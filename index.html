<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-BILL | Billing System ISP</title>
    
    <!-- CSS & JS Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        /* ========== RESET & VARIABLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #00b894;
            --danger: #ff6b6b;
            --warning: #fdcb6e;
            --info: #54a0ff;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
            --radius: 15px;
            --radius-sm: 10px;
        }
        
        body {
            background: #f5f7fb;
            color: var(--dark);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* ========== LOADING ========== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ========== TOAST (FIX Z-INDEX) ========== */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    /* ⭐ MAGIC NUMBER: Pastikan lebih tinggi dari modal (99999 > 9999) */
    z-index: 99999; 
    
    max-width: 400px;
    /* Tambah pointer-events: none agar klik tembus ke container, tapi tombol toast tetap klik */
    pointer-events: none; 
}

.toast {
    background: white;
    border-radius: var(--radius-sm);
    padding: 15px 20px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); /* Bayangan lebih gelap biar kontras */
    transform: translateX(400px);
    transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Animasi sedikit bouncy */
    
    /* ⭐ PENTING: Balikin pointer-events supaya toast bisa diclick */
    pointer-events: auto;
    
    /* Tambahkan border tipis biar kelihatan jelas di atas background modal gelap */
    border-left: 4px solid var(--gray);
}

/* Warna border sesuai tipe toast */
.toast-success { border-left-color: var(--success); }
.toast-error { border-left-color: var(--danger); }
.toast-warning { border-left-color: var(--warning); }
.toast-info { border-left-color: var(--info); }

.toast.show {
    transform: translateX(0);
}

.toast-icon {
    font-size: 24px; /* Ikon sedikit lebih besar */
}

.toast-title {
    font-weight: 700;
    margin-bottom: 5px;
    font-size: 16px;
}

.toast-message {
    font-size: 14px;
    color: var(--gray);
    line-height: 1.4;
}
        
        /* ========== LOGIN PAGE ========== */
        #loginPage {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient);
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        
        .login-header {
            background: var(--primary);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .login-header i {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .app-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .app-tagline {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .login-body {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius-sm);
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .login-footer {
            padding: 20px;
            text-align: center;
            background: var(--light);
            border-top: 1px solid var(--gray-light);
            font-size: 13px;
            color: var(--gray);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #00a085;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #ee5a52;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }
        
        .btn-warning:hover {
            background: #f9c74f;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background: var(--info);
            color: white;
        }
        
        .btn-info:hover {
            background: #2e86de;
            transform: translateY(-2px);
        }
        
        .btn-block {
            width: 100%;
        }
        
        /* ========== APP CONTAINER ========== */
        #appContainer {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f5f7fb;
        }
        
        /* ========== TOP NAVBAR ========== */
        .top-navbar {
            background: white;
            padding: 15px 25px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }
        
        .navbar-brand i {
            font-size: 24px;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;            /* ⭐ KECILKAN JARAK ANTAR ELEMEN */
            margin-left: auto;     /* ⭐ TAMBAHKAN INI: DORONG KE KANAN */
            flex-wrap: wrap;       /* ⭐ TAMBAHKAN INI: AGAR BISA TURUN BARIS DI HP */
        }

        
        .user-info {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-avatar {
            width: 25px;
            height: 25px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .logout-btn {
            background: var(--light);
            border: 1px solid var(--gray-light);
            padding: 8px 15px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        /* ========== BOTTOM NAVIGATION ========== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            color: var(--gray);
            text-decoration: none;
            border-radius: var(--radius-sm);
            transition: all 0.3s;
            min-width: 70px;
            cursor: pointer;
        }
        
        .nav-item i {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .nav-item span {
            font-size: 12px;
            font-weight: 500;
        }
        
        .nav-item.active {
            color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
        }
        
        .nav-item:hover {
            color: var(--primary);
            transform: translateY(-2px);
        }
        
        /* ========== MAIN CONTENT ========== */
        .main-content {
            flex: 1;
            padding: 25px;
            padding-bottom: 80px;
            overflow-y: auto;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        .page {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ========== PAGE HEADER ========== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-title i {
            color: var(--primary);
        }
        
        /* ========== STATS CARDS ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .stat-icon.primary { background: var(--primary); }
        .stat-icon.success { background: var(--success); }
        .stat-icon.info { background: var(--info); }
        .stat-icon.danger { background: var(--danger); }
        .stat-icon.warning { background: var(--warning); }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 14px;
        }
        
        /* ========== CARDS ========== */
        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h3 {
            font-size: 18px;
            color: var(--dark);
        }
        
        .card-body {
            padding: 25px;
        }
        
        /* ========== TABLES ========== */
        .table-responsive {
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            background: var(--light);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--gray-light);
        }
        
                .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
            vertical-align: middle;
            /* ⭐ TAMBAHKAN STYLE BERIKUT AGAR HURUF LEBIH KECIL ⭐ */
            font-size: 12px;           /* ⭐ KURANGI DARI DEFAULT (biasanya 14-16px) */
            line-height: 1.4;         /* ⭐ RAPATKAN JARAK ANTAR BARIS */
        }
        
        .table tr:hover {
            background: rgba(67, 97, 238, 0.02);
        }
        
        /* ========== BADGES ========== */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: rgba(0, 184, 148, 0.1);
            color: var(--success);
        }
        
        .badge-danger {
            background: rgba(255, 107, 107, 0.1);
            color: var(--danger);
        }
        
        .badge-warning {
            background: rgba(253, 203, 110, 0.1);
            color: #e67e22;
        }
        
        .badge-info {
            background: rgba(84, 160, 255, 0.1);
            color: var(--info);
        }
        
        .badge-primary {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        /* ========== BUTTONS ========== */
        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .btn-group {
            display: flex;
            gap: 5px;
        }
        
        .btn-outline {
            background: white;
            border: 2px solid var(--gray-light);
            color: var(--dark);
        }
        
        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }
        
        /* ========== FILTERS ========== */
        .filters-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        /* ========== MODALS ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlide 0.3s ease;
        }
        
        .modal-lg {
            max-width: 700px;
        }
        
        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray);
            cursor: pointer;
            padding: 5px;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* ========== FORM STYLES ========== */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .user-menu {
                margin-left: auto; /* Pastikan ini ada */
                gap: 8px;           /* Perkecil gap lagi biar muat */
            }

            #logoutBtnSmall {
                margin-left: 0;    /* Reset margin tombol logout */
                margin-right: 0;
            }
        
        .form-check {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .form-check-input {
            width: 18px;
            height: 18px;
        }
        
        .form-check-label {
            cursor: pointer;
        }
        
        /* ========== CHARTS ========== */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (min-width: 992px) {
            .charts-container {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        .chart-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
        }
        
        .chart-card h3 {
            margin-bottom: 20px;
            color: var(--dark);
            font-size: 18px;
        }
        
        /* ========== QUICK ACTIONS ========== */
        .quick-actions {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .quick-actions h3 {
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* ========== PAGINATION ========== */
.pagination {
    display: flex;                 /* ⭐ Gunakan Flexbox */
    justify-content: center;       /* Tengahkan secara horizontal */
    align-items: center;           /* ⭐ SAMAKAN POSISI VERTIKAL */
    gap: 10px;                      /* ⭐ JARAK ANTAR TOMBOL */
    margin-top: 20px;
    flex-wrap: wrap;                /* ⭐ BIAR TIDAK PECAH DI HP */
}

.page-link {
    padding: 8px 15px;
    border: 1px solid var(--gray-light);
    border-radius: var(--radius-sm);
    color: var(--dark);
    text-decoration: none;
    transition: all 0.3s;
    cursor: pointer;
    min-width: 40px;               /* ⭐ PASTIKAN LEBAR TOMBOL AGAR SAMA */
    text-align: center;              /* ⭐ TENGAKKAN TEKS */
}

/* ⭐ STYLE KHUSUS UNTUK TOMBOL PREV (KIRI) ⭐ */
.pagination a:first-child {
    background: var(--gray-light);   /* Warna beda biar jelas tombol navigasi */
    color: var(--dark);
    font-weight: bold;              /* Tebal */
    border-radius: 5px;             /* Sudut membulat sedikit */
}
.pagination a:first-child:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

/* ⭐ STYLE KHUSUS UNTUK TOMBOL NEXT (KANAN) ⭐ */
.pagination a:last-child {
    background: var(--gray-light);   /* Warna beda biar jelas tombol navigasi */
    color: var(--dark);
    font-weight: bold;              /* Tebal */
    border-radius: 5px;             /* Sudut membulat sedikit */
}
.pagination a:last-child:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

/* STYLE UNTUK ANGKA TENGAH */
.page-link:hover,
.page-link.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
                padding-bottom: 80px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .page-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .top-navbar {
                padding: 12px 15px;
            }
            
                        .navbar-brand span {
                /* display: none;  <-- HAPUS BARIS INI */
                
                /* TAMBAHKAN STYLE BERIKUT AGAR TETAP TERLIHAT TAPI RAPI */
                display: inline-block; 
                font-size: 16px;       /* Font sedikit lebih kecil */
                max-width: 150px;    /* Batasi lebar agar tidak merusak layout */
                white-space: nowrap;  /* Tidak turun baris */
                overflow: hidden;     /* Sembunyikan sisa teks jika kepanjangan */
                text-overflow: ellipsis; /* Tampilkan titik tiga (...) jika kepanjangan */
            }
            
            .bottom-nav span {
                font-size: 11px;
            }
            
            .nav-item {
                padding: 8px 10px;
                min-width: 60px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
        }
        
        /* ========== PACKAGE CARD ========== */
        .package-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .package-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }
        
        .package-card h4 {
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .package-price {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .package-features {
            list-style: none;
            margin-bottom: 20px;
        }
        
        .package-features li {
            padding: 5px 0;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .package-features i {
            color: var(--success);
        }
        
        /* ========== EMAIL TEMPLATE ========== */
        .email-template {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .email-header {
            border-bottom: 2px solid var(--gray-light);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .email-content {
            min-height: 200px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin-bottom: 20px;
        }
        
        /* ========== BACKUP STATUS ========== */
        .backup-status {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .backup-item:last-child {
            border-bottom: none;
        }

        /* ========== SETTING PAGE STYLES ========== */
.setting-card {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
    display: flex;
    gap: 15px;
    align-items: center;
}

.setting-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary);
}

.setting-icon {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    flex-shrink: 0;
}

.setting-content {
    flex: 1;
}

.setting-content h3 {
    margin: 0 0 5px 0;
    color: var(--dark);
    font-size: 18px;
}

.setting-content p {
    margin: 0;
    color: var(--gray);
    font-size: 14px;
    line-height: 1.4;
}

.setting-badge {
    display: inline-block;
    background: var(--light);
    color: var(--primary);
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    margin-top: 8px;
}

.quick-setting {
    background: var(--light);
    padding: 15px;
    border-radius: var(--radius-sm);
    min-width: 200px;
}

.status-item {
    background: var(--light);
    padding: 15px;
    border-radius: var(--radius-sm);
}

.status-label {
    font-size: 12px;
    color: var(--gray);
    margin-bottom: 5px;
}

.status-value {
    font-weight: 600;
    font-size: 16px;
}

#logoutBtnSmall:hover {
    background: rgba(255, 107, 107, 0.15) !important;
    transform: translateY(-2px);
}
    </style>
</head>
<body>
    <!-- LOADING OVERLAY -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- LOGIN PAGE -->
    <div id="loginPage">
        <div class="login-card">
            <div class="login-header">
                <i class="fas fa-file-invoice-dollar"></i>
                <div class="app-name">X-BILL ISP</div>
                <div class="app-tagline">Billing Management System</div>
            </div>
            
            <div class="login-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="loginUsername" 
                               placeholder="Masukkan username" required
                               value="admin">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" 
                               placeholder="Masukkan password" required
                               value="admin123">
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="login-footer">
                <p>Username: admin | Password: admin123</p>
            </div>
        </div>
    </div>

    

    <!-- ========== MODAL SETTING KOMPLIT ========== -->

<!-- MODAL 1: PROFIL PERUSAHAAN -->
<div class="modal-overlay hidden" id="modalCompanyProfile">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-building"></i> Profil Perusahaan</h3>
            <button class="modal-close" onclick="hideModal('modalCompanyProfile')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formCompanyProfile">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nama Perusahaan *</label>
                        <input type="text" class="form-control" id="companyName" required>
                    </div>
                    <div class="form-group">
                        <label>Tagline / Slogan</label>
                        <input type="text" class="form-control" id="companyTagline">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Alamat Lengkap *</label>
                        <textarea class="form-control" id="companyAddress" rows="2" required></textarea>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Telepon Kantor *</label>
                        <input type="text" class="form-control" id="companyPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Email Perusahaan</label>
                        <input type="email" class="form-control" id="companyEmail">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Website</label>
                        <input type="url" class="form-control" id="companyWebsite">
                    </div>
                    <div class="form-group">
                        <label>NPWP</label>
                        <input type="text" class="form-control" id="companyNPWP">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nama Direktur/Pemilik</label>
                        <input type="text" class="form-control" id="companyDirector">
                    </div>
                    <div class="form-group">
                        <label>Jenis Usaha</label>
                        <select class="form-control" id="companyType">
                            <option value="isp">ISP / Internet Provider</option>
                            <option value="wifi">Wifi Management</option>
                            <option value="it">IT Services</option>
                            <option value="other">Lainnya</option>
                        </select>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-file-invoice"></i> Informasi Invoice</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Prefix Invoice</label>
                                <input type="text" class="form-control" id="invoicePrefix" value="INV">
                            </div>
                            <div class="form-group">
                                <label>Footer Invoice</label>
                                <textarea class="form-control" id="invoiceFooter" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Terms & Conditions</label>
                                <textarea class="form-control" id="invoiceTerms" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalCompanyProfile')">Batal</button>
            <button class="btn btn-primary" onclick="saveCompanyProfile()">
                <i class="fas fa-save"></i> Simpan Profil
            </button>
        </div>
    </div>
</div>

<!-- MODAL 2: BRANDING & LOGO -->
<div class="modal-overlay hidden" id="modalBranding">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-palette"></i> Logo & Branding</h3>
            <button class="modal-close" onclick="hideModal('modalBranding')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formBranding">
                <!-- LOGO UPLOAD -->
                <div class="form-group text-center" style="margin-bottom: 30px;">
                    <label>Logo Perusahaan</label>
                    <div style="border: 2px dashed var(--gray-light); border-radius: 15px; padding: 30px; margin-top: 10px; cursor: pointer;" 
                         onclick="document.getElementById('logoUpload').click()" id="logoDropzone">
                        <div id="logoPreview" style="width: 150px; height: 150px; margin: 0 auto; 
                             background: var(--light); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-building" style="font-size: 48px; color: var(--gray);"></i>
                        </div>
                        <p class="mt-3" style="color: var(--gray);">Klik untuk upload logo</p>
                        <small class="text-muted">Rekomendasi: 500x500px, PNG/JPG, maks 2MB</small>
                    </div>
                    <input type="file" id="logoUpload" accept="image/*" style="display: none;" 
                           onchange="previewLogo(this)">
                </div>
                
                <!-- COLOR SCHEME -->
                <div class="form-group">
                    <label>Warna Utama</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="color" class="form-control" id="primaryColor" value="#4361ee" style="flex: 1;">
                        <input type="color" class="form-control" id="secondaryColor" value="#7209b7" style="flex: 1;">
                    </div>
                </div>
                
                <!-- FAVICON -->
                <div class="form-group">
                    <label>Favicon</label>
                    <input type="file" class="form-control" id="faviconUpload" accept=".ico,image/*">
                    <small class="text-muted">File .ico atau PNG 32x32px</small>
                </div>
                
                <!-- THEME OPTIONS -->
                <div class="form-group">
                    <label>Tema Dashboard</label>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="dashboardTheme" id="themeLight" value="light" checked>
                        <label class="form-check-label" for="themeLight">Light Mode</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="dashboardTheme" id="themeDark" value="dark">
                        <label class="form-check-label" for="themeDark">Dark Mode</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="dashboardTheme" id="themeAuto" value="auto">
                        <label class="form-check-label" for="themeAuto">Auto (ikuti sistem)</label>
                    </div>
                </div>
                
                <!-- FONT SETTINGS -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Font Utama</label>
                        <select class="form-control" id="mainFont">
                            <option value="'Segoe UI', system-ui">Segoe UI (Default)</option>
                            <option value="'Poppins', sans-serif">Poppins</option>
                            <option value="'Inter', sans-serif">Inter</option>
                            <option value="'Roboto', sans-serif">Roboto</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Font Size</label>
                        <select class="form-control" id="fontSize">
                            <option value="14px">Kecil (14px)</option>
                            <option value="16px" selected>Normal (16px)</option>
                            <option value="18px">Besar (18px)</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalBranding')">Batal</button>
            <button class="btn btn-primary" onclick="saveBranding()">
                <i class="fas fa-paint-brush"></i> Terapkan Branding
            </button>
        </div>
    </div>
</div>

<!-- MODAL 3: KONTAK & NOTIFIKASI -->
<div class="modal-overlay hidden" id="modalContactSettings">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-phone-alt"></i> Kontak & Notifikasi</h3>
            <button class="modal-close" onclick="hideModal('modalContactSettings')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formContactSettings">
                <!-- WHATSAPP SETTINGS -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fab fa-whatsapp" style="color: #25D366;"></i> WhatsApp Business</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nomor WhatsApp Pengirim *</label>
                                <input type="text" class="form-control" id="whatsappNumber" 
                                       placeholder="6281234567890" required>
                                <small class="text-muted">Format: 6281234567890 (tanpa +)</small>
                            </div>
                            <div class="form-group">
                                <label>WhatsApp API Key</label>
                                <input type="password" class="form-control" id="whatsappApiKey" 
                                       placeholder="Masukkan API key jika ada">
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enableWhatsApp" checked>
                            <label class="form-check-label">Aktifkan pengiriman otomatis via WhatsApp</label>
                        </div>
                    </div>
                </div>
                
                <!-- EMAIL SETTINGS -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-envelope"></i> Email Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>SMTP Host</label>
                                <input type="text" class="form-control" id="smtpHost" 
                                       placeholder="smtp.gmail.com">
                            </div>
                            <div class="form-group">
                                <label>SMTP Port</label>
                                <input type="number" class="form-control" id="smtpPort" 
                                       placeholder="587" value="587">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Email Pengirim</label>
                                <input type="email" class="form-control" id="smtpEmail" 
                                       placeholder="admin@perusahaan.com">
                            </div>
                            <div class="form-group">
                                <label>Password/App Password</label>
                                <input type="password" class="form-control" id="smtpPassword">
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enableSSL">
                            <label class="form-check-label">Gunakan SSL/TLS</label>
                        </div>
                    </div>
                </div>
                
                <!-- SMS GATEWAY -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-sms"></i> SMS Gateway</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Provider SMS</label>
                            <select class="form-control" id="smsProvider">
                                <option value="">-- Pilih Provider --</option>
                                <option value="zenziva">Zenziva</option>
                                <option value="nexmo">Nexmo (Vonage)</option>
                                <option value="twilio">Twilio</option>
                                <option value="custom">Custom API</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>API Key</label>
                                <input type="password" class="form-control" id="smsApiKey">
                            </div>
                            <div class="form-group">
                                <label>Secret Key</label>
                                <input type="password" class="form-control" id="smsSecret">
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enableSMS">
                            <label class="form-check-label">Aktifkan pengiriman SMS</label>
                        </div>
                    </div>
                </div>
                
                <!-- NOTIFICATION SETTINGS -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-bell"></i> Pengaturan Notifikasi</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Notifikasi untuk Admin</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifNewCustomer" checked>
                                <label class="form-check-label">Pelanggan baru mendaftar</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifPayment" checked>
                                <label class="form-check-label">Pembayaran diterima</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifOverdue" checked>
                                <label class="form-check-label">Tagihan overdue</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Jadwal Reminder Otomatis</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="reminder3Days">
                                <label class="form-check-label">3 hari sebelum jatuh tempo</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="reminder1Day">
                                <label class="form-check-label">1 hari sebelum jatuh tempo</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="reminderOverdue">
                                <label class="form-check-label">Setelah jatuh tempo</label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalContactSettings')">Batal</button>
            <button class="btn btn-success" onclick="testNotification()">
                <i class="fas fa-paper-plane"></i> Test Notifikasi
            </button>
            <button class="btn btn-primary" onclick="saveContactSettings()">
                <i class="fas fa-save"></i> Simpan Settings
            </button>
        </div>
    </div>
</div>

<!-- MODAL 4: GANTI PASSWORD -->
<div class="modal-overlay hidden" id="modalChangePassword">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-key"></i> Ganti Password</h3>
            <button class="modal-close" onclick="hideModal('modalChangePassword')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formChangePassword">
                <div class="form-group">
                    <label>Password Saat Ini *</label>
                    <input type="password" class="form-control" id="currentPassword" required>
                </div>
                
                <div class="form-group">
                    <label>Password Baru *</label>
                    <input type="password" class="form-control" id="newPassword" required>
                    <div class="password-strength" style="margin-top: 5px;">
                        <div class="strength-bar">
                            <div class="strength-fill" id="passwordStrength"></div>
                        </div>
                        <small id="passwordTips" class="text-muted"></small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Konfirmasi Password Baru *</label>
                    <input type="password" class="form-control" id="confirmPassword" required>
                    <div id="passwordMatch" style="display: none; color: var(--success); margin-top: 5px;">
                        <i class="fas fa-check-circle"></i> Password cocok
                    </div>
                    <div id="passwordMismatch" style="display: none; color: var(--danger); margin-top: 5px;">
                        <i class="fas fa-times-circle"></i> Password tidak cocok
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Tips Password Aman:</h6>
                    <ul style="margin-bottom: 0; font-size: 13px;">
                        <li>Minimal 8 karakter</li>
                        <li>Kombinasi huruf besar & kecil</li>
                        <li>Minimal 1 angka dan 1 simbol</li>
                        <li>Jangan gunakan password yang mudah ditebak</li>
                    </ul>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalChangePassword')">Batal</button>
            <button class="btn btn-primary" onclick="changePassword()">
                <i class="fas fa-key"></i> Ganti Password
            </button>
        </div>
    </div>
</div>

<!-- MODAL 5: PROFIL USER -->
<div class="modal-overlay hidden" id="modalUserProfile">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-user"></i> Profil Saya</h3>
            <button class="modal-close" onclick="hideModal('modalUserProfile')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formUserProfile">
                <div class="text-center mb-4">
                    <div style="width: 100px; height: 100px; border-radius: 50%; background: var(--gradient); 
                          margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; 
                          color: white; font-size: 36px; cursor: pointer;" 
                          onclick="document.getElementById('userPhotoUpload').click()" id="userPhotoPreview">
                        <span id="userInitials">A</span>
                        <img id="userPhotoImg" src="" style="width: 100%; height: 100%; border-radius: 50%; display: none;">
                    </div>
                    <input type="file" id="userPhotoUpload" accept="image/*" style="display: none;" 
                           onchange="uploadUserPhoto(this)">
                    <small class="text-muted">Klik untuk ganti foto profil</small>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nama Lengkap *</label>
                        <input type="text" class="form-control" id="userFullName" required>
                    </div>
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" class="form-control" id="userUsername" required readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="userEmail">
                    </div>
                    <div class="form-group">
                        <label>Telepon</label>
                        <input type="text" class="form-control" id="userPhone">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Alamat</label>
                    <textarea class="form-control" id="userAddress" rows="2"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Role</label>
                        <input type="text" class="form-control" id="userRoleInput" readonly>
                    </div>
                    <div class="form-group">
                        <label>Bergabung Sejak</label>
                        <input type="text" class="form-control" id="userJoinDate" readonly>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Bio/Signature</label>
                    <textarea class="form-control" id="userBio" rows="2" 
                              placeholder="Tulis bio atau signature untuk invoice..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalUserProfile')">Batal</button>
            <button class="btn btn-primary" onclick="saveUserProfile()">
                <i class="fas fa-save"></i> Simpan Profil
            </button>
        </div>
    </div>
</div>

<!-- MODAL 6: TEMPLATE PESAN -->
 
<div class="modal-overlay hidden" id="modalMessageTemplates">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-comment-alt"></i> Template Pesan</h3>
            <button class="modal-close" onclick="hideModal('modalMessageTemplates')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h5><i class="fas fa-variables"></i> Variabel yang Tersedia</h5>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <span class="badge badge-info">[nama_pelanggan]</span>
                        <span class="badge badge-info">[nama_perusahaan]</span>
                        <span class="badge badge-info">[bulan_tagihan]</span>
                        <span class="badge badge-info">[jumlah_tagihan]</span>
                        <span class="badge badge-info">[jatuh_tempo]</span>
                        <span class="badge badge-info">[invoice_number]</span>
                        <span class="badge badge-info">[link_pembayaran]</span>
                        <span class="badge badge-info">[no_telepon_admin]</span>
                        <span class="badge badge-info">[alamat_perusahaan]</span>
                        <span class="badge badge-info">[website_perusahaan]</span>
                    </div>
                </div>
            </div>
            
            <!-- TEMPLATE REMINDER -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h5><i class="fas fa-bell"></i> Template Reminder Tagihan</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Reminder 3 Hari Sebelum Jatuh Tempo</label>
                        <textarea class="form-control" id="templateReminder3Days" rows="3">
Yth. [nama_pelanggan],
Tagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan] akan jatuh tempo pada [jatuh_tempo].
Silakan lakukan pembayaran sebelum jatuh tempo.
Terima kasih.
[nama_perusahaan]</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Reminder 1 Hari Sebelum Jatuh Tempo</label>
                        <textarea class="form-control" id="templateReminder1Day" rows="3">
Yth. [nama_pelanggan],
Besok adalah jatuh tempo tagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan].
Segera lakukan pembayaran untuk menghindari denda.
Terima kasih.
[nama_perusahaan]</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Peringatan Telat Bayar</label>
                        <textarea class="form-control" id="templateOverdue" rows="3">
Yth. [nama_pelanggan],
Tagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan] TELAT BAYAR.
Silakan segera lakukan pembayaran untuk menghindari pemutusan layanan.
Terima kasih.
[nama_perusahaan]</textarea>
                    </div>
                </div>
            </div>

            
            <!-- TEMPLATE KONFIRMASI -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h5><i class="fas fa-check-circle"></i> Template Konfirmasi</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Konfirmasi Pembayaran Diterima</label>
                        <textarea class="form-control" id="templatePaymentConfirmed" rows="3">
Yth. [nama_pelanggan],
Pembayaran tagihan [invoice_number] sebesar [jumlah_tagihan] telah kami terima.
Terima kasih telah melakukan pembayaran tepat waktu.
[nama_perusahaan]</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Notifikasi Tagihan Baru</label>
                        <textarea class="form-control" id="templateNewInvoice" rows="3">
Yth. [nama_pelanggan],
Tagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan] telah tersedia.
Jatuh tempo: [jatuh_tempo]
Link pembayaran: [link_pembayaran]
Terima kasih.
[nama_perusahaan]</textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalMessageTemplates')">Batal</button>
            <button class="btn btn-primary" onclick="saveMessageTemplates()">
                <i class="fas fa-save"></i> Simpan Template
            </button>
        </div>
    </div>
</div>



    
    <div id="appContainer" class="hidden">
    
    <!-- ⭐ NAVBAR DI DALAM CONTAINER ⭐ -->
    <nav class="top-navbar">
        <div class="navbar-brand">
            <i class="fas fa-file-invoice-dollar"></i>
            <span id="companyNameNav">X-BILL ISP</span>
        </div>
        
        <div class="user-menu">
            <div class="notification-bell" id="notificationBell" style="position: relative; cursor: pointer; padding: 8px;">
                <i class="fas fa-bell"></i>
                <span class="badge badge-danger" id="notificationCount" style="position: absolute; top: -5px; right: -5px; font-size: 10px; display: none;">0</span>
            </div>
            
            <div class="user-info" style="cursor: pointer;" id="userProfileBtn">
    <div class="user-avatar" id="userAvatar">A</div>
    <div>
        <div id="userName">admin@xbill.com</div>
        <!-- ⭐⭐ TAMBAH INI UNTUK WAKTU ⭐⭐ -->
        <div id="userTime" style="font-size: 11px; color: var(--gray);">
            <i class="fas fa-clock"></i> <span id="currentTime">Loading...</span>
        </div>
    </div>
</div>
            
            <!-- TOMBOL LOGOUT (HAPUS onclick="handleLogout()") -->
            <button id="logoutBtnSmall" style="margin-left: 5px; border: none; background: transparent; color: var(--danger); cursor: pointer; padding: 8px 10px; border-radius: 8px; transition: all 0.3s; display: flex; align-items: center;" title="Keluar">
                <i class="fas fa-sign-out-alt" style="font-size: 18px;"></i>
            </button>

            <!-- DROPDOWN BUTTON (GEAR) -->
            <div class="dropdown" style="position: relative;">
                
                
                <!-- DROPDOWN MENU -->
                <div class="dropdown-menu" id="settingDropdown" style="position: absolute; top: 100%; right: 0; background: white; border-radius: 12px; 
                            box-shadow:0 10px 40px rgba(0,0,0,0.2); min-width: 320px; z-index: 1000; 
                            display: none; margin-top: 10px; border:1px solid var(--gray-light); overflow: hidden;">
                    
                    <!-- Header -->
                    <div style="background: var(--gradient); padding:20px; color: white;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div id="dropdownLogo" style="width: 50px; height: 50px; border-radius: 10px; 
                                  background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-building" style="font-size: 24px;"></i>
                            </div>
                            <div>
                                <h4 id="dropdownCompanyName" style="margin: 0; font-weight: 600;">X-BILL ISP</h4>
                                <small id="dropdownCompanyTagline" style="opacity: 0.9;">Billing Management System</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Menu Items -->
                    <div style="max-height: 400px; overflow-y: auto;">
                        <a href="javascript:void(0)" class="dropdown-item" onclick="showCompanyProfile()">
                            <i class="fas fa-building" style="color: #4361ee;"></i> Profil Perusahaan
                        </a>
                        <!-- ... item menu lainnya ... -->
                        <a href="javascript:void(0)" class="dropdown-item" onclick="showUserProfile()">
                            <i class="fas fa-user" style="color: #00cec9;"></i> Profil Saya
                        </a>
                        <a href="javascript:void(0)" class="dropdown-item" onclick="showChangePassword()">
                            <i class="fas fa-key" style="color: #fd79a8;"></i> Ganti Password
                        </a>
                        
                        <hr style="margin: 10px 20px;">
                        
                        <!-- LOGOUT DROPDOWN -->
                        <a href="javascript:void(0)" class="dropdown-item" onclick="performLogout()" style="color: var(--danger);">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                    
                    <!-- Footer -->
                    <div style="background: var(--light); padding: 10px 20px; border-top:1px solid var(--gray-light); font-size: 12px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span id="systemVersion">v2.1.0</span>
                            <span id="lastBackup">Backup: 2 hari lalu</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- ⭐ MAIN CONTENT (WAJIB DI DALAM appContainer) ⭐ -->
    <div class="main-content" id="mainContent">
        <!-- Pages will be dynamically loaded here -->
    </div>
    
    <!-- ⭐ BOTTOM NAVIGATION (WAJIB ADA & DI DALAM appContainer) ⭐ -->
    <div class="bottom-nav">
        <a href="#dashboard" class="nav-item active" data-page="dashboard">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="#pelanggan" class="nav-item" data-page="pelanggan">
            <i class="fas fa-users"></i>
            <span>Pelanggan</span>
        </a>
        <a href="#paket" class="nav-item" data-page="paket">
            <i class="fas fa-wifi"></i>
            <span>Paket</span>
        </a>
        <a href="#tagihan" class="nav-item" data-page="tagihan">
            <i class="fas fa-receipt"></i>
            <span>Tagihan</span>
        </a>
        <a href="#tunggakan" class="nav-item" data-page="tunggakan">
            <i class="fas fa-clock"></i>
            <span>Tunggakan</span>
        </a>
        <a href="#laporan" class="nav-item" data-page="laporan">
            <i class="fas fa-chart-bar"></i>
            <span>Laporan</span>
        </a>
         <a href="#setting" class="nav-item" data-page="setting">
            <i class="fas fa-cog"></i>
            <span>Setting</span>
        </a>
    </div>

</div> <!-- TUTUP appContainer -->
    
    <!-- ========== MODALS ========== -->
    
   <!-- MODAL: TAMBAH/EDIT PELANGGAN (REVISED) -->
<div class="modal-overlay hidden" id="modalPelanggan">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Data Pelanggan</h3>
            <button class="modal-close" onclick="forceCloseModal('modalPelanggan')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formPelanggan">
                <!-- BARIS 1: NAMA & TELEPON -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nama Lengkap *</label>
                        <input type="text" class="form-control" id="pelangganNama" 
       placeholder="Nama Pelanggan" required
       style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telepon *</label>
                        <input type="tel" class="form-control" id="pelangganTelepon" 
       placeholder="08xxxxxxxxxx" required
       inputmode="numeric" pattern="[0-9]*">
                    </div>
                </div>
                
                <!-- BARIS 2: PAKET & HARGA -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Paket *</label>
                        <select class="form-control" id="pelangganPaket" required>
                            <option value="">-- Pilih Paket --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Harga *</label>
                        <input type="number" class="form-control" id="pelangganHarga" placeholder="0" required>
                    </div>
                </div>

                <!-- BARIS 3: TANGGAL PASANG & STATUS -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tanggal Pasang *</label>
                        <input type="date" class="form-control" id="pelangganTanggalPasang" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select class="form-control" id="pelangganStatus" required>
                            <option value="aktif">Aktif</option>
                            <option value="nonaktif">Nonaktif</option>
                            <option value="tunggak">Tunggak</option>
                        </select>
                    </div>
                </div>

                <!-- BARIS 4: ALAMAT (FULL WIDTH) -->
                <div class="form-group">
                    <label class="form-label">Alamat *</label>
                    <textarea class="form-control" id="pelangganAlamat" rows="2" placeholder="Alamat Lengkap" required></textarea>
                </div>

                <!-- BARIS 5: KOORDINAT (FULL WIDTH + TOMBOL RAPI) -->
                <div class="form-group">
                    <label class="form-label">Koordinat GPS</label>
                    <div style="display: flex; gap: 10px; align-items: stretch;">
                        <input type="text" class="form-control" id="pelangganKoordinat" 
                               placeholder="Contoh: -6.2088, 106.8456" readonly 
                               style="background: #f8f9fa; color: #495057;">
                        
                        <button type="button" class="btn btn-info" onclick="getLocation()" 
                                style="display: flex; align-items: center; justify-content: center; min-width: 120px;">
                            <i class="fas fa-crosshairs" style="margin-right: 5px;"></i> Set Lokasi
                        </button>
                    </div>
                </div>
                
                <!-- BARIS 6: CATATAN (FULL WIDTH) -->
                <div class="form-group">
                    <label class="form-label">Catatan</label>
                    <textarea class="form-control" id="pelangganCatatan" rows="2"></textarea>
                </div>
                
                <input type="hidden" id="pelangganId">
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="forceCloseModal('modalPelanggan')">Batal</button>
            <button type="button" class="btn btn-primary" onclick="savePelanggan()">
                <i class="fas fa-save"></i> Simpan Data
            </button>
        </div>
    </div>
</div>
    
    <!-- MODAL: TAMBAH/EDIT PAKET -->
    <div class="modal-overlay hidden" id="modalPaket">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Tambah Paket</h3>
                <button class="modal-close" onclick="hideModal('modalPaket')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formPaket">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nama Paket *</label>
                            <input type="text" class="form-control" id="paketNama" placeholder="Contoh: 10 Mbps" required>
                        </div>
                        <div class="form-group">
                            <label>Kecepatan *</label>
                            <input type="text" class="form-control" id="paketKecepatan" placeholder="Contoh: 10 Mbps" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Harga Bulanan *</label>
                            <input type="number" class="form-control" id="paketHarga" required>
                        </div>
                        <div class="form-group">
                            <label>Kuota</label>
                            <input type="text" class="form-control" id="paketKuota" placeholder="Contoh: Unlimited">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Deskripsi</label>
                        <textarea class="form-control" id="paketDeskripsi" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Fitur</label>
                        <textarea class="form-control" id="paketFitur" rows="3" placeholder="Pisahkan dengan koma"></textarea>
                        <small class="text-muted">Contoh: Unlimited Bandwidth, 24/7 Support, Free Router</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Warna</label>
                            <input type="color" class="form-control" id="paketWarna" value="#4361ee">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-control" id="paketStatus">
                                <option value="aktif">Aktif</option>
                                <option value="nonaktif">Nonaktif</option>
                            </select>
                        </div>
                    </div>
                    
                    <input type="hidden" id="paketId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalPaket')">Batal</button>
                <button class="btn btn-primary" onclick="savePaket()">Simpan Paket</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: KALKULATOR PRORATA -->
    <div class="modal-overlay hidden" id="modalProrata">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-calculator"></i> Kalkulator Prorata</h3>
                <button class="modal-close" onclick="hideModal('modalProrata')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formProrata">
                    <div class="form-group">
                        <label>Biaya Bulanan (Rp)</label>
                        <input type="number" class="form-control" id="prorataBiaya" value="150000">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tanggal Mulai</label>
                            <input type="date" class="form-control" id="prorataMulai">
                        </div>
                        <div class="form-group">
                            <label>Tanggal Akhir</label>
                            <input type="date" class="form-control" id="prorataAkhir">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Jumlah Hari</label>
                        <input type="number" class="form-control" id="prorataHari" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Hasil Perhitungan:</label>
                        <div class="form-control" style="background: #f8f9fa; font-weight: bold; font-size: 18px;" id="prorataHasil">
                            Rp 0
                        </div>
                    </div>
                    
                    <div class="alert" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <strong>Rumus:</strong> (Biaya Bulanan ÷ 30) × Jumlah Hari
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalProrata')">Tutup</button>
                <button class="btn btn-primary" onclick="hitungProrata()">
                    <i class="fas fa-calculator"></i> Hitung Prorata
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: GENERATE TAGIHAN ARREARS (YANG BENAR) -->
<div class="modal-overlay hidden" id="modalGenerateTagihan">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-bolt"></i> Generate Tagihan </h3>
            <button class="modal-close" onclick="forceCloseModal('modalGenerateTagihan')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formGenerateTagihan">
                <!-- TIMELINE ARREARS EXPLANATION -->
                <div class="alert alert-info" style="background: #e7f3ff; border-left: 4px solid #4361ee; padding: 15px; margin-bottom: 20px;">
                    <h5 style="color: #4361ee; margin-top: 0;">
                        <i class="fas fa-calendar-alt"></i> Timeline Sistem 
                    </h5>
                    <p style="margin-bottom: 5px;">
                        <strong>Pilih bulan untuk GENERATE tagihan:</strong>
                    </p>
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px; font-size: 14px;">
                        <div style="color: var(--primary); font-weight: bold;">Jan 2025</div>
                        <div>→ Generate tagihan untuk <strong>Desember 2024</strong> (pemakaian bulan sebelumnya)</div>
                        <div style="color: var(--success); font-weight: bold;">Jatuh Tempo</div>
                        <div>→ 10 Februari 2025 (bulan BERIKUTNYA setelah pemakaian)</div>
                    </div>
                    <hr style="margin: 10px 0;">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Sistem <strong></strong>: Tagihan untuk pemakaian bulan SEBELUMNYA, 
                        jatuh tempo di bulan BERIKUTNYA. Contoh: Pakai di Desember, bayar di Januari.
                    </small>
                </div>
                
                <!-- INPUT FIELDS -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Bulan Generate *</label>
                        <input type="month" class="form-control" id="generateBulan" 
       value="2025-01" 
       onchange="updateArrearsTimeline()" required>
                        <small class="text-muted">Bulan saat generate tagihan</small>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Jatuh Tempo (tgl) *</label>
                        <input type="number" class="form-control" id="generateJatuhTempo" 
                               min="1" max="31" value="10" required>
                        <small class="text-muted">Tanggal jatuh tempo di bulan berikutnya</small>
                    </div>
                </div>
                
                <!-- TIMELINE PREVIEW -->
                <div id="arrearsTimelinePreview" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h5><i class="fas fa-project-diagram"></i> Timeline Tagihan :</h5>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <div style="text-align: center;">
                            <div style="background: #4361ee; color: white; padding: 10px; border-radius: 8px; min-width: 120px;">
                                <strong id="previewBulanPemakaian">Des 2024</strong>
                                <div style="font-size: 12px;">Pemakaian</div>
                            </div>
                            <div style="margin-top: 5px; font-size: 12px;">Bulan Sebelumnya</div>
                        </div>
                        
                        <div style="flex: 1; text-align: center;">
                            <i class="fas fa-arrow-right" style="color: var(--gray);"></i>
                        </div>
                        
                        <div style="text-align: center;">
                            <div style="background: #00b894; color: white; padding: 10px; border-radius: 8px; min-width: 120px;">
                                <strong id="previewBulanGenerate">Jan 2025</strong>
                                <div style="font-size: 12px;">Generate Tagihan</div>
                            </div>
                            <div style="margin-top: 5px; font-size: 12px;">Awal Bulan</div>
                        </div>
                        
                        <div style="flex: 1; text-align: center;">
                            <i class="fas fa-arrow-right" style="color: var(--gray);"></i>
                        </div>
                        
                        <div style="text-align: center;">
                            <div style="background: #ff6b6b; color: white; padding: 10px; border-radius: 8px; min-width: 120px;">
                                <strong id="previewJatuhTempo">10 Feb 2025</strong>
                                <div style="font-size: 12px;">Jatuh Tempo</div>
                            </div>
                            <div style="margin-top: 5px; font-size: 12px;">Bulan Berikutnya</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px; font-size: 14px;">
                        <i class="fas fa-calculator"></i> 
                        <strong>Perhitungan:</strong>
                        <span id="previewPelangganCount">0</span> pelanggan aktif × 
                        <span id="previewHargaRata">Rp 150.000</span> = 
                        <strong id="previewTotalEstimasi">Rp 0</strong>
                    </div>
                </div>
                
                <!-- SECTION TUNGGAKAN -->
                <div class="card" style="margin-top: 20px; margin-bottom: 20px;">
                    <div class="card-header" style="background: #fff3cd; border-color: #ffeaa7;">
                        <h4 style="color: #856404; margin: 0;">
                            <i class="fas fa-exclamation-triangle"></i> Filter Pelanggan
                        </h4>
                    </div>
                    <div class="card-body">
                        <!-- FILTER TUNGGAKAN -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>Filter Tunggakan</label>
                                <select class="form-control" id="filterTunggakan" onchange="toggleTunggakanFilter()">
                                    <option value="all">Generate untuk semua pelanggan</option>
                                    <option value="exclude_tunggakan">Exclude pelanggan dengan tunggakan</option>
                                    <option value="only_tunggakan">Generate hanya untuk yang punya tunggakan</option>
                                    <option value="exclude_berat">Exclude tunggakan berat (>60 hari)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Kategori Tunggakan</label>
                                <select class="form-control" id="kategoriTunggakan" disabled>
                                    <option value="all">Semua Kategori</option>
                                    <option value="ringan">Ringan (1-30 hari)</option>
                                    <option value="sedang">Sedang (31-60 hari)</option>
                                    <option value="berat">Berat (>60 hari)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- TAMPILKAN DATA TUNGGAKAN -->
                        <div id="tunggakanDataSection" style="display: none; margin-top: 15px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                                <h5 style="margin-bottom: 10px; color: var(--danger);">
                                    <i class="fas fa-list"></i> Daftar Pelanggan dengan Tunggakan
                                </h5>
                                <table style="width: 100%; font-size: 12px;">
                                    <thead style="background: #e9ecef;">
                                        <tr>
                                            <th style="padding: 8px;">Pelanggan</th>
                                            <th style="padding: 8px;">Tunggakan</th>
                                            <th style="padding: 8px;">Hari</th>
                                            <th style="padding: 8px;">Kategori</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tunggakanList">
                                        <!-- Data tunggakan akan diisi di sini -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- SUMMARIES -->
                        <div class="form-row" style="margin-top: 15px;">
                            <div class="form-group" style="flex: 1;">
                                <div style="background: #e7f3ff; padding: 10px; border-radius: 6px;">
                                    <small><strong>Total Pelanggan Aktif:</strong></small>
                                    <div id="summaryTotalAktif" style="font-size: 18px; font-weight: bold; color: var(--primary);">0</div>
                                </div>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <div style="background: #ffeaa7; padding: 10px; border-radius: 6px;">
                                    <small><strong>Pelanggan dengan Tunggakan:</strong></small>
                                    <div id="summaryTunggakan" style="font-size: 18px; font-weight: bold; color: var(--warning);">0</div>
                                </div>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <div style="background: #ffcccc; padding: 10px; border-radius: 6px;">
                                    <small><strong>Total Tunggakan:</strong></small>
                                    <div id="summaryTotalTunggakan" style="font-size: 18px; font-weight: bold; color: var(--danger);">Rp 0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- OPTIONS -->
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="generateProrata" checked>
                    <label class="form-check-label">
                        <strong>Include perhitungan prorata otomatis</strong>
                        <small class="text-muted">(Untuk pelanggan baru di bulan pemakaian)</small>
                    </label>
                </div>
                
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="generateEmail">
                    <label class="form-check-label">Kirim email pemberitahuan ke pelanggan</label>
                </div>
                
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="generateWhatsapp">
                    <label class="form-check-label">Kirim notifikasi WhatsApp</label>
                </div>
                
                <!-- SUMMARY GENERATE -->
                <div id="generateSummary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h5><i class="fas fa-calculator"></i> Rincian Generate :</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                        <div>
                            <p><strong>Bulan Pemakaian:</strong> 
                               <span id="summaryBulanPemakaian" style="color: var(--primary); font-weight: bold;">-</span>
                            </p>
                            <p><strong>Jumlah Tagihan:</strong> 
                               <span id="summaryJumlahTagihan" style="color: var(--primary); font-weight: bold;">0</span>
                            </p>
                            <p><strong>Estimasi Total:</strong> 
                               <span id="summaryEstimasiTotal" style="color: var(--success); font-weight: bold;">Rp 0</span>
                            </p>
                        </div>
                        <div>
                            <p><strong>Bulan Jatuh Tempo:</strong> 
                               <span id="summaryBulanJatuhTempo" style="color: var(--danger); font-weight: bold;">-</span>
                            </p>
                            <p><strong>Estimasi Waktu:</strong> 
                               <span id="summaryWaktu" style="font-weight: bold;">~5 detik</span>
                            </p>
                            <p><strong>Denda Termasuk:</strong> 
                               <span id="summaryDenda" style="color: var(--danger); font-weight: bold;">Rp 0</span>
                            </p>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="forceCloseModal('modalGenerateTagihan')">Batal</button>
            <button type="button" class="btn btn-info" onclick="loadTunggakanDataForModal()">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
            <button type="button" class="btn btn-primary" onclick="generateTagihanBulk()">
                <i class="fas fa-bolt"></i> Generate Tagihan 
            </button>
        </div>
    </div>
</div>
    
    <!-- MODAL: BAYAR TAGIHAN -->
    <div class="modal-overlay hidden" id="modalBayarTagihan">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-money-bill-wave"></i> Pembayaran Tagihan</h3>
                <button class="modal-close" onclick="hideModal('modalBayarTagihan')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formBayarTagihan">
                    <div class="form-group">
                        <label>Invoice</label>
                        <input type="text" class="form-control" id="bayarInvoice" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Pelanggan</label>
                        <input type="text" class="form-control" id="bayarPelanggan" readonly>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Jumlah Tagihan</label>
                            <input type="text" class="form-control" id="bayarJumlah" readonly>
                        </div>
                        <div class="form-group">
                            <label>Denda Keterlambatan</label>
                            <input type="text" class="form-control" id="bayarDenda" value="0" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Total Bayar *</label>
                        <input type="number" class="form-control" id="totalBayar" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Metode Pembayaran *</label>
                        <select class="form-control" id="metodeBayar" required>
                            <option value="">Pilih Metode</option>
                            <option value="tunai">Tunai</option>
                            <option value="transfer">Transfer Bank</option>
                            <option value="qris">QRIS</option>
                            <option value="gopay">GoPay</option>
                            <option value="ovo">OVO</option>
                            <option value="dana">DANA</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tanggal Bayar *</label>
                            <input type="date" class="form-control" id="tanggalBayar" required>
                        </div>
                        <div class="form-group">
                            <label>No. Referensi</label>
                            <input type="text" class="form-control" id="referensiBayar" placeholder="No. transaksi/bukti">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Catatan</label>
                        <textarea class="form-control" id="catatanBayar" rows="2"></textarea>
                    </div>
                    
                    <input type="hidden" id="tagihanId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalBayarTagihan')">Batal</button>
                <button class="btn btn-success" onclick="konfirmasiPembayaran()">
                    <i class="fas fa-check-circle"></i> Konfirmasi Pembayaran
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: KIRIM REMINDER -->
    <div class="modal-overlay hidden" id="modalReminder">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-envelope"></i> Kirim Reminder Tagihan</h3>
                <button class="modal-close" onclick="hideModal('modalReminder')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Pilih Pelanggan</label>
                    <select class="form-control" id="reminderPelanggan" multiple style="height: 150px;">
                        <!-- Pelanggan akan diisi -->
                    </select>
                    <small class="text-muted">Tekan Ctrl untuk memilih multiple</small>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipe Reminder</label>
                        <select class="form-control" id="reminderType">
                            <option value="email">Email</option>
                            <option value="whatsapp">WhatsApp</option>
                            <option value="sms">SMS</option>
                            <option value="all">Semua Media</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Jadwal Kirim</label>
                        <select class="form-control" id="reminderSchedule">
                            <option value="now">Sekarang</option>
                            <option value="tomorrow">Besok Pagi (08:00)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                </div>
                
                <div id="customSchedule" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tanggal</label>
                            <input type="date" class="form-control" id="reminderDate">
                        </div>
                        <div class="form-group">
                            <label>Jam</label>
                            <input type="time" class="form-control" id="reminderTime">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Template Pesan</label>
                    <select class="form-control" id="reminderTemplate">
                        <option value="standard">Standar</option>
                        <option value="urgent">Mendesak</option>
                        <option value="friendly">Ramah</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Preview Pesan</label>
                    <div class="email-content" id="previewPesan">
                        <p>Yth. [Nama Pelanggan],</p>
                        <p>Tagihan bulan [Bulan] sebesar [Jumlah] jatuh tempo pada [Tanggal Jatuh Tempo].</p>
                        <p>Silakan lakukan pembayaran sebelum jatuh tempo.</p>
                        <p>Terima kasih.</p>
                    </div>
                </div>
                
                <div id="reminderSummary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4>Summary:</h4>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Jumlah pelanggan: <span id="summaryPelanggan" style="font-weight: bold;">0</span></li>
                        <li>Media pengiriman: <span id="summaryMedia" style="font-weight: bold;">Email</span></li>
                        <li>Waktu pengiriman: <span id="summaryWaktuReminder" style="font-weight: bold;">Sekarang</span></li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalReminder')">Batal</button>
                <button class="btn btn-primary" onclick="kirimReminder()">
                    <i class="fas fa-paper-plane"></i> Kirim Reminder
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: EXPORT LAPORAN -->
    <div class="modal-overlay hidden" id="modalExportLaporan">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-export"></i> Export Laporan</h3>
                <button class="modal-close" onclick="hideModal('modalExportLaporan')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formExportLaporan">
                    <div class="form-group">
                        <label>Tipe Laporan *</label>
                        <select class="form-control" id="exportLaporanType" required>
                            <option value="">Pilih Tipe</option>
                            <option value="keuangan">Laporan Keuangan</option>
                            <option value="pelanggan">Laporan Pelanggan</option>
                            <option value="tagihan">Laporan Tagihan</option>
                            <option value="tunggakan">Laporan Tunggakan</option>
                            <option value="paket">Laporan Paket</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Periode Awal</label>
                            <input type="date" class="form-control" id="exportStartDate">
                        </div>
                        <div class="form-group">
                            <label>Periode Akhir</label>
                            <input type="date" class="form-control" id="exportEndDate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Format File *</label>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="exportFormat" id="formatExcel" value="excel" checked>
                            <label class="form-check-label" for="formatExcel">Excel (.xlsx)</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="exportFormat" id="formatPDF" value="pdf">
                            <label class="form-check-label" for="formatPDF">PDF (.pdf)</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="exportFormat" id="formatCSV" value="csv">
                            <label class="form-check-label" for="formatCSV">CSV (.csv)</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Include Data</label>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="includeCharts" checked>
                            <label class="form-check-label" for="includeCharts">Grafik</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="includeSummary" checked>
                            <label class="form-check-label" for="includeSummary">Ringkasan</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="includeDetail">
                            <label class="form-check-label" for="includeDetail">Detail Data</label>
                        </div>
                    </div>
                    
                    <div id="exportSummary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4>Summary Export:</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Tipe: <span id="summaryTipe" style="font-weight: bold;">-</span></li>
                            <li>Format: <span id="summaryFormat" style="font-weight: bold;">Excel</span></li>
                            <li>Estimasi waktu: <span id="summaryEstimasi" style="font-weight: bold;">5 detik</span></li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalExportLaporan')">Batal</button>
                <button class="btn btn-success" onclick="exportLaporan()">
                    <i class="fas fa-download"></i> Download Laporan
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: BACKUP DATA -->
    <div class="modal-overlay hidden" id="modalBackup">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-database"></i> Backup Data</h3>
                <button class="modal-close" onclick="hideModal('modalBackup')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Tipe Backup</label>
                    <select class="form-control" id="backupType">
                        <option value="full">Full Backup (Semua Data)</option>
                        <option value="pelanggan">Data Pelanggan</option>
                        <option value="tagihan">Data Tagihan</option>
                        <option value="paket">Data Paket</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Format Backup</label>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="backupFormat" id="backupJSON" value="json" checked>
                        <label class="form-check-label" for="backupJSON">JSON</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="backupFormat" id="backupCSV" value="csv">
                        <label class="form-check-label" for="backupCSV">CSV</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="backupFormat" id="backupExcel" value="excel">
                        <label class="form-check-label" for="backupExcel">Excel</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Enkripsi Data</label>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="encryptData">
                        <label class="form-check-label" for="encryptData">Enkripsi dengan password</label>
                    </div>
                </div>
                
                <div id="passwordSection" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" class="form-control" id="backupPassword">
                        </div>
                        <div class="form-group">
                            <label>Konfirmasi Password</label>
                            <input type="password" class="form-control" id="backupPasswordConfirm">
                        </div>
                    </div>
                </div>
                
                <div class="backup-status">
                    <h4>Backup Terakhir:</h4>
                    <div class="backup-item">
                        <span>Full Backup</span>
                        <span>2 hari lalu</span>
                    </div>
                    <div class="backup-item">
                        <span>Data Pelanggan</span>
                        <span>1 minggu lalu</span>
                    </div>
                    <div class="backup-item">
                        <span>Data Tagihan</span>
                        <span>3 hari lalu</span>
                    </div>
                </div>
                
                <div id="backupProgress" style="margin-top: 20px; display: none;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4>Progress Backup:</h4>
                        <div style="background: #e9ecef; height: 10px; border-radius: 5px; margin: 10px 0;">
                            <div id="progressBar" style="background: var(--primary); height: 100%; width: 0%; border-radius: 5px; transition: width 0.3s;"></div>
                        </div>
                        <div id="progressText" style="text-align: center; font-weight: bold;">0%</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalBackup')">Batal</button>
                <button class="btn btn-info" onclick="startBackup()">
                    <i class="fas fa-play"></i> Mulai Backup
                </button>
                <button class="btn btn-success" onclick="restoreBackup()">
                    <i class="fas fa-upload"></i> Restore
                </button>
            </div>
        </div>
    </div>


    <!-- MODAL: DETAIL LUNAS BULAN INI -->
<div class="modal-overlay hidden" id="modalLunasBulanIni">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-check-circle" style="color: var(--success);"></i> Detail Pelunasan Bulan Ini</h3>
            <button class="modal-close" onclick="hideModal('modalLunasBulanIni')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">No</th>
                            <th style="width: 20%;">Nama</th>
                            <th style="width: 15%;">Tagihan</th>
                            <th style="width: 15%;">Periode</th>
                            <th style="width: 10%;">Status</th>
                            <th style="width: 15%;">Tgl Bayar</th>
                            <th style="width: 20%;">Petugas</th>
                        </tr>
                    </thead>
                    <tbody id="lunasBulanIniTable">
                        <tr><td colspan="8" class="text-center">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div id="lunasPagination" class="mt-3"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalLunasBulanIni')">Tutup</button>
        </div>
    </div>
</div>


<!-- MODAL: DETAIL TUNGGAKAN -->
<div class="modal-overlay hidden" id="modalDetailTunggakan">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-clock" style="color: var(--danger);"></i> Detail Tunggakan</h3>
            <button class="modal-close" onclick="hideModal('modalDetailTunggakan')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Nama</th>
                            <th>Total Tunggakan</th>
                            <th>Periode (Belum Bayar)</th>
                        </tr>
                    </thead>
                    <tbody id="tunggakanTable">
                        <!-- Data akan diisi oleh JS -->
                    </tbody>
                </table>
            </div>
            <div id="tunggakanPagination" class="mt-3"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalDetailTunggakan')">Tutup</button>
        </div>
    </div>
</div>


    
    <!-- ========== ALL JAVASCRIPT ========== -->
    <script>
        // ============================================
        // CONFIGURATION & INITIALIZATION
        // ============================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyBocAz1byGPHa3ky2Wsj5wQMCtAHdJH48w",
            authDomain: "dnt-network-nota.firebaseapp.com",
            projectId: "dnt-network-nota",
            storageBucket: "dnt-network-nota.firebasestorage.app",
            messagingSenderId: "896578021877",
            appId: "1:896578021877:web:2c882371b4673e7c18d8bc",
            measurementId: "G-NJYGGK0S0H"
        };
        
        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized");
        } catch (error) {
            console.log("Firebase already initialized");
        }
        
        const db = firebase.firestore();
        let currentUser = null;
        let currentPage = 'dashboard';
        let pelangganData = [];
        let paketData = [];
        let tagihanData = [];
        let globalDataPelanggan = {};
        let globalCompanyId = null; // Variabel global untuk menyimpan ID Perusahaan saat ini

        



        // Tambah di awal script setelah deklarasi variabel lain (line ~96)
let currentPagePelanggan = 1;
let currentPageTagihan = 1;
let currentPageTunggakan = 1;
let currentPagePaket = 1;
let currentPageAktivitas = 1; // Variable untuk halaman aktivitas
const itemsPerPage = 10;



// ============================================
// SISTEM KEAMANAN LOGIN
// ============================================
let loginAttempts = 0;
let lastFailedAttempt = 0;
const MAX_LOGIN_ATTEMPTS = 3;
const LOCKOUT_DURATION = 5 * 60 * 1000; // 5 menit dalam milidetik

// COPY INI, PASTE DI BAWAH VARIABLE globalCompanyId (sekitar line 96-100):
function getUserLogName() {
    return currentUser?.email || "Admin";
}

function checkLoginLockout() {
    const now = Date.now();
    const timeSinceLastFail = now - lastFailedAttempt;
    
    // Jika sudah melebihi batas percobaan dan masih dalam waktu lockout
    if (loginAttempts >= MAX_LOGIN_ATTEMPTS && timeSinceLastFail < LOCKOUT_DURATION) {
        const remainingMinutes = Math.ceil((LOCKOUT_DURATION - timeSinceLastFail) / 60000);
        return {
            locked: true,
            remainingMinutes: remainingMinutes
        };
    }
    
    // Reset counter jika sudah lewat waktu lockout
    if (timeSinceLastFail >= LOCKOUT_DURATION) {
        loginAttempts = 0;
        lastFailedAttempt = 0;
        localStorage.removeItem('loginAttempts');
        localStorage.removeItem('lastFailedAttempt');
    }
    
    return { locked: false };
}

function recordFailedLogin() {
    loginAttempts++;
    lastFailedAttempt = Date.now();
    
    // Simpan ke localStorage agar persist saat refresh
    localStorage.setItem('loginAttempts', loginAttempts.toString());
    localStorage.setItem('lastFailedAttempt', lastFailedAttempt.toString());
    
    console.log(`❌ Login gagal. Percobaan ke-${loginAttempts}/${MAX_LOGIN_ATTEMPTS}`);
    
    // Jika melebihi batas, lock
    if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
        console.log(`🔒 Akun terkunci selama ${LOCKOUT_DURATION/60000} menit`);
    }
}

function resetLoginAttempts() {
    loginAttempts = 0;
    lastFailedAttempt = 0;
    localStorage.removeItem('loginAttempts');
    localStorage.removeItem('lastFailedAttempt');
    console.log("✅ Reset login attempts");
}

// Load saved attempts saat halaman dimuat
document.addEventListener('DOMContentLoaded', function() {
    const savedAttempts = localStorage.getItem('loginAttempts');
    const savedLastFail = localStorage.getItem('lastFailedAttempt');
    
    if (savedAttempts) loginAttempts = parseInt(savedAttempts);
    if (savedLastFail) lastFailedAttempt = parseInt(savedLastFail);
    
    console.log(`📊 Login attempts loaded: ${loginAttempts}/${MAX_LOGIN_ATTEMPTS}`);
});
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function showLoading() {
            
        }
        
        function hideLoading() {
            
        }
        
        function showToast(type, title, message, duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-times-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.id = toastId;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="${icons[type]}"></i>
                </div>
                <div class="toast-body">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }
        
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }
        
       function hideModal(modalId) {
    const modalEl = typeof modalId === 'string' 
        ? document.getElementById(modalId) 
        : modalId;
    
    if (!modalEl) {
        console.warn(`Modal ${modalId} tidak ditemukan`);
        return;
    }
    
    try {
        modalEl.classList.remove('show');
        modalEl.classList.add('hidden');
        document.body.style.overflow = 'auto';
        console.log(`Modal ${modalEl.id} ditutup`);
    } catch (error) {
        console.error("Error hideModal:", error);
    }
}


async function ensureCompanyId() {
    // 1. Pastikan User Sudah Login
    if (!currentUser || !currentUser.uid) {
        console.error("User belum login!");
        return null; // ⭐ PERBAIKAN: return null, bukan false
    }

    // 2. Cek apakah variabel global sudah ada (agar tidak baca database berulang-ulang)
    if (globalCompanyId) {
        return globalCompanyId;
    }

    try {
        console.log("🔍 Mengecek Company ID untuk user:", currentUser.email);

        // 3. Ambil data user dari collection 'users'
        const userDocRef = db.collection('users').doc(currentUser.uid);
        const userDoc = await userDocRef.get();

        if (userDoc.exists) {
            const userData = userDoc.data();
            globalCompanyId = userData.company_id || null;
            
            if (globalCompanyId) {
                console.log("✅ Company ID ditemukan:", globalCompanyId);
                return globalCompanyId;
            } else {
                console.warn("⚠️ Data user ada tapi company_id kosong. Membuat baru...");
            }
        }

        // 4. Jika belum ada company_id, Buat Baru
        const newCompanyId = `COMP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        await userDocRef.set({
            uid: currentUser.uid,
            email: currentUser.email,
            name: currentUser.displayName || currentUser.email.split('@')[0],
            company_id: newCompanyId,
            role: 'admin',
            created_at: new Date().toISOString()
        });

        await db.collection('companies').doc(newCompanyId).set({
            id: newCompanyId,
            admin_email: currentUser.email,
            created_at: new Date().toISOString()
        });

        globalCompanyId = newCompanyId;
        console.log("✅ Company ID baru dibuat:", globalCompanyId);
        
        return globalCompanyId;

    } catch (error) {
        console.error("❌ Error ensureCompanyId:", error);
        return null; // ⭐ PERBAIKAN: return null, bukan false
    }
}

async function handleLoginSuccess() {
    try {
        console.log("✅ Login berhasil, menyiapkan aplikasi...");
        
        // 1. Tampilkan UI
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('appContainer').classList.remove('hidden');
        
        // 2. AMBIL NAMA USER
        let displayName = localStorage.getItem('userName') || 'Administrator';
        
        console.log("👤 Nama user:", displayName);
        
        // 3. UPDATE NAVBAR USER
        const userNameEl = document.getElementById('userName');
        const userAvatarEl = document.getElementById('userAvatar');
        const userRoleEl = document.getElementById('userRole');
        
        if (userNameEl) {
            userNameEl.innerText = displayName; // ⭐ Ganti textContent dengan innerText
            // Paksa re-render untuk mobile
            userNameEl.style.display = 'none';
            userNameEl.offsetHeight; 
            userNameEl.style.display = '';
        }
        
        if (userAvatarEl) userAvatarEl.textContent = displayName.charAt(0).toUpperCase();
        if (userRoleEl) {
            const roleMapping = {'admin': 'Admin'};
            const userRole = currentUser?.role || localStorage.getItem('userRole') || 'admin';
            userRoleEl.textContent = roleMapping[userRole] || userRole;
        }
        
        // 4. ⭐⭐ INI YANG PERLU DITAMBAH - LOAD PROFIL PERUSAHAAN ⭐⭐
        console.log("🔄 Memuat profil perusahaan...");
        await loadCompanyProfile();
        
        // 5. Load data lainnya
        await loadAllDataOnce();
        await loadPage('dashboard');
        
        // 6. TOAST
        showToast('success', 'Login Berhasil', `Selamat datang ${displayName}!`);
        
        setTimeout(() => {
            initializeQuickActions();
        }, 200);
        
    } catch (error) {
        console.error("❌ Error handleLoginSuccess:", error);
        showToast('error', 'Error', 'Gagal memuat aplikasi');
    }
}

// Fungsi pagination umum (tambah setelah fungsi utility)
function renderPagination(totalItems, currentPage, pageType, containerId) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    if (totalPages <= 1) return '';
    
    let html = '<div class="pagination">';
    
    // 1. TOMBOL KIRI (<)
    if (currentPage > 1) {
        html += `<a class="page-link" onclick="changePage('${pageType}', ${currentPage - 1})">&lt;</a>`;
    }
    
    // 2. TOMBOL RENTANG HALAMAN 1-10
    // Hitung blok (1-10, 11-20, dst)
    const startBlock = Math.floor((currentPage - 1) / 10) * 10 + 1;
    const endBlock = Math.min(startBlock + 9, totalPages);
    
    // Spasi agar tidak berdempetan
    if (startBlock > 1) html += ` `;
    html += `<a class="page-link" onclick="changePage('${pageType}', ${startBlock})">${startBlock}-${endBlock}</a>`;
    if (endBlock < totalPages) html += ` `;
    
    // 3. TOMBOL KANAN (>)
    if (currentPage < totalPages) {
        html += `<a class="page-link" onclick="changePage('${pageType}', ${currentPage + 1})">&gt;</a>`;
    }
    
    html += '</div>';
    
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = html;
    }
}

async function autoGenerateTagihanArrears() {
    console.log("🤖 Cek auto-generate tagihan...");
    
    // Cek jika tanggal 1-3 di awal bulan
    const today = moment();
    if (today.date() > 3) {
        console.log("⚠️ Bukan awal bulan (tanggal 1-3), skip auto-generate");
        return;
    }
    
    try {
        // Tentukan bulan tagihan (bulan sebelumnya)
        const bulanKemarin = today.subtract(1, 'month').format('MM-YYYY');
        const bulanSekarang = today.format('MM-YYYY');
        
        console.log(`📅 Auto-generate untuk pemakaian: ${bulanKemarin}`);
        
        // Cek apakah sudah digenerate bulan ini
        const checkSnapshot = await db.collection('tagihan')
            .where('bulan', '==', bulanKemarin)
            .limit(1)
            .get();
        
        if (!checkSnapshot.empty) {
            console.log(`✅ Tagihan ${bulanKemarin} sudah digenerate, skip`);
            return;
        }
        
        // Generate otomatis
        console.log(`🚀 Mulai auto-generate tagihan untuk ${bulanKemarin}`);
        
        // Panggil fungsi generate dengan parameter bulan sekarang
        // (karena generate di bulan sekarang untuk pemakaian bulan sebelumnya)
        const event = { preventDefault: () => {} };
        await generateTagihanBulk();
        
        // Log aktivitas auto-generate
        await db.collection('aktivitas').add({
            aktiviuser: getUserLogName(),
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        console.error("❌ Error auto-generate:", error);
    }
}

// Panggil saat app load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        autoGenerateTagihanArrears();
    }, 5000); // Delay 5 detik setelah app load
});

function changePage(pageType, pageNumber) {
    switch(pageType) {
        case 'pelanggan':
            currentPagePelanggan = pageNumber;
            loadPelangganData();
            break;
        case 'tagihan':
            currentPageTagihan = pageNumber;
            loadTagihanData();
            break;
        case 'tunggakan':
            currentPageTunggakan = pageNumber;
            loadTunggakanData();
            break;
        case 'paket':
            currentPagePaket = pageNumber;
            loadPaketData();
            break;
    }
}

function getPaginatedData(data, currentPage) {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    return data.slice(startIndex, endIndex);
}
        
        function confirmDialog(message, callback) {
            if (confirm(message)) {
                callback();
            }
        }
        
        // Generate unique ID
        function generateId(prefix = '') {
            return prefix + Date.now() + Math.random().toString(36).substr(2, 9);
        }
        
        
        
        // ============================================
        // PAGE TEMPLATES
        // ============================================
        
        async function getDashboardHTML() {
    return `
        <div class="page dashboard-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-home"></i> Dashboard</h2>
                <button class="btn btn-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            
            <div class="stats-grid">
                <!-- CARD 1: TOTAL PELANGGAN -->
                <div class="stat-card" onclick="navigateToPelanggan()" style="cursor: pointer;">
                    <div class="stat-icon primary">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="statPelanggan">0</div>
                        <div class="stat-label">Total Pelanggan</div>
                        <div class="stat-action" style="margin-top: 8px; font-size: 12px; color: #4361ee;">
                            <i class="fas fa-external-link-alt"></i> Klik untuk lihat detail
                        </div>
                    </div>
                </div>
                
                <!-- CARD 2: TAGIHAN BULAN INI -->
                <div class="stat-card" onclick="navigateToTagihan()" style="cursor: pointer;">
                    <div class="stat-icon success">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="statTagihanBulanan">Rp 0</div>
                        <div class="stat-label">Tagihan Bulan Ini</div>
                        <div class="stat-action" style="margin-top: 8px; font-size: 12px; color: #00b894;">
                            <i class="fas fa-external-link-alt"></i> Klik untuk lihat tagihan
                        </div>
                    </div>
                </div>
                
                <!-- CARD 3: LUNAS -->
                <div class="stat-card" onclick="showLunasBulanIni()" style="cursor: pointer;">
    <div class="stat-icon success">
        <i class="fas fa-check-circle"></i>
    </div>
    <div class="stat-content">
        <!-- Angka Persentase -->
        <div class="stat-value" id="statLunasPersen">0%</div>
        
        <!-- Label & Detail Jumlah -->
        <div class="stat-label">Pelunasan Bulan Ini</div>
        <div class="stat-detail" style="font-size: 12px; color: #666; margin-top: 4px;">
            <span id="statLunasCount">0</span> dari <span id="statTotalPelanggan">0</span> Pelanggan
        </div>
        
        <div class="stat-action" style="margin-top: 8px; font-size: 12px; color: #00b894;">
            <i class="fas fa-list-ul"></i> Klik untuk lihat detail
        </div>
    </div>
</div>
                
                <!-- CARD 4: TUNGGAKAN -->
<div class="stat-card" onclick="showDetailTunggakan()" style="cursor: pointer;">
    <div class="stat-icon danger">
        <i class="fas fa-clock"></i>
    </div>
    <div class="stat-content">
    <!-- Nilai Nominal (Rupiah) -->
    <div class="stat-value" id="statTunggakan">Rp 0</div>
    
    <!-- Label -->
    <div class="stat-label">Total Tunggakan</div>
    
    <!-- Aksi -->
    <div class="stat-action" style="margin-top: 8px; font-size: 12px; color: #ff6b6b;">
        <i class="fas fa-external-link-alt"></i> Klik untuk lihat detail
    </div>
</div>
</div>
            </div>
            
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Tagihan 6 Bulan Terakhir</h3>
                    <canvas id="chartTagihan" height="150"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Status Pelanggan</h3>
                    <canvas id="chartStatus" height="150"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3>Aktivitas Terbaru</h3>
                </div>
                                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Waktu</th>
                                        <th>Aktivitas</th>
                                        <th>User</th>
                                    </tr>
                                </thead>
                                <tbody id="aktivitasTable">
                                    <tr><td colspan="3" class="text-center">Memuat aktivitas...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- ⭐ TAMBAHKAN CONTAINER PAGINATION INI ⭐ -->
                        <div id="aktivitasPagination"></div>
                    </div>
            </div>
        </div>
    `;
}

// TAMBAHKAN FUNGSI-FUNGSI UNTUK HANDLE KLIK CARD:

// Fungsi untuk navigasi ke halaman Pelanggan
function navigateToPelanggan() {
    console.log("Navigasi ke halaman Pelanggan");
    loadPage('pelanggan');
}

// Fungsi untuk navigasi ke halaman Tagihan
function navigateToTagihan() {
    console.log("Navigasi ke halaman Tagihan");
    loadPage('tagihan');
}

// Fungsi untuk filter tagihan lunas
function filterTagihanLunas() {
    console.log("Filter tagihan lunas");
    loadPage('tagihan');
    
    // Tunggu sedikit untuk memastikan halaman sudah load
    setTimeout(() => {
        const filterStatus = document.getElementById('filterStatusTagihan');
        if (filterStatus) {
            filterStatus.value = 'lunas';
            loadTagihanData();
            showToast('success', 'Filter', 'Menampilkan tagihan yang sudah lunas');
        }
    }, 500);
}

// Fungsi untuk filter tagihan tunggakan
function filterTagihanTunggakan() {
    console.log("Filter tagihan tunggakan");
    loadPage('tunggakan');
}

// FUNGSI INITIALIZE QUICK ACTIONS (Pastikan ada di file):
function initializeQuickActions() {
    console.log("⚡ Initializing quick actions dengan...");
    
    // Generate Tagihan ARREARS
    document.getElementById('btnGenerateTagihan')?.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log("🔘 Quick Action: Generate Tagihan");
        
        const modal = document.getElementById('modalGenerateTagihan');
        if (modal) {
            // Reset dan setup modal arrears
            modal.classList.remove('hidden');
            modal.classList.add('show');
            modal.style.display = 'flex';
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            modal.style.zIndex = '9999';
            
            // Hapus scroll body
            document.body.style.overflow = 'hidden';
            
            // Set default values untuk arrears
            const bulanIni = moment().format('MM-YYYY');
            document.getElementById('generateBulan').value = bulanIni;
            document.getElementById('generateJatuhTempo').value = 10;
            
            // Reset checkbox
            document.getElementById('generateProrata').checked = true;
            document.getElementById('generateEmail').checked = false;
            document.getElementById('generateWhatsapp').checked = false;
            
            // Load data dan update timeline
            setTimeout(() => {
                loadTunggakanDataForModal();
            }, 300);
            
        }
    });
    
    
    // Kirim Reminder
    const btnReminder = document.getElementById('btnKirimReminder');
    if (btnReminder) {
        btnReminder.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Tombol Kirim Reminder diklik");
            
            const modal = document.getElementById('modalReminder');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('show');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                showToast('info', 'Kirim Reminder', 'Membuka form kirim reminder');
            }
        });
    }
    
    // Export Laporan
    const btnExport = document.getElementById('btnExportLaporan');
    if (btnExport) {
        btnExport.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Tombol Export Laporan diklik");
            
            const modal = document.getElementById('modalExportLaporan');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('show');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                showToast('info', 'Export Laporan', 'Membuka form export laporan');
            }
        });
    }
    
    // Backup Data
    const btnBackup = document.getElementById('btnBackupData');
    if (btnBackup) {
        btnBackup.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Tombol Backup Data diklik");
            
            const modal = document.getElementById('modalBackup');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('show');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                showToast('info', 'Backup Data', 'Membuka form backup data');
            }
        });
    }
    
    console.log("✅ Quick Actions berhasil diinisialisasi");
}

// FUNGSI UNTUK LOAD DAN TAMPILKAN DATA TUNGGAKAN DI MODAL
async function loadTunggakanDataForModal() {
    console.log("📊 Loading data untuk modal generate...");
    
    try {
        const pelangganSnapshot = await db.collection('pelanggan')
            .where('status', '==', 'aktif')
            .get();
        
        const totalAktif = pelangganSnapshot.size;
        
        document.getElementById('summaryTotalAktif').textContent = totalAktif;
        
        updateArrearsTimeline();
        
        showToast('success', 'Data Dimuat', `${totalAktif} pelanggan aktif siap digenerate`);
        
    } catch (error) {
        console.error("❌ Error load data untuk modal:", error);
        showToast('error', 'Error', 'Gagal memuat data');
    }
}

// FUNGSI UNTUK UPDATE ESTIMASI GENERATE
function updateGenerateEstimation(totalAktif, totalTunggak, totalTunggakan) {
    try {
        const filter = document.getElementById('filterTunggakan').value;
        const bulanGenerateInput = document.getElementById('generateBulan').value;
        
        if (!bulanGenerateInput) return;
        
        const bulanGenerate = moment(bulanGenerateInput, 'YYYY-MM');
        const bulanPemakaian = bulanGenerate.clone().subtract(1, 'month');
        
        // Hitung berdasarkan filter
        let estimasiJumlah = totalAktif;
        
        switch(filter) {
            case 'exclude_tunggakan':
                estimasiJumlah = totalAktif - totalTunggak;
                break;
            case 'only_tunggakan':
                estimasiJumlah = totalTunggak;
                break;
            case 'exclude_berat':
                estimasiJumlah = Math.round(totalAktif * 0.8); // Asumsi 20% berat
                break;
        }
        
        // Asumsi rata-rata harga 150rb
        const rataHarga = 150000;
        const estimasiTotal = estimasiJumlah * rataHarga;
        
        // Update UI
        document.getElementById('summaryJumlahTagihan').textContent = estimasiJumlah;
        document.getElementById('summaryEstimasiTotal').textContent = formatRupiah(estimasiTotal);
        document.getElementById('summaryWaktu').textContent = `~${Math.ceil(estimasiJumlah / 10)} detik`;
        document.getElementById('summaryBulanPemakaian').textContent = bulanPemakaian.format('MMMM YYYY');
        
    } catch (error) {
        console.error("Error update estimation:", error);
    }
}

// FUNGSI TOGGLE FILTER
function toggleTunggakanFilter() {
    const filter = document.getElementById('filterTunggakan').value;
    const kategoriSelect = document.getElementById('kategoriTunggakan');
    
    // Enable kategori hanya jika filter khusus tunggakan
    if (filter === 'only_tunggakan') {
        kategoriSelect.disabled = false;
    } else {
        kategoriSelect.disabled = true;
        kategoriSelect.value = 'all';
    }
    
    // Refresh estimasi jika ada data
    const totalAktif = parseInt(document.getElementById('summaryTotalAktif').textContent) || 0;
    const totalTunggak = parseInt(document.getElementById('summaryTunggakan').textContent) || 0;
    const totalTunggakanText = document.getElementById('summaryTotalTunggakan').textContent;
    const totalTunggakan = parseFloat(totalTunggakanText.replace(/[^0-9]/g, '')) || 0;
    
    updateGenerateEstimation(totalAktif, totalTunggak, totalTunggakan);
}
        

       async function getPelangganHTML() {
    return `
        <div class="page pelanggan-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-users"></i> Data Pelanggan</h2>
                <div class="action-buttons">
                    <!-- TOMBOL IMPORT/EXPORT -->
                    <button class="btn btn-outline" onclick="showImportExportPanel()">
                        <i class="fas fa-file-import"></i> Import/Export
                    </button>
                    <button class="btn btn-primary" onclick="showAddPelangganModal()">
                        <i class="fas fa-plus"></i> Tambah Pelanggan
                    </button>
                </div>
            </div>
            
            <!-- PANEL IMPORT/EXPORT (AWALNYA DISEMBUNYIKAN) -->
            <div id="importExportPanel" class="card hidden" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h3><i class="fas fa-file-import"></i> Import & Export Data Pelanggan</h3>
                    <button class="btn btn-sm btn-outline" onclick="hideImportExportPanel()">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- IMPORT SECTION -->
                        <div>
                            <h4><i class="fas fa-upload"></i> Import Data</h4>
                            <div class="form-group">
                                <label>Pilih File Excel/CSV</label>
                                <input type="file" class="form-control" id="fileImportPelanggan" 
                                       accept=".xlsx,.xls,.csv">
                                <small class="text-muted">Format: Excel (.xlsx, .xls) atau CSV</small>
                            </div>
                            <button class="btn btn-success" onclick="importDataPelanggan()">
                                <i class="fas fa-upload"></i> Import Data
                            </button>
                        </div>
                        
                        <!-- EXPORT SECTION -->
                        <div>
                            <h4><i class="fas fa-download"></i> Export Data</h4>
                             <button class="btn btn-primary" onclick="exportDataPelanggan()">
                                <i class="fas fa-download"></i> Export Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- FILTERS (SUDAH DITAMBAHKAN DISINI) -->
            <div class="filters-card">
                <div class="filter-row">
                    <div class="form-group">
                        <label>Status</label>
                        <select class="form-control" id="filterStatus" onchange="saveFilterState(); loadPelangganData()">

                            <option value="">Semua Status</option>
                            <option value="aktif">Aktif</option>
                            <option value="nonaktif">Nonaktif</option>
                            <option value="tunggak">Tunggak</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Paket</label>
                        <select class="form-control" id="filterPaket" onchange="saveFilterState(); loadPelangganData()">

                            <option value="">Semua Paket</option>
                            <!-- OPSI PAKET AKAN DIISI OLEH JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cari</label>
                        <input type="text" class="form-control" id="searchPelanggan" 
                               placeholder="Nama, alamat, atau telepon..." oninput="loadPelangganData()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-outline" onclick="loadPelangganData()" style="margin-top: 25px;">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- CARD TABEL PELANGGAN -->
            <div class="card">
                <div class="card-header">
                    <h3>Daftar Pelanggan</h3>
                    <div class="btn-group">
                        
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Nama</th>
                                    <th>Telepon</th>
                                    <th>Alamat</th>
                                    <th>Paket</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="pelangganTable">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto;"></div>
                                        Memuat data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- PAGINATION -->
                    <div id="pelangganPagination" class="mt-3"></div>
                </div>
            </div>
        </div>
    `;
}
        
        async function getPaketHTML() {
            return `
                <div class="page paket-page">
                    <div class="page-header">
                        <h2 class="page-title"><i class="fas fa-wifi"></i> Data Paket Internet</h2>
                        <div>
                            <button class="btn btn-outline" onclick="exportPaket()">
                                <i class="fas fa-file-export"></i> Export
                            </button>
                            <button class="btn btn-primary" onclick="showAddPaketModal()">
                                <i class="fas fa-plus"></i> Tambah Paket
                            </button>
                        </div>
                    </div>
                    
                    
                    
                    <div class="card">
                <div class="card-header">
                    <h3>Detail Paket</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nama Paket</th>
                                    <th>Kecepatan</th>
                                    <th>Harga</th>
                                    <th>Kuota</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="paketTable">
                                <!-- Data akan diisi -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- PAGINATION CONTAINER -->
                    <div id="paketPagination"></div>
                    
                    <div style="margin-top: 10px; color: var(--gray); font-size: 14px;">
                        Menampilkan <span id="paketStart">0</span>-<span id="paketEnd">0</span> dari 
                        <span id="paketTotal">0</span> paket
                    </div>
                </div>
            </div>
        </div>
    `;
}
        
        async function getTagihanHTML() {
    return `
        <div class="page tagihan-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-receipt"></i> Tagihan </h2>
                <div class="action-buttons">
                    
                    <button class="btn btn-warning" onclick="resetGenerate()">
                        <i class="fas fa-trash-restore"></i> Reset Generate
                    </button>
                    
                    <button class="btn btn-primary" onclick="openGenerateModal()">
                        <i class="fas fa-bolt"></i> Generate Tagihan 
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
    <h3>Daftar Tagihan </h3>
    <div class="btn-group">
        <!-- INPUT PENCARIAN (BARU) -->
        <input type="text" id="searchTagihan" 
               class="form-control" 
               placeholder="Cari nama,alamat,dll..." 
               style="width: 200px; display: inline-block; height: 38px; padding: 5px 10px; margin-right: 10px;" 
               autocomplete="off" 
               oninput="filterTagihanSearch(this.value)">
               
        
    </div>
</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
    <tr>
        <th style="width: 25%;">Pelanggan</th> <!-- Melebar -->
        <th style="width: 20%;">Alamat</th> <!-- KOLOM BARU -->
        <th style="width: 10%;">Bulan</th>
        <th style="width: 15%;">Total Tagihan</th>
        <th style="width: 10%;">Status</th>
        <th style="width: 20%;">Aksi</th>
    </tr>
</thead>
                            <tbody id="tagihanTable">
                                <tr>
                                    <td colspan="4" class="text-center">Memuat data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="tagihanPagination" class="mt-3"></div>
                </div>
            </div>
        </div>
    `;
}

async function resetGenerate() {
    if (!confirm('PERINGATAN!\n\nIni akan MENGHAPUS SEMUA data tagihan yang belum lunas.\nData pelanggan tetap aman.\n\nLanjutkan?')) {
        return;
    }

    try {
        showLoading();
        // Hapus hanya status 'belum'
        const snapshot = await db.collection('tagihan').where('status', '==', 'belum').get();
        const batch = db.batch();

        snapshot.forEach(doc => {
            batch.delete(doc.ref);
        });

        await batch.commit();
        hideLoading();
       

        
            await loadTagihanData();
        

    } catch (error) {
        hideLoading();
        console.error("Error reset:", error);
        showToast('error', 'Gagal', 'Gagal mereset tagihan: ' + error.message);
    }
}

// Fungsi Khusus untuk Buka Modal Generate Tagihan (Fix Tidak Bisa Muncul)
function openGenerateModal() {
    console.log("🔘 Membuka Modal Generate Tagihan...");
    
    const modal = document.getElementById('modalGenerateTagihan');
    if (!modal) {
        showToast('error', 'Error', 'Modal tidak ditemukan di DOM');
        return;
    }

    // Set nilai default
    const bulanInput = document.getElementById('generateBulan');
    if (bulanInput) bulanInput.value = moment().format('YYYY-MM'); // Sesuaikan format input type="month"

    // Tampilkan modal
    modal.classList.remove('hidden');
    modal.classList.add('show');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Kunci scroll body

    // Refresh data
    setTimeout(() => {
        loadTunggakanDataForModal();
    }, 300);
}
        
        // ============================================
// HALAMAN HTML: MENU TUNGGAKAN
// ============================================

async function getTunggakanHTML() {
    return `
        <div class="page tunggakan-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-clock"></i> Tunggakan</h2>
                <div class="action-buttons">
                    <button class="btn btn-outline" onclick="exportTunggakan()">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                    <button class="btn btn-success" onclick="showModal('modalReminder')">
                        <i class="fas fa-envelope"></i> Kirim Reminder
                    </button>
                    <button class="btn btn-info" onclick="location.reload()">
                        <i class="fas fa-sync-alt"></i> Refresh Data
                    </button>
                </div>
            </div>
            
            <!-- KARTU STATISTIK (TETAP ADA) -->
            <div class="stats-grid">
                <div class="stat-card" onclick="filterTunggakanTable('ringan')" style="cursor: pointer;">
                    <div class="stat-icon warning">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="tunggakanRingan">0</div>
                        <div class="stat-label">Ringan (1-30 Hari)</div>
                    </div>
                </div>
                
                <div class="stat-card" onclick="filterTunggakanTable('sedang')" style="cursor: pointer;">
                    <div class="stat-icon danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="tunggakanSedang">0</div>
                        <div class="stat-label">Sedang (31-60 Hari)</div>
                    </div>
                </div>
                
                <div class="stat-card" onclick="filterTunggakanTable('berat')" style="cursor: pointer;">
                    <div class="stat-icon primary">
                        <i class="fas fa-ban"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="tunggakanBerat">0</div>
                        <div class="stat-label">Berat (>60 Hari)</div>
                    </div>
                </div>
                
                <div class="stat-card" onclick="filterTunggakanTable('semua')" style="cursor: pointer;">
                    <div class="stat-icon info">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalTunggakanUang">Rp 0</div>
                        <div class="stat-label">Total Nominal</div>
                    </div>
                </div>
            </div>

            <!-- TABEL DATA TUNGGAKAN (DENGAN INPUT CARI) -->
            <div class="card">
                <div class="card-header">
                    <h3>Daftar Pelanggan Menunggak</h3>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <!-- INPUT PENCARIAN -->
                        <input type="text" id="searchTunggakan" 
                               class="form-control" 
                               placeholder="Cari nama/telepon..." 
                               style="width: 250px; display: inline-block;" 
                               autocomplete="off" 
                               oninput="filterTunggakanSearch(this.value)">
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Pelanggan</th>
                                    <th>Bulan Tagihan</th>
                                    <th>Nominal</th>
                                    <th>Jatuh Tempo</th>
                                    <th>Lama Telat</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tunggakanTable">
                                <tr>
                                    <td colspan="7" class="text-center">Memuat data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- PAGINATION CONTAINER -->
                    <div id="tunggakanPagination"></div>
                </div>
            </div>
        </div>
    `;
}


// ============================================
// FUNGSI PENCARIAN TUNGGAKAN (SEARCH)
// ============================================

function filterTunggakanSearch(keyword) {
    console.log("🔍 Mencari:", keyword);
    
    const table = document.getElementById('tunggakanTable');
    if (!table) {
        console.warn("⚠️ Tabel #tunggakanTable tidak ditemukan!");
        return;
    }
    
    const rows = table.getElementsByTagName('tr');
    const filterLower = keyword.toLowerCase();
    
    // Loop mulai dari 1 (skip header)
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        
        // Pastikan ada sel sebelum diambil textContent
        if (cells.length > 0) {
            // Cari di Kolom Nama (td 0) atau Telepon (td 0 small)
            // Ambil textContent dari cell pertama (Nama Pelanggan)
            const textData = cells[0].textContent || "";
            
            // Cek apakah keyword ada di text
            if (textData.toLowerCase().indexOf(filterLower) > -1) {
                row.style.display = ""; 
            } else {
                row.style.display = "none"; 
            }
        }
    }
}


// ============================================
// FUNGSI PENDUKUNG (WAJIB ADA)
// ============================================

function gantiHalamanTunggakan(pageNum, kategori = 'semua') {
    halamanTunggakanSaatIni = pageNum;
    loadTunggakanData(kategori);
}

function filterTunggakanTable(kategori) {
    console.log(`🔍 Filter kartu: ${kategori}`);
    
    // Reset input pencarian menjadi kosong
    const searchInput = document.getElementById('searchTunggakan');
    if (searchInput) searchInput.value = '';
    
    // Panggil load data
    loadTunggakanData(kategori);
    
   
}


async function showPayAllModal(pelangganId) {
    console.log("💳 Membuka Modal Bayar Semua...");
    
    try {
        // 1. Ambil data pelanggan
        const docPel = await db.collection('pelanggan').doc(pelangganId).get();
        if (!docPel.exists) throw new Error("Pelanggan tidak ditemukan");
        
        const dataPel = docPel.data();
        const namaPel = dataPel.nama;

        // 2. Ambil data tagihan yang BELUM LUNAS pelanggan ini
        const snapshot = await db.collection('tagihan')
            .where('pelanggan_id', '==', pelangganId)
            .where('status', 'in', ['belum', 'telat'])
            .get();
        
        if (snapshot.empty) {
            showToast('info', 'Info', 'Tidak ada tagihan tertunggak.');
            return;
        }

        let listTagihan = [];
        let totalNominal = 0;
        let idsString = "";

        snapshot.forEach(doc => {
            const t = doc.data();
            listTagihan.push(t);
            totalNominal += Number(t.jumlah) || 0;
            idsString += doc.id + ",";
        });

        // Hapus koma terakhir
        idsString = idsString.slice(0, -1);

        // 3. Generate ID Bulan String (Misal: Jan, Feb)
        const bulanList = listTagihan.map(t => {
            const parts = (t.bulan || '').split('-');
            if (parts.length === 2) {
                const dateObj = moment(`${parts[1]}-${parts[0]}-01`);
                return dateObj.format('MMM YY');
            }
            return t.bulan;
        }).join(', ');

        // 4. Buat Modal "Pay All" Dinamis
        const modalId = 'modalPayAllDynamic';
        const oldModal = document.getElementById(modalId);
        if (oldModal) oldModal.remove();

        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal-overlay show';
        modal.style.zIndex = '1060';
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        modal.innerHTML = `
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Pembayaran Tunggakan</h3>
                    <button class="modal-close" onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto';">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4>${namaPel}</h4>
                        <p style="margin: 5px 0; color: #666;">Total Tagihan: <strong>${formatRupiah(totalNominal)}</strong></p>
                        <p style="margin: 0; font-size: 13px;">Periode: ${bulanList}</p>
                    </div>

                    <div class="form-group">
                        <label>Metode Pembayaran</label>
                        <select id="payAllMetode" class="form-control">
                            <option value="Tunai">Tunai</option>
                            <option value="Transfer Bank">Transfer Bank</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto';">Batal</button>
                    <button id="btnExecutePayAll" class="btn btn-success" onclick="executePayAllDirect('${pelangganId}', '${idsString}', ${totalNominal}, '${bulanList}', '${modalId}', '${namaPel}')">
                        <i class="fas fa-money-bill-wave"></i> Bayar Sekarang
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);

    } catch (error) {
        console.error("Error show pay all:", error);
        showToast('error', 'Gagal', error.message);
    }
}

async function executePayAllDirect(pelangganId, idsString, totalNominal, bulanString, modalId, namaPelanggan) {
    const btn = document.getElementById('btnExecutePayAll');
    const originalText = btn.innerHTML;
    
    if (!confirm(`Konfirmasi Pelunasan Tunggakan:\n${namaPelanggan}\nTotal: ${formatRupiah(totalNominal)}\n\nLanjutkan?`)) {
        return;
    }

    try {
        showLoading();
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Proses...';

        // 1. Update Status di Database
        const tagihanIds = String(idsString).split(',');
        const batch = db.batch();
        const now = new Date().toISOString();
        const tglHariIni = moment().format('DD MMMM YYYY, HH:mm');

        tagihanIds.forEach(id => {
            const ref = db.collection('tagihan').doc(id);
            batch.update(ref, {
                status: 'lunas',
                tanggal_bayar: tglHariIni,
                metode_bayar: document.getElementById('payAllMetode').value,
                catatan_bayar: 'Pelunasan Tunggakan',
                updated_at: now
            });
        });

        await batch.commit();

        // 2. Buat Nota HTML Sementara (Untuk dijadikan Gambar)
        const strukContainer = document.createElement('div');
        strukContainer.style.position = 'absolute';
        strukContainer.style.left = '-9999px';
        strukContainer.style.top = '0';
        strukContainer.style.width = '300px';
        strukContainer.style.background = 'white';
        strukContainer.style.padding = '10px';
        strukContainer.style.fontFamily = 'monospace';
        strukContainer.style.fontSize = '12px';
        strukContainer.style.color = '#000000';
        strukContainer.style.border = '1px solid #000';
        
        strukContainer.innerHTML = `
            <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px;">
                <h3 style="margin: 0; font-size: 18px; font-weight: bold;">X-BILL ISP</h3>
                <p style="margin: 0; font-size: 10px;">Jl. Internet Cepat No. 1</p>
            </div>
            
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Pelanggan:</span>
                    <strong>${namaPelanggan}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Tanggal:</span>
                    <span>${tglHariIni}</span>
                </div>
            </div>

            <div style="border-top: 1px solid #000; border-bottom: 1px solid #000; padding: 10px 0; margin: 10px 0; text-align: center;">
                <strong>BUKTI PELUNASAN</strong>
            </div>

            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Item:</span>
                    <span>Pelunasan Tunggakan</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Bulan:</span>
                    <span>${bulanString}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <span>Total:</span>
                    <strong>${formatRupiah(totalNominal)}</strong>
                </div>
            </div>

            <div style="text-align: center; margin-top: 15px; font-weight: bold;">
                STATUS: LUNAS
            </div>

            <div style="text-align: center; margin-top: 20px; border-top: 1px solid #000; padding-top: 10px; font-size: 10px;">
                Terima Kasih<br>
                Simpan struk ini sebagai bukti pembayaran yang sah.
            </div>
        `;
        
        document.body.appendChild(strukContainer);

        // 3. Generate Gambar (Canvas)
        await new Promise(r => setTimeout(r, 100)); // Tunggu render DOM
        const canvas = await html2canvas(strukContainer, {
            scale: 2,
            useCORS: true,
            backgroundColor: "#ffffff"
        });

        // 4. Hapus elemen HTML
        document.body.removeChild(strukContainer);
        document.getElementById(modalId).remove();

        hideLoading();
        showToast('success', 'Lunas', 'Pembayaran berhasil dicatat.');

        // 5. SHARE KE WA (PAKAI WEB SHARE API)
        canvas.toBlob(async function(blob) {
            if (!blob) return;
            
            const fileShare = new File([blob], `Bukti_Lunas_${pelangganId}.png`, { type: 'image/png' });
            
            if (navigator.share && navigator.canShare({ files: [fileShare] })) {
                try {
                    await navigator.share({
                        title: 'Bukti Pelunasan',
                        text: `Halo Kak ${namaPelanggan}, berikut bukti pelunasan tagihan ${bulanString}.`,
                        files: [fileShare] 
                    });
                } catch (err) {
                    console.log("Share dibatalkan/diabaikan user");
                }
            } else {
                alert("Browser tidak support share otomatis.");
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Bukti_Lunas_${pelangganId}.png`;
                link.click();
            }
        });

        // 6. Refresh Table
        await loadTunggakanData();
        await loadTagihanData(); // Refresh tabel tagihan utama juga

                    await batch.commit();

            // ⭐⭐ TAMBAHKAN KODE INI: REFRESH DATA & TAMPILAN ULANG ⭐⭐
            console.log("🔄 Refreshing Data Tagihan...");
            
            // 1. Bersihkan array global data tagihan (paksa reload biar fresh)
            window.tagihanData = [];
            
            // 2. Load ulang data tagihan (ini akan mengambil data status 'Lunas' yang baru)
            if (typeof loadTagihanData === 'function') {
                await loadTagihanData();
            }
            
            // 3. Jika halaman yang sedang aktif adalah 'tunggakan', refresh juga data tunggakan
            if (currentPage === 'tunggakan') {
                if (typeof loadTunggakanData === 'function') {
                    await loadTunggakanData();
                }
            }

            showToast('success', 'Berhasil', 'Pembayaran berhasil dikonfirmasi & Tabel diperbarui');
            
            // 4. Jika modal bayar terbuka, tutup otomatis
            const modalBayar = document.getElementById('modalBayarTagihan');
            if (modalBayar) {
                modalBayar.classList.remove('show');
                modalBayar.classList.add('hidden');
            }

    } catch (error) {
        hideLoading();
        btn.disabled = false;
        btn.innerHTML = originalText;
        console.error("Error execute pay all:", error);
        showToast('error', 'Gagal', error.message);
    }
}



// ============================================
// FUNGSI LOAD DATA TUNGGAKAN (DENGAN PAGINATION)
// ============================================

let halamanTunggakanSaatIni = 1;
const jumlahDataPerHalamanTunggakan = 10;

async function loadTunggakanData(filterKategori = 'semua') {
    console.log("📊 Loading Tunggakan Data untuk Company:", globalCompanyId);
    
    const table = document.getElementById('tunggakanTable');
    const paginationContainer = document.getElementById('tunggakanPagination');
    
    if (!table) {
        console.warn("Tabel tunggakan tidak ditemukan");
        return;
    }

    try {
        table.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px;"><div class="spinner" style="margin:0 auto;"></div> Memuat Data...</td></tr>`;

        // ⭐⭐ PERBAIKAN 1: TAMBAH FILTER COMPANY_ID ⭐⭐
        const snapshot = await db.collection('tagihan')
            .where('company_id', '==', globalCompanyId)  // ⭐ FILTER COMPANY
            .where('status', 'in', ['belum', 'telat'])
            .get();
        
        if (snapshot.empty) {
            table.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align:center; padding: 40px;">
                        <i class="fas fa-check-circle" style="font-size: 48px; color: #e9ecef;"></i>
                        <h4 style="margin-top:15px; color: var(--gray);">Tidak Ada Tunggakan</h4>
                        <p>Semua tagihan sudah lunas untuk perusahaan Anda.</p>
                    </td>
                </tr>`;
            
            // Reset Stats
            if(document.getElementById('tunggakanRingan')) document.getElementById('tunggakanRingan').textContent = '0';
            if(document.getElementById('tunggakanSedang')) document.getElementById('tunggakanSedang').textContent = '0';
            if(document.getElementById('tunggakanBerat')) document.getElementById('tunggakanBerat').textContent = '0';
            if(document.getElementById('totalTunggakanUang')) document.getElementById('totalTunggakanUang').textContent = 'Rp 0';
            
            paginationContainer.innerHTML = '';
            return;
        }
        
        console.log(`✅ ${snapshot.size} tagihan tunggakan ditemukan untuk company: ${globalCompanyId}`);
        
        // ⭐⭐ PERBAIKAN 2: AMBIL DATA PELANGGAN UNTUK VALIDASI ⭐⭐
        const pelangganSnapshot = await db.collection('pelanggan')
            .where('company_id', '==', globalCompanyId)
            .get();
        
        const validPelangganMap = {};
        pelangganSnapshot.forEach(doc => {
            const p = doc.data();
            if (p.company_id === globalCompanyId) {
                validPelangganMap[doc.id] = {
                    nama: p.nama || 'Tanpa Nama',
                    telepon: p.telepon || '-'
                };
            }
        });
        
        console.log(`👥 ${Object.keys(validPelangganMap).length} pelanggan valid untuk company ini`);
        
        // Group data berdasarkan Pelanggan
        const groupedMap = {};
        let totalNominalSemua = 0;
        let skippedCount = 0;
        
        snapshot.forEach(doc => {
            const t = doc.data();
            const pid = t.pelanggan_id;
            
            // ⭐⭐ PERBAIKAN 3: VALIDASI TAGIHAN MILIK COMPANY INI ⭐⭐
            if (t.company_id !== globalCompanyId) {
                console.warn(`⚠️ Tagihan ${doc.id} bukan milik company ini:`, t.company_id);
                skippedCount++;
                return;
            }
            
            // ⭐⭐ PERBAIKAN 4: VALIDASI PELANGGAN ADA DI DATABASE PELANGGAN ⭐⭐
            if (!validPelangganMap[pid]) {
                console.warn(`⚠️ Tagihan ${doc.id} milik pelanggan ${pid} yang tidak ada di database pelanggan`);
                skippedCount++;
                return;
            }
            
            if (!groupedMap[pid]) {
                groupedMap[pid] = {
                    pelanggan_id: pid,
                    pelanggan_nama: validPelangganMap[pid].nama,
                    pelanggan_telepon: validPelangganMap[pid].telepon,
                    list_tagihan: [],
                    total_nominal: 0,
                    company_id: globalCompanyId  // ⭐ SIMPAN COMPANY_ID
                };
            }
            
            groupedMap[pid].list_tagihan.push({
                ...t,
                tagihan_id: doc.id  // ⭐ SIMPAN ID TAGIHAN
            });
            groupedMap[pid].total_nominal += Number(t.jumlah) || 0;
            totalNominalSemua += Number(t.jumlah) || 0;
        });
        
        console.log(`📊 ${Object.keys(groupedMap).length} grup valid, ${skippedCount} data di-skip`);

        // --- PROSES DATA (HITUNG KATEGORI & STRING) ---
        let processedData = Object.values(groupedMap).map(item => {
            let maxHariTerlambat = 0;
            let statusTerparah = 'belum';
            
            // Helper buat string bulan
            let listBulan = item.list_tagihan.map(t => {
                const rawBulan = t.bulan || '';
                let dateObj = null;
                
                if (rawBulan.includes('-')) {
                    const parts = rawBulan.split('-');
                    if (parts.length === 2 && parts[0].length === 4) dateObj = moment(rawBulan); 
                    else if (parts.length === 2 && parts[0].length <= 2) dateObj = moment(rawBulan, 'MM-YYYY');
                    else if (parts.length === 3) {
                        const fixedString = `${parts[1]}-${parts[2]}-${parts[0]}`;
                        dateObj = moment(fixedString, 'YYYY-MM-DD');
                    }
                } else {
                    dateObj = moment(rawBulan);
                }
                if (dateObj && dateObj.isValid()) return dateObj.format('MMM YY');
                return rawBulan;
            }).join(', ');

            // Helper buat string jatuh tempo & hitung hari terlambat
            let jatuhTempoText = '-';
            let jatuhTempoDate = null;
            
            if (item.list_tagihan.length > 0) {
                const sortedTagihan = [...item.list_tagihan].sort((a, b) => {
                    const getTime = (val) => {
                        if (!val) return 0;
                        let m = moment(val, 'DD-MM-YYYY');
                        if (!m.isValid()) m = moment(val);
                        return m.isValid() ? m.valueOf() : 0;
                    };
                    return getTime(a.tanggal_jatuh_tempo) - getTime(b.tanggal_jatuh_tempo);
                });
                
                if (sortedTagihan[0].tanggal_jatuh_tempo) {
                    let mJatuhTempo = moment(sortedTagihan[0].tanggal_jatuh_tempo, 'DD-MM-YYYY');
                    if (!mJatuhTempo.isValid()) mJatuhTempo = moment(sortedTagihan[0].tanggal_jatuh_tempo);
                    if (mJatuhTempo.isValid()) {
                        jatuhTempoText = mJatuhTempo.format('DD MMM YYYY');
                        jatuhTempoDate = mJatuhTempo;
                    }
                }
            }

            // Hitung hari terlambat
            item.list_tagihan.forEach(t => {
                if (t.status === 'telat' && t.tanggal_jatuh_tempo) {
                    statusTerparah = 'telat';
                    let mJatuhTempo = moment(t.tanggal_jatuh_tempo, 'DD-MM-YYYY');
                    if (!mJatuhTempo.isValid()) mJatuhTempo = moment(t.tanggal_jatuh_tempo);
                    if (mJatuhTempo.isValid()) {
                        const hariTelat = moment().diff(mJatuhTempo, 'days');
                        if (hariTelat > maxHariTerlambat) maxHariTerlambat = hariTelat;
                    }
                }
            });

            // Tentukan kategori
            let kategori = 'ringan';
            if (statusTerparah === 'telat') {
                if (maxHariTerlambat > 60) kategori = 'berat';
                else if (maxHariTerlambat > 30) kategori = 'sedang';
            }

            return { 
                ...item, 
                kategori: kategori, 
                hari_terlambat: maxHariTerlambat,
                string_bulan: listBulan,
                string_jatuh_tempo: jatuhTempoText,
                jatuh_tempo_date: jatuhTempoDate,
                jumlah_tagihan: item.list_tagihan.length
            };
        });

        // --- UPDATE STATS (PAKAI DATA ASLI: processedData) ---
        let ringanCount = 0, sedangCount = 0, beratCount = 0;
        let totalUang = 0;

        processedData.forEach(item => {
             if (item.kategori === 'ringan') ringanCount++;
             if (item.kategori === 'sedang') sedangCount++;
             if (item.kategori === 'berat') beratCount++;
             totalUang += item.total_nominal;
        });

        // Update UI Stats
        if (document.getElementById('tunggakanRingan')) {
            document.getElementById('tunggakanRingan').textContent = ringanCount;
            document.getElementById('tunggakanRingan').style.cursor = 'pointer';
        }
        if (document.getElementById('tunggakanSedang')) {
            document.getElementById('tunggakanSedang').textContent = sedangCount;
            document.getElementById('tunggakanSedang').style.cursor = 'pointer';
        }
        if (document.getElementById('tunggakanBerat')) {
            document.getElementById('tunggakanBerat').textContent = beratCount;
            document.getElementById('tunggakanBerat').style.cursor = 'pointer';
        }
        if (document.getElementById('totalTunggakanUang')) {
            document.getElementById('totalTunggakanUang').textContent = formatRupiah(totalUang);
            document.getElementById('totalTunggakanUang').style.cursor = 'pointer';
        }

        // --- FILTER DATA UNTUK TABEL ---
        let tableData = [...processedData];
        
        if (filterKategori !== 'semua') {
            tableData = tableData.filter(item => item.kategori === filterKategori);
        }

        // --- PAGINATION ---
        const totalData = tableData.length;
        const totalPages = Math.ceil(totalData / jumlahDataPerHalamanTunggakan);
        
        if (halamanTunggakanSaatIni > totalPages) halamanTunggakanSaatIni = 1;
        
        const startIndex = (halamanTunggakanSaatIni - 1) * jumlahDataPerHalamanTunggakan;
        const endIndex = startIndex + jumlahDataPerHalamanTunggakan;
        const pageData = tableData.slice(startIndex, endIndex);

        // --- RENDER TABEL ---
        table.innerHTML = pageData.map((item) => {
            const jumlahBulan = item.jumlah_tagihan;
            
            let badgeColor = '#fdcb6e';
            let badgeText = 'Ringan';
            if (item.kategori === 'sedang') {
                badgeColor = '#e17055';
                badgeText = 'Sedang';
            } else if (item.kategori === 'berat') {
                badgeColor = '#d63031';
                badgeText = 'Berat';
            }

            // ⭐⭐ PERBAIKAN 5: TAMBAH INFO COMPANY ID DI DEBUG ⭐⭐
            const debugInfo = item.company_id !== globalCompanyId 
                ? `<br><small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Company: ${item.company_id}</small>` 
                : '';

            return `
                <tr>
                    <td>
                        <strong>${item.pelanggan_nama}</strong>
                        <br>
                        <small class="text-muted">${item.pelanggan_telepon}</small>
                        ${debugInfo}
                    </td>
                    <td>
                        <small style="color: var(--gray);">${item.string_bulan}</small>
                        <br>
                        <small class="text-muted">${item.jumlah_tagihan} tagihan</small>
                    </td>
                    <td>
                        <strong>${formatRupiah(item.total_nominal)}</strong>
                        <br>
                        <small class="text-muted">${item.hari_terlambat > 0 ? `${item.hari_terlambat} hari telat` : 'Belum telat'}</small>
                    </td>
                    <td>
                        <small>${item.string_jatuh_tempo}</small>
                        ${item.jatuh_tempo_date ? `<br><small class="text-muted">${moment(item.jatuh_tempo_date).fromNow()}</small>` : ''}
                    </td>
                    <td>
                        <span style="background: ${badgeColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold;">
                            ${badgeText} (${item.hari_terlambat} Hari)
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-danger">
                            <i class="fas fa-clock"></i> Menunggak
                        </span>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" onclick="showPayAllModal('${item.pelanggan_id}')" title="Bayar Semua Tunggakan">
                                <i class="fas fa-money-bill-wave"></i> Bayar
                            </button>
                            <button class="btn btn-sm btn-info" onclick="viewTagihanDetails('${item.pelanggan_id}')" title="Rincian Tagihan">
                                <i class="fas fa-list"></i> Detail
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        // --- RENDER PAGINATION ---
        let paginationHTML = '<div class="pagination">';
        if (halamanTunggakanSaatIni > 1) {
            paginationHTML += `<a class="page-link" onclick="gantiHalamanTunggakan(${halamanTunggakanSaatIni - 1}, '${filterKategori}')">&laquo; Prev</a>`;
        }
        
        // Tampilkan halaman
        for (let i = 1; i <= totalPages; i++) {
            if (i === halamanTunggakanSaatIni) {
                paginationHTML += `<span class="page-link active">${i}</span>`;
            } else {
                paginationHTML += `<a class="page-link" onclick="gantiHalamanTunggakan(${i}, '${filterKategori}')">${i}</a>`;
            }
        }
        
        if (halamanTunggakanSaatIni < totalPages) {
            paginationHTML += `<a class="page-link" onclick="gantiHalamanTunggakan(${halamanTunggakanSaatIni + 1}, '${filterKategori}')">Next &raquo;</a>`;
        }
        
        paginationHTML += `</div><div style="text-align:center; margin-top:10px; color:var(--gray); font-size:12px;">
            Menampilkan ${startIndex + 1}-${Math.min(endIndex, totalData)} dari ${totalData} data tunggakan
        </div>`;
        
        paginationContainer.innerHTML = paginationHTML;

        // LOG FINAL
        console.log(`🎉 Load tunggakan selesai: ${totalData} data untuk company ${globalCompanyId}`);

    } catch (error) {
        console.error("❌ Error load tunggakan:", error);
        table.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger" style="padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px;"></i>
                    <h4 style="margin-top:15px;">Error Memuat Data</h4>
                    <p>${error.message}</p>
                    <button class="btn btn-outline mt-2" onclick="loadTunggakanData('${filterKategori}')">
                        <i class="fas fa-redo"></i> Coba Lagi
                    </button>
                </td>
            </tr>`;
    }
}


// ============================================
// FUNGSI GANTI HALAMAN
// ============================================

function gantiHalamanTunggakan(pageNum, kategori) {
    halamanTunggakanSaatIni = pageNum;
    loadTunggakanData(kategori);
}
        
        async function getImportExportHTML() {
            return `
                <div class="page import-export-page">
                    <div class="page-header">
                        <h2 class="page-title"><i class="fas fa-file-import"></i> Import & Export Data</h2>
                    </div>
                    
                    <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-upload"></i> Import Data</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Tipe Data</label>
                                    <select class="form-control" id="importType">
                                        <option value="pelanggan">Data Pelanggan</option>
                                        <option value="paket">Data Paket</option>
                                        <option value="tagihan">Data Tagihan</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Pilih File</label>
                                    <input type="file" class="form-control" id="fileImport" accept=".xlsx,.xls,.csv">
                                    <small class="text-muted">Format: Excel (.xlsx, .xls) atau CSV</small>
                                </div>
                                
                                <div class="form-group">
                                    <label>Aksi</label>
                                    <select class="form-control" id="importAction">
                                        <option value="tambah">Tambah Data Baru</option>
                                        <option value="update">Update Data Existing</option>
                                        <option value="replace">Replace Semua Data</option>
                                    </select>
                                </div>
                                
                                <div class="action-buttons" style="margin-top: 20px;">
                                    <button class="btn btn-primary" onclick="downloadTemplate()">
                                        <i class="fas fa-download"></i> Download Template
                                    </button>
                                    <button class="btn btn-success" onclick="importExcel()">
                                        <i class="fas fa-upload"></i> Import Data
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-download"></i> Export Data</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Tipe Data</label>
                                    <select class="form-control" id="exportType">
                                        <option value="pelanggan">Data Pelanggan</option>
                                        <option value="paket">Data Paket</option>
                                        <option value="tagihan">Data Tagihan</option>
                                        <option value="tunggakan">Data Tunggakan</option>
                                        <option value="all">Semua Data</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Format File</label>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" name="exportFormat" id="exportExcel" value="excel" checked>
                                        <label class="form-check-label" for="exportExcel">Excel (.xlsx)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" name="exportFormat" id="exportCSV" value="csv">
                                        <label class="form-check-label" for="exportCSV">CSV (.csv)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" name="exportFormat" id="exportJSON" value="json">
                                        <label class="form-check-label" for="exportJSON">JSON (.json)</label>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Include</label>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="includeHeader" checked>
                                        <label class="form-check-label" for="includeHeader">Header Kolom</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="includeTimestamp" checked>
                                        <label class="form-check-label" for="includeTimestamp">Timestamp</label>
                                    </div>
                                </div>
                                
                                <div class="action-buttons" style="margin-top: 20px;">
                                    <button class="btn btn-success" onclick="exportData()">
                                        <i class="fas fa-download"></i> Export Data
                                    </button>
                                    <button class="btn btn-info" onclick="backupManual()">
                                        <i class="fas fa-save"></i> Backup Manual
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>Log Import/Export</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Tanggal</th>
                                            <th>Tipe</th>
                                            <th>File</th>
                                            <th>Jumlah Data</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logTable">
                                        <tr>
                                            <td colspan="5" class="text-center">Tidak ada log</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function getLaporanHTML() {
    return `
        <div class="page laporan-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-chart-bar"></i> Laporan & Analytics</h2>
                <div class="action-buttons">
                    <button class="btn btn-outline" onclick="printLaporan()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <!-- TOMBOL GENERATE TETAP ADA DISINI -->
                    <button class="btn btn-primary" onclick="generateLaporan()">
                        <i class="fas fa-sync-alt"></i> Generate Laporan
                    </button>
                </div>
            </div>
            
            <div class="filters-card">
                <div class="filter-row">
                    <div class="form-group">
                        <label>Periode Awal</label>
                        <input type="date" class="form-control" id="laporanStartDate" value="${moment().startOf('month').format('YYYY-MM-DD')}">
                    </div>
                    <div class="form-group">
                        <label>Periode Akhir</label>
                        <input type="date" class="form-control" id="laporanEndDate" value="${moment().endOf('month').format('YYYY-MM-DD')}">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" style="margin-top: 25px;" onclick="generateLaporan()">
                            <i class="fas fa-filter"></i> Tampilkan
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Grafik Pendapatan</h3>
                    <canvas id="laporanChart1" height="150"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Distribusi Pelanggan</h3>
                    <canvas id="laporanChart2" height="150"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3>Detail Laporan</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table" id="laporanTable">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Pelanggan</th>
                                    <th>Periode</th>
                                    <th>Nominal</th>
                                    <th>Status</th>
                                    <th>Metode</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center">Menunggu generate laporan...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}


        // ============================================
// FUNGSI IMPORT/EXPORT DATA PELANGGAN
// ============================================

// TAMPILKAN/SEMBUNYIKAN PANEL IMPORT/EXPORT
function showImportExportPanel() {
    document.getElementById('importExportPanel').classList.remove('hidden');
    showToast('info', 'Import/Export', 'Buka panel import/export data pelanggan');
}

function hideImportExportPanel() {
    document.getElementById('importExportPanel').classList.add('hidden');
}

// DOWNLOAD TEMPLATE EXCEL
function downloadTemplatePelanggan() {
    try {
        // Buat data template
        const templateData = [
            ['nama', 'telepon', 'email', 'alamat', 'paket', 'harga', 'tanggal_pasang', 'status', 'koordinat', 'catatan'],
            ['Budi Santoso', '081234567890', 'budi@email.com', 'Jl. Contoh No. 123', 'Paket 20 Mbps', '250000', '2024-01-15', 'aktif', '-6.2088, 106.8456', 'Pelanggan baru'],
            ['Siti Rahayu', '082345678901', 'siti@email.com', 'Jl. Contoh No. 456', 'Paket 10 Mbps', '150000', '2024-02-01', 'aktif', '-6.2250, 106.8050', ''],
            // ... tambahkan contoh lainnya
        ];
        
        // Buat workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(templateData);
        XLSX.utils.book_append_sheet(wb, ws, 'Template Pelanggan');
        
        // Download
        XLSX.writeFile(wb, 'Template_Pelanggan_XBILL.xlsx');
        
        showToast('success', 'Template', 'Template berhasil didownload');
        
    } catch (error) {
        console.error("Error download template:", error);
        showToast('error', 'Error', 'Gagal download template');
    }
}

// IMPORT DATA DARI EXCEL/CSV
async function importDataPelanggan() {
    const fileInput = document.getElementById('fileImportPelanggan');
    const action = document.getElementById('importActionPelanggan').value;
    
    if (!fileInput.files.length) {
        showToast('error', 'Error', 'Pilih file terlebih dahulu');
        return;
    }
    
    try {
        showLoading();
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                console.log(`📊 Data dari file: ${jsonData.length} baris`);
                
                if (jsonData.length === 0) {
                    throw new Error('File kosong atau format tidak sesuai');
                }
                
                // Validasi kolom minimal
                const requiredFields = ['nama', 'telepon', 'alamat', 'paket'];
                const firstRow = jsonData[0];
                const missingFields = requiredFields.filter(field => !firstRow.hasOwnProperty(field));
                
                if (missingFields.length > 0) {
                    throw new Error(`Kolom wajib tidak ditemukan: ${missingFields.join(', ')}`);
                }
                
                // Proses import berdasarkan aksi
                let successCount = 0;
                let errorCount = 0;
                const errors = [];
                
                // Batch write ke Firebase
                const batch = db.batch();
                const now = new Date().toISOString();
                
                for (let i = 0; i < jsonData.length; i++) {
                    try {
                        const row = jsonData[i];
                        
                        // Validasi data
                        if (!row.nama || !row.telepon) {
                            errors.push(`Baris ${i + 2}: Nama atau telepon kosong`);
                            errorCount++;
                            continue;
                        }
                        
                        // Format data
                        const pelangganData = {
                            nama: row.nama.toString().trim(),
                            telepon: row.telepon.toString().trim(),
                            email: row.email ? row.email.toString().trim() : `${row.telepon}@xbill.com`,
                            alamat: row.alamat ? row.alamat.toString().trim() : '',
                            paket: row.paket ? row.paket.toString().trim() : 'Paket 10 Mbps',
                            harga: parseInt(row.harga) || 150000,
                            tanggal_pasang: row.tanggal_pasang || new Date().toISOString().split('T')[0],
                            status: row.status || 'aktif',
                            koordinat: row.koordinat || '',
                            company_id: globalCompanyId,
                            catatan: row.catatan || '',
                            created_at: now,
                            updated_at: now
                        };
                        
                        // Generate ID
                        const pelangganId = `CUST_${Date.now()}_${i}`;
                        const pelangganRef = db.collection('pelanggan').doc(pelangganId);
                        
                        // Add to batch
                        batch.set(pelangganRef, pelangganData);
                        successCount++;
                        
                    } catch (rowError) {
                        errors.push(`Baris ${i + 2}: ${rowError.message}`);
                        errorCount++;
                    }
                }
                
                // Execute batch
                await batch.commit();
                
                // Log aktivitas
                await db.collection('aktivitas').add({
                    aktivitas: `Import data pelanggan: ${successCount} berhasil, ${errorCount} gagal`,
                    user: getUserLogName(),
                    timestamp: now
                });
                
                // Update log di UI
                updateImportExportLog(`Import: ${successCount} data berhasil, ${errorCount} error`);
                
                hideLoading();
                
                // Tampilkan hasil
                const resultMessage = `
                    📊 Hasil Import:
                    ✅ Berhasil: ${successCount} data
                    ❌ Gagal: ${errorCount} data
                    ${errors.length > 0 ? `\n📝 Error:\n${errors.slice(0, 5).join('\n')}` : ''}
                `;
                
                showToast('success', 'Import Berhasil', resultMessage);
                
                // Refresh data pelanggan
                if (currentPage === 'pelanggan') {
                    await loadPelangganData();
                }
                
                // Reset file input
                fileInput.value = '';
                
            } catch (parseError) {
                hideLoading();
                console.error("Error parsing file:", parseError);
                showToast('error', 'Error Parsing', parseError.message);
            }
        };
        
        reader.onerror = function() {
            hideLoading();
            showToast('error', 'Error', 'Gagal membaca file');
        };
        
        reader.readAsArrayBuffer(file);
        
    } catch (error) {
        hideLoading();
        console.error("Error import:", error);
        showToast('error', 'Error', 'Gagal import data: ' + error.message);
    }
}

// EXPORT DATA PELANGGAN
async function exportDataPelanggan() {
    try {
        showLoading();
        
        // ⭐⭐ CEK APAKAH ELEMEN ADA SEBELUM DIPAKAI ⭐⭐
        const filter = document.getElementById('exportFilterPelanggan');
        const formatInputs = document.querySelectorAll('input[name="exportFormatPelanggan"]:checked');
        const includeID = document.getElementById('includeID');
        const includeKoordinat = document.getElementById('includeKoordinat');
        const includeCatatan = document.getElementById('includeCatatan');
        
        // Default values jika elemen tidak ditemukan
        const filterValue = filter ? filter.value : 'all';
        const formatValue = formatInputs.length > 0 ? formatInputs[0].value : 'excel';
        const includeIDValue = includeID ? includeID.checked : false;
        const includeKoordinatValue = includeKoordinat ? includeKoordinat.checked : false;
        const includeCatatanValue = includeCatatan ? includeCatatan.checked : false;
        
        // ⭐⭐ QUERY DATA DENGAN FILTER COMPANY ⭐⭐
        let query = db.collection('pelanggan')
            .where('company_id', '==', globalCompanyId);
        
        if (filterValue !== 'all') {
            query = query.where('status', '==', filterValue);
        }
        
        const snapshot = await query.get();
        
        if (snapshot.empty) {
            hideLoading();
            showToast('warning', 'Data Kosong', 'Tidak ada data untuk diexport');
            return;
        }
        
        // Format data untuk export
        const data = [];
        
        // Header
        const headers = ['No'];
        if (includeIDValue) headers.push('ID');
        headers.push('Nama', 'Telepon', 'Email', 'Alamat', 'Paket', 'Harga', 'Status', 'Tanggal Pasang');
        if (includeKoordinatValue) headers.push('Koordinat');
        if (includeCatatanValue) headers.push('Catatan');
        headers.push('Created At');
        
        data.push(headers);
        
        // Data rows
        let index = 1;
        snapshot.forEach(doc => {
            const pelanggan = doc.data();
            const row = [index++];
            
            if (includeIDValue) row.push(doc.id);
            row.push(
                pelanggan.nama || '',
                pelanggan.telepon || '',
                pelanggan.email || '',
                pelanggan.alamat || '',
                pelanggan.paket || '',
                pelanggan.harga || 0,
                pelanggan.status || '',
                pelanggan.tanggal_pasang || ''
            );
            
            if (includeKoordinatValue) row.push(pelanggan.koordinat || '');
            if (includeCatatanValue) row.push(pelanggan.catatan || '');
            row.push(pelanggan.created_at ? moment(pelanggan.created_at).format('DD/MM/YYYY HH:mm') : '');
            
            data.push(row);
        });
        
        // Buat file berdasarkan format
        const now = moment().format('YYYYMMDD_HHmmss');
        let fileName = `Data_Pelanggan_${globalCompanyId}_${now}`;
        
        if (formatValue === 'excel') {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Data Pelanggan');
            XLSX.writeFile(wb, `${fileName}.xlsx`);
            
        } else if (formatValue === 'csv') {
            const csvContent = data.map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${fileName}.csv`;
            link.click();
            
        } else if (formatValue === 'json') {
            const jsonData = [];
            snapshot.forEach(doc => {
                jsonData.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${fileName}.json`;
            link.click();
        }
        
        // Log aktivitas
        await db.collection('aktivitas').add({
            aktivitas: `Export data pelanggan: ${snapshot.size} data, format: ${formatValue}`,
            user: getUserLogName(),
            timestamp: new Date().toISOString(),
            company_id: globalCompanyId
        });
        
        hideLoading();
        showToast('success', 'Export Berhasil', `${snapshot.size} data berhasil diexport`);
        
    } catch (error) {
        hideLoading();
        console.error("❌ Error export:", error);
        showToast('error', 'Error', 'Gagal export data: ' + error.message);
    }
}

// QUICK EXPORT (TOMBOl CEPAT)
async function quickExportPelanggan(format = 'excel') {
    try {
        showLoading();
        
        // Ambil semua data pelanggan
        const snapshot = await db.collection('pelanggan')
    .where('company_id', '==', globalCompanyId)  // ⭐ FILTER COMPANY
    .get();
        
        if (snapshot.empty) {
            hideLoading();
            showToast('warning', 'Data Kosong', 'Tidak ada data pelanggan');
            return;
        }
        
        // Format data sederhana
        const data = [
            ['No', 'Nama', 'Telepon', 'Email', 'Alamat', 'Paket', 'Harga', 'Status', 'Tanggal Pasang']
        ];
        
        let index = 1;
        snapshot.forEach(doc => {
            const pelanggan = doc.data();
            data.push([
                index++,
                pelanggan.nama || '',
                pelanggan.telepon || '',
                pelanggan.email || '',
                pelanggan.alamat || '',
                pelanggan.paket || '',
                pelanggan.harga || 0,
                pelanggan.status || '',
                pelanggan.tanggal_pasang || ''
            ]);
        });
        
        // Export berdasarkan format
        const now = moment().format('YYYYMMDD_HHmmss');
        
        if (format === 'excel') {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Pelanggan');
            XLSX.writeFile(wb, `Pelanggan_XBILL_${now}.xlsx`);
            
        } else if (format === 'csv') {
            const csvContent = data.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Pelanggan_XBILL_${now}.csv`;
            link.click();
        }
        
        hideLoading();
        showToast('success', 'Export Berhasil', `${snapshot.size} data diexport`);
        
    } catch (error) {
        hideLoading();
        console.error("Error quick export:", error);
        showToast('error', 'Error', 'Gagal export cepat');
    }
}

// BACKUP LENGKAP
async function exportBackupPelanggan() {
    if (!confirm('Buat backup lengkap semua data pelanggan?\n\nBackup akan mencakup semua data termasuk yang sudah dihapus.')) {
        return;
    }
    
    try {
        showLoading();
        
        // Ambil SEMUA data pelanggan (termasuk yang sudah dihapus/archive jika ada)
        const snapshot = await db.collection('pelanggan')
    .where('company_id', '==', globalCompanyId)  // ⭐ FILTER COMPANY
    .get();
        
        if (snapshot.empty) {
            hideLoading();
            showToast('warning', 'Data Kosong', 'Tidak ada data untuk dibackup');
            return;
        }
        
        // Format data backup lengkap
        const backupData = {
            metadata: {
                system: 'X-BILL ISP',
                type: 'pelanggan_backup',
                exported_at: new Date().toISOString(),
                total_records: snapshot.size,
                version: '1.0'
            },
            data: []
        };
        
        // Tambah semua data
        snapshot.forEach(doc => {
            backupData.data.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        // Buat file JSON
        const now = moment().format('YYYYMMDD_HHmmss');
        const fileName = `Backup_Pelanggan_XBILL_${now}.json`;
        const jsonStr = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        
        // Download
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
        
        // Log aktivitas
        await db.collection('aktivitas').add({
            aktivitas: `Backup lengkap data pelanggan: ${snapshot.size} records`,
            user: getUserLogName(),
            timestamp: new Date().toISOString()
        });
        
        hideLoading();
        showToast('success', 'Backup Berhasil', `Backup ${snapshot.size} data berhasil dibuat`);
        
    } catch (error) {
        hideLoading();
        console.error("Error backup:", error);
        showToast('error', 'Error', 'Gagal membuat backup');
    }
}

// UPDATE LOG IMPORT/EXPORT
function updateImportExportLog(message) {
    const logContainer = document.getElementById('importExportLogPelanggan');
    if (!logContainer) return;
    
    const timestamp = moment().format('HH:mm:ss');
    const logEntry = document.createElement('div');
    logEntry.style.padding = '5px';
    logEntry.style.borderBottom = '1px solid #f1f1f1';
    logEntry.innerHTML = `<strong>${timestamp}:</strong> ${message}`;
    
    logContainer.prepend(logEntry);
    
    // Batasi hanya 10 log terakhir
    const logs = logContainer.children;
    if (logs.length > 10) {
        for (let i = 10; i < logs.length; i++) {
            logContainer.removeChild(logs[i]);
        }
    }
}
        
        

        // ============================================
// FIX QUICK ACTIONS EVENT HANDLERS
// ============================================

function initializeQuickActions() {
    // Generate Tagihan
    document.getElementById('btnGenerateTagihan')?.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = document.getElementById('modalGenerateTagihan');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            showToast('info', 'Generate Tagihan', 'Membuka form generate tagihan');
        } else {
            showToast('error', 'Error', 'Modal generate tagihan tidak ditemukan');
        }
    });
    
    // Kirim Reminder
    document.getElementById('btnKirimReminder')?.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = document.getElementById('modalReminder');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            showToast('info', 'Kirim Reminder', 'Membuka form kirim reminder');
        } else {
            showToast('error', 'Error', 'Modal reminder tidak ditemukan');
        }
    });
    
    // Export Laporan
    document.getElementById('btnExportLaporan')?.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = document.getElementById('modalExportLaporan');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            showToast('info', 'Export Laporan', 'Membuka form export laporan');
        } else {
            showToast('error', 'Error', 'Modal export laporan tidak ditemukan');
        }
    });
    
    // Backup Data
    document.getElementById('btnBackupData')?.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = document.getElementById('modalBackup');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            showToast('info', 'Backup Data', 'Membuka form backup data');
        } else {
            showToast('error', 'Error', 'Modal backup tidak ditemukan');
        }
    });
}

// Panggil fungsi ini dalam renderDashboard() setelah rendering selesai

// ============================================
// RENDER DASHBOARD (FULL FIXED FUNCTION)
// ============================================

async function renderDashboard() {
    console.log("🔄 MEMULAI RENDER DASHBOARD dengan data TERISOLASI");
    
    // 1. TAMPILKAN LOADING
    const loadingEl = document.getElementById('loadingOverlay');
    if (loadingEl) loadingEl.classList.remove('hidden');
    
    try {
        // 2. PASTIKAN GLOBAL COMPANY ID
        if (!globalCompanyId) {
            console.warn("⚠️ globalCompanyId kosong, mencoba fallback...");
            if (!globalCompanyId) globalCompanyId = localStorage.getItem('xbill_company_id') || 'COMP_DEFAULT';
        }
        
        // 3. AMBIL DATA DARI FIREBASE
        console.log("📥 Mengambil data TERISOLASI untuk Company:", globalCompanyId);
        
        const [pelangganSnapshot, tagihanSnapshot] = await Promise.all([
            db.collection('pelanggan').where('company_id', '==', globalCompanyId).get(),
            db.collection('tagihan').where('company_id', '==', globalCompanyId).get()
        ]);
        
        console.log(`✅ Data loaded: ${pelangganSnapshot.size} pelanggan, ${tagihanSnapshot.size} tagihan`);
        
        // 4. SIMPAN ID PELANGGAN YANG VALID KE ARRAY
        let pelangganIds = [];
        const pelangganMap = {};
        
        pelangganSnapshot.forEach(doc => {
            const p = doc.data();
            if (p.company_id === globalCompanyId) {
                pelangganIds.push(doc.id);
                pelangganMap[doc.id] = {
                    nama: p.nama || 'Tanpa Nama',
                    telepon: p.telepon || '-',
                    alamat: p.alamat || '-'
                };
            }
        });

        console.log(`👥 ${pelangganIds.length} pelanggan valid untuk company ini`);

        // 5. UPDATE UI - TOTAL PELANGGAN
         const statPelangganEl = document.getElementById('statPelanggan');
        if (statPelangganEl) {
            statPelangganEl.textContent = pelangganSnapshot.size;
        } else {
            console.warn("⚠️ Elemen #statPelanggan tidak ditemukan!");
        }
        
        // 6. HITUNG TAGIHAN BULAN INI (DAN TUNGGAKAN) ✨ PERBAIKAN DISINI
        const bulanSekarangText = moment().format('MM-YYYY');
        const tahunSekarang = moment().format('YYYY');
        const bulanAngkaSekarang = moment().format('MM');
        
        let totalTagihanBulanIni = 0; 
        let lunasCount = 0;
        let tunggakanCount = 0;
        let belumBayarCount = 0;
        
        // ✨ TAMBAHKAN VARIABEL INI YANG HILANG
        let totalNominalTunggakan = 0; 

        const todayMoment = moment();

        // Looping Semua Tagihan
        tagihanSnapshot.forEach(doc => {
            const t = doc.data();
            const pelangganIdTagihan = t.pelanggan_id;
            const bulanTagihan = t.bulan || "";
            const statusTagihan = t.status || "";
            const jumlah = Number(t.jumlah) || 0;
            
            // Cek ID Pelanggan
            if (!pelangganIds.includes(pelangganIdTagihan)) return;
            
            // LOGIKA PERBAIKAN: CEK BULAN LEBIH KETAT
            let isBulanIni = false;
            
            // Cek Sama Persis
            if (bulanTagihan === bulanSekarangText) {
                isBulanIni = true;
            } else {
                // Cek Format Terbalik (MM-YYYY vs YYYY-MM)
                const parts = bulanTagihan.split('-');
                if (parts.length === 2) {
                    const dbMonth = parts[0];
                    const dbYear = parts[1];
                    if (dbMonth === bulanAngkaSekarang && dbYear === tahunSekarang) {
                        isBulanIni = true;
                    }
                }
            }

            // ✨ HITUNG TUNGGAKAN KHUSUS: JUMLAHKAN SEMUA YANG BELUM LUNAS
            if (statusTagihan === 'belum' || statusTagihan === 'telat') {
                totalNominalTunggakan += jumlah;
            }

            // HANYA PROSES STATISTIK BULAN INI
            if (isBulanIni) {
                totalTagihanBulanIni += jumlah;
                
                // HITUNG STATUS
                if (statusTagihan === 'lunas') {
                    lunasCount++;
                } else if (statusTagihan === 'telat') {
                    tunggakanCount++;
                } else {
                    belumBayarCount++;
                }
            }
        });

        console.log(`💰 Total Bulan Ini: ${totalTagihanBulanIni}, Lunas: ${lunasCount}, Tunggak: ${tunggakanCount}`);
        
        // 7. UPDATE UI - TAGIHAN BULAN INI
        const statTagihanEl = document.getElementById('statTagihanBulanan');
        if (statTagihanEl) {
            // Tentukan bulan sekarang dalam format database (MM-YYYY)
            const currentMonthText = moment().format('MM-YYYY');
            
            // Hitung total tagihan bulan ini yang BELUM LUNAS
            const totalTagihanBulanIniBelum = tagihanSnapshot.docs.reduce((total, doc) => {
                const t = doc.data();
                const bulanTagihan = t.bulan || "";
                const statusTagihan = t.status || "";
                const jumlah = Number(t.jumlah) || 0;
                
                // Cek: Apakah bulan tagihan sama dengan bulan sekarang DAN status belum bayar?
                if (bulanTagihan === currentMonthText && statusTagihan === 'belum') {
                    return total + jumlah;
                } else {
                    return total;
                }
            }, 0);

            // Tampilkan di UI
            statTagihanEl.textContent = totalTagihanBulanIniBelum > 0 ? formatRupiah(totalTagihanBulanIniBelum) : 'Rp 0';
        }

        // 8. UPDATE UI - LUNAS (FIX: STATUS & COUNT)
        const totalP = pelangganSnapshot.size || 1;
        const persen = Math.round((lunasCount / totalP) * 100);
        const textPersen = `${persen}%`;
        const textCount = `${lunasCount} dari ${totalP}`;

        // 1. Update Persen (Cari elemen yang mengandung teks atau title 'Lunas')
        const elsLunas = document.querySelectorAll('[class*="stat-lunas"], [id*="statLunas"]');
        elsLunas.forEach(el => el.textContent = textPersen);

        // 2. Update Jumlah (Cari elemen yang mengandung 'Count' atau di sebelah elemen Lunas)
        const elsCount = document.querySelectorAll('.stat-lunas-count, [id*="statLunasCount"], [id*="statCount"]');
        elsCount.forEach(el => el.textContent = textCount);

        // 3. Update Total (Cari elemen yang mengandung 'Total' atau 'Pelanggan' deket card lunas)
        const elsTotal = document.querySelectorAll('.stat-total-pelanggan, [id*="statTotalPelanggan"], [id*="statTotal"]');
        elsTotal.forEach(el => el.textContent = totalP.toString());
        // -----------------------------------------------------------

        // 9. UPDATE UI - TUNGGAKAN (SUDAH DIPERBAIKI OLEH VARIABEL DI ATAS)
        const statTunggakanEl = document.getElementById('statTunggakan');
        if (statTunggakanEl) {
            // Variabel totalNominalTunggakan sekarang sudah terisi dengan benar
            statTunggakanEl.textContent = formatRupiah(totalNominalTunggakan);
        }

            // 10. HITUNG STATUS PELANGGAN
            let aktifCount = 0;
            let nonaktifCount = 0;
            let tunggakPelangganCount = 0;

            pelangganSnapshot.forEach(doc => {
                const status = doc.data().status || 'nonaktif';
                if (status === 'aktif') aktifCount++;
                else if (status === 'nonaktif') nonaktifCount++;
                else if (status === 'tunggak') tunggakPelangganCount++;
            });
            
            // RENDER CHART DENGAN DATA REAL
            console.log("📈 Rendering chart...");
            renderDashboardCharts(aktifCount, nonaktifCount, tunggakPelangganCount);

            // 11. LOAD AKTIVITAS
            console.log("📋 Loading aktivitas...");
            await loadAktivitas();

        } catch (error) {
            console.error("❌ ERROR FATAL dalam renderDashboard:", error);
            
            // Set nilai default jika error
            if (document.getElementById('statPelanggan')) document.getElementById('statPelanggan').textContent = '0';
            if (document.getElementById('statTagihanBulanan')) document.getElementById('statTagihanBulanan').textContent = 'Rp 0';
            if (document.getElementById('statLunas')) document.getElementById('statLunas').textContent = '0';
            if (document.getElementById('statTunggakan')) document.getElementById('statTunggakan').textContent = 'Rp 0';

            showToast('error', 'Error Dashboard', 'Gagal memuat data dashboard.');
        } finally {
            // PASTIKAN LOADING DIHILANGKAN
            const loadingEl = document.getElementById('loadingOverlay');
            if (loadingEl) loadingEl.classList.add('hidden');
        }
    }

// FUNGSI REFRESH STATS ONLY
async function refreshDashboardStats() {
    try {
        console.log("🔄 Refreshing dashboard stats...");
        
        // CEK APAKAH ELEMENT DASHBOARD MASIH ADA
        const isDashboardPage = document.querySelector('.dashboard-page') !== null;
        if (!isDashboardPage) {
            console.log("⚠️ Bukan halaman dashboard, skip refresh");
            return;
        }
        
        // WAIT UNTIL ELEMENTS ARE READY
        await waitForElement('#statPelanggan');
        
        const [pelangganSnapshot, tagihanSnapshot] = await Promise.all([
    db.collection('pelanggan').where('company_id', '==', globalCompanyId).get(), // <--- DITAMBAH FILTER INI
    db.collection('tagihan').where('company_id', '==', globalCompanyId).get()  // <--- DAN INI JUGA
]);
        
        // Update Total Pelanggan
        const totalPelanggan = pelangganSnapshot.size;
        updateElementText('#statPelanggan', totalPelanggan);
        
        // Update Tagihan Bulan Ini
        const currentMonthText = moment().format('MM-YYYY'); // Contoh: "01-2025"

let lunasCount = 0;
let tunggakanCount = 0;
let belumBayarCount = 0;

tagihanSnapshot.forEach(doc => {
    const t = doc.data();
    const bulanTagihan = t.bulan || "";
    const jumlah = Number(t.jumlah) || 0;
    
    // PERBAIKAN LOGIKA PENGECEKAN BULAN
    let isBulanIni = false;
    if (bulanTagihan === currentMonthText) {
        isBulanIni = true;
    } else {
        // Cek format terbalik (misal: 2025-01 vs 01-2025)
        const parts = bulanTagihan.split('-');
        if (parts.length === 2) {
            const dbMonth = parts[0];
            const dbYear = parts[1];
            const currentMonthParts = currentMonthText.split('-');
            if (dbMonth === currentMonthParts[0] && dbYear === currentMonthParts[1]) {
                isBulanIni = true;
            }
        }
    }

    // HANYA PROSES JIKA BULAN INI
    if (isBulanIni) {
        if (t.status === 'lunas') {
            lunasCount++;
        } else if (t.status === 'telat') {
            tunggakanCount++;
        } else {
            belumBayarCount++;
        }
    }
});
        
        updateElementText('#statTagihanBulanan', formatRupiah(totalTagihanBulanIni));
        updateElementText('#statLunas', lunasCount);
        updateElementText('#statTunggakan', tunggakanCount);
        
        console.log("✅ Dashboard stats refreshed");
        
    } catch (error) {
        console.error("❌ Error refreshing dashboard stats:", error);
    }
}

// HELPER FUNCTION: Wait for element
function waitForElement(selector, timeout = 5000) {
    return new Promise((resolve, reject) => {
        const startTime = Date.now();
        
        function check() {
            const element = document.querySelector(selector);
            if (element) {
                resolve(element);
            } else if (Date.now() - startTime >= timeout) {
                reject(new Error(`Element ${selector} not found after ${timeout}ms`));
            } else {
                setTimeout(check, 100);
            }
        }
        
        check();
    });
}

// HELPER FUNCTION: Safe update element text
function updateElementText(selector, value) {
    const element = document.querySelector(selector);
    if (element) {
        element.textContent = value;
    } else {
        console.warn(`⚠️ Element ${selector} not found for update`);
    }
}

// ============================================
// RENDER DASHBOARD CHARTS (REAL DATA VERSION - FIXED)
// ============================================

async function renderDashboardCharts(aktifCount, nonaktifCount, tunggakCount) {
    console.log("📊 Rendering charts...");

    // 1. CHART TAGIHAN
    const ctx1 = document.getElementById('chartTagihan');
    if (ctx1) {
        try {
            // Hancurkan chart lama jika ada
            if (window.tagihanChartInstance) {
                window.tagihanChartInstance.destroy();
                window.tagihanChartInstance = null;
            }

            // AMBIL DATA REAL DARI DATABASE
            const snapshot = await db.collection('tagihan')
                .where('company_id', '==', globalCompanyId)
                .get();
            
            // Siapkan data 6 bulan terakhir
            const last6Months = [];
            const labels = [];
            
            for (let i = 5; i >= 0; i--) {
                const month = moment().subtract(i, 'months');
                last6Months.push(month.format('YYYY-MM')); // Format: 2025-01
                labels.push(month.format('MMM YY')); // Label: Jan 25
            }
            
            console.log("Bulan yang ditampilkan:", labels);
            
            // Hitung total per bulan
            const monthlyData = Array(6).fill(0);
            
            snapshot.forEach(doc => {
                const t = doc.data();
                const bulanTagihan = t.bulan; // Format: "01-2025" atau "2025-01"
                
                if (!bulanTagihan) return;
                
                // Cari index bulan ini di array
                let index = -1;
                
                // Coba format "MM-YYYY"
                const parts1 = bulanTagihan.split('-');
                if (parts1.length === 2 && parts1[0].length === 2) {
                    const formatted = `${parts1[1]}-${parts1[0]}`; // jadi "2025-01"
                    index = last6Months.indexOf(formatted);
                }
                
                // Coba format "YYYY-MM"
                if (index === -1) {
                    index = last6Months.indexOf(bulanTagihan);
                }
                
                // Jika ditemukan, tambahkan ke data
                if (index !== -1) {
                    monthlyData[index] += Number(t.jumlah) || 0;
                }
            });
            
            console.log("Data bulanan:", monthlyData);
            
            // Buat chart
            window.tagihanChartInstance = new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Tagihan (Rp)',
                    data: monthlyData,
                    borderColor: '#4361ee',
                    backgroundColor: 'rgba(67, 97, 238, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                animation: {
                    duration: 2000,
                    easing: 'easeOutQuart'
                },
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return formatRupiah(context.raw);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatRupiah(value);
                            }
                        },
                        title: { display: true, text: 'Jumlah Tagihan' }
                    },
                    x: { title: { display: true, text: 'Bulan' } }
                    }
                }
            });

        } catch (error) {
            console.error("❌ Error Chart Tagihan:", error);
            // Fallback data dummy jika error
            if (ctx1) {
                window.tagihanChartInstance = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'],
                        datasets: [{
                            label: 'Tagihan (Rp)',
                            data: [500000, 750000, 600000, 900000, 800000, 950000],
                            borderColor: '#4361ee'
                        }]
                    }
                });
            }
        }
    }
    
    // 2. CHART STATUS PELANGGAN
    const ctx2 = document.getElementById('chartStatus');
    if (ctx2) {
        try {
            if (window.statusChartInstance) {
                window.statusChartInstance.destroy();
                window.statusChartInstance = null;
            }
            
            window.statusChartInstance = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Aktif', 'Tunggak', 'Nonaktif'],
                datasets: [{
                    data: [aktifCount, tunggakCount, nonaktifCount],
                    backgroundColor: ['#00b894', '#ff6b6b', '#fdcb6e'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                animation: {
                    animateScale: true,
                    animateRotate: true,
                    duration: 1500
                },
                plugins: {
                    legend: { position: 'bottom' }
                    }
                }
            });
            
        } catch (error) {
            console.error("❌ Error Chart Status:", error);
        }
    }
}

// FUNGSI BARU: Ambil data tagihan 6 bulan terakhir REAL dari Firebase
async function loadRealTagihanData() {
    console.log("📈 Mengambil data tagihan 6 bulan terakhir REAL...");
    
    // ⭐ DEFINISI VARIABEL last6Months DI SINI ⭐
    const last6Months = [];
    const displayLabels = [];
    
    try {
        // 1. Siapkan array 6 bulan terakhir
        for (let i = 5; i >= 0; i--) {
            const m = moment().subtract(i, 'months');
            last6Months.push(m.format('YYYY-MM')); // "2024-12", "2025-01"
            displayLabels.push(m.format('MMM YYYY'));  // "Des 2024", "Jan 2025"
        }
        
        console.log("Target Bulan:", last6Months);

        // 2. Ambil data tagihan (Pastikan pakai filter company)
        const snapshot = await db.collection('tagihan')
            .where('company_id', '==', globalCompanyId)
            .get();
        
        if (snapshot.empty) {
            console.log("📭 Tidak ada data tagihan untuk company ini");
            return [];
        }
        
        // 3. Hitung total per bulan
        const dataChart = last6Months.map(() => 0); // Reset data chart jadi 0 dulu

        snapshot.forEach(doc => {
            const t = doc.data();
            const dbMonth = t.bulan; // Format DB: misal "12-2024" atau "2024-12"
            
            if (!dbMonth) return;

            // Logika Pencocokan Format Bulan
            let idx = -1;

            // Coba 1: Format Standar (YYYY-MM)
            if (last6Months.includes(dbMonth)) {
                idx = last6Months.indexOf(dbMonth);
            } 
            // Coba 2: Format Terbalik (MM-YYYY) -> Ganti jadi (YYYY-MM)
            else if (dbMonth.includes('-')) {
                const parts = dbMonth.split('-');
                if (parts.length === 2) {
                    const flipped = `${parts[1]}-${parts[0]}`; // "2024-12"
                    if (last6Months.includes(flipped)) {
                        idx = last6Months.indexOf(flipped);
                    }
                }
            }

            // Jika ketemu, tambahkan datanya
            if (idx !== -1) {
                dataChart[idx] += Number(t.jumlah) || 0;
            }
        });

        console.log("Data Chart Final:", dataChart);
        return dataChart;
        
    } catch (error) {
        console.error("❌ Error load real tagihan data:", error);
        // Fallback ke dummy data jika error
        return [
            { bulan: 'Jan 24', total: 5000000 },
            { bulan: 'Feb 24', total: 7500000 },
            { bulan: 'Mar 24', total: 6500000 },
            { bulan: 'Apr 24', total: 8000000 },
            { bulan: 'Mei 24', total: 9000000 },
            { bulan: 'Jun 24', total: 8500000 }
        ];
    }
}

// ============================================
// FUNGSI PAGINATION
// ============================================

function getPaginatedData(data, currentPage) {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    return data.slice(startIndex, endIndex);
}



function changePage(pageType, pageNumber) {
    switch(pageType) {
        case 'pelanggan':
            currentPagePelanggan = pageNumber;
            loadPelangganData();
            break;
        case 'tagihan':
            currentPageTagihan = pageNumber;
            loadTagihanData();
            break;
        case 'tunggakan':
            currentPageTunggakan = pageNumber;
            loadTunggakanData();
            break;
        case 'paket':
            currentPagePaket = pageNumber;
            loadPaketData();
            break;
    }
}



// TAMBAHKAN fungsi untuk refresh chart saja
function refreshTagihanChart() {
    console.log("🔄 Refreshing tagihan chart...");
    
    // Hapus chart lama
    if (window.tagihanChart) {
        window.tagihanChart.destroy();
        window.tagihanChart = null;
    }
    
    // Load data baru dan render
    loadRealTagihanData().then(tagihanData => {
        const ctx1 = document.getElementById('chartTagihan');
        if (ctx1) {
            const labels = tagihanData.map(t => t.bulan);
            const data = tagihanData.map(t => t.total);
            
            window.tagihanChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tagihan (Rp)',
                        data: data,
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatRupiah(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            }
                        }
                    }
                }
            });
            
            console.log("✅ Chart tagihan berhasil direfresh dengan data REAL");
        }
    });
}

// MODIFIKASI fungsi refreshDashboard() untuk include chart refresh
function refreshDashboard() {
    console.log("🔄 Manual refresh dashboard dengan data REAL");
    
    // Tampilkan loading
    const loadingEl = document.getElementById('loadingOverlay');
    if (loadingEl) loadingEl.classList.remove('hidden');
    
    // Refresh semua data
    renderDashboard().then(() => {
        // Refresh chart khusus
        setTimeout(() => {
            refreshTagihanChart();
        }, 1000);
    });
    
    showToast('info', 'Memperbarui', 'Dashboard sedang diperbarui dengan data terbaru...');
}

// FUNGSI REFRESH DASHBOARD (untuk tombol refresh)
function refreshDashboard() {
    console.log("🔄 Manual refresh dashboard");
    renderDashboard();
    showToast('info', 'Memperbarui', 'Dashboard sedang diperbarui...');
}

        // ============================================
// FUNGSI TAMBAHAN (FIX TOMBOL & LOKASI)
// ============================================

// 1. Fungsi Get Location (Akurat)
function getLocation() {
    const coordInput = document.getElementById('pelangganKoordinat');
    
    if (!navigator.geolocation) {
        showToast('error', 'Error', 'GPS tidak didukung.');
        return;
    }

    // Jangan banyak notifikasi saat cari lokasi

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            coordInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            showToast('success', 'Sukses', 'Lokasi ditemukan.');
        },
        (error) => {
            // Jangan banyak toast error
            console.error("GPS Error:", error);
            showToast('error', 'Gagal', 'Gagal ambil lokasi (Cek GPS/WiFi).');
        },
        {
            enableHighAccuracy: true,
            timeout: 5000, // Cuma 5 DETIK
            maximumAge: 0
        }
    );
}

// ============================================
// EVENT LISTENER GLOBAL (FIX TOMBOL TUTUP)
// ============================================

document.addEventListener('click', function(e) {
    // 1. TANGKAP TOMBOL CLOSE (X) - SAAT INI BERLAKU UNTUK SEMUA MODAL
    if (e.target.classList.contains('modal-close') || e.target.closest('.modal-close')) {
        e.preventDefault();
        e.stopPropagation();
        
        const modal = e.target.closest('.modal-overlay');
        if (modal) {
            hideModal(modal); // Panggil fungsi universal
        }
        return;
    }

    // 2. TANGKAP KLIK DI LUAR MODAL (BACKGROUND GELAP) - SAAT INI BERLAKU UNTUK SEMUA MODAL
    if (e.target.classList.contains('modal-overlay') && e.target.classList.contains('show')) {
        hideModal(e.target); // Panggil fungsi universal
    }
});

// ============================================
// FUNGSI KLIK PADA CARD STATISTIK (FILTER TABLE)
// ============================================

// 1. TANGKAP EVENT LISTENER UNTUK KARTU
document.addEventListener('click', function(e) {
    // Cek apakah yang diklik adalah elemen di dalam Kartu Statistik
    const card = e.target.closest('.stat-card');
    
    // Kalau bukan kartu, stop.
    if (!card) return;
    
    // Cek text label kartu untuk tahu kategori apa
    const labelElement = card.querySelector('.stat-label');
    if (!labelElement) return;
    
    const label = labelElement.textContent.toLowerCase();
    let filterKategori = '';
    
    // Tentukan kategori berdasarkan tulisan di kartu
    if (label.includes('ringan')) {
        filterKategori = 'ringan';
    } else if (label.includes('sedang')) {
        filterKategori = 'sedang';
    } else if (label.includes('berat')) {
        filterKategori = 'berat';
    } else if (label.includes('total nominal')) {
        // Kalau klik total nominal, tampilkan semua (Reset Filter)
        filterKategori = 'semua';
    } else {
        return; // Kalau kartu lain (misal dashboard), abaikan
    }
    
    console.log(`🔍 Memfilter tabel: ${filterKategori}`);
    
    // Panggil fungsi filter tabel
    filterTunggakanTable(filterKategori);
});


// TANGKAP TOMBOL ESC (Keyboard)
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        // Cari semua modal yang terbuka dan HAPUS SEMUA
        const allModals = document.querySelectorAll('.modal-overlay');
        allModals.forEach(modal => modal.remove());
    }
});

// TAMBAHKAN EVENT LISTENER untuk ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        // Tutup semua modal yang sedang terbuka
        const allModals = document.querySelectorAll('.modal-overlay.show');
        allModals.forEach(modal => {
            hideModal(modal);
        });
    }
});

// TAMBAHKAN EVENT LISTENER untuk klik di luar modal
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-overlay') && e.target.classList.contains('show')) {
        console.log("🌌 Click outside modal, closing:", e.target.id);
        hideModal(e.target.id);
    }
});

// ============================================
// FUNGSI TUTUP MODAL (SMART VERSION)
// ============================================

function forceCloseModal(modalId) {
    // 1. Cari elemen modal berdasarkan ID
    const modalEl = document.getElementById(modalId);
    
    // 2. Jika tidak ditemukan, berhenti saja (JANGAN ERROR)
    if (!modalEl) {
        console.warn(`⚠️ Modal dengan ID '${modalId}' tidak ditemukan.`);
        return; 
    }
    
    // 3. TUTUP MODAL DENGAN AMAN (HANYA HIDE, BUKAN REMOVE)
    try {
        // Sembunyikan dengan class CSS
        modalEl.classList.remove('show');
        modalEl.classList.add('hidden');
        
        // Reset style display (opsional, untuk memastikan tidak tampil)
        modalEl.style.display = 'none';
        
        console.log(`🔒 Modal '${modalId}' ditutup (disembunyikan).`);
        
    } catch (error) {
        console.error("❌ Gagal menutup modal:", error);
    } finally {
        // 4. Kembalikan scroll halaman agar bisa discroll lagi
        document.body.style.overflow = 'auto';
    }
}

// ==========================================
// FUNGSI TUTUP MODAL DENGAN TOMBOL CLOSE (X)
// ==========================================
// (Opsional) Jika tombol close di dalam modal menggunakan onclick="..."
function closeModalButton(modalId) {
    forceCloseModal(modalId);
}

// Fungsi untuk show modal yang bener
function showModal(modalId) {
    // ⭐ PERBAIKAN 1: Ambil elemen modal
    const modal = document.getElementById(modalId);
    if (!modal) {
        console.error("❌ Modal tidak ditemukan:", modalId);
        return;
    }
    
    // ⭐ PERBAIKAN 2: Kunci scroll body (PENTING!)
    document.body.style.overflow = 'hidden';
    
    // ⭐ PERBAIKAN 3: Tampilkan modal
    // Kita HAPUS class 'hidden' dan TAMBAHKAN class 'show'
    modal.classList.remove('hidden');
    modal.classList.add('show');
    
    // ⭐ PERBAIKAN 4 (KRUCIAL): Paksa display jadi 'flex'
    // Karena CSS asli Anda pakai .hidden { display: none }
    // Maka kita wajib set display: flex secara inline saat .show aktif
    modal.style.display = 'flex';
}


        
        async function loadAktivitas() {
    try {
        console.log("📋 Loading aktivitas (Limit 10 Halaman)...");

        const table = await waitForElement('#aktivitasTable');
        if (!table) return;

        // 1. AMBIL DATA DARI FIREBASE
        // Kita ambil dulu SEMUA data yang ada, lalu kita urutkan dan potong di script ini.
        const snapshot = await db.collection('aktivitas')
            .orderBy('timestamp', 'desc') // Urutkan terbaru dulu
            .get();

        if (snapshot.empty) {
            table.innerHTML = `<tr><td colspan="3" class="text-center">Tidak ada aktivitas</td></tr>`;
            const paginationContainer = document.getElementById('aktivitasPagination');
            if (paginationContainer) paginationContainer.innerHTML = '';
            return;
        }

        // 2. SIMPAN KE ARRAY SEMENTARA & URUTKAN
        let allData = [];
        snapshot.forEach(doc => {
            const act = doc.data();
            allData.push(act);
        });

        // 3. POTONG DATA MAKSIMAL 100 BARIS (LOGIKA SLIDING WINDOW)
        // Kita hanya simpan 100 data terakhir. Sisanya dibuang.
        const maxDataLimit = 100; 
        if (allData.length > maxDataLimit) {
            console.warn(`⚠️ Data melebihi limit (${allData.length}), memotong menjadi ${maxDataLimit} data terbaru.`);
            allData = allData.slice(0, maxDataLimit); // Ambil 100 pertama (yang terbaru)
        }

        // 4. SIMPAN KE VARIABLE GLOBAL AGAR TIDAK PERLU QUERY ULANG SAAT GANTI HALAMAN
        window.allAktivitasData = allData;
        window.totalAktivitasDataCount = allData.length; // Simpan jumlah asli untuk perhitungan pagination
        window.currentHalamanAktivitas = window.currentHalamanAktivitas || 1;

        // 5. LAKUKAN PAGINATION
        // Jika halaman saat ini melebihi halaman maksimal baru (misal user sedang di hal 12, tapi data dipotong jadi max hal 10), kembalikan ke hal 1.
        const totalPages = Math.ceil(window.totalAktivitasDataCount / itemsPerPage);
        if (window.currentHalamanAktivitas > totalPages) {
            window.currentHalamanAktivitas = 1;
        }

        // 6. POTONG DATA UNTUK HALAMAN YANG DITAMPILKAN
        const startIndex = (window.currentHalamanAktivitas - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = window.allAktivitasData.slice(startIndex, endIndex);

        // 7. RENDER TABEL
        let html = '';
        pageData.forEach(act => {
            // Format waktu
            let timeDisplay = '';
            if (act.timestamp) {
                const m = moment(act.timestamp);
                timeDisplay = m.isValid() ? m.format('DD/MM HH:mm') : act.timestamp;
            }

            html += `
                <tr>
                    <td>${timeDisplay}</td>
                    <td>${act.aktivitas}</td>
                    <td>${act.user || 'System'}</td>
                </tr>
            `;
        });
        
        table.innerHTML = html;

        // 8. RENDER PAGINATION
        renderPagination(window.totalAktivitasDataCount, window.currentHalamanAktivitas, 'aktivitas', 'aktivitasPagination');
        
        console.log(`✅ Aktivitas dimuat: ${window.totalAktivitasDataCount} total data, menampilkan hal ${window.currentHalamanAktivitas}`);
        
    } catch (error) {
        console.error("❌ Error load aktivitas:", error);
        const table = document.getElementById('aktivitasTable');
        if (table) {
            table.innerHTML = `<tr><td colspan="3" class="text-center text-danger">Error: ${error.message}</td></tr>`;
        }
    }
}
        
        function renderCharts() {
            // Chart 1: Tagihan 6 Bulan
            const ctx1 = document.getElementById('chartTagihan')?.getContext('2d');
            if (ctx1) {
                if (window.tagihanChart) {
                    window.tagihanChart.destroy();
                }
                
                window.tagihanChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: moment.monthsShort(),
                        datasets: [{
                            label: 'Tagihan (Rp)',
                            data: [5000000, 7500000, 6500000, 8000000, 9000000, 8500000, 9500000, 10000000, 11000000, 10500000, 12000000, 11500000],
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatRupiah(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Chart 2: Status Pelanggan
            const ctx2 = document.getElementById('chartStatus')?.getContext('2d');
            if (ctx2) {
                if (window.statusChart) {
                    window.statusChart.destroy();
                }
                
                window.statusChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Aktif', 'Tunggak', 'Nonaktif'],
                        datasets: [{
                            data: [70, 15, 15],
                            backgroundColor: ['#00b894', '#ff6b6b', '#fdcb6e']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }
        
       async function loadPelangganData() {
    const table = document.getElementById('pelangganTable');
    if (!table) {
        console.warn("⚠️ Tabel pelanggan tidak ditemukan!");
        return;
    }

    // Tampilkan Loading
    table.innerHTML = `<tr><td colspan="7" class="text-center"><div class="spinner" style="width:30px;height:30px;margin:0 auto;"></div> Memuat Data...</td></tr>`;

    try {
        // 1. AMBIL DATA DARI FIREBASE
        const snapshot = await db.collection('pelanggan')
            .where('company_id', '==', globalCompanyId)
            .get();
        
        if (snapshot.empty) {
            table.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center" style="padding: 40px;">
                        <i class="fas fa-inbox" style="font-size: 48px; color: #e9ecef;"></i>
                        <h4 style="margin-top:15px; color: var(--gray);">Database Kosong</h4>
                        <p>Belum ada data pelanggan untuk perusahaan Anda.</p>
                        <button class="btn btn-primary mt-2" onclick="showAddPelangganModal()">
                            <i class="fas fa-plus"></i> Tambah Pelanggan Pertama
                        </button>
                    </td>
                </tr>`;
            pelangganData = []; 
            return;
        }
        
        // 2. SIMPAN DATA KE ARRAY GLOBAL (PENTING!)
        pelangganData = snapshot.docs.map(doc => ({
            id: doc.id,
            nama: doc.data().nama || 'Tidak ada nama',
            telepon: doc.data().telepon || '-',
            alamat: doc.data().alamat || '-',
            paket: doc.data().paket || '-',
            harga: doc.data().harga || 0,
            status: doc.data().status || 'nonaktif',
            email: doc.data().email || `${doc.data().telepon || ''}@xbill.com`,
            tanggal_pasang: doc.data().tanggal_pasang || '',
            koordinat: doc.data().koordinat || '',
            catatan: doc.data().catatan || '',
            company_id: doc.data().company_id || 'TIDAK ADA'
        }));
        
        // 3. AMBIL NILAI FILTER DARI UI
        // Saat pertama load, value akan kosong, sehingga SEMUA data muncul otomatis
        const statusFilter = document.getElementById('filterStatus')?.value || '';
        const paketFilter = document.getElementById('filterPaket')?.value || '';
        const searchFilter = document.getElementById('searchPelanggan')?.value || '';

        let filteredData = [...pelangganData];
        
        // LOGIKA PENCARIAN & FILTER
        if (statusFilter) {
            filteredData = filteredData.filter(p => p.status === statusFilter);
        }
        
        if (paketFilter) {
            filteredData = filteredData.filter(p => p.paket === paketFilter);
        }
        
        if (searchFilter) {
            const keyword = searchFilter.toLowerCase().trim();
            filteredData = filteredData.filter(p => 
                (p.nama && p.nama.toLowerCase().includes(keyword)) ||
                (p.telepon && p.telepon.includes(keyword)) ||
                (p.alamat && p.alamat.toLowerCase().includes(keyword)) ||
                (p.email && p.email.toLowerCase().includes(keyword))
            );
        }
        
        // 5. PAGINATION
        const itemsPerPage = 10;
        const totalItems = filteredData.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        
        if (currentPagePelanggan > totalPages) {
            currentPagePelanggan = Math.max(1, totalPages);
        }
        
        const startIndex = (currentPagePelanggan - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = filteredData.slice(startIndex, endIndex);
        
        // 6. RENDER TABEL
        renderPelangganTable(pageData, totalItems);
        
        // 7. RENDER PAGINATION
        renderPelangganPagination(totalItems);
        
        // 8. LOAD DROPDOWN PAKET UNTUK FILTER (JIKA SUDAH ADA)
        const paketSelect = document.getElementById('filterPaket');
        if (paketSelect && paketSelect.options.length <= 1) {
             loadPaketSelectOptions();
        }
        
    } catch (error) {
        console.error("❌ Error Load Pelanggan:", error);
        table.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error: ${error.message}</td></tr>`;
    }
}

// TAMBAHKAN FUNGSI UNTUK MENYIMPAN FILTER SAAT USER MENGUBAH INPUT
function saveFilterState() {
    const statusVal = document.getElementById('filterStatus')?.value || '';
    const paketVal = document.getElementById('filterPaket')?.value || '';
    
    if (statusVal) localStorage.setItem('last_filter_status', statusVal);
    else localStorage.removeItem('last_filter_status');
    
    if (paketVal) localStorage.setItem('last_filter_paket', paketVal);
    else localStorage.removeItem('last_filter_paket');
}

// ============================================
// FUNGSI UNTUK LOAD SEMUA DATA SEKALI SAJA
// ============================================
async function loadAllDataOnce() {
    try {
        console.log("📊 Loading all data...");
        
        // Load data dasar
        await loadPelangganData();
        await loadPaketData();
        await loadTagihanData();
        
        // ⭐⭐⭐ PERBAIKAN: TAMBAHKAN LOAD PROFIL PERUSAHAAN ⭐⭐⭐
        await loadCompanyProfile();
        
        console.log("✅ All data loaded successfully");
    } catch (error) {
        console.error("❌ Error loading all data:", error);
    }
}

// ============================================
// FUNGSI UNTUK AMBIL DATA DARI CACHE
// ============================================
function getCachedData() {
    const cached = localStorage.getItem('xbill_cache');
    if (!cached) return null;
    
    try {
        const data = JSON.parse(cached);
        
        // VALIDASI 1: CACHE UNTUK COMPANY YANG SAMA
        if (data.company_id !== globalCompanyId) {
            localStorage.removeItem('xbill_cache');
            return null;
        }
        
        // VALIDASI 2: CACHE MAX 1 JAM
        const oneHour = 60 * 60 * 1000;
        if (Date.now() - data.timestamp > oneHour) {
            localStorage.removeItem('xbill_cache');
            return null;
        }
        
        return data;
        
    } catch (e) {
        localStorage.removeItem('xbill_cache');
        return null;
    }
}

// FUNGSI BARU: LOAD PAKET KE DROPDOWN FILTER
// FUNGSI BARU: LOAD PAKET KE DROPDOWN FILTER
async function loadPaketSelectOptions() {
    try {
        const select = document.getElementById('pelangganPaket');
        const hargaInput = document.getElementById('pelangganHarga');
        
        if (!select) {
            console.warn("⚠️ Elemen #pelangganPaket tidak ditemukan");
            return;
        }

        // Simpan nilai yang sedang dipilih user (supaya tidak hilang saat refresh)
        const currentSelected = select.value;

        // 1. AMBIL DATA PAKET DARI DATABASE
        const snapshot = await db.collection('paket')
            .where('company_id', '==', globalCompanyId)
            .where('status', '==', 'aktif')
            .get();
        
        // 2. ISI DROPDOWN
        select.innerHTML = '<option value="">-- Pilih Paket --</option>';
        
        if (snapshot.empty) {
            console.warn("⚠️ Belum ada data paket aktif");
            if(hargaInput) {
                hargaInput.value = '';
                hargaInput.readOnly = false; // Boleh isi manual jika kosong
            }
            return;
        }

        // Simpan data paket ke memory sementara (cache) untuk cari harga nanti
        const paketCache = {}; 

        snapshot.forEach(doc => {
            const p = doc.data();
            // Buat option
            const option = document.createElement('option');
            option.value = p.nama;
            option.textContent = `${p.nama} `; // Tampilkan harga di tooltip dropdown
            
            // Simpan harga di atribut data-harga agar mudah diambil
            option.setAttribute('data-harga', p.harga);
            
            select.appendChild(option);
            
            // Simpan ke cache object
            paketCache[p.nama] = p.harga;
        });

        // 3. KEMBALIKAN PILIHAN USER SEBELUMNYA (JIKA ADA)
        if (currentSelected) {
            select.value = currentSelected;
            // Jika user sedang edit, otomatis isi harganya
            if (currentSelected && paketCache[currentSelected]) {
                hargaInput.value = paketCache[currentSelected];
                hargaInput.readOnly = true; // 🔒 KUNCI (READ ONLY)
            }
        }

        // 4. EVENT LISTENER: KETIKA DROPDOWN DIKLIK/DIGANTI
        // Hanya pasang listener sekali (jangan pasang berulang kali)
        if (!select.hasPaketListener) {
            select.addEventListener('change', function() {
                const namaPaketDipilih = this.value;
                const optionDipilih = this.options[this.selectedIndex];
                
                if (namaPaketDipilih) {
                    // Ambil harga dari atribut 'data-harga' pada option
                    const harga = optionDipilih.getAttribute('data-harga');
                    
                    if (harga) {
                        hargaInput.value = harga;
                        hargaInput.readOnly = true; // 🔒 KUNCI INPUT HARGA
                        console.log(`💰 Harga otomatis terisi: ${harga}`);
                    }
                } else {
                    // Jika user pilih "-- Pilih Paket --"
                    hargaInput.value = '';
                    hargaInput.readOnly = false; // Buka kunci jika kosong
                }
            });
            
            select.hasPaketListener = true; // Tandai sudah ada listener
        }

    } catch (error) {
        console.error("❌ Error load paket select options:", error);
    }
}

// FUNGSI RESET FILTER
function resetFilters() {
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterPaket').value = '';
    document.getElementById('searchPelanggan').value = '';
    loadPelangganData();
}

function renderPelangganTable(data, totalItems) {
    const table = document.getElementById('pelangganTable');
    if (!table) return;

    if (!data || data.length === 0) {
        // Tampilan jika data kosong TANPA tombol reset
        table.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted" style="padding: 40px;">
                    <i class="fas fa-search" style="font-size: 48px; color: #e9ecef; margin-bottom: 15px;"></i>
                    <h4 style="color: var(--gray);">Tidak ada data</h4>
                    <p>Tidak ada pelanggan yang sesuai dengan filter yang dipilih.</p>
                </td>
            </tr>`;
        
        // Reset pagination jika kosong
        const paginationContainer = document.getElementById('pelangganPagination');
        if (paginationContainer) paginationContainer.innerHTML = '';
        
        const elStart = document.getElementById('pelangganStart');
        const elEnd = document.getElementById('pelangganEnd');
        const elTotal = document.getElementById('pelangganTotal');
        
        if (elStart) elStart.textContent = '0';
        if (elEnd) elEnd.textContent = '0';
        if (elTotal) elTotal.textContent = '0';
        
        return;
    }
    
    const startIndex = ((currentPagePelanggan - 1) * itemsPerPage);
    
    table.innerHTML = data.map((pelanggan, index) => {
        const nama = pelanggan.nama || '-';
        const telepon = pelanggan.telepon || '-';
        const alamat = pelanggan.alamat || '-';
        const paket = pelanggan.paket || '-';
        const harga = pelanggan.harga || 0;
        const status = pelanggan.status || 'nonaktif';
        
        let badgeClass = 'badge-warning';
        if (status === 'aktif') badgeClass = 'badge-success';
        if (status === 'tunggak') badgeClass = 'badge-danger';
        
        return `
            <tr>
                <td style="font-weight: bold;">${startIndex + index + 1}</td>
                <td>
                    <strong>${nama}</strong>
                    ${pelanggan.email ? `<br><small class="text-muted">${pelanggan.email}</small>` : ''}
                </td>
                <td>${telepon}</td>
                <td>
                    ${alamat.substring(0, 40)}${alamat.length > 40 ? '...' : ''}
                    ${pelanggan.koordinat ? `<br><small class="text-info"><i class="fas fa-map-marker-alt"></i> ${pelanggan.koordinat}</small>` : ''}
                </td>
                <td>
                    <span class="badge badge-primary">${paket}</span>
                    <br>
                    <small class="text-success">${formatRupiah(harga)}/bln</small>
                </td>
                <td>
                    <span class="badge ${badgeClass}">
                        <i class="fas ${status === 'aktif' ? 'fa-check-circle' : status === 'tunggak' ? 'fa-exclamation-triangle' : 'fa-times-circle'}"></i>
                        ${status.charAt(0).toUpperCase() + status.slice(1)}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" onclick="editPelanggan('${pelanggan.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="viewDetailPelanggan('${pelanggan.id}')" title="Detail">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="deletePelanggan('${pelanggan.id}')" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    // UPDATE INFO TOTAL
    const start = ((currentPagePelanggan - 1) * itemsPerPage);
    const end = Math.min(currentPagePelanggan * itemsPerPage, totalItems);
    
    const elStart = document.getElementById('pelangganStart');
    const elEnd = document.getElementById('pelangganEnd');
    const elTotal = document.getElementById('pelangganTotal');
    
    if (elStart) elStart.textContent = start + 1;
    if (elEnd) elEnd.textContent = end;
    if (elTotal) elTotal.textContent = totalItems;
}

function renderPelangganPagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const container = document.getElementById('pelangganPagination');
    
    if (!container || totalPages <= 1) {
        if (container) container.innerHTML = '';
        return;
    }
    
    let paginationHtml = '<div class="pagination">';
    
    // Previous button
    if (currentPagePelanggan > 1) {
        paginationHtml += `<a class="page-link" onclick="changePage('pelanggan', ${currentPagePelanggan - 1})">&laquo;</a>`;
    }
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPagePelanggan) {
            paginationHtml += `<a class="page-link active">${i}</a>`;
        } else {
            paginationHtml += `<a class="page-link" onclick="changePage('pelanggan', ${i})">${i}</a>`;
        }
    }
    
    // Next button
    if (currentPagePelanggan < totalPages) {
        paginationHtml += `<a class="page-link" onclick="changePage('pelanggan', ${currentPagePelanggan + 1})">&raquo;</a>`;
    }
    
    paginationHtml += '</div>';
    container.innerHTML = paginationHtml;
}



async function deletePelanggan(id) {
    if (localStorage.getItem('userRole') !== 'admin') {
        alert('HANYA ADMIN!'); 
        return;
    }
    
    if (!confirm('HAPUS?')) return;
    
    try {
        showLoading();
        
        // 1. HAPUS DARI DATABASE
        await db.collection('pelanggan').doc(id).delete();
        
        // 2. UPDATE VARIABLE GLOBAL `pelangganData`
        if (Array.isArray(pelangganData)) {
            pelangganData = pelangganData.filter(p => p.id !== id);
        }
        
        // 3. UPDATE CACHE
        if (window.pelangganDataCache) {
            window.pelangganDataCache = window.pelangganDataCache.filter(p => p.id !== id);
        }
        
        // 4. ⭐⭐ RENDER ULANG DENGAN FUNGSI ASLI ANDA ⭐⭐
        // Filter data sesuai filter aktif
        let filteredData = [...pelangganData];
        
        const statusFilter = document.getElementById('filterStatus')?.value;
        if (statusFilter) {
            filteredData = filteredData.filter(p => p.status === statusFilter);
        }
        
        const paketFilter = document.getElementById('filterPaket')?.value;
        if (paketFilter) {
            filteredData = filteredData.filter(p => p.paket === paketFilter);
        }
        
        const searchFilter = document.getElementById('searchPelanggan')?.value;
        if (searchFilter) {
            const keyword = searchFilter.toLowerCase();
            filteredData = filteredData.filter(p => 
                (p.nama && p.nama.toLowerCase().includes(keyword)) ||
                (p.telepon && p.telepon.includes(keyword)) ||
                (p.alamat && p.alamat.toLowerCase().includes(keyword))
            );
        }
        
        // PAGINATION
        const itemsPerPage = 10;
        const start = (currentPagePelanggan - 1) * itemsPerPage;
        const pageData = filteredData.slice(start, start + itemsPerPage);
        
        // ⭐⭐ PANGGIL FUNGSI RENDER ASLI ANDA ⭐⭐
        renderPelangganTable(pageData);
        
        // 5. UPDATE PAGINATION
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        renderPelangganPagination(totalPages);
        
        showToast('success', 'Berhasil', 'Data terhapus');
        hideLoading();
        
    } catch (error) {
        console.error("Error delete pelanggan:", error);
        showToast('error', 'Gagal', 'Gagal menghapus: ' + error.message);
        hideLoading();
    }
}

function applyPelangganFilters(data) {
    const statusFilter = document.getElementById('filterStatus')?.value || '';
    const paketFilter = document.getElementById('filterPaket')?.value || '';
    const searchFilter = document.getElementById('searchPelanggan')?.value || '';
    
    return data.filter(pelanggan => {
        // Filter status
        if (statusFilter && pelanggan.status !== statusFilter) return false;
        
        // Filter paket
        if (paketFilter && pelanggan.paket !== paketFilter) return false;
        
        // Filter search
        if (searchFilter) {
            const searchLower = searchFilter.toLowerCase();
            return (
                (pelanggan.nama && pelanggan.nama.toLowerCase().includes(searchLower)) ||
                (pelanggan.telepon && pelanggan.telepon.includes(searchFilter)) ||
                (pelanggan.alamat && pelanggan.alamat.toLowerCase().includes(searchLower))
            );
        }
        
        return true;
    });
}






// TAMBAHKAN FUNGSI VIEW DETAIL (Opsional, untuk tombol detail)
async function viewDetailPelanggan(id) {
    try {
        const doc = await db.collection('pelanggan').doc(id).get();
        if (!doc.exists) {
            showToast('error', 'Error', 'Data pelanggan tidak ditemukan');
            return;
        }
        
        const data = doc.data();
        let detailHtml = `
            <div style="padding: 20px;">
                <h4>Detail Pelanggan</h4>
                <table class="table" style="background: #f8f9fa; border-radius: 8px;">
                    <tr><td><strong>Nama</strong></td><td>${data.nama || '-'}</td></tr>
                    <tr><td><strong>Telepon</strong></td><td>${data.telepon || '-'}</td></tr>
                    <tr><td><strong>Email</strong></td><td>${data.email || '-'}</td></tr>
                    <tr><td><strong>Alamat</strong></td><td>${data.alamat || '-'}</td></tr>
                    <tr><td><strong>Paket</strong></td><td>${data.paket || '-'} (${formatRupiah(data.harga || 0)})</td></tr>
                    <tr><td><strong>Status</strong></td><td>${data.status || '-'}</td></tr>
                    <tr><td><strong>Tanggal Pasang</strong></td><td>${data.tanggal_pasang || '-'}</td></tr>
                    <tr><td><strong>Koordinat</strong></td><td>${data.koordinat || '-'}</td></tr>
                    <tr><td><strong>Catatan</strong></td><td>${data.catatan || '-'}</td></tr>
                </table>
            </div>
        `;
        
        // Buat modal detail sederhana
        const modal = document.createElement('div');
        modal.className = 'modal-overlay show';
        modal.innerHTML = `
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-user"></i> Detail Pelanggan</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    ${detailHtml}
                </div>
                <div class="modal-footer">
                   
                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                        Tutup
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error("Error viewing detail:", error);
        showToast('error', 'Error', 'Gagal memuat detail pelanggan');
    }
}
        
        
        
        // PERBAIKI loadPaketData():
async function loadPaketData() {
    try {
        console.log("🔄 loadPaketData() dipanggil");
        
        const table = document.getElementById('paketTable');
        if (!table) {
            console.error("❌ Tabel paket tidak ditemukan!");
            return;
        }
        
        // Loading state
        table.innerHTML = `<tr><td colspan="6" class="text-center"><div class="spinner"></div> Memuat data...</td></tr>`;
        
        // Pastikan company_id ada
        if (!globalCompanyId) {
            console.error("❌ globalCompanyId kosong!");
            table.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Company ID tidak ditemukan</td></tr>`;
            return;
        }
        
        // Ambil data
        const snapshot = await db.collection('paket')
            .where('company_id', '==', globalCompanyId)
            .get();
        
        console.log(`📊 ${snapshot.size} paket ditemukan`);
        
        if (snapshot.empty) {
            table.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="fas fa-wifi-slash"></i>
                        <p>Belum ada data paket</p>
                        <button class="btn btn-sm btn-primary mt-2" onclick="showAddPaketModal()">
                            <i class="fas fa-plus"></i> Tambah Paket Pertama
                        </button>
                    </td>
                </tr>
            `;
            return;
        }
        
        // Render langsung di sini (tanpa renderPaketTable)
        let html = '';
        let counter = 1;
        
        snapshot.forEach((doc) => {
            const p = doc.data();
            
            // ⭐⭐ PERBAIKAN: TAMBAHKAN SATUAN (Mbps) ⭐⭐
            const kecepatan = p.kecepatan || '-';
            const kecepatanDenganSatuan = kecepatan.includes('Mbps') ? kecepatan : kecepatan + ' Mbps';
            
            html += `
                <tr>
                    <td><strong>${p.nama || '-'}</strong></td>
                    <td>${kecepatanDenganSatuan}</td> <!-- ⭐⭐ INI YANG DIPERBAIKI ⭐⭐ -->
                    <td>${formatRupiah(p.harga || 0)}</td>
                    <td>${p.kuota || 'Unlimited'}</td>
                    <td>
                        <span class="badge ${p.status === 'aktif' ? 'badge-success' : 'badge-warning'}">
                            ${p.status === 'aktif' ? 'Aktif' : 'Nonaktif'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline" onclick="editPaket('${doc.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="deletePaket('${doc.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            
            counter++;
        });
        
        table.innerHTML = html;
        console.log("✅ Tabel paket berhasil diisi");
        
    } catch (error) {
        console.error("❌ Error loadPaketData:", error);
        showToast('error', 'Gagal', 'Gagal memuat data paket');
        
        const table = document.getElementById('paketTable');
        if (table) {
            table.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${error.message}</td></tr>`;
        }
    }
}

function renderPaketTable(data) {
    const table = document.getElementById('paketTable');
    if (!table) return;
    
    if (data.length === 0) {
        table.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada data</td></tr>';
        return;
    }
    
    table.innerHTML = data.map((paket, index) => {
        const startIndex = ((currentPagePaket - 1) * itemsPerPage);
        return `
            <tr>
                <td><strong>${paket.nama}</strong><br><small>${paket.deskripsi || ''}</small></td>
                <td>${paket.kecepatan}</td>
                <td>${formatRupiah(paket.harga)}</td>
                <td>${paket.kuota || 'Unlimited'}</td>
                <td>
                    <span class="badge ${paket.status === 'aktif' ? 'badge-success' : 'badge-warning'}">
                        ${paket.status === 'aktif' ? 'Aktif' : 'Nonaktif'}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" onclick="editPaket('${paket.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="deletePaket('${paket.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}
        




function applyTagihanFilters(data) {
    const bulanFilter = document.getElementById('filterBulan')?.value || '';
    const statusFilter = document.getElementById('filterStatusTagihan')?.value || '';
    const searchFilter = document.getElementById('searchTagihan')?.value || '';
    
    return data.filter(tagihan => {
        // Filter bulan
        if (bulanFilter && tagihan.bulan !== bulanFilter) return false;
        
        // Filter status
        if (statusFilter && tagihan.status !== statusFilter) return false;
        
        // Filter search
        if (searchFilter) {
            const searchLower = searchFilter.toLowerCase();
            return (
                (tagihan.pelanggan_nama && tagihan.pelanggan_nama.toLowerCase().includes(searchLower)) ||
                (tagihan.id && tagihan.id.toLowerCase().includes(searchLower)) ||
                (tagihan.bulan && tagihan.bulan.includes(searchFilter))
            );
        }
        
        return true;
    });
}

function renderTagihanTable(data) {
    const table = document.getElementById('tagihanTable');
    if (!table) return;

    if (data.length === 0) {
        table.innerHTML = `<tr><td colspan="8" class="text-center">Tidak ada data</td></tr>`;
        return;
    }

    // KELOMPOKKAN DATA
    const grouped = {};
    
    data.forEach(item => {
        const key = item.pelanggan_nama + "|" + item.pelanggan_telepon;
        
        if (!grouped[key]) {
            grouped[key] = {
                nama: item.pelanggan_nama,
                telp: item.pelanggan_telepon,
                alamat: item.pelanggan_alamat,
                tagihan: [],
                total: 0,
                lunas: 0,
                belum: 0,
                telat: 0,
                tglBayar: '-'
            };
        }
        
        grouped[key].tagihan.push({
            bulan: item.bulan,
            jumlah: item.jumlah,
            status: item.status
        });
        
        grouped[key].total += item.jumlah || 0;
        
        if (item.status === 'lunas') {
            grouped[key].lunas++;
            grouped[key].tglBayar = item.tgl_bayar || '-';
        } else if (item.status === 'belum') {
            grouped[key].belum++;
        } else if (item.status === 'telat') {
            grouped[key].telat++;
        }
    });

    // RENDER
    const hasil = Object.values(grouped);
    
    table.innerHTML = hasil.map(item => {
        const bulanList = item.tagihan.map(t => t.bulan).join(', ');
        
        let status = 'Lunas', statusClass = 'badge-success';
        if (item.telat > 0) {
            status = 'Telat';
            statusClass = 'badge-danger';
        } else if (item.belum > 0) {
            status = 'Belum';
            statusClass = 'badge-warning';
        }

        return `
            <tr>
                <td><strong>${item.nama}</strong></td>
                <td>${item.telp}</td>
                <td>${item.alamat.substring(0, 30)}${item.alamat.length > 30 ? '...' : ''}</td>
                <td>${bulanList}</td>
                <td>${formatRupiah(item.total)}</td>
                <td><span class="badge ${statusClass}">${status}</span></td>
                <td>${item.tglBayar}</td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-success" onclick="bayarSemuaTagihan('${item.nama}')">
                            <i class="fas fa-money-bill-wave"></i>
                        </button>
                        <button class="btn btn-sm btn-info" onclick="lihatDetailTagihan('${item.nama}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

async function viewTagihanDetails(pelangganId) {
    console.log("👁️ MEMBUKA RIWAYAT TAGIHAN...");

    try {
        // 1. AMBIL DATA PELANGGAN
        const pelDoc = await db.collection('pelanggan').doc(pelangganId).get();
        const pelData = pelDoc.exists ? pelDoc.data() : {};
        const teleponPelanggan = pelData.telepon || '';
        const namaPelanggan = pelData.nama || 'Pelanggan';

        // 2. AMBIL DATA TAGIHAN
        const snapshot = await db.collection('tagihan')
            .where('pelanggan_id', '==', pelangganId)
            .get();

        if (snapshot.empty) {
            showToast('info', 'Info', 'Riwayat tagihan kosong.');
            return;
        }

        let tagihanList = [];
        snapshot.forEach(doc => {
            let data = doc.data();
            let bulanRaw = data.bulan || '';

            // NORMALISASI FORMAT BULAN
            let bulanFix = bulanRaw;
            if (bulanRaw.includes('-')) {
                let parts = bulanRaw.split('-');
                if (parts[0].length === 4 && parts[1].length === 2) {
                    bulanFix = `${parts[1]}-${parts[0]}`;
                } else if (parts[0].length === 2 && parts[1].length === 4) {
                    bulanFix = bulanRaw;
                }
            }
            
            let partsFix = bulanFix.split('-');
            let numericBulan = parseInt(partsFix[0]) || 1;
            let numericTahun = parseInt(partsFix[1]) || new Date().getFullYear();
            
            tagihanList.push({ 
                id: doc.id, 
                ...data,
                bulan_fix: bulanFix,
                sort_bulan: numericBulan,
                sort_tahun: numericTahun
            });
        });

        // SORTING
        tagihanList.sort((a, b) => {
            if (b.sort_tahun !== a.sort_tahun) {
                return b.sort_tahun - a.sort_tahun;
            }
            return b.sort_bulan - a.sort_bulan;
        });

        // 3. BUAT MODAL "RIWAYAT TAGIHAN" DINAMIS
        const modalId = 'modalDetailTagihanFull';
        const oldModal = document.getElementById(modalId);
        if (oldModal) oldModal.remove();

        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal-overlay show';
        modal.style.zIndex = '1060';
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        modal.innerHTML = `
            <div class="modal modal-lg">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-list"></i> Riwayat Tagihan</h3>
                    <button class="modal-close" onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto'">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 20%;">Bulan</th>
                                    <th style="width: 20%;">Nominal</th>
                                    <th style="width: 15%;">Status</th>
                                    <th style="width: 15%;">Jatuh Tempo</th>
                                    <th style="width: 15%;">Tanggal Bayar</th>
                                    <th style="width: 15%;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="detailTableBody"></tbody>
                        </table>
                    </div>
                    <div id="detailPagination" style="margin-top: 15px; text-align: center;"></div>
                </div>
                <div class="modal-footer" id="modalFooterContent"></div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';

        // 4. FUNGSI RENDER
        window.renderDetailTable = function(page) {
            const tbody = document.getElementById('detailTableBody');
            const paginationDiv = document.getElementById('detailPagination');
            const footerDiv = document.getElementById('modalFooterContent');
            
            const itemsPerPage = 10;
            const totalPages = Math.ceil(tagihanList.length / itemsPerPage);
            if (page > totalPages) page = totalPages;
            
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = tagihanList.slice(start, end);

            // RENDER TABLE
            tbody.innerHTML = pageData.map(t => {
                const isLunas = t.status === 'lunas';
                
                // --- AMBIL LANGSUNG DARI DATABASE ---
                let tglJatuhTempoDisplay = '-';
                if (t.tanggal_jatuh_tempo) {
                    const jatuhTempoDate = moment(t.tanggal_jatuh_tempo, 'DD-MM-YYYY');
                    if (jatuhTempoDate.isValid()) {
                        tglJatuhTempoDisplay = jatuhTempoDate.format('DD MMM YYYY');
                    } else {
                        tglJatuhTempoDisplay = t.tanggal_jatuh_tempo; 
                    }
                }
                
                // TANGGAL BAYAR
                let tglBayarDisplay = '-';
                if (isLunas && t.tanggal_bayar) {
                    let date = null;
                    if (moment(t.tanggal_bayar, 'DD MMM YYYY', true).isValid()) {
                        date = moment(t.tanggal_bayar, 'DD MMM YYYY');
                    } else if (moment(t.tanggal_bayar, 'YYYY-MM-DD', true).isValid()) {
                        date = moment(t.tanggal_bayar, 'YYYY-MM-DD');
                    } else {
                        date = moment(t.tanggal_bayar);
                    }
                    
                    if (date.isValid()) {
                        tglBayarDisplay = date.format('DD MMM YYYY');
                    } else {
                        tglBayarDisplay = t.tanggal_bayar;
                    }
                }

                let rowStyle = '';
                let statusBadge = '<span class="badge badge-danger">BELUM</span>';
                
                if (isLunas) {
                    rowStyle = 'background-color: #f0fff4 !important;';
                    statusBadge = '<span class="badge badge-success">LUNAS</span>';
                } else {
                    rowStyle = 'background-color: #fff0f0 !important;';
                }

                // ========================================
                // LOGIKA TOMBOL: JIKA LUNAS KIRIM, JIKA BELUM LUNAS BAYAR
                // ========================================
                let btnAksi = '';
                
                if (isLunas) {
                    // JIKA SUDAH LUNAS: TOMBOL KIRIM STRUK (GAMBAR)
                    btnAksi = `
                    <button class="btn btn-sm btn-success" id="btnKirimLunas_${t.id}">
                        <i class="fas fa-share"></i> Kirim
                    </button>
                    `;

                    // Pasang Event Listener Kirim Struk
                    setTimeout(() => {
                        const btn = document.getElementById(`btnKirimLunas_${t.id}`);
                        if (btn) {
                            btn.onclick = async function() {
                                try {
                                    const originalText = this.innerHTML;
                                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Proses...';
                                    this.disabled = true;

                                    // Data Struk
                                    const nominal = t.jumlah || 0;
                                    const tglBayarStr = t.tanggal_bayar ? moment(t.tanggal_bayar).format('DD MMMM YYYY') : moment().format('DD MMMM YYYY');
                                    const namaPetugas = t.nama_petugas || t.updated_by || getNamaKaryawan();
                                    const namaPerusahaan = window.globalCompanyName || 'X-BILL ISP';
                                    const alamatPerusahaan = window.globalCompanyAddress || 'Jl. Internet Cepat No. 1';
                                    const noInvoice = `INV/${t.id.substring(t.id.length - 6).toUpperCase()}`;

                                    // Buat Struk HTML
                                    const strukContainer = document.createElement('div');
                                    strukContainer.style.position = 'absolute';
                                    strukContainer.style.left = '-9999px';
                                    strukContainer.style.top = '0';
                                    strukContainer.style.width = '300px'; 
                                    strukContainer.style.background = 'white';
                                    strukContainer.style.padding = '15px'; 
                                    strukContainer.style.fontFamily = 'Courier New, Courier, monospace'; 
                                    strukContainer.style.fontSize = '12px'; 
                                    strukContainer.style.color = '#000000'; 
                                    strukContainer.style.border = '1px solid #000';
                                    
                                    strukContainer.innerHTML = `
                                        <div style="text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px;">
                                            <h2 style="margin: 0; font-size: 16px; font-weight: bold;">${namaPerusahaan}</h2>
                                            <p style="margin: 0; font-size: 10px;">Jl. Internet Cepat No. 1</p>
                                        </div>
                                        
                                        <div style="margin-bottom: 10px;">
                                            <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                                                <tr>
                                                    <td style="padding: 2px 0; width: 30%; color: #666;">TGL</td>
                                                    <td style="padding: 2px 0; font-weight: bold; text-align: right;">${tglBayarStr}</td>
                                                </tr>
                                                <tr>
                                                    <td style="padding: 2px 0; color: #666;">NO</td>
                                                    <td style="padding: 2px 0; font-weight: bold; text-align: right;">${noInvoice}</td>
                                                </tr>
                                                <tr>
                                                    <td style="padding: 2px 0; color: #666;">PETUGAS</td>
                                                    <td style="padding: 2px 0; font-weight: bold; text-align: right;">${namaPetugas.toUpperCase()}</td>
                                                </tr>
                                            </table>
                                        </div>

                                        <div style="border-top: 1px dashed #ccc; border-bottom: 1px dashed #ccc; padding: 8px 0; margin-bottom: 10px;">
                                            <div style="font-size: 11px; color: #666; margin-bottom: 2px;">PELANGGAN</div>
                                            <div style="font-weight: bold; font-size: 12px; margin-bottom: 2px;">${namaPelanggan}</div>
                                        </div>

                                        <div style="margin-bottom: 10px;">
                                            <div style="display: flex; justify-content: space-between; font-size: 11px; border-bottom: 1px dotted #eee; padding-bottom: 5px;">
                                                <span>PAKET INTERNET</span>
                                                <span>${formatRupiah(nominal)}</span>
                                            </div>
                                            <div style="font-size: 10px; color: #666; margin-top: 2px; padding-left: 5px;">
                                                ${pelData.paket || 'Paket Internet'} (${t.bulan_fix})
                                            </div>
                                        </div>

                                        <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 5px; border-top: 2px solid #000; font-weight: bold; font-size: 14px;">
                                            <span>TOTAL</span>
                                            <span>${formatRupiah(nominal)}</span>
                                        </div>

                                        <div style="text-align: center; margin-top: 5px; font-size: 11px;">
                                            <div id="notaStatusText" style="font-weight: bold; color: #27ae60;">LUNAS</div>
                                        </div>

                                        <div style="margin-top: 20px; text-align: center; border-top: 1px dashed #ccc; padding-top: 10px; font-size: 10px; color: #666;">
                                            <p style="margin: 0 0 5px 0;">Terima Kasih atas kepercayaan Anda</p>
                                            <p style="margin: 0;">Simpan struk ini sebagai bukti pembayaran yang sah.</p>
                                        </div>
                                    `;
                                    
                                    document.body.appendChild(strukContainer);
                                    await new Promise(r => setTimeout(r, 100));

                                    const canvas = await html2canvas(strukContainer, {
                                        scale: 2, useCORS: true, backgroundColor: "#ffffff"
                                    });

                                    canvas.toBlob(async function(blob) {
                                        document.body.removeChild(strukContainer);
                                        if (!blob) throw new Error("Gagal membuat gambar");

                                        const fileShare = new File([blob], `Bukti_Lunas_${t.id}.png`, { type: 'image/png' });
                                        
                                        if (navigator.share && navigator.canShare({ files: [fileShare] })) {
                                            try {
                                                await navigator.share({
                                                    title: 'Bukti Pembayaran',
                                                    text: `Halo Kak ${namaPelanggan}, berikut bukti pelunasan tagihan ${t.bulan_fix}.`,
                                                    files: [fileShare] 
                                                });
                                                // TIDAK MENGUBAH TEKS TOMBOL MENJADI "TERKIRIM"
                                            } catch (shareError) {
                                                console.log("Share dibatalkan user");
                                                // PERBAIKAN: Pastikan tombol kembali normal jika user batal
                                            }
                                        } else {
                                            alert("Browser tidak support share otomatis.");
                                            const url = URL.createObjectURL(blob);
                                            const link = document.createElement('a');
                                            link.href = url;
                                            link.download = `Bukti_Lunas_${t.id}.png`;
                                            link.click();
                                        }
                                        // PENTING: Reset tombol di luar catch/finally agar selalu jalan
                                        btn.innerHTML = originalText;
                                        btn.disabled = false;
                                    }, 'image/png');

                                } catch (error) {
                                    console.error("Error:", error);
                                    // Reset tombol jika error
                                    btn.innerHTML = originalText; 
                                    btn.disabled = false;
                                    showToast('error', 'Gagal', 'Gagal memproses gambar: ' + error.message);
                                }
                            };
                        }
                    }, 100);
                } else {
                    // JIKA BELUM LUNAS: TOMBOL BAYAR (BUKA FORM)
                    btnAksi = `
                    <button class="btn btn-sm btn-success" 
                        onclick="bukaNotaDanKonfirmasi('${t.id}', '${pelangganId}', '${namaPelanggan}', ${t.jumlah}, '${t.bulan_fix}')" 
                        title="Bayar Sekarang">
                        <i class="fas fa-money-bill-wave"></i> Bayar
                    </button>
                    `;
                }
                
                return `
                    <tr style="${rowStyle}" data-id="${t.id}"> 
                        <td><strong>${t.bulan_fix}</strong></td>
                        <td>${formatRupiah(t.jumlah)}</td>
                        <td>${statusBadge}</td>
                        <td>${tglJatuhTempoDisplay}</td>
                        <td>${tglBayarDisplay}</td>
                        <td>${btnAksi}</td>
                    </tr>
                `;
            }).join('');

            // FOOTER
            if (footerDiv) {
                let footerHTML = `<button class="btn btn-primary" onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto'">Tutup</button>`;
                
                const listBelumUrut = tagihanList.filter(item => item.status !== 'lunas');
                if (listBelumUrut.length > 0) {
                    const idsBelumUrut = listBelumUrut.map(item => item.id).join(',');
                    const totalBelum = listBelumUrut.reduce((sum, item) => sum + (item.jumlah || 0), 0);

                    footerHTML = `
                        <button class="btn btn-success" onclick="executePayAllDirect('${pelangganId}', '${idsBelumUrut}', ${totalBelum}, 'Riwayat')">
                            <i class="fas fa-money-bill-wave"></i> Bayar Semua
                        </button>
                        <button class="btn btn-primary" onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto'">Tutup</button>
                    `;
                }
                footerDiv.innerHTML = footerHTML;
            }

            // PAGINATION
            if (paginationDiv) {
                let pagHTML = '<div class="pagination">';
                if (page > 1) pagHTML += `<a class="page-link" onclick="window.renderDetailTable(${page - 1})">&laquo;</a>`;
                pagHTML += `<span style="padding: 8px;">Hal ${page} / ${totalPages}</span>`;
                if (page < totalPages) pagHTML += `<a class="page-link" onclick="window.renderDetailTable(${page + 1})">&raquo;</a>`;
                pagHTML += '</div>';
                paginationDiv.innerHTML = pagHTML;
            }
        };

        window.renderDetailTable(1);

    } catch (error) {
        console.error("❌ Error view detail:", error);
        showToast('error', 'Gagal', 'Gagal memuat detail: ' + error.message);
    }
}




async function executePayAllDirect(pelangganId, idsString, totalNominal, bulanString) {
    const tagihanIds = String(idsString).split(',');
    const tagihanId = tagihanIds[0];

    let dataPelanggan = { nama: 'Pelanggan', telepon: '-', paket: 'Paket Umum', alamat: '-' };
    try {
        const docPel = await db.collection('pelanggan').doc(pelangganId).get();
        if (docPel.exists) {
            const data = docPel.data();
            dataPelanggan.nama = data.nama;
            dataPelanggan.telepon = data.telepon;
            dataPelanggan.paket = data.paket;
            dataPelanggan.alamat = data.alamat;
        }
    } catch (e) { console.warn(e); }

    await bukaNotaDanKonfirmasi(tagihanId, pelangganId, dataPelanggan.nama, totalNominal, bulanString);
    
    const btnBayar = document.getElementById('btnBayarStruk');
    if(btnBayar) {
        const newBtn = btnBayar.cloneNode(true);
        btnBayar.parentNode.replaceChild(newBtn, btnBayar);
        
        newBtn.onclick = async function() {
            if (!confirm(`Lunas ${tagihanIds.length} tagihan (${formatRupiah(totalNominal)})?`)) return;

            showLoading();
            try {
                const batch = db.batch();
                const now = new Date().toISOString();
                const tglHariIni = moment().format('DD MMMM YYYY, HH:mm');

                tagihanIds.forEach(id => {
                    const ref = db.collection('tagihan').doc(id);
                    batch.update(ref, {
                        status: 'lunas',
                        tanggal_bayar: tglHariIni,
                        metode_bayar: 'Tunai (Bulk)',
                        catatan_bayar: 'Pelunasan melalui menu Rincian Tagihan',
                        updated_at: now
                    });
                });

                await batch.commit();
                hideLoading();
                
                const btnBatal = document.getElementById('btnBatalStruk');
                const btnKirim = document.getElementById('btnKirimWA');
                const statusText = document.getElementById('notaStatusText');
                const btnContainer = document.getElementById('notaFooterContainer');
                const strukElement = document.getElementById('strukPrintable');

                if (btnContainer) {
                    newBtn.style.display = 'none';
                    if (btnBatal) btnBatal.style.display = 'none';

                    if (!document.getElementById('btnSelesaiStruk')) {
                        const btnBaru = document.createElement('button');
                        btnBaru.id = 'btnSelesaiStruk';
                        btnBaru.className = 'btn';
                        btnBaru.style.cssText = 'width: 100%; background: #2ecc71; color: white; padding: 15px; border-radius: 6px; font-weight: bold; font-size: 16px; margin-top: 10px; border: none; cursor: pointer;';
                        btnBaru.innerHTML = '<i class="fas fa-check-circle"></i> SELESAI';
                        btnContainer.appendChild(btnBaru);
                        
                        btnBaru.onclick = () => {
                            document.getElementById('strukOverlay').remove();
                            const modalDetail = document.getElementById('modalDetailTagihan');
                            if(modalDetail) modalDetail.remove();
                            if (typeof loadTagihanData === 'function') loadTagihanData();
                        };
                    }

                    if (btnKirim) {
                        btnKirim.removeAttribute('disabled');
                        btnKirim.style.background = '#25D366';
                        btnKirim.style.color = 'white';
                        btnKirim.style.cursor = 'pointer';
                        btnKirim.innerHTML = '<i class="fas fa-camera"></i> KIRIM NOTA';

                        btnKirim.onclick = async function() {
                            const btnOriginal = this.innerHTML;
                            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> MEMBUAT GAMBAR...';
                            this.disabled = true;

                            try {
                                if (!strukElement) throw new Error("Elemen tidak ada");

                                const canvas = await html2canvas(strukElement, {
                                    scale: 2,
                                    useCORS: true,
                                    backgroundColor: "#ffffff"
                                });

                                const imageUrl = await uploadAtauDownloadStruk(canvas, pelangganId);

                                if (imageUrl) {
                                    const noWA = "62" + (globalDataPelanggan.telepon || '').replace(/^0/, '');
                                    const pesanWA = `*BUKTI PELUNASAN TAGIHAN*\n\nHalo Kak ${globalDataPelanggan.nama},\n\nBerikut bukti pelunasan bulan ${bulanString} (${tagihanIds.length} bulan):\n\n${imageUrl}\n\nTerima kasih.`;
                                    
                                    window.open(`https://wa.me/${noWA}?text=${encodeURIComponent(pesanWA)}`, '_blank');
                                    
                                    this.innerHTML = '<i class="fas fa-check"></i> TERKIRIM';
                                    this.style.background = '#2ecc71';
                                } else {
                                    this.innerHTML = btnOriginal;
                                    this.disabled = false;
                                }

                            } catch (err) {
                                console.error(err);
                                this.innerHTML = btnOriginal;
                                this.disabled = false;
                            }
                        };
                    }

                    if (statusText) {
                        statusText.textContent = 'LUNAS (SEMUA)';
                        statusText.style.color = '#27ae60';
                    }
                }

            } catch (error) {
                hideLoading();
                console.error(error);
                showToast('error', 'Gagal', error.message);
            }
        };
    }
}


// ==========================================
// FUNGSI UPDATE TOMBOL DI TABEL (HELPER)
// (BARU - TAMBAHKAN INI)
// ==========================================
 function getTombolBayarHTML(tagihan) {
    const namaAman = (tagihan.pelanggan_nama || 'Pelanggan').replace(/"/g, '&quot;');
    return `
    <button class="btn btn-sm btn-success" 
        onclick="bukaNotaDanKonfirmasi('${tagihan.id}', '${tagihan.pelanggan_id}', '${namaAman}', ${tagihan.jumlah}, '${tagihan.bulan}')" 
        title="Bayar Sekarang">
        <i class="fas fa-money-bill-wave"></i> Bayar
    </button>
    `;
}

// ==========================================
// FUNGSI TAMPILKAN POP UP KONFIRMASI
// (BARU - TAMBAHKAN INI)
// ==========================================
function tampilkanPopUpKonfirmasi(tagihanId, pelangganId, namaPelanggan, nominal, bulan) {
    const modal = document.createElement('div');
    modal.id = 'modalKonfirmasiBayar';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.background = 'rgba(0, 0, 0, 0.7)';
    modal.style.zIndex = '1000000';
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    
    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.4); animation: popIn 0.3s;">
            <div style="width: 70px; height: 70px; background: #e74c3c; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 30px;">
                <i class="fas fa-question"></i>
            </div>
            <h3 style="color: #2c3e50; margin: 0 0 10px 0;">Konfirmasi Pembayaran</h3>
            <p style="color: #7f8c8d; font-size: 16px; margin: 0 0 20px 0;">Yakin ingin memproses pembayaran <strong>${formatRupiah(nominal)}</strong>?</p>
            
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button id="btnConfirmCancel" style="flex: 1; padding: 12px; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; color: #555;">Batal</button>
                <button id="btnConfirmOK" style="flex: 1; padding: 12px; border: none; background: #27ae60; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Ya, Bayar</button>
            </div>
        </div>
        <style>@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }</style>
    `;
    
    document.body.appendChild(modal);

    document.getElementById('btnConfirmCancel').onclick = () => modal.remove();
    document.getElementById('btnConfirmOK').onclick = async () => {
        modal.remove();
        await prosesBayarDanUpdateNota(tagihanId, pelangganId, namaPelanggan, nominal, bulan);
    };
}


async function uploadAtauDownloadStruk(canvas, fileNamePrefix) {
    try {
        const dataUrl = canvas.toDataURL("image/png");
        let finalUrl = null;

        try {
            const blob = await (await fetch(dataUrl)).blob();
            const formData = new FormData();
            formData.append('image', blob);
            
            // API KEY LU ADA DI SINI
            const response = await fetch('https://api.imgbb.com/1/upload?key=a49ed3d489c6e1745b4948e06e5eee15', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success && result.data && result.data.url) {
                finalUrl = result.data.url;
            } else {
                throw new Error("Upload Gagal");
            }

        } catch (uploadError) {
            console.warn("Upload Gagal, Download Manual:", uploadError);
            
            // Download Otomatis Jika Gagal
            const downloadLink = document.createElement('a');
            downloadLink.href = dataUrl;
            downloadLink.download = `${fileNamePrefix}.png`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            alert("Upload gagal. Gambar didownload otomatis. Silakan kirim manual.");
            return null;
        }

        return finalUrl;

    } catch (error) {
        console.error("Error fungsi upload:", error);
        return null;
    }
}

// ==========================================
// FUNGSI HELPER: AMBIL PENGATURAN STRUK (FOOTER & WARNA)
// ==========================================
function getStrukSettings() {
    // Ambil dari localStorage, kalau kosong pakai default
    const savedSettings = localStorage.getItem('xbill_struk_settings');
    
    if (savedSettings) {
        return JSON.parse(savedSettings);
    }

    // Default Settings
    return {
        themeColor: '#000000', // Default Hitam (Thermal)
        footerText1: 'Terima Kasih atas kepercayaan Anda',
        footerText2: 'Simpan struk ini sebagai bukti pembayaran yang sah.',
        showLogo: true
    };
}

// ==========================================
//  FUNGSI PROSES BAYAR & UPDATE TAMPILAN NOTA
// (PERBAIKAN: UPDATE STATUS TABEL LANGSUNG)
// ==========================================
async function prosesBayarDanUpdateNota(tagihanId, pelangganId, namaPelanggan, nominal, bulan) {
    try {
        // 1. UPDATE DATABASE
        const ref = db.collection('tagihan').doc(tagihanId);
        const tglSekarang = moment().format('DD MMMM YYYY, HH:mm');

        await ref.update({
            status: 'lunas',
            tanggal_bayar: tglSekarang,
            metode_bayar: 'Tunai / Transfer',
            catatan_bayar: 'Lunas via Web App',
            updated_at: new Date().toISOString()
        });

        // 2. UPDATE TAMPILAN NOTA
        const btnBayar = document.getElementById('btnBayarStruk');
        const btnBatal = document.getElementById('btnBatalStruk');
        const btnKirim = document.getElementById('btnKirimWA');
        const statusText = document.getElementById('notaStatusText');
        const btnContainer = document.getElementById('notaFooterContainer');

        if (btnContainer) {
            if (btnBayar) btnBayar.style.display = 'none';
            if (btnBatal) btnBatal.style.display = 'none';

            // Buat Tombol Selesai
            if (!document.getElementById('btnSelesaiStruk')) {
                const btnBaru = document.createElement('button');
                btnBaru.id = 'btnSelesaiStruk';
                btnBaru.className = 'btn';
                btnBaru.style.cssText = 'width: 100%; background: #2ecc71; color: white; padding: 15px; border-radius: 6px; font-weight: bold; font-size: 16px; margin-top: 10px; border: none; cursor: pointer;';
                btnBaru.innerHTML = '<i class="fas fa-check-circle"></i> SELESAI';
                btnContainer.appendChild(btnBaru);
                
                // ===============================
                // PERBAIKAN FINAL: REFRESH DATA SEBELUM TUTUP
                // ===============================
                btnBaru.onclick = async function() {
                    // Tampilkan loading sebentar
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refresh...';
                    
                    try {
                        // 1. Refresh Halaman Utama
                        if (typeof loadTagihanData === 'function') {
                            await loadTagihanData();
                        }

                        // 2. Refresh Modal Detail (Riwayat Tagihan)
                        // Kita panggil lagi fungsi viewTagihanDetails untuk reload data dari DB
                        if (pelangganId) {
                            // Hapus dulu modal lama agar bersih
                            const oldModal = document.getElementById('modalDetailTagihanFull');
                            if (oldModal) oldModal.remove();

                            // Tampilkan modal baru (akan otomatis hijau karena data sudah lunas di DB)
                            await viewTagihanDetails(pelangganId);
                        }

                    } catch (err) {
                        console.error("Error refresh:", err);
                    } finally {
                        // Hapus Nota Overlay setelah refresh selesai (atau error)
                        const strukOverlay = document.getElementById('strukOverlay');
                        if (strukOverlay) strukOverlay.remove();
                    }
                };
            }

            // --- LOGIKA TOMBOL KIRIM WA ---
            if (btnKirim) {
                btnKirim.removeAttribute('disabled');
                btnKirim.style.background = '#25D366';
                btnKirim.style.color = 'white';
                btnKirim.style.cursor = 'pointer';
                btnKirim.style.opacity = '1';
                btnKirim.innerHTML = '<i class="fas fa-share"></i> KIRIM KE WA';

                btnKirim.onclick = async function() {
                    const btnOriginal = this.innerHTML;
                    
                    try {
                        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> MEMPROSES...';
                        this.disabled = true;

                        const strukEl = document.getElementById('strukPrintable');
                        if (!strukEl) throw new Error("Elemen nota tidak ditemukan");

                        const cloneStruk = strukEl.cloneNode(true);
                        const footerClone = cloneStruk.querySelector('#notaFooterContainer');
                        if (footerClone) footerClone.style.display = 'none';

                        cloneStruk.style.position = 'absolute';
                        cloneStruk.style.top = '-9999px';
                        cloneStruk.style.left = '-9999px';
                        cloneStruk.style.background = 'white';
                        document.body.appendChild(cloneStruk);

                        const canvas = await html2canvas(cloneStruk, {
                            scale: 2, 
                            useCORS: true,
                            backgroundColor: "#ffffff"
                        });

                        document.body.removeChild(cloneStruk);

                        canvas.toBlob(async function(blob) {
                            if (!blob) throw new Error("Gagal membuat gambar");

                            const fileShare = new File([blob], `Bukti_Bayar_${tagihanId}.png`, { type: 'image/png' });
                            
                            if (navigator.share && navigator.canShare({ files: [fileShare] })) {
                                try {
                                    await navigator.share({
                                        title: 'Bukti Pembayaran',
                                        text: `Halo Kak ${namaPelanggan}, berikut bukti pembayaran tagihan bulan ${bulan}.`,
                                        files: [fileShare] 
                                    });
                                    
                                    this.innerHTML = '<i class="fas fa-check"></i> TERKIRIM';
                                    this.style.background = '#2ecc71';
                                } catch (shareError) {
                                    console.log("Share dibatalkan user");
                                    this.innerHTML = btnOriginal;
                                    this.disabled = false;
                                }
                            } else {
                                alert("Browser Anda tidak mendukung Share Langsung.");
                                const url = URL.createObjectURL(blob);
                                const link = document.createElement('a');
                                link.href = url;
                                link.download = `Bukti_Bayar_${tagihanId}.png`;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                
                                this.innerHTML = btnOriginal;
                                this.disabled = false;
                            }

                        }, 'image/png');

                    } catch (error) {
                        console.error("Error:", error);
                        this.innerHTML = btnOriginal; 
                        this.disabled = false;
                        showToast('error', 'Gagal', 'Gagal memproses gambar: ' + error.message);
                    }
                };
            }

            if (statusText) {
                statusText.textContent = 'LUNAS';
                statusText.style.color = '#27ae60';
            }
        }
    } catch (error) {
        hideLoading();
        console.error("Error bayar:", error);
        showToast('error', 'Gagal', error.message);
    }
}





async function prepareModalPayAll(pelangganId, idsString, totalNominal, bulanString) {
    console.log("📦 Menyiapkan Modal PayAll...");

    try {
        // 1. Tutup Modal Detail (Supaya bersih)
        forceCloseModal('modalDetailTagihan');

        // 2. Ambil Data Pelanggan
        const docRef = await db.collection('pelanggan').doc(pelangganId).get();
        if (!docRef.exists) return;
        
        const data = docRef.data();

        // 3. ISI FORM MODAL PAYALL
        const hiddenInput = document.getElementById('payAllTagihanIds');
        const namaEl = document.getElementById('payAllNama');
        const teleponEl = document.getElementById('payAllTelepon');
        const totalTagihanEl = document.getElementById('payAllTotalTagihan');
        const totalDendaEl = document.getElementById('payAllDenda');
        const grandTotalEl = document.getElementById('payAllGrandTotal');
        const inputNominalEl = document.getElementById('payAllInputNominal');
        const tglEl = document.getElementById('payAllTanggal');

        // Cek elemen ada sebelum diset
        if (!hiddenInput || !namaEl) {
            console.error("Elemen Modal PayAll tidak ditemukan di HTML.");
            showToast('error', 'Error', 'Form Modal PayAll belum siap (HTML ID salah/hilang).');
            return;
        }

        if (hiddenInput) hiddenInput.value = idsString;
        if (namaEl) namaEl.textContent = data.nama;
        if (teleponEl) teleponEl.textContent = data.telepon;
        if (totalTagihanEl) totalTagihanEl.textContent = formatRupiah(totalNominal);
        if (totalDendaEl) totalDendaEl.textContent = 'Rp 0';
        if (grandTotalEl) grandTotalEl.textContent = formatRupiah(totalNominal);
        if (inputNominalEl) inputNominalEl.value = totalNominal;
        if (tglEl) tglEl.value = moment().format('YYYY-MM-DD');

        // 4. BUKA MODAL PAYALL
        const modalPay = document.getElementById('modalPayAll');
        if (modalPay) {
            modalPay.classList.remove('hidden');
            modalPay.classList.add('show');
            modalPay.style.display = 'flex';
            modalPay.style.zIndex = '1060'; // Di atas modal detail
            document.body.style.overflow = 'hidden';
        } else {
            showToast('error', 'Error', 'Modal PayAll tidak ditemukan di HTML.');
        }

    } catch (error) {
        console.error("Error prepare modal:", error);
        showToast('error', 'Error', 'Gagal menyiapkan form pembayaran.');
    }
}


// ============================================
// FULL FUNGSI TOMBOL BAYAR (SINGLE & BULK)
// ============================================

// 1. FUNGSI UTAMA: BUKA NOTA + UPDATE PETUGAS & PERUSAHAAN
async function bukaNotaDanKonfirmasi(tagihanId, pelangganId, namaPelanggan, nominal, bulan) {
    try {
        // Ambil Data Pelanggan
        let dataPelanggan = { 
            nama: namaPelanggan, 
            alamat: 'Alamat belum diset', 
            telepon: '-', 
            paket: 'Paket Umum',
            id_pelanggan: pelangganId
        };

        try {
            const docPel = await db.collection('pelanggan').doc(pelangganId).get();
            if (docPel.exists) {
                const data = docPel.data();
                dataPelanggan.nama = data.nama || namaPelanggan;
                dataPelanggan.alamat = data.alamat || '-';
                dataPelanggan.telepon = data.telepon || '-';
                dataPelanggan.paket = data.paket || 'Paket Umum';
                dataPelanggan.id_pelanggan = docPel.id;
            }
        } catch (e) {
            console.warn("Gagal ambil detail pelanggan:", e);
        }

        globalDataPelanggan = dataPelanggan;

        // --- AMBIL NAMA PETUGAS (USER LOGIN) ---
        let namaPetugas = 'ADMIN'; // Default
        
        try {
            const userStr = localStorage.getItem('xbill_user');
            if (userStr) {
                const userObj = JSON.parse(userStr);
                // Cek nama, kalau gak ada pakai email
                if (userObj.name) {
                    namaPetugas = userObj.name;
                } else if (userObj.email) {
                    namaPetugas = userObj.email.split('@')[0];
                }
            }
        } catch (err) {
            console.log("Gagal ambil user login");
        }
        // ----------------------------------------

        // --- AMBIL DATA DARI VARIABEL GLOBAL (SINKRON DASHBOARD) ---
        let namaPerusahaan = window.globalCompanyName || 'X-BILL ISP';
        let alamatPerusahaan = window.globalCompanyAddress || 'Jl. Merdeka No. 45, Jakarta';
        // -----------------------------------------------------------------

        // Buat Tampilan Nota (Overlay)
        const strukOverlay = document.createElement('div');
        strukOverlay.id = 'strukOverlay';
        strukOverlay.style.position = 'fixed';
        strukOverlay.style.top = '0';
        strukOverlay.style.left = '0';
        strukOverlay.style.width = '100%';
        strukOverlay.style.height = '100%';
        strukOverlay.style.background = 'rgba(0, 0, 0, 0.85)';
        strukOverlay.style.zIndex = '999999';
        strukOverlay.style.display = 'flex';
        strukOverlay.style.alignItems = 'center';
        strukOverlay.style.justifyContent = 'center';
        strukOverlay.style.overflowY = 'auto';
        strukOverlay.style.padding = '20px';

        const tanggalInvoice = moment().format('DD MMMM YYYY');
        const noInvoice = `INV/${tagihanId.substring(tagihanId.length - 6).toUpperCase()}`;

        // HTML STRUK LENGKAP
        strukOverlay.innerHTML = `
             <div style="
                display: flex; 
                flex-direction: column; 
                align-items: center; 
                justify-content: center; 
                width:100%;
            ">
                <!-- AREA STRUK -->
                <div id="strukPrintable" style="
                    background: white; 
                    width:320px; 
                    padding:15px; 
                    font-family: 'Courier New', Courier, monospace; 
                    font-size: 12px; 
                    color: #333; 
                    box-shadow:0 0 20px rgba(0,0,0,0.5); 
                    position: relative; 
                    border-radius:5px;
                    margin-bottom: 15px;
                ">
                    
                    <!-- HEADER (PERUSAHAAN) -->
                    <div style="
                        text-align: center; 
                        border-bottom: 2px dashed #000; 
                        padding-bottom: 10px; 
                        margin-bottom: 10px;
                    ">
                        <h2 id="displayStrukCompanyName" style="
                            margin: 0; 
                            font-size: 16px; 
                            font-weight: bold; 
                            text-transform: uppercase;
                            color: #000;
                        ">${namaPerusahaan}</h2>
                        <p style="margin: 2px 0 0 0; font-size: 10px; color: #666;">Billing Management System</p>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">${alamatPerusahaan}</p>
                        </div>

                    <!-- INFO TRANSAKSI -->
                    <div style="margin-bottom: 10px;">
                        <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                            <tr>
                                <td style="padding: 2px 0; width: 30%; color: #666;">TGL</td>
                                <td style="padding: 2px 0; font-weight: bold; text-align: right;">${tanggalInvoice}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0; color: #666;">NO</td>
                                <td style="padding: 2px 0; font-weight: bold; text-align: right;">${noInvoice}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0; color: #666;">PETUGAS</td>
                                <td style="padding: 2px 0; font-weight: bold; text-align: right;">${namaPetugas.toUpperCase()}</td>
                            </tr>
                        </table>
                    </div>

                    <!-- PEMBELI -->
                    <div style="
                        border-top: 1px dashed #ccc; 
                        border-bottom: 1px dashed #ccc; 
                        padding: 8px 0; 
                        margin-bottom: 10px;
                    ">
                        <div style="font-size: 11px; color: #666; margin-bottom: 2px;">PELANGGAN</div>
                        <div style="font-weight: bold; font-size: 12px; margin-bottom: 2px;">${globalDataPelanggan.nama}</div>
                    </div>

                    <!-- ITEM TAGIHAN -->
                    <div style="margin-bottom: 10px;">
                        <div style="
                            display: flex; 
                            justify-content: space-between; 
                            font-size: 11px; 
                            border-bottom: 1px dotted #eee; 
                            padding-bottom: 5px;
                        ">
                            <span>PAKET INTERNET</span>
                            <span>${formatRupiah(nominal)}</span>
                        </div>
                        <div style="
                            font-size: 10px; 
                            color: #666; 
                            margin-top: 2px; 
                            padding-left: 5px;
                        ">
                            ${globalDataPelanggan.paket} (${bulan})
                        </div>
                    </div>

                    <!-- TOTAL -->
                    <div style="
                        display: flex; 
                        justify-content: space-between; 
                        margin-top: 10px; 
                        padding-top: 5px; 
                        border-top: 2px solid #000; 
                        font-weight: bold; 
                        font-size: 14px;
                    ">
                        <span>TOTAL</span>
                        <span>${formatRupiah(nominal)}</span>
                    </div>

                    <!-- STATUS -->
                    <div style="text-align: center; margin-top: 5px; font-size: 11px;">
                        <div id="notaStatusText" style="font-weight: bold; color: #e74c3c;">BELUM LUNAS</div>
                    </div>

                    <!-- FOOTER (ALAMAT PERUSAHAAN) -->
                    <div style="
                        margin-top: 20px; 
                        text-align: center; 
                        border-top: 1px dashed #ccc; 
                        padding-top: 10px; 
                        font-size: 10px; 
                        color: #666;
                    ">
                        <p style="margin: 0 0 5px 0;">Terima Kasih atas kepercayaan Anda</p>
                        <p style="margin: 0;">Simpan struk ini sebagai bukti pembayaran yang sah.</p>
                        
                    </div>

                </div>

                <!-- TOMBOL AKSI -->
                <div id="notaFooterContainer" style="
                    width: 320px; 
                    display: flex; 
                    flex-direction: column; 
                    gap: 10px;
                ">
                    <button id="btnBayarStruk" class="btn btn-success" style="
                        width: 100%; 
                        padding: 12px; 
                        border-radius: 5px; 
                        font-weight: bold; 
                        font-size: 14px; 
                        cursor: pointer; 
                        border: none; 
                        background-color: #27ae60;
                    ">
                        <i class="fas fa-money-bill-wave"></i> BAYAR
                    </button>
                    
                    <button id="btnKirimWA" class="btn" style="
                        width: 100%; 
                        background: #bdc3c7; 
                        color: #7f8c8d; 
                        padding: 12px; 
                        border-radius: 5px; 
                        font-weight: bold; 
                        font-size: 14px; 
                        cursor: not-allowed; 
                        border: none; 
                        opacity: 0.6;
                    " disabled>
                        <i class="fab fa-whatsapp"></i> KIRIM NOTA
                    </button>
                    
                    <button id="btnBatalStruk" class="btn" style="
                        width: 100%; 
                        background: #fff; 
                        color: #e74c3c; 
                        border: 1px solid #e74c3c; 
                        padding: 10px; 
                        border-radius: 5px; 
                        font-weight: bold; 
                        font-size: 13px; 
                        cursor: pointer;
                    ">
                        BATAL
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(strukOverlay);

        // Event Tombol Batal
        const btnBatal = document.getElementById('btnBatalStruk');
        if(btnBatal) {
            btnBatal.onclick = function() {
                document.getElementById('strukOverlay').remove();
            };
        }

        // Event Tombol Bayar
        const btnBayar = document.getElementById('btnBayarStruk');
        if(btnBayar) {
            btnBayar.onclick = function() {
                tampilkanPopUpKonfirmasi(tagihanId, pelangganId, namaPelanggan, nominal, bulan);
            };
        }

    } catch (error) {
        console.error("Error buka nota:", error);
        showToast('error', 'Error', 'Gagal membuka nota');
    }
}



// ============================================
// FUNGSI CEK ID PERUSAHAAN
// ============================================

function cekIDPerusahaan() {
    console.log("🔍 Mencari ID Dokumen Perusahaan di folder 'settings'...");
    
    db.collection('settings').get().then((snapshot) => {
        if (snapshot.empty) {
            console.log("❌ KOSONG: Folder 'settings' tidak ada datanya sama sekali.");
        } else {
            console.log(`✅ DITEMUKAN: Ada ${snapshot.size} dokumen di folder 'settings'.`);
            console.log("📋 DAFTAR ID DOKUMEN:");
            
            let index = 1;
            snapshot.forEach((doc) => {
                const data = doc.data();
                const idDoc = doc.id;
                
                console.log(`${index}. ID: [ ${idDoc} ]`);
                console.log(`   Isi Data:`, data);
                console.log(`   ---------------------------------`);
                
                index++;
            });
            
            console.log("👆 LIHAT DAFTAR DI ATAS.");
            console.log("👆 CARA DOKUMEN YANG ISINYA ADA 'NAMA' / 'ALAMAT', AMBIL ID-NYA.");
        }
    }).catch((error) => {
        console.error("❌ Error:", error);
    });
}

// ============================================
// FUNGSI KIRIM ULANG STRUK (JIKA SUDAH LUNAS)
// ============================================

async function kirimUlangStruk(tagihanId, namaPelanggan, nominal, bulan) {
    console.log("📤 Kirim Ulang Struk...");
    
    // Ambil data tanggal bayar terbaru untuk ditampilkan di struk
    let tglBayarStr = moment().format('DD-MM-YYYY');
    
    try {
        showLoading();
        
        // GENERATE GAMBAR STRUK (Sama logic dengan bayar, tapi tidak update DB)
        const strukContainer = document.createElement('div');
        strukContainer.style.width = '300px';
        strukContainer.style.padding = '15px';
        strukContainer.style.background = '#ffffff';
        strukContainer.style.fontFamily = 'monospace';
        strukContainer.style.fontSize = '14px';
        strukContainer.style.color = '#000000';
        strukContainer.style.border = '1px solid #000';
        strukContainer.style.position = 'absolute';
        strukContainer.style.left = '-9999px'; 
        
        strukContainer.innerHTML = `
            <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px;">
                <h2 style="margin: 0; font-size: 18px; font-weight: bold;">X-BILL ISP</h2>
                <p style="margin: 0; font-size: 10px;">Jl. Internet Cepat No. 1</p>
            </div>
            
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Pelanggan:</span>
                    <strong>${namaPelanggan}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Tanggal:</span>
                    <span>${tglBayarStr}</span>
                </div>
            </div>

            <div style="border-top: 1px solid #000; border-bottom: 1px solid #000; padding: 10px 0; margin: 10px 0; text-align: center;">
                <strong>BUKTI PEMBAYARAN</strong>
            </div>

            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Periode:</span>
                    <span>${bulan}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 16px; font-weight: bold;">
                    <span>Total:</span>
                    <span>${formatRupiah(nominal)}</span>
                </div>
            </div>

            <div style="text-align: center; margin-top: 15px; font-weight: bold;">
                STATUS: LUNAS
            </div>

            <div style="text-align: center; margin-top: 15px; border-top: 1px solid #000; padding-top: 10px; font-size: 11px;">
                Terima Kasih<br>
                Simpan struk ini sebagai bukti pembayaran yang sah.
            </div>
        `;
        
        document.body.appendChild(strukContainer);
        await new Promise(r => setTimeout(r, 300));

        // NOTE: Untuk sharing gambar ke WA via browser, biasanya butuh API backend tambahan
        // Di sini kita simulasi dengan membuka WA text biasa saja karena keterbatasan client-side only
        const noWA = "62" + (await getNomorTeleponPelanggan(tagihanId)).replace(/^0/, '');
        const pesanWA = `*BUKTI PELUNASAN TAGIHAN*\n\nHalo Kak ${namaPelanggan},\n\nBerikut adalah bukti pelunasan tagihan bulan ${bulan} sebesar ${formatRupiah(nominal)}.\n\nStatus: LUNAS\nTanggal: ${tglBayarStr}\n\nTerima kasih.`;
        const urlWA = `https://wa.me/${noWA}?text=${encodeURIComponent(pesanWA)}`;
        
        window.open(urlWA, '_blank');
        
        hideLoading();
        
    } catch (error) {
        hideLoading();
        console.error("Error:", error);
        showToast('error', 'Gagal', error.message);
    }
}

// Helper untuk ambil nomor telepon jika perlu
async function getNomorTeleponPelanggan(tagihanId) {
    try {
        const doc = await db.collection('tagihan').doc(tagihanId).get();
        if(doc.exists && doc.data().pelanggan_telepon) {
            return doc.data().pelanggan_telepon;
        }
        return "-";
    } catch(e) {
        return "-";
    }
}

// Helper: Fungsi Bayar Semua (Opsional, sesuaikan logicnya)
function showPayAllModal(pelangganId) {
    showToast('info', 'Fitur', 'Fitur bayar semua segera hadir');
    // Logic: Loop tagihan user tersebut dan panggil fungsi bayarTagihan() untuk masing-masing ID
}

// FUNGSI BARU: Apply filter di client side
function applyTagihanFilters() {
    const bulanFilter = document.getElementById('filterBulan')?.value || '';
    const statusFilter = document.getElementById('filterStatusTagihan')?.value || '';
    const searchFilter = document.getElementById('searchTagihan')?.value || '';
    
    console.log("Filter:", { bulanFilter, statusFilter, searchFilter });
    
    // Clone data asli
    let filteredData = [...tagihanData];
    
    // Filter bulan
    if (bulanFilter) {
        filteredData = filteredData.filter(t => t.bulan === bulanFilter);
    }
    
    // Filter status
    if (statusFilter) {
        filteredData = filteredData.filter(t => t.status === statusFilter);
    }
    
    // Filter search
    if (searchFilter) {
        const searchLower = searchFilter.toLowerCase();
        filteredData = filteredData.filter(t => 
            (t.pelanggan_nama && t.pelanggan_nama.toLowerCase().includes(searchLower)) ||
            (t.id && t.id.toLowerCase().includes(searchLower)) ||
            (t.bulan && t.bulan.includes(searchFilter))
        );
    }
    
    // Update global variable
    tagihanData = filteredData;
    
    // Render tabel
    renderTagihanTable();
}
        
        function renderTagihanTable() {
    const table = document.getElementById('tagihanTable');
    if (!table) return;
    
    if (tagihanData.length === 0) {
        table.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tidak ada data tagihan</td></tr>`;
        return;
    }
    
    table.innerHTML = tagihanData.map((tagihan, index) => {
        // Format Data Aman
        const id = tagihan.id || `TAGIHAN_${index}`;
        const nama = (tagihan.pelanggan_nama || 'Pelanggan').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const nominal = tagihan.jumlah || 0;
        const bulan = tagihan.bulan || '-';
        
        // Logic Status
        const isLunas = tagihan.status === 'lunas';
        let tombolBayar = '';

        // --- PERBAIKAN DISINI ---
        // Kita simpan SEMUA data yang dibutuhkan di dalam atribut 'data-' pada tombol
        // Kemudian kita gunakan fungsi pembantu 'handleBayarClick' yang lebih aman
        if (!isLunas) {
            tombolBayar = `
                <button class="btn btn-sm btn-success" 
                    data-id="${id}"
                    data-pid="${tagihan.pelanggan_id || ''}"
                    data-nama="${nama}"
                    data-nominal="${nominal}"
                    data-bulan="${bulan}"
                    onclick="handleBayarClick(this)"
                    title="Bayar Sekarang">
                    <i class="fas fa-money-bill-wave"></i> Bayar
                </button>
            `;
        }

        return `
            <tr>
                <td>${id.substring(0, 10)}...</td>
                <td><strong>${nama}</strong></td>
                <td>${bulan}</td>
                <td>${formatRupiah(nominal)}</td>
                <td>
                    <span class="badge ${isLunas ? 'badge-success' : 'badge-warning'}">
                        ${isLunas ? 'Lunas' : 'Belum'}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        ${tombolBayar}
                        <button class="btn btn-sm btn-info" onclick="viewInvoice('${id}')"><i class="fas fa-eye"></i></button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}


// ============================================
// FUNGSI SHOW PAYMENT CONFIRMATION (POP UP)
// ============================================

function showPaymentConfirmation(tagihanId, pelangganId, namaPelanggan, nominal, bulan) {
    console.log("⚠️ MENAMPILKAN POP UP KONFIRMASI...");

    // MODAL KONFIRMASI
    const modalConfirm = document.createElement('div');
    modalConfirm.style.position = 'fixed';
    modalConfirm.style.top = '0';
    modalConfirm.style.left = '0';
    modalConfirm.style.width = '100%';
    modalConfirm.style.height = '100%';
    modalConfirm.style.background = 'rgba(0, 0, 0, 0.7)';
    modalConfirm.style.zIndex = '1000000'; 
    modalConfirm.style.display = 'flex';
    modalConfirm.style.alignItems = 'center';
    modalConfirm.style.justifyContent = 'center';
    
    modalConfirm.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.4); animation: modalPop 0.3s ease;">
            <div style="width: 70px; height: 70px; background: #e74c3c; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 30px;">
                <i class="fas fa-question"></i>
            </div>
            <h3 style="color: #2c3e50; margin: 0 0 10px 0;">Konfirmasi Pembayaran</h3>
            <p style="color: #7f8c8d; margin: 0 0 20px 0;">Anda akan memproses pembayaran untuk:</p>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <small>Pelanggan:</small> <strong>${namaPelanggan}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <small>Periode:</small> <strong>${bulan}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; border-top: 1px solid #ddd; padding-top: 10px;">
                    <small style="font-weight: bold;">Total:</small> <strong style="color: #e74c3c; font-size: 18px;">${formatRupiah(nominal)}</strong>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button id="btnConfirmCancel" style="flex: 1; padding: 12px; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; color: #555;">Batal</button>
                <button id="btnConfirmOK" style="flex: 1; padding: 12px; border: none; background: #27ae60; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Lanjut Bayar</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modalConfirm);

    // HANDLE BUTTONS DI MODAL KONFIRMASI
    document.getElementById('btnConfirmCancel').onclick = () => modalConfirm.remove();
    
    document.getElementById('btnConfirmOK').onclick = () => {
        modalConfirm.remove();
        // JIKA OK -> BARU MUNCULKAN NOTA (PREVIEW)
        bayarTagihanDenganStruk(tagihanId, pelangganId, namaPelanggan, nominal, bulan);
    };
}



// ============================================
// FUNGSI PEMBANTU CLICK TOMBOL BAYAR
// ============================================

function handleBayarClick(btnElement) {

    
    const id = btnElement.getAttribute('data-id');
    const pid = btnElement.getAttribute('data-pid');
    const nama = btnElement.getAttribute('data-nama'); 
    const nominal = parseInt(btnElement.getAttribute('data-nominal')) || 0;
    const bulan = btnElement.getAttribute('data-bulan');

    if (!id || !pid || !nominal) return showToast('error', 'Error', 'Data tidak lengkap');

    bukaNotaDanKonfirmasi(id, pid, nama, nominal, bulan);

    
}



async function loadTagihanData() {
    const table = document.getElementById('tagihanTable');
    if (!table) return;
    
    table.innerHTML = `<tr><td colspan="6" class="text-center"><div class="spinner" style="width:30px;height:30px;margin:0 auto;"></div></td></tr>`;

    try {
        // ⭐⭐ PERBAIKAN 1: FILTER PELANGGAN BERDASARKAN COMPANY_ID ⭐⭐
        const pelangganSnapshot = await db.collection('pelanggan')
            .where('company_id', '==', globalCompanyId)  // ⭐ TAMBAH FILTER INI
            .get();
        
        const pelangganIds = [];
        const pelangganMap = {};
        
        pelangganSnapshot.forEach(doc => {
            // ⭐⭐ PERBAIKAN 2: VALIDASI DATA PELANGGAN MILIK COMPANY INI ⭐⭐
            const p = doc.data();
            if (p.company_id !== globalCompanyId) {
                console.warn(`⚠️ Pelanggan ${doc.id} bukan milik company ini:`, p.company_id);
                return; // Skip jika bukan milik company ini
            }
            
            pelangganIds.push(doc.id);
            pelangganMap[doc.id] = {
                alamat: p.alamat || '-',
                nama: p.nama || '-',
                telepon: p.telepon || '-',
                company_id: p.company_id || globalCompanyId // Simpan company_id untuk validasi
            };
        });

        if (pelangganIds.length === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center" style="padding: 40px;">
                        <i class="fas fa-inbox" style="font-size: 48px; color: #e9ecef;"></i>
                        <h4 style="margin-top:15px; color: var(--gray);">Tidak Ada Pelanggan</h4>
                        <p>Belum ada data pelanggan untuk perusahaan Anda.</p>
                        <button class="btn btn-primary mt-2" onclick="showAddPelangganModal()">
                            <i class="fas fa-plus"></i> Tambah Pelanggan Pertama
                        </button>
                    </td>
                </tr>`;
            return;
        }

        console.log(`👥 ${pelangganIds.length} pelanggan valid untuk company: ${globalCompanyId}`);

        // 2. AMBIL HANYA TAGIHAN YANG PELANGGANNYA MASIH ADA
        let tagihanData = [];
        
        if (pelangganIds.length <= 10) {
            // JIKA PELANGGAN <= 10, AMBIL SEKALIGUS DENGAN FILTER COMPANY
            const tagihanSnapshot = await db.collection('tagihan')
                .where('pelanggan_id', 'in', pelangganIds)
                .where('company_id', '==', globalCompanyId)  // ⭐ TAMBAH FILTER INI
                .get();
            
            tagihanSnapshot.forEach(doc => {
                const data = doc.data();
                // ⭐⭐ VALIDASI TAMBAHAN: PASTIKAN TAGIHAN MILIK COMPANY INI ⭐⭐
                if (data.company_id === globalCompanyId) {
                    tagihanData.push({ id: doc.id, data: data });
                } else {
                    console.warn(`⚠️ Tagihan ${doc.id} bukan milik company ini:`, data.company_id);
                }
            });
        } else {
            // JIKA PELANGGAN > 10, AMBIL PER BATCH (FIREBASE LIMIT 10)
            for (let i = 0; i < pelangganIds.length; i += 10) {
                const batchIds = pelangganIds.slice(i, i + 10);
                const batchSnapshot = await db.collection('tagihan')
                    .where('pelanggan_id', 'in', batchIds)
                    .where('company_id', '==', globalCompanyId)  // ⭐ TAMBAH FILTER INI
                    .get();
                
                batchSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.company_id === globalCompanyId) {
                        tagihanData.push({ id: doc.id, data: data });
                    }
                });
            }
        }

        if (tagihanData.length === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center" style="padding: 40px;">
                        <i class="fas fa-receipt" style="font-size: 48px; color: #e9ecef;"></i>
                        <h4 style="margin-top:15px; color: var(--gray);">Belum Ada Tagihan</h4>
                        <p>Belum ada data tagihan untuk pelanggan Anda.</p>
                        <button class="btn btn-primary mt-2" onclick="openGenerateModal()">
                            <i class="fas fa-bolt"></i> Generate Tagihan Pertama
                        </button>
                    </td>
                </tr>`;
            return;
        }

        console.log(`💰 ${tagihanData.length} tagihan valid untuk company: ${globalCompanyId}`);

        // 3. GROUP BY PELANGGAN (DENGAN VALIDASI EKSTRA)
        const groupedMap = {};
        
        tagihanData.forEach(item => {
            const t = item.data;
            const pid = t.pelanggan_id;
            
            // ⭐⭐ VALIDASI: PASTIKAN PELANGGAN ADA DI MAP KITA ⭐⭐
            if (!pelangganMap[pid]) {
                console.warn(`⚠️ Tagihan ${item.id} milik pelanggan ${pid} yang tidak ada di pelangganMap`);
                return; // Skip jika pelanggan tidak valid
            }
            
            if (!groupedMap[pid]) {
                groupedMap[pid] = {
                    pelanggan_id: pid,
                    pelanggan_nama: pelangganMap[pid].nama, 
                    pelanggan_telepon: pelangganMap[pid].telepon,
                    pelanggan_alamat: pelangganMap[pid].alamat,
                    list_tagihan: [], 
                    total_nominal: 0,
                    company_id: pelangganMap[pid].company_id  // Simpan company_id
                };
            }
            
            // ⭐⭐ VALIDASI: PASTIKAN TAGIHAN MILIK COMPANY YANG SAMA ⭐⭐
            if (t.company_id !== globalCompanyId) {
                console.warn(`⚠️ Tagihan ${item.id} company_id tidak match:`, t.company_id);
                return;
            }
            
            groupedMap[pid].list_tagihan.push(t);
            if (t.status !== 'lunas') {
                groupedMap[pid].total_nominal += Number(t.jumlah) || 0;
            }
        });

        const groupedData = Object.values(groupedMap);

        // SORTING: BELUM LUNAS DI ATAS, LUNAS DI BAWAH
groupedData.sort((a, b) => {
    const aBelumLunas = a.list_tagihan.filter(t => t.status !== 'lunas').length;
    const bBelumLunas = b.list_tagihan.filter(t => t.status !== 'lunas').length;
    
    // 1. Urutkan berdasarkan jumlah tagihan belum lunas (descending)
    if (bBelumLunas !== aBelumLunas) {
        return bBelumLunas - aBelumLunas;
    }
    
    // 2. Urutkan berdasarkan nama pelanggan
    return a.pelanggan_nama.localeCompare(b.pelanggan_nama);
});
        
        // LOG DEBUGGING
        console.log(`📊 ${groupedData.length} grup tagihan setelah validasi`);
        if (groupedData.length > 0) {
            console.log("Contoh data grup pertama:", groupedData[0]);
        }

        // 4. PAGINATION
        const itemsPerPage = 10;
        const totalData = groupedData.length; 
        const totalPages = Math.ceil(totalData / itemsPerPage);
        
        if (currentPageTagihan > totalPages) currentPageTagihan = 1;
        const startIndex = (currentPageTagihan - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = groupedData.slice(startIndex, endIndex);

        // 5. RENDER TABEL
        table.innerHTML = pageData.map((item) => {
            const listBelumLunas = item.list_tagihan.filter(t => t.status !== 'lunas');
            const jumlahBulanBelumLunas = listBelumLunas.length;
            
            const isAllLunas = jumlahBulanBelumLunas === 0;
            
            let displayBulan = `<strong>${jumlahBulanBelumLunas} Bulan</strong>`;
            let displayNominal = `<strong>${formatRupiah(item.total_nominal)}</strong>`;

            if (isAllLunas) {
                displayBulan = `<span style="color: var(--gray);">-</span>`;
                displayNominal = `<div style="color: var(--success); font-weight: bold;"><i class="fas fa-check-circle"></i> LUNAS</div>`;
            }

            let tombolBayar = '';
            if (!isAllLunas) {
                const tagihanPertama = listBelumLunas[0]; 
                const idTagihan = tagihanPertama.id;
                
                tombolBayar = `
                    <button class="btn btn-sm btn-success" 
                        data-id="${idTagihan}"
                        data-pid="${item.pelanggan_id}"
                        data-nama="${item.pelanggan_nama}"
                        data-nominal="${tagihanPertama.jumlah}"
                        data-bulan="${tagihanPertama.bulan}"
                        onclick="handleBayarClick(this)"
                        title="Bayar Tagihan">
                        <i class="fas fa-money-bill-wave"></i> Bayar
                    </button>
                `;
            }

            return `
                <tr>
                    <td>
                        <strong>${item.pelanggan_nama}</strong><br>
                        <small class="text-muted">${item.pelanggan_telepon}</small>
                        ${item.company_id !== globalCompanyId ? '<br><small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Data tidak valid</small>' : ''}
                    </td>
                    <td>
                        <small style="color: #666;">${item.pelanggan_alamat}</small>
                    </td>
                    <td>
                        <span class="badge badge-primary" style="font-size:14px; padding:8px 12px;">
                            ${displayBulan}
                        </span>
                    </td>
                    <td>${displayNominal}</td>
                    <td>
                        ${isAllLunas 
                            ? '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Lunas</span>' 
                            : '<span class="badge badge-warning"><i class="fas fa-clock"></i> Belum</span>'}
                    </td>
                    <td>
                        <div class="btn-group">
                            ${tombolBayar}
                            <button class="btn btn-sm btn-info" onclick="viewTagihanDetails('${item.pelanggan_id}')" title="Detail">
                                <i class="fas fa-list"></i> Detail
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        // 6. RENDER PAGINATION
        renderPagination(totalData, currentPageTagihan, 'tagihan', 'tagihanPagination');
        
    } catch (error) {
        console.error("❌ Error load tagihan:", error);
        table.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${error.message}</td></tr>`;
    }
}




// FUNGSI applyTagihanFilters YANG HARUS ADA
function applyTagihanFilters(data) {
    if (!data || !Array.isArray(data)) {
        console.error("❌ applyTagihanFilters: data bukan array");
        return [];
    }
    
    const bulanFilter = document.getElementById('filterBulan')?.value || '';
    const statusFilter = document.getElementById('filterStatusTagihan')?.value || '';
    const searchFilter = document.getElementById('searchTagihan')?.value || '';
    
    return data.filter(tagihan => {
        // Filter bulan
        if (bulanFilter && tagihan.bulan !== bulanFilter) return false;
        
        // Filter status
        if (statusFilter && tagihan.status !== statusFilter) return false;
        
        // Filter search
        if (searchFilter) {
            const searchLower = searchFilter.toLowerCase();
            return (
                (tagihan.pelanggan_nama && tagihan.pelanggan_nama.toLowerCase().includes(searchLower)) ||
                (tagihan.id && tagihan.id.toLowerCase().includes(searchLower)) ||
                (tagihan.bulan && tagihan.bulan.includes(searchFilter))
            );
        }
        
        return true;
    });
}


// ============================================
// FUNGSI PENCARIAN TAGIHAN (SEARCH)
// ============================================

function filterTagihanSearch(keyword) {
    const table = document.getElementById('tagihanTable');
    const rows = table.getElementsByTagName('tr');
    
    const filterLower = keyword.toLowerCase();
    
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        
        // Cari di Nama (td 0) atau Alamat (td 1)
        const textNama = cells[0].textContent || "";
        const textAlamat = cells[1].textContent || "";
        
        if (textNama.toLowerCase().indexOf(filterLower) > -1 || 
            textAlamat.toLowerCase().indexOf(filterLower) > -1) {
            row.style.display = ""; 
        } else {
            row.style.display = "none"; 
        }
    }
}
        
 
async function executePayAllAndPrint(pelangganId, idsString, totalNominal, bulanString) {
    console.log("💳 PROSES BAYAR & GENERATE GAMBAR STRUK...");

    if (!confirm(`Konfirmasi pembayaran lunas sebesar ${formatRupiah(totalNominal)}?\n\nStruk Gambar akan dibuat & dikirim ke WhatsApp.`)) {
        return;
    }

    try {
        showLoading();

        // 1. UPDATE DATABASE
        const tagihanIds = String(idsString).split(',');
        const batch = db.batch();
        const now = new Date().toISOString();
        const tglHariIni = moment().format('DD-MM-YYYY HH:mm');

        let namaPelanggan = "Pelanggan";
        let teleponPelanggan = "";
        const docRef = await db.collection('pelanggan').doc(pelangganId).get();
        if (docRef.exists) {
            const data = docRef.data();
            namaPelanggan = data.nama;
            teleponPelanggan = data.telepon;
        }

        tagihanIds.forEach(id => {
            const ref = db.collection('tagihan').doc(id);
            batch.update(ref, {
                status: 'lunas',
                tanggal_bayar: tglHariIni,
                metode_bayar: 'Tunai (Bulk)',
                updated_at: now
            });
        });

        await batch.commit();

        // 2. GENERATE HTML STRUK (HIDDEN)
        // Kita buat elemen HTML sementara yang berisi tampilan struk
        const strukContainer = document.createElement('div');
        strukContainer.style.position = 'absolute';
        strukContainer.style.left = '-9999px';
        strukContainer.style.top = '0';
        strukContainer.style.width = '300px'; // Lebar standar kertas 58mm/80mm
        strukContainer.style.background = 'white';
        strukContainer.style.padding = '10px';
        strukContainer.style.fontFamily = 'monospace';
        strukContainer.style.fontSize = '12px';
        
        // Isi HTML Struk
        strukContainer.innerHTML = `
            <div style="text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px;">
                <h3 style="margin: 0; font-size: 16px;">X-BILL ISP</h3>
                <p style="margin: 0; font-size: 10px;">Jl. Internet Cepat No. 1</p>
            </div>
            
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Pelanggan:</span>
                    <strong>${namaPelanggan}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Tanggal:</span>
                    <span>${tglHariIni}</span>
                </div>
            </div>

            <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 10px 0; margin: 10px 0; text-align: center;">
                <strong>BUKTI PEMBAYARAN</strong>
            </div>

            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Item:</span>
                    <span>Pelunasan Tagihan</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Bulan:</span>
                    <span>${bulanString}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <span>Total:</span>
                    <strong>${formatRupiah(totalNominal)}</strong>
                </div>
            </div>

            <div style="text-align: center; margin-top: 15px; font-weight: bold;">
                STATUS: LUNAS
            </div>

            <div style="text-align: center; margin-top: 20px; border-top: 1px solid #000; padding-top: 10px; font-size: 10px;">
                Terima Kasih<br>
                Simpan struk ini sebagai bukti pembayaran yang sah.
            </div>
        `;
        
        document.body.appendChild(strukContainer);

        // 3. CONVERT HTML JADI GAMBAR (CANVAS) MENGGUNAKAN HTML2CANVAS
        // Tunggu sebentar agar DOM siap
        await new Promise(r => setTimeout(r, 500));

        const canvas = await html2canvas(strukContainer, {
            scale: 2, // Skala 2x biar gambarnya tajam tidak pecah
            useCORS: true,
            backgroundColor: "#ffffff"
        });

        // Convert Canvas ke BLOB (PNG)
        canvas.toBlob(async function(blob) {
            // Hapus elemen HTML sementara
            document.body.removeChild(strukContainer);

            // 4. KIRIM KE WHATSAPP
            // WA tidak bisa kirim file langsung dari Web JS, jadi kita pakai trik upload ke imgbb/gambar
            // TAPI untuk simplifikasi, kita pakai API hosting gambar gratis & langsung buka WA
            
            // CONTOH: Upload ke imagekit.io atau hosting lain yang support base64/blob
            // Karena keterbatasan API Key, kita akan coba trik "Data URI" di browser modern
            // Namun, cara PALING AMPUH untuk Web App tanpa backend:
            // Kita convert ke File, lalu user buka WA manual ATAU pakai API hosting.
            
            // SOLUSI PALING STABIL: Kita buka file gambar di tab baru, user tinggal "Share" ke WA.
            const imgUrl = URL.createObjectURL(blob);
            
            // BUKA GAMBAR DI TAB BARU
            const imageWindow = window.open(imgUrl, '_blank');
            
            // Tampilkan instruksi
            setTimeout(() => {
                 if(imageWindow) {
                     imageWindow.document.write('<p style="text-align:center; padding:20px;">Klik tombol Share / Bagikan di browser ini, lalu pilih <b>WhatsApp</b>.</p><img src="'+imgUrl+'" style="width:100%; max-width:300px; display:block; margin:0 auto;">');
                 }
            }, 500);

            hideLoading();
            forceCloseModal('modalDetailTagihan');
            showToast('info', 'Gambar Siap', 'Struk Gambar dibuat. Silakan Share gambar tersebut ke WA.');

            // Refresh Data
            if (currentPage === 'tagihan') await loadTagihanData();
            if (currentPage === 'dashboard') await renderDashboard();

        }, 'image/png');

    } catch (error) {
        hideLoading();
        console.error("Error Generate Gambar:", error);
        showToast('error', 'Gagal', 'Gagal membuat gambar struk: ' + error.message);
    }
}


// FUNGSI INJECT NAMA PERUSAHAAN KE STRUK
function syncCompanyNameToStruk() {
    const nameInput = document.getElementById('companyName');
    const displayTarget = document.getElementById('displayStrukCompanyName');

    if (nameInput && displayTarget) {
        // Cek apakah ada isinya
        if (nameInput.value && nameInput.value.trim() !== "") {
            displayTarget.textContent = nameInput.value;
            console.log("✅ Nama Perusahaan Struk diupdate: " + nameInput.value);
        } else {
            // Kalau kosong, balikin ke default
            displayTarget.textContent = "X-BILL ISP";
        }
    }
}



// ============================================
// FUNGSI INISIALISASI DATABASE OTOMATIS
// ============================================

async function initializeDatabase() {
    console.log("🚀 Memulai inisialisasi database...");
    
    try {
        // 1. CEK APAKAH DATABASE SUDAH ADA
        console.log("📊 Mengecek struktur database...");
        
        // Cek apakah ada data di collections
        const [pelangganSnapshot, paketSnapshot, tagihanSnapshot] = await Promise.all([
            db.collection('pelanggan').limit(1).get(),
            db.collection('paket').limit(1).get(),
            db.collection('tagihan').limit(1).get()
        ]);
        
        const hasData = !pelangganSnapshot.empty || !paketSnapshot.empty || !tagihanSnapshot.empty;
        
        if (hasData) {
            console.log("✅ Database sudah ada, tidak perlu inisialisasi");
            return;
        }
        
        console.log("📝 Database kosong, membuat data awal...");
        
        // 2. BUAT COLLECTION PAKET TERLEBIH DAHULU
        console.log("📦 Membuat data paket internet...");
        await createInitialPackages();
        
        // 3. BUAT COLLECTION PELANGGAN
        console.log("👥 Membuat data pelanggan contoh...");
        await createInitialCustomers();
        
        // 4. BUAT COLLECTION TAGIHAN
        console.log("💰 Membuat data tagihan contoh...");
        await createInitialInvoices();
        
        // 5. BUAT COLLECTION AKTIVITAS
        console.log("📋 Membuat log aktivitas...");
        await createInitialActivities();
        
        // 6. BUAT INDEX OTOMATIS (jika perlu)
        console.log("🔧 Mengecek index...");
        await checkAndCreateIndexes();
        
        
    } catch (error) {
        console.error("❌ Error inisialisasi database:", error);
        showToast('error', 'Error', 'Gagal menginisialisasi database: ' + error.message);
    }
}

// FUNGSI UNTUK MEMBUAT PAKET INTERNET AWAL
async function createInitialPackages() {
    const packages = [];
    
    const batch = db.batch();
    
    packages.forEach(pkg => {
        const paketRef = db.collection('paket').doc(pkg.id);
        batch.set(paketRef, pkg);
    });

     if (packages.length > 0) {
        await batch.commit();
        console.log(`✅ ${packages.length} paket berhasil dibuat`);
    } else {
        console.log("⚠️ Tidak ada data paket dummy untuk dibuat.");
    }
    
    await batch.commit();
    console.log(`✅ ${packages.length} paket berhasil dibuat`);
}

// FUNGSI UNTUK MEMBUAT PELANGGAN AWAL
async function createInitialCustomers() {
    const customers = [];
    
    const batch = db.batch();
    
    customers.forEach(customer => {
        const custRef = db.collection('pelanggan').doc(customer.id);
        batch.set(custRef, customer);
    });

    if (customers.length > 0) {
        await batch.commit();
        console.log(`✅ ${customers.length} pelanggan berhasil dibuat`);
    } else {
        console.log("⚠️ Tidak ada data pelanggan dummy untuk dibuat.");
    }
    
    await batch.commit();
    console.log(`✅ ${customers.length} pelanggan berhasil dibuat`);
}

// FUNGSI UNTUK MEMBUAT TAGIHAN AWAL
async function createInitialInvoices() {
    const invoices = [];
    
    const batch = db.batch();
    
    invoices.forEach(invoice => {
        const invoiceRef = db.collection('tagihan').doc(invoice.id);
        batch.set(invoiceRef, invoice);
    });

     if (invoices.length > 0) {
        await batch.commit();
        console.log(`✅ ${invoices.length} tagihan berhasil dibuat`);
    } else {
        console.log("⚠️ Tidak ada data tagihan dummy untuk dibuat.");
    }
    
    await batch.commit();
    console.log(`✅ ${invoices.length} tagihan berhasil dibuat`);
}

// FUNGSI UNTUK MEMBUAT AKTIVITAS AWAL
async function createInitialActivities() {
    const activities = [];
    
    const batch = db.batch();
    
    activities.forEach((activity, index) => {
        const activityRef = db.collection('aktivitas').doc(`ACT_${Date.now()}_${index}`);
        batch.set(activityRef, activity);
    });

    if (activities.length > 0) {
        await batch.commit();
        console.log(`✅ ${activities.length} aktivitas berhasil dibuat`);
    } else {
        console.log("⚠️ Tidak ada data aktivitas dummy untuk dibuat.");
    }
    
    await batch.commit();
    console.log(`✅ ${activities.length} aktivitas berhasil dibuat`);
}

// FUNGSI UNTUK CEK DAN BUAT INDEX
async function checkAndCreateIndexes() {
    try {
        console.log("🔍 Mengecek index Firestore...");
        
        // Tidak ada fungsi langsung untuk buat index via JavaScript
        // User harus buat manual di Firebase Console
        console.log("ℹ️ Untuk performa optimal, buat index di Firebase Console:");
        console.log("1. Buka https://console.firebase.google.com/");
        console.log("2. Pilih project Anda");
        console.log("3. Pilih Firestore Database > Indexes");
        console.log("4. Buat index untuk query yang sering digunakan");
        
    } catch (error) {
        console.error("❌ Error cek index:", error);
    }
}


// ==========================================
// PERBAIKAN DARURAT: SIMPAN COMPANY ID SAAT LOGIN
// ==========================================

// Fungsi ini akan dipanggil otomatis setelah login berhasil
async function saveUserSessionAndInit() {
    if (!currentUser) {
        console.warn("Tidak ada user untuk disimpan.");
        return;
    }

    // 1. Siapkan data lengkap user
    let finalCompanyId = globalCompanyId; // Cek apakah sudah ada global
    
    // 2. Jika global kosong, coba ambil dari localStorage
    if (!finalCompanyId) {
        const storedUser = localStorage.getItem('xbill_user');
        if (storedUser) {
            try {
                const parsedUser = JSON.parse(storedUser);
                if (parsedUser.company_id) {
                    finalCompanyId = parsedUser.company_id;
                }
            } catch (e) {}
        }
    }

    // 3. Jika masih kosong, beri ID Default (COMP_DEFAULT)
    if (!finalCompanyId) {
        finalCompanyId = "COMP_DEFAULT";
        console.warn("⚠️ Company ID masih kosong, pakai Default.");
    }

    // 4. Simpan ke GLOBAL & LOCALSTORAGE (Agar sinkron)
    globalCompanyId = finalCompanyId;
    
    // Update user object di memori
    currentUser.company_id = finalCompanyId;

    // Update localStorage user object
    const userStorageData = JSON.parse(localStorage.getItem('xbill_user') || '{}');
    userStorageData.company_id = finalCompanyId;
    localStorage.setItem('xbill_user', JSON.stringify(userStorageData));

    console.log("💾 Company ID FINAL:", globalCompanyId);
}

// ==========================================
// PANGGIL FUNGSI INI DI AKHIR SCRIPT LOGIN
// ==========================================
// Cari bagian login berhasil, dan tambahkan baris ini:
// saveUserSessionAndInit();

// ============================================
// ROUTING & PAGE MANAGEMENT
// ============================================

async function loadPage(page) {
    console.log("🔄 Loading Page:", page);
    
    // 1. AMBIL ROLE USER SAAT INI
    const currentRole = currentUser ? currentUser.role : 'admin'; 
    console.log("🔑 Current Role:", currentRole);

    // 2. CEK AKSES BERDASARKAN ROLE
    if (currentRole === 'staff_billing') {
        const allowedPages = ['dashboard', 'tagihan', 'tunggakan', 'setting'];
        
        if (!allowedPages.includes(page)) {
            console.warn("⛔ Akses Ditolak untuk Role:", currentRole, "Halaman:", page);
            showToast('error', 'Akses Ditolak', 'Anda tidak memiliki izin mengakses menu ini.');
            
            // Redirect otomatis ke halaman Tagihan
            page = 'tagihan';
        }
    }

    // 3. ATUR TAMPILAN MENU NAVIGASI (VISIBILITAS)
    if (currentRole === 'staff_billing') {
        document.querySelectorAll('.nav-item').forEach(nav => {
            const navPage = nav.getAttribute('data-page');
            
            // HANYA TAMPILKAN MENU YANG DIIJINKAN
            // Dashboard, Tagihan, Tunggakan, Setting
            if (['dashboard', 'tagihan', 'tunggakan', 'setting'].includes(navPage)) {
                nav.style.display = 'flex';
                
                // KHUSUS MENU SETTING: Kita ubah teks/icon sedikit biar beda atau biarkan default
                if (navPage === 'setting') {
                    // Opsional: Ubah icon setting jadi icon gembok (keamanan)
                    // const icon = nav.querySelector('i');
                    // if(icon) icon.className = 'fas fa-shield-alt';
                }
            } else {
                // SEMBUNYIKAN MENU LAINNYA (Pelanggan, Paket, Laporan, dll)
                nav.style.display = 'none';
            }
        });
    } else {
        // Jika Admin, pastikan semua menu tampil normal
        document.querySelectorAll('.nav-item').forEach(nav => {
            nav.style.display = 'flex';
        });
    }

    // Update active nav
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-page') === page) {
            item.classList.add('active');
        }
    });
    
    const mainContent = document.getElementById('mainContent');
    if (!mainContent) {
        console.error("❌ Error: #mainContent tidak ditemukan");
        return;
    }
    
    let pageHTML = '';
    
    try {
        switch(page) {
            case 'dashboard':
                pageHTML = await getDashboardHTML();
                mainContent.innerHTML = pageHTML;
                await renderDashboard();
                break;
                
            case 'pelanggan':
                // Jika Staff coba buka halaman ini (seharusnya sudah di-redirect di atas), cek lagi
                if (currentRole === 'staff_billing') {
                    showToast('error', 'Akses Ditolak', 'Menu ini hanya untuk Admin.');
                    loadPage('tagihan'); // Redirect paksa
                    return;
                }
                pageHTML = await getPelangganHTML();
                mainContent.innerHTML = pageHTML;
                await loadPaketData();
                await loadPelangganData();
                break;
                
            case 'paket':
                if (currentRole === 'staff_billing') {
                    showToast('error', 'Akses Ditolak', 'Menu ini hanya untuk Admin.');
                    loadPage('tagihan');
                    return;
                }
                pageHTML = await getPaketHTML();
                mainContent.innerHTML = pageHTML;
                await loadPaketData();
                break;
                
            case 'tagihan':
                pageHTML = await getTagihanHTML();
                mainContent.innerHTML = pageHTML;
                await loadTagihanData();
                break;
                
            case 'tunggakan':
                pageHTML = await getTunggakanHTML();
                mainContent.innerHTML = pageHTML;
                setTimeout(async () => {
                    await loadTunggakanData();
                }, 50); 
                break;
                
            case 'laporan':
    pageHTML = await getLaporanHTML();
    mainContent.innerHTML = pageHTML;
    
    // --- KODE RAHASIA: AUTO KLIK GENERATE LAPORAN ---
    setTimeout(() => {
        console.log("⚡ Auto-generate Laporan...");
        generateLaporan();
    }, 500); // Delay setengah detik biar loading UI selesai dulu
    break;
                
                        case 'setting':
                console.log("⚙️ Load Page: Setting");
                pageHTML = await getSettingHTML();
                mainContent.innerHTML = pageHTML;
                
                // ⭐⭐ FIX: PANGGIL FUNGSI ISI DATA ⭐⭐
                setTimeout(async () => {
                    await loadCompanyProfile(); // PANGGIL YANG BENAR
                    await loadBrandingSettings();
                }, 100);
                break;
                
            default:
                pageHTML = `<div class="page"><h3>Halaman tidak ditemukan</h3></div>`;
                mainContent.innerHTML = pageHTML;
        }
        
        console.log("✅ Page Render Selesai:", page);
        
    } catch (error) {
        console.error("❌ Error Fatal di loadPage:", error);
        const mainContent = document.getElementById('mainContent');
        if (mainContent) {
            mainContent.innerHTML = `
                <div class="page" style="padding: 50px; text-align: center;">
                    <h3 style="color:red">Terjadi Kesalahan</h3>
                    <p>${error.message}</p>
                    <button class="btn btn-primary" onclick="location.reload()">Refresh Halaman</button>
                </div>
            `;
        }
    }
}

// TAMBAHKAN TOMBOL RESET DATABASE DI HALAMAN IMPORT/EXPORT
// Modifikasi getImportExportHTML():
async function getImportExportHTML() {
    return `
        <div class="page import-export-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-file-import"></i> Import & Export Data</h2>
                <button class="btn btn-danger" onclick="resetDatabase()" title="Reset semua data ke kondisi awal">
                    <i class="fas fa-database"></i> Reset Database
                </button>
            </div>
            
            <!-- ... sisa kode tetap ... -->
            
            <div class="card mt-4">
                <div class="card-header">
                    <h3><i class="fas fa-database"></i> Tools Database</h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Perhatian!</strong> Tindakan ini akan menghapus semua data dan membuat ulang data contoh.
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="initializeDatabase()">
                            <i class="fas fa-play"></i> Inisialisasi Database
                        </button>
                        <button class="btn btn-danger" onclick="resetDatabase()">
                            <i class="fas fa-trash"></i> Reset & Buat Ulang
                        </button>
                        <button class="btn btn-info" onclick="checkDatabaseStatus()">
                            <i class="fas fa-chart-bar"></i> Status Database
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// FUNGSI RESET DATABASE
async function resetDatabase() {
    if (!confirm('⚠️ PERINGATAN!\n\nAnda akan menghapus SEMUA data dan membuat ulang data contoh.\n\nLanjutkan?')) {
        return;
    }
    
    try {
        showLoading();
        console.log("🔄 Memulai reset database...");
        
        // Hapus semua collections
        const collections = ['pelanggan', 'paket', 'tagihan', 'aktivitas'];
        
        for (const collectionName of collections) {
            console.log(`🗑️ Menghapus collection: ${collectionName}`);
            
            const snapshot = await db.collection(collectionName).get();
            const batch = db.batch();
            
            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            await batch.commit();
            console.log(`✅ ${snapshot.size} dokumen dihapus dari ${collectionName}`);
        }
        
        // Reset flag
        window.databaseInitialized = false;
        
        // Buat ulang data
        await initializeDatabase();
        
        hideLoading();
        showToast('success', 'Reset Berhasil', 'Database berhasil direset dan data contoh dibuat ulang');
        
        // Redirect ke dashboard
        loadPage('dashboard');
        
    } catch (error) {
        console.error("❌ Error reset database:", error);
        hideLoading();
        showToast('error', 'Error', 'Gagal reset database: ' + error.message);
    }
}

// FUNGSI CEK STATUS DATABASE
async function checkDatabaseStatus() {
    try {
        showLoading();
        
        const collections = ['pelanggan', 'paket', 'tagihan', 'aktivitas'];
        let result = '<h4>Status Database:</h4><ul>';
        
        for (const collectionName of collections) {
            const snapshot = await db.collection(collectionName).get();
            result += `<li><strong>${collectionName}:</strong> ${snapshot.size} dokumen</li>`;
        }
        
        result += '</ul>';
        
        hideLoading();
        
        // Tampilkan modal dengan status
        const modal = document.createElement('div');
        modal.className = 'modal-overlay show';
        modal.innerHTML = `
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-database"></i> Status Database</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    ${result}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="initializeDatabase()">
                        <i class="fas fa-play"></i> Inisialisasi
                    </button>
                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                        Tutup
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error("Error cek status database:", error);
        hideLoading();
        showToast('error', 'Error', 'Gagal cek status database');
    }
}
        

// DI showApp() ATAU loadPage():
function updateUIBasedOnRole() {
  const role = localStorage.getItem('userRole');
  
  // Sembunyikan menu untuk karyawan
  if (role === 'karyawan') {
    document.querySelector('[data-page="paket"]').style.display = 'none';
    document.querySelector('[data-page="import-export"]').style.display = 'none';
    document.querySelector('[data-page="laporan"]').style.display = 'none';
  }


  
  // Update nama user di navbar
  document.getElementById('userRole').textContent = 
    role === 'admin' ? 'Administrator' : 'Karyawan';
}

        // ============================================
        // CRUD FUNCTIONS - PELANGGAN
        // ============================================
        
        // PERBAIKAN: GANTI FUNGSI showAddPelangganModal
function showAddPelangganModal() {
    // Reset form
    document.getElementById('formPelanggan').reset();
    document.getElementById('pelangganId').value = '';
    
    // Set tanggal default
    document.getElementById('pelangganTanggalPasang').value = new Date().toISOString().split('T')[0];
    
    // ⭐⭐ TAMBAHKAN INI: ⭐⭐
    loadPaketSelectOptions();
    
    // Tampilkan modal
    showModal('modalPelanggan');
}

console.log("✅ Function updated");

function setupAutoProrata() {
    const tglInput = document.getElementById('pelangganTanggalPasang');
    const hargaInput = document.getElementById('pelangganHarga');
    
    if (!tglInput || !hargaInput) return;
    
    tglInput.addEventListener('change', function() {
        const tglPasang = new Date(this.value);
        const sekarang = new Date();
        const harga = parseInt(hargaInput.value) || 0;
        
        if (harga > 0 && 
            tglPasang.getMonth() === sekarang.getMonth() && 
            tglPasang.getFullYear() === sekarang.getFullYear()) {
            
            const hariDalamBulan = 30;
            const sisaHari = hariDalamBulan - tglPasang.getDate() + 1;
            const prorata = Math.round((harga / hariDalamBulan) * sisaHari);
            
            // TAMPILKAN INFO PRORATA
            showToast('info', 'Prorata', 
                `Bulan pertama: ${sisaHari} hari = ${formatRupiah(prorata)}`);
            
            // OPSIONAL: Auto-update harga field
            // hargaInput.value = prorata;
        }
    });
}

// PANGGIL DI showAddPelangganModal():
// setupAutoProrata();
async function generateTagihanArrears(pelangganId, pelangganData, tglPasang) {
    const tglPasangObj = new Date(tglPasang);
    
    // 1. TAGIHAN UNTUK BULAN PERTAMA (PRORATA)
    // Tagihan bulan berikutnya untuk penggunaan bulan pertama
    const bulanTagihan1 = moment(tglPasang).add(1, 'month').format('MM-YYYY');
    
    // Hitung prorata bulan pertama
    const prorata = hitungProrataBulanPertama(pelangganData.harga, tglPasang);
    
    // Buat tagihan prorata (jatuh tempo: 10 bulan berikutnya)
    await buatTagihanArrears(pelangganId, pelangganData, {
        bulan: bulanTagihan1,
        jumlah: prorata,
        keterangan: `Prorata ${moment(tglPasang).format('MMM YYYY')}`,
        jatuh_tempo: moment(bulanTagihan1).date(10).format('DD-MM-YYYY')
    });
    
    // 2. TAGIHAN BULAN-BULAN BERIKUTNYA (FULL)
    // Mulai dari bulan setelah bulan pertama
    const mulaiBulanFull = moment(tglPasang).add(2, 'months');
    
    for (let i = 0; i < 12; i++) { // 12 bulan ke depan
        const bulanTagihan = mulaiBulanFull.clone().add(i, 'months').format('MM-YYYY');
        const jatuhTempo = mulaiBulanFull.clone().add(i, 'months').date(10).format('DD-MM-YYYY');
        
        await buatTagihanArrears(pelangganId, pelangganData, {
            bulan: bulanTagihan,
            jumlah: pelangganData.harga,
            keterangan: `Tagihan reguler`,
            jatuh_tempo: jatuhTempo
        });
    }
}

function hitungProrataBulanPertama(hargaBulanan, tglPasang) {
    const tgl = new Date(tglPasang);
    const tahun = tgl.getFullYear();
    const bulan = tgl.getMonth();
    const hariDalamBulan = new Date(tahun, bulan + 1, 0).getDate();
    const sisaHari = hariDalamBulan - tgl.getDate() + 1;
    
    return Math.round((hargaBulanan / hariDalamBulan) * sisaHari);
}


// Helper terpisah untuk isi dropdown agar rapi
function populatePaketOptions() {
    const paketSelect = document.getElementById('pelangganPaket');
if (paketSelect && paketData) {
    paketSelect.innerHTML = '<option value="">-- Pilih Paket --</option>';
    
    paketData.forEach(p => {
        const option = document.createElement('option');
        option.value = p.nama;
        option.textContent = p.nama; // ← HANYA NAMA
        option.dataset.harga = p.harga;
        paketSelect.appendChild(option);
    });
    
    paketSelect.onchange = function() {
        const harga = this.options[this.selectedIndex].dataset.harga;
        document.getElementById('pelangganHarga').value = harga || '';
    };
}
}

// ============================================
// FUNGSI TEMPLATE PESAN - FIX
// ============================================

// 1. FUNGSI SAVE TEMPLATE PESAN
async function saveMessageTemplates() {
    console.log("🔄 Menyimpan template pesan...");
    
    try {
        // Ambil data dari form
        const templateData = {
            // Reminder templates
            reminder_3hari: document.getElementById('templateReminder3Days').value,
            reminder_1hari: document.getElementById('templateReminder1Day').value,
            reminder_overdue: document.getElementById('templateOverdue').value,
            
            // Konfirmasi templates
            payment_confirmed: document.getElementById('templatePaymentConfirmed').value,
            new_invoice: document.getElementById('templateNewInvoice').value,
            
            // Metadata
            updated_at: new Date().toISOString(),
            updated_by: currentUser.email,
            company_id: globalCompanyId
        };

        // Validasi
        if (!templateData.reminder_3hari || !templateData.payment_confirmed) {
            showToast('error', 'Validasi Gagal', 'Template utama harus diisi');
            return;
        }

        showLoading();

        // Simpan ke Firestore
        await db.collection('message_templates').doc(globalCompanyId).set(templateData, { merge: true });

        // Log aktivitas
        await db.collection('aktivitas').add({
            aktivitas: 'Menyimpan template pesan otomatis',
            user: getUserLogName(),
            timestamp: new Date().toISOString()
        });

        hideLoading();
        hideModal('modalMessageTemplates');
        showToast('success', 'Berhasil', 'Template pesan berhasil disimpan!');

    } catch (error) {
        hideLoading();
        console.error("❌ Error saveMessageTemplates:", error);
        showToast('error', 'Gagal', 'Gagal menyimpan template: ' + error.message);
    }
}

// 2. FUNGSI LOAD TEMPLATE PESAN
async function loadMessageTemplates() {
    console.log("📥 Memuat template pesan...");
    
    try {
        const doc = await db.collection('message_templates').doc(globalCompanyId).get();
        
        if (doc.exists) {
            const data = doc.data();
            console.log("✅ Template ditemukan:", data);
            
            // Map data ke field yang sesuai
            const fieldMapping = {
                'templateReminder3Days': data.reminder_3hari,
                'templateReminder1Day': data.reminder_1hari,
                'templateOverdue': data.reminder_overdue,
                'templatePaymentConfirmed': data.payment_confirmed,
                'templateNewInvoice': data.new_invoice
            };

            // Isi setiap textarea
            Object.entries(fieldMapping).forEach(([fieldId, value]) => {
                const element = document.getElementById(fieldId);
                if (element && value) {
                    element.value = value;
                }
            });
            
            console.log("✅ Template berhasil dimuat ke form");
        } else {
            console.log("ℹ️ Belum ada template tersimpan, gunakan default");
            // Biarkan nilai default dari HTML
        }
    } catch (error) {
        console.error("❌ Error loadMessageTemplates:", error);
    }
}

// 3. FUNGSI SHOW MODAL DENGAN LOAD DATA
function showMessageTemplates() {
    console.log("🔘 Membuka modal template pesan");
    
    // Tampilkan modal
    showModal('modalMessageTemplates');
    
    // Load data setelah modal terbuka
    setTimeout(() => {
        loadMessageTemplates();
    }, 200);
}
        
        // ============================================
// FUNGSI SIMPAN PELANGGAN (FIX EDIT)
// ============================================

async function savePelanggan() {
    try {
        // Ambil nilai dari form
        const pelangganId = document.getElementById('pelangganId').value;
        const nama = document.getElementById('pelangganNama').value.trim();
        const telepon = document.getElementById('pelangganTelepon').value.trim();
        const alamat = document.getElementById('pelangganAlamat').value.trim();
        const paket = document.getElementById('pelangganPaket').value;
        const harga = document.getElementById('pelangganHarga').value;
        const tanggalPasang = document.getElementById('pelangganTanggalPasang').value;
        const status = document.getElementById('pelangganStatus').value;
        const koordinat = document.getElementById('pelangganKoordinat').value;
        const catatan = document.getElementById('pelangganCatatan').value;
        
        // Validasi
        if (!nama || !telepon || !alamat || !paket || !harga || !tanggalPasang) {
            showToast('error', 'Validasi Gagal', 'Harap isi semua field yang wajib');
            return;
        }
        
        // Validasi nomor telepon (harus angka)
        const teleponAngka = telepon.replace(/\D/g, '');
        if (teleponAngka !== telepon) {
            showToast('error', 'Validasi Gagal', 'Nomor telepon hanya boleh mengandung angka');
            return;
        }
        
        // Validasi minimal panjang telepon
        if (telepon.length < 10) {
            showToast('error', 'Validasi Gagal', 'Nomor telepon minimal 10 digit');
            return;
        }
        
        // Validasi harga harus angka
        if (isNaN(parseFloat(harga)) || parseFloat(harga) <= 0) {
            showToast('error', 'Validasi Gagal', 'Harga harus angka dan lebih dari 0');
            return;
        }
        
        showLoading();
        
        // Pastikan company_id ada
        if (!globalCompanyId) {
            await ensureCompanyId();
        }
        
        // Data untuk disimpan
        const pelangganData = {
            nama: nama.toUpperCase(),
            telepon: telepon,
            alamat: alamat,
            paket: paket,
            harga: parseFloat(harga),
            tanggal_pasang: tanggalPasang,
            status: status,
            koordinat: koordinat,
            catatan: catatan,
            company_id: globalCompanyId,
            updated_at: new Date().toISOString()
        };
        
        let message = '';
        let isNew = !pelangganId;
        
        // ⭐⭐ AMBIL DATA LAMA JIKA UPDATE ⭐⭐
        let oldData = null;
        if (pelangganId) {
            const oldDoc = await db.collection('pelanggan').doc(pelangganId).get();
            if (oldDoc.exists) oldData = oldDoc.data();
        }
        
        if (pelangganId) {
            // Update existing
            await db.collection('pelanggan').doc(pelangganId).update(pelangganData);
            message = 'Data pelanggan berhasil diperbarui';
        } else {
            // Add new
            pelangganData.created_at = new Date().toISOString();
            const newDocRef = await db.collection('pelanggan').add(pelangganData);
            message = 'Pelanggan baru berhasil ditambahkan';
        }

        // ⭐⭐ LOG AKTIVITAS DETAIL ⭐⭐
        try {
            let detailPerubahan = "";
            
            if (!isNew && oldData) {
                // CEK PERUBAHAN
                if (oldData.nama !== pelangganData.nama) {
                    detailPerubahan += `Nama: "${oldData.nama}" → "${pelangganData.nama}". `;
                }
                if (oldData.paket !== pelangganData.paket) {
                    detailPerubahan += `Paket: "${oldData.paket}" → "${pelangganData.paket}". `;
                }
                if (oldData.harga !== pelangganData.harga) {
                    detailPerubahan += `Harga: ${formatRupiah(oldData.harga)} → ${formatRupiah(pelangganData.harga)}. `;
                }
                if (oldData.status !== pelangganData.status) {
                    detailPerubahan += `Status: "${oldData.status}" → "${pelangganData.status}". `;
                }
            }
            
            const aktivitasText = isNew 
                ? `TAMBAH PELANGGAN - ${nama} | Paket: ${paket} | Harga: ${formatRupiah(pelangganData.harga)}`
                : `UPDATE PELANGGAN - ${nama} | ${detailPerubahan || "Data diperbarui"}`;
            
            await db.collection('aktivitas').add({
                aktivitas: aktivitasText,
                user: currentUser?.email || "Admin",
                timestamp: new Date().toISOString(),
                company_id: globalCompanyId
            });
            
        } catch (logError) {
            console.log("Log gagal:", logError);
        }
        
        // Tutup modal
        hideModal('modalPelanggan');
        
        // Refresh data
        await loadPelangganData();
        
        // Tampilkan pesan sukses
        hideLoading();
        showToast('success', 'Berhasil', message);
        
    } catch (error) {
        console.error("Error saving pelanggan:", error);
        hideLoading();
        showToast('error', 'Error', 'Gagal menyimpan data pelanggan');
    }
}

async function generateTagihanPertama(pelangganId, pelangganData, tglPasang) {
    try {
        // === PERBAIKAN: Timeline arrears untuk pelanggan baru ===
        const tglPasangObj = new Date(tglPasang);
        
        // 1. Tentukan bulan pemakaian (bulan saat pasang)
        const bulanPemakaian = moment(tglPasangObj).format('MM-YYYY'); // Contoh: "2024-12"
        
        // 2. Jatuh tempo = bulan berikutnya, tanggal 10
        const bulanJatuhTempo = moment(tglPasangObj).add(1, 'month').format('MM-YYYY'); // "2025-01"
        const tanggalJatuhTempo = `${bulanJatuhTempo}-10`;
        
        // 3. Hitung prorata untuk sisa hari di bulan pemakaian
        const hariDalamBulan = moment(bulanPemakaian).daysInMonth();
        const sisaHari = hariDalamBulan - tglPasangObj.getDate() + 1;
        const jumlah = Math.round((pelangganData.harga / hariDalamBulan) * sisaHari);
        
        console.log("🆕 Tagihan pertama:");
        console.log(`- Pelanggan: ${pelangganData.nama}`);
        console.log(`- Pasang: ${tglPasang} (${sisaHari} hari sisa di ${bulanPemakaian})`);
        console.log(`- Tagihan: ${bulanPemakaian} = ${formatRupiah(jumlah)}`);
        console.log(`- Jatuh tempo: ${tanggalJatuhTempo}`);
        
        const tagihanId = 'INV_' + pelangganId + '_' + bulanPemakaian.replace('-', '');
        
        const tagihanData = {
            id: tagihanId,
            pelanggan_id: pelangganId,
            pelanggan_nama: pelangganData.nama,
            pelanggan_telepon: pelangganData.telepon,
            pelanggan_email: pelangganData.email || pelangganData.telepon + '@xbill.com',
            bulan: bulanPemakaian, // Bulan pemakaian (saat pasang)
            jumlah: jumlah,
            status: 'belum',
            tanggal_jatuh_tempo: tanggalJatuhTempo, // Jatuh tempo bulan berikutnya
            tanggal_dibuat: new Date().toISOString(),
            prorata: true,
            prorata_hari: sisaHari,
            denda: 0,
            company_id: globalCompanyId,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };
        
        await db.collection('tagihan').doc(tagihanId).set(tagihanData);
        
        console.log("✅ Tagihan pertama digenerate:", tagihanId);
        
        // Tampilkan timeline yang jelas ke user
        const timelineMessage = `
            📅 Timeline ARREARS untuk ${pelangganData.nama}:
            1. Pasang: ${moment(tglPasang).format('DD MMM YYYY')}
            2. Pemakaian: ${bulanPemakaian} (${sisaHari} hari)
            3. Tagihan: ${formatRupiah(jumlah)} (prorata)
            4. Jatuh tempo: ${moment(tanggalJatuhTempo).format('DD MMM YYYY')}
        `;
        
        showToast('info', 'Tagihan Dibuat', timelineMessage);
        
        // LOG AKTIVITAS dengan detail arrears
        await db.collection('aktivitas').add({
            aktivitas: `Auto-generate tagihan pertama untuk ${pelangganData.nama}: ${bulanPemakaian} (prorata ${sisaHari} hari) → jatuh tempo ${tanggalJatuhTempo}`,
            user: getUserLogName(),
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        console.error("❌ Gagal generate tagihan pertama :", error);
        showToast('error', 'Error', 'Gagal buat tagihan pertama: ' + error.message);
    }
}
        
        async function editPelanggan(id) {
    console.log("🔥 EDIT PELANGGAN FORCE METHOD");
    
    // 1. FORCE CLOSE ALL MODALS
    document.querySelectorAll('.modal-overlay').forEach(m => {
        m.style.display = 'none';
        m.classList.remove('show');
        m.classList.add('hidden');
    });
    
    // 2. FORCE OPEN PELANGGAN MODAL
    const modal = document.getElementById('modalPelanggan');
    modal.style.display = 'flex';
    modal.style.visibility = 'visible';
    modal.style.opacity = '1';
    modal.classList.remove('hidden');
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    try {
        // 3. GET DATA
        const doc = await db.collection('pelanggan').doc(id).get();
        if (!doc.exists) return;
        
        const data = doc.data();
        
        // 4. FILL FORM (SIMPLE VERSION)
        document.getElementById('pelangganId').value = id;
        document.getElementById('pelangganNama').value = data.nama || '';
        document.getElementById('pelangganTelepon').value = data.telepon || '';
        document.getElementById('pelangganAlamat').value = data.alamat || '';
        document.getElementById('pelangganHarga').value = data.harga || '';
        document.getElementById('pelangganStatus').value = data.status || 'aktif';
        document.getElementById('pelangganTanggalPasang').value = data.tanggal_pasang || '';
        
        // 5. LOAD & SET PAKET
        setTimeout(async () => {
            await loadPaketSelectOptions();
            
            const select = document.getElementById('pelangganPaket');
            if (select && data.paket) {
                select.value = data.paket;
                console.log("✅ Paket set:", data.paket);
            }
        }, 300);
        
    } catch (error) {
        console.error("Error:", error);
    }
}

// ============================================
// FUNGSI KHUSUS UNTUK MENGISI DROPDOWN PAKET
// ============================================

async function populateDropdownPaket() {
    console.log("📦 Mengisi Dropdown Paket...");
    
    const paketSelect = document.getElementById('pelangganPaket');
    if (!paketSelect) {
        console.error("❌ Elemen #pelangganPaket tidak ditemukan!");
        return;
    }
    
    try {
        // Ambil data paket (gunakan window.paketData jika ada preload, atau ambil baru)
        let snapshot;
        if (window.paketData && window.paketData.length > 0) {
            console.log("Menggunakan data preload paket");
            // Tidak perlu await get lagi
        } else {
            console.log("Mengambil data paket baru...");
            snapshot = await db.collection('paket').get();
            window.paketData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }
        
        // Kosongkan dulu
        paketSelect.innerHTML = '<option value="">-- Pilih Paket --</option>';
        
        // Isi Option
        if (window.paketData && window.paketData.length > 0) {
            window.paketData.forEach(p => {
                const option = document.createElement('option');
                option.value = p.nama; // Gunakan NAMA Paket sebagai Value
                option.textContent = `${p.nama} (${formatRupiah(p.harga)})`;
                paketSelect.appendChild(option);
            });
            
            console.log(`✅ ${window.paketData.length} paket berhasil diisi ke dropdown.`);
        } else {
            console.warn("⚠️ Data paket kosong");
        }
        
        // Setup Event Listener (Hanya sekali)
        if (!paketSelect.hasListener) {
            paketSelect.addEventListener('change', function() {
                const harga = this.options[this.selectedIndex].getAttribute('data-harga');
                document.getElementById('pelangganHarga').value = harga || '';
            });
            paketSelect.hasListener = true;
        }
        
    } catch (error) {
        console.error("❌ Error populate dropdown:", error);
    }
}


// ============================================
// FUNGSI EDIT DI HALAMAN TUNGGAKAN (PAKSA MODAL)
// ============================================

async function editPelangganDetail(pelangganId) {
    try {
        console.log("✏️ Edit pelanggan (Mode Tumpuk Tindih):", pelangganId);
        
        showLoading();
        
        // 1. AMBIL DATA
        const doc = await db.collection('pelanggan').doc(pelangganId).get();
        if (!doc.exists) throw new Error('Data tidak ditemukan');
        
        const data = doc.data();
        
        // 2. ISI FORM MODAL PELANGGAN
        document.getElementById('pelangganId').value = pelangganId;
        document.getElementById('pelangganNama').value = data.nama || '';
        document.getElementById('pelangganTelepon').value = data.telepon || '';
        document.getElementById('pelangganAlamat').value = data.alamat || '';
        document.getElementById('pelangganPaket').value = data.paket || '';
        document.getElementById('pelangganHarga').value = data.harga || '';
        document.getElementById('pelangganTanggalPasang').value = data.tanggal_pasang || '';
        document.getElementById('pelangganStatus').value = data.status || 'aktif';
        document.getElementById('pelangganCatatan').value = data.catatan || '';
        
        // 3. TUTUP MODAL TUNGGAKAN (Detail/Pay) KALAU ADA
        const modalDetail = document.getElementById('modalDetailTagihan');
        if (modalDetail) modalDetail.remove();
        
        const modalPay = document.getElementById('modalPayAll');
        if (modalPay) modalPay.remove();
        
        // 4. BUKA MODAL EDIT (PAKSA MUNCUL DI HALAMAN INI)
        const modalEdit = document.getElementById('modalPelanggan');
        modalEdit.classList.remove('hidden');
        modalEdit.classList.add('show');
        modalEdit.style.display = 'flex';
        modalEdit.style.zIndex = '99999'; // Z-INDEX TERTINGGI
        document.body.style.overflow = 'hidden';
        
        // Ubah judul jadi "Edit Pelanggan"
        const judul = modalEdit.querySelector('.modal-title');
        if (judul) judul.innerText = 'Edit Pelanggan';
        
        hideLoading();
        showToast('info', 'Mode Edit', 'Form Edit Pelanggan aktif.');
        
    } catch (error) {
        console.error("Error:", error);
        hideLoading();
        showToast('error', 'Gagal', error.message);
    }
}
        
// ============================================
// FUNGSI deletePelanggan() - VERSI HEMAT
// ============================================
async function deletePelanggan(id) {
    if (localStorage.getItem('userRole') !== 'admin') {
        alert('HANYA ADMIN!'); 
        return;
    }
    
    if (!confirm('HAPUS PELANGGAN INI?')) return;
    
    try {
        showLoading();
        
        // 1. HAPUS DARI DATABASE
        await db.collection('pelanggan').doc(id).delete();
        
        // ⭐⭐ 2. UPDATE CACHE LOKAL LANGSUNG ⭐⭐
        if (window.pelangganDataCache) {
            window.pelangganDataCache = window.pelangganDataCache.filter(p => p.id !== id);
        }
        
        // ⭐⭐ 3. UPDATE LOCALSTORAGE CACHE LANGSUNG ⭐⭐
        const cached = localStorage.getItem('xbill_cache');
        if (cached) {
            try {
                const data = JSON.parse(cached);
                if (data.pelanggan) {
                    data.pelanggan = data.pelanggan.filter(p => p.id !== id);
                    data.timestamp = Date.now();
                    localStorage.setItem('xbill_cache', JSON.stringify(data));
                }
            } catch(e) {
                // ignore parse error
            }
        }
        
        // ⭐⭐ 4. RENDER ULANG TABEL LANGSUNG DARI CACHE ⭐⭐
        if (window.pelangganDataCache) {
            renderPelangganTable(window.pelangganDataCache);
        } else {
            // Jika tidak ada cache, load dari database
            await loadPelangganData();
        }
        
        showToast('success', 'Berhasil', 'Data terhapus');
        hideLoading();
        
        // 5. LOG AKTIVITAS
        await db.collection('aktivitas').add({
            aktivitas: `Hapus pelanggan: ${nama}`,
            user: currentUser?.email || "Admin",
            timestamp: new Date().toISOString(),
            company_id: globalCompanyId  // ⭐ TAMBAH INI!
        });
        
    } catch (error) {
        console.error("Error delete pelanggan:", error);
        showToast('error', 'Gagal', 'Gagal menghapus: ' + error.message);
        hideLoading();
    }
}

// TAMBAHKAN INI DI renderPelangganTable()
function attachDeleteEvents() {
    // HAPUS SEMUA EVENT LAMA
    document.querySelectorAll('.btn-danger').forEach(btn => {
        btn.replaceWith(btn.cloneNode(true));
    });
    
    // PASANG EVENT BARU
    document.querySelectorAll('.btn-danger').forEach(btn => {
        btn.onclick = function(e) {
            e.stopPropagation();
            e.stopImmediatePropagation();
            const id = this.getAttribute('data-id');
            if (id) deletePelanggan(id);
        };
    });
}


// FUNGSI UNTUK UPDATE TIMELINE PREVIEW DI MODAL
function updateArrearsTimeline() {
    try {
        // Ambil input bulan generate
        const bulanGenerateInput = document.getElementById('generateBulan').value;
        const tanggalJatuhTempo = parseInt(document.getElementById('generateJatuhTempo').value) || 10;
        
        if (!bulanGenerateInput) return;
        
        // Parse input
        const bulanGenerate = moment(bulanGenerateInput, 'YYYY-MM'); // Titik Akhir Loop
        const bulanSebelumnya = bulanGenerate.clone().subtract(1, 'month'); // Bulan sebelum input

        // Update UI Preview
        // Sesuai perintah: Yang muncul "Tagihan Bulan Januari"
        document.getElementById('previewBulanPemakaian').textContent = bulanSebelumnya.format('MMM YYYY'); // Des 2024 (Pemakaian)
        document.getElementById('previewBulanGenerate').textContent = bulanGenerate.format('MMM YYYY'); // Jan 2025 (Generate)
        
        // Jatuh tempo: 10 bulan berikutnya (Feb 2025) -> ATAU SESUAI LOGIKA BARU (10 Jan 2025)
        // Karena perintah: "Generate bulan januari, yang muncul tagihan bulan januari"
        // Maka jatuh tempo idealnya adalah di bulan berikutnya (Februari) atau akhir bulan Januari.
        // Namun agar konsisten dengan bulan muncul:
        const jatuhTempoDate = bulanGenerate.clone().date(tanggalJatuhTempo); // 10 Januari 2025
        document.getElementById('previewJatuhTempo').textContent = jatuhTempoDate.format('DD MMM YYYY');

        // Update Summary
        document.getElementById('summaryBulanPemakaian').textContent = bulanSebelumnya.format('MMMM YYYY'); // Menunjukkan pemakaian bulan lalu
        document.getElementById('summaryBulanJatuhTempo').textContent = bulanGenerate.format('MMMM YYYY'); // Menunjukkan jatuh tempo di bulan ini

    } catch (error) {
        console.error("Error update timeline:", error);
    }
}

// FUNGSI UNTUK LOAD DATA DAN UPDATE PREVIEW
async function loadTunggakanDataForModal() {
    console.log("📊 Loading data untuk modal ...");
    
    try {
        // 1. AMBIL DATA PELANGGAN AKTIF
        const snapshot = await db.collection('pelanggan').where('status', '==', 'aktif').get();
        const totalAktif = snapshot.size;
        
        // 2. HITUNG RATA-RATA HARGA
        let totalHarga = 0;
        snapshot.forEach(doc => {
            totalHarga += Number(doc.data().harga) || 150000;
        });
        const rataHarga = Math.round(totalHarga / totalAktif);
        
        // 3. UPDATE UI
        document.getElementById('summaryTotalAktif').textContent = totalAktif;
        document.getElementById('previewPelangganCount').textContent = totalAktif;
        document.getElementById('previewHargaRata').textContent = formatRupiah(rataHarga);
        
        const estimasiTotal = totalAktif * rataHarga;
        document.getElementById('previewTotalEstimasi').textContent = formatRupiah(estimasiTotal);
        document.getElementById('summaryEstimasiTotal').textContent = formatRupiah(estimasiTotal);
        document.getElementById('summaryJumlahTagihan').textContent = totalAktif;
        
        // 4. UPDATE TIMELINE
        updateArrearsTimeline();
        
       
        
    } catch (error) {
        console.error("❌ Error load data for modal:", error);
        showToast('error', 'Error', 'Gagal memuat data');
    }
}

// INIT MODAL SAAT DIBUKA
document.addEventListener('DOMContentLoaded', function() {
    // Event listener untuk input bulan generate
    const bulanGenerateInput = document.getElementById('generateBulan');
    if (bulanGenerateInput) {
        // Set default ke bulan sekarang
        const now = moment();
        bulanGenerateInput.value = now.format('YYYY-MM');
        
        bulanGenerateInput.addEventListener('change', function() {
            updateArrearsTimeline();
        });
    }
 // Event listener untuk input tanggal jatuh tempo
    const jatuhTempoInput = document.getElementById('generateJatuhTempo');
    if (jatuhTempoInput) {
        jatuhTempoInput.addEventListener('change', updateArrearsTimeline);
    }
    
    // Event listener untuk filter tunggakan
    const filterTunggakan = document.getElementById('filterTunggakan');
    if (filterTunggakan) {
        filterTunggakan.addEventListener('change', function() {
            toggleTunggakanFilter();
            updateArrearsTimeline();
        });
    }
    
    // Inisialisasi timeline saat pertama kali
    setTimeout(updateArrearsTimeline, 500);
});

// ============================================
// FUNGSI HELPER: FORMAT BULAN UNTUK DISPLAY
// ============================================

function formatBulanForDisplay(bulanString) {
    try {
        // Coba berbagai format
        let m = moment(bulanString, 'MM-YYYY');
        if (!m.isValid()) {
            m = moment(bulanString, 'YYYY-MM');
        }
        if (!m.isValid()) {
            m = moment(bulanString);
        }
        
        if (m.isValid()) {
            return m.format('MMMM YYYY');
        }
        
        return bulanString; // Fallback ke string asli
        
    } catch (error) {
        return bulanString;
    }
}

// ============================================
// FUNGSI BARU: VALIDASI DAN KONVERSI TANGGAL
// ============================================

function parseAndValidateDate(dateString, format = null) {
    try {
        let m;
        
        if (format) {
            m = moment(dateString, format);
        } else {
            // Coba berbagai format umum
            const formats = [
                'YYYY-MM-DD',
                'DD-MM-YYYY', 
                'MM-DD-YYYY',
                'YYYY/MM/DD',
                'DD/MM/YYYY'
            ];
            
            for (const fmt of formats) {
                m = moment(dateString, fmt, true); // strict mode
                if (m.isValid()) break;
            }
        }
        
        if (!m || !m.isValid()) {
            throw new Error(`Format tanggal tidak valid: ${dateString}`);
        }
        
        // Validasi: tanggal tidak boleh di masa depan jauh atau masa lalu jauh
        const now = moment();
        const diffYears = Math.abs(m.diff(now, 'years'));
        
        if (diffYears > 10) {
            throw new Error(`Tanggal tidak realistis: ${m.format('DD/MM/YYYY')}`);
        }
        
        return {
            moment: m,
            iso: m.format('YYYY-MM-DD'),
            display: m.format('DD/MM/YYYY'),
            database: m.format('YYYY-MM-DD')
        };
        
    } catch (error) {
        console.error("Error parse date:", error);
        return null;
    }
}


// FUNGSI UNTUK EKSEKUSI DELETE (DIPANGGIL DARI MODAL)
async function executeDelete(id) {
    console.log("🔥 EKSEKUSI DELETE UNTUK:", id);
    
    try {
        // TAMPILKAN LOADING
        const deleteBtn = document.querySelector('button[onclick*="executeDelete"]');
        if (deleteBtn) {
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menghapus...';
            deleteBtn.disabled = true;
        }
        
        // HAPUS DARI FIREBASE
        await db.collection('pelanggan').doc(id).delete();
        console.log("✅ BERHASIL DIHAPUS");
        
        // HAPUS MODAL
        const modal = document.getElementById('deleteConfirmModal');
        if (modal) modal.remove();
        
        // TAMPILKAN NOTIFIKASI
        showToast('success', 'Berhasil', 'Data pelanggan telah dihapus');
        
        // REFRESH DATA
        if (currentPage === 'pelanggan') {
            loadPelangganData();
        }
        
        // LOG AKTIVITAS
        await db.collection('aktivitas').add({
            aktivitas: `Menghapus pelanggan ${id.substring(0, 8)}...`,
            user: getUserLogName(),
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        console.error("❌ ERROR DELETE:", error);
        showToast('error', 'Gagal', 'Gagal menghapus: ' + error.message);
        
        // HAPUS MODAL
        const modal = document.getElementById('deleteConfirmModal');
        if (modal) modal.remove();
    }
}

// GANTI TOMBOL DI TABLE MENJADI:
// <button class="btn btn-sm btn-danger" onclick="deletePelanggan('${pelanggan.id}'); return false;" title="Hapus">
        
        // ============================================
        // CRUD FUNCTIONS - PAKET
        // ============================================
        
        function showAddPaketModal() {
    if (localStorage.getItem('userRole') !== 'admin') {
        alert('HANYA ADMIN!'); 
        return;
    }
    
    // Reset form
    document.getElementById('formPaket').reset();
    
    // PERBAIKAN: Wajib mengosongkan ID Paket agar mode kembali ke "TAMBAH"
    document.getElementById('paketId').value = '';
    
    const modal = document.getElementById('modalPaket');
    modal.classList.remove('hidden');
    modal.classList.add('show');
}
        
       async function savePaket() {
    // Ambil semua nilai form
    const nama = document.getElementById('paketNama').value.trim();
    const kecepatan = document.getElementById('paketKecepatan').value.trim();
    const harga = parseInt(document.getElementById('paketHarga').value) || 0;
    const kuota = document.getElementById('paketKuota').value.trim();
    const deskripsi = document.getElementById('paketDeskripsi').value.trim();
    const fitur = document.getElementById('paketFitur').value.trim();
    const warna = document.getElementById('paketWarna').value;
    const status = document.getElementById('paketStatus').value;
    const paketId = document.getElementById('paketId').value; // ⭐⭐ INI YANG DICEK ⭐⭐
    
    // Validasi
    if (!nama || !kecepatan || harga <= 0) {
        showToast('error', 'Error', 'Isi nama, kecepatan, dan harga dengan benar!');
        return;
    }
    
    try {
        const dataPaket = {
            nama,
            kecepatan,
            harga,
            kuota: kuota || 'Unlimited',
            deskripsi,
            fitur,
            warna,
            status: status || 'aktif',
            company_id: globalCompanyId, // ⭐ Pastikan ada company_id
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };
        
        // ⭐⭐⭐ LOGIKA YANG BENAR: ⭐⭐⭐
        if (paketId) {
            // MODE EDIT - Update data yang ada
            await db.collection('paket').doc(paketId).update({
                ...dataPaket,
                updated_at: new Date().toISOString()
            });
            showToast('success', 'Berhasil', 'Paket berhasil diperbarui');
        } else {
            // MODE TAMBAH - Buat data baru dengan ID unik
            const newId = `PAKET_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            await db.collection('paket').doc(newId).set(dataPaket);
            showToast('success', 'Berhasil', 'Paket baru berhasil ditambahkan');
        }
        
        // Tutup modal
        hideModal('modalPaket');
        
        // Refresh data paket
        await loadPaketData();
        
    } catch (error) {
        console.error('Error save paket:', error);
        showToast('error', 'Error', 'Gagal menyimpan paket');
    }
}


        async function editPaket(id) {
    console.log("🎯 EDIT PAKET:", id);
    
    if (localStorage.getItem('userRole') !== 'admin') {
        alert('❌ HANYA ADMIN!');
        return;
    }
    
    try {
        // 1. FORCE TUTUP SEMUA MODAL LAIN
        document.querySelectorAll('.modal-overlay').forEach(m => {
            m.style.display = 'none';
            m.classList.remove('show');
            m.classList.add('hidden');
        });
        
        // 2. AMBIL DATA
        const doc = await db.collection('paket').doc(id).get();
        if (!doc.exists) {
            showToast('error', 'Error', 'Data tidak ditemukan');
            return;
        }
        
        const data = doc.data();
        console.log("📊 Data paket:", data);
        
        // 3. ISI FORM
        document.getElementById('paketId').value = id;
        document.getElementById('paketNama').value = data.nama || '';
        document.getElementById('paketKecepatan').value = data.kecepatan || '';
        document.getElementById('paketHarga').value = data.harga || 150000;
        document.getElementById('paketKuota').value = data.kuota || '';
        document.getElementById('paketDeskripsi').value = data.deskripsi || '';
        document.getElementById('paketFitur').value = data.fitur || '';
        document.getElementById('paketWarna').value = data.warna || '#4361ee';
        document.getElementById('paketStatus').value = data.status || 'aktif';
        
        // 4. FORCE BUKA MODAL
        const modal = document.getElementById('modalPaket');
        modal.style.display = 'flex';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        modal.classList.remove('hidden');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        
        // 5. UPDATE JUDUL
        modal.querySelector('.modal-title').textContent = 'Edit Paket';
        
        console.log("✅ Modal paket terbuka");
        
    } catch (error) {
        console.error("❌ Error edit paket:", error);
        showToast('error', 'Error', 'Gagal memuat data paket');
    }
}
        
        async function deletePaket(id) {
            confirmDialog('Hapus paket ini? Pelanggan yang menggunakan paket ini akan terpengaruh.', async () => {
                try {
                    showLoading();
                    await db.collection('paket').doc(id).delete();
                    
                    // Log activity
                    await db.collection('aktivitas').add({
                        aktivitas: 'Menghapus paket',
                        user: getUserLogName(),
                        timestamp: new Date().toISOString()
                    });
                    
                    hideLoading();
                    showToast('success', 'Berhasil', 'Paket berhasil dihapus');
                    
                    await loadPaketData();
                    
                } catch (error) {
                    console.error("Error deleting paket:", error);
                    hideLoading();
                    showToast('error', 'Error', 'Gagal menghapus paket');
                }
            });
        }
        



// ============================================
// GENERATE TAGIHAN (LOGIKA: PASANG BULAN INI = TAGIHAN BULAN DEPAN)
// ============================================

async function generateTagihanBulk() {
    console.log("🎯 MEMULAI GENERATE TAGIHAN (HEMAT MODE)...");
    
    try {
        // 1. AMBIL TOMBOL
        const generateBtn = document.querySelector('#modalGenerateTagihan .btn-primary') || 
                           document.getElementById('btnGenerateTagihan');
        
        if (!generateBtn) return; // Error handling simple
        
        const originalText = generateBtn.innerHTML;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Hemat Processing...';
        generateBtn.disabled = true;
        
        // 2. VALIDASI INPUT
        const bulanGenerateInput = document.getElementById('generateBulan').value;
        if (!bulanGenerateInput) {
            showToast('error', 'Error', 'Pilih bulan generate');
            resetGenerateButton();
            return;
        }

        // 3. VALIDASI COMPANY ID
        if (!globalCompanyId) {
            globalCompanyId = await ensureCompanyId();
            if (!globalCompanyId) {
                showToast('error', 'Error', 'Company ID tidak ditemukan');
                resetGenerateButton();
                return;
            }
        }

        // ==========================================
        // ✅ OPTIMASI 1: AMBIL DATA PELANGGAN & PAKET SEKALIGUS (HEMAT WAKTU)
        // ==========================================
        // Kita ambil data paket SEKALIGUS dengan pelanggan, jadi di dalam loop nanti 
        // kita TIDAK PERLU query ulang harga paket (Hemat Banyak Read)
        const [pelangganSnapshot, paketSnapshot] = await Promise.all([
            db.collection('pelanggan')
                .where('company_id', '==', globalCompanyId)
                .where('status', '==', 'aktif')
                .get(),
            db.collection('paket')
                .where('company_id', '==', globalCompanyId)
                .get()
        ]);
        
        if (pelangganSnapshot.empty) {
            showToast('info', 'Kosong', 'Tidak ada pelanggan aktif');
            resetGenerateButton();
            return;
        }
        
        // ==========================================
        // ✅ OPTIMASI 2: SIMPAN HARGA PAKET DI MEMORY (HEMAT READ)
        // ==========================================
        const paketHargaMap = {};
        paketSnapshot.forEach(doc => {
            const p = doc.data();
            paketHargaMap[p.nama] = p.harga;
        });
        // Sekarang kita punya "Database Mini" harga paket di browser. Tidak perlu Read DB lagi.

        // ==========================================
        // ✅ OPTIMASI 3: LOAD TAGIHAN YANG SUDAH ADA SEKALIGUS (HEMAT READ)
        // ==========================================
        const tagihanSnapshot = await db.collection('tagihan')
            .where('company_id', '==', globalCompanyId)
            .get();
        
        const existingMap = new Map();
        tagihanSnapshot.forEach(doc => {
            const t = doc.data();
            const key = t.pelanggan_id + '_' + (t.bulan || '');
            existingMap.set(key, true);
        });

        // ==========================================
        // ✅ OPTIMASI 4: BATCH WRITE (HEMAT WRITE)
        // ==========================================
        const batch = db.batch(); // Siapkan batch (wadah besar)
        const jatuhTempoFix = parseInt(document.getElementById('generateJatuhTempo').value) || 10;
        
        let count = 0;
        const limitDate = moment(bulanGenerateInput, 'YYYY-MM').endOf('month');
        const now = new Date().toISOString();

        // LOOPING
        for (const doc of pelangganSnapshot.docs) {
            const p = doc.data();
            const pid = doc.id;
            
            // Parse Tanggal
            let tglPasang = moment(p.tanggal_pasang);
            if (!tglPasang.isValid()) continue;
            
            let bulanSaatIni = tglPasang.clone().add(1, 'months').startOf('month');
            
            if (bulanSaatIni.isAfter(limitDate, 'month')) continue;

            // Generate per bulan
            while (bulanSaatIni.isSameOrBefore(limitDate, 'month')) {
                const bulanKey = bulanSaatIni.format('MM-YYYY');
                const uniqueKey = pid + '_' + bulanKey;
                
                // Cek duplikat dari Map (Cepat, tidak perlu query DB)
                if (existingMap.has(uniqueKey)) {
                    bulanSaatIni.add(1, 'months');
                    continue;
                }
                
                // Buat ID
                const tagihanId = `INV_${Date.now()}_${count}`;
                
                // HITUNG HARGA
                // ✅ PAKAI MAP PAKET (HEMAT: Tidak Read 'paket' collection lagi)
                let jumlahTagihan = paketHargaMap[p.paket] || 0;

                // Logic Prorata (Sama seperti asli)
                if (bulanSaatIni.isSame(tglPasang.clone().add(1, 'month'), 'month')) {
                    const bulanPemakaian = bulanSaatIni.clone().subtract(1, 'month');
                    const akhirBulanPemakaian = bulanPemakaian.clone().endOf('month');
                    const hariEfektif = akhirBulanPemakaian.diff(tglPasang, 'days') + 1;
                    const hargaPerHari = (jumlahTagihan / 30);
                    jumlahTagihan = Math.round(hargaPerHari * hariEfektif);
                }

                const jatuhTempo = bulanSaatIni.clone().date(jatuhTempoFix);
                
                // ✅ MASUKKAN KE BATCH (JANGAN .set() SATU-SATU)
                const tagihanRef = db.collection('tagihan').doc(tagihanId);
                batch.set(tagihanRef, {
                    id: tagihanId,
                    pelanggan_id: pid,
                    pelanggan_nama: p.nama || '',
                    pelanggan_telepon: p.telepon || '',
                    pelanggan_alamat: p.alamat || '',
                    paket: p.paket || '',
                    bulan: bulanKey,
                    jumlah: jumlahTagihan,
                    tanggal_jatuh_tempo: jatuhTempo.format('DD-MM-YYYY'),
                    status: 'belum',
                    company_id: globalCompanyId,
                    created_at: now,
                    updated_at: now,
                    catatan: jumlahTagihan !== p.harga ? `Tagihan prorata` : ''
                });

                count++;
                bulanSaatIni.add(1, 'months');
            }
        }

        // KOMIT BATCH SEKALIGUS (HEMAT: 1 Request untuk ratusan tagihan)
        if (count > 0) {
            console.log(`📤 Mengirim ${count} tagihan dalam 1x Hemat Batch...`);
            await batch.commit();
            console.log("✅ Berhasil! Hemat biaya request.");
        }

        forceCloseModal('modalGenerateTagihan');
        await loadTagihanData();
        showToast('success', 'Berhasil', `${count} Tagihan dibuat (Hemat Biaya)`);
        
    } catch (error) {
        console.error("❌ Error generateTagihanBulk:", error);
        showToast('error', 'Gagal', error.message);
    } finally {
        resetGenerateButton();
    }
}

// Helper untuk reset tombol (biar rapi)
function resetGenerateButton() {
    const generateBtn = document.querySelector('#modalGenerateTagihan .btn-primary') || 
                       document.getElementById('btnGenerateTagihan');
    if (generateBtn) {
        generateBtn.innerHTML = '<i class="fas fa-bolt"></i> Generate Tagihan';
        generateBtn.disabled = false;
    }
}

function resetGenerateButton() {
    const generateBtn = document.getElementById('btnGenerateTagihan');
    if (generateBtn) {
        generateBtn.innerHTML = '<i class="fas fa-bolt"></i> Generate Tagihan';
        generateBtn.disabled = false;
    }
}


    

// ============================================
// FUNGSI CEK TAGIHAN SUDAH ADA
// ============================================

async function cekTagihanSudahAda(pelangganId, bulanKey) {
    try {
        const snapshot = await db.collection('tagihan')
            .where('pelanggan_id', '==', pelangganId)
            .where('bulan', '==', bulanKey)
            .limit(1)
            .get();
        return !snapshot.empty;
    } catch (error) {
        console.error(`Error cek tagihan:`, error);
        return true; // Jika error, anggap sudah ada
    }
}

        

// FUNGSI UNTUK AMBIL DATA TUNGGAKAN
async function getTunggakanData() {
    try {
        const snapshot = await db.collection('tagihan')
            .where('status', '==', 'telat')
            .get();
        
        if (snapshot.empty) {
            return [];
        }
        
        const tunggakanByPelanggan = {};
        
        snapshot.docs.forEach(doc => {
            const tagihan = doc.data();
            const pelangganId = tagihan.pelanggan_id;
            
            if (!tunggakanByPelanggan[pelangganId]) {
                tunggakanByPelanggan[pelangganId] = {
                    pelanggan_id: pelangganId,
                    pelanggan_nama: tagihan.pelanggan_nama,
                    total: 0,
                    jumlah_tunggakan: 0,
                    hari_terlambat: 0
                };
            }
            
            // Hitung hari terlambat
            const jatuhTempo = moment(tagihan.tanggal_jatuh_tempo);
            const hariTerlambat = moment().diff(jatuhTempo, 'days');
            
            // Update data tunggakan
            tunggakanByPelanggan[pelangganId].total += Number(tagihan.jumlah) || 0;
            tunggakanByPelanggan[pelangganId].jumlah_tunggakan += 1;
            tunggakanByPelanggan[pelangganId].hari_terlambat = Math.max(
                tunggakanByPelanggan[pelangganId].hari_terlambat, 
                hariTerlambat
            );
        });
        
        return Object.values(tunggakanByPelanggan);
        
    } catch (error) {
        console.error("❌ Error get tunggakan data:", error);
        return [];
    }
}

// FUNGSI PREVIEW GENERATE TAGIHAN
async function previewGenerateTagihan() {
    try {
        console.log("👁️‍🗨️ Preview generate tagihan...");
        
        // Update summary
        await updateGenerateSummary();
        
        showToast('info', 'Preview', 'Menghitung summary generate...');
        
    } catch (error) {
        console.error("Error preview:", error);
    }
}

// FUNGSI UPDATE SUMMARY
async function updateGenerateSummary() {
    try {
        const bulan = document.getElementById('generateBulan').value;
        if (!bulan) return;
        
        // Ambil data pelanggan aktif
        const snapshot = await db.collection('pelanggan')
            .where('status', '==', 'aktif')
            .get();
        
        const totalAktif = snapshot.size;
        
        // Ambil data tunggakan
        const tunggakanData = await getTunggakanData();
        const jumlahTunggakan = tunggakanData.length;
        
        // Hitung total tunggakan
        const totalTunggakan = tunggakanData.reduce((sum, t) => sum + t.total, 0);
        
        // Estimasi tagihan (rata-rata 150rb per pelanggan)
        const estimasiTagihan = totalAktif * 150000;
        
        // Update UI
        document.getElementById('summaryTotalAktif').textContent = totalAktif;
        document.getElementById('summaryTunggakan').textContent = jumlahTunggakan;
        document.getElementById('summaryTotalTunggakan').textContent = formatRupiah(totalTunggakan);
        document.getElementById('summaryTagihan').textContent = formatRupiah(estimasiTagihan);
        
        // Estimasi waktu
        const estimasiWaktu = Math.ceil(totalAktif / 10); // 10 pelanggan per detik
        document.getElementById('summaryWaktu').textContent = `~${estimasiWaktu} detik`;
        
    } catch (error) {
        console.error("Error update summary:", error);
    }
}

// Di fungsi initializeQuickActions() atau saat buka modal:
// FUNGSI UNTUK BUKA MODAL DENGAN DATA TUNGGAKAN
function showGenerateTagihanModal() {
    const role = localStorage.getItem('userRole');
    if (role !== 'admin' && role !== 'karyawan') {
        alert('HANYA ADMIN/KARYAWAN!'); return;
    }
    const modal = document.getElementById('modalGenerateTagihan');
    modal.classList.remove('hidden');
    modal.classList.add('show');
}
        
        // FUNGSI UNTUK TOMBOL "BAYAR"
async function bayarTagihan(tagihanId) {
    try {
        console.log("Membuka form bayar untuk tagihan:", tagihanId);
        
        // Ambil data tagihan
                // Ambil data tagihan
        const doc = await db.collection('tagihan').doc(tagihanId).get();
        if (!doc.exists) {
            showToast('error', 'Error', 'Data tidak ditemukan');
            return;
        }
        
        const tagihan = doc.data();
        
        // Ambil data pelanggan (UNTUK NAMA & STATUS)
        let namaPelanggan = tagihan.pelanggan_nama || 'Pelanggan';
        let statusPelanggan = 'Nonaktif'; // Default
        let tglPasang = '-';
        let namaPetugas = 'Admin'; // ⭐ DEFAULT PETUGAS

        try {
            const pelDoc = await db.collection('pelanggan').doc(tagihan.pelanggan_id).get();
            if (petugasDoc.exists) {
                const pData = petugasDoc.data();
                namaPelanggan = pData.nama || namaPelanggan; // Update nama dari DB jika ada
                statusPelanggan = pData.status || 'Nonaktif';
                tglPasang = pData.tanggal_pasang || '-';
                
                // ⭐ AMBIL NAMA PETUGAS DARI USER LOGIN ⭐
                namaPetugas = getNamaKaryawan(); // Fungsi helper (akan kita buat di bawah)
            }
        } catch (err) {
            console.warn("Gagal ambil data pelanggan:", err);
            // Pakai default Admin
        }

        // Isi Form Modal
        document.getElementById('bayarInvoice').value = tagihan.id || tagihanId.substring(0, 10) + '...';
        document.getElementById('bayarPelanggan').value = namaPelanggan;
        document.getElementById('bayarStatusPelanggan').value = statusPelanggan;
        document.getElementById('bayarTanggalPasang').value = tglPasang;
        document.getElementById('bayarJumlah').value = formatRupiah(tagihan.jumlah || 0);
        
        // Hitung denda jika telat
        let denda = 0;
        if (tagihan.status === 'telat' && tagihan.tanggal_jatuh_tempo) {
            const hariTerlambat = moment().diff(moment(tagihan.tanggal_jatuh_tempo), 'days');
            denda = Math.round((tagihan.jumlah || 0) * Math.min(0.1, 0.02 * hariTerlambat));
        }
        
        document.getElementById('bayarDenda').value = formatRupiah(denda);
        document.getElementById('totalBayar').value = (tagihan.jumlah || 0) + denda;
        document.getElementById('tagihanId').value = tagihanId;
        
        // Set tanggal hari ini
        document.getElementById('tanggalBayar').value = moment().format('DD-MM-YYYY');
        
        // Buka modal
        const modal = document.getElementById('modalBayarTagihan');
        modal.classList.remove('hidden');
        modal.classList.add('show');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        showToast('info', 'Pembayaran', 'Isi form pembayaran');
        
    } catch (error) {
        console.error("Error membuka form bayar:", error);
        showToast('error', 'Error', 'Gagal membuka form pembayaran');
    }
}

// FUNGSI HELPER: AMBIL NAMA PETUGAS
function getNamaKaryawan() {
    // Coba ambil dari localStorage/Variable Global
    if (currentUser && currentUser.name) {
        return currentUser.name;
    }
    
    // Fallback jika user object belum siap
    const savedName = localStorage.getItem('userName');
    if (savedName) return savedName;
    
    return 'Admin'; // Default
}

// FUNGSI UNTUK TOMBOL "LIHAT DETAIL"
async function viewInvoice(tagihanId) {
    try {
        console.log("Melihat detail tagihan:", tagihanId);
        
        // Ambil data tagihan
        const doc = await db.collection('tagihan').doc(tagihanId).get();
        if (!doc.exists) {
            showToast('error', 'Error', 'Tagihan tidak ditemukan');
            return;
        }
        
        const tagihan = doc.data();
        
        // Ambil data pelanggan
        let pelanggan = {};
        if (tagihan.pelanggan_id) {
            const pelangganDoc = await db.collection('pelanggan').doc(tagihan.pelanggan_id).get();
            if (pelangganDoc.exists) {
                pelanggan = pelangganDoc.data();
            }
        }
        
        // Buat HTML untuk detail
        const detailHTML = `
            <div style="padding: 20px;">
                <div style="background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h3 style="color: var(--primary);">INVOICE</h3>
                        <h1 style="color: var(--dark);">${tagihan.id || tagihanId}</h1>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                        <div>
                            <h4>Informasi Pelanggan</h4>
                            <table class="table" style="background: #f8f9fa; border-radius: 8px;">
                                <tr><td><strong>Nama</strong></td><td>${pelanggan.nama || tagihan.pelanggan_nama || '-'}</td></tr>
                                <tr><td><strong>Telepon</strong></td><td>${pelanggan.telepon || tagihan.pelanggan_telepon || '-'}</td></tr>
                                <tr><td><strong>Email</strong></td><td>${pelanggan.email || tagihan.pelanggan_email || '-'}</td></tr>
                                <tr><td><strong>Alamat</strong></td><td>${pelanggan.alamat || '-'}</td></tr>
                            </table>
                        </div>
                        
                        <div>
                            <h4>Detail Tagihan</h4>
                            <table class="table" style="background: #f8f9fa; border-radius: 8px;">
                                <tr><td><strong>Bulan</strong></td><td>${tagihan.bulan || '-'}</td></tr>
                                <tr><td><strong>Jatuh Tempo</strong></td><td>${moment(tagihan.tanggal_jatuh_tempo).format('DD/MM/YYYY') || '-'}</td></tr>
                                <tr><td><strong>Status</strong></td><td>
                                    <span class="badge ${tagihan.status === 'lunas' ? 'badge-success' : 
                                                       tagihan.status === 'telat' ? 'badge-danger' : 'badge-warning'}">
                                        ${tagihan.status === 'lunas' ? 'LUNAS' : 
                                         tagihan.status === 'telat' ? 'TELAT' : 'BELUM BAYAR'}
                                    </span>
                                </td></tr>
                                <tr><td><strong>Tipe</strong></td><td>${tagihan.prorata ? 'PRORATA' : 'NORMAL'}</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <div style="background: var(--primary); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                        <h2 style="margin: 0;">TOTAL: ${formatRupiah(tagihan.jumlah || 0)}</h2>
                    </div>
                    
                    ${tagihan.status === 'lunas' ? `
                        <div style="margin-top: 30px; padding: 20px; background: #e8f5e9; border-radius: 8px;">
                            <h4 style="color: #00b894;"><i class="fas fa-check-circle"></i> SUDAH DIBAYAR</h4>
                            <p><strong>Tanggal Bayar:</strong> ${tagihan.tanggal_bayar || '-'}</p>
                            <p><strong>Metode:</strong> ${tagihan.metode_bayar || '-'}</p>
                            <p><strong>Referensi:</strong> ${tagihan.referensi_bayar || '-'}</p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        // Buat modal
        const modal = document.createElement('div');
        modal.className = 'modal-overlay show';
        modal.innerHTML = `
            <div class="modal modal-lg">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-file-invoice"></i> Detail Tagihan</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    ${detailHTML}
                </div>
                <div class="modal-footer">
                    ${tagihan.status !== 'lunas' ? `
                        <button class="btn btn-success" onclick="bayarTagihan('${tagihanId}')">
                            <i class="fas fa-money-bill-wave"></i> Bayar Sekarang
                        </button>
                    ` : ''}
                    <button class="btn btn-primary" onclick="printInvoiceDetail('${tagihanId}')">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                        Tutup
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error("Error melihat detail:", error);
        showToast('error', 'Error', 'Gagal memuat detail tagihan');
    }
}

// FUNGSI UNTUK TOMBOL "KIRIM REMINDER"
async function sendReminderSingle(pelangganId) {
    try {
        console.log("Kirim reminder untuk pelanggan:", pelangganId);
        
        if (!pelangganId) {
            showToast('error', 'Error', 'ID pelanggan tidak valid');
            return;
        }
        
        // Ambil data pelanggan
        const pelangganDoc = await db.collection('pelanggan').doc(pelangganId).get();
        if (!pelangganDoc.exists) {
            showToast('error', 'Error', 'Pelanggan tidak ditemukan');
            return;
        }
        
        const pelanggan = pelangganDoc.data();
        
        // Tampilkan konfirmasi
        if (confirm(`Kirim reminder tagihan ke ${pelanggan.nama} (${pelanggan.telepon})?`)) {
            showLoading();
            
            // Simulasi kirim reminder
            setTimeout(() => {
                hideLoading();
                showToast('success', 'Berhasil', `Reminder telah dikirim ke ${pelanggan.nama}`);
                
                // Log aktivitas
                db.collection('aktivitas').add({
                    aktivitas: `Kirim reminder ke ${pelanggan.nama}`,
                    user: currentUser?.name || 'Administrator',
                    timestamp: new Date().toISOString()
                });
            }, 1500);
        }
        
    } catch (error) {
        console.error("Error kirim reminder:", error);
        showToast('error', 'Error', 'Gagal mengirim reminder');
    }
}

// FUNGSI UNTUK TOMBOL "PRINT"
function printInvoice(tagihanId) {
    console.log("Print invoice:", tagihanId);
    
    // Buka window print
    window.open(`?print=${tagihanId}`, '_blank');
    
    // Atau show toast info
    showToast('info', 'Print Invoice', 'Membuka printer dialog...');
}

// Fungsi sederhana untuk print detail
function printInvoiceDetail(tagihanId) {
    const printContent = document.querySelector('.modal-overlay.show .modal-body').innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = printContent;
    window.print();
    document.body.innerHTML = originalContent;
    location.reload();
}
        
        async function konfirmasiPembayaran() {
            try {
                const form = document.getElementById('formBayarTagihan');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }
                
                showLoading();
                
                const tagihanId = document.getElementById('tagihanId').value;
                const totalBayar = parseInt(document.getElementById('totalBayar').value);
                const metodeBayar = document.getElementById('metodeBayar').value;
                const tanggalBayar = document.getElementById('tanggalBayar').value;
                const referensiBayar = document.getElementById('referensiBayar').value;
                const catatanBayar = document.getElementById('catatanBayar').value;
                
                await db.collection('tagihan').doc(tagihanId).update({
                    status: 'lunas',
                    total_bayar: totalBayar,
                    metode_bayar: metodeBayar,
                    tanggal_bayar: tanggalBayar,
                    referensi_bayar: referensiBayar,
                    catatan_bayar: catatanBayar,
                    updated_at: new Date().toISOString()
                });


                
                
                // Log activity
                await db.collection('aktivitas').add({
            aktivitas: `Bayar tagihan: ${dataTagihan.bulan} - ${formatRupiah(totalBayar)}`,
            user: currentUser?.email || "Admin",
            timestamp: new Date().toISOString(),
            company_id: globalCompanyId
                });
                
                hideModal('modalBayarTagihan');
                hideLoading();
                
                showToast('success', 'Berhasil', 'Pembayaran berhasil dikonfirmasi');
                
                if (currentPage === 'tagihan') {
                    await loadTagihanData();
                }
                if (currentPage === 'tunggakan') {
                    await loadTunggakanData();
                }
                if (currentPage === 'dashboard') {
                    await renderDashboard();
                }
                
            } catch (error) {
                console.error("Error confirming payment:", error);
                hideLoading();
                showToast('error', 'Error', 'Gagal konfirmasi pembayaran');
            }
        }
        
        // ============================================
        // PRORATA CALCULATOR
        // ============================================
        
        function hitungProrata() {
    try {
        const biayaBulanan = parseFloat(document.getElementById('prorataBiaya').value) || 0;
        const mulaiStr = document.getElementById('prorataMulai').value;
        const akhirStr = document.getElementById('prorataAkhir').value;
        
        if (!mulaiStr || !akhirStr) {
            showToast('error', 'Error', 'Isi tanggal mulai dan akhir');
            return;
        }
        
        const tanggalMulai = moment(mulaiStr);
        const tanggalAkhir = moment(akhirStr);
        
        if (!tanggalMulai.isValid() || !tanggalAkhir.isValid()) {
            showToast('error', 'Error', 'Format tanggal tidak valid');
            return;
        }
        
        if (tanggalAkhir.isBefore(tanggalMulai)) {
            showToast('error', 'Error', 'Tanggal akhir harus setelah tanggal mulai');
            return;
        }
        
        // Hitung jumlah hari
        const jumlahHari = tanggalAkhir.diff(tanggalMulai, 'days') + 1;
        document.getElementById('prorataHari').value = jumlahHari;
        
        // Hitung prorata: (biaya bulanan / 30) × jumlah hari
        const hargaPerHari = biayaBulanan / 30;
        const totalProrata = Math.round(hargaPerHari * jumlahHari);
        
        document.getElementById('prorataHasil').textContent = formatRupiah(totalProrata);
        
        // Tampilkan detail perhitungan
        const detail = `
            Perhitungan:
            - Biaya bulanan: ${formatRupiah(biayaBulanan)}
            - Per hari: ${formatRupiah(Math.round(hargaPerHari))}
            - Jumlah hari: ${jumlahHari} hari
            - Total prorata: ${formatRupiah(totalProrata)}
        `;
        
        console.log(detail);
        
    } catch (error) {
        console.error("Error hitung prorata:", error);
        showToast('error', 'Error', 'Gagal menghitung prorata');
    }
}
        
        // ============================================
        // REMINDER FUNCTIONS
        // ============================================
        
        async function kirimReminder() {
            try {
                showLoading();
                
                // Simulate sending reminders
                setTimeout(() => {
                    hideLoading();
                    hideModal('modalReminder');
                    showToast('success', 'Berhasil', 'Reminder berhasil dikirim ke pelanggan');
                    
                    // Log activity
                    db.collection('aktivitas').add({
                        aktivitas: 'Mengirim reminder tagihan',
                        user: currentUser?.name || 'Administrator',
                        timestamp: new Date().toISOString()
                    });
                }, 2000);
                
            } catch (error) {
                console.error("Error sending reminder:", error);
                hideLoading();
                showToast('error', 'Error', 'Gagal mengirim reminder');
            }
        }
        
        // ============================================
        // EXPORT FUNCTIONS
        // ============================================
        
        async function exportData() {
    if (localStorage.getItem('userRole') !== 'admin') {
        alert('❌ HANYA ADMIN YANG BOLEH EXPORT DATA!');
        return;
    }
    
    try {
        showLoading();
        const type = document.getElementById('exportType').value;
        const format = document.querySelector('input[name="exportFormat"]:checked')?.value || 'excel';
        
        let data = [];
        let filename = '';
        
        if (type === 'pelanggan') {
            const snapshot = await db.collection('pelanggan')
    .where('company_id', '==', globalCompanyId)  // ⭐ FILTER COMPANY
    .get();
            data = snapshot.docs.map(doc => {
                const p = doc.data();
                return {
                    ID: doc.id,
                    Nama: p.nama,
                    Telepon: p.telepon,
                    Email: p.email,
                    Alamat: p.alamat,
                    Paket: p.paket,
                    Harga: p.harga,
                    Status: p.status,
                    'Tanggal Pasang': p.tanggal_pasang,
                    'Tanggal Update': p.updated_at
                };
            });
            filename = `pelanggan_${moment().format('YYYYMMDD_HHmmss')}`;
        } else if (type === 'paket') {
            const snapshot = await db.collection('paket')
    .where('company_id', '==', globalCompanyId)  // ⭐ FILTER COMPANY
    .get();
            data = snapshot.docs.map(doc => {
                const p = doc.data();
                return {
                    ID: doc.id,
                    'Nama Paket': p.nama,
                    Kecepatan: p.kecepatan,
                    Harga: p.harga,
                    Kuota: p.kuota,
                    Deskripsi: p.deskripsi,
                    Fitur: p.fitur,
                    Status: p.status,
                    'Tanggal Buat': p.created_at
                };
            });
            filename = `paket_${moment().format('YYYYMMDD_HHmmss')}`;
        } else if (type === 'tagihan') {
            const snapshot = await db.collection('tagihan').limit(100).get();
            data = snapshot.docs.map(doc => {
                const t = doc.data();
                return {
                    Invoice: t.id,
                    Pelanggan: t.pelanggan_nama,
                    Bulan: t.bulan,
                    Jumlah: t.jumlah,
                    Status: t.status,
                    'Jatuh Tempo': t.tanggal_jatuh_tempo,
                    'Tanggal Bayar': t.tanggal_bayar || '-',
                    'Metode Bayar': t.metode_bayar || '-',
                    Denda: t.denda || 0
                };
            });
            filename = `tagihan_${moment().format('YYYYMMDD_HHmmss')}`;
        }
        
        if (format === 'excel') {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, `${filename}.xlsx`);
        } else if (format === 'csv') {
            const csv = XLSX.utils.sheet_to_csv(XLSX.utils.json_to_sheet(data));
            downloadCSV(csv, `${filename}.csv`);
        }
        
        hideLoading();
        showToast('success', 'Berhasil', 'Data berhasil diexport');
        
    } catch (error) {
        console.error("Error exporting:", error);
        hideLoading();
        showToast('error', 'Error', 'Gagal export data');
    }
}
        
        // ============================================
        // OTHER BUTTON FUNCTIONS
        // ============================================
        
        function refreshDashboard() {
            renderDashboard();
            showToast('success', 'Berhasil', 'Dashboard diperbarui');
        }
        
        function exportPelanggan() {
            // For now, just export data
            document.getElementById('exportType').value = 'pelanggan';
            exportData();
        }
        
        function generateSingleTagihan(pelangganId) {
            showToast('info', 'Info', 'Membuat tagihan untuk pelanggan...');
            // Implementation would be similar to bulk generate but for single customer
        }
        
        function sendReminderSingle(pelangganId) {
            showToast('info', 'Info', 'Mengirim reminder ke pelanggan...');
        }
        
        function printPelanggan() {
            window.print();
        }
        
        function exportPelangganPDF() {
            showToast('info', 'Coming Soon', 'Export PDF akan segera tersedia');
        }
        
        function exportPaket() {
            document.getElementById('exportType').value = 'paket';
            exportData();
        }
        
        function printTagihan() {
            window.print();
        }
        
        function exportTagihanPDF() {
            showToast('info', 'Coming Soon', 'Export PDF akan segera tersedia');
        }
        
        function exportTunggakan() {
            document.getElementById('exportType').value = 'tunggakan';
            exportData();
        }
        
        function generateTunggakanReport() {
            showToast('info', 'Coming Soon', 'Laporan tunggakan akan segera tersedia');
        }
        
        function sendWhatsAppReminder() {
            showToast('info', 'Coming Soon', 'WhatsApp reminder akan segera tersedia');
        }
        
        function suspendingPelanggan(pelangganId) {
            confirmDialog('Suspend pelanggan ini?', async () => {
                try {
                    showLoading();
                    await db.collection('pelanggan').doc(pelangganId).update({
                        status: 'nonaktif'
                    });
                    
                    hideLoading();
                    showToast('success', 'Berhasil', 'Pelanggan berhasil disuspend');
                    
                    if (currentPage === 'tunggakan') {
                        await loadTunggakanData();
                    }
                    
                } catch (error) {
                    console.error("Error suspending pelanggan:", error);
                    hideLoading();
                    showToast('error', 'Error', 'Gagal suspend pelanggan');
                }
            });
        }
        
        function viewInvoice(tagihanId) {
            showToast('info', 'Coming Soon', 'View invoice akan segera tersedia');
        }
        
        function printInvoice(tagihanId) {
            showToast('info', 'Coming Soon', 'Print invoice akan segera tersedia');
        }
        
        function downloadTemplate() {
            showToast('info', 'Coming Soon', 'Download template akan segera tersedia');
        }
        
        async function importExcel() {
            try {
                const fileInput = document.getElementById('fileImport');
                const file = fileInput.files[0];
                
                if (!file) {
                    showToast('error', 'Error', 'Pilih file terlebih dahulu');
                    return;
                }
                
                showLoading();
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        // Process data based on import type
                        const importType = document.getElementById('importType').value;
                        
                        showToast('success', 'Berhasil', `${jsonData.length} data berhasil diimport`);
                        
                        hideLoading();
                        
                    } catch (error) {
                        console.error("Error importing data:", error);
                        hideLoading();
                        showToast('error', 'Error', 'Gagal import data');
                    }
                };
                
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error("Error importing:", error);
                hideLoading();
                showToast('error', 'Error', 'Gagal import data');
            }
        }
        
        function backupManual() {
            showModal('modalBackup');
        }
        
        function startBackup() {
            showToast('info', 'Coming Soon', 'Backup otomatis akan segera tersedia');
        }
        
        function restoreBackup() {
            showToast('info', 'Coming Soon', 'Restore backup akan segera tersedia');
        }
        
        function generateLaporan() {
            showToast('info', 'Coming Soon', 'Generate laporan akan segera tersedia');
        }
        
        function printLaporan() {
            window.print();
        }
        
        function exportLaporan() {
            showModal('modalExportLaporan');
        }
        
        // ============================================
        // EVENT HANDLERS
        // ============================================
        
        // Login Handler
        // Event Listener Login
document.getElementById('loginForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    // Validasi input kosong
    if (!username || !password) {
        showToast('error', 'Login Gagal', 'Email dan Password wajib diisi');
        return;
    }

    // ⭐⭐ CEK LOCKOUT STATUS ⭐⭐
    const lockoutCheck = checkLoginLockout();
    if (lockoutCheck.locked) {
        showToast('error', 'Akun Terkunci', 
            `Terlalu banyak percobaan gagal. Coba lagi dalam ${lockoutCheck.remainingMinutes} menit.`);
        return;
    }

    // Ambil elemen tombol submit untuk efek loading
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    try {
        // Ubah tombol jadi loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Login...';
        showLoading();

        let loginSuccess = false;
        let userData = null;

        // 1. COBA LOGIN SEBAGAI ADMIN HARDCODED
        if (username === 'admin' && password === 'admin123') {
            console.log("🔐 Login sebagai Admin Hardcoded");
            
            userData = {
                uid: 'admin_hardcoded',
                name: 'Administrator',
                email: 'admin@xbill.com',
                role: 'admin'
            };
            
            loginSuccess = true;
        }
        // 2. COBA LOGIN SEBAGAI KARYAWAN (EMAIL)
        else if (username.includes('@')) {
            console.log("🔐 Login dengan email:", username);
            
            // ⭐⭐ PERBAIKAN: CEK DI KARYAWAN DULU ⭐⭐
            const karyawanSnapshot = await db.collection('karyawan')
                .where('email', '==', username.toLowerCase())
                .limit(1)
                .get();
            
            if (!karyawanSnapshot.empty) {
                const karyawanDoc = karyawanSnapshot.docs[0];
                const karyawan = karyawanDoc.data();
                
                // ⭐⭐ CEK STATUS AKTIF ⭐⭐
                if (karyawan.status !== 'aktif') {
                    throw new Error("Akun karyawan tidak aktif");
                }
                
                // Verifikasi password (base64 hash sederhana)
                if (karyawan.password === btoa(password)) {
                    userData = {
                        uid: karyawanDoc.id,
                        name: karyawan.nama,
                        email: karyawan.email,
                        role: karyawan.role,
                        telepon: karyawan.telepon || '',
                        karyawan_id: karyawanDoc.id
                    };
                    loginSuccess = true;
                    
                    // Update last login
                    await db.collection('karyawan').doc(karyawanDoc.id).update({
                        last_login: new Date().toISOString()
                    });
                    
                    console.log("✅ Login karyawan berhasil:", karyawan.nama);
                } else {
                    throw new Error("Password salah");
                }
            } 
            // ⭐⭐ PERBAIKAN: JIKA TIDAK ADA DI KARYAWAN, CEK DI FIREBASE AUTH ⭐⭐
            else {
                console.log("⚠️ Email tidak ada di karyawan, coba login sebagai user...");
                
                try {
                    const authResult = await firebase.auth().signInWithEmailAndPassword(username, password);
                    const user = authResult.user;
                    
                    // Ambil data user dari collection users
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        const userDataDB = userDoc.data();
                        userData = {
                            uid: user.uid,
                            name: userDataDB.name || user.email.split('@')[0],
                            email: user.email,
                            role: userDataDB.role || 'user'
                        };
                        loginSuccess = true;
                        
                    } else {
                        throw new Error("Akun tidak terdaftar di sistem");
                    }
                    
                } catch (firebaseError) {
                    let errorMessage = "Login gagal";
                    
                    if (firebaseError.code === 'auth/invalid-credential' || 
                        firebaseError.code === 'auth/wrong-password') {
                        errorMessage = "Email atau password salah";
                    } else if (firebaseError.code === 'auth/user-not-found') {
                        errorMessage = "Akun tidak ditemukan";
                    }
                    
                    throw new Error(errorMessage);
                }
            }
        }
        // 3. COBA LOGIN DENGAN USERNAME (BUKAN EMAIL)
        else {
            console.log("🔐 Login dengan username:", username);
            
            const email = `${username}@xbill.com`;
            try {
                const authResult = await firebase.auth().signInWithEmailAndPassword(email, password);
                const user = authResult.user;
                
                // Ambil data user dari collection users
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const userDataDB = userDoc.data();
                    userData = {
                        uid: user.uid,
                        name: userDataDB.name || user.email.split('@')[0],
                        email: user.email,
                        role: userDataDB.role || 'admin'
                    };
                    loginSuccess = true;
                    console.log("✅ Login user berhasil:", user.email);
                } else {
                    throw new Error("Akun tidak terdaftar di sistem");
                }
                
            } catch (firebaseError) {
                let errorMessage = "Login gagal";
                
                if (firebaseError.code === 'auth/invalid-credential' || 
                    firebaseError.code === 'auth/wrong-password') {
                    errorMessage = "Username atau password salah";
                } else if (firebaseError.code === 'auth/user-not-found') {
                    errorMessage = "Akun tidak ditemukan";
                }
                
                throw new Error(errorMessage);
            }
        }

        // ⭐⭐ JIKA LOGIN SUKSES ⭐⭐
        if (loginSuccess && userData) {
    // Set current user
    currentUser = userData;
    
    // ⭐⭐ VALIDASI: JIKA NAME ADALAH EMAIL, UBAH ⭐⭐
    if (currentUser.name && currentUser.name.includes('@')) {
        // Name adalah email, ambil bagian sebelum @
        const nameFromEmail = currentUser.name.split('@')[0];
        currentUser.name = nameFromEmail.charAt(0).toUpperCase() + nameFromEmail.slice(1);
        console.log("⚠️ Name diubah dari email:", currentUser.name);
    }
    
    // ⭐⭐ JIKA NAME KOSONG, BUAT DARI EMAIL ⭐⭐
    if (!currentUser.name || currentUser.name.trim() === '') {
        if (currentUser.email) {
            const nameFromEmail = currentUser.email.split('@')[0];
            currentUser.name = nameFromEmail.charAt(0).toUpperCase() + nameFromEmail.slice(1);
        } else {
            currentUser.name = 'User';
        }
    }
    
    console.log("✅ Nama user yang akan ditampilkan:", currentUser.name);
    
    // Simpan ke localStorage
    localStorage.setItem('xbill_user', JSON.stringify(currentUser));
    localStorage.setItem('userName', currentUser.name); // ⭐ INI YANG DITAMPILKAN
    localStorage.setItem('userEmail', currentUser.email);
    localStorage.setItem('userRole', currentUser.role);
    
    if (currentUser.karyawan_id) {
        localStorage.setItem('karyawanId', currentUser.karyawan_id);
    }
            // ⭐⭐ INISIALISASI COMPANY ID ⭐⭐
            console.log("🏢 Menginisialisasi Company ID...");
            
            // Cek apakah sudah punya company_id di database
            const userDocRef = db.collection('users').doc(currentUser.uid);
            const userDoc = await userDocRef.get();

            if (userDoc.exists) {
                const existingData = userDoc.data();
                globalCompanyId = existingData.company_id || null;
                
                if (globalCompanyId) {
                    console.log("✅ Company ID ditemukan:", globalCompanyId);
                } else {
                    console.warn("⚠️ Data user ada tapi company_id kosong. Membuat baru...");
                    const newCompanyId = `COMP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                    
                    await userDocRef.update({
                        company_id: newCompanyId,
                        updated_at: new Date().toISOString()
                    });
                    
                    await db.collection('companies').doc(newCompanyId).set({
                        id: newCompanyId,
                        admin_email: currentUser.email,
                        admin_name: currentUser.name,
                        created_at: new Date().toISOString()
                    });
                    
                    globalCompanyId = newCompanyId;
                    console.log("✅ Company ID baru dibuat:", globalCompanyId);
                }
            } else {
                console.log("📝 Data user belum ada. Membuat dokumen user baru...");
                const newCompanyId = `COMP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                await userDocRef.set({
                    uid: currentUser.uid,
                    email: currentUser.email,
                    name: currentUser.name,
                    role: currentUser.role,
                    company_id: newCompanyId,
                    created_at: new Date().toISOString()
                });

                await db.collection('companies').doc(newCompanyId).set({
                    id: newCompanyId,
                    admin_email: currentUser.email,
                    admin_name: currentUser.name,
                    created_at: new Date().toISOString()
                });

                globalCompanyId = newCompanyId;
                console.log("✅ User & Company ID baru dibuat:", globalCompanyId);
            }
            
            // ⭐⭐ RESET LOGIN ATTEMPTS JIKA BERHASIL ⭐⭐
            resetLoginAttempts();
            
            // ⭐⭐ LOG AKTIVITAS LOGIN ⭐⭐
            await db.collection('aktivitas').add({
                aktivitas: `Login: ${currentUser.name} (${currentUser.role})`,
                user: currentUser.name,
                user_id: currentUser.uid,
                role: currentUser.role,
                company_id: globalCompanyId,
                timestamp: new Date().toISOString()
            });
            
            // ⭐⭐ UPDATE UI DAN LOAD APLIKASI ⭐⭐
            
            // Update UI User Info
            const userNameEl = document.getElementById('userName');
            const userAvatarEl = document.getElementById('userAvatar');
            const userRoleEl = document.getElementById('userRole');
            
            if (userNameEl) userNameEl.textContent = currentUser.name;
            if (userAvatarEl) userAvatarEl.textContent = currentUser.name.charAt(0).toUpperCase();
            if (userRoleEl) {
                // Tampilkan role yang user-friendly
                const roleDisplay = {
                    'admin': 'Admin',
                    'staff_billing': 'Staff Billing',
                    'staff_teknis': 'Staff Teknis',
                    'supervisor': 'Supervisor'
                };
                userRoleEl.textContent = roleDisplay[currentUser.role] || currentUser.role;
            }
            
            // Switch View: Sembunyikan Login, Tampilkan App
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            
            // Load Dashboard
            await handleLoginSuccess();
            
            // Reset tombol
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            hideLoading();
            
            
        }
        
    } catch (error) {
        console.error("❌ Error Login:", error);
        
        // ⭐⭐ RECORD FAILED ATTEMPT UNTUK LOGIN GAGAL ⭐⭐
        recordFailedLogin();
        
        // Cek apakah sekarang terkunci
        const newLockoutCheck = checkLoginLockout();
        if (newLockoutCheck.locked) {
            error.message = `Terlalu banyak percobaan gagal. Akun terkunci selama ${newLockoutCheck.remainingMinutes} menit.`;
        } else {
            const remainingAttempts = MAX_LOGIN_ATTEMPTS - loginAttempts;
            error.message = `${error.message} (Sisa percobaan: ${remainingAttempts})`;
        }
        
        // Reset tombol
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        hideLoading();
        
        showToast('error', 'Login Gagal', error.message);
    }
});
        
        // Navigation Handler
        document.addEventListener('click', function(e) {
            const navItem = e.target.closest('.nav-item');
            if (navItem) {
                e.preventDefault();
                const page = navItem.getAttribute('data-page');
                loadPage(page);
            }
        });



        

        // Di login form, setelah verifikasi:
async function loginKaryawan(email, password) {
    try {
        console.log("🔐 Login karyawan dengan email:", email);
        
        // 1. CEK DI COLLECTION KARYAWAN
        const snapshot = await db.collection('karyawan')
            .where('email', '==', email.toLowerCase())
            .where('company_id', '==', globalCompanyId)
            .limit(1)
            .get();
        
        if (snapshot.empty) {
            throw new Error("Email tidak terdaftar");
        }
        
        const karyawanDoc = snapshot.docs[0];
        const karyawanData = karyawanDoc.data();
        
        // 2. CEK STATUS AKTIF
        if (karyawanData.status !== 'aktif') {
            throw new Error("Akun karyawan tidak aktif");
        }
        
        // 3. VERIFIKASI PASSWORD (BASE64)
        const hashedInput = btoa(password);
        if (karyawanData.password !== hashedInput) {
            throw new Error("Password salah");
        }
        
        // 4. SET CURRENT USER
        currentUser = {
            uid: karyawanDoc.id,
            karyawan_id: karyawanDoc.id,
            name: karyawanData.nama,
            email: karyawanData.email,
            role: karyawanData.role,
            telepon: karyawanData.telepon
        };
        
        // 5. SIMPAN KE LOCALSTORAGE
        localStorage.setItem('userName', karyawanData.nama);
        localStorage.setItem('userEmail', karyawanData.email);
        localStorage.setItem('userRole', karyawanData.role);
        localStorage.setItem('karyawanId', karyawanDoc.id);
        localStorage.setItem('xbill_user', JSON.stringify(currentUser));
        
        // 6. UPDATE LAST LOGIN
        await db.collection('karyawan').doc(karyawanDoc.id).update({
            last_login: new Date().toISOString()
        });
        
        // 7. LOG AKTIVITAS LOGIN
        await db.collection('aktivitas').add({
            aktivitas: `Login karyawan: ${karyawanData.nama}`,
            user: karyawanData.nama,
            user_id: karyawanDoc.id,
            company_id: globalCompanyId,
            timestamp: new Date().toISOString()
        });
        
        console.log("✅ Login berhasil sebagai karyawan:", karyawanData.nama);
        return true;
        
    } catch (error) {
        console.error("❌ Login karyawan error:", error);
        throw error;
    }
}

// Fungsi hash password sederhana
function hashPassword(password) {
    // Gunakan library bcrypt di production
    return btoa(password); // Sementara pakai base64
}


function getNamaKaryawan() {
    // Priority 1: Current user session
    if (currentUser && currentUser.name) {
        return currentUser.name;
    }
    
    // Priority 2: LocalStorage
    const savedName = localStorage.getItem('userName');
    if (savedName) {
        return savedName;
    }
    
    // Priority 3: Ambil dari Firebase berdasarkan email
    return 'Staff';
}

// ⭐⭐ PAKAI DI SEMUA LOG AKTIVITAS: ⭐⭐
async function logActivity(aktivitas, details = {}) {
    try {
        await db.collection('aktivitas').add({
            aktivitas: aktivitas,
            user: getNamaKaryawan(), // ← NAMA KARYAWAN YANG LOGIN
            user_id: localStorage.getItem('karyawanId') || currentUser?.uid,
            role: localStorage.getItem('userRole') || 'staff',
            company_id: globalCompanyId,
            details: details,
            timestamp: new Date().toISOString()
        });
    } catch (error) {
        console.error("❌ Gagal log aktivitas:", error);
    }
}


async function logActivity(aktivitas, details = {}) {
    try {
        const namaKaryawan = getNamaKaryawan();
        const karyawanId = localStorage.getItem('karyawanId') || currentUser?.uid;
        
        await db.collection('aktivitas').add({
            aktivitas: aktivitas,
            user: namaKaryawan,
            user_id: karyawanId,
            role: localStorage.getItem('userRole') || 'staff',
            company_id: globalCompanyId,
            details: details,
            timestamp: new Date().toISOString()
        });
        
        console.log(`📝 Activity by ${namaKaryawan}: ${aktivitas}`);
    } catch (error) {
        console.error("❌ Gagal log aktivitas:", error);
    }
}


async function simpanKaryawan() {
    try {
        const nama = document.getElementById('karyawanNama').value.trim();
        const email = document.getElementById('karyawanEmail').value.trim().toLowerCase();
        const password = document.getElementById('karyawanPassword').value;
        const role = document.getElementById('karyawanRole').value;
        const telepon = document.getElementById('karyawanTelepon').value.trim();
        const catatan = document.getElementById('karyawanCatatan').value.trim();
        
        // ⭐⭐ VALIDASI EMAIL FORMAT ⭐⭐
        if (!validateEmail(email)) {
            showToast('error', 'Error', 'Format email tidak valid');
            return;
        }
        
        // Validasi wajib
        if (!nama || !email || !password) {
            showToast('error', 'Error', 'Nama, email dan password wajib diisi');
            return;
        }
        
        if (password.length < 6) {
            showToast('error', 'Error', 'Password minimal 6 karakter');
            return;
        }
        
        // ⭐⭐ CEK EMAIL SUDAH TERDAFTAR DI COMPANY INI ⭐⭐
        const checkSnapshot = await db.collection('karyawan')
            .where('email', '==', email)
            .where('company_id', '==', globalCompanyId)
            .get();
        
        if (!checkSnapshot.empty) {
            showToast('error', 'Error', 'Email sudah terdaftar');
            return;
        }
        
        // ⭐⭐ SIMPAN KE FIREBASE ⭐⭐
        const karyawanId = `K_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;
        
        await db.collection('karyawan').doc(karyawanId).set({
            id: karyawanId,
            nama: nama,
            email: email, // Email sebagai username
            password: btoa(password), // Hash sederhana (base64)
            role: role,
            telepon: telepon,
            catatan: catatan,
            company_id: globalCompanyId,
            status: 'aktif',
            created_at: new Date().toISOString(),
            created_by: currentUser?.uid || 'system',
            last_login: null
        });
        
        // ⭐⭐ LOG AKTIVITAS ⭐⭐
        await db.collection('aktivitas').add({
            aktivitas: `Tambah karyawan: ${nama} (${email})`,
            user: getNamaKaryawan(),
            user_id: currentUser?.uid,
            company_id: globalCompanyId,
            details: {
                karyawan_id: karyawanId,
                role: role,
                email: email
            },
            timestamp: new Date().toISOString()
        });
        
        showToast('success', 'Berhasil', `Karyawan ${nama} berhasil ditambahkan`);
        hideModal('modalTambahKaryawan');
        
        // Reset form
        document.getElementById('formTambahKaryawan').reset();
        
    } catch (error) {
        console.error("❌ Error simpan karyawan:", error);
        showToast('error', 'Error', 'Gagal menyimpan karyawan');
    }
}

// ⭐⭐ FUNGSI VALIDASI EMAIL ⭐⭐
function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}





        async function exportPaket() {
    try {
        showLoading();
        
        // ⭐⭐ HAPUS/COMMENT BARIS INI KARENA ELEMEN TIDAK ADA: ⭐⭐
        // document.getElementById('paketStatusFilter').value = ''; // ← INI YANG ERROR
        
        // ⭐⭐ AMBIL DATA PAKET DENGAN FILTER COMPANY ⭐⭐
        const snapshot = await db.collection('paket')
            .where('company_id', '==', globalCompanyId)
            .get();
        
        if (snapshot.empty) {
            hideLoading();
            showToast('warning', 'Data Kosong', 'Tidak ada data paket');
            return;
        }
        
        // Format data untuk export
        const data = [
            ['No', 'Nama Paket', 'Kecepatan', 'Harga', 'Kuota', 'Status', 'Deskripsi', 'Fitur', 'Created At']
        ];
        
        let index = 1;
        snapshot.forEach(doc => {
            const paket = doc.data();
            data.push([
                index++,
                paket.nama || '',
                paket.kecepatan || '',
                paket.harga || 0,
                paket.kuota || '',
                paket.status || '',
                paket.deskripsi || '',
                paket.fitur || '',
                paket.created_at ? moment(paket.created_at).format('DD/MM/YYYY HH:mm') : ''
            ]);
        });
        
        // Export ke Excel
        const now = moment().format('YYYYMMDD_HHmmss');
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, 'Paket');
        XLSX.writeFile(wb, `Paket_${globalCompanyId}_${now}.xlsx`);
        
        hideLoading();
        showToast('success', 'Export Berhasil', `${snapshot.size} paket diexport`);
        
    } catch (error) {
        hideLoading();
        console.error("Error export paket:", error);
        showToast('error', 'Error', 'Gagal export paket: ' + error.message);
    }
}
        
        // ============================================
// LOGOUT HANDLER (FIXED & CENTRALIZED)
// ============================================

// Fungsi Logout Utama (Global - bisa dipanggil dari tombol mana saja)
async function handleLogout() {
    console.log("🚪 Proses Logout dimulai...");
    
    // Konfirmasi Logout
    if (!confirm('Apakah Anda yakin ingin keluar dari sistem?')) {
        console.log("❌ Logout dibatalkan oleh user.");
        return;
    }
    
    try {
        showLoading(); // Tampilkan loading
        
        // 1. Logout dari Firebase (jika ada sesi aktif)
        if (firebase.auth()) {
            await firebase.auth().signOut();
            console.log("✅ Firebase sign-out berhasil");
        }

        // 2. Hapus LocalStorage
        localStorage.removeItem('xbill_user');
        localStorage.removeItem('userRole');
        localStorage.removeItem('userName');
        
        console.log("✅ Localstorage dibersihkan");
        
        // 3. Reload Halaman untuk kembali ke Login Page
        window.location.reload();
        
    } catch (error) {
        console.error("❌ Error saat logout:", error);
        hideLoading();
        alert('Terjadi kesalahan saat logout. Silakan coba lagi.');
    }
}

// Event Listener untuk tombol logout di Navbar (ID: logoutBtn)
const logoutBtnMain = document.getElementById('logoutBtn');
if (logoutBtnMain) {
    logoutBtnMain.addEventListener('click', handleLogout);
    console.log("✅ Event listener logoutBtn terpasang");
}

// Event Listener untuk tombol logout kecil di User Menu (ID: logoutBtnSmall)
const logoutBtnSmall = document.getElementById('logoutBtnSmall');
if (logoutBtnSmall) {
    logoutBtnSmall.addEventListener('click', handleLogout);
    console.log("✅ Event listener logoutBtnSmall terpasang");
}
        


        // ==========================================
// FUNGSI PLACEHOLDER SETTING (MENGATASI ERROR)
// ==========================================

// ============================================
// 1. PROFIL PERUSAHAAN
// ============================================
async function showCompanyProfile() {
    try {
        // Load data terbaru dari Firebase sebelum buka modal
        await loadCompanyProfile();
        
        // Tampilkan modal
        const modal = document.getElementById('modalCompanyProfile');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            showToast('info', 'Profil Perusahaan', 'Memuat data profil...');
        }
    } catch (error) {
        console.error("Error show company profile:", error);
        showToast('error', 'Error', 'Gagal memuat profil perusahaan');
    }
}

// ============================================
// 2. BRANDING
// ============================================
async function showBrandingSettings() {
    try {
        // 1. Ambil data dari Firestore
        const docRef = db.collection('settings').doc('branding');
        const doc = await docRef.get();
        
        if (doc.exists) {
            const data = doc.data();
            
            // 2. Load Warna & Font (Tetap sama)
            if (document.getElementById('primaryColor')) document.getElementById('primaryColor').value = data.primary_color || '#4361ee';
            if (document.getElementById('secondaryColor')) document.getElementById('secondaryColor').value = data.secondary_color || '#7209b7';
            if (document.getElementById('mainFont')) document.getElementById('mainFont').value = data.font || "'Segoe UI', system-ui";
            if (document.getElementById('fontSize')) document.getElementById('fontSize').value = data.font_size || '16px';
            
            // 3. Load Logo (BAGIAN YANG DIPERBAIKI)
            const logoPreview = document.getElementById('logoPreview');
            if (logoPreview) {
                // Cek apakah ada field 'logo' di database dan isinya tidak kosong
                if (data.logo && data.logo.trim() !== "") {
                    // Jika ada, tampilkan gambar tersebut
                    logoPreview.innerHTML = `<img src="${data.logo}" style="width:100%;height:100%;object-fit:contain;border-radius:10px;">`;
                } else {
                    // Jika tidak ada di database, tampilkan icon default
                    logoPreview.innerHTML = `<i class="fas fa-building" style="font-size: 48px; color: var(--gray);"></i>`;
                }
            }
        }
        
        showModal('modalBranding');
        
    } catch (error) {
        console.error("Error show branding:", error);
    }
}

// ============================================
// 3. KONTAK & NOTIFIKASI
// ============================================
async function showContactSettings() {
    try {
        const docRef = db.collection('settings').doc('contacts');
        const doc = await docRef.get();
        
        if (doc.exists) {
            const data = doc.data();
            if (document.getElementById('whatsappNumber')) document.getElementById('whatsappNumber').value = data.whatsapp_number || '';
            if (document.getElementById('whatsappApiKey')) document.getElementById('whatsappApiKey').value = data.whatsapp_api_key || '';
            if (document.getElementById('enableWhatsApp')) document.getElementById('enableWhatsApp').checked = data.enable_whatsapp || false;
            if (document.getElementById('smtpHost')) document.getElementById('smtpHost').value = data.smtp_host || '';
            if (document.getElementById('smtpPort')) document.getElementById('smtpPort').value = data.smtp_port || '';
            if (document.getElementById('smtpEmail')) document.getElementById('smtpEmail').value = data.smtp_email || '';
            if (document.getElementById('smtpPassword')) document.getElementById('smtpPassword').value = data.smtp_password || '';
            if (document.getElementById('enableSSL')) document.getElementById('enableSSL').checked = data.enable_ssl || false;
            if (document.getElementById('smsProvider')) document.getElementById('smsProvider').value = data.sms_provider || '';
            if (document.getElementById('smsApiKey')) document.getElementById('smsApiKey').value = data.sms_api_key || '';
            if (document.getElementById('smsSecret')) document.getElementById('smsSecret').value = data.sms_secret || '';
            if (document.getElementById('enableSMS')) document.getElementById('enableSMS').checked = data.enable_sms || false;
            
            // Checkboxes Notifikasi
            if (document.getElementById('notifNewCustomer')) document.getElementById('notifNewCustomer').checked = data.notif_new_customer || false;
            if (document.getElementById('notifPayment')) document.getElementById('notifPayment').checked = data.notif_payment || false;
            if (document.getElementById('notifOverdue')) document.getElementById('notifOverdue').checked = data.notif_overdue || false;
            if (document.getElementById('reminder3Days')) document.getElementById('reminder3Days').checked = data.reminder_3days || false;
            if (document.getElementById('reminder1Day')) document.getElementById('reminder1Day').checked = data.reminder_1day || false;
            if (document.getElementById('reminderOverdue')) document.getElementById('reminderOverdue').checked = data.reminder_overdue || false;
        }
        showModal('modalContactSettings');
    } catch (error) {
        console.error("Error show contact settings:", error);
    }
}

// ============================================
// 4. TEMPLATE PESAN
// ============================================
async function showMessageTemplates() {
    try {
        const docRef = db.collection('settings').doc('message_templates');
        const doc = await docRef.get();
        
        if (doc.exists) {
            const data = doc.data();
            if (document.getElementById('templateReminder3Days')) document.getElementById('templateReminder3Days').value = data.reminder_3days || '';
            if (document.getElementById('templateReminder1Day')) document.getElementById('templateReminder1Day').value = data.reminder_1day || '';
            if (document.getElementById('templateOverdue')) document.getElementById('templateOverdue').value = data.overdue || '';
            if (document.getElementById('templatePaymentConfirmed')) document.getElementById('templatePaymentConfirmed').value = data.payment_confirmed || '';
            if (document.getElementById('templateNewInvoice')) document.getElementById('templateNewInvoice').value = data.new_invoice || '';
        }
        showModal('modalMessageTemplates');
    } catch (error) {
        console.error("Error show templates:", error);
    }
}

// ============================================
// 5. KEUANGAN & PAJAK
// ============================================
async function showFinancialSettings() {
    // Simulasi: Ambil data pajak dari localStorage
    const currentTax = localStorage.getItem('xbill_tax_rate') || '11';
    
    // Karena modal bawaan mungkin tidak ada input pajak, kita pakai prompt sederhana untuk demo
    const newTax = prompt(`Masukkan Pajak PPN Saat Ini (%):`, currentTax);
    
    if (newTax !== null) {
        localStorage.setItem('xbill_tax_rate', newTax);
        showToast('success', 'Berhasil', `Pajak diatur ke ${newTax}%`);
    }
}

// ============================================
// 6. KEAMANAN & AKSES (GANTI PASSWORD)
// ============================================
async function showSecuritySettings() {
    showModal('modalChangePassword');
}

// ============================================
// 7. BACKUP & RESTORE
// ============================================
async function showBackupSettings() {
    showModal('modalBackup');
}

// ============================================
// 8. SYSTEM SETTINGS
// ============================================
async function showSystemSettings() {
    // Simulasi: Ambil nama app dari localStorage
    const currentName = localStorage.getItem('xbill_app_name') || document.getElementById('companyNameNav')?.textContent || "X-BILL ISP";
    
    const newName = prompt("Masukkan Nama Aplikasi:", currentName);
    
    if (newName) {
        localStorage.setItem('xbill_app_name', newName);
        if (document.getElementById('companyNameNav')) {
            document.getElementById('companyNameNav').textContent = newName;
        }
        showToast('success', 'Berhasil', `Nama aplikasi diubah menjadi ${newName}`);
    }
}

// ============================================
// 9. USER MANAGEMENT (PROFIL SAYA)
// ============================================
// ============================================
// FUNGSI USER MANAGEMENT - GUNAKAN NAMA YANG SUDAH ADA
// ============================================

// FUNGSI 1: showUserManagement() - JIKA BELUM ADA
function showUserManagement() {
    console.log("🚀 MEMBUKA USER MANAGEMENT");
    
    // CEK EMAIL ADMIN
    const userEmail = firebase.auth().currentUser?.email || currentUser?.email;
    console.log("User email:", userEmail);
    
    // LIST EMAIL ADMIN YANG DIIZINKAN
    const adminEmails = [
        'admin@xbill.com',
        'administrator@',
        'superadmin@',
        'dovand@gmail.com',  // ⭐ EMAIL LU ⭐
        'dovand.akses@gmail.com',
        'admin'  // untuk user 'admin'
    ];
    
    // CEK APAKAH EMAIL TERMASUK ADMIN
    let isAdmin = false;
    if (userEmail) {
        const emailLower = userEmail.toLowerCase();
        for (const adminEmail of adminEmails) {
            if (emailLower.includes(adminEmail.toLowerCase())) {
                isAdmin = true;
                break;
            }
        }
    }
    
    console.log("Is admin?", isAdmin);
    
    // JIKA BUKAN ADMIN, TETAPI IZINKAN UNTUK TESTING
    if (!isAdmin) {
        // UNTUK TESTING, IZINKAN SEMUA USER
        console.log("⚠️ Bukan admin, tapi diizinkan untuk testing");
        // showToast('warning', 'Testing Mode', 'Akses User Management diizinkan untuk testing');
    }

    
    
    // BUKA MODAL
    const modal = document.getElementById('modalUserManagement');
    if (modal) {
        showModal('modalUserManagement');
        // LANGSUNG PANGGIL loadDataKaryawan() DI SINI
        loadDataKaryawan(); // <=== INI YANG BIKIN NOMER URUT
    } else {
        buatModalUserManagement();
    }
}

// FUNGSI 2: loadDataKaryawan() - Load data dari Firebase
async function loadDataKaryawan() {
    try {
        console.log("Memuat data karyawan...");
        
        const table = document.getElementById('tabelKaryawan');
        if (!table) return;
        
        table.innerHTML = `<tr><td colspan="7" class="text-center"><div class="spinner"></div> Memuat data...</td></tr>`;
        
        if (!globalCompanyId) {
            table.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Company ID tidak ditemukan</td></tr>`;
            return;
        }
        
        const snapshot = await db.collection('users')
            .where('company_id', '==', globalCompanyId)
            .get();
        
        console.log("Jumlah data:", snapshot.size);
        
        if (snapshot.empty) {
            table.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Belum ada data karyawan</td></tr>`;
            return;
        }
        
        let html = '';
        let counter = 1;
        
        snapshot.forEach((doc) => {
            const user = doc.data();
            
            // DATA
            const nama = user.nama || '-';
            const email = user.email || '-';
            const role = user.role || '-';
            const status = user.status || 'nonaktif';
            
            // ROLE BADGE
            let roleBadge = '';
            if (role === 'admin') {
                roleBadge = '<span class="badge badge-primary">Admin</span>';
            } else if (role === 'staff_billing') {
                roleBadge = '<span class="badge badge-success">Staff Billing</span>';
            } else if (role === 'staff_collection') {
                roleBadge = '<span class="badge badge-warning">Staff Collection</span>';
            } else if (role === 'karyawan') {
                roleBadge = '<span class="badge badge-info">Karyawan</span>';
            } else {
                roleBadge = `<span class="badge badge-secondary">${role}</span>`;
            }
            
            // STATUS BADGE
            const statusBadge = status === 'aktif' 
                ? '<span class="badge badge-success">Aktif</span>'
                : '<span class="badge badge-danger">Nonaktif</span>';
            
            // HAK AKSES
            let hakAksesText = '-';
            if (user.hak_akses) {
                const hak = user.hak_akses;
                const akses = [];
                if (hak.tagihan) akses.push('Tagihan');
                if (hak.tunggakan) akses.push('Tunggakan');
                if (hak.pelanggan) akses.push('Pelanggan');
                if (hak.paket) akses.push('Paket');
                if (hak.laporan) akses.push('Laporan');
                hakAksesText = akses.join(', ') || '-';
            }
            
            // HTML ROW
            html += `
                <tr>
                    <td style="font-weight: bold;">${counter}</td>
                    <td><strong>${nama}</strong></td>
                    <td>${email}</td>
                    <td>${roleBadge}</td>
                    <td>${statusBadge}</td>
                    <td><small>${hakAksesText}</small></td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline" onclick="editKaryawan('${doc.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="resetPassword('${doc.id}')" title="Reset Password">
                                <i class="fas fa-key"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            
            counter++;
        });
        
        table.innerHTML = html;
        
    } catch (error) {
        console.error("Error loadDataKaryawan:", error);
        showToast('error', 'Gagal', 'Gagal memuat data karyawan');
        
        const table = document.getElementById('tabelKaryawan');
        if (table) {
            table.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error: ${error.message}</td></tr>`;
        }
    }
}

// FUNGSI 3: updateStatsKaryawan() - Update statistik
async function updateStatsKaryawan() {
    try {
        const snapshot = await db.collection('users')
            .where('company_id', '==', globalCompanyId)
            .get();
        
        const total = snapshot.size;
        const adminCount = snapshot.docs.filter(doc => doc.data().role === 'admin').length;
        const staffCount = snapshot.docs.filter(doc => doc.data().role.includes('staff')).length;
        const aktifCount = snapshot.docs.filter(doc => doc.data().status === 'aktif').length;
        
        // Update elemen jika ada
        const totalEl = document.getElementById('totalKaryawan');
        const adminEl = document.getElementById('adminKaryawan');
        const staffEl = document.getElementById('staffKaryawan');
        const aktifEl = document.getElementById('aktifKaryawan');
        
        if (totalEl) totalEl.textContent = total;
        if (adminEl) adminEl.textContent = adminCount;
        if (staffEl) staffEl.textContent = staffCount;
        if (aktifEl) aktifEl.textContent = aktifCount;
        
        // Update badge di card
        const badge = document.querySelector('.setting-card [onclick="showUserManagement()"] .setting-badge');
        if (badge) {
            badge.textContent = total + ' user';
        }
        
    } catch (error) {
        console.error("Error updateStatsKaryawan:", error);
    }
}

// FUNGSI 4: buatModalUserManagement() - Buat modal jika belum ada
function buatModalUserManagement() {
    console.log("Membuat modal User Management...");
    
    const modalHTML = `
    <div class="modal-overlay hidden" id="modalUserManagement">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-user-shield"></i> User Management</h3>
                <button class="modal-close" onclick="hideModal('modalUserManagement')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <button class="btn btn-primary" onclick="tambahKaryawan()">
                        <i class="fas fa-user-plus"></i> Tambah Karyawan Baru
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Hak Akses</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tabelKaryawan">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="spinner"></div> Memuat data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalUserManagement')">Tutup</button>
            </div>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // TUNGGU MODAL RENDER, BARU LOAD DATA
    setTimeout(() => {
        showModal('modalUserManagement');
        // PANGGIL loadDataKaryawan() UNTUK ISI NOMER URUT
        if (typeof loadDataKaryawan === 'function') {
            loadDataKaryawan();
        } else {
            console.error("loadDataKaryawan() tidak ditemukan!");
        }
    }, 100);
}

// FUNGSI 5: tambahKaryawan() - Untuk tombol tambah karyawan
function tambahKaryawan() {
    console.log("tambahKaryawan() dipanggil");
    
    // 1. TUTUP MODAL USER MANAGEMENT DULU
    hideModal('modalUserManagement');
    
    // 2. BARU BUKA MODAL TAMBAH KARYAWAN
    setTimeout(() => {
        const modal = document.getElementById('modalTambahKaryawan');
        if (!modal) {
            buatModalTambahKaryawan();
        } else {
            showModal('modalTambahKaryawan');
        }
    }, 300);
}

// FUNGSI 6: buatModalTambahKaryawan() - Modal form
function buatModalTambahKaryawan() {
    const modalHTML = `
    <div class="modal-overlay hidden" id="modalTambahKaryawan">
    <div class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Tambah Karyawan</h3>
            <button class="modal-close" onclick="hideModal('modalTambahKaryawan')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formTambahKaryawan">
                <!-- NAMA & EMAIL (USERNAME) -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Nama Lengkap *</label>
                        <input type="text" class="form-control" id="karyawanNama" required>
                    </div>
                    <div class="form-group">
                        <label>Email (Username Login) *</label>
                        <input type="email" class="form-control" id="karyawanEmail" required>
                    </div>
                </div>
                
                <!-- PASSWORD -->
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" class="form-control" id="karyawanPassword" required>
                    <small class="text-muted">Minimal 6 karakter</small>
                </div>
                
                <!-- ROLE & TELEPON -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Role *</label>
                        <select class="form-control" id="karyawanRole" required>
                            <option value="staff_billing">Staff_Billing</option>
                            <option value="admin">Admin</option>
                            
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Telepon</label>
                        <input type="tel" class="form-control" id="karyawanTelepon">
                    </div>
                </div>
                
                
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalTambahKaryawan')">Batal</button>
            <button class="btn btn-primary" onclick="simpanKaryawan()">
                <i class="fas fa-save"></i> Simpan Karyawan
            </button>
        </div>
    </div>
</div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    showModal('modalTambahKaryawan');
}

// FUNGSI 7: simpanKaryawanBaru() - Save ke Firebase
// ============================================
// FUNGSI SIMPAN KARYAWAN BARU - LENGKAP & FIX
// ============================================

async function simpanKaryawanBaru() {
    console.log("🔄 FUNGSI simpanKaryawanBaru DIPANGGIL");
    
    try {
        // 1. CEK SEMUA VARIABLE PENTING
        console.log("=== DEBUG INFO ===");
        console.log("1. currentUser:", currentUser);
        console.log("2. currentUser.email:", currentUser?.email);
        console.log("3. currentUser.uid:", currentUser?.uid);
        console.log("4. globalCompanyId:", globalCompanyId);
        console.log("5. Firestore db:", db ? "TERHUBUNG" : "ERROR");
        
        // 2. JIKA globalCompanyId NULL, BUAT DARI EMAIL ADMIN
        let companyId = globalCompanyId;
        if (!companyId && currentUser && currentUser.email) {
            companyId = currentUser.email.replace(/[@.]/g, '_').toUpperCase() + "_COMPANY";
            console.log("⚠️ Buat companyId dari email:", companyId);
        }
        
        if (!companyId) {
            showToast('error', 'System Error', 
                `Tidak bisa mendapatkan Company ID.
                Admin: ${currentUser?.email || 'Tidak diketahui'}
                Silakan refresh halaman atau logout/login kembali.`);
            return;
        }
        
        // 3. AMBIL DATA DARI FORM (DENGAN ID YANG BENAR)
        console.log("=== AMBIL DATA DARI FORM ===");
        
        const nama = document.getElementById('namaKaryawan').value;
        const email = document.getElementById('emailKaryawan').value;
        const telepon = document.getElementById('teleponKaryawan').value;
        const role = document.getElementById('roleKaryawan').value;
        const password = document.getElementById('passwordKaryawan').value;
        
        console.log("Data form:", {nama, email, telepon, role, password});
        
        // 4. VALIDASI DATA
        if (!nama || !email || !telepon || !role || !password) {
            showToast('error', 'Form Kosong', 'Harap isi semua field yang wajib');
            return;
        }
        
        if (password.length < 6) {
            showToast('error', 'Password Lemah', 'Password minimal 6 karakter');
            return;
        }
        
        // 5. BUAT OBJECT DATA KARYAWAN
        const karyawanData = {
            nama: nama.trim(),
            email: email.trim().toLowerCase(),
            telepon: telepon.trim(),
            role: role,
            status: 'aktif',
            company_id: companyId, // INI YANG PASTI ADA
            created_at: new Date().toISOString(),
            created_by: currentUser.email,
            hak_akses: {
                dashboard: true,
                pelanggan: false,
                paket: false,
                tagihan: true,
                tunggakan: true,
                laporan: false,
                setting: false
            }
        };
        
        console.log("✅ Data siap disimpan:", karyawanData);
        
        // 6. TAMPILKAN LOADING
        showLoading();
        
        // 7. BUAT USER DI FIREBASE AUTH
        console.log("Membuat user di Firebase Auth...");
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(
            karyawanData.email,
            password
        );
        
        const userId = userCredential.user.uid;
        console.log("✅ User Auth dibuat, UID:", userId);
        
        // 8. SIMPAN DATA KE FIRESTORE
        karyawanData.uid = userId;
        
        console.log("Menyimpan ke Firestore collection 'users'...");
        await db.collection('users').doc(userId).set(karyawanData);
        console.log("✅ Data tersimpan di Firestore");
        
        // 9. UPDATE PROFILE DISPLAY NAME
        await userCredential.user.updateProfile({
            displayName: karyawanData.nama
        });
        
        // 10. KIRIM EMAIL VERIFIKASI (OPSIONAL)
        try {
            await userCredential.user.sendEmailVerification();
            console.log("✅ Email verifikasi dikirim");
        } catch (emailError) {
            console.log("ℹ️ Email verifikasi gagal, tapi user tetap dibuat");
        }
        
        // 11. SEMBUNYIKAN LOADING
        hideLoading();
        
        // 12. TUTUP MODAL
        hideModal('modalTambahKaryawan');
        
        // 13. TAMPILKAN SUKSES
        showToast('success', 'BERHASIL!', 
            `Karyawan "${karyawanData.nama}" berhasil ditambahkan.
            Email: ${karyawanData.email}
            Role: ${karyawanData.role}
            Company ID: ${karyawanData.company_id}`);
        
        // 14. RESET FORM
        document.getElementById('namaKaryawan').value = '';
        document.getElementById('emailKaryawan').value = '';
        document.getElementById('teleponKaryawan').value = '';
        document.getElementById('passwordKaryawan').value = '';
        
        // 15. REFRESH DATA JIKA MODAL USER MANAGEMENT MASIH TERBUKA
        setTimeout(() => {
            if (typeof loadDataKaryawan === 'function') {
                loadDataKaryawan();
            }
        }, 1000);
        
    } catch (error) {
        // ERROR HANDLING
        console.error("❌ ERROR DETAIL:", error);
        hideLoading();
        
        // ERROR MESSAGE YANG SPESIFIK
        let errorMessage = 'Gagal menambah karyawan: ';
        
        if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'Email ini sudah terdaftar di sistem';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Format email tidak valid';
        } else if (error.code === 'auth/weak-password') {
            errorMessage = 'Password terlalu lemah, minimal 6 karakter';
        } else if (error.code === 'auth/network-request-failed') {
            errorMessage = 'Koneksi internet bermasalah';
        } else if (error.code === 'permission-denied') {
            errorMessage = 'Anda tidak punya izin untuk menambah user';
        } else {
            errorMessage += error.message;
        }
        
        showToast('error', 'GAGAL', errorMessage);
    }
}

// ============================================
// FUNGSI UNTUK MEMASTIKAN company_id SELALU ADA
// ============================================

async function initCompanyId() {
    console.log("🔄 initCompanyId() dipanggil");
    
    // 1. CEK DI LOCALSTORAGE
    const savedCompanyId = localStorage.getItem('xbill_company_id');
    if (savedCompanyId) {
        console.log("✅ Company ID dari localStorage:", savedCompanyId);
        globalCompanyId = savedCompanyId;
        return savedCompanyId;
    }
    
    // 2. JIKA ADA USER LOGIN
    if (currentUser && currentUser.uid) {
        try {
            // CEK DI FIRESTORE
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            
            if (userDoc.exists) {
                const userData = userDoc.data();
                if (userData.company_id) {
                    console.log("✅ Company ID dari Firestore:", userData.company_id);
                    globalCompanyId = userData.company_id;
                    localStorage.setItem('xbill_company_id', userData.company_id);
                    return userData.company_id;
                }
            }
            
            // BUAT BARU JIKA TIDAK ADA
            const newCompanyId = `COMP_${Date.now()}_${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
            console.log("🆕 Buat Company ID baru:", newCompanyId);
            
            // SIMPAN KE FIRESTORE
            await db.collection('users').doc(currentUser.uid).set({
                uid: currentUser.uid,
                email: currentUser.email,
                nama: currentUser.displayName || currentUser.email.split('@')[0],
                company_id: newCompanyId,
                role: 'admin',
                created_at: new Date().toISOString(),
                status: 'aktif'
            }, { merge: true });
            
            // SIMPAN KE VARIABLE & LOCALSTORAGE
            globalCompanyId = newCompanyId;
            localStorage.setItem('xbill_company_id', newCompanyId);
            
            return newCompanyId;
            
        } catch (error) {
            console.error("❌ Error initCompanyId:", error);
            
            // FALLBACK: BUAT DARI EMAIL
            const fallbackCompanyId = currentUser.email.replace(/[@.]/g, '_').toUpperCase() + "_COMPANY";
            globalCompanyId = fallbackCompanyId;
            localStorage.setItem('xbill_company_id', fallbackCompanyId);
            
            return fallbackCompanyId;
        }
    }
    
    console.error("❌ Tidak ada user login");
    return null;
}

// ============================================
// PANGGIL initCompanyId() SETELAH LOGIN
// ============================================

// Di dalam firebase.auth().onAuthStateChanged:
firebase.auth().onAuthStateChanged(async function(user) {
    if (user) {
        console.log("✅ Auth State Changed: User login", user.email);
        
        // AMBIL DATA USER DARI FIRESTORE UNTUK MENDAPAT ROLE YANG BENAR
        try {
            const userDocRef = db.collection('users').doc(user.uid);
            const userDoc = await userDocRef.get();

            let userRole = 'admin'; // Default

            if (userDoc.exists) {
                const userData = userDoc.data();
                userRole = userData.role || 'admin';
                console.log("✅ Role dari Database:", userRole);
                
                // Ambil Company ID juga
                globalCompanyId = userData.company_id;
            } else {
                console.warn("⚠️ Data user Firestore kosong, gunakan default.");
            }

            // SIMPAN KE GLOBAL & LOCALSTORAGE
            currentUser = {
                uid: user.uid,
                name: user.displayName || user.email.split('@')[0],
                email: user.email,
                role: userRole // Menggunakan role dari database
            };

            localStorage.setItem('xbill_user', JSON.stringify(currentUser));
            localStorage.setItem('userRole', userRole);
            localStorage.setItem('userName', currentUser.name);

            // SHOW APP
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');

            // Update UI Navbar
            if (document.getElementById('userName')) document.getElementById('userName').textContent = currentUser.name;
            if (document.getElementById('userRole')) document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'Administrator' : currentUser.role.toUpperCase();

            // Load Dashboard
            await loadPage('dashboard');
            
        } catch (error) {
            console.error("Error saat load user data onAuthChanged:", error);
            // Fallback ke admin jika error
            currentUser.role = 'admin';
        }
        
    } else {
        // User Logout
        console.log("User logout");
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('appContainer').classList.add('hidden');
    }
});


// FUNGSI 8: editKaryawan() - Edit data karyawan
function editKaryawan(userId) {
    console.log("Edit karyawan:", userId);
    showToast('info', 'Edit', 'Fitur edit dalam pengembangan');
}

// FUNGSI 9: resetPassword() - Reset password
async function resetPassword(userId) {
    if (!confirm('Reset password karyawan ini?')) return;
    
    try {
        showLoading();
        
        // Generate password baru
        const newPassword = Math.random().toString(36).slice(-8);
        
        // TODO: Implement reset password via Cloud Functions
        
        hideLoading();
        showToast('success', 'Berhasil', 'Password telah direset: ' + newPassword);
        
    } catch (error) {
        hideLoading();
        console.error("Error resetPassword:", error);
        showToast('error', 'Gagal', 'Gagal reset password');
    }
}

// ============================================
// 10. API & INTEGRATION
// ============================================
async function showAPISettings() {
    // Simulasi: Ambil API Key dari localStorage
    const currentKey = localStorage.getItem('xbill_api_key') || "";
    
    const newKey = prompt("Masukkan API Key Integrasi:", currentKey);
    
    if (newKey !== null) {
        localStorage.setItem('xbill_api_key', newKey);
        showToast('success', 'Berhasil', 'API Key berhasil disimpan.');
    }
}

// ============================================
// 11. LOGS & AUDIT
// ============================================
async function showLogsAudit() {
    try {
        showToast('info', 'Memuat Logs...', 'Mengambil riwayat aktivitas.');
        
        const snapshot = await db.collection('aktivitas').orderBy('timestamp', 'desc').limit(50).get();
        
        let logHtml = '<h4 style="margin-bottom:15px;">Riwayat Aktivitas (50 Terakhir)</h4>';
        logHtml += '<div style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px;">';
        
        if (snapshot.empty) {
            logHtml += '<p class="text-muted">Belum ada aktivitas.</p>';
        } else {
            logHtml += '<table class="table" style="font-size:12px; margin-bottom:0;">';
            logHtml += '<thead><tr><th>Waktu</th><th>Aktivitas</th><th>User</th></tr></thead><tbody>';
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const time = moment(data.timestamp).format('DD/MM HH:mm');
                logHtml += `<tr><td>${time}</td><td>${data.aktivitas}</td><td>${data.user}</td></tr>`;
            });
            
            logHtml += '</tbody></table>';
        }
        
        logHtml += '</div>';

        // Tampilkan di Modal (Buat modal dinamis jika belum ada)
        let modal = document.getElementById('modalLogsAudit');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'modalLogsAudit';
            modal.className = 'modal-overlay show';
            modal.style.zIndex = '10000';
            modal.innerHTML = `
                <div class="modal modal-lg">
                    <div class="modal-header">
                        <h3 class="modal-title">Logs & Audit Trail</h3>
                        <button class="modal-close" onclick="document.getElementById('modalLogsAudit').remove()">&times;</button>
                    </div>
                    <div class="modal-body" id="logsContent">${logHtml}</div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="document.getElementById('modalLogsAudit').remove()">Tutup</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        } else {
            const content = document.getElementById('logsContent');
            if(content) content.innerHTML = logHtml;
            modal.classList.remove('hidden');
            modal.classList.add('show');
        }
        
    } catch (error) {
        console.error("Error load logs:", error);
        showToast('error', 'Gagal', 'Gagal memuat logs.');
    }
}

// ============================================
// 12. TENTANG APLIKASI
// ============================================
async function showAboutInfo() {
    let modal = document.getElementById('modalAboutInfo');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modalAboutInfo';
        modal.className = 'modal-overlay show';
        modal.innerHTML = `
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Tentang Aplikasi</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </div>
                <div class="modal-body" style="text-align: center;">
                    <h2 style="color: var(--primary);">X-BILL v2.1.0</h2>
                    <p>Billing Management System untuk ISP</p>
                    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                    <p>Developed by <strong>Your Team Name</strong></p>
                    <p>&copy; 2024 X-BILL Systems.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Tutup</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    } else {
        modal.classList.remove('hidden');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
}


// ==========================================
// FUNGSI TUTUP MODAL (ANTI-LOOP & ANTI-ERROR)
// ==========================================

function forceCloseModal(modalIdOrElement) {
    // 1. Normalisasi Input: Bisa berupa String ID atau Element HTML
    let modalEl = modalIdOrElement;

    // Jika input string (ID), cari elemennya
    if (typeof modalEl === 'string') {
        modalEl = document.getElementById(modalIdOrElement);
    }

    // 2. Validasi: Jika elemen tidak ditemukan
    if (!modalEl) {
        console.warn(`⚠️ Modal tidak ditemukan: ${modalIdOrElement}`);
        return; // Stop, jangan lanjut agar tidak error
    }

    // 3. Lakukan Penutupan
    try {
        // Hapus class show
        modalEl.classList.remove('show');
        // Tambah class hidden (sesuai CSS Anda)
        modalEl.classList.add('hidden');
        // Reset display style ke none (agar benar-benar hilang)
        modalEl.style.display = 'none';
        
        // Opsional: Jika modal dinamis buatan JS (bukan static di HTML), hapus dari DOM
        // Tapi karena ID Anda statis ('modalCompanyProfile'), kita cukup hide saja.
        
        console.log(`🔒 Modal ditutup: ${modalEl.id || 'Unknown ID'}`);
        
    } catch (error) {
        console.error("❌ Error saat menutup modal:", error);
    } finally {
        // 4. Selalu pastikan body scroll kembali aktif (terlepas dari error di atas)
        document.body.style.overflow = 'auto';
    }
}


// ============================================
// SISTEM KARYAWAN - FIX
// ============================================

// A. MODAL HTML UNTUK KARYAWAN (Tambahkan sebelum )
const karyawanModalHTML = `
<!-- MODAL: TAMBAH KARYAWAN -->
<div class="modal-overlay hidden" id="modalTambahKaryawan">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-user-plus"></i> Tambah Karyawan Baru</h3>
            <button class="modal-close" onclick="hideModal('modalTambahKaryawan')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formTambahKaryawan">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nama Lengkap *</label>
                        <input type="text" class="form-control" id="namaKaryawan" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" class="form-control" id="emailKaryawan" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Telepon *</label>
                        <input type="text" class="form-control" id="teleponKaryawan" required>
                    </div>
                    <div class="form-group">
                        <label>Role *</label>
                        <select class="form-control" id="roleKaryawan" required>
                            <option value="staff_billing">Staff Billing</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Password Sementara *</label>
                    <input type="password" class="form-control" id="passwordKaryawan" required>
                    <small class="text-muted">Password untuk login pertama kali</small>
                </div>
                
                <div class="form-group">
                    <label>Hak Akses</label>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="aksesTagihan" checked disabled>
                        <label class="form-check-label">Tagihan (Wajib)</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="aksesTunggakan" checked>
                        <label class="form-check-label">Tunggakan</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="aksesPelanggan">
                        <label class="form-check-label">Data Pelanggan (View Only)</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="aksesDashboard">
                        <label class="form-check-label">Dashboard (View Only)</label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
           <div class="modal-footer">
    <button class="btn btn-outline" onclick="kembaliKeUserManagement()">Batal</button>
    <button class="btn btn-primary" onclick="simpanKaryawanBaru()">Simpan</button>
</div>
        </div>
    </div>
</div>
`;

// B. TAMBAHKAN MODAL KE DOM
document.addEventListener('DOMContentLoaded', function() {
    document.body.insertAdjacentHTML('beforeend', karyawanModalHTML);
});



// D. FUNGSI UNTUK MEMBUKA MODAL TAMBAH KARYAWAN
function bukaModalTambahKaryawan() {
    // Reset form
    document.getElementById('formTambahKaryawan').reset();
    
    // Set nilai default
    document.getElementById('aksesTagihan').checked = true;
    document.getElementById('aksesTunggakan').checked = true;
    document.getElementById('aksesPelanggan').checked = false;
    document.getElementById('aksesDashboard').checked = false;
    
    showModal('modalTambahKaryawan');
}


// ============================================
// INISIALISASI EVENT LISTENER - TAMBAHKAN INI
// ============================================

// Tunggu DOM siap



async function getSettingHTML() {
    const currentRole = currentUser ? currentUser.role : 'admin';
    console.log("⚙️ Load Page: Setting. Role:", currentRole);

    // Template HTML Setting
    let settingsHTML = `
        <div class="page setting-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-cog"></i> System Settings</h2>
            </div>
            
            <!-- SETTING MENU GRID -->
            <div class="settings-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); gap: 20px;">
                
                <!-- CARD 1: PROFIL PERUSAHAAN (HANYA UNTUK ADMIN) -->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showCompanyProfile()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Profil Perusahaan</h3>
                        <p>Kelola data perusahaan, alamat, kontak, dan informasi bisnis</p>
                        <div class="setting-badge">Pengaturan Dasar</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 2: LOGO & BRANDING (HANYA UNTUK ADMIN) -->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showBrandingSettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-palette"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Logo & Branding</h3>
                        <p>Custom logo, warna tema, font, dan tampilan aplikasi</p>
                        <div class="setting-badge">UI/UX</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 3: KONTAK & NOTIFIKASI (HANYA UNTUK ADMIN) -->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showContactSettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-phone-alt"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Kontak & Notifikasi</h3>
                        <p>WhatsApp, Email, SMS, dan pengaturan notifikasi</p>
                        <div class="setting-badge">Komunikasi</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 4: TEMPLATE PESAN (HANYA UNTUK ADMIN) -->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showMessageTemplates()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-comment-alt"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Template Pesan</h3>
                        <p>Custom template untuk reminder, invoice, dan notifikasi</p>
                        <div class="setting-badge">Marketing</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 5: KEUANGAN & PAJAK (HANYA UNTUK ADMIN) -->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showFinancialSettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Keuangan & Pajak</h3>
                        <p>PPN, denda, metode pembayaran, dan laporan keuangan</p>
                        <div class="setting-badge">Financial</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 6: KEAMANAN & AKSES (UNTUK ADMIN & STAFF) -->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showUserManagement()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);">
                        <i class="fas fa-users-cog"></i>
                    </div>
                    <div class="setting-content">
                        <h3>User Management</h3>
                        <p>Kelola pengguna dan hak akses ke sistem</p>
                        <span class="setting-badge">Admin Only</span>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 7: KEAMANAN (GANTI PASSWORD) - UNTUK SEMUA ROLE -->
                <div class="setting-card" onclick="showSecuritySettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Keamanan & Akses</h3>
                        <p>Ganti password dan pengaturan keamanan akun Anda</p>
                        <div class="setting-badge">Security</div>
                    </div>
                </div>
                
                <!-- CARD 8: BACKUP & RESTORE (HANYA UNTUK ADMIN) -->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showBackupSettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #5ee7df 0%, #b490ca 100%);">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Backup & Restore</h3>
                        <p>Auto-backup, restore data, dan management database</p>
                        <div class="setting-badge">Data</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 9: SYSTEM SETTINGS (HANYA UNTUK ADMIN) -->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showSystemSettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);">
                        <i class="fas fa-sliders-h"></i>
                    </div>
                    <div class="setting-content">
                        <h3>System Settings</h3>
                        <p>Timezone, bahasa, format tanggal, dan pengaturan sistem</p>
                        <div class="setting-badge">System</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 10: API & INTEGRATION (HANYA UNTUK ADMIN) -->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showAPISettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);">
                        <i class="fas fa-code"></i>
                    </div>
                    <div class="setting-content">
                        <h3>API & Integration</h3>
                        <p>API keys, webhooks, dan integrasi dengan sistem lain</p>
                        <div class="setting-badge">Developer</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 11: LOGS & AUDIT (HANYA UNTUK ADMIN) -->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showLogsAudit()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Logs & Audit</h3>
                        <p>Activity logs, audit trail, dan monitoring sistem</p>
                        <div class="setting-badge">Monitoring</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 12: TENTANG APLIKASI -->
                <div class="setting-card" onclick="showAboutInfo()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%);">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Tentang Aplikasi</h3>
                        <p>Versi, update, credits, dan informasi sistem</p>
                        <div class="setting-badge">Info</div>
                    </div>
                </div>
                
            </div>
            
            <!-- QUICK SETTINGS PANEL (HANYA UNTUK ADMIN) -->
            ${currentRole === 'admin' ? `
            <div class="card" style="margin-top: 30px;">
                <div class="card-header">
                    <h3><i class="fas fa-bolt"></i> Quick Settings</h3>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                        <!-- Tombol Quick Settings Admin... -->
                        <!-- (Isi sesuai kode asli Anda) -->
                    </div>
                </div>
            </div>
            ` : ''}
            
            <!-- SYSTEM STATUS (UNTUK SEMUA) -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h3><i class="fas fa-chart-line"></i> System Status</h3>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 15px;">
                        <div class="status-item">
                            <div class="status-label">Database</div>
                            <div class="status-value" style="color: #00b894;">
                                <i class="fas fa-check-circle"></i> Connected
                             </div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Storage</div>
                            <div class="status-value" style="color: #4361ee;">
                                <i class="fas fa-hdd"></i> 2.4 GB / 5 GB
                             </div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">App Version</div>
                            <div class="status-value" id="appVersion">v2.1.0</div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    `;

    return settingsHTML;
}





// ============================================
// FUNGSI SAVE UNTUK MODAL SETTING
// ============================================

// 1. SIMPAN PROFIL PERUSAHAAN
async function saveCompanyProfile() {
    try {
        const formData = {
            companyName: document.getElementById('companyName').value,
            companyTagline: document.getElementById('companyTagline').value,
            companyAddress: document.getElementById('companyAddress').value,
            companyPhone: document.getElementById('companyPhone').value,
            companyEmail: document.getElementById('companyEmail').value,
            companyWebsite: document.getElementById('companyWebsite').value,
            companyNPWP: document.getElementById('companyNPWP').value,
            companyDirector: document.getElementById('companyDirector').value,
            companyType: document.getElementById('companyType').value,
            invoicePrefix: document.getElementById('invoicePrefix').value,
            invoiceFooter: document.getElementById('invoiceFooter').value,
            invoiceTerms: document.getElementById('invoiceTerms').value,
            updated_at: new Date().toISOString()
        };

        // Validasi
        if (!formData.companyName || !formData.companyAddress || !formData.companyPhone) {
            showToast('error', 'Validasi Gagal', 'Harap isi field yang wajib diisi (*)');
            return;
        }

        showLoading();

        // Simpan ke Firebase
        await db.collection('company_settings').doc('profile').set(formData, { merge: true });

        // Update UI
        const navEl = document.getElementById('companyNameNav');
        if (navEl) {
            navEl.innerText = formData.companyName; // ⭐ Ganti textContent dengan innerText
            // Paksa re-render untuk mobile
            navEl.style.display = 'none';
            navEl.offsetHeight;
            navEl.style.display = '';
        }
        
        const dropdownNameEl = document.getElementById('dropdownCompanyName');
        if (dropdownNameEl) dropdownNameEl.textContent = formData.companyName;
        
        const dropdownTaglineEl = document.getElementById('dropdownCompanyTagline');
        if (dropdownTaglineEl) dropdownTaglineEl.textContent = formData.companyTagline || 'Billing Management System';

        hideLoading();
        showToast('success', 'Berhasil', 'Profil perusahaan berhasil disimpan');
        hideModal('modalCompanyProfile');

    } catch (error) {
        hideLoading();
        console.error("Error save company profile:", error);
        showToast('error', 'Gagal', 'Gagal menyimpan profil: ' + error.message);
    }
}

// 2. SIMPAN BRANDING & LOGO (PERBAIKAN)
async function saveBranding() {
    try {
        const formData = {
            primaryColor: document.getElementById('primaryColor').value,
            secondaryColor: document.getElementById('secondaryColor').value,
            dashboardTheme: document.querySelector('input[name="dashboardTheme"]:checked').value,
            mainFont: document.getElementById('mainFont').value,
            fontSize: document.getElementById('fontSize').value,
            updated_at: new Date().toISOString()
        };

        // --- BAGIAN BARU: PROSES LOGO ---
        const logoInput = document.getElementById('logoUpload');
        
        if (logoInput.files && logoInput.files[0]) {
            const file = logoInput.files[0];
            
            // Validasi tipe file
            if (!file.type.match('image.*')) {
                showToast('error', 'Format Salah', 'File harus berupa gambar (JPG/PNG).');
                return;
            }

            // Validasi ukuran (Max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('error', 'File Terlalu Besar', 'Maksimal ukuran logo 2MB.');
                return;
            }

            showLoading();
            showToast('info', 'Sedang Memproses', 'Mengupload logo...');

            // Ubah file gambar jadi string Base64 menggunakan FileReader
            const reader = new FileReader();
            
            reader.onload = function(e) {
                // Hasil konversi base64 ada di e.target.result
                // Simpan ke formData
                formData.logo = e.target.result; 
                
                // Lanjutkan simpan ke Firebase setelah logo selesai diproses
                simpanKeFirebase(formData);
            };
            
            reader.onerror = function() {
                hideLoading();
                showToast('error', 'Gagal', 'Gagal membaca file gambar.');
            };

            // Mulai membaca file
            reader.readAsDataURL(file);

        } else {
            // Jika tidak ada file logo baru dipilih, hanya simpan setting warna/font
            showLoading();
            simpanKeFirebase(formData);
        }

    } catch (error) {
        hideLoading();
        console.error("Error save branding:", error);
        showToast('error', 'Gagal', 'Gagal menyimpan branding: ' + error.message);
    }
}

// Fungsi Helper untuk simpan ke Firebase (Dipisah agar rapi)
async function simpanKeFirebase(data) {
    try {
        // Simpan ke Firestore
        await db.collection('company_settings').doc('branding').set(data, { merge: true });

        // Terapkan perubahan ke UI
        applyBrandingStyles(data);

        hideLoading();
        hideModal('modalBranding');
        showToast('success', 'Berhasil', 'Branding & Logo berhasil disimpan!');
        
        // Refresh tampilan logo di modal agar langsung muncul
        setTimeout(() => {
            showBrandingSettings();
        }, 500);

    } catch (error) {
        hideLoading();
        console.error("Error simpan ke firebase:", error);
        showToast('error', 'Gagal', 'Gagal menyimpan ke database: ' + error.message);
    }
}

// Fungsi untuk menerapkan styling branding
function applyBrandingStyles(settings) {
    const root = document.documentElement;
    
    if (settings.primaryColor) {
        root.style.setProperty('--primary', settings.primaryColor);
    }
    if (settings.secondaryColor) {
        root.style.setProperty('--secondary', settings.secondaryColor);
    }
    if (settings.mainFont) {
        document.body.style.fontFamily = settings.mainFont;
    }
    if (settings.fontSize) {
        document.body.style.fontSize = settings.fontSize;
    }
    
    // Terapkan tema
    if (settings.dashboardTheme === 'dark') {
        document.body.classList.add('dark-mode');
    } else if (settings.dashboardTheme === 'light') {
        document.body.classList.remove('dark-mode');
    } else {
        // Auto mode - ikuti sistem
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
    }
}

// 3. PREVIEW LOGO
function previewLogo(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const preview = document.getElementById('logoPreview');
            preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;border-radius:10px;object-fit:cover;">`;
        };
        
        reader.readAsDataURL(input.files[0]);
    }
}

// 4. SIMPAN KONTAK & NOTIFIKASI
async function saveContactSettings() {
    try {
        const formData = {
            // WhatsApp
            whatsappNumber: document.getElementById('whatsappNumber').value,
            whatsappApiKey: document.getElementById('whatsappApiKey').value,
            enableWhatsApp: document.getElementById('enableWhatsApp').checked,
            
            // Email
            smtpHost: document.getElementById('smtpHost').value,
            smtpPort: document.getElementById('smtpPort').value,
            smtpEmail: document.getElementById('smtpEmail').value,
            smtpPassword: document.getElementById('smtpPassword').value,
            enableSSL: document.getElementById('enableSSL').checked,
            
            // SMS Gateway
            smsProvider: document.getElementById('smsProvider').value,
            smsApiKey: document.getElementById('smsApiKey').value,
            smsSecret: document.getElementById('smsSecret').value,
            enableSMS: document.getElementById('enableSMS').checked,
            
            // Notifikasi
            notifNewCustomer: document.getElementById('notifNewCustomer').checked,
            notifPayment: document.getElementById('notifPayment').checked,
            notifOverdue: document.getElementById('notifOverdue').checked,
            reminder3Days: document.getElementById('reminder3Days').checked,
            reminder1Day: document.getElementById('reminder1Day').checked,
            reminderOverdue: document.getElementById('reminderOverdue').checked,
            
            updated_at: new Date().toISOString()
        };

        // Validasi WhatsApp jika diaktifkan
        if (formData.enableWhatsApp && !formData.whatsappNumber) {
            showToast('error', 'Validasi Gagal', 'Nomor WhatsApp wajib diisi jika WhatsApp diaktifkan');
            return;
        }

        showLoading();

        // Simpan ke Firebase
        await db.collection('company_settings').doc('contact').set(formData, { merge: true });

        hideLoading();
        hideModal('modalContactSettings');
        showToast('success', 'Berhasil', 'Pengaturan kontak berhasil disimpan');

    } catch (error) {
        hideLoading();
        console.error("Error save contact settings:", error);
        showToast('error', 'Gagal', 'Gagal menyimpan pengaturan: ' + error.message);
    }
}

// 5. TEST NOTIFIKASI
async function testNotification() {
    try {
        showLoading();
        
        // Ambil pengaturan kontak
        const contactDoc = await db.collection('company_settings').doc('contact').get();
        const contactData = contactDoc.exists ? contactDoc.data() : {};
        
        // Simulasikan pengiriman notifikasi
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        hideLoading();
        
        if (contactData.enableWhatsApp && contactData.whatsappNumber) {
            showToast('success', 'Test Berhasil', `Notifikasi test terkirim ke ${contactData.whatsappNumber}`);
        } else {
            showToast('info', 'Test Simulasi', 'Notifikasi test berhasil disimulasikan (mode offline)');
        }

    } catch (error) {
        hideLoading();
        console.error("Error test notification:", error);
        showToast('error', 'Gagal', 'Gagal mengirim test: ' + error.message);
    }
}

// 6. GANTI PASSWORD
async function changePassword() {
    try {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // Validasi
        if (!currentPassword || !newPassword || !confirmPassword) {
            showToast('error', 'Validasi Gagal', 'Harap isi semua field password');
            return;
        }

        if (newPassword !== confirmPassword) {
            showToast('error', 'Validasi Gagal', 'Password baru tidak cocok');
            return;
        }

        if (newPassword.length < 8) {
            showToast('error', 'Validasi Gagal', 'Password minimal 8 karakter');
            return;
        }

        showLoading();

        // Re-authenticate user
        const user = firebase.auth().currentUser;
        const credential = firebase.auth.EmailAuthProvider.credential(
            user.email,
            currentPassword
        );

        await user.reauthenticateWithCredential(credential);
        
        // Update password
        await user.updatePassword(newPassword);
        
        // Log aktivitas
        await db.collection('aktivitas').add({
            aktivitas: 'User mengganti password',
            user: getUserLogName(),
            timestamp: new Date().toISOString()
        });

        hideLoading();
        hideModal('modalChangePassword');
        showToast('success', 'Berhasil', 'Password berhasil diubah');

        // Clear form
        document.getElementById('formChangePassword').reset();

    } catch (error) {
        hideLoading();
        console.error("Error change password:", error);
        
        if (error.code === 'auth/wrong-password') {
            showToast('error', 'Gagal', 'Password saat ini salah');
        } else if (error.code === 'auth/weak-password') {
            showToast('error', 'Gagal', 'Password terlalu lemah');
        } else {
            showToast('error', 'Gagal', 'Gagal mengubah password: ' + error.message);
        }
    }
}

// 7. VALIDASI PASSWORD (real-time)
function validatePasswordStrength() {
    const password = document.getElementById('newPassword').value;
    const strengthBar = document.getElementById('passwordStrength');
    const tipsElement = document.getElementById('passwordTips');
    
    if (!password) {
        strengthBar.style.width = '0%';
        strengthBar.style.background = '#ddd';
        tipsElement.textContent = '';
        return;
    }

    let strength = 0;
    let tips = [];

    // Kriteria password
    if (password.length >= 8) strength += 25;
    if (/[a-z]/.test(password)) strength += 25;
    if (/[A-Z]/.test(password)) strength += 25;
    if (/[0-9]/.test(password)) strength += 15;
    if (/[^A-Za-z0-9]/.test(password)) strength += 10;

    // Warna berdasarkan strength
    let color = '#ff6b6b'; // merah
    if (strength >= 50) color = '#fdcb6e'; // kuning
    if (strength >= 75) color = '#00b894'; // hijau

    strengthBar.style.width = strength + '%';
    strengthBar.style.background = color;

    // Tips
    if (password.length < 8) tips.push('Minimal 8 karakter');
    if (!/[a-z]/.test(password)) tips.push('Tambahkan huruf kecil');
    if (!/[A-Z]/.test(password)) tips.push('Tambahkan huruf besar');
    if (!/[0-9]/.test(password)) tips.push('Tambahkan angka');
    if (!/[^A-Za-z0-9]/.test(password)) tips.push('Tambahkan simbol');

    tipsElement.textContent = tips.length > 0 ? tips.join(', ') : 'Password kuat!';
}

// 8. CHECK PASSWORD MATCH
function checkPasswordMatch() {
    const password = document.getElementById('newPassword').value;
    const confirm = document.getElementById('confirmPassword').value;
    const matchDiv = document.getElementById('passwordMatch');
    const mismatchDiv = document.getElementById('passwordMismatch');

    if (!confirm) {
        matchDiv.style.display = 'none';
        mismatchDiv.style.display = 'none';
        return;
    }

    if (password === confirm) {
        matchDiv.style.display = 'block';
        mismatchDiv.style.display = 'none';
    } else {
        matchDiv.style.display = 'none';
        mismatchDiv.style.display = 'block';
    }
}

// 9. SIMPAN PROFIL USER
async function saveUserProfile() {
    try {
        const formData = {
            fullName: document.getElementById('userFullName').value,
            username: document.getElementById('userUsername').value,
            email: document.getElementById('userEmail').value,
            phone: document.getElementById('userPhone').value,
            address: document.getElementById('userAddress').value,
            bio: document.getElementById('userBio').value,
            updated_at: new Date().toISOString()
        };

        // Validasi
        if (!formData.fullName || !formData.username) {
            showToast('error', 'Validasi Gagal', 'Nama lengkap dan username wajib diisi');
            return;
        }

        showLoading();

        // Update di Firebase Auth
        const user = firebase.auth().currentUser;
        await user.updateProfile({
            displayName: formData.fullName
        });

        // Update di Firestore
        await db.collection('users').doc(user.uid).set(formData, { merge: true });

        // Update UI
        if (document.getElementById('userName')) {
            document.getElementById('userName').textContent = formData.fullName;
        }
        
        if (document.getElementById('userAvatar')) {
            const initials = formData.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('userAvatar').textContent = initials;
        }

        hideLoading();
        hideModal('modalUserProfile');
        showToast('success', 'Berhasil', 'Profil berhasil disimpan');

    } catch (error) {
        hideLoading();
        console.error("Error save user profile:", error);
        showToast('error', 'Gagal', 'Gagal menyimpan profil: ' + error.message);
    }
}

// 10. UPLOAD FOTO PROFIL
function uploadUserPhoto(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validasi ukuran file (max 2MB)
        if (file.size > 2 * 1024 * 1024) {
            showToast('error', 'File Terlalu Besar', 'Maksimal ukuran file 2MB');
            return;
        }

        // Validasi tipe file
        if (!file.type.match('image.*')) {
            showToast('error', 'Format Tidak Valid', 'Hanya file gambar yang diperbolehkan');
            return;
        }

        const reader = new FileReader();
        
        reader.onload = function(e) {
            const preview = document.getElementById('userPhotoPreview');
            const img = document.getElementById('userPhotoImg');
            const initials = document.getElementById('userInitials');
            
            img.src = e.target.result;
            img.style.display = 'block';
            initials.style.display = 'none';
            
            showToast('success', 'Berhasil', 'Foto profil berhasil diupload');
        };
        
        reader.readAsDataURL(file);
    }
}

// 11. SIMPAN TEMPLATE PESAN
async function saveMessageTemplates() {
    try {
        const formData = {
            // Reminder
            templateReminder3Days: document.getElementById('templateReminder3Days').value,
            templateReminder1Day: document.getElementById('templateReminder1Day').value,
            templateOverdue: document.getElementById('templateOverdue').value,
            
            // Konfirmasi
            templatePaymentConfirmed: document.getElementById('templatePaymentConfirmed').value,
            templateNewInvoice: document.getElementById('templateNewInvoice').value,
            
            updated_at: new Date().toISOString()
        };

        showLoading();

        // Simpan ke Firebase
        await db.collection('company_settings').doc('templates').set(formData, { merge: true });

        hideLoading();
        hideModal('modalMessageTemplates');
        showToast('success', 'Berhasil', 'Template pesan berhasil disimpan');

    } catch (error) {
        hideLoading();
        console.error("Error save templates:", error);
        showToast('error', 'Gagal', 'Gagal menyimpan template: ' + error.message);
    }
}

// 12. LOAD DATA SETTING SAAT MODAL DIBUKA
async function loadCompanyProfile() {
    try {
        const doc = await db.collection('company_settings').doc('profile').get();
        
        if (!doc.exists) return;
        
        const data = doc.data();
        const companyName = data.companyName;
        const companyAddress = data.companyAddress || 'Jl. Internet Cepat No. 1';
        
        if (!companyName) return;
        
        localStorage.setItem('companyName', companyName);
        localStorage.setItem('companyAddress', companyAddress);
        
        const navElement = document.getElementById('companyNameNav');
        if (navElement) navElement.textContent = companyName;
        
        const dropdownElement = document.getElementById('dropdownCompanyName');
        if (dropdownElement) dropdownElement.textContent = companyName;
        
        document.querySelectorAll('.company-name').forEach(element => {
            element.textContent = companyName;
        });
        
        document.querySelectorAll('[data-company-name]').forEach(element => {
            element.textContent = companyName;
        });
        
        window.namaPerusahaan = companyName;
        window.alamatPerusahaan = companyAddress;
        
    } catch (error) {
        console.error(error);
    }
}

function updateNavbarTime() {
    const timeElement = document.getElementById('currentTime');
    if (timeElement) {
        const now = moment();
        timeElement.textContent = now.format('DD/MM/YYYY HH:mm');
    }
}

// UPDATE SETIAP MENIT (60.000 ms)
setInterval(updateNavbarTime, 60000);

// PANGGIL PERTAMA KALI
updateNavbarTime();


async function loadBrandingSettings() {
    try {
        const doc = await db.collection('company_settings').doc('branding').get();
        
        if (doc.exists) {
            const data = doc.data();
            
            // Isi form
            document.getElementById('primaryColor').value = data.primaryColor || '#4361ee';
            document.getElementById('secondaryColor').value = data.secondaryColor || '#7209b7';
            
            // Set radio button
            const theme = data.dashboardTheme || 'light';
            document.getElementById(`theme${theme.charAt(0).toUpperCase() + theme.slice(1)}`).checked = true;
            
            document.getElementById('mainFont').value = data.mainFont || "'Segoe UI', system-ui";
            document.getElementById('fontSize').value = data.fontSize || '16px';
            
            // Terapkan langsung
            applyBrandingStyles(data);
        }
    } catch (error) {
        console.error("Error load branding:", error);
    }
}

// ============================================
// EVENT LISTENER UNTUK MODAL SETTING
// ============================================

// Tambahkan event listener untuk modal setting saat dibuka
document.addEventListener('DOMContentLoaded', function() {
    // Event untuk modal profil perusahaan
    document.addEventListener('click', function(e) {
        if (e.target.closest && e.target.closest('[onclick*="showCompanyProfile"]')) {
            setTimeout(loadCompanyProfile, 100);
        }
        
        if (e.target.closest && e.target.closest('[onclick*="showBrandingModal"]')) {
            setTimeout(loadBrandingSettings, 100);
        }
        
        if (e.target.closest && e.target.closest('[onclick*="showUserProfile"]')) {
            setTimeout(loadUserProfile, 100);
        }
    });
    
    // Event untuk validasi password real-time
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    
    if (newPasswordInput) {
        newPasswordInput.addEventListener('input', function() {
            validatePasswordStrength();
            checkPasswordMatch();
        });
    }
    
    if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', checkPasswordMatch);
    }
});


function kembaliKeUserManagement() {
    hideModal('modalTambahKaryawan');
    setTimeout(() => {
        showModal('modalUserManagement');
    }, 300);
}

// ============================================
// FUNGSI TAMBAHAN UNTUK LOAD DATA USER
// ============================================

async function loadUserProfile() {
    try {
        const user = firebase.auth().currentUser;
        if (!user) return;

        const doc = await db.collection('users').doc(user.uid).get();
        
        if (doc.exists) {
            const data = doc.data();
            
            // Isi form
            document.getElementById('userFullName').value = data.fullName || user.displayName || '';
            document.getElementById('userUsername').value = data.username || user.email?.split('@')[0] || '';
            document.getElementById('userEmail').value = data.email || user.email || '';
            document.getElementById('userPhone').value = data.phone || '';
            document.getElementById('userAddress').value = data.address || '';
            document.getElementById('userBio').value = data.bio || '';
            
            // Data readonly
            document.getElementById('userRoleInput').value = data.role || 'Admin';
            document.getElementById('userJoinDate').value = user.metadata.creationTime 
                ? moment(user.metadata.creationTime).format('DD MMMM YYYY')
                : moment().format('DD MMMM YYYY');
            
            // Set avatar
            const avatar = document.getElementById('userAvatar');
            const initials = document.getElementById('userInitials');
            if (data.fullName) {
                const avatarInitials = data.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
                if (avatar) avatar.textContent = avatarInitials;
                if (initials) initials.textContent = avatarInitials;
            }
        } else {
            // Data default jika belum ada
            document.getElementById('userFullName').value = user.displayName || '';
            document.getElementById('userUsername').value = user.email?.split('@')[0] || '';
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userRoleInput').value = 'Admin';
            document.getElementById('userJoinDate').value = user.metadata.creationTime 
                ? moment(user.metadata.creationTime).format('DD MMMM YYYY')
                : moment().format('DD MMMM YYYY');
            
            // Set avatar default
            const avatar = document.getElementById('userAvatar');
            const initials = document.getElementById('userInitials');
            if (user.displayName) {
                const avatarInitials = user.displayName.split(' ').map(n => n[0]).join('').toUpperCase();
                if (avatar) avatar.textContent = avatarInitials;
                if (initials) initials.textContent = avatarInitials;
            }
        }
    } catch (error) {
        console.error("Error load user profile:", error);
    }
}




// FUNGSI CEK PERMISSION
function cekAkses(requiredRole, actionType) {
  const userRole = localStorage.getItem('userRole');
  
  // Admin bisa semua
  if (userRole === 'admin') return true;
  
  // Karyawan hanya bisa:
  if (userRole === 'karyawan') {
    // Baca semua data
    if (actionType === 'read') return true;
    
    // Hanya tagihan yang boleh create/update
    if (actionType === 'write_tagihan') return true;
    
    // Tidak boleh hapus apapun
    if (actionType === 'delete') return false;
    
    // Tidak boleh CRUD pelanggan & paket
    if (actionType === 'write_pelanggan') return false;
    if (actionType === 'write_paket') return false;
  }
  
  return false;
}

// ALIAS FUNGSI UNTUK MUDAH
function hanyaAdmin() {
  return localStorage.getItem('userRole') === 'admin';
}

function adminAtauKaryawan() {
  const role = localStorage.getItem('userRole');
  return role === 'admin' || role === 'karyawan';
}


// ============================================
// FUNGSI KLIK CARD LUNAS - DETAIL BULAN INI
// ============================================

function showLunasBulanIni() {
    console.log("🟢 Membuka detail lunas bulan ini...");
    
    // --- TAMBAHKAN INI: PAKSA Z-INDEX TINGGI ---
    // Kita cari semua modal lain yang mungkin ada dan turunkan z-index-nya
    window.document.querySelectorAll('.modal-overlay.show').forEach(modal => {
    modal.style.zIndex = "1000"; 
});

    showModal('modalLunasBulanIni');
    
    // --- TAMBAHKAN INI: SET Z-INDEX MODAL INI TINGGI ---
    // Pastikan modal lunas menang di paling atas
    const modal = document.getElementById('modalLunasBulanIni');
    if (modal) {
        modal.style.zIndex = "99999"; 
        console.log("✅ Modal Lunas Z-Index set to 99999");
    }
    
    loadLunasBulanIniData();
}

// ============================================
// FUNGSI LOAD DATA LUNAS BULAN INI (FIXED: HANYA PELANGGAN LUNAS)
// ============================================

async function loadLunasBulanIniData(page = 1) {
    const table = document.getElementById('lunasBulanIniTable');
    if (!table) return;
    
    try {
        table.innerHTML = `<tr><td colspan="8" class="text-center"><div class="spinner" style="margin:0 auto;"></div> Memuat Data...</td></tr>`;
        
        // Tentukan Bulan Ini
        const currentMonthText = moment().format('MM-YYYY');
        
        // 1. Ambil SEMUA tagihan bulan ini (tanpa filter status dulu)
        const snapshot = await db.collection('tagihan')
            .where('company_id', '==', globalCompanyId)
            .where('bulan', '==', currentMonthText)
            .get();
        
        // 2. Kita Filter secara Manual di JavaScript agar TIDAK ERROR INDEKS
        // Hanya ambil data pelanggan yang statusnya 'lunas'
        let filteredDocs = [];
        
        if (!snapshot.empty) {
            // Loop semua data
            snapshot.forEach(doc => {
                const data = doc.data();
                
                // Filter Status: HANYA JIKA STATUS = 'lunas'
                if (data.status === 'lunas') {
                    filteredDocs.push({ id: doc.id, ...data });
                }
            });
        }
        
        console.log(`📊 Ditemukan ${filteredDocs.length} data lunas bulan ini.`);
        
        if (filteredDocs.length === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center" style="padding: 30px;">
                        <i class="fas fa-inbox" style="font-size: 40px; color: #e9ecef;"></i>
                        <h4 style="margin-top:10px; color: var(--gray);">Belum Ada Pelunasan</h4>
                        <p>Belum ada pelanggan yang membayar lunas bulan ini.</p>
                    </td>
                </tr>`;
            document.getElementById('lunasPagination').innerHTML = '';
            return;
        }
        
        // 3. Pagination Logic (Sama seperti sebelumnya)
        const totalData = filteredDocs.length;
        const itemsPerPage = 10;
        const totalPages = Math.ceil(totalData / itemsPerPage);
        
        if (page > totalPages) page = totalPages;
        
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageDocs = filteredDocs.slice(startIndex, endIndex);
        
        // 4. Render Table
        let html = '';
        
        // Cache map pelanggan
        if (!window.pelangganCacheMap) window.pelangganCacheMap = {};
        
        for (let i = 0; i < pageDocs.length; i++) {
            const t = pageDocs[i];
            
            // Ambil Nama Pelanggan
            let namaPelanggan = t.pelanggan_nama || 'Unknown';
            if (t.pelanggan_id && !window.pelangganCacheMap[t.pelanggan_id]) {
                try {
                    const pelDoc = await db.collection('pelanggan').doc(t.pelanggan_id).get();
                    if (pelDoc.exists) {
                        const pData = pelDoc.data();
                        window.pelangganCacheMap[t.pelanggan_id] = pData.nama || t.pelanggan_nama;
                    }
                } catch (e) { /* ignore */ }
            }
            
            if (window.pelangganCacheMap[t.pelanggan_id]) {
                namaPelanggan = window.pelangganCacheMap[t.pelanggan_id];
            }
            
            // Format Tanggal Bayar
            let tglBayarDisplay = '-';
            if (t.tanggal_bayar) {
                let m = moment(t.tanggal_bayar, 'DD MMMM YYYY, HH:mm');
                if (!m.isValid()) m = moment(t.tanggal_bayar);
                if (!m.isValid()) m = moment(t.tanggal_bayar, 'YYYY-MM-DD');
                if (m.isValid()) tglBayarDisplay = m.format('DD/MM/YYYY');
            }

            const no = startIndex + i + 1;

            html += `
                <tr>
                    <td style="font-weight: bold;">${no}</td>
                    <td><strong>${namaPelanggan}</strong></td>
                    <td>${formatRupiah(t.jumlah || 0)}</td>
                    <td><span class="badge badge-info">${t.bulan || '-'}</span></td>
                    <td><span class="badge badge-success"><i class="fas fa-check-circle"></i> LUNAS</span></td>
                    <td>${tglBayarDisplay}</td>
                    <td><small>${t.nama_petugas || t.updated_by || 'System'}</small></td>
                </tr>
            `;
        }
        
        table.innerHTML = html;
        
        // Render Pagination
        renderPagination(totalData, page, 'lunasBulanIni', 'lunasPagination');
        
    } catch (error) {
        console.error("Error load data lunas:", error);
        const table = document.getElementById('lunasBulanIniTable');
        if(table) {
            table.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Error: ${error.message}</td></tr>`;
        }
    }
}


// ============================================
// FUNGSI DETAIL TUNGGAKAN (REAL-TIME CALCULATION)
// ============================================

function showDetailTunggakan() {
    console.log("🔴 Membuka detail tunggakan...");
    showModal('modalDetailTunggakan'); // Pastikan ID Modal HTML ini sama
    loadTunggakanDynamicData();
}

// ============================================
// LOAD DATA TUNGGAKAN DENGAN PERHITUNGAN DINAMIS
// ============================================

async function loadTunggakanDynamicData(page = 1) {
    const table = document.getElementById('tunggakanTable');
    if (!table) return;
    
    try {
        // 1. Ambil SEMUA Tagihan BELUM LUNAS
        const snapshot = await db.collection('tagihan')
            .where('company_id', '==', globalCompanyId)
            .where('status', '==', 'belum') // Status belum (termasuk telat)
            .get();
        
        if (snapshot.empty) {
            table.innerHTML = `<tr><td colspan="4" class="text-center" style="padding: 40px;">Tidak ada tunggakan saat ini. Semua tagihan sudah LUNAS.</td></tr>`;
            document.getElementById('tunggakanPagination').innerHTML = '';
            return;
        }
        
        // 2. Group Data per Pelanggan & Hitung Total
        const groupedMap = {};
        
        snapshot.forEach(doc => {
            const t = doc.data();
            const pid = t.pelanggan_id;
            const bulanRaw = t.bulan || "";
            
            // Konversi "01-2025" jadi Angka 1 (Januari)
            const parts = bulanRaw.split('-');
            const angkaBulan = parts[0] ? parseInt(parts[0], 10) : 0; // Ambil bagian bulan (01 jadi 1)
            
            if (!groupedMap[pid]) {
                // Init pelanggan baru
                groupedMap[pid] = {
                    pelanggan_id: pid,
                    pelanggan_nama: t.pelanggan_nama || 'Unknown',
                    pelanggan_telepon: t.pelanggan_telepon || '-',
                    total_uang: 0,
                    list_angka_bulan: [] // Simpan angka bulan: [1, 2, 3]
                };
            }
            
            // Tambah nominal
            groupedMap[pid].total_uang += Number(t.jumlah) || 0;
            
            // Simpan angka bulan (Hanya simpan angka unik agar tidak doang 1, 1, 1)
            if (!groupedMap[pid].list_angka_bulan.includes(angkaBulan)) {
                groupedMap[pid].list_angka_bulan.push(angkaBulan);
            }
        });
        
        // 3. Siapkan Array untuk Pagination
        let dataArray = Object.values(groupedMap);
        
        // 4. Pagination
        const itemsPerPage = 10;
        const totalPages = Math.ceil(dataArray.length / itemsPerPage);
        
        if (page > totalPages) page = totalPages;
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = dataArray.slice(startIndex, endIndex);
        
        // 5. Render Table
        let html = '';
        
        pageData.forEach((item, index) => {
            const nomor = startIndex + index + 1;
            
            // Ubah array angka [1, 2] jadi string "1, 2"
            const periodeString = item.list_angka_bulan.join(', ');
            
            html += `
                <tr>
                    <td>${nomor}</td>
                    <td><strong>${item.pelanggan_nama}</strong></td>
                    <td style="color: var(--danger); font-weight: bold;">${formatRupiah(item.total_uang)}</td>
                    <td><span style="background: #ffebeb; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 12px;">${periodeString}</span></td>
                </tr>
            `;
        });
        
        table.innerHTML = html;
        
        // Render Pagination
        renderPagination(dataArray.length, page, 'tunggakan', 'tunggakanPagination');
        
    } catch (error) {
        console.error("Error load tunggakan:", error);
        const table = document.getElementById('tunggakanTable');
        if(table) table.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Error: ${error.message}</td></tr>`;
    }
}


// -------------------------------------------------------
// 1. FUNGSI GENERATE LAPORAN (AMAN & LENGKAP)
// -------------------------------------------------------
async function generateLaporan() {
    console.log("📊 Generate Laporan: 6 BULAN TERAKHIR");

    const table = document.getElementById('laporanTable');
    if (!table) return;

    table.innerHTML = `<tr><td colspan="6" class="text-center"><div class="spinner" style="width:30px;height:30px;margin:0 auto;"></div> Memuat Data 6 Bulan...</td></tr>`;

    try {
        // 1. TENTUKAN 6 BULAN TERAKHIR
        const listBulan = [];
        
        for (let i = 5; i >= 0; i--) {
            const m = moment().subtract(i, 'months');
            const bulanKey = m.format('MM-YYYY');
            const labelDisplay = m.format('MMM YY');
            
            listBulan.push({ key: bulanKey, display: labelDisplay });
        }
        
        // 2. AMBIL DATA BATCH
        const promises = listBulan.map(item => {
            return db.collection('tagihan')
                .where('company_id', '==', globalCompanyId)
                .where('bulan', '==', item.key)
                .get();
        });

        const snapshots = await Promise.all(promises);

        // 3. GABUNGKAN SEMUA DATA
        let laporanData = [];
        let totalPendapatan = 0;

        snapshots.forEach((snap) => {
            snap.forEach(doc => {
                const t = doc.data();
                const nominal = Number(t.jumlah) || 0;
                
                // Hitung total (Semua status, atau bisa difilter cuma Lunas)
                totalPendapatan += nominal;

                let tglDisplay = '-';
                if (t.created_at) {
                    let m = moment(t.created_at);
                    if (m.isValid()) tglDisplay = m.format('DD/MM/YYYY');
                }

                // Cari label bulan yang sesuai dari listBulan
                const bulanInfo = listBulan.find(b => b.key === t.bulan);

                laporanData.push({
                    tanggal: tglDisplay,
                    bulanKey: t.bulan,          // Kunci untuk sorting
                    bulanDisplay: bulanInfo ? bulanInfo.display : t.bulan,
                    pelanggan: t.pelanggan_nama || 'Unknown',
                    nominal: nominal,
                    status: t.status || 'belum',
                    metode: t.metode_bayar || '-'
                });
            });
        });

        // 4. URUTKAN DATA: LAMA -> BARU (ASCENDING CHRONOLOGIS)
        laporanData.sort((a, b) => {
            const dateA = moment(a.bulanKey, 'MM-YYYY');
            const dateB = moment(b.bulanKey, 'MM-YYYY');
            
            if (dateA.isValid() && dateB.isValid()) {
                return dateA.valueOf() - dateB.valueOf();
            }
            return 0;
        });

        console.log(`💰 Total Pendapatan 6 Bulan: ${formatRupiah(totalPendapatan)}`);

        // 5. RENDER TABEL
        let tableHTML = `
            <thead>
                <tr>
                    <th>Periode</th>
                    <th>Pelanggan</th>
                    <th>Nominal</th>
                    <th>Status</th>
                    <th>Metode</th>
                </tr>
            </thead>
            <tbody>
        `;

        // Tampilkan 50 data terakhir
        laporanData.slice(-50).reverse().forEach(item => {
            let badgeClass = 'badge-warning'; 
            if (item.status === 'lunas') badgeClass = 'badge-success';

            tableHTML += `
                <tr>
                    <td><span class="badge badge-info">${item.bulanDisplay}</span></td>
                    <td><strong>${item.pelanggan}</strong></td>
                    <td>${formatRupiah(item.nominal)}</td>
                    <td><span class="badge ${badgeClass}">${item.status.toUpperCase()}</span></td>
                    <td>${item.metode}</td>
                </tr>
            `;
        });

        tableHTML += `</tbody>`;
        table.innerHTML = tableHTML;

        // 6. UPDATE GRAFIK (LEWATKAN DATA SAJA, TANPA PARAMETER LABELS)
        updateLaporanCharts(laporanData);

        

    } catch (error) {
        console.error("❌ Error generate laporan:", error);
        table.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${error.message}</td></tr>`;
    }
}

// -------------------------------------------------------
// 2. FUNGSI UPDATE GRAFIK (MANDIRI & AMAN)
// -------------------------------------------------------
function updateLaporanCharts(data) {
    // CEGAH ERROR JIKA DATA KOSONG ATAU UNDEFINED
    if (!data || data.length === 0) {
        console.warn("⚠️ Data chart kosong atau undefined, skip render chart.");
        return;
    }

    // 1. GRAFIK PENDAPATAN
    if (window.laporanChartInstance) {
        window.laporanChartInstance.destroy();
    }

    // Grouping data berdasarkan bulanKey
    const monthlyData = {};
    // Ambil semua key bulan yang unik dari data untuk label sumbu X
    const uniqueBulanKeys = [...new Set(data.map(item => item.bulanKey))];

    // Inisialisasi 0
    uniqueBulanKeys.forEach(key => {
        monthlyData[key] = 0;
    });

    // Hitung total per bulan
    data.forEach(item => {
        if (monthlyData[item.bulanKey] !== undefined) {
            monthlyData[item.bulanKey] += item.nominal;
        }
    });

    // Urutkan Label Bulan (Ascending: Jan, Feb, Mar...)
    uniqueBulanKeys.sort((a, b) => {
        const dateA = moment(a, 'MM-YYYY');
        const dateB = moment(b, 'MM-YYYY');
        return dateA.valueOf() - dateB.valueOf();
    });

    // Ambil total pendapatan berdasarkan urutan key
    const monthlyTotals = uniqueBulanKeys.map(key => monthlyData[key]);

    // Format Labels agar cantik
    const formattedLabels = uniqueBulanKeys.map(bulan => {
        const parts = bulan.split('-');
        if (parts.length === 2) {
            const dateObj = moment(`${parts[1]}-${parts[0]}-01`);
            return dateObj.isValid() ? dateObj.format('MMM YY') : bulan;
        }
        return bulan;
    });

    const ctx = document.getElementById('laporanChart1');
    if (ctx) {
        window.laporanChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: formattedLabels,
                datasets: [{
                    label: 'Pendapatan (Rp)',
                    data: monthlyTotals,
                    backgroundColor: 'rgba(67, 97, 238, 0.6)',
                    borderColor: '#4361ee',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatRupiah(value);
                            }
                        }
                    }
                }
            }
        });
    }

    // 2. GRAFIK DISTRIBUSI (PIE CHART - METODE PEMBAYARAN)
    const ctx2 = document.getElementById('laporanChart2');
    if (ctx2) {
        if (window.laporanChart2Instance) {
            window.laporanChart2Instance.destroy();
        }

        const metodeCounts = {};
        data.forEach(item => {
            const metode = item.metode || 'Lainnya';
            metodeCounts[metode] = (metodeCounts[metode] || 0) + 1;
        });

        window.laporanChart2Instance = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: Object.keys(metodeCounts),
                datasets: [{
                    data: Object.values(metodeCounts),
                    backgroundColor: ['#00b894', '#0984e3', '#6c5ce7', '#fdcb6e', '#ff7675']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
}
        
// ============================================
// INITIALIZATION & EVENT HANDLERS (FIXED VERSION)
// ============================================



document.addEventListener('DOMContentLoaded', function() {
    console.log("🚀 X-BILL System Initializing...");

    (async function initGlobalData() {
        console.log("🚀 Inisialisasi Data Global Aplikasi...");
        
        try {
            // Kita coba ambil data Company Profile terlebih dahulu
            const doc = await db.collection('company_settings').doc('profile').get();
            
            if (doc.exists) {
                const data = doc.data();
                const companyName = data.companyName || 'X-BILL ISP';
                const companyAddress = data.companyAddress || 'Jl. Internet Cepat No. 1';
                
                // Simpan ke Variable Global agar tidak hilang saat ganti menu
                window.globalCompanyName = companyName;
                window.globalCompanyAddress = companyAddress;
                
                // Update UI Navbar secara langsung (jika elemennya ada)
                const navElement = document.getElementById('companyNameNav');
                if (navElement) navElement.textContent = companyName;
                
                console.log("✅ Data Perusahaan dimuat dari Database:", companyName);
            } else {
                console.log("ℹ️ Belum ada profil perusahaan di database, gunakan default.");
                window.globalCompanyName = 'X-BILL ISP';
                window.globalCompanyAddress = 'Jl. Internet Cepat No. 1';
            }
            
        } catch (error) {
            console.warn("⚠️ Gagal inisialisasi data global (mungkin belum login/offline):", error);
            // Set default jika error
            window.globalCompanyName = 'X-BILL ISP';
            window.globalCompanyAddress = 'Jl. Internet Cepat No. 1';
        }
    })();
    
    // 1. SETUP DEFAULT DATES
    const today = moment().format('DD-MM-YYYY');
    const nextMonth = moment().add(1, 'month').format('MM-YYYY');
    
    const dateFields = ['prorataMulai', 'prorataAkhir', 'tanggalBayar'];
    dateFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = today;
    });
    
    const monthFields = ['generateBulan'];
    monthFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = nextMonth;
    });
    
    // 2. CEK STATUS LOGIN
    const savedUser = localStorage.getItem('xbill_user');
    const loginPageEl = document.getElementById('loginPage');
    const appContainerEl = document.getElementById('appContainer');
    
    if (savedUser && loginPageEl && appContainerEl) {
        try {
            currentUser = JSON.parse(savedUser);
            
            // Update UI User Info
            const userNameEl = document.getElementById('userName');
            const userAvatarEl = document.getElementById('userAvatar');
            const avatarTextEl = document.getElementById('avatarText');
            
            if (userNameEl) userNameEl.textContent = currentUser.name;
            if (userAvatarEl) userAvatarEl.textContent = currentUser.name.charAt(0);
            if (avatarTextEl) avatarTextEl.textContent = currentUser.name.charAt(0);
            
            // Switch View
            loginPageEl.classList.add('hidden');
            appContainerEl.classList.remove('hidden');
            
            // Load Dashboard
            loadPage('dashboard');
            
        } catch (e) {
            console.error("Error parsing user:", e);
        }
    } else if (!savedUser && loginPageEl) {
        // Pastikan Login Page Tampil
        loginPageEl.classList.remove('hidden');
        if (appContainerEl) appContainerEl.classList.add('hidden');
    }
    
    // 3. ATTACH EVENT LISTENER UNTUK FORM LOGIN
    const loginForm = document.getElementById('loginForm');
if (loginForm) {
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        
        if (!username || !password) {
            showToast('error', 'Login Gagal', 'Username dan Password wajib diisi');
            return;
        }

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Login...';
            showLoading();

            let userCredential = null;
            let userUid = null; // Variabel untuk menyimpan UID Firebase

            // 1. COBA LOGIN MENGGUNAKAN HARDCODE ADMIN
            if (username === 'admin' && password === 'admin123') {
                userCredential = {
                    uid: 'admin_hardcoded',
                    name: 'Administrator',
                    email: 'admin@xbill.com',
                    role: 'admin' // Default hardcoded
                };
                userUid = 'admin_hardcoded';
            } else {
                // 2. COBA LOGIN MENGGUNAKAN FIREBASE AUTH
                const email = username.includes('@') ? username : `${username}@xbill.com`;
                const authResult = await firebase.auth().signInWithEmailAndPassword(email, password);
                
                userCredential = {
                    uid: authResult.user.uid,
                    name: authResult.user.displayName || authResult.user.email.split('@')[0],
                    email: authResult.user.email,
                    role: null // Akan diisi dari database nanti
                };
                userUid = authResult.user.uid;
            }

            // 3. AMBIL DATA USER LENGKAP DARI FIRESTORE (AMBIL ROLE YANG ASLI)
            console.log("Mengambil data user dari Firestore untuk UID:", userUid);
            const userDocRef = db.collection('users').doc(userUid);
            const userDoc = await userDocRef.get();

            if (userDoc.exists) {
                const userData = userDoc.data();
                // Update role dengan yang ada di database
                userCredential.role = userData.role || 'admin'; 
                console.log("Role ditemukan di database:", userCredential.role);
            } else {
                console.warn("Data user tidak ditemukan di Firestore, menggunakan role default:", userCredential.role);
            }

            // 4. SIMPAN SESSION
            currentUser = userCredential;
            localStorage.setItem('xbill_user', JSON.stringify(currentUser));
            localStorage.setItem('userRole', currentUser.role);
            localStorage.setItem('userName', currentUser.name);

            // 5. SWITCH VIEW
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            
            // Update UI User Info
            if (document.getElementById('userName')) document.getElementById('userName').textContent = currentUser.name;
            if (document.getElementById('userAvatar')) document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
            
            // Update Role Text di Navbar
            if (document.getElementById('userRole')) {
                document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'Administrator' : currentUser.role.toUpperCase();
            }

            // 6. LOAD PAGE DASHBOARD
            await loadPage('dashboard');
            
            hideLoading();
          

        } catch (error) {
            // ⭐⭐ PERBAIKAN: Jangan tampilkan Toast Error jika sudah masuk Dashboard ⭐⭐
            console.error("❌ Error Login:", error);
            
            // Cek apakah user sudah masuk dashboard sebelum menampilkan error
            const appContainer = document.getElementById('appContainer');
            if (!appContainer.classList.contains('hidden')) {
                console.log("⚠️ User sudah di dashboard, abaikan error login toast ini.");
                return; // Stop jangan tampilkan error toast
            }

            hideLoading();
            
            // Kembalikan tombol
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
            
            // Opsional: Tampilkan pesan error hanya jika benar-benar gagal total
            // showToast('error', 'Login Gagal', error.message);
        } finally {
            // Pastikan tombol kembali normal
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
    });
}
    
    // 4. ATTACH NAVIGATION
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const page = this.getAttribute('data-page');
            if (page) loadPage(page);
        });
    });
    
    // 5. ATTACH LOGOUT
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                localStorage.removeItem('xbill_user');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userName');
                currentUser = null;
                firebase.auth().signOut().catch(() => {});
                window.location.reload();
            }
        });
    }

    // 6. ATTACH OTHER EVENTS
    const encryptEl = document.getElementById('encryptData');
    if (encryptEl) {
        encryptEl.addEventListener('change', function() {
            const el = document.getElementById('passwordSection');
            if (el) el.style.display = this.checked ? 'block' : 'none';
        });
    }
    
    const reminderEl = document.getElementById('reminderSchedule');
    if (reminderEl) {
        reminderEl.addEventListener('change', function() {
            const el = document.getElementById('customSchedule');
            if (el) el.style.display = (this.value === 'custom') ? 'block' : 'none';
        });
    }
    
    console.log("✅ Initialization Complete.");
});


// Dalam fungsi loadPage('setting') atau fungsi yang merender halaman setting
document.querySelectorAll('.setting-card').forEach(card => {
    card.addEventListener('click', function() {
        const targetModal = this.getAttribute('data-modal');
        if (targetModal) {
            showModal(targetModal);
            
            // Load data sesuai modal
            switch(targetModal) {
                case 'modalCompanyProfile':
                    setTimeout(loadCompanyProfile, 100);
                    break;
                case 'modalBranding':
                    setTimeout(loadBrandingSettings, 100);
                    break;
                case 'modalUserProfile':
                    setTimeout(loadUserProfile, 100);
                    break;
            }
        }
    });
});

// ============================================
// 2. TOMBOL GENERATE TAGIHAN (FIXING)
// ============================================

// ⭐⭐ TAMBAHKAN VALIDASI ELEMENT DULU ⭐⭐
const btnGenerate = document.getElementById('btnGenerateTagihan');

if (!btnGenerate) {
    console.log("⚠️ Tombol btnGenerateTagihan tidak ditemukan, skip event listener");
} else {
    btnGenerate.addEventListener('click', function(e) {
        e.preventDefault();
        
        const modal = document.getElementById('modalGenerateTagihan');
        if (!modal) {
            console.error("❌ Modal generate tagihan tidak ditemukan");
            return;
        }
        
        // Set nilai default bulan ke bulan INI
        const todayMoment = moment();
        const bulanKini = todayMoment.format('MM-YYYY');
        
        // Reset checkbox
        document.getElementById('generateProrata').checked = true; 
        
        // Isi form
        const bulanInput = document.getElementById('generateBulan');
        if(bulanInput) {
            bulanInput.value = bulanKini;
        }
        
        // Show modal
        modal.classList.remove('hidden');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';

        // Panggil fungsi generate
        setTimeout(() => {
            console.log("Tombol Generate diklik...");
            // generateTagihanBulk(); // ⭐⭐ COMMENT DULU JIKA MAU TEST MODAL
        }, 300);
    });
}



// ============================================
// FIX TOMBOL BAYAR DI HALAMAN DAFTAR TAGIHAN
// ============================================

document.body.addEventListener('click', function(e) {
    // Cari elemen <button> atau <i> di dalam tombol yang diklik
    const target = e.target;
    const btn = target.closest('button');

    // Cek apakah yang diklik adalah tombol Bayar (Warna Hijau, Ikon Uang/Dollar)
    // atau tombol yang memiliki onclick mengandung kata "executePayAllDirect" (Untuk tombol Bayar di grup)
    
    if (btn) {
        const onclickAttr = btn.getAttribute('onclick') || '';
        
        // LOGIKA 1: Jika tombol BAYAR SEMUA (Grup Pelanggan)
        if (onclickAttr.includes('executePayAllDirect')) {
            e.preventDefault(); // Mencegah aksi default/error
            
            // Ambil data dari tombol
            const pelangganId = btn.getAttribute('data-pid') || btn.getAttribute('onclick').match(/'([^']+)'/)[1]; // Ambil ID string
            // Perlu mengambil ID dan Total dari context tabel
            // Cara paling aman adalah mencari baris tabel (tr) terdekat
            const row = btn.closest('tr');
            if (row) {
                // Disini kita perlu menarik data 'belumUrut' yang tersimpan secara global di window atau ambil manual dari array
                // Karena tombol di tabel utama biasanya membuka modal 'viewTagihanDetails' dulu
                // JADI untuk tabel DAFTAR TAGIHAN, tombol 'Bayar' biasanya memanggil 'showPayAllModal'
                if (onclickAttr.includes('showPayAllModal')) {
                    showPayAllModal(pelangganId);
                }
            }
        }

        // LOGIKA 2: Jika tombol BAYAR LANGSUNG (Tombol tunggal per tagihan - JIKA ADA)
        // Biasanya di tabel utama tombolnya 'showPayAllModal', tapi kalau tombol bayar langsung:
        if (onclickAttr.includes('bayarTagihanDenganStruk')) {
            e.preventDefault();
            e.stopPropagation();
            
            // Ekstrak parameter dari string onclick jika perlu, atau panggil fungsi langsung
            // Karena tombol di tabel utama sering pakai showPayAllModal, kita fokus ke situ dulu:
            // showPayAllModal(pid);
        }
    }
});


// ⭐⭐⭐ GLOBAL CLICK HANDLER UNTUK LOG ⭐⭐⭐
document.addEventListener('click', async function(e) {
    const target = e.target;
    
    // Tangkap semua tombol simpan/hapus
    if (target.matches('[onclick*="save"], [onclick*="delete"], [onclick*="generate"]')) {
        const onclickText = target.getAttribute('onclick') || '';
        
        // Auto-log setelah 2 detik (biar proses utama selesai dulu)
        setTimeout(async () => {
            try {
                await db.collection('aktivitas').add({
                    aktivitas: `KLIK: ${onclickText.substring(0, 50)}...`,
                    user: currentUser?.email || "User",
                    timestamp: new Date().toISOString(),
                    company_id: globalCompanyId
                });
            } catch (e) {
                // Ignore
            }
        }, 2000);
    }
});
        
        // Encrypt data checkbox handler
        document.getElementById('encryptData')?.addEventListener('change', function() {
            const passwordSection = document.getElementById('passwordSection');
            if (this.checked) {
                passwordSection.style.display = 'block';
            } else {
                passwordSection.style.display = 'none';
            }
        });
        
        // Reminder schedule handler
        document.getElementById('reminderSchedule')?.addEventListener('change', function() {
            const customSchedule = document.getElementById('customSchedule');
            if (this.value === 'custom') {
                customSchedule.style.display = 'block';
            } else {
                customSchedule.style.display = 'none';
            }
        });
        
        console.log("X-BILL System Loaded Successfully!");

        // Blokir form submit default
document.addEventListener('DOMContentLoaded', function() {
    const allForms = document.querySelectorAll('form');
    allForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        });
    });
    
    // Blokir click pada semua tombol di modal
    const allButtons = document.querySelectorAll('.modal button');
    allButtons.forEach(button => {
        if (!button.onclick) {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
        }
    });
});
    </script>
</body>
</html>
