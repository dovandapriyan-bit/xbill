<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X-BILL | Billing System ISP</title>
    
    <!-- CSS & JS Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="email.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- Tambahkan setelah library html2canvas -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* ========== RESET & VARIABLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #00b894;
            --danger: #ff6b6b;
            --warning: #fdcb6e;
            --info: #54a0ff;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.12);
            --radius: 15px;
            --radius-sm: 10px;
        }
        
        body {
            background: #f5f7fb;
            color: var(--dark);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* ========== LOADING ========== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ========== TOAST (FIX Z-INDEX) ========== */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    /* ⭐ MAGIC NUMBER: Pastikan lebih tinggi dari modal (99999 > 9999) */
    z-index: 99999; 
    
    max-width: 400px;
    /* Tambah pointer-events: none agar klik tembus ke container, tapi tombol toast tetap klik */
    pointer-events: none; 
}

.toast {
    background: white;
    border-radius: var(--radius-sm);
    padding: 15px 20px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); /* Bayangan lebih gelap biar kontras */
    transform: translateX(400px);
    transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Animasi sedikit bouncy */
    
    /* ⭐ PENTING: Balikin pointer-events supaya toast bisa diclick */
    pointer-events: auto;
    
    /* Tambahkan border tipis biar kelihatan jelas di atas background modal gelap */
    border-left: 4px solid var(--gray);
}

/* Warna border sesuai tipe toast */
.toast-success { border-left-color: var(--success); }
.toast-error { border-left-color: var(--danger); }
.toast-warning { border-left-color: var(--warning); }
.toast-info { border-left-color: var(--info); }

.toast.show {
    transform: translateX(0);
}

.toast-icon {
    font-size: 24px; /* Ikon sedikit lebih besar */
}

.toast-title {
    font-weight: 700;
    margin-bottom: 5px;
    font-size: 16px;
}

.toast-message {
    font-size: 14px;
    color: var(--gray);
    line-height: 1.4;
}
        
        /* ========== LOGIN PAGE ========== */
        #loginPage {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient);
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        
        .login-header {
            background: var(--primary);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .login-header i {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .app-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .app-tagline {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .login-body {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--gray-light);
            border-radius: var(--radius-sm);
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .login-footer {
            padding: 20px;
            text-align: center;
            background: var(--light);
            border-top: 1px solid var(--gray-light);
            font-size: 13px;
            color: var(--gray);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #00a085;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #ee5a52;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }
        
        .btn-warning:hover {
            background: #f9c74f;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background: var(--info);
            color: white;
        }
        
        .btn-info:hover {
            background: #2e86de;
            transform: translateY(-2px);
        }
        
        .btn-block {
            width: 100%;
        }
        
        /* ========== APP CONTAINER ========== */
        #appContainer {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f5f7fb;
            padding-top: 60px;
        }
        
        /* ========== TOP NAVBAR ========== */
        .top-navbar {
        background: white;
        padding: 15px 25px;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: fixed;    /* ⬅️ GANTI INI */
        top: 0;
        width: 100%;
        z-index: 1000;
        height: 60px;              /* ⬅️ TAMBAH INI */
        box-sizing: border-box;    /* ⬅️ TAMBAH INI */
        }


        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
            line-height: 1.2;      /* biar teks tidak renggang */
            height: 100%;
        }
        
        .navbar-brand {
    gap: 12px;
}

.navbar-brand img {
    margin-right: 10px;
    max-height: 40px;
    max-width: 200px;
    width: auto;
    height: auto;
    object-fit: contain;
    display: block;
}

#companyNameNav {
    font-size: 22px;
    margin-left: 8px;
}


        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;            /* ⭐ KECILKAN JARAK ANTAR ELEMEN */
            margin-left: auto;     /* ⭐ TAMBAHKAN INI: DORONG KE KANAN */
            flex-wrap: wrap;       /* ⭐ TAMBAHKAN INI: AGAR BISA TURUN BARIS DI HP */
        }

        
        .user-info {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-avatar {
            width: 25px;
            height: 25px;
            background: var(--gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .logout-btn {
            background: var(--light);
            border: 1px solid var(--gray-light);
            padding: 8px 15px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        /* ========== BOTTOM NAVIGATION ========== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            z-index: 1010;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            color: var(--gray);
            text-decoration: none;
            border-radius: var(--radius-sm);
            transition: all 0.3s;
            min-width: 70px;
            cursor: pointer;
        }
        
        .nav-item i {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .nav-item span {
            font-size: 12px;
            font-weight: 500;
        }
        
        .nav-item.active {
            color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
        }
        
        .nav-item:hover {
            color: var(--primary);
            transform: translateY(-2px);
        }
        
        /* ========== MAIN CONTENT ========== */
        .main-content {
            flex: 1;
            padding: 25px;
            padding-bottom: 80px;
            overflow-y: auto;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        .page {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ========== PAGE HEADER ========== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-title i {
            color: var(--primary);
        }
        
        /* ========== STATS CARDS ========== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .stat-icon.primary { background: var(--primary); }
        .stat-icon.success { background: var(--success); }
        .stat-icon.info { background: var(--info); }
        .stat-icon.danger { background: var(--danger); }
        .stat-icon.warning { background: var(--warning); }
        
        .stat-content {
            flex: 1;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 14px;
        }
        
        /* ========== CARDS ========== */
        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h3 {
            font-size: 18px;
            color: var(--dark);
        }
        
        .card-body {
            padding: 25px;
        }
        
        /* ========== TABLES ========== */
        .table-responsive {
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            background: var(--light);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--gray-light);
        }
        
                .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
            vertical-align: middle;
            /* ⭐ TAMBAHKAN STYLE BERIKUT AGAR HURUF LEBIH KECIL ⭐ */
            font-size: 12px;           /* ⭐ KURANGI DARI DEFAULT (biasanya 14-16px) */
            line-height: 1.4;         /* ⭐ RAPATKAN JARAK ANTAR BARIS */
        }
        
        .table tr:hover {
            background: rgba(67, 97, 238, 0.02);
        }
        
        /* ========== BADGES ========== */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: rgba(0, 184, 148, 0.1);
            color: var(--success);
        }
        
        .badge-danger {
            background: rgba(255, 107, 107, 0.1);
            color: var(--danger);
        }
        
        .badge-warning {
            background: rgba(253, 203, 110, 0.1);
            color: #e67e22;
        }
        
        .badge-info {
            background: rgba(84, 160, 255, 0.1);
            color: var(--info);
        }
        
        .badge-primary {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        /* ========== BUTTONS ========== */
        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .btn-group {
            display: flex;
            gap: 5px;
        }
        
        .btn-outline {
            background: white;
            border: 2px solid var(--gray-light);
            color: var(--dark);
        }
        
        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }
        
        /* ========== FILTERS ========== */
        .filters-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        
        
        /* ========== MODALS ========== */
        .modal-overlay {
            position: fixed;
            top: 80px;
            left: 0;
            right: 0;
            bottom: 80px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
           

            

        }

        /* ⭐ TAMBAHKAN BARIS INI DI BAWAHNYA ⭐ */
.modal-overlay .modal {
    pointer-events: auto;
}
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlide 0.3s ease;
        }
        
        .modal-lg {
            max-width: 700px;
        }
        
        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray);
            cursor: pointer;
            padding: 5px;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* ========== FORM STYLES ========== */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .user-menu {
                margin-left: auto; /* Pastikan ini ada */
                gap: 8px;           /* Perkecil gap lagi biar muat */
            }

            #logoutBtnSmall {
                margin-left: 0;    /* Reset margin tombol logout */
                margin-right: 0;
            }
        
        .form-check {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .form-check-input {
            width: 18px;
            height: 18px;
        }
        
        .form-check-label {
            cursor: pointer;
        }
        
        /* ========== CHARTS ========== */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (min-width: 992px) {
            .charts-container {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        .chart-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
        }
        
        .chart-card h3 {
            margin-bottom: 20px;
            color: var(--dark);
            font-size: 18px;
        }
        
        /* ========== QUICK ACTIONS ========== */
        .quick-actions {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .quick-actions h3 {
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* ========== PAGINATION ========== */
.pagination {
    display: flex;                 /* ⭐ Gunakan Flexbox */
    justify-content: center;       /* Tengahkan secara horizontal */
    align-items: center;           /* ⭐ SAMAKAN POSISI VERTIKAL */
    gap: 10px;                      /* ⭐ JARAK ANTAR TOMBOL */
    margin-top: 20px;
    flex-wrap: wrap;                /* ⭐ BIAR TIDAK PECAH DI HP */
}

.page-link {
    padding: 8px 15px;
    border: 1px solid var(--gray-light);
    border-radius: var(--radius-sm);
    color: var(--dark);
    text-decoration: none;
    transition: all 0.3s;
    cursor: pointer;
    min-width: 40px;               /* ⭐ PASTIKAN LEBAR TOMBOL AGAR SAMA */
    text-align: center;              /* ⭐ TENGAKKAN TEKS */
}

/* ⭐ STYLE KHUSUS UNTUK TOMBOL PREV (KIRI) ⭐ */
.pagination a:first-child {
    background: var(--gray-light);   /* Warna beda biar jelas tombol navigasi */
    color: var(--dark);
    font-weight: bold;              /* Tebal */
    border-radius: 5px;             /* Sudut membulat sedikit */
}
.pagination a:first-child:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

/* ⭐ STYLE KHUSUS UNTUK TOMBOL NEXT (KANAN) ⭐ */
.pagination a:last-child {
    background: var(--gray-light);   /* Warna beda biar jelas tombol navigasi */
    color: var(--dark);
    font-weight: bold;              /* Tebal */
    border-radius: 5px;             /* Sudut membulat sedikit */
}
.pagination a:last-child:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

/* STYLE UNTUK ANGKA TENGAH */
.page-link:hover,
.page-link.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
                padding-bottom: 80px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .page-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .top-navbar {
                padding: 12px 15px;
            }
            
                        .navbar-brand span {
                /* display: none;  <-- HAPUS BARIS INI */
                
                /* TAMBAHKAN STYLE BERIKUT AGAR TETAP TERLIHAT TAPI RAPI */
                display: inline-block; 
                font-size: 16px;       /* Font sedikit lebih kecil */
                max-width: 150px;    /* Batasi lebar agar tidak merusak layout */
                white-space: nowrap;  /* Tidak turun baris */
                overflow: hidden;     /* Sembunyikan sisa teks jika kepanjangan */
                text-overflow: ellipsis; /* Tampilkan titik tiga (...) jika kepanjangan */
            }
            
            .bottom-nav span {
                font-size: 11px;
            }
            
            .nav-item {
                padding: 8px 10px;
                min-width: 60px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
        }
        
        /* ========== PACKAGE CARD ========== */
        .package-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .package-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }
        
        .package-card h4 {
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .package-price {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .package-features {
            list-style: none;
            margin-bottom: 20px;
        }
        
        .package-features li {
            padding: 5px 0;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .package-features i {
            color: var(--success);
        }
        
        /* ========== EMAIL TEMPLATE ========== */
        .email-template {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .email-header {
            border-bottom: 2px solid var(--gray-light);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .email-content {
            min-height: 200px;
            border: 1px solid var(--gray-light);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin-bottom: 20px;
        }
        
        /* ========== BACKUP STATUS ========== */
        .backup-status {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        
        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .backup-item:last-child {
            border-bottom: none;
        }

        /* ========== SETTING PAGE STYLES ========== */
.setting-card {
    background: white;
    border-radius: var(--radius);
    padding: 20px;
    box-shadow: var(--shadow);
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
    display: flex;
    gap: 15px;
    align-items: center;
}

.setting-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary);
}

.setting-icon {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    flex-shrink: 0;
}

.setting-content {
    flex: 1;
}

.setting-content h3 {
    margin: 0 0 5px 0;
    color: var(--dark);
    font-size: 18px;
}

.setting-content p {
    margin: 0;
    color: var(--gray);
    font-size: 14px;
    line-height: 1.4;
}

.setting-badge {
    display: inline-block;
    background: var(--light);
    color: var(--primary);
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    margin-top: 8px;
}

.quick-setting {
    background: var(--light);
    padding: 15px;
    border-radius: var(--radius-sm);
    min-width: 200px;
}

.status-item {
    background: var(--light);
    padding: 15px;
    border-radius: var(--radius-sm);
}

.status-label {
    font-size: 12px;
    color: var(--gray);
    margin-bottom: 5px;
}

.status-value {
    font-weight: 600;
    font-size: 16px;
}

#logoutBtnSmall:hover {
    background: rgba(255, 107, 107, 0.15) !important;
    transform: translateY(-2px);
}



/* Pastikan modal tetap di atas peta */
.modal-overlay {
    z-index: 2000 !important;
}

.modal {
    z-index: 2001 !important;
}

/* Animasi untuk modal kustom */
@keyframes modalSlide {
    from {
        opacity: 0;
        transform: translateY(-30px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

#modalBranding {
    pointer-events: auto !important;
}



/* Tambah di bagian style */
.leaflet-marker-draggable {
    cursor: move !important;
}

.custom-marker {
    cursor: move !important;
}

.leaflet-dragging .custom-marker {
    transform: scale(1.2);
    transition: transform 0.2s;
}

.leaflet-pane {
    z-index: 200 !important;
}

.leaflet-marker-pane,
.leaflet-shadow-pane,
.leaflet-popup-pane {
    z-index: 300 !important;
}



.modal-overlay {
    position: fixed;
    top: 80px;
    left: 0;
    right: 0;
    bottom: 80px;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999;
    padding: 20px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
}

.modal-overlay.show {
    opacity: 1;
    visibility: visible;
}

.pelanggan-baru {
    border-left: 5px solid red;
    background: #ffecec;
}


/* ⭐⭐ PASTE DI CSS ANDA ⭐⭐ */
@media (max-width: 768px) {
    /* HEADER RAPI */
    .page-header {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: space-between !important;
        padding: 15px 0 !important;
        margin-bottom: 20px !important;
        gap: 8px !important;
        width: 100% !important;
    }
    
    /* JUDUL - KIRI, UKURAN PAS */
    .page-title {
        font-size: 17px !important;
        font-weight: 700 !important;
        color: var(--dark) !important;
        margin: 0 !important;
        padding: 0 !important;
        text-align: left !important;
        flex: 1 !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        line-height: 1.2 !important;
    }
    
    /* CONTAINER TOMBOL - KANAN */
    .action-buttons {
        display: flex !important;
        gap: 5px !important;
        margin-left: auto !important;
        flex-shrink: 0 !important;
    }
    
    /* TOMBOL - KECIL TAPI ADA ICON + TEXT */
    .page-header .btn,
    .action-buttons .btn {
        padding: 6px 10px !important;
        min-width: auto !important;
        height: 34px !important;
        border-radius: 6px !important;
        font-size: 11px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin: 0 !important;
        flex-shrink: 0 !important;
        white-space: nowrap !important;
        gap: 4px !important;
    }
    
    /* TEXT KECIL */
    .page-header .btn span,
    .action-buttons .btn span {
        display: inline !important;
        font-size: 11px !important;
        font-weight: 500 !important;
        line-height: 1 !important;
    }
    
    /* ICON KECIL */
    .page-header .btn i,
    .action-buttons .btn i {
        font-size: 12px !important;
        margin: 0 !important;
        line-height: 1 !important;
    }
    
    /* TOMBOL SPESIFIK - LEBIH KECIL */
    .btn-primary, .btn-success, .btn-warning, .btn-danger, .btn-info {
        padding: 5px 8px !important;
        font-size: 10px !important;
    }
}

/* ⭐⭐ DESKTOP (NORMAL) ⭐⭐ */
@media (min-width: 769px) {
    .page-header {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
    }
    
    .page-title {
        font-size: 24px !important;
    }
    
    .action-buttons {
        display: flex !important;
        gap: 10px !important;
    }
    
    .action-buttons .btn {
        padding: 10px 16px !important;
        font-size: 14px !important;
        gap: 6px !important;
    }
}
@media (max-width: 768px) {
    /* CARD UNIFIED - JUDUL + TOMBOL DALAM 1 KOTAK */
    .page-header {
        background: white !important;
        border-radius: 10px !important;
        padding: 12px 15px !important;
        margin-bottom: 15px !important;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1) !important;
        border: 1px solid #e0e0e0 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: 12px !important;
    }
    
    /* JUDUL DALAM CARD */
    .page-title {
        font-size: 16px !important;
        font-weight: 700 !important;
        color: var(--dark) !important;
        margin: 0 !important;
        padding: 0 !important;
        text-align: left !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        flex: 1 !important;
        min-width: 0 !important;
    }
    
    /* TOMBOL DALAM CARD YANG SAMA */
    .action-buttons {
        display: flex !important;
        gap: 6px !important;
        flex-shrink: 0 !important;
    }
    
    /* TOMBOL STYLE CARD KECIL */
    .action-buttons .btn {
        padding: 7px 10px !important;
        border-radius: 6px !important;
        font-size: 11px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 4px !important;
        white-space: nowrap !important;
        min-width: 65px !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08) !important;
        border: 1px solid var(--gray-light) !important;
        background: white !important;
    }
    
    /* WARNA CARD TOMBOL */
    .action-buttons .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--primary-dark)) !important;
        color: white !important;
        border: none !important;
    }
    
    .action-buttons .btn-success {
        background: linear-gradient(135deg, var(--success), #00a085) !important;
        color: white !important;
        border: none !important;
    }
    
    /* ICON + TEXT DALAM CARD TOMBOL */
    .action-buttons .btn i {
        font-size: 12px !important;
        margin: 0 !important;
    }
    
    .action-buttons .btn span {
        font-size: 11px !important;
        font-weight: 500 !important;
        display: inline !important;
    }
}

/* ⭐⭐ MODAL FIX - TETAP MUNCUL ⭐⭐ */
.modal-overlay.show {
    opacity: 1 !important;
    visibility: visible !important;
}

/* POSISI MODAL - DI TENGAH TANPA KEPOTONG */
.modal-overlay {
    position: fixed !important;
    top: 50px !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 50px !important;
    background: rgba(0, 0, 0, 0.5) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    z-index: 999 !important;
    padding: 25px !important;
    opacity: 0 !important;
    visibility: hidden !important;
    transition: all 0.3s !important;
}

/* MODAL CONTENT */
.modal-overlay .modal {
    pointer-events: auto !important;
    max-height: calc(100vh - 140px) !important;
    overflow-y: auto !important;
    width: 100% !important;
    max-width: 500px !important;
}

/* PASTIKAN NAVBAR DI ATAS */
.top-navbar {
    z-index: 1000 !important;
}

.bottom-nav {
    z-index: 1000 !important;
}

/* HP: MODAL LEBIH KECIL */
@media (max-width: 768px) {
    .modal-overlay {
        top: 70px !important;
        bottom: 70px !important;
        padding: 25px !important;
    }
    
    .modal {
        max-width: 100% !important;
    }
}

    </style>
</head>
<body>
    <!-- LOADING OVERLAY -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- LOGIN PAGE -->
    <div id="loginPage">
        <div class="login-card">
            <div class="login-header">


                <div class="app-name">X-BILL</div>
                <div class="app-tagline">Billing Management System</div>
            </div>
            
            <div class="login-body">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="loginUsername" 
                               placeholder="Masukkan username" required
                               >
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" 
                               placeholder="Masukkan password" required
                               >
                    </div>
                    
                        <div class="form-group" style="display:flex; justify-content:center;">

                            <button type="submit"
                            class="btn btn-primary"
                            style="width:20%; padding:60px 0; font-weight:600;">
                        Login
                    </button>

                        </div>
                </form>
            </div>
            
            <div class="login-footer">
                <p>Copyright 2026 | By X-Software</p>
            </div>
        </div>
    </div>


        
    <!-- ========== LOGIN PAGE CUSTOMER ========== -->
    <div id="customerLoginPage" class="hidden">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); padding: 20px;">
            <div class="login-card" style="max-width: 400px;">
                <div class="login-header" style="background: #00b894;">
                    <i class="fas fa-user-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                    <div class="app-name">PORTAL PELANGGAN</div>
                    <div class="app-tagline">Masukkan Nomor HP dan Password</div>
                </div>
                <div class="login-body">
                    <form id="customerLoginForm">
                        <div class="form-group">
                            <label class="form-label">Nomor Telepon</label>
                            <input type="tel" class="form-control" id="customerPhone"
                                   placeholder="Contoh: 081234567890" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="customerPassword"
                                   placeholder="Masukkan password">
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                <i class="fas fa-sign-in-alt"></i> Login
                            </button>
                            <button type="button" id="requestPasswordBtn" class="btn btn-success" style="flex: 1;">
                                <i class="fas fa-paper-plane"></i> Kirim Password
                            </button>
                        </div>
                    </form>

                    <div id="passwordSentMessage" class="hidden" style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; text-align: center;">
                        <i class="fas fa-check-circle" style="color: #00b894; font-size: 24px;"></i>
                        <p style="margin-top: 10px;">Password telah dikirim ke WhatsApp Anda.</p>
                    </div>
                </div>
                <div class="login-footer">
                    <a href="#" onclick="showAdminLoginPage()" style="color: var(--primary); text-decoration: none;">
                        <i class="fas fa-arrow-left"></i> Kembali ke Login Admin
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL KIRIM PASSWORD -->
    <div class="modal-overlay hidden" id="modalRequestPassword">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-key"></i> Kirim Password</h3>
                <button class="modal-close" onclick="hideModal('modalRequestPassword')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nomor Telepon</label>
                    <input type="tel" class="form-control" id="requestPhoneModal"
                           placeholder="Masukkan nomor HP" required>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalRequestPassword')">Batal</button>
                <button class="btn btn-success" onclick="processPasswordRequest()">
                    <i class="fas fa-paper-plane"></i> Kirim
                </button>
            </div>
        </div>
    </div>


    <!-- MODAL PILIH PERUSAHAAN -->
    <div class="modal-overlay hidden" id="modalPilihPerusahaan">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-building"></i> Pilih Perusahaan</h3>
                <button class="modal-close" onclick="hideModal('modalPilihPerusahaan')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Nomor <strong id="displayPhone"></strong> terdaftar di:</p>
                <div id="companyList" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalPilihPerusahaan')">Batal</button>
            </div>
        </div>
    </div>

    <!-- ========== CUSTOMER APP CONTAINER ========== -->
    <div id="customerAppContainer" class="hidden">
        <!-- Top Navbar Customer -->
        <nav class="top-navbar" style="background: white; position: fixed; top: 0; width: 100%; z-index: 1000;">
            <div class="navbar-brand">
                <i class="fas fa-wifi" style="color: #00b894;"></i>

                <span style="margin-left: 8px; font-size: 11px; background: #00b894; color: white; padding: 2px 10px; border-radius: 12px;">Pelanggan</span>
            </div>
            <div class="user-menu" style="gap: 5px;">
                <div style="text-align: right;">
                    <div id="customerNameNav" style="font-weight: 600; font-size: 14px;">Loading...</div>
                    <div id="customerPackageNav" style="font-size: 11px; color: var(--gray);">-</div>
                </div>
                <button id="customerLogoutBtn" class="btn btn-sm" style="border: 1px solid #ff6b6b; background: white; color: #ff6b6b; padding: 6px 12px; border-radius: 6px;" onclick="handleCustomerLogout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </nav>

        <!-- Main Content Customer -->
        <div class="main-content" id="customerMainContent" style="padding-top: 90px; padding-bottom: 80px; max-width: 800px; margin: 0 auto;">
            <!-- Akan diisi JavaScript -->
        </div>

        <!-- Bottom Navigation Customer -->
        <div class="bottom-nav" style="background: white; display: flex; justify-content: space-around; padding: 8px 0;">
            <a href="#customer-home" class="nav-item active" data-customer-page="home">
                <i class="fas fa-home"></i>
                <span>Beranda</span>
            </a>
            <a href="#customer-tagihan" class="nav-item" data-customer-page="tagihan">
                <i class="fas fa-receipt"></i>
                <span>Tagihan</span>
            </a>
            <a href="#customer-gangguan" class="nav-item" data-customer-page="gangguan">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Gangguan</span>
            </a>
            <a href="#customer-profil" class="nav-item" data-customer-page="profil">
                <i class="fas fa-user"></i>
                <span>Profil</span>
            </a>
        </div>
    </div>

    

    <!-- ========== MODAL SETTING KOMPLIT ========== -->

<!-- MODAL 1: PROFIL PERUSAHAAN -->
<div class="modal-overlay hidden" id="modalCompanyProfile">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-building"></i> Profil Perusahaan</h3>
            <button class="modal-close" onclick="hideModal('modalCompanyProfile')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formCompanyProfile">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nama Perusahaan *</label>
                        <input type="text" class="form-control" id="companyName" required>
                    </div>
                    <div class="form-group">
                        <label>Tagline / Slogan</label>
                        <input type="text" class="form-control" id="companyTagline">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Alamat Lengkap *</label>
                        <textarea class="form-control" id="companyAddress" rows="2" required></textarea>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Telepon Kantor *</label>
                        <input type="text" class="form-control" id="companyPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Email Perusahaan</label>
                        <input type="email" class="form-control" id="companyEmail">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Website</label>
                        <input type="url" class="form-control" id="companyWebsite">
                    </div>
                    <div class="form-group">
                        <label>NPWP</label>
                        <input type="text" class="form-control" id="companyNPWP">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nama Direktur/Pemilik</label>
                        <input type="text" class="form-control" id="companyDirector">
                    </div>
                    <div class="form-group">
                        <label>Jenis Usaha</label>
                        <select class="form-control" id="companyType">
                            <option value="isp">ISP / Internet Provider</option>
                            <option value="wifi">Wifi Management</option>
                            <option value="it">IT Services</option>
                            <option value="other">Lainnya</option>
                        </select>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-file-invoice"></i> Informasi Invoice</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Prefix Invoice</label>
                                <input type="text" class="form-control" id="invoicePrefix" value="INV">
                            </div>
                            <div class="form-group">
                                <label>Footer Invoice</label>
                                <textarea class="form-control" id="invoiceFooter" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Terms & Conditions</label>
                                <textarea class="form-control" id="invoiceTerms" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalCompanyProfile')">Batal</button>
            <button class="btn btn-primary" onclick="saveCompanyProfile()">
                <i class="fas fa-save"></i> Simpan Profil
            </button>
        </div>
    </div>
</div>

<!-- MODAL 2: BRANDING & LOGO -->
<div class="modal-overlay hidden" id="modalBranding">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-palette"></i> Logo & Branding</h3>
            <button class="modal-close" onclick="hideModal('modalBranding')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formBranding">
                <!-- LOGO UPLOAD -->
                <div class="form-group text-center" style="margin-bottom: 30px;">
                    <label>Logo Perusahaan</label>
                    <div id="logoDropzone"
                    onclick="document.getElementById('logoUpload').click()"
                    style="border: 2px dashed var(--gray-light);
                            border-radius: 15px;
                            padding: 30px;
                            margin-top: 10px;
                            text-align: center;
                            cursor:pointer;">

                    <input type="file" id="logoUpload" accept="image/*" style="display: none;" onchange="handleLogoUpload(this)">

                    <label style="cursor:pointer; display:block;">

                        <div id="logoPreview" style="
    width: 200px;
    height: auto;
    min-height: 60px;
    max-height: 100px;
    margin: 0 auto;
    background: var(--light);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px;">
                            <i class="fas fa-building" style="font-size: 48px; color: var(--gray);"></i>
                        </div>

                        <p style="color: var(--gray); margin-top: 12px;">
                            Klik untuk upload logo
                        </p>

                    </label>

                    <small class="text-muted">
                        Rekomendasi: 500×500px, PNG/JPG, maks 2MB
                    </small>
                </div>
                </div>
                
                <!-- COLOR SCHEME -->
                <div class="form-group">
                    <label>Warna Utama</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="color" class="form-control" id="primaryColor" value="#4361ee" style="flex: 1;">
                        <input type="color" class="form-control" id="secondaryColor" value="#7209b7" style="flex: 1;">
                    </div>
                </div>
               
                
                
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalBranding')">Batal</button>
            <button class="btn btn-primary" onclick="saveBranding()">
                <i class="fas fa-paint-brush"></i> Terapkan Branding
            </button>
        </div>
    </div>
</div>

<!-- MODAL 3: KONTAK & NOTIFIKASI -->
<div class="modal-overlay hidden" id="modalContactSettings">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-phone-alt"></i> Kontak & Notifikasi</h3>
            <button class="modal-close" onclick="hideModal('modalContactSettings')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formContactSettings">
                <!-- WHATSAPP SETTINGS -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fab fa-whatsapp" style="color: #25D366;"></i> WhatsApp Business</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nomor WhatsApp Pengirim *</label>
                                <input type="text" class="form-control" id="whatsappNumber" 
                                       placeholder="6281234567890" required>
                                <small class="text-muted">Format: 6281234567890 (tanpa +)</small>
                            </div>
                            <div class="form-group">
                                <label>WhatsApp API Key</label>
                                <input type="password" class="form-control" id="whatsappApiKey" 
                                       placeholder="Masukkan API key jika ada">
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enableWhatsApp" checked>
                            <label class="form-check-label">Aktifkan pengiriman otomatis via WhatsApp</label>
                        </div>
                    </div>
                </div>
                
                <!-- EMAIL SETTINGS -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-envelope"></i> Email Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>SMTP Host</label>
                                <input type="text" class="form-control" id="smtpHost" 
                                       placeholder="smtp.gmail.com">
                            </div>
                            <div class="form-group">
                                <label>SMTP Port</label>
                                <input type="number" class="form-control" id="smtpPort" 
                                       placeholder="587" value="587">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Email Pengirim</label>
                                <input type="email" class="form-control" id="smtpEmail" 
                                       placeholder="admin@perusahaan.com">
                            </div>
                            <div class="form-group">
                                <label>Password/App Password</label>
                                <input type="password" class="form-control" id="smtpPassword">
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enableSSL">
                            <label class="form-check-label">Gunakan SSL/TLS</label>
                        </div>
                    </div>
                </div>
                
                <!-- SMS GATEWAY -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h5><i class="fas fa-sms"></i> SMS Gateway</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Provider SMS</label>
                            <select class="form-control" id="smsProvider">
                                <option value="">-- Pilih Provider --</option>
                                <option value="zenziva">Zenziva</option>
                                <option value="nexmo">Nexmo (Vonage)</option>
                                <option value="twilio">Twilio</option>
                                <option value="custom">Custom API</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>API Key</label>
                                <input type="password" class="form-control" id="smsApiKey">
                            </div>
                            <div class="form-group">
                                <label>Secret Key</label>
                                <input type="password" class="form-control" id="smsSecret">
                            </div>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="enableSMS">
                            <label class="form-check-label">Aktifkan pengiriman SMS</label>
                        </div>
                    </div>
                </div>
                
                <!-- NOTIFICATION SETTINGS -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-bell"></i> Pengaturan Notifikasi</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label>Notifikasi untuk Admin</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifNewCustomer" checked>
                                <label class="form-check-label">Pelanggan baru mendaftar</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifPayment" checked>
                                <label class="form-check-label">Pembayaran diterima</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="notifOverdue" checked>
                                <label class="form-check-label">Tagihan overdue</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Jadwal Reminder Otomatis</label>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="reminder3Days">
                                <label class="form-check-label">3 hari sebelum jatuh tempo</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="reminder1Day">
                                <label class="form-check-label">1 hari sebelum jatuh tempo</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="reminderOverdue">
                                <label class="form-check-label">Setelah jatuh tempo</label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalContactSettings')">Batal</button>
            <button class="btn btn-success" onclick="testNotification()">
                <i class="fas fa-paper-plane"></i> Test Notifikasi
            </button>
            <button class="btn btn-primary" onclick="saveContactSettings()">
                <i class="fas fa-save"></i> Simpan Settings
            </button>
        </div>
    </div>
</div>

<!-- MODAL 4: GANTI PASSWORD -->
<div class="modal-overlay hidden" id="modalChangePassword">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-key"></i> Ganti Password</h3>
            <button class="modal-close" onclick="hideModal('modalChangePassword')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formChangePassword">
                <div class="form-group">
                    <label>Password Saat Ini *</label>
                    <input type="password" class="form-control" id="currentPassword" required>
                </div>
                
                <div class="form-group">
                    <label>Password Baru *</label>
                    <input type="password" class="form-control" id="newPassword" required>
                    <div class="password-strength" style="margin-top: 5px;">
                        <div class="strength-bar">
                            <div class="strength-fill" id="passwordStrength"></div>
                        </div>
                        <small id="passwordTips" class="text-muted"></small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Konfirmasi Password Baru *</label>
                    <input type="password" class="form-control" id="confirmPassword" required>
                    <div id="passwordMatch" style="display: none; color: var(--success); margin-top: 5px;">
                        <i class="fas fa-check-circle"></i> Password cocok
                    </div>
                    <div id="passwordMismatch" style="display: none; color: var(--danger); margin-top: 5px;">
                        <i class="fas fa-times-circle"></i> Password tidak cocok
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> Tips Password Aman:</h6>
                    <ul style="margin-bottom: 0; font-size: 13px;">
                        <li>Minimal 8 karakter</li>
                        <li>Kombinasi huruf besar & kecil</li>
                        <li>Minimal 1 angka dan 1 simbol</li>
                        <li>Jangan gunakan password yang mudah ditebak</li>
                    </ul>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalChangePassword')">Batal</button>
            <button class="btn btn-primary" onclick="changePassword()">
                <i class="fas fa-key"></i> Ganti Password
            </button>
        </div>
    </div>
</div>

<!-- MODAL 5: PROFIL USER -->
<div class="modal-overlay hidden" id="modalUserProfile">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-user"></i> Profil Saya</h3>
            <button class="modal-close" onclick="hideModal('modalUserProfile')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formUserProfile">
                <div class="text-center mb-4">
                    <div style="width: 100px; height: 100px; border-radius: 50%; background: var(--gradient); 
                          margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; 
                          color: white; font-size: 36px; cursor: pointer;" 
                          onclick="document.getElementById('userPhotoUpload').click()" id="userPhotoPreview">
                        <span id="userInitials">A</span>
                        <img id="userPhotoImg" src="" style="width: 100%; height: 100%; border-radius: 50%; display: none;">
                    </div>
                    <input type="file" id="userPhotoUpload" accept="image/*" style="display: none;" 
                           onchange="uploadUserPhoto(this)">
                    <small class="text-muted">Klik untuk ganti foto profil</small>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nama Lengkap *</label>
                        <input type="text" class="form-control" id="userFullName" required>
                    </div>
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" class="form-control" id="userUsername" required readonly>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="userEmail">
                    </div>
                    <div class="form-group">
                        <label>Telepon</label>
                        <input type="text" class="form-control" id="userPhone">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Alamat</label>
                    <textarea class="form-control" id="userAddress" rows="2"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Role</label>
                        <input type="text" class="form-control" id="userRoleInput" readonly>
                    </div>
                    <div class="form-group">
                        <label>Bergabung Sejak</label>
                        <input type="text" class="form-control" id="userJoinDate" readonly>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Bio/Signature</label>
                    <textarea class="form-control" id="userBio" rows="2" 
                              placeholder="Tulis bio atau signature untuk invoice..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalUserProfile')">Batal</button>
            <button class="btn btn-primary" onclick="saveUserProfile()">
                <i class="fas fa-save"></i> Simpan Profil
            </button>
        </div>
    </div>
</div>

<!-- MODAL 6: TEMPLATE PESAN -->
 
<div class="modal-overlay hidden" id="modalMessageTemplates">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-comment-alt"></i> Template Pesan</h3>
            <button class="modal-close" onclick="hideModal('modalMessageTemplates')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h5><i class="fas fa-variables"></i> Variabel yang Tersedia</h5>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <span class="badge badge-info">[nama_pelanggan]</span>
                        <span class="badge badge-info">[nama_perusahaan]</span>
                        <span class="badge badge-info">[bulan_tagihan]</span>
                        <span class="badge badge-info">[jumlah_tagihan]</span>
                        <span class="badge badge-info">[jatuh_tempo]</span>
                        <span class="badge badge-info">[invoice_number]</span>
                        <span class="badge badge-info">[link_pembayaran]</span>
                        <span class="badge badge-info">[no_telepon_admin]</span>
                        <span class="badge badge-info">[alamat_perusahaan]</span>
                        <span class="badge badge-info">[website_perusahaan]</span>
                    </div>
                </div>
            </div>
            
            <!-- TEMPLATE REMINDER -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h5><i class="fas fa-bell"></i> Template Reminder Tagihan</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Reminder 3 Hari Sebelum Jatuh Tempo</label>
                        <textarea class="form-control" id="templateReminder3Days" rows="3">
Yth. [nama_pelanggan],
Tagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan] akan jatuh tempo pada [jatuh_tempo].
Silakan lakukan pembayaran sebelum jatuh tempo.
Terima kasih.
[nama_perusahaan]</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Reminder 1 Hari Sebelum Jatuh Tempo</label>
                        <textarea class="form-control" id="templateReminder1Day" rows="3">
Yth. [nama_pelanggan],
Besok adalah jatuh tempo tagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan].
Segera lakukan pembayaran untuk menghindari denda.
Terima kasih.
[nama_perusahaan]</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Peringatan Telat Bayar</label>
                        <textarea class="form-control" id="templateOverdue" rows="3">
Yth. [nama_pelanggan],
Tagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan] TELAT BAYAR.
Silakan segera lakukan pembayaran untuk menghindari pemutusan layanan.
Terima kasih.
[nama_perusahaan]</textarea>
                    </div>
                </div>
            </div>

            
            <!-- TEMPLATE KONFIRMASI -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h5><i class="fas fa-check-circle"></i> Template Konfirmasi</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Konfirmasi Pembayaran Diterima</label>
                        <textarea class="form-control" id="templatePaymentConfirmed" rows="3">
Yth. [nama_pelanggan],
Pembayaran tagihan [invoice_number] sebesar [jumlah_tagihan] telah kami terima.
Terima kasih telah melakukan pembayaran tepat waktu.
[nama_perusahaan]</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Notifikasi Tagihan Baru</label>
                        <textarea class="form-control" id="templateNewInvoice" rows="3">
Yth. [nama_pelanggan],
Tagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan] telah tersedia.
Jatuh tempo: [jatuh_tempo]
Link pembayaran: [link_pembayaran]
Terima kasih.
[nama_perusahaan]</textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalMessageTemplates')">Batal</button>
            <button class="btn btn-primary" onclick="saveMessageTemplates()">
                <i class="fas fa-save"></i> Simpan Template
            </button>
        </div>
    </div>
</div>



    
    <div id="appContainer" class="hidden">
    
    <!-- ⭐ NAVBAR DI DALAM CONTAINER ⭐ -->
        <nav class="top-navbar">
            <div class="navbar-brand">
                <img src="./logo.png"
                     style="height:35px;
                    width:auto;
                    object-fit:contain;
                    margin-right:10px;">

            </div>


            <div class="user-menu">


                <div class="user-info" style="cursor: pointer;" id="userProfileBtn">

                    <div>
        <div id="userName">admin@xbill.com</div>
        <!-- ⭐⭐ TAMBAH INI UNTUK WAKTU ⭐⭐ -->
        <div id="userTime" style="font-size: 11px; color: var(--gray);">
            <i class="fas fa-clock"></i> <span id="currentTime">Loading...</span>
        </div>
    </div>
</div>
            
            <!-- TOMBOL LOGOUT (HAPUS onclick="handleLogout()") -->
            <button id="logoutBtnSmall" style="margin-left: 5px; border: none; background: transparent; color: var(--danger); cursor: pointer; padding: 8px 10px; border-radius: 8px; transition: all 0.3s; display: flex; align-items: center;" title="Keluar">
                <i class="fas fa-sign-out-alt" style="font-size: 18px;"></i>
            </button>

            <!-- DROPDOWN BUTTON (GEAR) -->
            <div class="dropdown" style="position: relative;">
                
                
                <!-- DROPDOWN MENU -->
                <div class="dropdown-menu" id="settingDropdown" style="position: absolute; top: 100%; right: 0; background: white; border-radius: 12px; 
                            box-shadow:0 10px 40px rgba(0,0,0,0.2); min-width: 320px; z-index: 1000; 
                            display: none; margin-top: 10px; border:1px solid var(--gray-light); overflow: hidden;">
                    
                    <!-- Header -->
                    <div style="background: var(--gradient); padding:20px; color: white;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div id="dropdownLogo" style="width: 50px; height: 50px; border-radius: 10px; 
                                  background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-building" style="font-size: 24px;"></i>
                            </div>
                            <div>
                                <h4 id="dropdownCompanyName" style="margin: 0; font-weight: 600;">X-BILL</h4>
                                <small id="dropdownCompanyTagline" style="opacity: 0.9;">Billing Management System</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Menu Items -->
                    <div style="max-height: 400px; overflow-y: auto;">
                        <a href="javascript:void(0)" class="dropdown-item" onclick="showCompanyProfile()">
                            <i class="fas fa-building" style="color: #4361ee;"></i> Profil Perusahaan
                        </a>
                        <!-- ... item menu lainnya ... -->
                        <a href="javascript:void(0)" class="dropdown-item" onclick="showUserProfile()">
                            <i class="fas fa-user" style="color: #00cec9;"></i> Profil Saya
                        </a>
                        <a href="javascript:void(0)" class="dropdown-item" onclick="showChangePassword()">
                            <i class="fas fa-key" style="color: #fd79a8;"></i> Ganti Password
                        </a>
                        
                        <hr style="margin: 10px 20px;">
                        
                        <!-- LOGOUT DROPDOWN -->
                        <a href="javascript:void(0)" class="dropdown-item" onclick="performLogout()" style="color: var(--danger);">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                    
                    <!-- Footer -->
                    <div style="background: var(--light); padding: 10px 20px; border-top:1px solid var(--gray-light); font-size: 12px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span id="systemVersion">v2.1.0</span>
                            <span id="lastBackup">Backup: 2 hari lalu</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- ⭐ MAIN CONTENT (WAJIB DI DALAM appContainer) ⭐ -->
    <div class="main-content" id="mainContent">
        <!-- Pages will be dynamically loaded here -->
    </div>
    
    <!-- ⭐ BOTTOM NAVIGATION (WAJIB ADA & DI DALAM appContainer) ⭐ -->
    <div class="bottom-nav">
        <a href="#dashboard" class="nav-item active" data-page="dashboard">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="#pelanggan" class="nav-item" data-page="pelanggan">
            <i class="fas fa-users"></i>
            <span>Pelanggan</span>
        </a>
        <a href="#paket" class="nav-item" data-page="paket">
            <i class="fas fa-wifi"></i>
            <span>Paket</span>
        </a>
        <a href="#tagihan" class="nav-item" data-page="tagihan">
            <i class="fas fa-receipt"></i>
            <span>Tagihan</span>
        </a>
        <a href="#tunggakan" class="nav-item" data-page="tunggakan">
            <i class="fas fa-clock"></i>
            <span>Tunggakan</span>
        </a>
        <a href="#laporan" class="nav-item" data-page="laporan">
            <i class="fas fa-chart-bar"></i>
            <span>Laporan</span>
        </a>
         <a href="#setting" class="nav-item" data-page="setting">
            <i class="fas fa-cog"></i>
            <span>Setting</span>
        </a>
    </div>

</div> <!-- TUTUP appContainer -->
    
    <!-- ========== MODALS ========== -->
    
  <!-- MODAL: TAMBAH/EDIT PELANGGAN (REVISED) -->
<div class="modal-overlay hidden" id="modalPelanggan">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Data Pelanggan</h3>
            <button class="modal-close" onclick="forceCloseModal('modalPelanggan')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formPelanggan">
                <!-- BARIS 0: SERVER/WILAYAH (BARU - INPUT TEXT) -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Server (Wilayah)</label>
                        <input type="text" class="form-control" id="pelangganServer" 
                               placeholder="Contoh: Server Utama, Server Timur, dll">
                    </div>
                    
                </div>
            </form>
        </div>
        <div class="modal-body">
            <form id="formPelanggan">
                <!-- BARIS 1: NAMA & TELEPON -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nama Lengkap *</label>
                        <input type="text" class="form-control" id="pelangganNama" 
       placeholder="Nama Pelanggan" required
       style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telepon *</label>
                        <input type="tel" class="form-control" id="pelangganTelepon" 
       placeholder="08xxxxxxxxxx" required
       inputmode="numeric" pattern="[0-9]*">
                    </div>
                </div>
                
                <!-- BARIS 2: PAKET & HARGA -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Paket *</label>
                        <select class="form-control" id="pelangganPaket" required>
                            <option value="">-- Pilih Paket --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Harga *</label>
                        <input type="number" class="form-control" id="pelangganHarga" placeholder="0" required>
                    </div>
                </div>

                <!-- BARIS 3: TANGGAL PASANG & STATUS -->
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tanggal Pasang *</label>
                        <input type="date" class="form-control" id="pelangganTanggalPasang" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select class="form-control" id="pelangganStatus" required>
                            <option value="aktif">Aktif</option>
                            <option value="nonaktif">Nonaktif</option>
                            <option value="tunggak">Tunggak</option>
                        </select>
                    </div>
                </div>

                <!-- BARIS 4: ALAMAT (FULL WIDTH) -->
                <div class="form-group">
                    <label class="form-label">Alamat *</label>
                    <textarea class="form-control" id="pelangganAlamat" rows="2" 
                              placeholder="Alamat Lengkap" required
                              style="text-transform: uppercase;"></textarea> <!-- ✅ TAMBAH INI -->
                </div>

                <!-- BARIS 5: KOORDINAT (FULL WIDTH + TOMBOL RAPI) -->
                <div class="form-group">
                    <label class="form-label">Koordinat GPS</label>
                    <div style="display: flex; gap: 10px; align-items: stretch;">
                        <input type="text" class="form-control" id="pelangganKoordinat" 
                               placeholder="Contoh: -6.2088, 106.8456" readonly 
                               style="background: #f8f9fa; color: #495057;">
                        
                        <button type="button" class="btn btn-info" onclick="getLocation()" 
                                style="display: flex; align-items: center; justify-content: center; min-width: 120px;">
                            <i class="fas fa-crosshairs" style="margin-right: 5px;"></i> Set Lokasi
                        </button>
                    </div>
                </div>
                
                <!-- BARIS 6: CATATAN (FULL WIDTH) -->
                <div class="form-group">
                    <label class="form-label">Catatan</label>
                    <textarea class="form-control" id="pelangganCatatan" rows="2"></textarea>
                </div>
                
                <input type="hidden" id="pelangganId">
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="forceCloseModal('modalPelanggan')">Batal</button>
            <button type="button" class="btn btn-primary" onclick="savePelanggan()">
                <i class="fas fa-save"></i> Simpan Data
            </button>
        </div>
    </div>
</div>
    
    <!-- MODAL: TAMBAH/EDIT PAKET -->
    <div class="modal-overlay hidden" id="modalPaket">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Tambah Paket</h3>
                <button class="modal-close" onclick="hideModal('modalPaket')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formPaket">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nama Paket *</label>
                            <input type="text" class="form-control" id="paketNama" placeholder="Contoh: 10 Mbps" required>
                        </div>
                        <div class="form-group">
                            <label>Kecepatan *</label>
                            <input type="text" class="form-control" id="paketKecepatan" placeholder="Contoh: 10 Mbps" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Harga Bulanan *</label>
                            <input type="number" class="form-control" id="paketHarga" required>
                        </div>
                        <div class="form-group">
                            <label>Kuota</label>
                            <input type="text" class="form-control" id="paketKuota" placeholder="Contoh: Unlimited">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Deskripsi</label>
                        <textarea class="form-control" id="paketDeskripsi" rows="2"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Fitur</label>
                        <textarea class="form-control" id="paketFitur" rows="3" placeholder="Pisahkan dengan koma"></textarea>
                        <small class="text-muted">Contoh: Unlimited Bandwidth, 24/7 Support, Free Router</small>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Warna</label>
                            <input type="color" class="form-control" id="paketWarna" value="#4361ee">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-control" id="paketStatus">
                                <option value="aktif">Aktif</option>
                                <option value="nonaktif">Nonaktif</option>
                            </select>
                        </div>
                    </div>
                    
                    <input type="hidden" id="paketId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalPaket')">Batal</button>
                <button class="btn btn-primary" onclick="savePaket()">Simpan Paket</button>
            </div>
        </div>
    </div>
    
   
    
    <!-- MODAL: GENERATE TAGIHAN ARREARS (YANG BENAR) -->
<div class="modal-overlay hidden" id="modalGenerateTagihan">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-bolt"></i> Generate Tagihan </h3>
            <button class="modal-close" onclick="forceCloseModal('modalGenerateTagihan')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formGenerateTagihan">
                <!-- TIMELINE ARREARS EXPLANATION -->
                <div class="alert alert-info" style="background: #e7f3ff; border-left: 4px solid #4361ee; padding: 15px; margin-bottom: 20px;">
                    <h5 style="color: #4361ee; margin-top: 0;">
                        <i class="fas fa-calendar-alt"></i> Timeline Sistem 
                    </h5>
                    <p style="margin-bottom: 5px;">
                        <strong>Pilih bulan untuk GENERATE tagihan:</strong>
                    </p>
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px; font-size: 14px;">
                        <div style="color: var(--primary); font-weight: bold;">Jan 2025</div>
                        <div>→ Generate tagihan untuk <strong>Desember 2024</strong> (pemakaian bulan sebelumnya)</div>
                        <div style="color: var(--success); font-weight: bold;">Jatuh Tempo</div>
                        <div>→ 10 Februari 2025 (bulan BERIKUTNYA setelah pemakaian)</div>
                    </div>
                    <hr style="margin: 10px 0;">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Sistem <strong></strong>: Tagihan untuk pemakaian bulan SEBELUMNYA, 
                        jatuh tempo di bulan BERIKUTNYA. Contoh: Pakai di Desember, bayar di Januari.
                    </small>
                </div>
                
                <!-- INPUT FIELDS -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Bulan Generate *</label>
                        <input type="month" class="form-control" id="generateBulan" 
       value="2025-01" 
       onchange="updateArrearsTimeline()" required>
                        <small class="text-muted">Bulan saat generate tagihan</small>
                    </div>
                    <div class="form-group">
                        <label>Tanggal Jatuh Tempo (tgl) *</label>
                        <input type="number" class="form-control" id="generateJatuhTempo" 
                               min="1" max="31" value="10" required>
                        <small class="text-muted">Tanggal jatuh tempo di bulan berikutnya</small>
                    </div>
                </div>


                
                <!-- SUMMARY GENERATE -->
                <div id="generateSummary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h5><i class="fas fa-calculator"></i> Rincian Generate :</h5>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                        <div>
                            <p><strong>Bulan Pemakaian:</strong> 
                               <span id="summaryBulanPemakaian" style="color: var(--primary); font-weight: bold;">-</span>
                            </p>
                            <p><strong>Jumlah Tagihan:</strong> 
                               <span id="summaryJumlahTagihan" style="color: var(--primary); font-weight: bold;">0</span>
                            </p>
                            <p><strong>Estimasi Total:</strong> 
                               <span id="summaryEstimasiTotal" style="color: var(--success); font-weight: bold;">Rp 0</span>
                            </p>
                        </div>
                        <div>
                            <p><strong>Bulan Jatuh Tempo:</strong> 
                               <span id="summaryBulanJatuhTempo" style="color: var(--danger); font-weight: bold;">-</span>
                            </p>
                            <p><strong>Estimasi Waktu:</strong> 
                               <span id="summaryWaktu" style="font-weight: bold;">~5 detik</span>
                            </p>
                            <p><strong>Denda Termasuk:</strong> 
                               <span id="summaryDenda" style="color: var(--danger); font-weight: bold;">Rp 0</span>
                            </p>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline" onclick="forceCloseModal('modalGenerateTagihan')">Batal</button>
            <button type="button" class="btn btn-info" onclick="loadTunggakanDataForModal()">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
            <button type="button" class="btn btn-primary" onclick="generateTagihanBulk()">
                <i class="fas fa-bolt"></i> Generate Tagihan 
            </button>
        </div>
    </div>
</div>
    
    <!-- MODAL: BAYAR TAGIHAN -->
    <div class="modal-overlay hidden" id="modalBayarTagihan">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-money-bill-wave"></i> Pembayaran Tagihan</h3>
                <button class="modal-close" onclick="hideModal('modalBayarTagihan')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formBayarTagihan">
                    <div class="form-group">
                        <label>Invoice</label>
                        <input type="text" class="form-control" id="bayarInvoice" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Pelanggan</label>
                        <input type="text" class="form-control" id="bayarPelanggan" readonly>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Jumlah Tagihan</label>
                            <input type="text" class="form-control" id="bayarJumlah" readonly>
                        </div>
                        <div class="form-group">
                            <label>Denda Keterlambatan</label>
                            <input type="text" class="form-control" id="bayarDenda" value="0" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Total Bayar *</label>
                        <input type="number" class="form-control" id="totalBayar" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Metode Pembayaran *</label>
                        <select class="form-control" id="metodeBayar" required>
                            <option value="">Pilih Metode</option>
                            <option value="tunai">Tunai</option>
                            <option value="transfer">Transfer Bank</option>
                            <option value="qris">QRIS</option>
                            <option value="gopay">GoPay</option>
                            <option value="ovo">OVO</option>
                            <option value="dana">DANA</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tanggal Bayar *</label>
                            <input type="date" class="form-control" id="tanggalBayar" required>
                        </div>
                        <div class="form-group">
                            <label>No. Referensi</label>
                            <input type="text" class="form-control" id="referensiBayar" placeholder="No. transaksi/bukti">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Catatan</label>
                        <textarea class="form-control" id="catatanBayar" rows="2"></textarea>
                    </div>
                    
                    <input type="hidden" id="tagihanId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalBayarTagihan')">Batal</button>
                <button class="btn btn-success" onclick="konfirmasiPembayaran()">
                    <i class="fas fa-check-circle"></i> Konfirmasi Pembayaran
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: KIRIM REMINDER -->
<div class="modal-overlay hidden" id="modalReminder">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-envelope"></i> Kirim Reminder Tagihan</h3>
            <button class="modal-close" onclick="hideModal('modalReminder')">&times;</button>
        </div>
        <div class="modal-body">
            <!-- SUMMARY BOX -->
            <div class="summary-box" style="background: #f0f9ff; border-left: 4px solid #3498db; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4 style="margin-top: 0; color: #2c3e50;">
                    <i class="fas fa-info-circle"></i> Summary Pengiriman
                </h4>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div>
                        <small style="color: #7f8c8d;">Jumlah Pelanggan</small>
                        <div style="font-size: 24px; font-weight: bold; color: #2c3e50;" id="summaryJumlahPelanggan">0</div>
                    </div>
                    <div>
                        <small style="color: #7f8c8d;">Media</small>
                        <div style="font-size: 16px; font-weight: bold; color: #3498db;" id="summaryMedia">WhatsApp</div>
                    </div>
                    <div>
                        <small style="color: #7f8c8d;">Jadwal Kirim</small>
                        <div style="font-size: 16px; font-weight: bold; color: #27ae60;" id="summaryWaktuReminder">Sekarang</div>
                    </div>
                </div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                    <small style="color: #7f8c8d;">Status:</small>
                    <span id="summaryStatus" class="badge badge-warning" style="margin-left: 10px;">MENUNGGU</span>
                </div>
            </div>
            
            <!-- LIST PELANGGAN YANG AKAN DIKIRIM -->
            <div class="form-group">
                <label style="font-weight: bold; margin-bottom: 10px; display: block;">
                    <i class="fas fa-users"></i> Pelanggan dengan Tunggakan (Otomatis Terpilih)
                </label>
                <div id="reminderPelangganList" style="
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    padding: 15px;
                    max-height: 200px;
                    overflow-y: auto;
                    background: #f8f9fa;
                ">
                    <div class="text-center text-muted" style="padding: 20px;">
                        <i class="fas fa-spinner fa-spin"></i> Memuat daftar pelanggan...
                    </div>
                </div>
                <small class="text-muted">Semua pelanggan dengan tagihan belum lunas akan dikirimi reminder</small>
            </div>
            
            <!-- TYPE REMINDER -->
            <div class="form-group">
                <label>Media Pengiriman</label>
                <select class="form-control" id="reminderType" onchange="updateSummaryReminder()">
                    <option value="whatsapp">WhatsApp</option>
                    <option value="email">Email</option>
                    <option value="sms">SMS</option>
                </select>
            </div>
            
            <!-- JADWAL KIRIM -->
            <div class="form-group">
                <label>Jadwal Kirim</label>
                <select class="form-control" id="reminderSchedule" onchange="updateSummaryReminder()">
                    <option value="now">Sekarang</option>
                    <option value="tomorrow">Besok Pagi (08:00)</option>
                    <option value="afternoon">Sore Ini (16:00)</option>
                </select>
            </div>
            
            <!-- PREVIEW PESAN -->
            <div class="form-group">
                <label>Pesan Reminder</label>
                <textarea class="form-control" id="previewPesan" rows="6" style="font-family: 'Segoe UI', Arial, sans-serif; font-size: 14px;">
Halo [Nama],

Ini adalah pengingat untuk tagihan internet Anda yang belum lunas.

Silakan lakukan pembayaran segera.

Terima kasih,
[Perusahaan Anda]
                </textarea>
                <small class="text-muted">Pesan akan dikirim ke semua pelanggan di atas</small>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalReminder')">Batal</button>
            <button class="btn btn-primary" onclick="kirimReminder()" style="padding: 10px 25px;">
                <i class="fas fa-paper-plane"></i> Kirim ke Semua Pelanggan
            </button>
        </div>
    </div>
</div>
    
    <!-- MODAL: EXPORT LAPORAN -->
    <div class="modal-overlay hidden" id="modalExportLaporan">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-export"></i> Export Laporan</h3>
                <button class="modal-close" onclick="hideModal('modalExportLaporan')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formExportLaporan">
                    <div class="form-group">
                        <label>Tipe Laporan *</label>
                        <select class="form-control" id="exportLaporanType" required>
                            <option value="">Pilih Tipe</option>
                            <option value="keuangan">Laporan Keuangan</option>
                            <option value="pelanggan">Laporan Pelanggan</option>
                            <option value="tagihan">Laporan Tagihan</option>
                            <option value="tunggakan">Laporan Tunggakan</option>
                            <option value="paket">Laporan Paket</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Periode Awal</label>
                            <input type="date" class="form-control" id="exportStartDate">
                        </div>
                        <div class="form-group">
                            <label>Periode Akhir</label>
                            <input type="date" class="form-control" id="exportEndDate">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Format File *</label>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="exportFormat" id="formatExcel" value="excel" checked>
                            <label class="form-check-label" for="formatExcel">Excel (.xlsx)</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="exportFormat" id="formatPDF" value="pdf">
                            <label class="form-check-label" for="formatPDF">PDF (.pdf)</label>
                        </div>
                        <div class="form-check">
                            <input type="radio" class="form-check-input" name="exportFormat" id="formatCSV" value="csv">
                            <label class="form-check-label" for="formatCSV">CSV (.csv)</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Include Data</label>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="includeCharts" checked>
                            <label class="form-check-label" for="includeCharts">Grafik</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="includeSummary" checked>
                            <label class="form-check-label" for="includeSummary">Ringkasan</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="includeDetail">
                            <label class="form-check-label" for="includeDetail">Detail Data</label>
                        </div>
                    </div>
                    
                    <div id="exportSummary" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4>Summary Export:</h4>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Tipe: <span id="summaryTipe" style="font-weight: bold;">-</span></li>
                            <li>Format: <span id="summaryFormat" style="font-weight: bold;">Excel</span></li>
                            <li>Estimasi waktu: <span id="summaryEstimasi" style="font-weight: bold;">5 detik</span></li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalExportLaporan')">Batal</button>
                <button class="btn btn-success" onclick="exportLaporan()">
                    <i class="fas fa-download"></i> Download Laporan
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL: BACKUP DATA -->
    <div class="modal-overlay hidden" id="modalBackup">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-database"></i> Backup Data</h3>
                <button class="modal-close" onclick="hideModal('modalBackup')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Tipe Backup</label>
                    <select class="form-control" id="backupType">
                        <option value="full">Full Backup (Semua Data)</option>
                        <option value="pelanggan">Data Pelanggan</option>
                        <option value="tagihan">Data Tagihan</option>
                        <option value="paket">Data Paket</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Format Backup</label>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="backupFormat" id="backupJSON" value="json" checked>
                        <label class="form-check-label" for="backupJSON">JSON</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="backupFormat" id="backupCSV" value="csv">
                        <label class="form-check-label" for="backupCSV">CSV</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="backupFormat" id="backupExcel" value="excel">
                        <label class="form-check-label" for="backupExcel">Excel</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Enkripsi Data</label>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="encryptData">
                        <label class="form-check-label" for="encryptData">Enkripsi dengan password</label>
                    </div>
                </div>
                
                <div id="passwordSection" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" class="form-control" id="backupPassword">
                        </div>
                        <div class="form-group">
                            <label>Konfirmasi Password</label>
                            <input type="password" class="form-control" id="backupPasswordConfirm">
                        </div>
                    </div>
                </div>
                
                <div class="backup-status">
                    <h4>Backup Terakhir:</h4>
                    <div class="backup-item">
                        <span>Full Backup</span>
                        <span>2 hari lalu</span>
                    </div>
                    <div class="backup-item">
                        <span>Data Pelanggan</span>
                        <span>1 minggu lalu</span>
                    </div>
                    <div class="backup-item">
                        <span>Data Tagihan</span>
                        <span>3 hari lalu</span>
                    </div>
                </div>
                
                <div id="backupProgress" style="margin-top: 20px; display: none;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <h4>Progress Backup:</h4>
                        <div style="background: #e9ecef; height: 10px; border-radius: 5px; margin: 10px 0;">
                            <div id="progressBar" style="background: var(--primary); height: 100%; width: 0%; border-radius: 5px; transition: width 0.3s;"></div>
                        </div>
                        <div id="progressText" style="text-align: center; font-weight: bold;">0%</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalBackup')">Batal</button>
                <button class="btn btn-info" onclick="startBackup()">
                    <i class="fas fa-play"></i> Mulai Backup
                </button>
                <button class="btn btn-success" onclick="restoreBackup()">
                    <i class="fas fa-upload"></i> Restore
                </button>
            </div>
        </div>
    </div>


    <!-- MODAL: DETAIL LUNAS BULAN INI -->
<div class="modal-overlay hidden" id="modalLunasBulanIni">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-check-circle" style="color: var(--success);"></i> Detail Pelunasan Bulan Ini</h3>
            <button class="modal-close" onclick="hideModal('modalLunasBulanIni')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">No</th>
                            <th style="width: 20%;">Nama</th>
                            <th style="width: 15%;">Tagihan</th>
                            <th style="width: 15%;">Periode</th>
                            <th style="width: 10%;">Status</th>
                            <th style="width: 15%;">Tgl Bayar</th>
                            <th style="width: 20%;">Petugas</th>
                        </tr>
                    </thead>
                    <tbody id="lunasBulanIniTable">
                        <tr><td colspan="8" class="text-center">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div id="lunasPagination" class="mt-3"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalLunasBulanIni')">Tutup</button>
        </div>
    </div>
</div>


<!-- MODAL: DETAIL TUNGGAKAN -->
<!-- ⭐⭐ MODAL DETAIL TUNGGAKAN ⭐⭐ -->
<div class="modal-overlay hidden" id="modalDetailTunggakan">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-clock" style="color: var(--danger);"></i> Detail Tunggakan</h3>
            <button class="modal-close" onclick="hideModal('modalDetailTunggakan')">&times;</button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div class="table-responsive">
                <table class="table" style="font-size: 12px;">
                    <thead>
                        <tr>
                            <th style="width: 8%; font-size: 11px;">Server</th>
                            <th style="width: 18%; font-size: 11px;">Pelanggan</th>
                            <th style="width: 12%; font-size: 11px;">Lokasi</th>
                            <th style="width: 12%; font-size: 11px;">Bulan</th>
                            <th style="width: 12%; font-size: 11px;">Nominal</th>
                            <th style="width: 12%; font-size: 11px;">Jatuh Tempo</th>
                            <th style="width: 8%; font-size: 11px;">Kategori</th>
                            <th style="width: 8%; font-size: 11px;">Status</th>
                            <th style="width: 10%; font-size: 11px;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="tunggakanTable">
                        <!-- Data akan diisi -->
                    </tbody>
                </table>
            </div>
            <div id="tunggakanPagination" class="mt-3"></div>
        </div>
        <div class="modal-footer" style="padding: 10px 15px;">
            <button class="btn btn-outline" onclick="hideModal('modalDetailTunggakan')" style="padding: 8px 15px; font-size: 12px;">Tutup</button>
        </div>
    </div>
</div>


<!-- TAMBAHKAN DI BAWAH MODAL LAIN -->
<!-- PASTIKAN ADA DI FILE ANDA -->
<div class="modal-overlay hidden" id="modalTambahServerKecil">
    <div class="modal" style="max-width: 400px; background: white; border-radius: 15px; padding: 0; overflow: hidden;">
        <div class="modal-header" style="background: #4361ee; color: white; padding: 20px;">
            <h3 class="modal-title" style="margin: 0;"><i class="fas fa-plus-circle"></i> Tambah Server</h3>
            <button class="modal-close" onclick="hideModal('modalTambahServerKecil')" style="color: white; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <div class="form-group">
                <label>Nama Server *</label>
                <input type="text" class="form-control" id="inputServerBaru" 
                       placeholder="Contoh: Server Utama" style="padding: 12px;">
            </div>
        </div>
        <div class="modal-footer" style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #ddd;">
            <button class="btn btn-outline" onclick="hideModal('modalTambahServerKecil')" style="padding: 10px 20px;">Batal</button>
            <button class="btn btn-primary" onclick="simpanServerModal()" style="padding: 10px 20px;">
                <i class="fas fa-save"></i> Simpan
            </button>
        </div>
    </div>
</div>

<!-- MODAL IMPORT PAKET -->
<div class="modal-overlay hidden" id="modalImportPaket">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-file-import"></i> Import Data Paket</h3>
            <button class="modal-close" onclick="hideModal('modalImportPaket')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Pilih File Excel/CSV</label>
                <input type="file" class="form-control" id="fileImportPaket" 
                       accept=".xlsx,.xls,.csv">
                <small class="text-muted">Format: Excel (.xlsx, .xls) atau CSV</small>
            </div>
            
            <div class="alert alert-info">
                <h6><i class="fas fa-info-circle"></i> Logika Import:</h6>
                <p style="margin: 5px 0; font-size: 12px;">
                    • Data yang <strong>sudah ada</strong> (nama+kecepatan+harga sama) akan <strong>dilewati</strong><br>
                    • Hanya data <strong>baru</strong> yang akan dimasukkan<br>
                    • Untuk update data existing, gunakan tombol <strong>Edit</strong> di tabel
                </p>
            </div>
            
            <div class="alert alert-success">
                <h6><i class="fas fa-download"></i> Template:</h6>
                <p style="margin: 5px 0; font-size: 12px;">
                    <a href="javascript:void(0)" onclick="downloadTemplatePaket()" 
                       style="color: var(--primary); text-decoration: underline;">
                       Download Template Excel
                    </a>
                </p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalImportPaket')">Batal</button>
            <button class="btn btn-success" onclick="importDataPaket()">
                <i class="fas fa-upload"></i> Import Data Baru
            </button>
        </div>
    </div>
</div>  

    
    <!-- ========== ALL JAVASCRIPT ========== -->
    <script>
        // ============================================
        // CONFIGURATION & INITIALIZATION
        // ============================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyBocAz1byGPHa3ky2Wsj5wQMCtAHdJH48w",
            authDomain: "dnt-network-nota.firebaseapp.com",
            projectId: "dnt-network-nota",
            storageBucket: "dnt-network-nota.firebasestorage.app",
            messagingSenderId: "896578021877",
            appId: "1:896578021877:web:2c882371b4673e7c18d8bc",
            measurementId: "G-NJYGGK0S0H"
        };
        
        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized");
        } catch (error) {
            console.log("Firebase already initialized");
        }
        
            const db = firebase.firestore();
            let currentUser = null;
            let currentPage = 'dashboard';
            let pelangganData = [];
            let paketData = [];
            let tagihanData = [];
            let globalDataPelanggan = {};
            let globalCompanyId = null;
            let mapAlreadyLoaded = false;
            var isAdmin = false;



            // ================================
            // PAGINATION & PAGE STATE
            // ================================
            let currentPagePelanggan = 1;
            let currentPageTagihan = 1;
            let currentPageTunggakan = 1;
            let currentPagePaket = 1;
            let currentPageAktivitas = 1;
            let lastBackPress = 0;
            let pageHistory = ['dashboard'];

            const itemsPerPage = 10;

            // ================================
            // READ COUNTER
            // ================================
            let readsCounter = {
                dashboard: 0,
                aktivitas: 0,
                generate: 0,
                pelanggan: 0,
                tagihan: 0,
                total: 0
            };

            // ================================
            // MAP GLOBAL
            // ================================
            window.pelangganMap = null;
            window.mapMarkers = [];
            window.isMapInitialized = false;
            window.mapLoading = false;
            window.lastMapLoadTime = 0;

            // ================================
            // 🔥 CACHE (TARUH DI SINI)
            // ================================
            window._tunggakanCache = null;
            window._tunggakanCacheTime = 0;
            const TUNGGAKAN_CACHE_TTL = 60 * 1000; // 60 detik
            window._pelangganCache = null;
            window._pelangganCacheTime = 0;
            const PELANGGAN_CACHE_TTL = 5 * 60 * 1000; // 5 menit
            // CACHE DASHBOARD
            window._dashboardCache = null;
            window._dashboardCacheTime = 0;
            const DASHBOARD_CACHE_TTL = 60 * 1000; // 60 detik
            // DASHBOARD LOAD GUARD
            window._dashboardLoaded = false;
            window._dashboardDirty = true; // 🔥 PENTING
            // CACHE TAGIHAN
            window._tagihanCache = null;
            window._tagihanCacheTime = 0;
            window._loadingTagihan = false;
            const TAGIHAN_CACHE_TTL = 60 * 1000; // 60 detik

            // ============================================
            // CACHE GLOBAL SYSTEM
            // ============================================
            const CACHE = {
                data: {},
                time: {},

                // Ambil data dari cache
                get(key, maxAge = 300000) { // maxAge default 5 menit
                    if (this.data[key] && this.time[key] > Date.now() - maxAge) {
                        console.log(`✅ CACHE HIT: ${key}`);
                        return this.data[key];
                    }
                    console.log(`❌ CACHE MISS: ${key}`);
                    return null;
                },

                // Simpan data ke cache
                set(key, data) {
                    this.data[key] = data;
                    this.time[key] = Date.now();
                    console.log(`💾 CACHE SET: ${key}`);
                },

                // Hapus cache tertentu
                remove(key) {
                    delete this.data[key];
                    delete this.time[key];
                    console.log(`🗑️ CACHE REMOVED: ${key}`);
                },

                // Hapus semua cache
                clear() {
                    this.data = {};
                    this.time = {};
                    console.log('🧹 ALL CACHE CLEARED');
                }
            };


// Event listener untuk logo dropzone (tambah di kode utama)
document.getElementById('logoDropzone').addEventListener('click', function(e) {
    e.stopPropagation();
    e.stopImmediatePropagation();
    document.getElementById('logoUpload').click();
}, true);


// DISABLE sementara — bikin klik di modal (logo preview) ikut nutup modal
// document.addEventListener('click', function(e) {
    // Jika ada modal terbuka DAN klik di area navbar (atas 80px atau bawah 80px)
//    const openModal = document.querySelector('.modal-overlay.show');
  //  if (openModal && (e.clientY < 80 || e.clientY > window.innerHeight - 80)) {
    //    openModal.classList.remove('show');
      //  openModal.classList.add('hidden');
        //document.body.style.overflow = 'auto';
       
   // }
//});

function logRead(action, count = 1) {
    // ⭐⭐ CEK JIKA FUNGSI SEDANG BERJALAN ⭐⭐
    const guardKey = `_loading${action.charAt(0).toUpperCase() + action.slice(1)}`;
    if (window[guardKey]) {
        console.log(`⏸️ ${action} sedang berjalan, skip counting`);
        return 0; // Tidak count jika sedang running
    }
    
    readsCounter[action] = (readsCounter[action] || 0) + count;
    readsCounter.total += count;
    
    console.log(`📊 READS [${action.toUpperCase()}]: +${count} (Total: ${readsCounter[action]})`);
    
    return readsCounter[action];
}



// ============================================
// FUNGSI LOAD DATA PERUSAHAAN SEBELUM UI
// ============================================
async function loadCompanyDataBeforeUI() {
    try {
        // 1. AMBIL COMPANY ID DARI USER
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        if (userDoc.exists) {
            const userData = userDoc.data();
            globalCompanyId = userData.company_id;
            
            // 2. AMBIL DATA PERUSAHAAN
            if (globalCompanyId) {
                const companyDoc = await db.collection('company_settings').doc(globalCompanyId).get();

                if (companyDoc.exists) {
                    const data = companyDoc.data();
                    
                    // 3. UPDATE NAVBAR LANGSUNG (SEBELUM UI RENDER)
                    const navbarBrand = document.querySelector('.navbar-brand');
                    if (navbarBrand && data.companyName) {
                        navbarBrand.innerHTML = '';
                        
                        if (data.companyLogo) {
                            const img = document.createElement('img');
                            img.src = data.companyLogo;
                            img.style.height = '40px';
                            img.style.objectFit = 'contain';
                            navbarBrand.appendChild(img);
                        } else {
                            const icon = document.createElement('i');
                            icon.className = 'fas fa-file-invoice-dollar';
                            navbarBrand.appendChild(icon);
                        }
                        
                        const nameSpan = document.createElement('span');
                        nameSpan.id = 'companyNameNav';
                        nameSpan.textContent = data.companyName;
                        nameSpan.style.marginLeft = '10px';
                        nameSpan.style.color = 'var(--primary)';
                        nameSpan.style.fontSize = '20px';
                        nameSpan.style.fontWeight = '700';
                        navbarBrand.appendChild(nameSpan);
                    }
                }
            }
        }
    } catch (error) {
        console.error("Error load company before UI:", error);
    }
}




// ============================================
// SISTEM KEAMANAN LOGIN
// ============================================
let loginAttempts = 0;
let lastFailedAttempt = 0;
const MAX_LOGIN_ATTEMPTS = 3;
const LOCKOUT_DURATION = 5 * 60 * 1000; // 5 menit dalam milidetik

// COPY INI, PASTE DI BAWAH VARIABLE globalCompanyId (sekitar line 96-100):
function getUserLogName() {
    return currentUser?.email || "Admin";
}

function checkLoginLockout() {
    const now = Date.now();
    const timeSinceLastFail = now - lastFailedAttempt;
    
    // Jika sudah melebihi batas percobaan dan masih dalam waktu lockout
    if (loginAttempts >= MAX_LOGIN_ATTEMPTS && timeSinceLastFail < LOCKOUT_DURATION) {
        const remainingMinutes = Math.ceil((LOCKOUT_DURATION - timeSinceLastFail) / 60000);
        return {
            locked: true,
            remainingMinutes: remainingMinutes
        };
    }
    
    // Reset counter jika sudah lewat waktu lockout
    if (timeSinceLastFail >= LOCKOUT_DURATION) {
        loginAttempts = 0;
        lastFailedAttempt = 0;
        localStorage.removeItem('loginAttempts');
        localStorage.removeItem('lastFailedAttempt');
    }
    
    return { locked: false };
}

function recordFailedLogin() {
    loginAttempts++;
    lastFailedAttempt = Date.now();
    
    // Simpan ke localStorage agar persist saat refresh
    localStorage.setItem('loginAttempts', loginAttempts.toString());
    localStorage.setItem('lastFailedAttempt', lastFailedAttempt.toString());
    
    console.log(`❌ Login gagal. Percobaan ke-${loginAttempts}/${MAX_LOGIN_ATTEMPTS}`);
    
    // Jika melebihi batas, lock
    if (loginAttempts >= MAX_LOGIN_ATTEMPTS) {
        console.log(`🔒 Akun terkunci selama ${LOCKOUT_DURATION/60000} menit`);
    }
}

function resetLoginAttempts() {
    loginAttempts = 0;
    lastFailedAttempt = 0;
    localStorage.removeItem('loginAttempts');
    localStorage.removeItem('lastFailedAttempt');
    console.log("✅ Reset login attempts");
}

// Load saved attempts saat halaman dimuat
document.addEventListener('DOMContentLoaded', function() {
    const savedAttempts = localStorage.getItem('loginAttempts');
    const savedLastFail = localStorage.getItem('lastFailedAttempt');
    
    if (savedAttempts) loginAttempts = parseInt(savedAttempts);
    if (savedLastFail) lastFailedAttempt = parseInt(savedLastFail);
    
    console.log(`📊 Login attempts loaded: ${loginAttempts}/${MAX_LOGIN_ATTEMPTS}`);
});
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function showLoading() {
            
        }
        
        function hideLoading() {
            
        }
        
        function showToast(type, title, message, duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-times-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.id = toastId;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="${icons[type]}"></i>
                </div>
                <div class="toast-body">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }
        
        
        
       function hideModal(modalId) {
    const modalEl = typeof modalId === 'string' 
        ? document.getElementById(modalId) 
        : modalId;
    
    if (!modalEl) {
        console.warn(`Modal ${modalId} tidak ditemukan`);
        return;
    }
    
    try {
        modalEl.classList.remove('show');
        modalEl.classList.add('hidden');
        document.body.style.overflow = 'auto';
        console.log(`Modal ${modalEl.id} ditutup`);
    } catch (error) {
        console.error("Error hideModal:", error);
    }
}


async function ensureCompanyId() {
    if (!currentUser || !currentUser.uid) {
        return null;
    }

    globalCompanyId = currentUser.uid;
    return globalCompanyId;



    try {
        console.log("🔍 Mengecek Company ID untuk user:", currentUser.email);

        // 3. Ambil data user dari collection 'users'
        const userDocRef = db.collection('users').doc(currentUser.uid);
        const userDoc = await userDocRef.get();

        if (userDoc.exists) {
            const userData = userDoc.data();
            globalCompanyId = userData.company_id || null;
            
            if (globalCompanyId) {
                console.log("✅ Company ID ditemukan:", globalCompanyId);
                return globalCompanyId;
            } else {
                console.warn("⚠️ Data user ada tapi company_id kosong. Membuat baru...");
            }
        }

        // 4. Jika belum ada company_id, Buat Baru
        const newCompanyId = `COMP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        await userDocRef.set({
            uid: currentUser.uid,
            email: currentUser.email,
            name: currentUser.displayName || currentUser.email.split('@')[0],
            company_id: newCompanyId,
            role: 'admin',
            created_at: new Date().toISOString()
        });

            await db.collection('company_settings').doc(newCompanyId).set({
            id: newCompanyId,
            admin_email: currentUser.email,
            created_at: new Date().toISOString()
        });

        globalCompanyId = newCompanyId;
        console.log("✅ Company ID baru dibuat:", globalCompanyId);
        
        return globalCompanyId;

    } catch (error) {
        console.error("❌ Error ensureCompanyId:", error);
        return null; // ⭐ PERBAIKAN: return null, bukan false
    }
}

const oldForm = document.getElementById('loginForm');
if (oldForm) {
    const newForm = oldForm.cloneNode(true);
    oldForm.parentNode.replaceChild(newForm, oldForm);
}

document.getElementById('loginForm').onsubmit = async function(e) {
    e.preventDefault();

    const email = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value.trim();

    // ===== DEMO ADMIN LOGIN =====
    if (email === "admin" && password === "admin123") {

        showToast('success', 'Login Demo Berhasil', '');

        // tampilkan dashboard
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("dashboardPage").style.display = "block";

        return; // PENTING: HENTIKAN di sini
    }

    // ===== FIREBASE LOGIN =====
    try {

        await firebase.auth().signInWithEmailAndPassword(email, password);

        showToast('success', 'Login berhasil', '');

    } catch (error) {

        showToast('error', 'Login gagal', 'Username / Password salah...');
        return;
    }
};


// ============================================
// HANDLE LOGIN SUCCESS (DIPANGGIL DARI onAuthStateChanged)
// ============================================
    async function handleLoginSuccess() {
        try {
            console.log("✅ handleLoginSuccess() called, user:", currentUser.email);

            globalCompanyId = null;

            
            // 2. SET COMPANY ID = UID
            const companyId = currentUser.uid;
            globalCompanyId = companyId;

            // 🔥 TAMBAHKAN 3 BARIS INI DI SINI
            localStorage.removeItem(`companyProfile_${globalCompanyId}`);
            window._pelangganCache = null;
            window._dashboardCache = null;


    // ⭐⭐ AUTO-LOAD/BUAT DATA PERUSAHAAN UNTUK SEMUA USER ⭐⭐
    try {
        if (globalCompanyId) {
            const companyDoc = await db.collection('company_settings').doc(globalCompanyId).get();

            
            if (companyDoc.exists) {
                // 1. Data sudah ada -> simpan ke localStorage
                const companyData = companyDoc.data();
                localStorage.setItem(`companyProfile_${globalCompanyId}`, JSON.stringify(companyData));
                console.log("💾 Company data saved to localStorage");
            } else {
                // 2. Data belum ada -> BUAT DEFAULT untuk perusahaan baru
                const defaultCompanyData = {
                    companyName: "X-BILL",
                    companyAddress: "Jl. Internet Cepat No. 1",
                    companyPhone: "-",
                    companyTagline: "Billing Management System",
                    company_id: globalCompanyId,
                    admin_email: currentUser.email,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                // Simpan ke database
                await db.collection('company_settings').doc(globalCompanyId).set(defaultCompanyData); // ⬅️ HAPUS/COMMENT
                console.log("🏢 Default company data created");
                
                // Simpan ke localStorage
                localStorage.setItem(`companyProfile_${globalCompanyId}`, JSON.stringify(defaultCompanyData));
            }
        }
    } catch (error) {
        console.error("Error handling company data:", error);
    }

            // ⭐⭐ 3. GET COMPANY DATA FROM DATABASE ⭐⭐
            let companyName = 'X-BILL';
            let companyLogo = '';
            let companyTagline = 'Billing Management System';
            
            if (companyId) {
                try {
                    const companyDoc = await db.collection('company_settings').doc(companyId).get();
                    if (companyDoc.exists) {
                        const data = companyDoc.data();
                        console.log("🏢 Company data from DB:", data);
                        
                        if (data.companyName) companyName = data.companyName;
                        if (data.companyLogo) companyLogo = data.companyLogo;
                        if (data.companyTagline) companyTagline = data.companyTagline;
                    }
                } catch (dbError) {
                    console.error("Database error:", dbError);
                }
            }
            
            // ⭐⭐ 4. UPDATE NAVBAR FIRST ⭐⭐
            const navbarBrand = document.querySelector('.navbar-brand');
            if (navbarBrand) {
                navbarBrand.innerHTML = '';
                
                if (companyLogo && companyLogo.startsWith('data:image')) {
                    const img = document.createElement('img');
                    img.src = companyLogo;
                    img.style.height = '40px';
                    img.style.maxHeight = '40px';
                    img.style.objectFit = 'contain';
                    navbarBrand.appendChild(img);
                    console.log("✅ Company logo added");
                } else {
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-file-invoice-dollar';
                    navbarBrand.appendChild(icon);
                    console.log("✅ Default icon added");
                }
                
                const nameSpan = document.createElement('span');
                nameSpan.id = 'companyNameNav';
                nameSpan.textContent = companyName;
                nameSpan.style.marginLeft = navbarBrand.children.length > 0 ? '10px' : '0';
                nameSpan.style.color = 'var(--primary)';
                nameSpan.style.fontSize = '20px';
                nameSpan.style.fontWeight = '700';
                navbarBrand.appendChild(nameSpan);
                console.log("✅ Company name:", companyName);
            }
            
            // ⭐⭐ 5. NOW SHOW UI ⭐⭐
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            
            // 6. UPDATE USER INFO
            let displayName = currentUser.displayName || currentUser.email || 'Administrator';
            const userNameEl = document.getElementById('userName');
            const userAvatarEl = document.getElementById('userAvatar');
            
            if (userNameEl) userNameEl.innerText = displayName;
            if (userAvatarEl) userAvatarEl.textContent = displayName.charAt(0).toUpperCase();
            
            // 7. UPDATE DROPDOWN
            const dropdownCompanyName = document.getElementById('dropdownCompanyName');
            if (dropdownCompanyName) dropdownCompanyName.textContent = companyName;
            
            const dropdownCompanyTagline = document.getElementById('dropdownCompanyTagline');
            if (dropdownCompanyTagline) dropdownCompanyTagline.textContent = companyTagline;
            
            // 8. LOAD OTHER DATA
            // await loadAllDataOnce();
            await loadPage('dashboard');
            
            // 9. TOAST
            
        } catch (error) {
            console.error("❌ Error handleLoginSuccess:", error);
            showToast('error', 'Error', 'Gagal memuat aplikasi');
        }
    }

// Fungsi pagination umum (tambah setelah fungsi utility)
function renderPagination(totalItems, currentPage, pageType, containerId) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    if (totalPages <= 1) return '';
    
    let html = '<div class="pagination">';
    
    // 1. TOMBOL KIRI (<)
    if (currentPage > 1) {
        html += `<a class="page-link" onclick="changePage('${pageType}', ${currentPage - 1})">&lt;</a>`;
    }
    
    // 2. TOMBOL RENTANG HALAMAN 1-10
    // Hitung blok (1-10, 11-20, dst)
    const startBlock = Math.floor((currentPage - 1) / 10) * 10 + 1;
    const endBlock = Math.min(startBlock + 9, totalPages);
    
    // Spasi agar tidak berdempetan
    if (startBlock > 1) html += ` `;
    html += `<a class="page-link" onclick="changePage('${pageType}', ${startBlock})">${startBlock}-${endBlock}</a>`;
    if (endBlock < totalPages) html += ` `;
    
    // 3. TOMBOL KANAN (>)
    if (currentPage < totalPages) {
        html += `<a class="page-link" onclick="changePage('${pageType}', ${currentPage + 1})">&gt;</a>`;
    }
    
    html += '</div>';
    
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = html;
    }
}

async function autoGenerateTagihanArrears() {
    console.log("🤖 Cek auto-generate tagihan...");
    
    // Cek jika tanggal 1-3 di awal bulan
    const today = moment();
    if (today.date() > 3) {
        console.log("⚠️ Bukan awal bulan (tanggal 1-3), skip auto-generate");
        return;
    }
    
    try {
        // Tentukan bulan tagihan (bulan sebelumnya)
        const bulanKemarin = today.subtract(1, 'month').format('MM-YYYY');
        const bulanSekarang = today.format('MM-YYYY');
        
        console.log(`📅 Auto-generate untuk pemakaian: ${bulanKemarin}`);
        
        // Cek apakah sudah digenerate bulan ini
        const checkSnapshot = await db.collection('tagihan')
            .where('bulan', '==', bulanKemarin)
            .limit(1)
            .get();
        
        if (!checkSnapshot.empty) {
            console.log(`✅ Tagihan ${bulanKemarin} sudah digenerate, skip`);
            return;
        }
        
        // Generate otomatis
        console.log(`🚀 Mulai auto-generate tagihan untuk ${bulanKemarin}`);
        
        // Panggil fungsi generate dengan parameter bulan sekarang
        // (karena generate di bulan sekarang untuk pemakaian bulan sebelumnya)
        const event = { preventDefault: () => {} };
        await generateTagihanBulk();
        
        // Log aktivitas auto-generate
        await db.collection('aktivitas').add({
            aktiviuser: getUserLogName(),
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        console.error("❌ Error auto-generate:", error);
    }
}

// Panggil saat app load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        autoGenerateTagihanArrears();
    }, 5000); // Delay 5 detik setelah app load
});

function changePage(pageType, pageNumber) {
    switch(pageType) {
        case 'pelanggan':
    currentPagePelanggan = pageNumber;
    window.lastServerFilter = document.getElementById('filterServer')?.value || '';
    loadPelangganData(window.lastServerFilter);
    break;


        case 'tagihan':
            currentPageTagihan = pageNumber;
            loadTagihanData();
            break;
        case 'tunggakan':
            currentPageTunggakan = pageNumber;
            loadTunggakanData();
            break;
        case 'paket':
            currentPagePaket = pageNumber;
            loadPaketData();
            break;
    }
}

function getPaginatedData(data, currentPage) {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    return data.slice(startIndex, endIndex);
}
        
        // ============================================
// FUNGSI CONFIRM DIALOG (VERSI POP UP KUSTOM)
// ============================================
function confirmDialog(message, callback) {
    // Buat elemen HTML Overlay Gelap
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.6)';
    overlay.style.zIndex = '999999';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';

    // Buat Kotak Pop-up
    const popup = document.createElement('div');
    popup.style.backgroundColor = 'white';
    popup.style.padding = '30px';
    popup.style.borderRadius = '16px';
    popup.style.textAlign = 'center';
    popup.style.boxShadow = '0 15px 50px rgba(0,0,0,0.3)';
    popup.style.maxWidth = '400px';
    popup.style.width = '90%';
    popup.style.transform = 'scale(0.8)';
    popup.style.opacity = '0';
    popup.style.transition = 'all 0.3s ease';

    // Isi Konten
    popup.innerHTML = `
        <div style="font-size: 40px; color: #6c5ce7; margin-bottom: 20px;">
            <i class="fas fa-question-circle"></i>
        </div>
        <h3 style="margin: 0 0 10px 0; color: #2d3436;">Konfirmasi</h3>
        <p style="color: #636e72; margin-bottom: 25px;">${message}</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="btnCancel" style="padding: 10px 20px; border: none; background: #dfe6e9; color: #2d3436; border-radius: 8px; cursor: pointer; font-weight: 600;">Batal</button>
            <button id="btnOk" style="padding: 10px 20px; border: none; background: #4361ee; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Oke</button>
        </div>
    `;

    overlay.appendChild(popup);
    document.body.appendChild(overlay);

    // Animasi Muncul
    setTimeout(() => {
        popup.style.transform = 'scale(1)';
        popup.style.opacity = '1';
    }, 10);

    // Logika Tombol
    document.getElementById('btnCancel').onclick = function() {
        document.body.removeChild(overlay);
    };

    document.getElementById('btnOk').onclick = function() {
        document.body.removeChild(overlay);
        if (typeof callback === 'function') {
            callback();
        }
    };
}
        
        // Generate unique ID
        function generateId(prefix = '') {
            return prefix + Date.now() + Math.random().toString(36).substr(2, 9);
        }
        
        
        
        // ============================================
        // PAGE TEMPLATES
        // ============================================
        
       async function getDashboardHTML() {
    return `
        <div class="page dashboard-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-home"></i> Dashboard</h2>
                <button class="btn btn-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            
            <div class="stats-grid">
                <!-- CARD 1: TOTAL PELANGGAN -->
                <div class="stat-card" id="cardTotalPelanggan" onclick="navigateToPelanggan()" style="cursor: pointer;">
                    <div class="stat-icon primary">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="statPelanggan">0</div>
                        <div class="stat-label">Total Pelanggan</div>
                        <div class="stat-action" style="margin-top: 8px; font-size: 12px; color: #4361ee;">
                            <i class="fas fa-external-link-alt"></i> Klik untuk lihat detail
                        </div>
                    </div>
                </div>
                
                <!-- CARD 2: TAGIHAN BULAN INI -->
                <div class="stat-card" onclick="navigateToTagihan()" style="cursor: pointer;">
                    <div class="stat-icon success">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="statTagihanBulanan">Rp 0</div>
                        <div class="stat-label">Tagihan Bulan Ini</div>
                        <div class="stat-action" style="margin-top: 8px; font-size: 12px; color: #00b894;">
                            <i class="fas fa-external-link-alt"></i> Klik untuk lihat tagihan
                        </div>
                    </div>
                </div>
                
                <!-- CARD 3: LUNAS -->
                <div class="stat-card" onclick="showLunasBulanIni()" style="cursor: pointer;">
    <div class="stat-icon success">
        <i class="fas fa-check-circle"></i>
    </div>
    <div class="stat-content">
        <!-- Angka Persentase -->
        <div class="stat-value" id="statLunasPersen">0%</div>
        
        <!-- Label & Detail Jumlah -->
        <div class="stat-label">Pelunasan Bulan Ini</div>
        <div class="stat-detail" style="font-size: 12px; color: #666; margin-top: 4px;">
            <span id="statLunasCount">0</span> Pelanggan
        </div>
        
        <div class="stat-action" style="margin-top: 8px; font-size: 12px; color: #00b894;">
            <i class="fas fa-list-ul"></i> Klik untuk lihat detail
        </div>
    </div>
</div>
                
                <!-- CARD 4: TUNGGAKAN -->
<div class="stat-card" onclick="showDetailTunggakan()" style="cursor: pointer;">
    <div class="stat-icon danger">
        <i class="fas fa-clock"></i>
    </div>
    <div class="stat-content">
    <!-- Nilai Nominal (Rupiah) -->
    <div class="stat-value" id="statTunggakan">Rp 0</div>
    
    <!-- Label -->
    <div class="stat-label">Tunggakan Bulan Ini</div>
    
    <!-- Aksi -->
    <div class="stat-action" style="margin-top: 8px; font-size: 12px; color: #ff6b6b;">
        <i class="fas fa-external-link-alt"></i> Klik untuk lihat detail
    </div>
</div>
</div>
            </div>
            
            <div class="charts-container">
                <div class="chart-card">
                    <h3>Tagihan 6 Bulan Terakhir</h3>
                    <canvas id="chartTagihan" height="150"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Status Pelanggan</h3>
                    <canvas id="chartStatus" height="150"></canvas>
                </div>
            </div>
            
            <!-- GANTI SECTION AKTIVITAS TERBARU DENGAN PETA -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-map-marked-alt"></i> Peta Lokasi Pelanggan</h3>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" onclick="refreshPelangganMap()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="focusOnAllMarkers()">
                            <i class="fas fa-search"></i> Zoom All
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="mapContainer" style="height: 400px; border-radius: 8px; overflow: hidden; background: #f8f9fa;margin-top: 80px;">
                        <!-- JIKA MAP SUDAH ADA, PAKAI YANG SUDAH -->
                        <div id="pelangganMap" style="height: 100%; width: 100%;"></div>
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                Total titik: <span id="mapMarkerCount">0</span> pelanggan
                            </small>
                        </div>
                        <div>
                            <small class="text-muted">
                                <i class="fas fa-map-pin" style="color: #4361ee;"></i> Aktif
                                <i class="fas fa-map-pin" style="color: #ff6b6b; margin-left: 10px;"></i> Tunggak
                                <i class="fas fa-map-pin" style="color: #6c757d; margin-left: 10px;"></i> Nonaktif
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}


// ⭐⭐ FUNGSI BARU: Render map section terpisah ⭐⭐
async function renderMapSection() {
    const mapSection = document.getElementById('mapSection');
    if (!mapSection) return;
    
    // Render HTML map (hanya sekali)
    if (!mapSection.hasAttribute('data-rendered')) {
        mapSection.innerHTML = `
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-map-marked-alt"></i> Peta Lokasi Pelanggan</h3>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" onclick="refreshPelangganMap()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="focusOnAllMarkers()">
                            <i class="fas fa-search"></i> Zoom All
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="mapContainer" style="height: 400px; border-radius: 8px; overflow: hidden; background: #f8f9fa;margin-top: 80px;">
                        <div id="pelangganMap" style="height: 100%; width: 100%;"></div>
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                Total titik: <span id="mapMarkerCount">0</span> pelanggan
                            </small>
                        </div>
                        <div>
                            <small class="text-muted">
                                <i class="fas fa-map-pin" style="color: #4361ee;"></i> Aktif
                                <i class="fas fa-map-pin" style="color: #ff6b6b; margin-left: 10px;"></i> Tunggak
                                <i class="fas fa-map-pin" style="color: #6c757d; margin-left: 10px;"></i> Nonaktif
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        mapSection.setAttribute('data-rendered', 'true');
    }
    
    // Init map
    setTimeout(() => {
        initPelangganMap();
        setTimeout(() => loadPelangganMap(), 500);
    }, 300);
}



// TAMBAHKAN FUNGSI-FUNGSI UNTUK HANDLE KLIK CARD:

// Fungsi untuk navigasi ke halaman Pelanggan
function navigateToPelanggan() {
    console.log("Navigasi ke halaman Pelanggan");
    loadPage('pelanggan');
}

function navigateToTagihan() {
    // Set session storage untuk filter bulan ini
    sessionStorage.setItem('filterTagihan', 'bulanIni');
    loadPage('tagihan');
}

// Fungsi untuk filter tagihan lunas
function filterTagihanLunas() {
    console.log("Filter tagihan lunas");
    loadPage('tagihan');
    
    // Tunggu sedikit untuk memastikan halaman sudah load
    setTimeout(() => {
        const filterStatus = document.getElementById('filterStatusTagihan');
        if (filterStatus) {
            filterStatus.value = 'lunas';
            loadTagihanData();
            showToast('success', 'Filter', 'Menampilkan tagihan yang sudah lunas');
        }
    }, 500);
}

// Fungsi untuk filter tagihan tunggakan
function filterTagihanTunggakan() {
    console.log("Filter tagihan tunggakan");
    loadPage('tunggakan');
}

// FUNGSI INITIALIZE QUICK ACTIONS (Pastikan ada di file):
function initializeQuickActions() {
    console.log("⚡ Initializing quick actions dengan...");
    
    // Generate Tagihan ARREARS
    document.getElementById('btnGenerateTagihan')?.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log("🔘 Quick Action: Generate Tagihan");
        
        const modal = document.getElementById('modalGenerateTagihan');
        if (modal) {
            // Reset dan setup modal arrears
            modal.classList.remove('hidden');
            modal.classList.add('show');
            modal.style.display = 'flex';
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            modal.style.zIndex = '9999';
            
            // Hapus scroll body
            document.body.style.overflow = 'hidden';
            
            // Set default values untuk arrears
            const bulanIni = moment().format('MM-YYYY');
            document.getElementById('generateBulan').value = bulanIni;
            document.getElementById('generateJatuhTempo').value = 10;
            
            // Reset checkbox
            document.getElementById('generateProrata').checked = true;
            document.getElementById('generateEmail').checked = false;
            document.getElementById('generateWhatsapp').checked = false;
            
            // Load data dan update timeline
            setTimeout(() => {
                loadTunggakanDataForModal();
            }, 300);
            
        }
    });
    
    
    // Kirim Reminder
    const btnReminder = document.getElementById('btnKirimReminder');
    if (btnReminder) {
        btnReminder.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Tombol Kirim Reminder diklik");
            
            const modal = document.getElementById('modalReminder');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('show');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                showToast('info', 'Kirim Reminder', 'Membuka form kirim reminder');
            }
        });
    }
    
    // Export Laporan
    const btnExport = document.getElementById('btnExportLaporan');
    if (btnExport) {
        btnExport.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Tombol Export Laporan diklik");
            
            const modal = document.getElementById('modalExportLaporan');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('show');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                showToast('info', 'Export Laporan', 'Membuka form export laporan');
            }
        });
    }
    
    // Backup Data
    const btnBackup = document.getElementById('btnBackupData');
    if (btnBackup) {
        btnBackup.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log("Tombol Backup Data diklik");
            
            const modal = document.getElementById('modalBackup');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('show');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                showToast('info', 'Backup Data', 'Membuka form backup data');
            }
        });
    }
    
    console.log("✅ Quick Actions berhasil diinisialisasi");
}

// FUNGSI UNTUK LOAD DAN TAMPILKAN DATA TUNGGAKAN DI MODAL
async function loadTunggakanDataForModal() {
    console.log("📊 Loading data untuk modal generate...");
    
    try {
        const pelangganSnapshot = await db.collection('pelanggan')
            .where('status', '==', 'aktif')
            .get();
        
        const totalAktif = pelangganSnapshot.size;
        
        document.getElementById('summaryTotalAktif').textContent = totalAktif;
        
        updateArrearsTimeline();
        
        showToast('success', 'Data Dimuat', `${totalAktif} pelanggan aktif siap digenerate`);
        
    } catch (error) {
        console.error("❌ Error load data untuk modal:", error);
        showToast('error', 'Error', 'Gagal memuat data');
    }
}

// FUNGSI UNTUK UPDATE ESTIMASI GENERATE
function updateGenerateEstimation(totalAktif, totalTunggak, totalTunggakan) {
    try {
        const filter = document.getElementById('filterTunggakan').value;
        const bulanGenerateInput = document.getElementById('generateBulan').value;
        
        if (!bulanGenerateInput) return;
        
        const bulanGenerate = moment(bulanGenerateInput, 'YYYY-MM');
        const bulanPemakaian = bulanGenerate.clone().subtract(1, 'month');
        
        // Hitung berdasarkan filter
        let estimasiJumlah = totalAktif;
        
        switch(filter) {
            case 'exclude_tunggakan':
                estimasiJumlah = totalAktif - totalTunggak;
                break;
            case 'only_tunggakan':
                estimasiJumlah = totalTunggak;
                break;
            case 'exclude_berat':
                estimasiJumlah = Math.round(totalAktif * 0.8); // Asumsi 20% berat
                break;
        }
        
        // Asumsi rata-rata harga 150rb
        const rataHarga = 150000;
        const estimasiTotal = estimasiJumlah * rataHarga;
        
        // Update UI
        document.getElementById('summaryJumlahTagihan').textContent = estimasiJumlah;
        document.getElementById('summaryEstimasiTotal').textContent = formatRupiah(estimasiTotal);
        document.getElementById('summaryWaktu').textContent = `~${Math.ceil(estimasiJumlah / 10)} detik`;
        document.getElementById('summaryBulanPemakaian').textContent = bulanPemakaian.format('MMMM YYYY');
        
    } catch (error) {
        console.error("Error update estimation:", error);
    }
}

// FUNGSI TOGGLE FILTER
function toggleTunggakanFilter() {
    const filter = document.getElementById('filterTunggakan').value;
    const kategoriSelect = document.getElementById('kategoriTunggakan');
    
    // Enable kategori hanya jika filter khusus tunggakan
    if (filter === 'only_tunggakan') {
        kategoriSelect.disabled = false;
    } else {
        kategoriSelect.disabled = true;
        kategoriSelect.value = 'all';
    }
    
    // Refresh estimasi jika ada data
    const totalAktif = parseInt(document.getElementById('summaryTotalAktif').textContent) || 0;
    const totalTunggak = parseInt(document.getElementById('summaryTunggakan').textContent) || 0;
    const totalTunggakanText = document.getElementById('summaryTotalTunggakan').textContent;
    const totalTunggakan = parseFloat(totalTunggakanText.replace(/[^0-9]/g, '')) || 0;
    
    updateGenerateEstimation(totalAktif, totalTunggak, totalTunggakan);
}
        

      async function getPelangganHTML() {
    return `
        <div class="page pelanggan-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-users"></i> Data Pelanggan</h2>
                <div class="action-buttons">
                    <!-- TOMBOL IMPORT/EXPORT -->
                    <button class="btn btn-outline" onclick="showImportExportPanel()">
                        <i class="fas fa-file-import"></i> Import/Export
                    </button>
                    <button class="btn btn-primary" onclick="showAddPelangganModal()">
                        <i class="fas fa-plus"></i> Tambah Pelanggan
                    </button>
                </div>
            </div>
            
            <!-- PANEL IMPORT/EXPORT (AWALNYA DISEMBUNYIKAN) -->
            <div id="importExportPanel" class="card hidden" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h3><i class="fas fa-file-import"></i> Import & Export Data Pelanggan</h3>
                    <button class="btn btn-sm btn-outline" onclick="hideImportExportPanel()">
                        <i class="fas fa-times"></i> Tutup
                    </button>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- IMPORT SECTION -->
                        <div>
                            <h4><i class="fas fa-upload"></i> Import Data</h4>
                            <div class="form-group">
                                <label>Pilih File Excel/CSV</label>
                                <input type="file" class="form-control" id="fileImportPelanggan" 
                                       accept=".xlsx,.xls,.csv">
                                <small class="text-muted">Format: Excel (.xlsx, .xls) atau CSV</small>
                            </div>
                            <button class="btn btn-success" onclick="importDataPelanggan()">
                                <i class="fas fa-upload"></i> Import Data
                            </button>
                        </div>
                        
                        <!-- EXPORT SECTION -->
                        <div>
                            <h4><i class="fas fa-download"></i> Export Data</h4>
                             <button class="btn btn-primary" onclick="exportDataPelanggan()">
                                <i class="fas fa-download"></i> Export Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- FILTERS (SUDAH DITAMBAHKAN DISINI) -->
            <div class="filters-card">
                <div class="filter-row">
                    <div class="form-group">
    <label>Server</label>
    <div style="display: flex; gap: 5px; align-items: center;">
        <select class="form-control" id="filterServer" 
                 onchange="handleServerChange(this.value)" 
        style="flex: 1;">
    <option value="">Semua Server</option>
    
    <option value="+tambah" style="color: #4361ee; font-weight: bold; background: #f0f9ff;">
        + Tambah Server Baru
    </option>
</select>
    </div>
</div>
                    
                    <div class="form-group">
                        <label>Cari</label>
                        <input type="text" class="form-control" id="searchPelanggan" 
                               placeholder="Nama, alamat, atau telepon..." oninput="loadPelangganData()">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-outline" onclick="loadPelangganData()" style="margin-top: 25px;">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- CARD TABEL PELANGGAN -->
            <div class="card">
                <div class="card-header">
                    <h3>Daftar Pelanggan</h3>
                    <div class="btn-group">
                        
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Server</th>
                                    <th>Nama</th>
                                    <th>Telepon</th>
                                    <th>Alamat</th>
                                    <th>Lokasi</th>
                                    <th>Paket</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="pelangganTable">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto;"></div>
                                        Memuat data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- PAGINATION -->
                    <div id="pelangganPagination" class="mt-3"></div>
                </div>
            </div>
        </div>
    `;
}
        
        async function getPaketHTML() {
    return `
        <div class="page paket-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-wifi"></i> Data Paket Internet</h2>
                <div class="action-buttons">
                    <button class="btn btn-outline" onclick="showImportPaketModal()">
                        <i class="fas fa-file-import"></i> Import
                    </button>
                    <button class="btn btn-outline" onclick="exportPaket()">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3>Detail Paket</h3>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="showAddPaketModal()">
                            <i class="fas fa-plus"></i> Tambah Paket
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nama Paket</th>
                                    <th>Kecepatan</th>
                                    <th>Harga</th>
                                    <th>Kuota</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="paketTable">
                                <!-- Data akan diisi -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- PAGINATION CONTAINER -->
                    <div id="paketPagination"></div>
                    
                    <div style="margin-top: 10px; color: var(--gray); font-size: 14px;">
                        Menampilkan <span id="paketStart">0</span>-<span id="paketEnd">0</span> dari 
                        <span id="paketTotal">0</span> paket
                    </div>
                </div>
            </div>
        </div>
    `;
}
        
       async function getTagihanHTML() {
    return `
        <div class="page tagihan-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-receipt"></i> Tagihan </h2>
                <div class="action-buttons">
                    
                    <button class="btn btn-warning" onclick="resetGenerate()">
                        <i class="fas fa-trash-restore"></i> Reset Generate
                    </button>
                    
                    <button class="btn btn-primary" onclick="openGenerateModal()">
                        <i class="fas fa-bolt"></i> Generate Tagihan 
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
    <h3>Daftar Tagihan </h3>
    <div class="btn-group">
        <!-- FILTER SERVER (BARU) -->
        <select id="filterServerTagihan" class="form-control" 
                style="width: 150px; display: inline-block; height: 38px; padding: 5px 10px; margin-right: 10px;"
                onchange="filterByServerTagihan(this.value)">
            <option value="">Semua Server</option>
            <!-- OPSI SERVER AKAN DIISI OLEH JS -->
        </select>
        
        <!-- INPUT PENCARIAN -->
        <input type="text" id="searchTagihan" 
               class="form-control" 
               placeholder="Cari nama,alamat,dll..." 
               style="width: 200px; display: inline-block; height: 38px; padding: 5px 10px; margin-right: 10px;" 
               autocomplete="off" 
               oninput="filterTagihanSearch(this.value)">
               
        
    </div>
</div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
    <tr>
        <th style="width: 15%;">Server</th>
        <th style="width: 20%;">Pelanggan</th>
        <th style="width: 10%;">Lokasi</th>
        <th style="width: 15%;">Alamat</th>
        <th style="width: 8%;">Bulan</th>
        <th style="width: 12%;">Total Tagihan</th>
        <th style="width: 8%;">Status</th>
        <th style="width: 12%;">Aksi</th>
    </tr>
</thead>
                            <tbody id="tagihanTable">
                                <tr>
                                    <td colspan="8" class="text-center">Memuat data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="tagihanPagination" class="mt-3"></div>
                </div>
            </div>
        </div>
    `;
}

async function resetGenerate() {
    // GANTI confirm() bawaan browser dengan POPUP KUSTOM
    const modalId = 'modalResetConfirm';
    
    // Hapus modal lama jika ada
    const oldModal = document.getElementById(modalId);
    if (oldModal) oldModal.remove();
    
    // Buat modal kustom
    const modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'modal-overlay show';
    modal.style.zIndex = '999999';
    modal.innerHTML = `
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color: #e74c3c;">
                    <i class="fas fa-exclamation-triangle"></i> PERINGATAN!
                </h3>
                <button class="modal-close" onclick="document.getElementById('${modalId}').remove()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 15px 0;">
                    <div style="font-size: 48px; color: #e74c3c; margin-bottom: 15px;">
                        <i class="fas fa-trash-restore"></i>
                    </div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">Reset Generate Tagihan</h4>
                    <p style="color: #7f8c8d; line-height: 1.5;">
                        Ini akan <strong style="color: #e74c3c;">MENGHAPUS SEMUA</strong> data tagihan yang <strong>BELUM LUNAS</strong>.<br>
                        Data pelanggan tetap aman dan tidak terpengaruh.
                    </p>
                    <div style="background: #fff8e1; border-left: 4px solid #ffc107; padding: 10px; margin: 15px 0; text-align: left;">
                        <i class="fas fa-info-circle" style="color: #ff9800;"></i>
                        <small>Hanya tagihan dengan status "belum" yang akan dihapus.</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 10px;">
                <button class="btn btn-outline" onclick="document.getElementById('${modalId}').remove()" style="padding: 10px 20px;">
                    <i class="fas fa-times"></i> BATAL
                </button>
                <button id="btnConfirmReset" class="btn btn-danger" style="padding: 10px 20px;">
                    <i class="fas fa-check"></i> YA, RESET SEKARANG
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
    
    // Event listener untuk tombol konfirmasi
    document.getElementById('btnConfirmReset').onclick = async function() {
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> MEMPROSES...';
        btn.disabled = true;
        
        try {
            showLoading();
            
            // Hapus hanya status 'belum'
            const snapshot = await db.collection('tagihan')
                .where('status', '==', 'belum')
                .where('company_id', '==', globalCompanyId) // ⭐ Tambah filter company
                .get();
            
            const batch = db.batch();
            const deletedCount = snapshot.size;

            snapshot.forEach(doc => {
                batch.delete(doc.ref);
            });

            await batch.commit();
            
            // Tutup modal
            document.getElementById(modalId).remove();
            document.body.style.overflow = 'auto';
            
            hideLoading();
            
            // Tampilkan notifikasi sukses
            if (deletedCount > 0) {
                showToast('success', 'Reset Berhasil', 
                    `${deletedCount} tagihan belum lunas berhasil dihapus.`);
            } else {
                showToast('info', 'Tidak Ada Data', 
                    'Tidak ada tagihan belum lunas untuk direset.');
            }
            
            // Refresh data tagihan
            await loadTagihanData();
            
            // Log aktivitas
            await db.collection('aktivitas').add({
                aktivitas: `Reset generate tagihan: ${deletedCount} data dihapus`,
                user: getUserLogName(),
                timestamp: new Date().toISOString(),
                company_id: globalCompanyId
            });
            
        } catch (error) {
            hideLoading();
            btn.innerHTML = originalText;
            btn.disabled = false;
            console.error("Error reset:", error);
            showToast('error', 'Gagal', 'Gagal mereset tagihan: ' + error.message);
        }
    };
}

// Fungsi Khusus untuk Buka Modal Generate Tagihan (Fix Tidak Bisa Muncul)
function openGenerateModal() {
    console.log("🔘 Membuka Modal Generate Tagihan...");
    
    const modal = document.getElementById('modalGenerateTagihan');
    if (!modal) {
        showToast('error', 'Error', 'Modal tidak ditemukan di DOM');
        return;
    }

    // Set nilai default
    const bulanInput = document.getElementById('generateBulan');
    if (bulanInput) bulanInput.value = moment().format('YYYY-MM'); // Sesuaikan format input type="month"

    // Tampilkan modal
    modal.classList.remove('hidden');
    modal.classList.add('show');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Kunci scroll body

    // Refresh data
    setTimeout(() => {
        loadTunggakanDataForModal();
    }, 300);
}
        
        // ============================================
// HALAMAN HTML: MENU TUNGGAKAN
// ============================================

async function getTunggakanHTML() {
    return `
        <div class="page tunggakan-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-clock"></i> Tunggakan</h2>
                <div id="reminderContainer" style="display: none;">
    <button class="btn btn-success" onclick="showModal('modalReminder')">Kirim Reminder</button>
</div>
            </div>
            
            <!-- KARTU STATISTIK (TETAP ADA) -->
            <div class="stats-grid">
                <div class="stat-card" onclick="filterTunggakanTable('ringan')" style="cursor: pointer;">
                    <div class="stat-icon warning">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="tunggakanRingan">0</div>
                        <div class="stat-label">Ringan (1-30 Hari)</div>
                    </div>
                </div>
                
                <div class="stat-card" onclick="filterTunggakanTable('sedang')" style="cursor: pointer;">
                    <div class="stat-icon danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="tunggakanSedang">0</div>
                        <div class="stat-label">Sedang (31-60 Hari)</div>
                    </div>
                </div>
                
                <div class="stat-card" onclick="filterTunggakanTable('berat')" style="cursor: pointer;">
                    <div class="stat-icon primary">
                        <i class="fas fa-ban"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="tunggakanBerat">0</div>
                        <div class="stat-label">Berat (>60 Hari)</div>
                    </div>
                </div>
                
                <div class="stat-card" onclick="filterTunggakanTable('semua')" style="cursor: pointer;">
                    <div class="stat-icon info">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalTunggakanUang">Rp 0</div>
                        <div class="stat-label">Total Nominal</div>
                    </div>
                </div>
            </div>

            <!-- TABEL DATA TUNGGAKAN (DENGAN INPUT CARI) -->
            <div class="card">
                <div class="card-header">
                    <h3>Daftar Pelanggan Menunggak</h3>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <!-- INPUT PENCARIAN -->
                        <input type="text" id="searchTunggakan" 
                               class="form-control" 
                               placeholder="Cari nama/telepon..." 
                               style="width: 250px; display: inline-block;" 
                               autocomplete="off" 
                               oninput="filterTunggakanSearch(this.value)">
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Pelanggan</th>
                                    <th>Bulan Tagihan</th>
                                    <th>Nominal</th>
                                    <th>Jatuh Tempo</th>
                                    <th>Lama Telat</th>
                                    <th>Status</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tunggakanTable">
                                <tr>
                                    <td colspan="7" class="text-center">Memuat data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- PAGINATION CONTAINER -->
                    <div id="tunggakanPagination"></div>
                </div>
            </div>
        </div>
    `;
}


// ============================================
// FUNGSI PENCARIAN TUNGGAKAN (SEARCH)
// ============================================

function filterTunggakanSearch(keyword) {
    console.log("🔍 Mencari:", keyword);
    
    const table = document.getElementById('tunggakanTable');
    if (!table) {
        console.warn("⚠️ Tabel #tunggakanTable tidak ditemukan!");
        return;
    }
    
    const rows = table.getElementsByTagName('tr');
    const filterLower = keyword.toLowerCase();
    
    // Loop mulai dari 1 (skip header)
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        
        // Pastikan ada sel sebelum diambil textContent
        if (cells.length > 0) {
            // Cari di Kolom Nama (td 0) atau Telepon (td 0 small)
            // Ambil textContent dari cell pertama (Nama Pelanggan)
            const textData = cells[0].textContent || "";
            
            // Cek apakah keyword ada di text
            if (textData.toLowerCase().indexOf(filterLower) > -1) {
                row.style.display = ""; 
            } else {
                row.style.display = "none"; 
            }
        }
    }
}


// ============================================
// FUNGSI PENDUKUNG (WAJIB ADA)
// ============================================

function gantiHalamanTunggakan(pageNum, kategori = 'semua') {
    halamanTunggakanSaatIni = pageNum;
    loadTunggakanData(kategori);
}

function filterTunggakanTable(kategori) {
    console.log(`🔍 Filter kartu: ${kategori}`);
    
    // Reset input pencarian menjadi kosong
    const searchInput = document.getElementById('searchTunggakan');
    if (searchInput) searchInput.value = '';
    
    // Panggil load data
    loadTunggakanData(kategori);
    
   
}


async function showPayAllModal(pelangganId) {

    console.log("💳 Membuka Modal Bayar Semua...");
    
    try {
        // 1. Ambil data pelanggan
        const docPel = await db.collection('pelanggan').doc(pelangganId).get();
        if (!docPel.exists) throw new Error("Pelanggan tidak ditemukan");
        
        const dataPel = docPel.data();
        const namaPel = dataPel.nama;

        // 2. Ambil data tagihan yang BELUM LUNAS pelanggan ini
        const snapshot = await db.collection('tagihan')
            .where('pelanggan_id', '==', pelangganId)
            .where('status', 'in', ['belum', 'telat'])
            .get();
        
        if (snapshot.empty) {
            showToast('info', 'Info', 'Tidak ada tagihan tertunggak.');
            return;
        }

        let listTagihan = [];
        let totalNominal = 0;
        let idsString = "";

        snapshot.forEach(doc => {
            const t = doc.data();
            listTagihan.push(t);
            totalNominal += Number(t.jumlah) || 0;
            idsString += doc.id + ",";
        });

        // Hapus koma terakhir
        idsString = idsString.slice(0, -1);

        // 3. Generate ID Bulan String (Misal: Jan, Feb)
        const bulanList = listTagihan.map(t => {
            const parts = (t.bulan || '').split('-');
            if (parts.length === 2) {
                const dateObj = moment(`${parts[1]}-${parts[0]}-01`);
                return dateObj.format('MMM YY');
            }
            return t.bulan;
        }).join(', ');

        // 4. Buat Modal "Pay All" Dinamis
        const modalId = 'modalPayAllDynamic';
        const oldModal = document.getElementById(modalId);
        if (oldModal) oldModal.remove();

        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal-overlay show';
        modal.style.zIndex = '1060';
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        // 🔥 TAMBAHIN 3 BARIS INI SEBELUM modal.innerHTML
        const safeNamaPel = (namaPel || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');
        const safeBulanList = (bulanList || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');
        const safeIdsString = (idsString || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\n/g, ' ');


        modal.innerHTML = `
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">Pembayaran Tunggakan</h3>
            <button class="modal-close" onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto';">&times;</button>
        </div>
        <div class="modal-body">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <h4>${safeNamaPel}</h4>
                <p style="margin: 5px 0; color: #666;">Total Tagihan: <strong>${formatRupiah(totalNominal)}</strong></p>
                <p style="margin: 0; font-size: 13px;">Periode: ${safeBulanList}</p>
            </div>

            <div class="form-group">
                <label>Metode Pembayaran</label>
                <select id="payAllMetode" class="form-control">
                    <option value="Tunai">Tunai</option>
                    <option value="Transfer Bank">Transfer Bank</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto';">Batal</button>
            <button id="btnExecutePayAll" class="btn btn-success" onclick="executePayAllDirect('${pelangganId}', '${safeIdsString}', ${totalNominal}, '${safeBulanList}', '${modalId}', '${safeNamaPel}')">
                <i class="fas fa-money-bill-wave"></i> Bayar Sekarang
            </button>
        </div>
    </div>
`;
        
        document.body.appendChild(modal);

    } catch (error) {
        console.error("Error show pay all:", error);
        showToast('error', 'Gagal', error.message);
    }
}

async function executePayAllDirect(pelangganId, idsString, totalNominal, bulanString, modalId, namaPelanggan) {
    const btn = document.getElementById('btnExecutePayAll');
    const originalText = btn.innerHTML;
    
    if (!confirm(`Konfirmasi Pelunasan Tunggakan:\n${namaPelanggan}\nTotal: ${formatRupiah(totalNominal)}\n\nLanjutkan?`)) {
        return;
    }

    try {
        showLoading();
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Proses...';

        // 1. Update Status di Database
        const tagihanIds = String(idsString).split(',');
        const batch = db.batch();
        const now = new Date().toISOString();
        const tglHariIni = moment().format('DD MMMM YYYY, HH:mm');

        tagihanIds.forEach(id => {
            const ref = db.collection('tagihan').doc(id);
            batch.update(ref, {
                status: 'lunas',
                tanggal_bayar: tglHariIni,
                metode_bayar: document.getElementById('payAllMetode').value,
                catatan_bayar: 'Pelunasan Tunggakan',
                updated_at: now
            });
        });

        await batch.commit();

        // 2. Buat Nota HTML Sementara (Untuk dijadikan Gambar)
        const strukContainer = document.createElement('div');
        strukContainer.style.position = 'absolute';
        strukContainer.style.left = '-9999px';
        strukContainer.style.top = '0';
        strukContainer.style.width = '300px';
        strukContainer.style.background = 'white';
        strukContainer.style.padding = '10px';
        strukContainer.style.fontFamily = 'monospace';
        strukContainer.style.fontSize = '12px';
        strukContainer.style.color = '#000000';
        strukContainer.style.border = '1px solid #000';

        let namaPerusahaanStruk = 'X-BILL';
let alamatPerusahaanStruk = 'Jl. Internet Cepat No. 1';
if (globalCompanyId) {
    const companyDoc = await db.collection('company_settings').doc(globalCompanyId).get();

    if (companyDoc.exists) {
        const data = companyDoc.data();
        namaPerusahaanStruk = data.companyName || 'X-BILL';
        alamatPerusahaanStruk = data.companyAddress || 'Jl. Internet Cepat No. 1';
    }
}

        strukContainer.innerHTML = `
            <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px;">
                <h3 style="margin: 0; font-size: 18px; font-weight: bold;">${namaPerusahaanStruk}</h3>
                <p style="margin: 0; font-size: 10px;">${alamatPerusahaanStruk}</p>
            </div>

            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Pelanggan:</span>
                    <strong>${namaPelanggan}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Tanggal:</span>
                    <span>${tglHariIni}</span>
                </div>
            </div>

            <div style="border-top: 1px solid #000; border-bottom: 1px solid #000; padding: 10px 0; margin: 10px 0; text-align: center;">
                <strong>BUKTI PELUNASAN</strong>
            </div>

            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Item:</span>
                    <span>Pelunasan Tunggakan</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Bulan:</span>
                    <span>${bulanString}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <span>Total:</span>
                    <strong>${formatRupiah(totalNominal)}</strong>
                </div>
            </div>

            <div style="text-align: center; margin-top: 15px; font-weight: bold;">
                STATUS: LUNAS
            </div>

            <div style="text-align: center; margin-top: 20px; border-top: 1px solid #000; padding-top: 10px; font-size: 10px;">
                Terima Kasih<br>
                Simpan struk ini sebagai bukti pembayaran yang sah.
            </div>
        `;

        document.body.appendChild(strukContainer);

        // 3. Generate Gambar (Canvas)
        await new Promise(r => setTimeout(r, 100)); // Tunggu render DOM
        const canvas = await html2canvas(strukContainer, {
            scale: 2,
            useCORS: true,
            backgroundColor: "#ffffff"
        });

        // 4. Hapus elemen HTML
        document.body.removeChild(strukContainer);
        document.getElementById(modalId).remove();

        hideLoading();
        showToast('success', 'Lunas', 'Pembayaran berhasil dicatat.');

        // 5. SHARE KE WA (PAKAI WEB SHARE API)
        canvas.toBlob(function(blob) {

    if (!blob) return;

    const reader = new FileReader();
    reader.onloadend = function () {

        let noTujuan = (teleponPelanggan || "").replace(/\D/g, "");

        if (window.Android && Android.sendImageToWhatsApp) {
            Android.sendImageToWhatsApp(
                noTujuan,
                reader.result
            );
        }
    };

    reader.readAsDataURL(blob);

}, 'image/png');


        // 6. Refresh Table
        await loadTunggakanData();
        await loadTagihanData(); // Refresh tabel tagihan utama juga

                    await batch.commit();

            // ⭐⭐ TAMBAHKAN KODE INI: REFRESH DATA & TAMPILAN ULANG ⭐⭐
            console.log("🔄 Refreshing Data Tagihan...");

            // 1. Bersihkan array global data tagihan (paksa reload biar fresh)
            window.tagihanData = [];

            // 2. Load ulang data tagihan (ini akan mengambil data status 'Lunas' yang baru)
            if (typeof loadTagihanData === 'function') {
                await loadTagihanData();
            }

            // 3. Jika halaman yang sedang aktif adalah 'tunggakan', refresh juga data tunggakan
            if (currentPage === 'tunggakan') {
                if (typeof loadTunggakanData === 'function') {
                    await loadTunggakanData();
                }
            }

            showToast('success', 'Berhasil', 'Pembayaran berhasil dikonfirmasi & Tabel diperbarui');

            // 4. Jika modal bayar terbuka, tutup otomatis
            const modalBayar = document.getElementById('modalBayarTagihan');
            if (modalBayar) {
                modalBayar.classList.remove('show');
                modalBayar.classList.add('hidden');
            }

    } catch (error) {
        hideLoading();
        btn.disabled = false;
        btn.innerHTML = originalText;
        console.error("Error execute pay all:", error);
        showToast('error', 'Gagal', error.message);
    }
}



// ============================================
// FUNGSI LOAD DATA TUNGGAKAN (DENGAN PAGINATION)
// ============================================

let halamanTunggakanSaatIni = 1;
const jumlahDataPerHalamanTunggakan = 10;

async function loadTunggakanData(filterKategori = 'semua') {
     logRead('tunggakan');

    // ⭐⭐ GUARD BARU ⭐⭐
    if (window._loadingTunggakan) return;
    window._loadingTunggakan = true;

    console.log("📊 Loading Tunggakan Data untuk Company:", globalCompanyId);

    const table = document.getElementById('tunggakanTable');
    const paginationContainer = document.getElementById('tunggakanPagination');

    if (!table) {
        console.warn("Tabel tunggakan tidak ditemukan");
        return;
    }

    try {
        table.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px;"><div class="spinner" style="margin:0 auto;"></div> Memuat Data...</td></tr>`;

        // ⭐⭐ PERBAIKAN 1: TAMBAH FILTER COMPANY_ID ⭐⭐
        let snapshot;

// if (window._dashboardCache && window._dashboardCache.tagihanSnapshot) {
   // console.log("⚡ Tunggakan pakai cache tagihan (NO READ)");
    //snapshot = window._dashboardCache.tagihanSnapshot;
// } else {
    console.log("📥 Query tagihan untuk tunggakan (FIRST LOAD)");
    snapshot = await db.collection('tagihan')
        .where('company_id', '==', globalCompanyId)
       .get();
// }

        if (snapshot.empty) {
            table.innerHTML = `
                <tr>
                    <td colspan="7" style="text-align:center; padding: 40px;">
                        <i class="fas fa-check-circle" style="font-size: 48px; color: #e9ecef;"></i>
                        <h4 style="margin-top:15px; color: var(--gray);">Tidak Ada Tunggakan</h4>
                        <p>Semua tagihan sudah lunas untuk perusahaan Anda.</p>
                    </td>
                </tr>`;

            // Reset Stats
            if(document.getElementById('tunggakanRingan')) document.getElementById('tunggakanRingan').textContent = '0';
            if(document.getElementById('tunggakanSedang')) document.getElementById('tunggakanSedang').textContent = '0';
            if(document.getElementById('tunggakanBerat')) document.getElementById('tunggakanBerat').textContent = '0';
            if(document.getElementById('totalTunggakanUang')) document.getElementById('totalTunggakanUang').textContent = 'Rp 0';

            paginationContainer.innerHTML = '';
            return;
        }

        console.log(`✅ ${snapshot.size} tagihan tunggakan ditemukan untuk company: ${globalCompanyId}`);

        // ⭐⭐ PERBAIKAN 2: AMBIL DATA PELANGGAN UNTUK VALIDASI ⭐⭐
        const pelangganSnapshot = await db.collection('pelanggan')
            .where('company_id', '==', globalCompanyId)
            .get();

        const validPelangganMap = {};
        pelangganSnapshot.forEach(doc => {
            const p = doc.data();
            if (p.company_id === globalCompanyId) {
                validPelangganMap[doc.id] = {
                    nama: p.nama || 'Tanpa Nama',
                    telepon: p.telepon || '-'
                };
            }
        });

        console.log(`👥 ${Object.keys(validPelangganMap).length} pelanggan valid untuk company ini`);

        // Group data berdasarkan Pelanggan
        const groupedMap = {};
        let totalNominalSemua = 0;
        let skippedCount = 0;

        snapshot.forEach(doc => {
            const t = doc.data();
            const pid = t.pelanggan_id;

            // ⭐⭐ PERBAIKAN 3: VALIDASI TAGIHAN MILIK COMPANY INI ⭐⭐
            if (t.company_id !== globalCompanyId) {
                console.warn(`⚠️ Tagihan ${doc.id} bukan milik company ini:`, t.company_id);
                skippedCount++;
                return;
            }

            // ⭐⭐ PERBAIKAN 4: VALIDASI PELANGGAN ADA DI DATABASE PELANGGAN ⭐⭐
            if (!validPelangganMap[pid]) {
                console.warn(`⚠️ Tagihan ${doc.id} milik pelanggan ${pid} yang tidak ada di database pelanggan`);
                skippedCount++;
                return;
            }

            if (!groupedMap[pid]) {
                groupedMap[pid] = {
                    pelanggan_id: pid,
                    pelanggan_nama: validPelangganMap[pid].nama,
                    pelanggan_telepon: validPelangganMap[pid].telepon,
                    list_tagihan: [],
                    total_nominal: 0,
                    company_id: globalCompanyId  // ⭐ SIMPAN COMPANY_ID
                };
            }

            // HANYA MASUKKAN JIKA STATUS BELUM ATAU TELAT
if (t.status === 'belum' || t.status === 'telat') {
    groupedMap[pid].list_tagihan.push({
        ...t,
        tagihan_id: doc.id
    });
    groupedMap[pid].total_nominal += Number(t.jumlah) || 0;
}
// KALAU LUNAS, JANGAN DIMASUKKAN
            totalNominalSemua += Number(t.jumlah) || 0;
        });

        console.log(`📊 ${Object.keys(groupedMap).length} grup valid, ${skippedCount} data di-skip`);

        Object.keys(groupedMap).forEach(pid => {
            // HAPUS PELANGGAN YANG LIST_TAGIHANNYA KOSONG
            if (groupedMap[pid].list_tagihan.length === 0) {
                delete groupedMap[pid];
            }
        });

        // --- PROSES DATA (HITUNG KATEGORI & STRING) ---
        let processedData = Object.values(groupedMap).map(item => {
            let maxHariTerlambat = 0;
            let statusTerparah = 'belum';

            // Helper buat string bulan
            let listBulan = item.list_tagihan.map(t => {
                const rawBulan = t.bulan || '';
                let dateObj = null;

                if (rawBulan.includes('-')) {
                    const parts = rawBulan.split('-');
                    if (parts.length === 2 && parts[0].length === 4) dateObj = moment(rawBulan);
                    else if (parts.length === 2 && parts[0].length <= 2) dateObj = moment(rawBulan, 'MM-YYYY');
                    else if (parts.length === 3) {
                        const fixedString = `${parts[1]}-${parts[2]}-${parts[0]}`;
                        dateObj = moment(fixedString, 'YYYY-MM-DD');
                    }
                } else {
                    dateObj = moment(rawBulan);
                }
                if (dateObj && dateObj.isValid()) return dateObj.format('MMM YY');
                return rawBulan;
            }).join(', ');

            // Helper buat string jatuh tempo & hitung hari terlambat
let jatuhTempoText = '-';
let jatuhTempoDate = null;

if (item.list_tagihan.length > 0) {
    // ⭐⭐ CARI BULAN TERAKHIR DARI SEMUA TAGIHAN ⭐⭐
    let latestMonth = null;
    let latestTimestamp = 0;

    item.list_tagihan.forEach(tagihan => {
        if (tagihan.bulan) {
            // Coba parse bulan (berbagai format)
            let monthMoment = null;

            // Coba format MM-YYYY
            if (tagihan.bulan.includes('-')) {
                const parts = tagihan.bulan.split('-');
                if (parts.length === 2) {
                    if (parts[0].length === 2) { // MM-YYYY
                        monthMoment = moment(`${parts[1]}-${parts[0]}-01`);
                    } else if (parts[0].length === 4) { // YYYY-MM
                        monthMoment = moment(`${parts[0]}-${parts[1]}-01`);
                    }
                }
            }

            if (monthMoment && monthMoment.isValid()) {
                const timestamp = monthMoment.valueOf();
                if (timestamp > latestTimestamp) {
                    latestTimestamp = timestamp;
                    latestMonth = monthMoment;
                }
            }
        }
    });

    // JIKA KETEMU BULAN TERAKHIR
    if (latestMonth) {
        // ⭐⭐ JATUH TEMPO = TANGGAL 10 BULAN TERAKHIR ⭐⭐
        jatuhTempoDate = latestMonth.date(10); // Tanggal 10
        jatuhTempoText = jatuhTempoDate.format('DD MMM YYYY'); // Contoh: 10 Apr 2026
    } else {
        // FALLBACK: pakai tanggal jatuh tempo pertama
        if (item.list_tagihan[0].tanggal_jatuh_tempo) {
            jatuhTempoDate = moment(item.list_tagihan[0].tanggal_jatuh_tempo, 'DD-MM-YYYY');
            if (jatuhTempoDate.isValid()) {
                jatuhTempoText = jatuhTempoDate.format('DD MMM YYYY');
            }
        }
    }
}

            item.list_tagihan.forEach(t => {
                // CEK SEMUA TAGIHAN YANG BELUM LUNAS (baik 'belum' maupun 'telat')
                if ((t.status === 'belum' || t.status === 'telat') && t.tanggal_jatuh_tempo) {
                    statusTerparah = t.status === 'telat' ? 'telat' : 'belum';

                    // Parse tanggal jatuh tempo (ikuti format yang sudah ada)
                    let mJatuhTempo = moment(t.tanggal_jatuh_tempo, 'DD-MM-YYYY');
                    if (!mJatuhTempo.isValid()) mJatuhTempo = moment(t.tanggal_jatuh_tempo);

                    if (mJatuhTempo.isValid()) {
                        const hariTelat = moment().diff(mJatuhTempo, 'days');

                        // CARI HARI TERLAMBAT TERBESAR (tagihan terlama)
                        if (hariTelat > maxHariTerlambat) {
                            maxHariTerlambat = hariTelat;
                        }
                    }
                }
            });

            // TENTUKAN KATEGORI BERDASARKAN HARI TERLAMBAT TERBESAR
            let kategori = 'ringan';
            if (maxHariTerlambat > 60) {
                kategori = 'berat';
            } else if (maxHariTerlambat > 30) {
                kategori = 'sedang';
            } else if (maxHariTerlambat > 0) {
                kategori = 'ringan';
            } else {
                kategori = 'belum_telat'; // untuk yang belum lewat jatuh tempo
            }

            return {
                ...item,
                kategori: kategori,
                hari_terlambat: maxHariTerlambat,
                string_bulan: listBulan,
                string_jatuh_tempo: jatuhTempoText,
                jatuh_tempo_date: jatuhTempoDate,
                jumlah_tagihan: item.list_tagihan.length
            };
        });

        // --- UPDATE STATS (PAKAI DATA ASLI: processedData) ---
        let ringanCount = 0, sedangCount = 0, beratCount = 0;
        let totalUang = 0;

        processedData.forEach(item => {
             if (item.kategori === 'ringan') ringanCount++;
             if (item.kategori === 'sedang') sedangCount++;
             if (item.kategori === 'berat') beratCount++;
             totalUang += item.total_nominal;
        });

        // Update UI Stats
        if (document.getElementById('tunggakanRingan')) {
            document.getElementById('tunggakanRingan').textContent = ringanCount;
            document.getElementById('tunggakanRingan').style.cursor = 'pointer';
        }
        if (document.getElementById('tunggakanSedang')) {
            document.getElementById('tunggakanSedang').textContent = sedangCount;
            document.getElementById('tunggakanSedang').style.cursor = 'pointer';
        }
        if (document.getElementById('tunggakanBerat')) {
            document.getElementById('tunggakanBerat').textContent = beratCount;
            document.getElementById('tunggakanBerat').style.cursor = 'pointer';
        }
        if (document.getElementById('totalTunggakanUang')) {
            document.getElementById('totalTunggakanUang').textContent = formatRupiah(totalUang);
            document.getElementById('totalTunggakanUang').style.cursor = 'pointer';
        }

        // --- FILTER DATA UNTUK TABEL ---
        let tableData = [...processedData];

        if (filterKategori !== 'semua') {
            tableData = tableData.filter(item => item.kategori === filterKategori);
        }

        // --- PAGINATION ---
        const totalData = tableData.length;
        const totalPages = Math.ceil(totalData / jumlahDataPerHalamanTunggakan);

        if (halamanTunggakanSaatIni > totalPages) halamanTunggakanSaatIni = 1;

        const startIndex = (halamanTunggakanSaatIni - 1) * jumlahDataPerHalamanTunggakan;
        const endIndex = startIndex + jumlahDataPerHalamanTunggakan;
        const pageData = tableData.slice(startIndex, endIndex);

        // --- RENDER TABEL ---
        table.innerHTML = pageData.map((item) => {
            const jumlahBulan = item.jumlah_tagihan;

            let badgeColor = '#fdcb6e';
            let badgeText = 'Ringan';
            if (item.kategori === 'sedang') {
                badgeColor = '#e17055';
                badgeText = 'Sedang';
            } else if (item.kategori === 'berat') {
                badgeColor = '#d63031';
                badgeText = 'Berat';
            }

            // ⭐⭐ PERBAIKAN 5: TAMBAH INFO COMPANY ID DI DEBUG ⭐⭐
            const debugInfo = item.company_id !== globalCompanyId
                ? `<br><small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Company: ${item.company_id}</small>`
                : '';

            const idTagihanPertama = item.list_tagihan && item.list_tagihan.length > 0 
            ? item.list_tagihan[0].id || item.list_tagihan[0].tagihan_id || '' 
            : '';

            return `
                <tr>
                    <td>
                        <strong>${item.pelanggan_nama}</strong>
                        <br>
                        <small class="text-muted">${item.pelanggan_telepon}</small>
                        ${debugInfo}
                    </td>
                    <td>
                        <small style="color: var(--gray);">${item.string_bulan}</small>
                        <br>
                        <small class="text-muted">${item.jumlah_tagihan} tagihan</small>
                    </td>
                    <td>
                        <strong>${formatRupiah(item.total_nominal)}</strong>
                        <br>
                        <small class="text-muted">${item.hari_terlambat > 0 ? `${item.hari_terlambat} hari telat` : 'Belum telat'}</small>
                    </td>
                    <td>
                        <small>${item.string_jatuh_tempo}</small>
                        ${item.jatuh_tempo_date ? `<br><small class="text-muted">${moment(item.jatuh_tempo_date).fromNow()}</small>` : ''}
                    </td>
                    <td>
                        <div style="background: ${badgeColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; white-space: nowrap; text-align: center; line-height: 1.2;">
                            <div style="font-size: 10px;">${badgeText}</div>
                            <div>(${item.hari_terlambat} Hari)</div>
                        </div>
                    </td>
                    <td>
                        <span class="badge badge-warning">
                            <i class="fas fa-clock"></i> Belum Lunas</span>
                        </span>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-success" 
            data-id="${idTagihanPertama}" 
            data-pid="${item.pelanggan_id}" 
            data-nama="${item.pelanggan_nama}" 
            data-nominal="${item.total_nominal}" 
            data-bulan="${item.string_bulan}" 
            onclick="handleBayarClick(this)" 
            title="Bayar Semua Tunggakan">
        Bayar
    </button>
                            <button class="btn btn-sm btn-info" onclick="viewTagihanDetails('${item.pelanggan_id}')" title="Rincian Tagihan">
                                <i class="fas fa-list"></i> Detail
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');

        // --- RENDER PAGINATION ---
        let paginationHTML = '<div class="pagination">';
        if (halamanTunggakanSaatIni > 1) {
            paginationHTML += `<a class="page-link" onclick="gantiHalamanTunggakan(${halamanTunggakanSaatIni - 1}, '${filterKategori}')">&laquo; Prev</a>`;
        }

        // Tampilkan halaman
        for (let i = 1; i <= totalPages; i++) {
            if (i === halamanTunggakanSaatIni) {
                paginationHTML += `<span class="page-link active">${i}</span>`;
            } else {
                paginationHTML += `<a class="page-link" onclick="gantiHalamanTunggakan(${i}, '${filterKategori}')">${i}</a>`;
            }
        }

        if (halamanTunggakanSaatIni < totalPages) {
            paginationHTML += `<a class="page-link" onclick="gantiHalamanTunggakan(${halamanTunggakanSaatIni + 1}, '${filterKategori}')">Next &raquo;</a>`;
        }

        paginationHTML += `</div><div style="text-align:center; margin-top:10px; color:var(--gray); font-size:12px;">
            Menampilkan ${startIndex + 1}-${Math.min(endIndex, totalData)} dari ${totalData} data tunggakan
        </div>`;

        paginationContainer.innerHTML = paginationHTML;

        // LOG FINAL
        console.log(`🎉 Load tunggakan selesai: ${totalData} data untuk company ${globalCompanyId}`);

    } catch (error) {
        console.error("❌ Error load tunggakan:", error);
        table.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger" style="padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px;"></i>
                    <h4 style="margin-top:15px;">Error Memuat Data</h4>
                    <p>${error.message}</p>
                    <button class="btn btn-outline mt-2" onclick="loadTunggakanData('${filterKategori}')">
                        <i class="fas fa-redo"></i> Coba Lagi
                    </button>
                </td>
            </tr>`;
    }  finally {
        // ✅ WAJIB ADA – INI KUNCI MASALAHNYA
        window._loadingTunggakan = false;
    }
}

function bayarTagihanDariMap(pelangganId) {
    console.log("🔥🔥🔥 FUNGSI DIPANGGIL! pelangganId:", pelangganId);

    // Coba buka modal langsung tanpa cari tagihan
    const modal = document.getElementById('modalBayarTagihan');
    if (modal) {
        console.log("✅ Modal ditemukan, membuka...");
        modal.classList.remove('hidden');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        showToast('success', 'Test', 'Modal terbuka!');
    } else {
        console.error("❌ Modal tidak ditemukan!");
    }
}




// ============================================
// FUNGSI GANTI HALAMAN
// ============================================

function gantiHalamanTunggakan(pageNum, kategori) {
    halamanTunggakanSaatIni = pageNum;
    loadTunggakanData(kategori);
}

        async function getImportExportHTML() {
            return `
                <div class="page import-export-page">
                    <div class="page-header">
                        <h2 class="page-title"><i class="fas fa-file-import"></i> Import & Export Data</h2>
                    </div>

                    <div class="row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-upload"></i> Import Data</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Tipe Data</label>
                                    <select class="form-control" id="importType">
                                        <option value="pelanggan">Data Pelanggan</option>
                                        <option value="paket">Data Paket</option>
                                        <option value="tagihan">Data Tagihan</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Pilih File</label>
                                    <input type="file" class="form-control" id="fileImport" accept=".xlsx,.xls,.csv">
                                    <small class="text-muted">Format: Excel (.xlsx, .xls) atau CSV</small>
                                </div>

                                <div class="form-group">
                                    <label>Aksi</label>
                                    <select class="form-control" id="importAction">
                                        <option value="tambah">Tambah Data Baru</option>
                                        <option value="update">Update Data Existing</option>
                                        <option value="replace">Replace Semua Data</option>
                                    </select>
                                </div>

                                <div class="action-buttons" style="margin-top: 20px;">
                                    <button class="btn btn-primary" onclick="downloadTemplate()">
                                        <i class="fas fa-download"></i> Download Template
                                    </button>
                                    <button class="btn btn-success" onclick="importExcel()">
                                        <i class="fas fa-upload"></i> Import Data
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-download"></i> Export Data</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Tipe Data</label>
                                    <select class="form-control" id="exportType">
                                        <option value="pelanggan">Data Pelanggan</option>
                                        <option value="paket">Data Paket</option>
                                        <option value="tagihan">Data Tagihan</option>
                                        <option value="tunggakan">Data Tunggakan</option>
                                        <option value="all">Semua Data</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Format File</label>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" name="exportFormat" id="exportExcel" value="excel" checked>
                                        <label class="form-check-label" for="exportExcel">Excel (.xlsx)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" name="exportFormat" id="exportCSV" value="csv">
                                        <label class="form-check-label" for="exportCSV">CSV (.csv)</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" name="exportFormat" id="exportJSON" value="json">
                                        <label class="form-check-label" for="exportJSON">JSON (.json)</label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>Include</label>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="includeHeader" checked>
                                        <label class="form-check-label" for="includeHeader">Header Kolom</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="includeTimestamp" checked>
                                        <label class="form-check-label" for="includeTimestamp">Timestamp</label>
                                    </div>
                                </div>

                                <div class="action-buttons" style="margin-top: 20px;">
                                    <button class="btn btn-success" onclick="exportData()">
                                        <i class="fas fa-download"></i> Export Data
                                    </button>
                                    <button class="btn btn-info" onclick="backupManual()">
                                        <i class="fas fa-save"></i> Backup Manual
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3>Log Import/Export</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Tanggal</th>
                                            <th>Tipe</th>
                                            <th>File</th>
                                            <th>Jumlah Data</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logTable">
                                        <tr>
                                            <td colspan="5" class="text-center">Tidak ada log</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function getLaporanHTML() {
    return `
        <div class="page laporan-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-chart-bar"></i> Laporan & Analytics</h2>
                <div class="action-buttons">

                    <!-- TOMBOL GENERATE TETAP ADA DISINI -->
                    
                </div>
            </div>

            <div class="filters-card">
                <div class="filter-row">
                    <div class="form-group">
                        <label>Periode Awal</label>
                        <input type="date" class="form-control" id="laporanStartDate" value="${moment().startOf('month').format('YYYY-MM-DD')}">
                    </div>
                    <div class="form-group">
                        <label>Periode Akhir</label>
                        <input type="date" class="form-control" id="laporanEndDate" value="${moment().endOf('month').format('YYYY-MM-DD')}">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" style="margin-top: 25px;" onclick="generateLaporan()">
                            <i class="fas fa-filter"></i> Tampilkan
                        </button>
                    </div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <h3>Grafik Pendapatan</h3>
                    <canvas id="laporanChart1" height="150"></canvas>
                </div>
                <div class="chart-card">
    <h3>
        <i class="fas fa-users"></i> Distribusi Pelanggan
        <small style="font-size: 12px; color: #666; margin-left: 10px;">
            <span id="pelangganAktifCount">0</span> Aktif |
            <span id="pelangganTunggakCount">0</span> Tunggak |
            <span id="pelangganNonaktifCount">0</span> Nonaktif
        </small>
    </h3>
    <canvas id="laporanChart2" height="150"></canvas>
</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3>Detail Laporan</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table" id="laporanTable">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Pelanggan</th>
                                    <th>Periode</th>
                                    <th>Nominal</th>
                                    <th>Status</th>
                                    <th>Metode</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="text-center">Menunggu generate laporan...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    `;
}


        // ============================================
// FUNGSI IMPORT/EXPORT DATA PELANGGAN
// ============================================

// TAMPILKAN/SEMBUNYIKAN PANEL IMPORT/EXPORT
function showImportExportPanel() {
    document.getElementById('importExportPanel').classList.remove('hidden');

}

function hideImportExportPanel() {
    document.getElementById('importExportPanel').classList.add('hidden');
}

// DOWNLOAD TEMPLATE EXCEL
function downloadTemplatePelanggan() {
    try {
        // Buat data template
        const templateData = [
            ['nama', 'telepon', 'email', 'alamat', 'paket', 'harga', 'tanggal_pasang', 'status', 'koordinat', 'catatan'],
            ['Budi Santoso', '081234567890', 'budi@email.com', 'Jl. Contoh No. 123', 'Paket 20 Mbps', '250000', '2024-01-15', 'aktif', '-6.2088, 106.8456', 'Pelanggan baru'],
            ['Siti Rahayu', '082345678901', 'siti@email.com', 'Jl. Contoh No. 456', 'Paket 10 Mbps', '150000', '2024-02-01', 'aktif', '-6.2250, 106.8050', ''],
            // ... tambahkan contoh lainnya
        ];

        // Buat workbook
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(templateData);
        XLSX.utils.book_append_sheet(wb, ws, 'Template Pelanggan');

        // Download
        XLSX.writeFile(wb, 'Template_Pelanggan_XBILL.xlsx');

        showToast('success', 'Template', 'Template berhasil didownload');

    } catch (error) {
        console.error("Error download template:", error);
        showToast('error', 'Error', 'Gagal download template');
    }
}


// IMPORT DATA DARI EXCEL/CSV
// IMPORT DATA DARI EXCEL/CSV - VERSI PERBAIKAN (HANYA TAMBAH DATA BARU)
// IMPORT DATA PELANGGAN (FIX: UPDATE JIKA SUDAH ADA, JANGAN HAPUS)
async function importDataPelanggan() {
    const fileInput = document.getElementById('fileImportPelanggan');

    if (!fileInput) return;
    if (!fileInput.files.length) {
        showToast('error', 'Error', 'Pilih file dulu');
        return;
    }

    try {
        showLoading();
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (jsonData.length === 0) throw new Error('File kosong');

                // 1. AMBIL DATA PELANGGAN YANG SUDAH ADA DI DATABASE
                const existingSnapshot = await db.collection('pelanggan')
                    .where('company_id', '==', globalCompanyId)
                    .get();

                // Simpan data pelanggan yang sudah ada ke Map agar pencarian cepat (O(1))
                const existingMap = {}; // Struktur: { 'email': docId, 'nomor_telp': docId }

                existingSnapshot.forEach(doc => {
                    const t = doc.data();
                    if (t.email) existingMap[t.email.toLowerCase()] = doc.id;
                    if (t.telepon) existingMap[t.telepon] = doc.id;
                });

                let insertCount = 0;
                let updateCount = 0; // <--- VARIABEL BARU
                let skipCount = 0;
                const batch = db.batch();
                const now = new Date().toISOString();

                for (let i = 0; i < jsonData.length; i++) {
                    try {
                        const row = jsonData[i];

                        // FUNGSI BANTUAN MENCARI KEY (CASE INSENSITIVE)
                        function findKeySmart(row, search) {
                            return Object.keys(row).find(key => {
                                const keyString = key.toString();
                                const keyClean = keyString.trim().toLowerCase();
                                return keyClean === search.toLowerCase();
                            });
                        }

                        const keyNama = findKeySmart(row, 'nama');
                        const keyTelepon = findKeySmart(row, 'telepon');

                        if (!keyNama || !keyTelepon) {
                            skipCount++;
                            continue;
                        }

                        const namaRaw = row[keyNama];
                        const teleponRaw = row[keyTelepon];

                        if (!namaRaw || !teleponRaw) {
                            skipCount++;
                            continue;
                        }

                        const namaClean = namaRaw.toString().trim();
                        const teleponClean = teleponRaw.toString().trim();
                        const emailClean = row[findKeySmart(row, 'email')] ? row[findKeySmart(row, 'email')].toString().trim() : `${teleponClean}`;

                        // ==========================================
                        // PERUBAHAN LOGIKA DISINI: CEK DAN UPDATE
                        // ==========================================

                        // Cek apakah Email atau Telepon sudah terdaftar
                        let existingDocId = null;
                        let isUpdate = false;

                        if (existingMap[emailClean.toLowerCase()]) {
                            existingDocId = existingMap[emailClean.toLowerCase()];
                        } else if (existingMap[teleponClean]) {
                            existingDocId = existingMap[teleponClean];
                        }

                        // 🔥 VALIDASI DOC MASIH ADA


                        if (existingDocId) {
                            isUpdate = true;
                        }



                        if (isUpdate && existingDocId) {
                            // >>>>> LOGIKA UPDATE (Jika data sudah ada) <<<<<
                            console.log(`♻️ UPDATE (DATA SUDAH ADA): ${namaClean} - ${teleponClean}`);

                            const pelangganData = {
                                server: row[findKeySmart(row, 'server')] ? row[findKeySmart(row, 'server')].toString().trim() : '',
                                nama: namaClean,
                                telepon: teleponClean,
                                email: emailClean,
                                alamat: row[findKeySmart(row, 'alamat')] ? row[findKeySmart(row, 'alamat')].toString().trim() : '',
                                paket: row[findKeySmart(row, 'paket')] ? row[findKeySmart(row, 'paket')].toString().trim() : 'Paket 10 Mbps',
                                harga: parseInt(row[findKeySmart(row, 'harga')]) || 150000,
                                tanggal_pasang: function() {
                                    const possibleKeys = ['tanggal_pasang', 'tanggalpasang', 'tgl_pasang', 'tglpasang', 'tanggal', 'tgl', 'date', 'install_date', 'tanggal_install', 'tanggalinstall', 'tgl_install', 'tglinstall'];
                                    for (let key of possibleKeys) {
                                        const foundKey = findKeySmart(row, key);
                                        if (foundKey && row[foundKey]) {
                                            const dateValue = row[foundKey].toString().trim();
                                            if (dateValue) {
                                                let parsedDate = null;

                                                // Coba format berbagai
                                                if (dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                                    parsedDate = dateValue;
                                                } else if (dateValue.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                                                    const parts = dateValue.split('/');
                                                    parsedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                                                } else if (dateValue.match(/^\d{2}-\d{2}-\d{4}$/)) {
                                                    const parts = dateValue.split('-');
                                                    parsedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                                                } else {
                                                    const m = moment(dateValue);
                                                    if (m.isValid()) {
                                                        parsedDate = m.format('YYYY-MM-DD');
                                                    }
                                                }

                                                if (parsedDate) {
                                                    return parsedDate;
                                                }
                                            }
                                        }
                                    }

                                    // Default ke tanggal pasang yang ada di database lama jika memungkinkan,
                                    // atau tanggal yang logis (misal: 1 bulan lalu)
                                    return new Date().toISOString().split('T')[0];
                                }(),
                                status: row[findKeySmart(row, 'status')] ? row[findKeySmart(row, 'status')].toString().trim() : 'aktif',
                                koordinat: row[findKeySmart(row, 'koordinat')] ? row[findKeySmart(row, 'koordinat')].toString().trim() : '',
                                catatan: row[findKeySmart(row, 'catatan')] ? row[findKeySmart(row, 'catatan')].toString().trim() : '',
                                company_id: globalCompanyId,
                                updated_at: now,

                                __isNewImport: true,
                                __importTime: Date.now()



                            };

                            // Lakukan UPDATE pada dokumen yang sudah ada
                            batch.update(db.collection('pelanggan').doc(existingDocId), pelangganData);
                            updateCount++; // <--- Tambah COUNTER UPDATE

                        } else {
                            // >>>>> LOGIKA INSERT (Jika data baru) <<<<<
                            console.log(`✅ INSERT (BARU): ${namaClean} - ${teleponClean}`);

                            // Buat data pelanggan baru
                            const pelangganData = {
                                server: row[findKeySmart(row, 'server')] ? row[findKeySmart(row, 'server')].toString().trim() : '',
                                nama: namaClean,
                                telepon: teleponClean,
                                email: emailClean,
                                alamat: row[findKeySmart(row, 'alamat')] ? row[findKeySmart(row, 'alamat')].toString().trim() : '',
                                paket: row[findKeySmart(row, 'paket')] ? row[findKeySmart(row, 'paket')].toString().trim() : 'Paket 10 Mbps',
                                harga: parseInt(row[findKeySmart(row, 'harga')]) || 150000,
                                tanggal_pasang: function() {
                                    const possibleKeys = ['tanggal_pasang', 'tanggalpasang', 'tgl_pasang', 'tglpasang', 'tanggal', 'tgl', 'date', 'install_date', 'tanggal_install', 'tanggalinstall', 'tgl_install', 'tglinstall'];
                                    for (let key of possibleKeys) {
                                        const foundKey = findKeySmart(row, key);
                                        if (foundKey && row[foundKey]) {
                                            const dateValue = row[foundKey].toString().trim();
                                            if (dateValue) {
                                                let parsedDate = null;

                                                // Coba format berbagai
                                                if (dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                                    parsedDate = dateValue;
                                                } else if (dateValue.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                                                    const parts = dateValue.split('/');
                                                    parsedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                                                } else if (dateValue.match(/^\d{2}-\d{2}-\d{4}$/)) {
                                                    const parts = dateValue.split('-');
                                                    parsedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                                                } else {
                                                    const m = moment(dateValue);
                                                    if (m.isValid()) {
                                                        parsedDate = m.format('YYYY-MM-DD');
                                                    }
                                                }

                                                if (parsedDate) {
                                                    return parsedDate;
                                                }
                                            }
                                        }
                                    }

                                    // Default ke tanggal pasang yang ada di database lama jika memungkinkan,
                                    // atau tanggal yang logis (misal: 1 bulan lalu)
                                    return new Date().toISOString().split('T')[0];
                                }(),
                                status: row[findKeySmart(row, 'status')] ? row[findKeySmart(row, 'status')].toString().trim() : 'aktif',
                                koordinat: row[findKeySmart(row, 'koordinat')] ? row[findKeySmart(row, 'koordinat')].toString().trim() : '',
                                catatan: row[findKeySmart(row, 'catatan')] ? row[findKeySmart(row, 'catatan')].toString().trim() : '',
                                company_id: globalCompanyId,
                                created_at: now,
                                updated_at: now,
                                __importTime: Date.now()
                            };

                            const newId = `CUST_${Date.now()}_${i}_${Math.random().toString(36).substr(2, 6)}`;
                            const docRef = db.collection('pelanggan').doc(newId);
                            batch.set(docRef, pelangganData);
                            insertCount++;
                        }

                    } catch (errRow) {
                        console.error("Error baris " + i, errRow);
                        skipCount++;
                    }
                }

                // 3. EKSEKUSI SIMPAN KE DATABASE
                if (insertCount > 0 || updateCount > 0) {
                    await batch.commit();

                    // Log aktivitas
                    await db.collection('aktivitas').add({
                        aktivitas: `Import Pelanggan: ${insertCount} baru, ${updateCount} diperbarui.`,
                        user: getUserLogName(),
                        timestamp: now,
                        company_id: globalCompanyId
                    });
                }

                  // 🔥 RESET CACHE (WAJIB!)
                window._pelangganCache = null;
                window._pelangganCacheTime = 0;

                // 🔥 RESET GLOBAL VARIABLE
                window.pelangganData = null;
                window.filteredPelangganData = null;

                // 🔥 REFRESH TABEL DARI DATABASE (PASTI SEGAR)
                // await loadPelangganData();

                // SORTING MANUAL: Data terbaru di atas
                if (window.pelangganData && window.pelangganData.length > 0) {
                    window.pelangganData.sort((a, b) => {
                        // Urutkan berdasarkan __importTime (terbaru di atas)
                        return (b.__importTime || 0) - (a.__importTime || 0);
                    });
                    window.filteredPelangganData = [...window.pelangganData];

                    // Render ulang halaman 1
                    currentPagePelanggan = 1;
                    renderPelangganTable(window.filteredPelangganData);
                }

                hideLoading();

                // 4. NOTIFIKASI HASIL
                if (insertCount === 0 && updateCount === 0) {
                    showToast('info', 'Tidak Ada Perubahan', `Semua data (${skipCount} baris) sudah ada dan sama.`);
                } else {
                    // Tampilkan pesan sukses yang jelas
                    let pesan = `Import Selesai.<br>`;
                    if (insertCount > 0) pesan += `<strong>${insertCount} data baru</strong> ditambahkan.<br>`;
                    if (updateCount > 0) pesan += `<strong>${updateCount} data lama</strong> diperbarui.`;

                    showToast('success', 'Berhasil', pesan);
                }

                // 5. REFRESH TABEL AGAR DATA BARU MUNCUL
                // await loadPelangganData();

       currentPagePelanggan = 1;
await loadPelangganData();


            } catch (parseError) {
                hideLoading();
                console.error("Error parsing:", parseError);
                showToast('error', 'Error', 'Gagal membaca file: ' + parseError.message);
            }
        };

        reader.onerror = function() {
            hideLoading();
            showToast('error', 'Error', 'Gagal membaca file');
        };

        reader.readAsArrayBuffer(file);

    } catch (error) {
        hideLoading();
        console.error("Error import:", error);
        showToast('error', 'Gagal', 'Gagal import data: ' + error.message);
    }
}

// EXPORT DATA PELANGGAN
// ============================================
// ✅ EXPORT DATA PELANGGAN - VERSI FIX TOTAL
// ============================================
async function exportDataPelanggan() {
    console.log("📤 FUNGSI EXPORT DIPANGGIL");

    try {
        showLoading();

        // 🔥 CEK COMPANY ID
        if (!globalCompanyId) {
            await ensureCompanyId();
            if (!globalCompanyId) {
                throw new Error("Company ID tidak ditemukan");
            }
        }

        console.log("📊 Mengambil data pelanggan untuk company:", globalCompanyId);

        // 🔥 AMBIL DATA DARI DATABASE
        const snapshot = await db.collection('pelanggan')
            .where('company_id', '==', globalCompanyId)
            .get();

        console.log(`📋 Ditemukan ${snapshot.size} data pelanggan`);

        if (snapshot.empty) {
            hideLoading();
            showToast('warning', 'Data Kosong', 'Tidak ada data pelanggan untuk diexport');
            return;
        }

        // 🔥 FORMAT DATA UNTUK EXCEL
        const data = [];

        // HEADER
        data.push([
            'No',
            'Server',
            'Nama',
            'Telepon',
            'Email',
            'Alamat',
            'Paket',
            'Harga',
            'Status',
            'Tanggal Pasang',
            'Koordinat GPS',
            'Catatan',
            'Created At',
            'Tanggal Update'
        ]);

        // DATA ROWS
        let no = 1;
        snapshot.forEach(doc => {
            const p = doc.data();
            data.push([
                no++,
                p.server || '-',
                p.nama || '-',
                p.telepon || '-',
                p.email || '-',
                p.alamat || '-',
                p.paket || '-',
                p.harga ? formatRupiah(p.harga).replace('Rp', '').trim() : '0',
                p.status || '-',
                p.tanggal_pasang || '-',
                p.koordinat || '-',
                p.catatan || '-',
                p.created_at ? moment(p.created_at).format('DD/MM/YYYY HH:mm') : '-',
                p.updated_at ? moment(p.updated_at).format('DD/MM/YYYY HH:mm') : '-'
            ]);
        });

        console.log(`✅ ${data.length - 1} baris data siap diexport`);

        // 🔥 BUAT WORKBOOK EXCEL
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);

        // 🔥 FORMAT COLUMN WIDTH
        ws['!cols'] = [
            { wch: 5 },   // No
            { wch: 15 },  // Server
            { wch: 25 },  // Nama
            { wch: 15 },  // Telepon
            { wch: 25 },  // Email
            { wch: 30 },  // Alamat
            { wch: 15 },  // Paket
            { wch: 15 },  // Harga
            { wch: 10 },  // Status
            { wch: 15 },  // Tanggal Pasang
            { wch: 20 },  // Koordinat
            { wch: 25 },  // Catatan
            { wch: 20 },  // Created At
            { wch: 20 }   // Tanggal Update
        ];

        XLSX.utils.book_append_sheet(wb, ws, 'Data Pelanggan');

        // 🔥 GENERATE FILENAME
        const now = moment().format('YYYYMMDD_HHmmss');
        const companyName = document.getElementById('companyNameNav')?.textContent || 'XBILL';
        const fileName = `Data_Pelanggan_${companyName}_${now}.xlsx`;

        console.log("💾 Menyimpan file:", fileName);

        // 🔥🔥🔥 DOWNLOAD FILE (PAKSA DOWNLOAD) 🔥🔥🔥
        // 🔥🔥🔥 DOWNLOAD FILE VIA ANDROID (MASUK DOWNLOAD UMUM) 🔥🔥🔥
try {

    const base64 = XLSX.write(wb, {
        bookType: 'xlsx',
        type: 'base64'
    });

    if (window.Android && Android.saveBase64File) {
        Android.saveBase64File(base64, fileName);
        console.log("✅ File dikirim ke Android Download Folder");
    } else {
        throw new Error("Android bridge tidak tersedia");
    }

} catch (err) {
    console.error("❌ Gagal kirim ke Android:", err);
    throw err;
}


        // 🔥 LOG AKTIVITAS
        try {
            await db.collection('aktivitas').add({
                aktivitas: `Export data pelanggan: ${snapshot.size} data`,
                user: getUserLogName(),
                timestamp: new Date().toISOString(),
                company_id: globalCompanyId,
                details: {
                    filename: fileName,
                    total_data: snapshot.size
                }
            });
        } catch (logError) {
            console.warn("⚠️ Gagal log aktivitas:", logError);
        }

        hideLoading();
        showToast('success', 'Export Berhasil',
            `✅ ${snapshot.size} data pelanggan berhasil diexport<br>📁 File: ${fileName}`,
            5000);

    } catch (error) {
        console.error("❌ Error export data pelanggan:", error);
        hideLoading();
        showToast('error', 'Export Gagal',
            'Gagal export data: ' + error.message,
            5000);
    }
}

// QUICK EXPORT (TOMBOl CEPAT)
async function quickExportPelanggan(format = 'excel') {
    try {
        showLoading();

        // Ambil semua data pelanggan
        const snapshot = await db.collection('pelanggan')
    .where('company_id', '==', globalCompanyId)  // ⭐ FILTER COMPANY
    .get();

        if (snapshot.empty) {
            hideLoading();
            showToast('warning', 'Data Kosong', 'Tidak ada data pelanggan');
            return;
        }

        // Format data sederhana
        const data = [
            ['No', 'server', 'Nama', 'Telepon',  'Alamat', 'lokasi', 'Paket', 'Harga', 'Status', 'Tanggal Pasang']
        ];

        let index = 1;
        snapshot.forEach(doc => {
            const pelanggan = doc.data();
            data.push([
                index++,
                pelanggan.server || '',
                pelanggan.nama || '',
                pelanggan.telepon || '',
                pelanggan.alamat || '',
                pelanggan.koordinat || '',
                pelanggan.paket || '',
                pelanggan.harga || 0,
                pelanggan.status || '',
                pelanggan.tanggal_pasang || ''
            ]);
        });

        // Export berdasarkan format
        const now = moment().format('YYYYMMDD_HHmmss');

        if (format === 'excel') {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Pelanggan');
            XLSX.writeFile(wb, `Pelanggan_XBILL_${now}.xlsx`);

        } else if (format === 'csv') {
            const csvContent = data.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Pelanggan_XBILL_${now}.csv`;
            link.click();
        }

        hideLoading();
        showToast('success', 'Export Berhasil', `${snapshot.size} data diexport`);

    } catch (error) {
        hideLoading();
        console.error("Error quick export:", error);
        showToast('error', 'Error', 'Gagal export cepat');
    }
}

// BACKUP LENGKAP
async function exportBackupPelanggan() {
    if (!confirm('Buat backup lengkap semua data pelanggan?\n\nBackup akan mencakup semua data termasuk yang sudah dihapus.')) {
        return;
    }

    try {
        showLoading();

        // Ambil SEMUA data pelanggan (termasuk yang sudah dihapus/archive jika ada)
        const snapshot = await db.collection('pelanggan')
    .where('company_id', '==', globalCompanyId)  // ⭐ FILTER COMPANY
    .get();

        if (snapshot.empty) {
            hideLoading();
            showToast('warning', 'Data Kosong', 'Tidak ada data untuk dibackup');
            return;
        }

        // Format data backup lengkap
        const backupData = {
            metadata: {
                system: 'X-BILL',
                type: 'pelanggan_backup',
                exported_at: new Date().toISOString(),
                total_records: snapshot.size,
                version: '1.0'
            },
            data: []
        };

        // Tambah semua data
        snapshot.forEach(doc => {
            backupData.data.push({
                id: doc.id,
                ...doc.data()
            });
        });

        // Buat file JSON
        const now = moment().format('YYYYMMDD_HHmmss');
        const fileName = `Backup_Pelanggan_XBILL_${now}.json`;
        const jsonStr = JSON.stringify(backupData, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });

        // Download
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        link.click();

        // Log aktivitas
        await db.collection('aktivitas').add({
            aktivitas: `Backup lengkap data pelanggan: ${snapshot.size} records`,
            user: getUserLogName(),
            timestamp: new Date().toISOString()
        });

        hideLoading();
        showToast('success', 'Backup Berhasil', `Backup ${snapshot.size} data berhasil dibuat`);

    } catch (error) {
        hideLoading();
        console.error("Error backup:", error);
        showToast('error', 'Error', 'Gagal membuat backup');
    }
}

// UPDATE LOG IMPORT/EXPORT
function updateImportExportLog(message) {
    const logContainer = document.getElementById('importExportLogPelanggan');
    if (!logContainer) return;

    const timestamp = moment().format('HH:mm:ss');
    const logEntry = document.createElement('div');
    logEntry.style.padding = '5px';
    logEntry.style.borderBottom = '1px solid #f1f1f1';
    logEntry.innerHTML = `<strong>${timestamp}:</strong> ${message}`;

    logContainer.prepend(logEntry);

    // Batasi hanya 10 log terakhir
    const logs = logContainer.children;
    if (logs.length > 10) {
        for (let i = 10; i < logs.length; i++) {
            logContainer.removeChild(logs[i]);
        }
    }
}



        // ============================================
// FIX QUICK ACTIONS EVENT HANDLERS
// ============================================

function initializeQuickActions() {
    // Generate Tagihan
    document.getElementById('btnGenerateTagihan')?.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = document.getElementById('modalGenerateTagihan');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            showToast('info', 'Generate Tagihan', 'Membuka form generate tagihan');
        } else {
            showToast('error', 'Error', 'Modal generate tagihan tidak ditemukan');
        }
    });

    // Kirim Reminder
    document.getElementById('btnKirimReminder')?.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = document.getElementById('modalReminder');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            showToast('info', 'Kirim Reminder', 'Membuka form kirim reminder');
        } else {
            showToast('error', 'Error', 'Modal reminder tidak ditemukan');
        }
    });

    // Export Laporan
    document.getElementById('btnExportLaporan')?.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = document.getElementById('modalExportLaporan');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            showToast('info', 'Export Laporan', 'Membuka form export laporan');
        } else {
            showToast('error', 'Error', 'Modal export laporan tidak ditemukan');
        }
    });

    // Backup Data
    document.getElementById('btnBackupData')?.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = document.getElementById('modalBackup');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            showToast('info', 'Backup Data', 'Membuka form backup data');
        } else {
            showToast('error', 'Error', 'Modal backup tidak ditemukan');
        }
    });
}




// Panggil fungsi ini dalam renderDashboard() setelah rendering selesai
// ============================================
// RENDER DASHBOARD (FULL FIXED FUNCTION)
// ============================================

async function renderDashboard() {
console.count("🔥 renderDashboard CALLED");


        console.time("renderDashboard"); // ⭐ TAMBAH INI
       // logRead('dashboard');



    console.log("🔄 MEMULAI RENDER DASHBOARD dengan data TERISOLASI");

       // ⭐⭐ TAMBAHKAN INI: SIMPAN STATE MAP SEBELUM RENDER ⭐⭐
    const mapWasInitialized = window.pelangganMap && window.isMapInitialized;
    const oldMap = window.pelangganMap;

    // 1. TAMPILKAN LOADING
    const loadingEl = document.getElementById('loadingOverlay');
    if (loadingEl) loadingEl.classList.remove('hidden');

    try {

     // 6. HITUNG TAGIHAN BULAN INI (DAN TUNGGAKAN) ✨ PERBAIKAN DISINI
        const bulanSekarangText = moment().format('MM-YYYY');
        const tahunSekarang = moment().format('YYYY');
        const bulanAngkaSekarang = moment().format('MM');


        // 2. PASTIKAN GLOBAL COMPANY ID
        if (!globalCompanyId) {
            console.warn("⚠️ globalCompanyId kosong, mencoba fallback...");
            if (!globalCompanyId) globalCompanyId = localStorage.getItem('xbill_company_id') || 'COMP_DEFAULT';
        }

        // 3. AMBIL DATA DARI FIREBASE (CACHE FIX - TANPA UBAH ALUR)
console.log("📥 Mengambil data TERISOLASI untuk Company:", globalCompanyId);

if (!window._dashboardCache) {

    const [pelangganSnapshot, tagihanSnapshot] = await Promise.all([
        db.collection('pelanggan').where('company_id', '==', globalCompanyId).get(),
        db.collection('tagihan').where('company_id', '==', globalCompanyId).get()
    ]);

    window._dashboardCache = {
    pelangganSnapshot,
    tagihanSnapshot
};
window._dashboardCacheTime = Date.now();  // 🔥 TAMBAH INI!

    console.log(`✅ Data loaded: ${pelangganSnapshot.size} pelanggan, ${tagihanSnapshot.size} tagihan`);
}

const { pelangganSnapshot, tagihanSnapshot } = window._dashboardCache;

window._dashboardLoaded = true;


        // 4. SIMPAN ID PELANGGAN YANG VALID KE ARRAY
        let pelangganIds = [];
        const pelangganMap = {};

        pelangganSnapshot.forEach(doc => {
            const p = doc.data();
            if (p.company_id === globalCompanyId) {
                pelangganIds.push(doc.id);
                pelangganMap[doc.id] = {
                    nama: p.nama || 'Tanpa Nama',
                    telepon: p.telepon || '-',
                    alamat: p.alamat || '-'
                };
            }
        });

        console.log(`👥 ${pelangganIds.length} pelanggan valid untuk company ini`);

        // 5. UPDATE UI - TOTAL PELANGGAN
         const statPelangganEl = document.getElementById('statPelanggan');
        if (statPelangganEl) {
            statPelangganEl.textContent = pelangganSnapshot.size;
        } else {
            console.warn("⚠️ Elemen #statPelanggan tidak ditemukan!");
        }

        const userRole = localStorage.getItem('userRole');
        if (userRole !== 'admin') {
            const card = document.getElementById('cardTotalPelanggan');
            if (card) card.style.display = 'none';
        }

        let totalTagihanBulanIni = 0;
        let lunasCount = 0;
        let tunggakanCount = 0;
        let belumBayarCount = 0;

        // ✨ TAMBAHKAN VARIABEL INI YANG HILANG
        let totalNominalTunggakan = 0;

        const todayMoment = moment();

        // Looping Semua Tagihan
        tagihanSnapshot.forEach(doc => {
            const t = doc.data();
            const pelangganIdTagihan = t.pelanggan_id;
            const bulanTagihan = t.bulan || "";
            const statusTagihan = t.status || "";
            const jumlah = Number(t.jumlah) || 0;

            // Cek ID Pelanggan
            if (!pelangganIds.includes(pelangganIdTagihan)) return;

            // LOGIKA PERBAIKAN: CEK BULAN LEBIH KETAT
            let isBulanIni = false;

            // Cek Sama Persis
            if (bulanTagihan === bulanSekarangText) {
                isBulanIni = true;
            } else {
                // Cek Format Terbalik (MM-YYYY vs YYYY-MM)
                const parts = bulanTagihan.split('-');
                if (parts.length === 2) {
                    const dbMonth = parts[0];
                    const dbYear = parts[1];
                    if (dbMonth === bulanAngkaSekarang && dbYear === tahunSekarang) {
                        isBulanIni = true;
                    }
                }
            }

            // ✨ HITUNG TUNGGAKAN KHUSUS: JUMLAHKAN SEMUA YANG BELUM LUNAS
            if (statusTagihan === 'belum' || statusTagihan === 'telat') {
                totalNominalTunggakan += jumlah;
            }

            // HANYA PROSES STATISTIK BULAN INI
            if (isBulanIni) {
                totalTagihanBulanIni += jumlah;

                // HITUNG STATUS
                if (statusTagihan === 'lunas') {
                    lunasCount++;
                } else if (statusTagihan === 'telat') {
                    tunggakanCount++;
                } else {
                    belumBayarCount++;
                }
            }
        });

        console.log(`💰 Total Bulan Ini: ${totalTagihanBulanIni}, Lunas: ${lunasCount}, Tunggak: ${tunggakanCount}`);

        // 7. UPDATE UI - TAGIHAN BULAN INI
        const statTagihanEl = document.getElementById('statTagihanBulanan');
        if (statTagihanEl) {
            // Tentukan bulan sekarang dalam format database (MM-YYYY)
            const currentMonthText = moment().format('MM-YYYY');

            // Hitung total tagihan bulan ini yang BELUM LUNAS
            const totalTagihanBulanIniBelum = tagihanSnapshot.docs.reduce((total, doc) => {
                const t = doc.data();
                const bulanTagihan = t.bulan || "";
                const statusTagihan = t.status || "";
                const jumlah = Number(t.jumlah) || 0;

                // Cek: Apakah bulan tagihan sama dengan bulan sekarang DAN status belum bayar?
                if (bulanTagihan === currentMonthText && statusTagihan === 'belum') {
                    return total + jumlah;
                } else {
                    return total;
                }
            }, 0);

            // Tampilkan di UI
            statTagihanEl.textContent = totalTagihanBulanIniBelum > 0 ? formatRupiah(totalTagihanBulanIniBelum) : 'Rp 0';
        }

        // 8. UPDATE UI - LUNAS (FIX: STATUS & COUNT)
        const totalP = pelangganSnapshot.size || 0;
        const persen = totalP > 0 ? Math.round((lunasCount / totalP) * 100) : 0;

        const textPersen = `${persen}%`;
        const textCount = `${lunasCount} dari ${totalP}`;

        // 1. Update Persen (Cari elemen yang mengandung teks atau title 'Lunas')
        const elsLunas = document.querySelectorAll('[class*="stat-lunas"], [id*="statLunas"]');
        elsLunas.forEach(el => el.textContent = textPersen);

        // 2. Update Jumlah (Cari elemen yang mengandung 'Count' atau di sebelah elemen Lunas)
        const elsCount = document.querySelectorAll('.stat-lunas-count, [id*="statLunasCount"], [id*="statCount"]');
        elsCount.forEach(el => el.textContent = textCount);

        // 3. Update Total (Cari elemen yang mengandung 'Total' atau 'Pelanggan' deket card lunas)
        const elsTotal = document.querySelectorAll('.stat-total-pelanggan, [id*="statTotalPelanggan"], [id*="statTotal"]');
        elsTotal.forEach(el => el.textContent = totalP.toString());
        // -----------------------------------------------------------

        // 9. UPDATE UI - TUNGGAKAN (SUDAH DIPERBAIKI OLEH VARIABEL DI ATAS)
        const statTunggakanEl = document.getElementById('statTunggakan');
        if (statTunggakanEl) {
            // Variabel totalNominalTunggakan sekarang sudah terisi dengan benar
            statTunggakanEl.textContent = formatRupiah(totalNominalTunggakan);
        }

            // 10. HITUNG STATUS PELANGGAN
            let aktifCount = 0;
            let nonaktifCount = 0;
            let tunggakCount = 0;

            // Hitung status berdasarkan tagihan, bukan dari field status
            pelangganSnapshot.forEach(pelangganDoc => {
                const pelangganId = pelangganDoc.id;
                const pelangganData = pelangganDoc.data();

                // Cek apakah pelanggan ini punya tagihan belum lunas
                const punyaTunggakan = tagihanSnapshot.docs.some(tagihanDoc =>
                    tagihanDoc.data().pelanggan_id === pelangganId &&
                    (tagihanDoc.data().status === 'belum' || tagihanDoc.data().status === 'telat')
                );

                if (punyaTunggakan) {
                    tunggakCount++;
                } else if (pelangganData.status === 'aktif') {
                    aktifCount++;
                } else {
                    nonaktifCount++;
                }
            });
            // RENDER CHART DENGAN DATA REAL
            console.log("📈 Rendering chart...");
            renderDashboardCharts(aktifCount, nonaktifCount, tunggakCount, tagihanSnapshot);
                        // 11. LOAD AKTIVITAS
            // console.log("📋 Loading aktivitas...");
            // await loadAktivitas();



       // ⭐⭐ CEK JIKA HALAMAN DASHBOARD PUNYA MAP ⭐⭐
const mapContainer = document.getElementById('pelangganMap');
if (mapContainer) {
    // PASTIKAN CONTAINER TAMPIL
    mapContainer.style.display = 'block';
    mapContainer.style.height = '400px';

    // ⭐⭐ JIKA MAP SUDAH ADA SEBELUMNYA, RESTORE ⭐⭐
    if (mapWasInitialized && oldMap) {
        console.log("🔁 Restore map yang sudah ada...");
        window.pelangganMap = oldMap;
        window.isMapInitialized = true;

        // Refresh ukuran dan data
        setTimeout(() => {
            try {
                window.pelangganMap.invalidateSize();
                loadPelangganMap();
            } catch (e) {
                console.log("⚠️ Map corrupt, init ulang");
                initPelangganMap();
                setTimeout(() => loadPelangganMap(), 500);
            }
        }, 300);
    }
    // ⭐⭐ JIKA MAP BELUM PERNAH ADA, BUAT BARU ⭐⭐
    else {
        console.log("🆕 Buat map baru...");
        setTimeout(() => {
            initPelangganMap();
            setTimeout(() => loadPelangganMap(), 500);
        }, 500);
    }
}



        } catch (error) {
            console.error("❌ ERROR FATAL dalam renderDashboard:", error);

            // Set nilai default jika error
            if (document.getElementById('statPelanggan')) document.getElementById('statPelanggan').textContent = '0';
            if (document.getElementById('statTagihanBulanan')) document.getElementById('statTagihanBulanan').textContent = 'Rp 0';
            if (document.getElementById('statLunas')) document.getElementById('statLunas').textContent = '0';
            if (document.getElementById('statTunggakan')) document.getElementById('statTunggakan').textContent = 'Rp 0';

            showToast('error', 'Error Dashboard', 'Gagal memuat data dashboard.');
        }  finally {
                    console.timeEnd("renderDashboard"); // ⭐ TAMBAH INI

    // HAPUS LOADING SEGERA (jangan tunggu semua selesai)
    const loadingEl = document.getElementById('loadingOverlay');
    if (loadingEl) {
        setTimeout(() => {
            loadingEl.classList.add('hidden');
        }, 300); // Loading cuma 300ms

    }}}




// FUNGSI REFRESH STATS ONLY
async function refreshDashboardStats() {
    try {
        console.log("🔄 Refreshing dashboard stats...");

        // CEK APAKAH ELEMENT DASHBOARD MASIH ADA
        const isDashboardPage = document.querySelector('.dashboard-page') !== null;
        if (!isDashboardPage) {
            console.log("⚠️ Bukan halaman dashboard, skip refresh");
            return;
        }

        // WAIT UNTIL ELEMENTS ARE READY
        await waitForElement('#statPelanggan');

        const [pelangganSnapshot, tagihanSnapshot] = await Promise.all([
    db.collection('pelanggan').where('company_id', '==', globalCompanyId).get(), // <--- DITAMBAH FILTER INI
    db.collection('tagihan').where('company_id', '==', globalCompanyId).get()  // <--- DAN INI JUGA
]);

        // Update Total Pelanggan
        const totalPelanggan = pelangganSnapshot.size;
        updateElementText('#statPelanggan', totalPelanggan);

        // Update Tagihan Bulan Ini
        const currentMonthText = moment().format('MM-YYYY'); // Contoh: "01-2025"

let lunasCount = 0;
let tunggakanCount = 0;
let belumBayarCount = 0;

tagihanSnapshot.forEach(doc => {
    const t = doc.data();
    const bulanTagihan = t.bulan || "";
    const jumlah = Number(t.jumlah) || 0;

    // PERBAIKAN LOGIKA PENGECEKAN BULAN
    let isBulanIni = false;
    if (bulanTagihan === currentMonthText) {
        isBulanIni = true;
    } else {
        // Cek format terbalik (misal: 2025-01 vs 01-2025)
        const parts = bulanTagihan.split('-');
        if (parts.length === 2) {
            const dbMonth = parts[0];
            const dbYear = parts[1];
            const currentMonthParts = currentMonthText.split('-');
            if (dbMonth === currentMonthParts[0] && dbYear === currentMonthParts[1]) {
                isBulanIni = true;
            }
        }
    }

    // HANYA PROSES JIKA BULAN INI
    if (isBulanIni) {
        if (t.status === 'lunas') {
            lunasCount++;
        } else if (t.status === 'telat') {
            tunggakanCount++;
        } else {
            belumBayarCount++;
        }
    }
});

        updateElementText('#statTagihanBulanan', formatRupiah(totalTagihanBulanIni));
        updateElementText('#statLunas', lunasCount);
        updateElementText('#statTunggakan', tunggakanCount);

        console.log("✅ Dashboard stats refreshed");

    } catch (error) {
        console.error("❌ Error refreshing dashboard stats:", error);
    }
}

// ⭐⭐ FUNGSI UNTUK UPDATE DARI CACHE ⭐⭐
function updateDashboardFromCache() {
    console.log("⚡ Update UI dari cache...");

    const { pelangganSnapshot, tagihanSnapshot } = dashboardCache.data;

    // UPDATE STATISTIK CEPAT
    if (document.getElementById('statPelanggan')) {
        document.getElementById('statPelanggan').textContent = pelangganSnapshot.size;
    }

    // Hitung cepat untuk tagihan bulan ini
    const currentMonthText = moment().format('MM-YYYY');
    let totalTagihanBulanIni = 0;

    tagihanSnapshot.forEach(doc => {
        const t = doc.data();
        if (t.bulan === currentMonthText && t.status === 'belum') {
            totalTagihanBulanIni += Number(t.jumlah) || 0;
        }
    });

    if (document.getElementById('statTagihanBulanan')) {
        document.getElementById('statTagihanBulanan').textContent =
            totalTagihanBulanIni > 0 ? formatRupiah(totalTagihanBulanIni) : 'Rp 0';
    }

    // Hitung tunggakan cepat
    let totalTunggakan = 0;
    tagihanSnapshot.forEach(doc => {
        const t = doc.data();
        if (t.status === 'belum' || t.status === 'telat') {
            totalTunggakan += Number(t.jumlah) || 0;
        }
    });

    if (document.getElementById('statTunggakan')) {
        document.getElementById('statTunggakan').textContent = formatRupiah(totalTunggakan);
    }

    // Hapus loading jika masih ada
    const loadingEl = document.getElementById('loadingOverlay');
    if (loadingEl) loadingEl.classList.add('hidden');
}

// HELPER FUNCTION: Wait for element
function waitForElement(selector, timeout = 5000) {
    return new Promise((resolve, reject) => {
        const startTime = Date.now();

        function check() {
            const element = document.querySelector(selector);
            if (element) {
                resolve(element);
            } else if (Date.now() - startTime >= timeout) {
                reject(new Error(`Element ${selector} not found after ${timeout}ms`));
            } else {
                setTimeout(check, 100);
            }
        }

        check();
    });
}

// HELPER FUNCTION: Safe update element text
function updateElementText(selector, value) {
    const element = document.querySelector(selector);
    if (element) {
        element.textContent = value;
    } else {
        console.warn(`⚠️ Element ${selector} not found for update`);
    }
}

// ============================================
// RENDER DASHBOARD CHARTS (REAL DATA VERSION - FIXED)
// ============================================

async function renderDashboardCharts(aktifCount, nonaktifCount, tunggakCount, tagihanSnapshot) {
    // ... kode chart kategori pakai tagihanSnapshot ...
    console.log("📊 Rendering dashboard charts...");

    // 1. CHART TAGIHAN
    const ctx1 = document.getElementById('chartTagihan');
    if (ctx1) {
        try {
            // Hancurkan chart lama jika ada
            if (window.tagihanChartInstance) {
                window.tagihanChartInstance.destroy();
                window.tagihanChartInstance = null;
            }

            // AMBIL DATA REAL DARI DATABASE
            const snapshot = tagihanSnapshot; // pakai data yang sudah diambil

            // Siapkan data 6 bulan terakhir
            const last6Months = [];
            const labels = [];

            for (let i = 5; i >= 0; i--) {
                const month = moment().subtract(i, 'months');
                last6Months.push(month.format('YYYY-MM')); // Format: 2025-01
                labels.push(month.format('MMM YY')); // Label: Jan 25
            }

            console.log("Bulan yang ditampilkan:", labels);

            // Hitung total per bulan
            const monthlyData = Array(6).fill(0);

            snapshot.forEach(doc => {
                const t = doc.data();
                const bulanTagihan = t.bulan; // Format: "01-2025" atau "2025-01"

                if (!bulanTagihan) return;

                // Cari index bulan ini di array
                let index = -1;

                // Coba format "MM-YYYY"
                const parts1 = bulanTagihan.split('-');
                if (parts1.length === 2 && parts1[0].length === 2) {
                    const formatted = `${parts1[1]}-${parts1[0]}`; // jadi "2025-01"
                    index = last6Months.indexOf(formatted);
                }

                // Coba format "YYYY-MM"
                if (index === -1) {
                    index = last6Months.indexOf(bulanTagihan);
                }

                // Jika ditemukan, tambahkan ke data
                if (index !== -1) {
                    monthlyData[index] += Number(t.jumlah) || 0;
                }
            });

            console.log("Data bulanan:", monthlyData);

            // Buat chart
            window.tagihanChartInstance = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tagihan (Rp)',
                        data: monthlyData,
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    animation: {
                        duration: 2000,
                        easing: 'easeOutQuart'
                    },
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatRupiah(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            },
                            title: { display: true, text: 'Jumlah Tagihan' }
                        },
                        x: { title: { display: true, text: 'Bulan' } }
                    }
                }
            });

        } catch (error) {
            console.error("❌ Error Chart Tagihan:", error);
            // Fallback data dummy jika error
            if (ctx1) {
                window.tagihanChartInstance = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'],
                        datasets: [{
                            label: 'Tagihan (Rp)',
                            data: [500000, 750000, 600000, 900000, 800000, 950000],
                            borderColor: '#4361ee'
                        }]
                    }
                });
            }
        }
    }


    // 2. CHART KATEGORI TUNGGAKAN (RINGAN, SEDANG, BERAT)
const ctx2 = document.getElementById('chartStatus');
if (ctx2) {
    try {
        if (window.statusChartInstance) {
            window.statusChartInstance.destroy();
            window.statusChartInstance = null;
        }

        // Hitung kategori tunggakan dari data tagihan
        let ringan = 0, sedang = 0, berat = 0;

        tagihanSnapshot.forEach(doc => {
            const t = doc.data();
            if (t.status !== 'lunas' && t.tanggal_jatuh_tempo) {
                const jatuhTempo = moment(t.tanggal_jatuh_tempo, 'DD-MM-YYYY');
                const hariTerlambat = moment().diff(jatuhTempo, 'days');

                if (hariTerlambat <= 0) {
                    // Belum telat, masuk ringan
                    ringan++;
                } else if (hariTerlambat <= 30) {
                    ringan++;
                } else if (hariTerlambat <= 60) {
                    sedang++;
                } else if (hariTerlambat <= 90) {
                    berat++;
                }
            }
        });

        console.log("📊 Data tunggakan:", { ringan, sedang, berat });

        window.statusChartInstance = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Ringan (1-30 hr)', 'Sedang (31-60 hr)', 'Berat (61-90 hr)'],
                datasets: [{
                    data: [ringan || 0.1, sedang || 0.1, berat || 0.1],
                    backgroundColor: ['#fdcb6e', '#e17055', '#d63031', '#c0392b'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.raw} tagihan`;
                            }
                        }
                    }
                }
            }
        });

    } catch (error) {
        console.error("❌ Error Chart Kategori:", error);
    }
}
}




async function updatePelangganStats() {
    try {
        const snapshot = await db.collection('pelanggan')
            .where('company_id', '==', globalCompanyId)
            .get();

        let aktif = 0, tunggak = 0, nonaktif = 0;

        snapshot.forEach(doc => {
            const status = doc.data().status || 'nonaktif';
            if (status === 'aktif') aktif++;
            else if (status === 'tunggak') tunggak++;
            else nonaktif++;
        });

        // Update UI
        if (document.getElementById('pelangganAktifCount')) {
            document.getElementById('pelangganAktifCount').textContent = aktif;
            document.getElementById('pelangganTunggakCount').textContent = tunggak;
            document.getElementById('pelangganNonaktifCount').textContent = nonaktif;
        }

    } catch (error) {
        console.error("Error update pelanggan stats:", error);
    }
}

async function syncStatusPelanggan() {
    try {
        // Ambil semua pelanggan
        const pelangganSnapshot = await db.collection('pelanggan')
            .where('company_id', '==', globalCompanyId)
            .get();

        for (const doc of pelangganSnapshot.docs) {
            const pelangganId = doc.id;

            // Cek apakah pelanggan punya tunggakan
            const tagihanSnapshot = await db.collection('tagihan')
                .where('pelanggan_id', '==', pelangganId)
                .where('status', 'in', ['belum', 'telat'])
                .limit(1)
                .get();

            const statusBaru = tagihanSnapshot.empty ? 'aktif' : 'tunggak';

            // Update status di database
            await db.collection('pelanggan').doc(pelangganId).update({
                status: statusBaru
            });
        }

        console.log('✅ Status pelanggan disinkronkan');
        updatePelangganStats(); // Update UI setelah selesai

    } catch (error) {
        console.error('Error sync status:', error);
    }
}


// FUNGSI BARU: Ambil data tagihan 6 bulan terakhir REAL dari Firebase
async function loadRealTagihanData() {
    console.log("📈 Mengambil data tagihan 6 bulan terakhir REAL...");

    // ⭐ DEFINISI VARIABEL last6Months DI SINI ⭐
    const last6Months = [];
    const displayLabels = [];

    try {
        // 1. Siapkan array 6 bulan terakhir
        for (let i = 5; i >= 0; i--) {
            const m = moment().subtract(i, 'months');
            last6Months.push(m.format('YYYY-MM')); // "2024-12", "2025-01"
            displayLabels.push(m.format('MMM YYYY'));  // "Des 2024", "Jan 2025"
        }

        console.log("Target Bulan:", last6Months);

        // 2. Ambil data tagihan (Pastikan pakai filter company)
        const snapshot = await db.collection('tagihan')
            .where('company_id', '==', globalCompanyId)
            .get();

        if (snapshot.empty) {
            console.log("📭 Tidak ada data tagihan untuk company ini");
            return [];
        }

        // 3. Hitung total per bulan
        const dataChart = last6Months.map(() => 0); // Reset data chart jadi 0 dulu

        snapshot.forEach(doc => {
            const t = doc.data();
            const dbMonth = t.bulan; // Format DB: misal "12-2024" atau "2024-12"

            if (!dbMonth) return;

            // Logika Pencocokan Format Bulan
            let idx = -1;

            // Coba 1: Format Standar (YYYY-MM)
            if (last6Months.includes(dbMonth)) {
                idx = last6Months.indexOf(dbMonth);
            }
            // Coba 2: Format Terbalik (MM-YYYY) -> Ganti jadi (YYYY-MM)
            else if (dbMonth.includes('-')) {
                const parts = dbMonth.split('-');
                if (parts.length === 2) {
                    const flipped = `${parts[1]}-${parts[0]}`; // "2024-12"
                    if (last6Months.includes(flipped)) {
                        idx = last6Months.indexOf(flipped);
                    }
                }
            }

            // Jika ketemu, tambahkan datanya
            if (idx !== -1) {
                dataChart[idx] += Number(t.jumlah) || 0;
            }
        });

        console.log("Data Chart Final:", dataChart);
        return dataChart;

    } catch (error) {
        console.error("❌ Error load real tagihan data:", error);
        // Fallback ke dummy data jika error
        return [
            { bulan: 'Jan 24', total: 5000000 },
            { bulan: 'Feb 24', total: 7500000 },
            { bulan: 'Mar 24', total: 6500000 },
            { bulan: 'Apr 24', total: 8000000 },
            { bulan: 'Mei 24', total: 9000000 },
            { bulan: 'Jun 24', total: 8500000 }
        ];
    }
}

// ============================================
// FUNGSI PAGINATION
// ============================================

function getPaginatedData(data, currentPage) {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    return data.slice(startIndex, endIndex);
}



// TAMBAHKAN fungsi untuk refresh chart saja
function refreshTagihanChart() {
    console.log("🔄 Refreshing tagihan chart...");

    // Hapus chart lama
    if (window.tagihanChart) {
        window.tagihanChart.destroy();
        window.tagihanChart = null;
    }

    // Load data baru dan render
    loadRealTagihanData().then(tagihanData => {
        const ctx1 = document.getElementById('chartTagihan');
        if (ctx1) {
            const labels = tagihanData.map(t => t.bulan);
            const data = tagihanData.map(t => t.total);

            window.tagihanChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tagihan (Rp)',
                        data: data,
                        borderColor: '#4361ee',
                        backgroundColor: 'rgba(67, 97, 238, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatRupiah(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatRupiah(value);
                                }
                            }
                        }
                    }
                }
            });

            console.log("✅ Chart tagihan berhasil direfresh dengan data REAL");
        }
    });
}

// MODIFIKASI fungsi refreshDashboard() untuk include chart refresh
function refreshDashboard() {
    console.log("🔄 Manual refresh dashboard dengan data REAL");

    // Tampilkan loading
    const loadingEl = document.getElementById('loadingOverlay');
    if (loadingEl) loadingEl.classList.remove('hidden');

    // Refresh semua data
    renderDashboard().then(() => {
        // Refresh chart khusus
        setTimeout(() => {
            refreshTagihanChart();
        }, 1000);
    });

    showToast('info', 'Memperbarui', 'Dashboard sedang diperbarui dengan data terbaru...');
}

// FUNGSI REFRESH DASHBOARD (untuk tombol refresh)
function refreshDashboard() {
    window.__mapLoaded = false;

    console.log("🔄 Manual refresh dashboard");
    renderDashboard();
    showToast('info', 'Memperbarui', 'Dashboard sedang diperbarui...');
}


// ============================================
// FUNGSI PETA PELANGGAN
// ============================================

function initPelangganMap() {
    console.log("🗺️ Init pelanggan map (FINAL FIX)");

    const mapContainer = document.getElementById('pelangganMap');
    if (!mapContainer) {
        console.warn("⚠️ #pelangganMap tidak ada");
        return null;
    }

    // 🔥 FIX UTAMA: HANCURKAN MAP LAMA TOTAL
    if (window.pelangganMap) {
        console.warn('♻️ Destroy map lama');

        window.pelangganMap.off();
        window.pelangganMap.remove();
        window.pelangganMap = null;
    }

    // 🔥 FIX LEAFLET: bersihkan flag container
    mapContainer._leaflet_id = null;
    mapContainer.innerHTML = '';

    // Pastikan container valid
    mapContainer.style.display = 'block';
    mapContainer.style.height = '400px';
    mapContainer.style.width = '100%';

    // BUAT MAP BARU
    window.pelangganMap = L.map(mapContainer).setView(
        [-2.5489, 118.0149],
        5
    );

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
    }).addTo(window.pelangganMap);

    setTimeout(() => {
        window.pelangganMap.invalidateSize(true);
    }, 200);

    console.log("✅ Map berhasil dibuat ulang");
    return window.pelangganMap;
}




function bukaDetailTagihanPelanggan(pelangganId) {
    console.log("📍 Klik dari map - pelangganId:", pelangganId);

    // 1. Tampilkan loading
    showToast('info', 'Loading', 'Membuka data tagihan...');

    // 2. Navigasi ke halaman tagihan
    loadPage('tagihan');

    // 3. Tunggu halaman load, lalu filter berdasarkan pelanggan
    setTimeout(() => {
        // Ambil nama pelanggan untuk filter
        db.collection('pelanggan').doc(pelangganId).get().then(pelangganDoc => {
            if (pelangganDoc.exists) {
                const namaPelanggan = pelangganDoc.data().nama;

                // Cari input search
                const searchInput = document.getElementById('searchTagihan');
                if (searchInput) {
                    // Isi dengan nama pelanggan
                    searchInput.value = namaPelanggan;

                    // Trigger search (gunakan fungsi yang sudah ada)
                    if (typeof filterTagihanSearch === 'function') {
                        filterTagihanSearch(namaPelanggan);
                        showToast('success', 'Berhasil', `Menampilkan tagihan ${namaPelanggan}`);
                    }
                }
            }
        });
    }, 2000); // Tunggu 2 detik biar halaman selesai load
}





// Fungsi memuat data pelanggan ke peta
async function loadPelangganMap() {



    console.log("📍 Memuat data pelanggan ke peta...");

    // ⭐⭐ TAMBAHKAN 5 BARIS INI DI AWAL FUNGSI ⭐⭐
    const mapContainer = document.getElementById('pelangganMap');
    if (!mapContainer) {
        console.error("❌ Element #pelangganMap tidak ditemukan");
        return;
    }

    // TAMPILKAN CONTAINER JIKA TERHIDDEN
    if (mapContainer.style.display === 'none') {
        mapContainer.style.display = 'block';
    }

    if (window.pelangganMap) {
    setTimeout(() => {
        window.pelangganMap.invalidateSize(true);
    }, 200);
}




    try {
        // Hapus marker lama
        if (Array.isArray(mapMarkers) && mapMarkers.length > 0) {
            mapMarkers.forEach(marker => marker.remove());
            mapMarkers = [];
        }


        // Ambil data pelanggan dari Firestore
        const snapshot = await db.collection('pelanggan')
            .where('company_id', '==', globalCompanyId)
            .get();

        let markerCount = 0;

        snapshot.forEach(doc => {
            const pelanggan = doc.data();

            // Cek jika ada koordinat
            if (pelanggan.koordinat && pelanggan.koordinat.trim() !== '') {
                try {
                    const coords = pelanggan.koordinat.split(',').map(coord => parseFloat(coord.trim()));

                    if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                        // Tentukan warna berdasarkan status
                        let markerColor = '#6c757d'; // Default: nonaktif (abu)
                        if (pelanggan.status === 'aktif') markerColor = '#4361ee'; // Biru
                        if (pelanggan.status === 'tunggak') markerColor = '#ff6b6b'; // Merah

                        // Buat custom icon
                        const customIcon = L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="
                                background: ${markerColor};
                                width: 24px;
                                height: 24px;
                                border-radius: 50%;
                                border: 3px solid white;
                                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                color: white;
                                font-size: 12px;
                                font-weight: bold;
                            ">${pelanggan.nama ? pelanggan.nama.charAt(0).toUpperCase() : 'P'}</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });

                        // 1. BUAT MARKER
if (!window.pelangganMap) {
    console.error('❌ MAP BELUM ADA, MARKER DIBATALKAN');
    return;
}

const marker = L.marker([coords[0], coords[1]], {
    icon: customIcon,
    draggable: true
}).addTo(window.pelangganMap);


// 2. SIMPAN DATA
marker._pelangganId = doc.id;
marker._originalLatLng = L.latLng(coords[0], coords[1]); // Simpan sebagai LatLng object

// 3. POPUP INFO BIASA
// GANTI ID MENJADI CLASS
marker.bindPopup(`
    <div style="min-width: 250px;">
        <h4 style="margin: 0 0 10px 0; color: #2c3e50;">${pelanggan.nama}</h4>
        <p style="margin: 0 0 5px 0;"><i class="fas fa-map-marker-alt"></i> ${pelanggan.alamat || '-'}</p>
        <p style="margin: 0 0 5px 0;"><i class="fas fa-phone"></i> ${pelanggan.telepon || '-'}</p>
        <p style="margin: 0 0 5px 0;">
            <i class="fas fa-wifi"></i> ${pelanggan.paket || '-'}
            <span style="float: right; background: ${pelanggan.status === 'aktif' ? '#28a745' : pelanggan.status === 'tunggak' ? '#dc3545' : '#6c757d'};
            color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                ${pelanggan.status || 'nonaktif'}
            </span>
        </p>
        <hr style="margin: 10px 0;">
        <button class="btn-bayar-tagihan"
        onclick="bukaDetailTagihanPelanggan('${doc.id}')"
        style="width:100%;padding:8px;background:#4361ee;color:#fff;border:none;border-radius:4px;">
    <i class="fas fa-money-bill-wave"></i> Bayar Tagihan
</button>


    </div>
`);

// EVENT HANDLER YANG BENAR
marker.on('popupopen', function() {
    const currentMarker = this;

    setTimeout(() => {
        const btn = document.querySelector('.btn-bayar-tagihan');
        if (btn) {
            // HAPUS EVENT LAMA
            btn.removeEventListener('click', handleBayarClick);

            // TAMBAH EVENT BARU
            btn.addEventListener('click', async function() {
                const pelangganId = this.getAttribute('data-pelanggan-id');
                const namaPelanggan = this.getAttribute('data-nama');

                // CARI TAGIHAN BELUM LUNAS
                const tagihanSnapshot = await db.collection('tagihan')
                    .where('pelanggan_id', '==', pelangganId)
                    .where('company_id', '==', globalCompanyId)
                    .where('status', 'in', ['belum', 'telat'])
                    .limit(1)
                    .get();

                if (!tagihanSnapshot.empty) {
                    const doc = tagihanSnapshot.docs[0];
                    const tagihan = doc.data();

                    // ISI MODAL BAYAR
                    document.getElementById('tagihanId').value = doc.id;
                    document.getElementById('bayarInvoice').value = tagihan.invoice_number || `INV-${Date.now()}`;
                    document.getElementById('bayarPelanggan').value = namaPelanggan;
                    document.getElementById('bayarJumlah').value = formatRupiah(tagihan.jumlah);
                    document.getElementById('totalBayar').value = tagihan.jumlah;
                    document.getElementById('metodeBayar').value = 'tunai';
                    document.getElementById('tanggalBayar').value = new Date().toISOString().split('T')[0];

                    // BUKA MODAL
                    document.getElementById('modalBayarTagihan').classList.remove('hidden');
                    document.getElementById('modalBayarTagihan').classList.add('show');
                    document.body.style.overflow = 'hidden';

                    // TUTUP POPUP
                    currentMarker.closePopup();
                } else {

                }
            });
        }
    }, 100);
});

// 4. EVENT DRAGEND YANG BENAR
marker.on('dragend', function(e) {
    const marker = e.target;
    const newPos = marker.getLatLng();

    // Buat popup konfirmasi dengan event handler yang benar
    const popupContent = L.DomUtil.create('div', 'confirm-popup');
    popupContent.innerHTML = `
        <div style="padding: 10px;">
            <h4 style="margin: 0 0 10px 0;">Pindah Lokasi?</h4>
            <p>Pindah lokasi ${pelanggan.nama}?</p>
            <p><small>Koordinat baru:<br>${newPos.lat.toFixed(6)}, ${newPos.lng.toFixed(6)}</small></p>
            <div style="display: flex; gap: 5px; margin-top: 10px;">
                <button class="btn-cancel" style="flex:1; padding: 8px; background: #dc3545; color: white; border: none; border-radius: 4px;">
                    Batal
                </button>
                <button class="btn-save" style="flex:1; padding: 8px; background: #28a745; color: white; border: none; border-radius: 4px;">
                    Simpan
                </button>
            </div>
        </div>
    `;

    // Event listener untuk tombol - CARA YANG BENAR
    L.DomEvent.on(popupContent.querySelector('.btn-cancel'), 'click', function() {
        // Kembalikan ke posisi awal
        marker.setLatLng(marker._originalLatLng);
        window.pelangganMap.closePopup();

    });

    // Di dalam event dragend marker, bagian btn-save:
L.DomEvent.on(popupContent.querySelector('.btn-save'), 'click', async function() {
    try {
        // 1. Update di database
        await db.collection('pelanggan').doc(marker._pelangganId).update({
            koordinat: `${newPos.lat}, ${newPos.lng}`,
            updated_at: new Date().toISOString()
        });

        // 2. Update posisi marker
        marker._originalLatLng = newPos;

        // 3. Tutup popup
        window.pelangganMap.closePopup();


        showToast('success', 'Berhasil', 'Koordinat diperbarui');

        // ⭐⭐ LANGSUNG UPDATE DI HALAMAN PELANGGAN (jika sedang aktif) ⭐⭐
        if (currentPage === 'pelanggan') {
            // Panggil fungsi updateRowTable (akan dibuat di STEP 2)
            if (typeof updatePelangganTableRow === 'function') {
                updatePelangganTableRow(marker._pelangganId, `${newPos.lat}, ${newPos.lng}`);
            }
        }

    } catch (error) {
        console.error("Error:", error);
        showToast('error', 'Gagal', error.message);
    }
});

    // Buka popup
    L.popup()
        .setLatLng(newPos)
        .setContent(popupContent)
        .openOn(window.pelangganMap);

});

// 5. SIMPAN KE ARRAY
mapMarkers.push(marker);
markerCount++;

                    }
                } catch (error) {
                    console.warn(`Koordinat invalid: ${pelanggan.koordinat}`, error);
                }
            }
        });

        // Update counter
        const counterElement = document.getElementById('mapMarkerCount');
        if (counterElement) {
            counterElement.textContent = markerCount;
        }

        // Auto zoom ke semua marker jika ada
        if (mapMarkers.length > 0 && window.pelangganMap) {
    const group = new L.featureGroup(mapMarkers);

    // 🔥 FIX FINAL: PAKSA Z-INDEX LEAFLET
setTimeout(() => {
    const mapEl = document.getElementById('pelangganMap');
    if (!mapEl) return;

    mapEl.style.position = 'relative';
    mapEl.style.zIndex = '1';

    const panes = mapEl.querySelectorAll('.leaflet-pane');
    panes.forEach(p => p.style.zIndex = '500');

    const markerPane = mapEl.querySelector('.leaflet-marker-pane');
    if (markerPane) {
        markerPane.style.zIndex = '9999';
    }

    const popupPane = mapEl.querySelector('.leaflet-popup-pane');
    if (popupPane) {
        popupPane.style.zIndex = '10000';
    }
}, 100);

        }



        console.log(`✅ ${markerCount} marker ditambahkan ke peta`);



    } catch (error) {
        console.error("❌ Error memuat peta:", error);
    }
}

function updatePelangganTableRow(pelangganId, newKoordinat) {
    console.log("🔄 updatePelangganTableRow dipanggil:", pelangganId, newKoordinat);

    // 1. Cari tabel pelanggan
    const table = document.getElementById('pelangganTable');
    if (!table) {
        console.warn("⚠️ Tabel pelanggan tidak ditemukan");
        return;
    }

    // 2. Cari semua baris
    const rows = table.getElementsByTagName('tr');
    let found = false;

    for (let row of rows) {
        // Cek jika row punya data-id sama dengan pelangganId
        const rowId = row.getAttribute('data-id');
        if (rowId === pelangganId) {
            console.log("✅ Found row with data-id:", pelangganId);

            // 3. Update kolom koordinat (kolom ke-6, index 5)
            const cells = row.getElementsByTagName('td');
            if (cells.length > 5) {
                // Format tampilan koordinat
                const koordinatDisplay = `
                    <small class="text-muted">${newKoordinat}</small><br>
                    <button class="btn btn-sm btn-outline btn-sm"
                            onclick="openGoogleMaps('${newKoordinat}')"
                            title="Buka di Google Maps">
                        <i class="fas fa-external-link-alt"></i> Maps
                    </button>
                `;
                cells[5].innerHTML = koordinatDisplay;
                console.log("✅ Kolom koordinat di-update");
            }

            found = true;
            break;
        }
    }

    if (!found) {
        console.warn("⚠️ Row dengan data-id", pelangganId, "tidak ditemukan di tabel");
    }
}

// Fungsi batalkan perpindahan
function cancelMoveMarker(pelangganId, originalLat, originalLng) {
    // Cari marker berdasarkan pelangganId
    const marker = mapMarkers.find(m => m._pelangganId === pelangganId);
    if (marker) {
        // Kembalikan ke posisi semula
        marker.setLatLng([originalLat, originalLng]);
        // Tutup popup konfirmasi
        pelangganMap.closePopup();
        showToast('info', 'Dibatalkan', 'Marker dikembalikan ke posisi semula');
    }
}

// Fungsi simpan lokasi baru
async function saveNewLocation(pelangganId, newLat, newLng) {
    try {
        // Update di database
        await db.collection('pelanggan').doc(pelangganId).update({
            koordinat: `${newLat}, ${newLng}`,
            updated_at: new Date().toISOString()
        });

        // Tutup popup
        pelangganMap.closePopup();
        showToast('success', 'Berhasil', 'Lokasi pelanggan diperbarui');

        // Log aktivitas
        await db.collection('aktivitas').add({
            aktivitas: `Update koordinat pelanggan ${pelangganId}`,
            user: getUserLogName(),
            timestamp: new Date().toISOString(),
            company_id: globalCompanyId
        });

    } catch (error) {
        console.error("Error save location:", error);
        showToast('error', 'Gagal', 'Gagal menyimpan lokasi baru');
    }
}

// Fungsi tutup modal drag
function closeDragModal(modalId, marker, oldCoords) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.remove();
        document.body.style.overflow = 'auto';
    }
    // Kembalikan marker ke posisi lama
    if (marker && oldCoords) {
        marker.setLatLng(oldCoords);
    }
}

// Fungsi simpan koordinat
async function savePelangganKoordinat(pelangganId, newKoordinat, pelangganNama, modalId) {
    const modal = document.getElementById(modalId);
    const btn = modal.querySelector('.btn-success');
    const originalText = btn.innerHTML;

    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
    btn.disabled = true;

    try {
        await db.collection('pelanggan').doc(pelangganId).update({
            koordinat: newKoordinat,
            updated_at: new Date().toISOString()
        });

        modal.remove();
        document.body.style.overflow = 'auto';

        showToast('success', 'Berhasil', `Lokasi ${pelangganNama} diperbarui`);

        // Log aktivitas
        await db.collection('aktivitas').add({
            aktivitas: `Update lokasi pelanggan: ${pelangganNama} → ${newKoordinat}`,
            user: 'dovand@gmail.com',
            timestamp: new Date().toISOString(),
            company_id: globalCompanyId
        });

    } catch (error) {
        console.error('❌ Gagal update:', error);
        showToast('error', 'Gagal', 'Tidak bisa menyimpan');

        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function refreshPelangganMap() {
    console.log("🔥 HARD REFRESH MAP");

    const mapEl = document.getElementById('pelangganMap');
    if (!mapEl) return;

    // 🔥 HANCURKAN MAP LAMA TOTAL
    if (window.pelangganMap) {
        try {
            window.pelangganMap.off();
            window.pelangganMap.remove();
        } catch (e) {}
    }

    // 🔥 RESET SEMUA FLAG
    window.pelangganMap = null;
    window.mapMarkers = [];
    window.__mapLoaded = false;
    window.isMapInitialized = false;

    // 🔥 INIT MAP BARU (DOM BARU)
    initPelangganMap();

    setTimeout(() => {
        loadPelangganMap();
        window.pelangganMap.invalidateSize(true);
    }, 200);
}


// Fungsi zoom ke semua marker
function focusOnAllMarkers() {
    if (mapMarkers.length > 0) {
        const group = new L.featureGroup(mapMarkers);
        pelangganMap.fitBounds(group.getBounds().pad(0.05));
    } else {
        showToast('warning', 'Peta', 'Tidak ada marker untuk di-zoom');
    }
}

// Panggil saat dashboard dimuat
async function onDashboardLoaded() {
    // Tunggu sedikit untuk memastikan DOM siap
    setTimeout(() => {
        initPelangganMap();
        loadPelangganMap();
    }, 500);
}
        // ============================================
// FUNGSI TAMBAHAN (FIX TOMBOL & LOKASI)
// ============================================

// 1. Fungsi Get Location (Akurat)
function getLocation() {
    const coordInput = document.getElementById('pelangganKoordinat');

    if (!navigator.geolocation) {
        showToast('error', 'Error', 'GPS tidak didukung.');
        return;
    }

    // Jangan banyak notifikasi saat cari lokasi

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            coordInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            showToast('success', 'Sukses', 'Lokasi ditemukan.');
        },
        (error) => {
    console.warn("GPS Error:", error);

    // ❌ user menolak izin
    if (error.code === 1) {
        console.warn('Izin lokasi ditolak user');
        return;
    }

    // ⏱️ timeout / posisi tidak ditemukan
    if (error.code === 3) {
    console.warn('GPS timeout, coba fallback lokasi');

    // 🔥 fallback: coba ambil lokasi tanpa akurasi tinggi
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            coordInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            showToast('success', 'Lokasi', 'Lokasi perkiraan berhasil diambil');
        },
        (err) => {
            console.warn('Fallback GPS gagal:', err);
        },
        {
            enableHighAccuracy: false,
            timeout: 10000,
            maximumAge: 300000
        }
    );
    return;
}


    // error lain (jarang)
    showToast('error', 'Gagal', 'Tidak bisa mengambil lokasi.');
},

        {
            enableHighAccuracy: false,
            timeout: 15000,      // beri waktu
            maximumAge: 60000    // boleh pakai cache lokasi
        }
    );
}

// ============================================
// EVENT LISTENER GLOBAL (FIX TOMBOL TUTUP)
// ============================================

document.addEventListener('click', function(e) {
    // 1. TANGKAP TOMBOL CLOSE (X) - SAAT INI BERLAKU UNTUK SEMUA MODAL
    if (e.target.classList.contains('modal-close') || e.target.closest('.modal-close')) {
        e.preventDefault();
        e.stopPropagation();

        const modal = e.target.closest('.modal-overlay');
        if (modal) {
            hideModal(modal); // Panggil fungsi universal
        }
        return;
    }

    // 2. TANGKAP KLIK DI LUAR MODAL (BACKGROUND GELAP) - SAAT INI BERLAKU UNTUK SEMUA MODAL
    if (e.target.classList.contains('modal-overlay') && e.target.classList.contains('show')) {
        hideModal(e.target); // Panggil fungsi universal
    }
});

// ============================================
// FUNGSI KLIK PADA CARD STATISTIK (FILTER TABLE)
// ============================================

// 1. TANGKAP EVENT LISTENER UNTUK KARTU
document.addEventListener('click', function(e) {
    // Cek apakah yang diklik adalah elemen di dalam Kartu Statistik
    const card = e.target.closest('.stat-card');

    // Kalau bukan kartu, stop.
    if (!card) return;

    // Cek text label kartu untuk tahu kategori apa
    const labelElement = card.querySelector('.stat-label');
    if (!labelElement) return;

    const label = labelElement.textContent.toLowerCase();
    let filterKategori = '';

    // Tentukan kategori berdasarkan tulisan di kartu
    if (label.includes('ringan')) {
        filterKategori = 'ringan';
    } else if (label.includes('sedang')) {
        filterKategori = 'sedang';
    } else if (label.includes('berat')) {
        filterKategori = 'berat';
    } else if (label.includes('total nominal')) {
        // Kalau klik total nominal, tampilkan semua (Reset Filter)
        filterKategori = 'semua';
    } else {
        return; // Kalau kartu lain (misal dashboard), abaikan
    }

    console.log(`🔍 Memfilter tabel: ${filterKategori}`);

    // Panggil fungsi filter tabel
    filterTunggakanTable(filterKategori);
});


// TANGKAP TOMBOL ESC (Keyboard)
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        // Cari semua modal yang terbuka dan HAPUS SEMUA
        const allModals = document.querySelectorAll('.modal-overlay');
        allModals.forEach(modal => modal.remove());
    }
});

// TAMBAHKAN EVENT LISTENER untuk ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        // Tutup semua modal yang sedang terbuka
        const allModals = document.querySelectorAll('.modal-overlay.show');
        allModals.forEach(modal => {
            hideModal(modal);
        });
    }
});

// TAMBAHKAN EVENT LISTENER untuk klik di luar modal
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-overlay') && e.target.classList.contains('show')) {
        console.log("🌌 Click outside modal, closing:", e.target.id);
        hideModal(e.target.id);
    }
});

// ============================================
// FUNGSI TUTUP MODAL (SMART VERSION)
// ============================================

function forceCloseModal(modalId) {
    // 1. Cari elemen modal berdasarkan ID
    const modalEl = document.getElementById(modalId);

    // 2. Jika tidak ditemukan, berhenti saja (JANGAN ERROR)
    if (!modalEl) {
        console.warn(`⚠️ Modal dengan ID '${modalId}' tidak ditemukan.`);
        return;
    }

    // 3. TUTUP MODAL DENGAN AMAN (HANYA HIDE, BUKAN REMOVE)
    try {
        // Sembunyikan dengan class CSS
        modalEl.classList.remove('show');
        modalEl.classList.add('hidden');

        // Reset style display (opsional, untuk memastikan tidak tampil)
        modalEl.style.display = 'none';

        console.log(`🔒 Modal '${modalId}' ditutup (disembunyikan).`);

    } catch (error) {
        console.error("❌ Gagal menutup modal:", error);
    } finally {
        // 4. Kembalikan scroll halaman agar bisa discroll lagi
        document.body.style.overflow = 'auto';
    }
}


function hideModal(modalId) {
    const modalEl = typeof modalId === 'string'
        ? document.getElementById(modalId)
        : modalId;

    if (!modalEl) return;

    modalEl.classList.remove('show');
    modalEl.classList.add('hidden');

    // 🔥 INI YANG KURANG
    modalEl.style.display = 'none';

    document.body.style.overflow = 'auto';
}



// ==========================================
// FUNGSI TUTUP MODAL DENGAN TOMBOL CLOSE (X)
// ==========================================
// (Opsional) Jika tombol close di dalam modal menggunakan onclick="..."
function closeModalButton(modalId) {
    forceCloseModal(modalId);
}

// ============================================
// FUNGSI showModal() DENGAN AUTO LOAD REMINDER
// ============================================

function showModal(modalId) {
    // 1. Ambil elemen modal
    const modal = document.getElementById(modalId);
    if (!modal) {
        console.error("❌ Modal tidak ditemukan:", modalId);
        return;
    }

    // 2. Kunci scroll body
    document.body.style.overflow = 'hidden';

    // 3. Tampilkan modal
    modal.classList.remove('hidden');
    modal.classList.add('show');
    modal.style.display = 'flex';

    // ⭐⭐⭐ PERBAIKAN: AUTO LOAD DATA UNTUK MODAL REMINDER ⭐⭐⭐
    if (modalId === 'modalReminder') {
        console.log("✅ Modal reminder dibuka, auto load data...");

        // Tampilkan loading
        const container = document.getElementById('reminderPelangganList');
        if (container) {
            container.innerHTML = '<div class="text-center">Memuat...</div>';
        }

        // Load data setelah modal tampil
        setTimeout(() => {
            if (typeof loadPelangganForReminder === 'function') {
                loadPelangganForReminder();
            }
        }, 100);
    }
}



        async function loadAktivitas() {
            logRead('aktivitas');



    try {
        console.log("📋 Loading aktivitas (Limit 10 Halaman)...");

        const table = await waitForElement('#aktivitasTable');
        if (!table) return;

        // 1. AMBIL DATA DARI FIREBASE
        // Kita ambil dulu SEMUA data yang ada, lalu kita urutkan dan potong di script ini.
        const snapshot = await db.collection('aktivitas')
            .orderBy('timestamp', 'desc') // Urutkan terbaru dulu
            .get();

        if (snapshot.empty) {
            table.innerHTML = `<tr><td colspan="3" class="text-center">Tidak ada aktivitas</td></tr>`;
            const paginationContainer = document.getElementById('aktivitasPagination');
            if (paginationContainer) paginationContainer.innerHTML = '';
            return;
        }

        // 2. SIMPAN KE ARRAY SEMENTARA & URUTKAN
        let allData = [];
        snapshot.forEach(doc => {
            const act = doc.data();
            allData.push(act);
        });

        // 3. POTONG DATA MAKSIMAL 100 BARIS (LOGIKA SLIDING WINDOW)
        // Kita hanya simpan 100 data terakhir. Sisanya dibuang.
        const maxDataLimit = 50;
        if (allData.length > maxDataLimit) {
            console.warn(`⚠️ Data melebihi limit (${allData.length}), memotong menjadi ${maxDataLimit} data terbaru.`);
            allData = allData.slice(0, maxDataLimit); // Ambil 100 pertama (yang terbaru)
        }

        // 4. SIMPAN KE VARIABLE GLOBAL AGAR TIDAK PERLU QUERY ULANG SAAT GANTI HALAMAN
        window.allAktivitasData = allData;
        window.totalAktivitasDataCount = allData.length; // Simpan jumlah asli untuk perhitungan pagination
        window.currentHalamanAktivitas = window.currentHalamanAktivitas || 1;

        // 5. LAKUKAN PAGINATION
        // Jika halaman saat ini melebihi halaman maksimal baru (misal user sedang di hal 12, tapi data dipotong jadi max hal 10), kembalikan ke hal 1.
        const totalPages = Math.ceil(window.totalAktivitasDataCount / itemsPerPage);
        if (window.currentHalamanAktivitas > totalPages) {
            window.currentHalamanAktivitas = 1;
        }

        // 6. POTONG DATA UNTUK HALAMAN YANG DITAMPILKAN
        const startIndex = (window.currentHalamanAktivitas - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = window.allAktivitasData.slice(startIndex, endIndex);

        // 7. RENDER TABEL
        let html = '';
        pageData.forEach(act => {
            // Format waktu
            let timeDisplay = '';
            if (act.timestamp) {
                const m = moment(act.timestamp);
                timeDisplay = m.isValid() ? m.format('DD/MM HH:mm') : act.timestamp;
            }

            html += `
                <tr>
                    <td>${timeDisplay}</td>
                    <td>${act.aktivitas}</td>
                    <td>${act.user || 'System'}</td>
                </tr>
            `;
        });

        table.innerHTML = html;

        // 8. RENDER PAGINATION
        renderPagination(window.totalAktivitasDataCount, window.currentHalamanAktivitas, 'aktivitas', 'aktivitasPagination');

        console.log(`✅ Aktivitas dimuat: ${window.totalAktivitasDataCount} total data, menampilkan hal ${window.currentHalamanAktivitas}`);

    } catch (error) {
        console.error("❌ Error load aktivitas:", error);
        const table = document.getElementById('aktivitasTable');
        if (table) {
            table.innerHTML = `<tr><td colspan="3" class="text-center text-danger">Error: ${error.message}</td></tr>`;
        }
    }
}

        function renderCharts() {
            // Chart 1: Tagihan 6 Bulan
            const ctx1 = document.getElementById('chartTagihan')?.getContext('2d');
            if (ctx1) {
                if (window.tagihanChart) {
                    window.tagihanChart.destroy();
                }

                window.tagihanChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: moment.monthsShort(),
                        datasets: [{
                            label: 'Tagihan (Rp)',
                            data: [5000000, 7500000, 6500000, 8000000, 9000000, 8500000, 9500000, 10000000, 11000000, 10500000, 12000000, 11500000],
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatRupiah(value);
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Chart 2: Status Pelanggan
            const ctx2 = document.getElementById('chartStatus')?.getContext('2d');
            if (ctx2) {
                if (window.statusChart) {
                    window.statusChart.destroy();
                }

                window.statusChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: ['Aktif', 'Tunggak', 'Nonaktif'],
                        datasets: [{
                            data: [70, 15, 15],
                            backgroundColor: ['#00b894', '#ff6b6b', '#fdcb6e']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

   async function loadPelangganData(serverFilter = '') {
    logRead('pelanggan');
    console.log('🚀 loadPelangganData DIPANGGIL dengan serverFilter:', serverFilter);
    console.log('📍 1. Masuk fungsi loadPelangganData');

    let useCacheOnly = false;


    // ===== CEK CACHE GLOBAL =====
if (!useCacheOnly) {
    const cached = CACHE.get('pelangganData', PELANGGAN_CACHE_TTL);
    if (cached) {
        console.log('⚡ Pakai cache pelanggan (0 READ)');
        window.pelangganData = cached;
        useCacheOnly = true;
    }
}
// ===== END CEK CACHE =====



    // ⭐⭐ GUARD: Cegah double execution
    if (window._loadingPelanggan) {
        console.log('⏸️ loadPelangganData sedang berjalan, skip...');
        return;
    }
    window._loadingPelanggan = true;

    const table = document.getElementById('pelangganTable');
    if (!table) {
        console.warn("⚠️ Tabel pelanggan tidak ditemukan!");
        window._loadingPelanggan = false;
        return;
    }

    // Tampilkan Loading
    table.innerHTML = `<tr><td colspan="9" class="text-center"><div class="spinner" style="width:30px;height:30px;margin:0 auto;"></div> Memuat Data...</td></tr>`;

    try {
        console.log('📍 2. Masuk try block'); // ⭐ TAMBAHAN INI


        // ===============================
        // 🔥 CACHE GUARD (DI SINI)
        // ===============================
        if (useCacheOnly === true) {
            console.log('🚫 Skip Firestore query (pakai cache)');
            // LEWATI QUERY, LANJUT KE PROSES DI BAWAH
        }

        // 1. AMBIL DATA DARI FIREBASE
        let snapshot = null;
        if (!useCacheOnly) {
        snapshot = await db.collection('pelanggan')
        .where('company_id', '==', globalCompanyId)
        .get();
        }

        if (!useCacheOnly && snapshot && snapshot.empty) {

            table.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center" style="padding: 40px;">
                        <i class="fas fa-inbox" style="font-size: 48px; color: #e9ecef;"></i>
                        <h4 style="margin-top:15px; color: var(--gray);">Database Kosong</h4>
                        <p>Belum ada data pelanggan untuk perusahaan Anda.</p>
                        <button class="btn btn-primary mt-2" onclick="showAddPelangganModal()">
                            <i class="fas fa-plus"></i> Tambah Pelanggan Pertama
                        </button>
                    </td>
                </tr>`;
            window.pelangganData = pelangganData;
            window.filteredPelangganData = [...pelangganData]; // 🔥 WAJIB
            renderPelangganTable(window.filteredPelangganData);


        }

        // 2. SIMPAN DATA KE ARRAY GLOBAL (PENTING!)
        if (!useCacheOnly && snapshot) {
        window.pelangganData = snapshot.docs.map(doc => ({

            id: doc.id,
            server: doc.data().server || '',
            nama: doc.data().nama || 'Tidak ada nama',
            telepon: doc.data().telepon || '-',
            alamat: doc.data().alamat || '-',
            lokasi: doc.data().lokasi || '-',
            paket: doc.data().paket || '-',
            harga: doc.data().harga || 0,
            status: doc.data().status || 'nonaktif',
            email: doc.data().email || '',
            tanggal_pasang: doc.data().tanggal_pasang || '',
            koordinat: doc.data().koordinat || '',
            catatan: doc.data().catatan || '',
            company_id: doc.data().company_id || 'TIDAK ADA',
            created_at: doc.data().created_at || null

        }));
    }

        // ===============================
        // 🔥 URUTKAN: DATA TERBARU DI ATAS
        // ===============================
        // PASTIKAN window.pelangganData ADA SEBELUM DISORT
        // PASTIKAN window.pelangganData ADA SEBELUM DISORT
        if (!window.pelangganData || !Array.isArray(window.pelangganData)) {
            window.pelangganData = [];
        }

        window.pelangganData.sort((a, b) => {
            const timeA = a.created_at?.toDate ? a.created_at.toDate().getTime() : new Date(a.created_at || 0).getTime();
            const timeB = b.created_at?.toDate ? b.created_at.toDate().getTime() : new Date(b.created_at || 0).getTime();
            return timeB - timeA;
        });



        console.log(`📊 Data pelanggan diambil: ${window.pelangganData.length} record.`);

            // ===============================
            // 💾 SIMPAN KE CACHE GLOBAL
            // ===============================
            CACHE.set('pelangganData', window.pelangganData);
            console.log('💾 Cache pelanggan disimpan:', window.pelangganData.length);


        // 3. AMBIL NILAI FILTER DARI UI
        const statusFilter = document.getElementById('filterStatus')?.value || '';
        const paketFilter = document.getElementById('filterPaket')?.value || '';
        const searchFilter = document.getElementById('searchPelanggan')?.value || '';

        let filteredData = [...(window.pelangganData || [])];

        // LOGIKA PENCARIAN & FILTER
        if (statusFilter) {
            filteredData = filteredData.filter(p => p.status === statusFilter);
        }

        if (paketFilter) {
            filteredData = filteredData.filter(p => p.paket === paketFilter);
        }

        if (searchFilter) {
            const keyword = searchFilter.toLowerCase().trim();
            filteredData = filteredData.filter(p =>
                (p.nama && p.nama.toLowerCase().includes(keyword)) ||
                (p.telepon && p.telepon.includes(keyword)) ||
                (p.alamat && p.alamat.toLowerCase().includes(keyword)) ||
                (p.email && p.email.toLowerCase().includes(keyword))
            );
        }

        // FILTER BY SERVER (BARU!)
        const uiServerFilter = document.getElementById('filterServer')?.value || '';

        const activeServerFilter = serverFilter && serverFilter.trim() !== ''
            ? serverFilter
            : uiServerFilter;

        if (activeServerFilter && activeServerFilter.trim() !== '') {
            console.log('🔍 [INTERNAL] Filter server aktif:', activeServerFilter);
            console.log('   Data sebelum filter:', filteredData.length);

            filteredData = filteredData.filter(p =>
                p.server && p.server === activeServerFilter
            );

            console.log('   Data setelah filter:', filteredData.length);
        }

        // ⭐⭐ PERBAIKAN KRUSIAL: UPDATE GLOBAL VARIABLE AGAR TIDAK HILANG ⭐⭐
        window.filteredPelangganData = filteredData;

        // 5. PAGINATION
        const itemsPerPage = 10;
        const totalData = filteredData.length;
        const totalPages = Math.ceil(totalData / itemsPerPage);

        if (currentPagePelanggan > totalPages) currentPagePelanggan = 1;

        const startIndex = (currentPagePelanggan - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = filteredData.slice(startIndex, endIndex);

        // 6. RENDER TABEL
        if (filteredData.length === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center" style="padding: 40px;">
                        <i class="fas fa-search" style="font-size: 48px; color: #e9ecef;"></i>
                        <h4 style="margin-top:15px; color: var(--gray);">Tidak Ditemukan</h4>
                        <p>Tidak ada pelanggan yang cocok dengan filter.</p>
                    </td>
                </tr>`;

            // HAPUS PAGINATION
            const paginationContainer = document.getElementById('pelangganPagination');
            if (paginationContainer) paginationContainer.innerHTML = '';

            window._loadingPelanggan = false;
            return;
        }

        // RENDER DATA LANGSUNG
        table.innerHTML = pageData.map((p, index) => {
            const startIndex = ((currentPagePelanggan - 1) * itemsPerPage);

            return `
                <tr data-id="${p.id}">
                    <td>${startIndex + index + 1}</td>
                    <td>${p.server || ''}</td>
                    <td>${p.nama || '-'}</td>
                    <td>${p.telepon || '-'}</td>
                    <td>${p.alamat || '-'}</td>
                     <td>
                ${p.koordinat ?
                    `<small class="text-muted">${p.koordinat}</small><br>
                     <button class="btn btn-sm btn-outline btn-sm"
                             onclick="openGoogleMaps('${p.koordinat}')"
                             title="Buka di Google Maps">
                         <i class="fas fa-external-link-alt"></i> Maps
                     </button>`
                : '-'
            }
</td>

                    <td>${p.paket || '-'}</td>
                    <td><span class="badge ${p.status === 'aktif' ? 'badge-success' : p.status === 'tunggak' ? 'badge-danger' : 'badge-warning'}">${p.status || 'nonaktif'}</span></td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline" onclick="editPelanggan('${p.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="viewPelanggan('${p.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deletePelanggan('${p.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
        `}).join('');

        // 1. UPDATE DROPDOWN SERVER DENGAN DATA REAL
        const serverSelect = document.getElementById('filterServer');
        if (serverSelect) {

            // 🔒 SIMPAN PILIHAN USER SEBELUM DROPDOWN DIRESET
            const selectedValue = serverSelect.value;

            const uniqueServers = [...new Set(
                (window.pelangganData || [])
                    .map(p => p.server)
                    .filter(s => s && s.trim() !== '')
            )];

            // RESET DROPDOWN
            serverSelect.innerHTML = '';

            // OPTION DEFAULT
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Semua Server';
            serverSelect.appendChild(defaultOption);

            // OPTION SERVER
            uniqueServers.forEach(server => {
                const option = document.createElement('option');
                option.value = server;
                option.textContent = server;
                serverSelect.appendChild(option);
            });

            // OPTION TAMBAH SERVER
            const addOption = document.createElement('option');
            addOption.value = '+tambah';
            addOption.textContent = '+ Tambah Server Baru';
            addOption.style.color = '#4361ee';
            addOption.style.fontWeight = 'bold';
            serverSelect.appendChild(addOption);

            // 🔥 KEMBALIKAN SESUAI PILIHAN USER (TERMASUKAN SEMUA SERVER)
            if (selectedValue === '' || uniqueServers.includes(selectedValue) || selectedValue === '+tambah') {
                serverSelect.value = selectedValue;
            } else {
                serverSelect.value = '';
            }
        }

        // RENDER PAGINATION (SAMA KAYAK PELANGGAN)
        const paginationContainer = document.getElementById('pelangganPagination');
        if (paginationContainer) {
            paginationContainer.innerHTML = '';

            const dataForPagination = window.filteredPelangganData || filteredData || [];

            console.log('🧹 Pagination cleared');
            console.log('📊 dataForPagination length:', dataForPagination.length);

            if (dataForPagination.length > 0) {
                const totalPages = Math.ceil(dataForPagination.length / itemsPerPage);

                console.log('📐 totalPages:', totalPages);
                console.log('🔘 Tombol akan dirender?', totalPages > 1 ? 'YA' : 'TIDAK');

                // ⭐⭐ JANGAN RENDER JIKA CUMA 1 HALAMAN ⭐⭐
                if (totalPages >= 1) {
                    let paginationHTML = '<div class="pagination">';

                    // TOMBOL KIRI (<)
                    if (currentPagePelanggan > 1) {
                        paginationHTML += `<a class="page-link" onclick="changePage('pelanggan', ${currentPagePelanggan - 1})">&laquo;</a>`;
                    }

                    // ANGKA HALAMAN
                    for (let i = 1; i <= totalPages; i++) {
                        if (i === currentPagePelanggan) {
                            paginationHTML += `<span class="page-link active">${i}</span>`;
                        } else {
                            paginationHTML += `<a class="page-link" onclick="changePage('pelanggan', ${i})">${i}</a>`;
                        }
                    }

                    // TOMBOL KANANAN (>)
                    if (currentPagePelanggan < totalPages) {
                        paginationHTML += `<a class="page-link" onclick="changePage('pelanggan', ${currentPagePelanggan + 1})">&raquo;</a>`;
                    }

                    paginationHTML += '</div>';
                    paginationContainer.innerHTML = paginationHTML;
                }
                // ⭐⭐ JIKA CUMA 1 HALAMAN: biarkan kosong ⭐⭐
            }
        }

        console.log('📍 3. Sampai akhir try block'); // ⭐ TAMBAHAN INI

    } catch (error) {
        console.error("❌ Error Load Pelanggan:", error);
        table.innerHTML = `<tr><td colspan="9" class="text-center text-danger">Error: ${error.message}</td></tr>`;
    } finally {
        // ⭐⭐ RESET GUARD: TAMBAHAN BARU ⭐⭐
        window._loadingPelanggan = false;
    }
}


async function loadServerDropdownToModal() {
    const input = document.getElementById('pelangganServer');
    if (!input) return;

    // JIKA SUDAH ADA SELECT, STOP
    if (document.getElementById('pelangganServerSelect')) return;

    const currentValue = input.value || '';

    // 🔒 INPUT ASLI JANGAN DIHAPUS
    input.type = 'hidden';

    const snap = await db.collection('servers')
        .where('company_id', '==', globalCompanyId)
        .get();

    const servers = snap.docs.map(d => d.data().nama);

    const select = document.createElement('select');
    select.id = 'pelangganServerSelect';
    select.className = input.className;
    select.style.width = '100%';

    const optDefault = document.createElement('option');
    optDefault.value = '';
    optDefault.textContent = '-- Pilih Server --';
    select.appendChild(optDefault);

    servers.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        if (s === currentValue) opt.selected = true;
        select.appendChild(opt);
    });

    // 🔁 SYNC SELECT → INPUT ASLI
    select.addEventListener('change', () => {
        input.value = select.value;
    });

    // PASTIKAN INPUT TERISI SAAT EDIT
    input.value = currentValue;

    input.parentNode.appendChild(select);

    setTimeout(loadServerDropdownToModal, 0);

}





// TAMBAHKAN FUNGSI UNTUK MENYIMPAN FILTER SAAT USER MENGUBAH INPUT
function saveFilterState() {
    const statusVal = document.getElementById('filterStatus')?.value || '';
    const paketVal = document.getElementById('filterPaket')?.value || '';

    if (statusVal) localStorage.setItem('last_filter_status', statusVal);
    else localStorage.removeItem('last_filter_status');

    if (paketVal) localStorage.setItem('last_filter_paket', paketVal);
    else localStorage.removeItem('last_filter_paket');
}

// ============================================
// FUNGSI UNTUK LOAD SEMUA DATA SEKALI SAJA
// ============================================
async function loadAllDataOnce() {
    try {
        console.log("📊 Loading all data...");

        // Load data dasar
        await loadPelangganData();
        await loadPaketData();
        await loadTagihanData();

        // ⭐⭐⭐ PERBAIKAN: TAMBAHKAN LOAD PROFIL PERUSAHAAN ⭐⭐⭐
        await loadCompanyProfile();

        console.log("✅ All data loaded successfully");
    } catch (error) {
        console.error("❌ Error loading all data:", error);
    }
}

// ============================================
// FUNGSI UNTUK AMBIL DATA DARI CACHE
// ============================================
function getCachedData() {
    const cached = localStorage.getItem('xbill_cache');
    if (!cached) return null;

    try {
        const data = JSON.parse(cached);

        // VALIDASI 1: CACHE UNTUK COMPANY YANG SAMA
        if (data.company_id !== globalCompanyId) {
            localStorage.removeItem('xbill_cache');
            return null;
        }

        // VALIDASI 2: CACHE MAX 1 JAM
        const oneHour = 60 * 60 * 1000;
        if (Date.now() - data.timestamp > oneHour) {
            localStorage.removeItem('xbill_cache');
            return null;
        }

        return data;

    } catch (e) {
        localStorage.removeItem('xbill_cache');
        return null;
    }
}

// FUNGSI BARU: LOAD PAKET KE DROPDOWN FILTER
// FUNGSI BARU: LOAD PAKET KE DROPDOWN FILTER
async function loadPaketSelectOptions() {
    try {
        const select = document.getElementById('pelangganPaket');
        const hargaInput = document.getElementById('pelangganHarga');

        if (!select) {
            console.warn("⚠️ Elemen #pelangganPaket tidak ditemukan");
            return;
        }

        // Simpan nilai yang sedang dipilih user (supaya tidak hilang saat refresh)
        const currentSelected = select.value;

        // 1. AMBIL DATA PAKET DARI DATABASE
        const snapshot = await db.collection('paket')
            .where('company_id', '==', globalCompanyId)
            .where('status', '==', 'aktif')
            .get();

        // 2. ISI DROPDOWN
        select.innerHTML = '<option value="">-- Pilih Paket --</option>';

        if (snapshot.empty) {
            console.warn("⚠️ Belum ada data paket aktif");
            if(hargaInput) {
                hargaInput.value = '';
                hargaInput.readOnly = false; // Boleh isi manual jika kosong
            }
            return;
        }

        // Simpan data paket ke memory sementara (cache) untuk cari harga nanti
        const paketCache = {};

        snapshot.forEach(doc => {
            const p = doc.data();
            // Buat option
            const option = document.createElement('option');
            option.value = p.nama;
            option.textContent = `${p.nama} `; // Tampilkan harga di tooltip dropdown

            // Simpan harga di atribut data-harga agar mudah diambil
            option.setAttribute('data-harga', p.harga);

            select.appendChild(option);

            // Simpan ke cache object
            paketCache[p.nama] = p.harga;
        });

        // 3. KEMBALIKAN PILIHAN USER SEBELUMNYA (JIKA ADA)
        if (currentSelected) {
            select.value = currentSelected;
            // Jika user sedang edit, otomatis isi harganya
            if (currentSelected && paketCache[currentSelected]) {
                hargaInput.value = paketCache[currentSelected];
                hargaInput.readOnly = true; // 🔒 KUNCI (READ ONLY)
            }
        }

        // 4. EVENT LISTENER: KETIKA DROPDOWN DIKLIK/DIGANTI
        // Hanya pasang listener sekali (jangan pasang berulang kali)
        if (!select.hasPaketListener) {
            select.addEventListener('change', function() {
                const namaPaketDipilih = this.value;
                const optionDipilih = this.options[this.selectedIndex];

                if (namaPaketDipilih) {
                    // Ambil harga dari atribut 'data-harga' pada option
                    const harga = optionDipilih.getAttribute('data-harga');

                    if (harga) {
                        hargaInput.value = harga;
                        hargaInput.readOnly = true; // 🔒 KUNCI INPUT HARGA
                        console.log(`💰 Harga otomatis terisi: ${harga}`);
                    }
                } else {
                    // Jika user pilih "-- Pilih Paket --"
                    hargaInput.value = '';
                    hargaInput.readOnly = false; // Buka kunci jika kosong
                }
            });

            select.hasPaketListener = true; // Tandai sudah ada listener
        }

    } catch (error) {
        console.error("❌ Error load paket select options:", error);
    }
}

// FUNGSI RESET FILTER
function resetFilters() {
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterPaket').value = '';
    document.getElementById('searchPelanggan').value = '';
    loadPelangganData();
}

function renderPelangganTable(data, totalItems) {
    const table = document.getElementById('pelangganTable');
    if (!table) return;

    if (!data || data.length === 0) {
        // Tampilan jika data kosong TANPA tombol reset
        table.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted" style="padding: 40px;">
                    <i class="fas fa-search" style="font-size: 48px; color: #e9ecef; margin-bottom: 15px;"></i>
                    <h4 style="color: var(--gray);">Tidak ada data</h4>
                    <p>Tidak ada pelanggan yang sesuai dengan filter yang dipilih.</p>
                </td>
            </tr>`;

        // Reset pagination jika kosong
        const paginationContainer = document.getElementById('pelangganPagination');
        console.log('🔍 Cari pagination container:', paginationContainer ? 'DITEMUKAN' : 'TIDAK DITEMUKAN');
        if (paginationContainer) paginationContainer.innerHTML = '';

        const elStart = document.getElementById('pelangganStart');
        const elEnd = document.getElementById('pelangganEnd');
        const elTotal = document.getElementById('pelangganTotal');

        if (elStart) elStart.textContent = '0';
        if (elEnd) elEnd.textContent = '0';
        if (elTotal) elTotal.textContent = '0';

        return;
    }

    const startIndex = ((currentPagePelanggan - 1) * itemsPerPage);

    table.innerHTML = data.map((pelanggan, index) => {
        const nama = pelanggan.nama || '-';
        const telepon = pelanggan.telepon || '-';
        const alamat = pelanggan.alamat || '-';
        const paket = pelanggan.paket || '-';
        const harga = pelanggan.harga || 0;
        const status = pelanggan.status || 'nonaktif';
        const isNew = pelanggan.__isNewImport === true;


        let badgeClass = 'badge-warning';
        if (status === 'aktif') badgeClass = 'badge-success';
        if (status === 'tunggak') badgeClass = 'badge-danger';

        return `
            <tr>
                <tr class="${isNew ? 'new-import-row' : ''}">

                <td style="font-weight: bold;">${startIndex + index + 1}</td>
                <td>
                    <strong>${nama}</strong>
                    ${pelanggan.email ? `<br><small class="text-muted">${pelanggan.email}</small>` : ''}
                </td>
                <td>${telepon}</td>
                <td>
                    ${alamat.substring(0, 40)}${alamat.length > 40 ? '...' : ''}
                    ${pelanggan.koordinat ? `<br><small class="text-info"><i class="fas fa-map-marker-alt"></i> ${pelanggan.koordinat}</small>` : ''}
                </td>
                <td>
                    <span class="badge badge-primary">${paket}</span>
                    <br>
                    <small class="text-success">${formatRupiah(harga)}/bln</small>
                </td>
                <td>
                    <span class="badge ${badgeClass}">
                        <i class="fas ${status === 'aktif' ? 'fa-check-circle' : status === 'tunggak' ? 'fa-exclamation-triangle' : 'fa-times-circle'}"></i>
                        ${status.charAt(0).toUpperCase() + status.slice(1)}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" onclick="editPelanggan('${pelanggan.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="viewDetailPelanggan('${pelanggan.id}')" title="Detail">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="deletePelanggan('${pelanggan.id}')" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');

    // UPDATE INFO TOTAL
    const start = ((currentPagePelanggan - 1) * itemsPerPage);
    const end = Math.min(currentPagePelanggan * itemsPerPage, totalItems);

    const elStart = document.getElementById('pelangganStart');
    const elEnd = document.getElementById('pelangganEnd');
    const elTotal = document.getElementById('pelangganTotal');

    if (elStart) elStart.textContent = start + 1;
    if (elEnd) elEnd.textContent = end;
    if (elTotal) elTotal.textContent = totalItems;
}

function renderPelangganPagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const container = document.getElementById('pelangganPagination');

    if (!container || totalPages <= 1) {
        if (container) container.innerHTML = '';
        return;
    }

    let paginationHtml = '<div class="pagination">';

    // Previous button
    if (currentPagePelanggan > 1) {
        paginationHtml += `<a class="page-link" onclick="changePage('pelanggan', ${currentPagePelanggan - 1})">&laquo;</a>`;
    }

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === currentPagePelanggan) {
            paginationHtml += `<a class="page-link active">${i}</a>`;
        } else {
            paginationHtml += `<a class="page-link" onclick="changePage('pelanggan', ${i})">${i}</a>`;
        }
    }

    // Next button
    if (currentPagePelanggan < totalPages) {
        paginationHtml += `<a class="page-link" onclick="changePage('pelanggan', ${currentPagePelanggan + 1})">&raquo;</a>`;
    }

    paginationHtml += '</div>';
    container.innerHTML = paginationHtml;
}



async function deletePelanggan(id) {
    if (localStorage.getItem('userRole') !== 'admin') {
        showToast('error', 'Akses Ditolak', 'HANYA ADMIN!');
        return;
    }

    // ⭐ GANTI BROWSER BAWAAN JADI CUSTOM POP UP ⭐
    confirmDialog('HAPUS?', async () => {
        try {
            showLoading();

            // 1. HAPUS DARI DATABASE
await db.collection('pelanggan').doc(id).delete();

// 🔥 RESET CACHE
window._pelangganCache = null;
window._pelangganCacheTime = 0;

// 🔥 PANGGIL LOAD ULANG (INI AKAN MENGISI pelangganData DARI DATABASE)
await loadPelangganData();

showToast('success', 'Berhasil', 'Data terhapus');
hideLoading();

        } catch (error) {
            console.error("Error delete pelanggan:", error);
            showToast('error', 'Gagal', 'Gagal menghapus: ' + error.message);
            hideLoading();
        }
    });
}

function applyPelangganFilters(data) {
    const statusFilter = document.getElementById('filterStatus')?.value || '';
    const paketFilter = document.getElementById('filterPaket')?.value || '';
    const searchFilter = document.getElementById('searchPelanggan')?.value || '';

    return data.filter(pelanggan => {
        // Filter status
        if (statusFilter && pelanggan.status !== statusFilter) return false;

        // Filter paket
        if (paketFilter && pelanggan.paket !== paketFilter) return false;

        // Filter search
        if (searchFilter) {
            const searchLower = searchFilter.toLowerCase();
            return (
                (pelanggan.nama && pelanggan.nama.toLowerCase().includes(searchLower)) ||
                (pelanggan.telepon && pelanggan.telepon.includes(searchFilter)) ||
                (pelanggan.alamat && pelanggan.alamat.toLowerCase().includes(searchLower))
            );
        }

        return true;
    });
}






// TAMBAHKAN FUNGSI VIEW DETAIL (Opsional, untuk tombol detail)
async function viewPelanggan(id) {
    try {
        const doc = await db.collection('pelanggan').doc(id).get();
        if (!doc.exists) {
            showToast('error', 'Error', 'Data pelanggan tidak ditemukan');
            return;
        }

        const data = doc.data();
        let detailHtml = `
            <div style="padding: 20px;">
                <h4>Detail Pelanggan</h4>
                <table class="table" style="background: #f8f9fa; border-radius: 8px;">
                    <tr><td><strong>Nama</strong></td><td>${data.nama || '-'}</td></tr>
                    <tr><td><strong>Telepon</strong></td><td>${data.telepon || '-'}</td></tr>
                    <tr><td><strong>Email</strong></td><td>${data.email || '-'}</td></tr>
                    <tr><td><strong>Alamat</strong></td><td>${data.alamat || '-'}</td></tr>
                    <tr><td><strong>Paket</strong></td><td>${data.paket || '-'} (${formatRupiah(data.harga || 0)})</td></tr>
                    <tr><td><strong>Status</strong></td><td>${data.status || '-'}</td></tr>
                    <tr><td><strong>Tanggal Pasang</strong></td><td>${data.tanggal_pasang || '-'}</td></tr>
                    <tr><td><strong>Koordinat</strong></td><td>${data.koordinat || '-'}</td></tr>
                    <tr><td><strong>Catatan</strong></td><td>${data.catatan || '-'}</td></tr>
                </table>
            </div>
        `;

        // Buat modal detail sederhana
        const modal = document.createElement('div');
        modal.className = 'modal-overlay show';
        modal.innerHTML = `
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-user"></i> Detail Pelanggan</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    ${detailHtml}
                </div>
                <div class="modal-footer">

                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                        Tutup
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

    } catch (error) {
        console.error("Error viewing detail:", error);
        showToast('error', 'Error', 'Gagal memuat detail pelanggan');
    }
}



        // PERBAIKI loadPaketData():
async function loadPaketData() {
    try {
        console.log("🔄 loadPaketData() dipanggil");

        const table = document.getElementById('paketTable');
        if (!table) {
            console.error("❌ Tabel paket tidak ditemukan!");
            return;
        }

        // Loading state
        table.innerHTML = `<tr><td colspan="6" class="text-center"><div class="spinner"></div> Memuat data...</td></tr>`;

        // Pastikan company_id ada
        if (!globalCompanyId) {
            console.error("❌ globalCompanyId kosong!");
            table.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Company ID tidak ditemukan</td></tr>`;
            return;
        }

        // ===== TAMBAH 3 BARIS INI =====
        const cachedPaket = CACHE.get('paketData', 3600000);
        if (cachedPaket) {
            return renderPaketTable(cachedPaket);
        }
        // ===== SELESAI =====

        // Ambil data
        const snapshot = await db.collection('paket')
            .where('company_id', '==', globalCompanyId)
            .get();

            // ===== TAMBAH 1 BARIS INI =====
            CACHE.set('paketData', snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            // ===== SELESAI =====


        console.log(`📊 ${snapshot.size} paket ditemukan`);

        if (snapshot.empty) {
            table.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="fas fa-wifi-slash"></i>
                        <p>Belum ada data paket</p>
                        <button class="btn btn-sm btn-primary mt-2" onclick="showAddPaketModal()">
                            <i class="fas fa-plus"></i> Tambah Paket Pertama
                        </button>
                    </td>
                </tr>
            `;
            return;
        }

        // Render langsung di sini (tanpa renderPaketTable)
        let html = '';
        let counter = 1;

        snapshot.forEach((doc) => {
            const p = doc.data();

            // ⭐⭐ PERBAIKAN: TAMBAHKAN SATUAN (Mbps) ⭐⭐
            const kecepatan = p.kecepatan || '-';
            const kecepatanDenganSatuan = kecepatan.includes('Mbps') ? kecepatan : kecepatan + ' Mbps';

            html += `
                <tr>
                    <td><strong>${p.nama || '-'}</strong></td>
                    <td>${kecepatanDenganSatuan}</td> <!-- ⭐⭐ INI YANG DIPERBAIKI ⭐⭐ -->
                    <td>${formatRupiah(p.harga || 0)}</td>
                    <td>${p.kuota || 'Unlimited'}</td>
                    <td>
                        <span class="badge ${p.status === 'aktif' ? 'badge-success' : 'badge-warning'}">
                            ${p.status === 'aktif' ? 'Aktif' : 'Nonaktif'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline" onclick="editPaket('${doc.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="deletePaket('${doc.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;

            counter++;
        });

        table.innerHTML = html;
        console.log("✅ Tabel paket berhasil diisi");

    } catch (error) {
        console.error("❌ Error loadPaketData:", error);
        showToast('error', 'Gagal', 'Gagal memuat data paket');

        const table = document.getElementById('paketTable');
        if (table) {
            table.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${error.message}</td></tr>`;
        }
    }
}

function renderPaketTable(data) {
    const table = document.getElementById('paketTable');
    if (!table) return;

    if (data.length === 0) {
        table.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada data</td></tr>';
        return;
    }

    table.innerHTML = data.map((paket, index) => {
        const startIndex = ((currentPagePaket - 1) * itemsPerPage);
        return `
            <tr>
                <td><strong>${paket.nama}</strong><br><small>${paket.deskripsi || ''}</small></td>
                <td>${paket.kecepatan}</td>
                <td>${formatRupiah(paket.harga)}</td>
                <td>${paket.kuota || 'Unlimited'}</td>
                <td>
                    <span class="badge ${paket.status === 'aktif' ? 'badge-success' : 'badge-warning'}">
                        ${paket.status === 'aktif' ? 'Aktif' : 'Nonaktif'}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline" onclick="editPaket('${paket.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="deletePaket('${paket.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}





function applyTagihanFilters(data) {
    const bulanFilter = document.getElementById('filterBulan')?.value || '';
    const statusFilter = document.getElementById('filterStatusTagihan')?.value || '';
    const searchFilter = document.getElementById('searchTagihan')?.value || '';

    return data.filter(tagihan => {
        // Filter bulan
        if (bulanFilter && tagihan.bulan !== bulanFilter) return false;

        // Filter status
        if (statusFilter && tagihan.status !== statusFilter) return false;

        // Filter search
        if (searchFilter) {
            const searchLower = searchFilter.toLowerCase();
            return (
                (tagihan.pelanggan_nama && tagihan.pelanggan_nama.toLowerCase().includes(searchLower)) ||
                (tagihan.id && tagihan.id.toLowerCase().includes(searchLower)) ||
                (tagihan.bulan && tagihan.bulan.includes(searchFilter))
            );
        }

        return true;
    });
}

function renderTagihanTable(data) {
    const table = document.getElementById('tagihanTable');
    if (!table) return;

    if (data.length === 0) {
        table.innerHTML = `<tr><td colspan="8" class="text-center">Tidak ada data</td></tr>`;
        return;
    }

    // KELOMPOKKAN DATA
    const grouped = {};

    data.forEach(item => {
        const key = item.pelanggan_nama + "|" + item.pelanggan_telepon;

        if (!grouped[key]) {
            grouped[key] = {
                nama: item.pelanggan_nama,
                telp: item.pelanggan_telepon,
                alamat: item.pelanggan_alamat,
                tagihan: [],
                total: 0,
                lunas: 0,
                belum: 0,
                telat: 0,
                tglBayar: '-'
            };
        }

        grouped[key].tagihan.push({
            bulan: item.bulan,
            jumlah: item.jumlah,
            status: item.status
        });

        grouped[key].total += item.jumlah || 0;

        if (item.status === 'lunas') {
            grouped[key].lunas++;
            grouped[key].tglBayar = item.tgl_bayar || '-';
        } else if (item.status === 'belum') {
            grouped[key].belum++;
        } else if (item.status === 'telat') {
            grouped[key].telat++;
        }
    });

    // RENDER
    const hasil = Object.values(grouped);

    table.innerHTML = hasil.map(item => {
        const bulanList = item.tagihan.map(t => t.bulan).join(', ');

        let status = 'Lunas', statusClass = 'badge-success';
        if (item.telat > 0) {
            status = 'Telat';
            statusClass = 'badge-danger';
        } else if (item.belum > 0) {
            status = 'Belum';
            statusClass = 'badge-warning';
        }

        return `
            <tr>
                <td><strong>${item.nama}</strong></td>
                <td>${item.telp}</td>
                <td>${item.alamat.substring(0, 30)}${item.alamat.length > 30 ? '...' : ''}</td>
                <td>${bulanList}</td>
                <td>${formatRupiah(item.total)}</td>
                <td><span class="badge ${statusClass}">${status}</span></td>
                <td>${item.tglBayar}</td>
                <td>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-success" onclick="bayarSemuaTagihan('${item.nama}')">
                            <i class="fas fa-money-bill-wave"></i>
                        </button>
                        <button class="btn btn-sm btn-info" onclick="lihatDetailTagihan('${item.nama}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

async function viewTagihanDetails(pelangganId) {
    console.log("👁️ MEMBUKA RIWAYAT TAGIHAN...");

    try {
        // 1. AMBIL DATA PELANGGAN
        const pelDoc = await db.collection('pelanggan').doc(pelangganId).get();
        const pelData = pelDoc.exists ? pelDoc.data() : {};
        const teleponPelanggan = pelData.telepon || '';
        const namaPelanggan = pelData.nama || 'Pelanggan';

        // 2. AMBIL DATA TAGIHAN
        const snapshot = await db.collection('tagihan')
            .where('pelanggan_id', '==', pelangganId)
            .get();

        if (snapshot.empty) {
            showToast('info', 'Info', 'Riwayat tagihan kosong.');
            return;
        }

        let tagihanList = [];
        snapshot.forEach(doc => {
            let data = doc.data();
            let bulanRaw = data.bulan || '';

            // NORMALISASI FORMAT BULAN
            let bulanFix = bulanRaw;
            if (bulanRaw.includes('-')) {
                let parts = bulanRaw.split('-');
                if (parts[0].length === 4 && parts[1].length === 2) {
                    bulanFix = `${parts[1]}-${parts[0]}`;
                } else if (parts[0].length === 2 && parts[1].length === 4) {
                    bulanFix = bulanRaw;
                }
            }

            let partsFix = bulanFix.split('-');
            let numericBulan = parseInt(partsFix[0]) || 1;
            let numericTahun = parseInt(partsFix[1]) || new Date().getFullYear();

            tagihanList.push({
                id: doc.id,
                ...data,
                bulan_fix: bulanFix,
                sort_bulan: numericBulan,
                sort_tahun: numericTahun
            });
        });

        // SORTING
        tagihanList.sort((a, b) => {
            if (b.sort_tahun !== a.sort_tahun) {
                return b.sort_tahun - a.sort_tahun;
            }
            return b.sort_bulan - a.sort_bulan;
        });

        // 3. BUAT MODAL "RIWAYAT TAGIHAN" DINAMIS
        const modalId = 'modalDetailTagihanFull';
        const oldModal = document.getElementById(modalId);
        if (oldModal) oldModal.remove();

        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal-overlay show';
        modal.style.zIndex = '1060';
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        modal.innerHTML = `
            <div class="modal modal-lg">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-list"></i> Riwayat Tagihan</h3>
                    <button class="modal-close" onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto'">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 20%;">Bulan</th>
                                    <th style="width: 20%;">Nominal</th>
                                    <th style="width: 15%;">Status</th>
                                    <th style="width: 15%;">Jatuh Tempo</th>
                                    <th style="width: 15%;">Tanggal Bayar</th>
                                    <th style="width: 15%;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="detailTableBody"></tbody>
                        </table>
                    </div>
                    <div id="detailPagination" style="margin-top: 15px; text-align: center;"></div>
                </div>
                <div class="modal-footer" id="modalFooterContent"></div>
            </div>
        `;

        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';

        // 4. FUNGSI RENDER
        window.renderDetailTable = function(page) {
            const tbody = document.getElementById('detailTableBody');
            const paginationDiv = document.getElementById('detailPagination');
            const footerDiv = document.getElementById('modalFooterContent');

            const itemsPerPage = 10;
            const totalPages = Math.ceil(tagihanList.length / itemsPerPage);
            if (page > totalPages) page = totalPages;

            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = tagihanList.slice(start, end);

            // RENDER TABLE
            tbody.innerHTML = pageData.map(t => {
                const isLunas = t.status === 'lunas';

                // --- AMBIL LANGSUNG DARI DATABASE ---
                let tglJatuhTempoDisplay = '-';
                if (t.tanggal_jatuh_tempo) {
                    const jatuhTempoDate = moment(t.tanggal_jatuh_tempo, 'DD-MM-YYYY');
                    if (jatuhTempoDate.isValid()) {
                        tglJatuhTempoDisplay = jatuhTempoDate.format('DD MMM YYYY');
                    } else {
                        tglJatuhTempoDisplay = t.tanggal_jatuh_tempo;
                    }
                }

                // TANGGAL BAYAR
                let tglBayarDisplay = '-';
                if (isLunas && t.tanggal_bayar) {
                    let date = null;
                    if (moment(t.tanggal_bayar, 'DD MMM YYYY', true).isValid()) {
                        date = moment(t.tanggal_bayar, 'DD MMM YYYY');
                    } else if (moment(t.tanggal_bayar, 'YYYY-MM-DD', true).isValid()) {
                        date = moment(t.tanggal_bayar, 'YYYY-MM-DD');
                    } else {
                        date = moment(t.tanggal_bayar);
                    }

                    if (date.isValid()) {
                        tglBayarDisplay = date.format('DD MMM YYYY');
                    } else {
                        tglBayarDisplay = t.tanggal_bayar;
                    }
                }

                let rowStyle = '';
                let statusBadge = '<span class="badge badge-danger">BELUM</span>';

                if (isLunas) {
                    rowStyle = 'background-color: #f0fff4 !important;';
                    statusBadge = '<span class="badge badge-success">LUNAS</span>';
                } else {
                    rowStyle = 'background-color: #fff0f0 !important;';
                }

                // ========================================
                // LOGIKA TOMBOL: JIKA LUNAS KIRIM, JIKA BELUM LUNAS BAYAR
                // ========================================
                let btnAksi = '';

                if (isLunas) {
                    // JIKA SUDAH LUNAS: TOMBOL KIRIM STRUK (GAMBAR)
                    btnAksi = `
                    <button class="btn btn-sm btn-success" id="btnKirimLunas_${t.id}">
                        <i class="fas fa-share"></i> Kirim
                    </button>
                    `;

                    // Pasang Event Listener Kirim Struk
                    setTimeout(() => {
                        const btn = document.getElementById(`btnKirimLunas_${t.id}`);
                        if (btn) {
                            btn.onclick = async function() {
                                try {
                                    const originalText = this.innerHTML;
                                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Proses...';
                                    this.disabled = true;

                                    // Data Struk
                                    const nominal = t.jumlah || 0;
                                    const tglBayarStr = t.tanggal_bayar ? moment(t.tanggal_bayar).format('DD MMMM YYYY') : moment().format('DD MMMM YYYY');
                                    const namaPetugas = t.nama_petugas || t.updated_by || getNamaKaryawan();
                                    const namaPerusahaan = window.globalCompanyName || 'X-BILL';
                                    const alamatPerusahaan = window.globalCompanyAddress || 'Jl. Internet Cepat No. 1';
                                    const noInvoice = `INV/${t.id.substring(t.id.length - 6).toUpperCase()}`;

                                    // Buat Struk HTML
                                    const strukContainer = document.createElement('div');
                                    strukContainer.style.position = 'absolute';
                                    strukContainer.style.left = '-9999px';
                                    strukContainer.style.top = '0';
                                    strukContainer.style.width = '300px';
                                    strukContainer.style.background = 'white';
                                    strukContainer.style.padding = '15px';
                                    strukContainer.style.fontFamily = 'Courier New, Courier, monospace';
                                    strukContainer.style.fontSize = '12px';
                                    strukContainer.style.color = '#000000';
                                    strukContainer.style.border = '1px solid #000';

let strukCompanyName = 'X-BILL';
let strukCompanyAddress = 'Jl. Internet Cepat No. 1';
if (globalCompanyId) {
    const companyDoc = await db.collection('company_settings').doc(globalCompanyId).get();

    if (companyDoc.exists) {
        const data = companyDoc.data();
        strukCompanyName = data.companyName || 'X-BILL';
        strukCompanyAddress = data.companyAddress || 'Jl. Internet Cepat No. 1';
    }
}

// GANTI STRUK TEMPLATE:
strukContainer.innerHTML = `
    <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px;">
        <h3 style="margin: 0; font-size: 18px; font-weight: bold;">${strukCompanyName}</h3>
        <p style="margin: 0; font-size: 10px;">${strukCompanyAddress}</p>
    </div>

                                        <div style="margin-bottom: 10px;">
                                            <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                                                <tr>
                                                    <td style="padding: 2px 0; width: 30%; color: #666;">TGL</td>
                                                    <td style="padding: 2px 0; font-weight: bold; text-align: right;">${tglBayarStr}</td>
                                                </tr>
                                                <tr>
                                                    <td style="padding: 2px 0; color: #666;">NO</td>
                                                    <td style="padding: 2px 0; font-weight: bold; text-align: right;">${noInvoice}</td>
                                                </tr>
                                                <tr>
                                                    <td style="padding: 2px 0; color: #666;">PETUGAS</td>
                                                    <td style="padding: 2px 0; font-weight: bold; text-align: right;">${namaPetugas.toUpperCase()}</td>
                                                </tr>
                                            </table>
                                        </div>

                                        <div style="border-top: 1px dashed #ccc; border-bottom: 1px dashed #ccc; padding: 8px 0; margin-bottom: 10px;">
                                            <div style="font-size: 11px; color: #666; margin-bottom: 2px;">PELANGGAN</div>
                                            <div style="font-weight: bold; font-size: 12px; margin-bottom: 2px;">${namaPelanggan}</div>
                                        </div>

                                        <div style="margin-bottom: 10px;">
                                            <div style="display: flex; justify-content: space-between; font-size: 11px; border-bottom: 1px dotted #eee; padding-bottom: 5px;">
                                                <span>PAKET INTERNET</span>
                                                <span>${formatRupiah(nominal)}</span>
                                            </div>
                                            <div style="font-size: 10px; color: #666; margin-top: 2px; padding-left: 5px;">
                                                ${pelData.paket || 'Paket Internet'} (${t.bulan_fix})
                                            </div>
                                        </div>

                                        <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 5px; border-top: 2px solid #000; font-weight: bold; font-size: 14px;">
                                            <span>TOTAL</span>
                                            <span>${formatRupiah(nominal)}</span>
                                        </div>

                                        <div style="text-align: center; margin-top: 5px; font-size: 11px;">
                                            <div id="notaStatusText" style="font-weight: bold; color: #27ae60;">LUNAS</div>
                                        </div>

                                        <div style="margin-top: 20px; text-align: center; border-top: 1px dashed #ccc; padding-top: 10px; font-size: 10px; color: #666;">
                                            <p style="margin: 0 0 5px 0;">Terima Kasih atas kepercayaan Anda</p>
                                            <p style="margin: 0;">Simpan struk ini sebagai bukti pembayaran yang sah.</p>
                                        </div>
                                    `;

                                    document.body.appendChild(strukContainer);
                                    await new Promise(r => setTimeout(r, 100));

                                    const canvas = await html2canvas(strukContainer, {
                                        scale: 2, useCORS: true, backgroundColor: "#ffffff"
                                    });

                                    canvas.toBlob(function(blob) {

                                            document.body.removeChild(strukContainer);
                                            if (!blob) return;

                                            const reader = new FileReader();
                                            reader.onloadend = function () {

                                                let noTujuan = (teleponPelanggan || "").replace(/\D/g, "");

                                                if (window.Android && Android.sendImageToWhatsApp) {
                                                    Android.sendImageToWhatsApp(
                                                        noTujuan,
                                                        reader.result
                                                    );
                                                }
                                            };

                                            reader.readAsDataURL(blob);

                                            btn.innerHTML = originalText;
                                            btn.disabled = false;

                                        }, 'image/png');


                                } catch (error) {
                                    console.error("Error:", error);
                                    // Reset tombol jika error
                                    btn.innerHTML = originalText;
                                    btn.disabled = false;
                                    showToast('error', 'Gagal', 'Gagal memproses gambar: ' + error.message);
                                }
                            };
                        }
                    }, 100);
                } else {
                    // JIKA BELUM LUNAS: TOMBOL BAYAR (BUKA FORM)
                   // JIKA BELUM LUNAS: TOMBOL BAYAR + TOMBOL TAGIH
btnAksi = `
<div class="btn-group">
    <button class="btn btn-sm btn-success"
        onclick="bukaNotaDanKonfirmasi('${t.id}', '${pelangganId}', '${namaPelanggan}', ${t.jumlah}, '${t.bulan_fix}')"
        title="Bayar Sekarang">
        <i class="fas fa-money-bill-wave"></i> Bayar
    </button>

</div>
`;
}

                return `
                    <tr style="${rowStyle}" data-id="${t.id}">
                        <td><strong>${t.bulan_fix}</strong></td>
                        <td>${formatRupiah(t.jumlah)}</td>
                        <td>${statusBadge}</td>
                        <td>${tglJatuhTempoDisplay}</td>
                        <td>${tglBayarDisplay}</td>
                        <td>${btnAksi}</td>
                    </tr>
                `;
            }).join('');

            // FOOTER
            if (footerDiv) {
    // Hitung total tagihan belum lunas
    const listBelumUrut = tagihanList.filter(item => item.status !== 'lunas');
    const totalBelum = listBelumUrut.reduce((sum, item) => sum + (item.jumlah || 0), 0);
    const bulanList = listBelumUrut.map(item => item.bulan_fix).join(', ');

    let footerHTML = '';

    if (listBelumUrut.length > 0) {
        const idsBelumUrut = listBelumUrut.map(item => item.id).join(',');

        footerHTML = `
            <div style="display: flex; gap: 10px; justify-content: center; width: 100%;">
                <button class="btn btn-warning"
                    onclick="kirimTagihanSemuaViaWA('${pelangganId}', '${namaPelanggan}', ${totalBelum}, '${bulanList}', '${idsBelumUrut}')"
                    style="flex: 1; background: #ffc107; border-color: #ffc107;">
                    <i class="fas fa-paper-plane"></i> Tagih Semua (${listBelumUrut.length} Bulan)
                </button>

                <button class="btn btn-success"
                    onclick="executePayAllDirect('${pelangganId}', '${idsBelumUrut}', ${totalBelum}, '${bulanList}', '${modalId}', '${namaPelanggan}')"
                    style="flex: 1;">
                    <i class="fas fa-money-bill-wave"></i> Bayar Semua
                </button>

                <button class="btn btn-primary"
                    onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto'"
                    style="flex: 0.5;">
                    Tutup
                </button>
            </div>
        `;
    } else {
        footerHTML = `
            <button class="btn btn-primary"
                onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto'">
                Tutup
            </button>
        `;
    }

    footerDiv.innerHTML = footerHTML;
}

            // PAGINATION
            if (paginationDiv) {
                let pagHTML = '<div class="pagination">';
                if (page > 1) pagHTML += `<a class="page-link" onclick="window.renderDetailTable(${page - 1})">&laquo;</a>`;
                pagHTML += `<span style="padding: 8px;">Hal ${page} / ${totalPages}</span>`;
                if (page < totalPages) pagHTML += `<a class="page-link" onclick="window.renderDetailTable(${page + 1})">&raquo;</a>`;
                pagHTML += '</div>';
                paginationDiv.innerHTML = pagHTML;
            }
        };

        window.renderDetailTable(1);

    } catch (error) {
        console.error("❌ Error view detail:", error);
        showToast('error', 'Gagal', 'Gagal memuat detail: ' + error.message);
    }
}


async function kirimTagihanSemuaViaWA(pelangganId, namaPelanggan, totalNominal, bulanList, tagihanIds) {
    try {
        // 1. CEK COOLDOWN 1x PER HARI (TANGGAL, BUKAN 24 JAM)
        const today = moment().format('YYYY-MM-DD');
        const cooldownKey = `wa_daily_${pelangganId}_${today}`;

        if (localStorage.getItem(cooldownKey)) {
            showToast('warning', 'Sudah dikirim hari ini',
                `Sudah mengirim tagihan ke ${namaPelanggan} hari ini.\nBisa kirim lagi besok.`);
            return;
        }

        // 2. AMBIL DATA PELANGGAN
        const pelangganDoc = await db.collection('pelanggan').doc(pelangganId).get();
        if (!pelangganDoc.exists) {
            showToast('error', 'Error', 'Data pelanggan tidak ditemukan');
            return;
        }

        const pelangganData = pelangganDoc.data();
        const telepon = pelangganData.telepon || '';

        if (!telepon || telepon.length < 10) {
            showToast('error', 'Error', 'Nomor telepon pelanggan tidak valid');
            return;
        }

        // 3. AMBIL DATA TAGIHAN UNTUK URUTKAN DAN HITUNG JATUH TEMPO
        const tagihanSnapshot = await db.collection('tagihan')
            .where('pelanggan_id', '==', pelangganId)
            .where('status', 'in', ['belum', 'telat'])
            .get();

        if (tagihanSnapshot.empty) {
            showToast('info', 'Tidak ada tagihan', 'Semua tagihan sudah lunas');
            return;
        }

        // 4. URUTKAN TAGIHAN DARI PALING LAMA KE BARU
        let tagihanList = [];
        tagihanSnapshot.forEach(doc => {
            const t = doc.data();
            tagihanList.push({
                id: doc.id,
                bulan: t.bulan || '',
                jumlah: t.jumlah || 0,
                jatuh_tempo: t.tanggal_jatuh_tempo || ''
            });
        });

        // SORT BY DATE: PALING LAMA → BARU
        tagihanList.sort((a, b) => {
            // Convert bulan to date (MM-YYYY)
            const dateA = moment(a.bulan, 'MM-YYYY');
            const dateB = moment(b.bulan, 'MM-YYYY');
            return dateA.valueOf() - dateB.valueOf(); // Ascending (oldest first)
        });

        // 5. HITUNG JATUH TEMPO (BULAN TERAKHIR/TERBARU)
        // 5. HITUNG JATUH TEMPO (TANGGAL 10 BULAN TERAKHIR)
let jatuhTempo = '';
if (tagihanList.length > 0) {
    // Ambil bulan terakhir
    const lastTagihan = tagihanList[tagihanList.length - 1];
    // Jatuh tempo = tanggal 10 bulan terakhir
    const bulanTerakhir = moment(lastTagihan.bulan, 'MM-YYYY').date(10); // Tanggal 10
    jatuhTempo = bulanTerakhir.format('DD MMMM YYYY'); // Contoh: 10 April 2026
} else {
    jatuhTempo = moment().date(10).format('DD MMMM YYYY');
}

        // 6. FORMAT BULAN LIST (DARI LAMA KE BARU)
        const bulanFormatted = tagihanList.map(t => {
            const bulanMoment = moment(t.bulan, 'MM-YYYY');
            return bulanMoment.format('MMMM YYYY');
        }).join(', ');

        const jumlahBulan = tagihanList.length;

        // 7. AMBIL TEMPLATE
        let template = await getTemplateFromSettings('tagihan');
        if (!template || template.trim() === '') {
            template = `Yth. [nama_pelanggan],\nTagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan].\nJatuh tempo: [jatuh_tempo]\nTerima kasih.\n[nama_perusahaan]`;
        }

        // 8. AMBIL DATA PERUSAHAAN
        const companyData = await getCompanyProfile();

        // 9. FORMAT PESAN
        const pesanTagihan = template
            .replace(/\[nama_pelanggan\]/g, namaPelanggan)
            .replace(/\[nama_perusahaan\]/g, companyData.nama_perusahaan || 'X-BILL')
            .replace(/\[bulan_tagihan\]/g, `${jumlahBulan} bulan (${bulanFormatted})`)
            .replace(/\[jumlah_tagihan\]/g, formatRupiah(totalNominal))
            .replace(/\[jatuh_tempo\]/g, jatuhTempo)
            .replace(/\[invoice_number\]/g, `INV/${moment().format('YYYYMMDD')}/${pelangganId.substring(0, 4)}`)
            .replace(/\[link_pembayaran\]/g, `https://xbill.com/pay/${pelangganId}`)
            .replace(/\[no_telepon_admin\]/g, companyData.telepon || '')
            .replace(/\[alamat_perusahaan\]/g, companyData.alamat || '')
            .replace(/\[website_perusahaan\]/g, companyData.website || '');

        const noWA = "62" + telepon.replace(/^0/, '');

        // 10. POPUP KONFIRMASI
        showCustomConfirm(
            'Kirim Tagihan via WhatsApp',
            `<div style="text-align: left;">
                <div style="margin-bottom: 15px;">
                    <strong>Kirim ke:</strong><br>
                    👤 ${namaPelanggan}<br>
                    📱 ${telepon}
                </div>
                <div style="margin-bottom: 15px; background: #fff3cd; padding: 10px; border-radius: 6px; border-left: 4px solid #ffc107;">
                    <strong>${jumlahBulan} BULAN SEKALIGUS</strong><br>
                    📅 Periode: ${bulanFormatted}<br>
                    💰 Total: ${formatRupiah(totalNominal)}<br>
                    ⏰ Jatuh Tempo: ${jatuhTempo}<br>
                    📊 Urutan: ${tagihanList.map((t, i) => `${i+1}. ${moment(t.bulan, 'MM-YYYY').format('MMM YYYY')}`).join(', ')}
                </div>
                <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 14px; max-height: 200px; overflow-y: auto;">
                    <strong>Preview Pesan:</strong><br>
                    <div style="white-space: pre-wrap; font-family: monospace; margin-top: 5px; font-size: 12px;">
                        ${pesanTagihan.substring(0, 300)}${pesanTagihan.length > 300 ? '...' : ''}
                    </div>
                </div>
            </div>`,

            // JIKA KONFIRM
            async function() {
                try {
                    // SIMPAN COOLDOWN (1 HARI)
                    localStorage.setItem(cooldownKey, 'sent');

                   // BUKA WA VIA ANDROID BRIDGE (KHUSUS APLIKASI ANDROID)
                    let noTujuan = telepon.replace(/\D/g, "");
                    if (noTujuan.startsWith("0")) {
                        noTujuan = "62" + noTujuan.substring(1);
                    }

                    if (window.Android && Android.sendTextToWhatsApp) {
                        Android.sendTextToWhatsApp(noTujuan, pesanTagihan);
                    } else {
                        let waUrl = `https://wa.me/${noTujuan}?text=${encodeURIComponent(pesanTagihan)}`;
                        window.open(waUrl, '_blank');
                    }


                    // LOG
                    await db.collection('aktivitas').add({
                        aktivitas: `Kirim tagihan ${jumlahBulan} bulan: ${namaPelanggan}`,
                        user: getUserLogName(),
                        timestamp: new Date().toISOString(),
                        company_id: globalCompanyId
                    });

                    showToast('success', 'Berhasil', 'WhatsApp terbuka');

                } catch (error) {
                    console.error("Error:", error);
                    showToast('error', 'Gagal', 'Gagal: ' + error.message);
                }
            },

            // JIKA BATAL
            function() {
                console.log("Dibatalkan");
            }
        );

    } catch (error) {
        console.error("❌ Error kirim tagihan:", error);
        showToast('error', 'Gagal', 'Gagal: ' + error.message);
    }
}

async function getTemplateFromSettings(templateType) {
    try {
        // AMBIL DARI COLLECTION message_templates
        const templateRef = db.collection('message_templates').doc(globalCompanyId);
        const templateDoc = await templateRef.get();

        if (templateDoc.exists) {
            const templateData = templateDoc.data();

            // MAP TEMPLATE TYPE KE FIELD YANG SESUAI
            const templateMap = {
                'tagihan': 'new_invoice',          // Untuk kirim tagihan, pakai template new_invoice
                'reminder_3hari': 'reminder_3hari',
                'reminder_1hari': 'reminder_1hari',
                'reminder_overdue': 'reminder_overdue',
                'payment_confirmed': 'payment_confirmed'
            };

            const fieldName = templateMap[templateType] || templateType;

            if (templateData[fieldName] && templateData[fieldName].trim() !== '') {
                return templateData[fieldName].trim();
            }
        }

        // JIKA TIDAK DITEMUKAN, RETURN STRING KOSONG
        return '';

    } catch (error) {
        console.error("Error get template from settings:", error);
        return '';
    }
}

function showTemplateWarning() {
    const modalId = 'modalTemplateWarning';

    // Hapus modal lama
    const oldModal = document.getElementById(modalId);
    if (oldModal) oldModal.remove();

    // Buat modal warning
    const modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'modal-overlay show';
    modal.style.zIndex = '999999';

    modal.innerHTML = `
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header" style="background: #fff3cd; border-color: #ffeaa7;">
                <h3 class="modal-title" style="color: #856404;">
                    <i class="fas fa-exclamation-triangle"></i> Template Pesan Kosong
                </h3>
                <button class="modal-close" onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto';">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 48px; color: #fdcb6e; margin-bottom: 15px;">
                        <i class="fas fa-comment-slash"></i>
                    </div>
                    <h4 style="color: #856404; margin-bottom: 10px;">Template Pesan Belum Diatur</h4>
                    <p style="color: #666; line-height: 1.5;">
                        Anda belum mengatur template pesan tagihan di menu Settings.<br>
                        Silakan atur template terlebih dahulu sebelum mengirim tagihan via WhatsApp.
                    </p>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: left;">
                        <strong>Langkah-langkah:</strong>
                        <ol style="margin: 10px 0 0 0; padding-left: 20px;">
                            <li>Buka menu <strong>Settings</strong></li>
                            <li>Pilih tab <strong>Template Pesan</strong></li>
                            <li>Isi template untuk kategori <strong>"Tagihan"</strong></li>
                            <li>Simpan template</li>
                            <li>Coba kirim tagihan lagi</li>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 10px;">
                <button id="btnCloseWarning" class="btn btn-outline" style="padding: 10px 20px;">
                    <i class="fas fa-times"></i> Tutup
                </button>
                <button id="btnGoToSettings" class="btn btn-primary" style="padding: 10px 20px;">
                    <i class="fas fa-cog"></i> Buka Settings
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';

    // Event listeners
    document.getElementById('btnCloseWarning').onclick = function() {
        modal.remove();
        document.body.style.overflow = 'auto';
    };

    document.getElementById('btnGoToSettings').onclick = function() {
        modal.remove();
        document.body.style.overflow = 'auto';
        // ARAHKAN KE MENU SETTINGS
        loadPage('settings');
        // SCROLL KE BAGIAN TEMPLATE PESAN
        setTimeout(() => {
            const templateSection = document.getElementById('templatePesanSection');
            if (templateSection) {
                templateSection.scrollIntoView({ behavior: 'smooth' });
            }
            showToast('info', 'Settings', 'Silakan isi template pesan tagihan');
        }, 500);
    };
}

// DEFAULT TEMPLATE JIKA TIDAK ADA DI SETTINGS
function getDefaultTemplate(templateType) {
    if (templateType === 'tagihan') {
        return `*TAGIHAN INTERNET [bulan]*\n\n` +
               `Kepada: [nama]\n` +
               `Telepon: [telepon]\n` +
               `Alamat: [alamat]\n` +
               `Paket: [paket]\n` +
               `Harga: [harga]/bulan\n` +
               `Periode: [bulan]\n` +
               `Jumlah: [nominal]\n` +
               `Status: [status]\n` +
               `Tanggal: [tanggal]\n` +
               `Jatuh Tempo: [jatuh_tempo]\n\n` +
               `*RINCIAN:*\n` +
               `- Total tagihan [jumlah_bulan] bulan\n` +
               `- Pembayaran dapat dicicil per bulan\n` +
               `- Hubungi admin untuk info lebih lanjut\n\n` +
               `*PEMBAYARAN:*\n` +
               `- Transfer Bank\n` +
               `- Cash di Kantor\n\n` +
               `_Pesan otomatis dari sistem_`;
    }

    return `Tagihan [bulan] untuk [nama]: [nominal]. Jatuh tempo: [jatuh_tempo]`;
}

// ============================================
// FUNGSI CEK STATUS COOLDOWN
// ============================================

function cekCooldownHarian(pelangganId) {
    const today = moment().format('YYYY-MM-DD');
    const cooldownKey = `wa_daily_${pelangganId}_${today}`;

    if (localStorage.getItem(cooldownKey)) {
        return {
            bisaKirim: false,
            pesan: `Sudah dikirim hari ini (${today})`
        };
    }

    return {
        bisaKirim: true,
        pesan: 'Bisa kirim sekarang'
    };
}

// Jalankan saat app load
function initCooldownCleanup() {
    // Hapus cooldown kemarin
    const yesterday = moment().subtract(1, 'day').format('YYYY-MM-DD');

    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('wa_daily_') && key.includes(yesterday)) {
            localStorage.removeItem(key);
        }
    }

    console.log("🧹 Cooldown harian dibersihkan");
}

// Panggil di DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    initCooldownCleanup();
});

// ============================================
// FUNGSI UNTUK TAMPILKAN TOMBOL DENGAN STATUS COOLDOWN
// (Ganti tombol di modal detail)
// ============================================

function getTombolKirimTagihanHTML(pelangganId, namaPelanggan, nominal, bulan, tagihanId) {
    const cooldownStatus = cekStatusCooldown(pelangganId, bulan);

    if (!cooldownStatus.bisaKirim) {
        // Tampilkan tombol disabled dengan info cooldown
        return `
        <button class="btn btn-sm btn-outline"
            title="${cooldownStatus.pesan}"
            disabled
            style="cursor: not-allowed; opacity: 0.6;">
            <i class="fas fa-clock"></i> ${cooldownStatus.jamTersisa}j
        </button>
        `;
    } else {
        // Tampilkan tombol aktif
        return `
        <button class="btn btn-sm btn-warning"
            onclick="kirimTagihanViaWA('${pelangganId}', '${namaPelanggan}', ${nominal}, '${bulan}')"
            title="Kirim tagihan via WhatsApp">
            <i class="fas fa-paper-plane"></i> Tagih
        </button>
        `;
    }
}



// ============================================
// FUNGSI POPUP KUSTOM KONFIRMASI
// ============================================
function showCustomConfirm(title, message, confirmCallback, cancelCallback) {
    const modalId = 'modalCustomConfirmWA';

    // Hapus modal lama
    const oldModal = document.getElementById(modalId);
    if (oldModal) oldModal.remove();

    // Buat modal baru
    const modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'modal-overlay show';
    modal.style.zIndex = '999999';

    modal.innerHTML = `
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-paper-plane" style="color: #25D366;"></i> ${title}
                </h3>
                <button class="modal-close" onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto';">&times;</button>
            </div>
            <div class="modal-body">
                ${message}
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 10px;">
                <button id="btnCancelWA" class="btn btn-outline" style="padding: 10px 25px;">
                    <i class="fas fa-times"></i> Batal
                </button>
                <button id="btnSendWA" class="btn btn-success" style="padding: 10px 25px; background: #25D366;">
                    <i class="fab fa-whatsapp"></i> Buka WhatsApp
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';

    // Event listeners
    document.getElementById('btnCancelWA').onclick = function() {
        modal.remove();
        document.body.style.overflow = 'auto';
        if (typeof cancelCallback === 'function') cancelCallback();
    };

    document.getElementById('btnSendWA').onclick = function() {
        modal.remove();
        document.body.style.overflow = 'auto';
        if (typeof confirmCallback === 'function') confirmCallback();
    };
}


async function executePayAllDirect(pelangganId, idsString, totalNominal, bulanString) {
    const tagihanIds = String(idsString).split(',');
    const tagihanId = tagihanIds[0];

    let dataPelanggan = { nama: 'Pelanggan', telepon: '-', paket: 'Paket Umum', alamat: '-' };
    try {
        const docPel = await db.collection('pelanggan').doc(pelangganId).get();
        if (docPel.exists) {
            const data = docPel.data();
            dataPelanggan.nama = data.nama;
            dataPelanggan.telepon = data.telepon;
            dataPelanggan.paket = data.paket;
            dataPelanggan.alamat = data.alamat;
        }
    } catch (e) { console.warn(e); }

    await bukaNotaDanKonfirmasi(tagihanId, pelangganId, dataPelanggan.nama, totalNominal, bulanString);

    const btnBayar = document.getElementById('btnBayarStruk');
    if(btnBayar) {
        const newBtn = btnBayar.cloneNode(true);
        btnBayar.parentNode.replaceChild(newBtn, btnBayar);

       
            newBtn.onclick = async function() {
    confirmDialog(`Lunas ${tagihanIds.length} tagihan (${formatRupiah(totalNominal)})?`, async () => {

            showLoading();
            try {
                const batch = db.batch();
                const now = new Date().toISOString();
                const tglHariIni = moment().format('DD MMMM YYYY, HH:mm');

                tagihanIds.forEach(id => {
                    const ref = db.collection('tagihan').doc(id);
                    batch.update(ref, {
                        status: 'lunas',
                        tanggal_bayar: tglHariIni,
                        metode_bayar: 'Tunai (Bulk)',
                        catatan_bayar: 'Pelunasan melalui menu Rincian Tagihan',
                        updated_at: now
                    });
                });

                await batch.commit();
                hideLoading();

                const btnBatal = document.getElementById('btnBatalStruk');
                const btnKirim = document.getElementById('btnKirimWA');
                const statusText = document.getElementById('notaStatusText');
                const btnContainer = document.getElementById('notaFooterContainer');
                const strukElement = document.getElementById('strukPrintable');

                if (btnContainer) {
                    newBtn.style.display = 'none';
                    if (btnBatal) btnBatal.style.display = 'none';

                    if (!document.getElementById('btnSelesaiStruk')) {
                        const btnBaru = document.createElement('button');
                        btnBaru.id = 'btnSelesaiStruk';
                        btnBaru.className = 'btn';
                        btnBaru.style.cssText = 'width: 100%; background: #2ecc71; color: white; padding: 15px; border-radius: 6px; font-weight: bold; font-size: 16px; margin-top: 10px; border: none; cursor: pointer;';
                        btnBaru.innerHTML = '<i class="fas fa-check-circle"></i> SELESAI';
                        btnContainer.appendChild(btnBaru);

                        btnBaru.onclick = () => {
                            document.getElementById('strukOverlay').remove();
                            const modalDetail = document.getElementById('modalDetailTagihan');
                            if(modalDetail) modalDetail.remove();
                            if (typeof loadTagihanData === 'function') loadTagihanData();
                        };
                    }

                    if (btnKirim) {
                        btnKirim.removeAttribute('disabled');
                        btnKirim.style.background = '#25D366';
                        btnKirim.style.color = 'white';
                        btnKirim.style.cursor = 'pointer';
                        btnKirim.innerHTML = '<i class="fas fa-camera"></i> KIRIM NOTA';

                        btnKirim.onclick = async function() {
                            const btnOriginal = this.innerHTML;
                            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> MEMBUAT GAMBAR...';
                            this.disabled = true;

                            try {
                                if (!strukElement) throw new Error("Elemen tidak ada");

                                const canvas = await html2canvas(strukElement, {
                                    scale: 2,
                                    useCORS: true,
                                    backgroundColor: "#ffffff"
                                });

                                canvas.toBlob(function(blob) {

                                const reader = new FileReader();
                                reader.onloadend = function () {

                                    let noTujuan = (globalDataPelanggan.telepon || "").replace(/\D/g, "");
                                    if (noTujuan.startsWith("0")) {
                                        noTujuan = "62" + noTujuan.substring(1);
                                    }

                                    const base64Image = reader.result.split(',')[1];

                                    if (window.Android && Android.sendImageToWhatsApp) {
                                        Android.sendImageToWhatsApp(
                                            noTujuan,
                                            base64Image
                                        );
                                    }
                                };

                                reader.readAsDataURL(blob);

                            }, 'image/png');



                            } catch (err) {
                                console.error(err);
                                this.innerHTML = btnOriginal;
                                this.disabled = false;
                            }
                        };
                    }

                    if (statusText) {
                        statusText.textContent = 'LUNAS (SEMUA)';
                        statusText.style.color = '#27ae60';
                    }
                }

            } catch (error) {
                hideLoading();
                console.error(error);
                showToast('error', 'Gagal', error.message);
            }
        });
    };
}
}



// ==========================================
// FUNGSI UPDATE TOMBOL DI TABEL (HELPER)
// (BARU - TAMBAHKAN INI)
// ==========================================
 function getTombolBayarHTML(tagihan) {
    const namaAman = (tagihan.pelanggan_nama || 'Pelanggan').replace(/"/g, '&quot;');
    return `
    <button class="btn btn-sm btn-success"
        onclick="bukaNotaDanKonfirmasi('${tagihan.id}', '${tagihan.pelanggan_id}', '${namaAman}', ${tagihan.jumlah}, '${tagihan.bulan}')"
        title="Bayar Sekarang">
        <i class="fas fa-money-bill-wave"></i> Bayar
    </button>
    `;
}

// ==========================================
// FUNGSI TAMPILKAN POP UP KONFIRMASI
// (BARU - TAMBAHKAN INI)
// ==========================================
function tampilkanPopUpKonfirmasi(tagihanId, pelangganId, namaPelanggan, nominal, bulan) {
    const modal = document.createElement('div');
    modal.id = 'modalKonfirmasiBayar';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.background = 'rgba(0, 0, 0, 0.7)';
    modal.style.zIndex = '1000000';
    modal.style.display = 'flex';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';

    modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.4); animation: popIn 0.3s;">
            <div style="width: 70px; height: 70px; background: #e74c3c; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 30px;">
                <i class="fas fa-question"></i>
            </div>
            <h3 style="color: #2c3e50; margin: 0 0 10px 0;">Konfirmasi Pembayaran</h3>
            <p style="color: #7f8c8d; font-size: 16px; margin: 0 0 20px 0;">Yakin ingin memproses pembayaran <strong>${formatRupiah(nominal)}</strong>?</p>

            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button id="btnConfirmCancel" style="flex: 1; padding: 12px; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; color: #555;">Batal</button>
                <button id="btnConfirmOK" style="flex: 1; padding: 12px; border: none; background: #27ae60; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Ya, Bayar</button>
            </div>
        </div>
        <style>@keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }</style>
    `;

    document.body.appendChild(modal);

    document.getElementById('btnConfirmCancel').onclick = () => modal.remove();
    document.getElementById('btnConfirmOK').onclick = async () => {
        modal.remove();
        await prosesBayarDanUpdateNota(tagihanId, pelangganId, namaPelanggan, nominal, bulan);
    };
}


async function uploadAtauDownloadStruk(canvas, fileNamePrefix) {
    try {
        const dataUrl = canvas.toDataURL("image/png");
        let finalUrl = null;

        try {
            const blob = await (await fetch(dataUrl)).blob();
            const formData = new FormData();
            formData.append('image', blob);

            // API KEY LU ADA DI SINI
            const response = await fetch('https://api.imgbb.com/1/upload?key=a49ed3d489c6e1745b4948e06e5eee15', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success && result.data && result.data.url) {
                finalUrl = result.data.url;
            } else {
                throw new Error("Upload Gagal");
            }

        } catch (uploadError) {
            console.warn("Upload Gagal, Download Manual:", uploadError);

            // Download Otomatis Jika Gagal
            const downloadLink = document.createElement('a');
            downloadLink.href = dataUrl;
            downloadLink.download = `${fileNamePrefix}.png`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);

            alert("Upload gagal. Gambar didownload otomatis. Silakan kirim manual.");
            return null;
        }

        return finalUrl;

    } catch (error) {
        console.error("Error fungsi upload:", error);
        return null;
    }
}

// ==========================================
// FUNGSI HELPER: AMBIL PENGATURAN STRUK (FOOTER & WARNA)
// ==========================================
function getStrukSettings() {
    // Ambil dari localStorage, kalau kosong pakai default
    const savedSettings = localStorage.getItem('xbill_struk_settings');

    if (savedSettings) {
        return JSON.parse(savedSettings);
    }

    // Default Settings
    return {
        themeColor: '#000000', // Default Hitam (Thermal)
        footerText1: 'Terima Kasih atas kepercayaan Anda',
        footerText2: 'Simpan struk ini sebagai bukti pembayaran yang sah.',
        showLogo: true
    };
}

// ==========================================
//  FUNGSI PROSES BAYAR & UPDATE TAMPILAN NOTA
// ==========================================
async function prosesBayarDanUpdateNota(tagihanId, pelangganId, namaPelanggan, nominal, bulan) {
    try {

        // =========================
        // 1. UPDATE DATABASE
        // =========================
        const ref = db.collection('tagihan').doc(tagihanId);
        const tglSekarang = moment().format('DD MMMM YYYY, HH:mm');

        await ref.update({
            status: 'lunas',
            tanggal_bayar: tglSekarang,
            metode_bayar: 'Tunai / Transfer',
            catatan_bayar: 'Lunas via Web App',
            updated_at: new Date().toISOString()
        });

        // =========================
        // 2. UPDATE TAMPILAN NOTA
        // =========================
        const btnBayar = document.getElementById('btnBayarStruk');
        const btnBatal = document.getElementById('btnBatalStruk');
        const btnKirim = document.getElementById('btnKirimWA');
        const statusText = document.getElementById('notaStatusText');
        const btnContainer = document.getElementById('notaFooterContainer');

        if (btnContainer) {

            if (btnBayar) btnBayar.style.display = 'none';
            if (btnBatal) btnBatal.style.display = 'none';

            // ✅ SET STATUS UI LANGSUNG (TANPA CEK ULANG DB)
            if (statusText) {
                statusText.textContent = 'LUNAS';
                statusText.style.color = '#27ae60';
            }

            // =========================
            // LOGIKA TOMBOL KIRIM WA
            // =========================
            if (btnKirim) {

                btnKirim.disabled = false;
                btnKirim.style.background = '#25D366';
                btnKirim.style.color = 'white';
                btnKirim.style.cursor = 'pointer';
                btnKirim.style.opacity = '1';
                btnKirim.innerHTML = '<i class="fas fa-share"></i> KIRIM KE WA';

                btnKirim.onclick = async function(e) {

                    e.preventDefault();
                    e.stopPropagation();

                    const btnOriginal = this.innerHTML;

                    try {

                        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> MEMPROSES...';
                        this.disabled = true;

                        const strukEl = document.getElementById('strukPrintable');
                        if (!strukEl) throw new Error("Elemen nota tidak ditemukan");

                        const cloneStruk = strukEl.cloneNode(true);
                        const footerClone = cloneStruk.querySelector('#notaFooterContainer');
                        if (footerClone) footerClone.style.display = 'none';

                        cloneStruk.style.position = 'absolute';
                        cloneStruk.style.top = '-9999px';
                        cloneStruk.style.left = '-9999px';
                        cloneStruk.style.background = 'white';
                        document.body.appendChild(cloneStruk);

                        const canvas = await html2canvas(cloneStruk, {
                            scale: 2,
                            useCORS: true,
                            backgroundColor: "#ffffff"
                        });

                        document.body.removeChild(cloneStruk);

                        const dataUrl = canvas.toDataURL("image/png", 1.0);

                        let noTujuan = (globalDataPelanggan.telepon || "").replace(/\D/g, "");
                        if (noTujuan.startsWith("0")) {
                            noTujuan = "62" + noTujuan.substring(1);
                        }

                        if (!window.Android) {
                            throw new Error("Android bridge tidak tersedia");
                        }

                        Android.sendImageToWhatsApp(noTujuan, dataUrl);

                        this.innerHTML = '<i class="fas fa-check"></i> TERKIRIM';
                        this.style.background = '#2ecc71';
                        this.disabled = false;

                    } catch (error) {
                        console.error(error);
                        this.innerHTML = btnOriginal;
                        this.disabled = false;
                    }
                };
            }

            // =========================
            // TOMBOL SELESAI
            // =========================
            const btnSelesai = document.createElement('button');
            btnSelesai.id = 'btnSelesaiStruk';
            btnSelesai.className = 'btn';
            btnSelesai.style.cssText = `
                width: 100%;
                background: #2ecc71;
                color: white;
                padding: 12px;
                border-radius: 5px;
                font-weight: bold;
                font-size: 14px;
                cursor: pointer;
                border: none;
                margin-top: 10px;
            `;
            btnSelesai.innerHTML = '<i class="fas fa-check-circle"></i> SELESAI';
            btnContainer.appendChild(btnSelesai);

            btnSelesai.onclick = function() {
                const strukOverlay = document.getElementById('strukOverlay');
                if (strukOverlay) strukOverlay.remove();
                if (typeof loadTagihanData === 'function') loadTagihanData();
                if (typeof loadTunggakanData === 'function') loadTunggakanData();
            };
        }

    } catch (error) {
        console.error("Error bayar:", error);
        showToast('error', 'Gagal', error.message);
    }
}





async function prepareModalPayAll(pelangganId, idsString, totalNominal, bulanString) {
    console.log("📦 Menyiapkan Modal PayAll...");

    try {
        // 1. Tutup Modal Detail (Supaya bersih)
        forceCloseModal('modalDetailTagihan');

        // 2. Ambil Data Pelanggan
        const docRef = await db.collection('pelanggan').doc(pelangganId).get();
        if (!docRef.exists) return;

        const data = docRef.data();

        // 3. ISI FORM MODAL PAYALL
        const hiddenInput = document.getElementById('payAllTagihanIds');
        const namaEl = document.getElementById('payAllNama');
        const teleponEl = document.getElementById('payAllTelepon');
        const totalTagihanEl = document.getElementById('payAllTotalTagihan');
        const totalDendaEl = document.getElementById('payAllDenda');
        const grandTotalEl = document.getElementById('payAllGrandTotal');
        const inputNominalEl = document.getElementById('payAllInputNominal');
        const tglEl = document.getElementById('payAllTanggal');

        // Cek elemen ada sebelum diset
        if (!hiddenInput || !namaEl) {
            console.error("Elemen Modal PayAll tidak ditemukan di HTML.");
            showToast('error', 'Error', 'Form Modal PayAll belum siap (HTML ID salah/hilang).');
            return;
        }

        if (hiddenInput) hiddenInput.value = idsString;
        window.bulanList = bulanString;


        if (namaEl) namaEl.textContent = data.nama;
        if (teleponEl) teleponEl.textContent = data.telepon;
        if (totalTagihanEl) totalTagihanEl.textContent = formatRupiah(totalNominal);
        if (totalDendaEl) totalDendaEl.textContent = 'Rp 0';
        if (grandTotalEl) grandTotalEl.textContent = formatRupiah(totalNominal);
        if (inputNominalEl) inputNominalEl.value = totalNominal;
        if (tglEl) tglEl.value = moment().format('YYYY-MM-DD');

        // 4. BUKA MODAL PAYALL
        const modalPay = document.getElementById('modalPayAll');
        if (modalPay) {
            modalPay.classList.remove('hidden');
            modalPay.classList.add('show');
            modalPay.style.display = 'flex';
            modalPay.style.zIndex = '1060'; // Di atas modal detail
            document.body.style.overflow = 'hidden';
        } else {
            showToast('error', 'Error', 'Modal PayAll tidak ditemukan di HTML.');
        }

    } catch (error) {
        console.error("Error prepare modal:", error);
        showToast('error', 'Error', 'Gagal menyiapkan form pembayaran.');
    }
}


// ============================================
// FULL FUNGSI TOMBOL BAYAR (SINGLE & BULK)
// ============================================

// 1. FUNGSI UTAMA: BUKA NOTA + UPDATE PETUGAS & PERUSAHAAN
async function bukaNotaDanKonfirmasi(tagihanId, pelangganId, namaPelanggan, nominal, bulan) {
    try {
        // Ambil Data Pelanggan
        let dataPelanggan = {
            nama: namaPelanggan,
            alamat: 'Alamat belum diset',
            telepon: '-',
            paket: 'Paket Umum',
            id_pelanggan: pelangganId
        };

        try {
            const docPel = await db.collection('pelanggan').doc(pelangganId).get();
            if (docPel.exists) {
                const data = docPel.data();
                dataPelanggan.nama = data.nama || namaPelanggan;
                dataPelanggan.alamat = data.alamat || '-';
                dataPelanggan.telepon = data.telepon || '-';
                dataPelanggan.paket = data.paket || 'Paket Umum';
                dataPelanggan.id_pelanggan = docPel.id;
            }
        } catch (e) {
            console.warn("Gagal ambil detail pelanggan:", e);
        }

        globalDataPelanggan = dataPelanggan;

        // --- AMBIL NAMA PETUGAS (USER LOGIN) ---
        let namaPetugas = 'ADMIN'; // Default

        try {
            const userStr = localStorage.getItem('xbill_user');
            if (userStr) {
                const userObj = JSON.parse(userStr);
                // Cek nama, kalau gak ada pakai email
                if (userObj.name) {
                    namaPetugas = userObj.name;
                } else if (userObj.email) {
                    namaPetugas = userObj.email.split('@')[0];
                }
            }
        } catch (err) {
            console.log("Gagal ambil user login");
        }
        // ----------------------------------------

        // --- AMBIL DATA DARI VARIABEL GLOBAL (SINKRON DASHBOARD) ---

let logoPerusahaan = '';
if (globalCompanyId) {
    const companyDoc = await db.collection('company_settings').doc(globalCompanyId).get();
    if (companyDoc.exists) {
        const data = companyDoc.data();
        namaPerusahaan = data.companyName || 'X-BILL';
        alamatPerusahaan = data.companyAddress || 'Jl. Merdeka No. 45, Jakarta';
        logoPerusahaan = data.companyLogo || '';
    }
}

        // -----------------------------------------------------------------

        // Buat Tampilan Nota (Overlay)
        const strukOverlay = document.createElement('div');
        strukOverlay.id = 'strukOverlay';
        strukOverlay.style.position = 'fixed';
        strukOverlay.style.top = '0';
        strukOverlay.style.left = '0';
        strukOverlay.style.width = '100%';
        strukOverlay.style.height = '100%';
        strukOverlay.style.background = 'rgba(0, 0, 0, 0.85)';
        strukOverlay.style.zIndex = '999999';
        strukOverlay.style.display = 'flex';
        strukOverlay.style.alignItems = 'center';
        strukOverlay.style.justifyContent = 'center';
        strukOverlay.style.overflowY = 'auto';
        strukOverlay.style.padding = '20px';

        const tanggalInvoice = moment().format('DD MMMM YYYY');
        const noInvoice = `INV/${tagihanId.substring(tagihanId.length - 6).toUpperCase()}`;

        // HTML STRUK LENGKAP
        strukOverlay.innerHTML = `
             <div style="
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width:100%;
            ">
                <!-- AREA STRUK -->
                <div id="strukPrintable" style="
                    background: white;
                    width:320px;
                    padding:5px;
                    font-family: 'Courier New', Courier, monospace;
                    font-size: 12px;
                    color: #333;
                    box-shadow:0 0 5px rgba(0,0,0,0.5);
                    position: relative;
                    border-radius:5px;
                    margin-bottom: 5px;
                ">

                    <!-- HEADER (PERUSAHAAN) -->
                    <div style="
                         text-align: center;
    border-bottom: 2px dashed #000;
    padding-top: 0;           /* ← TAMBAH INI */
    padding-bottom: 5px;
    margin-top: 0;            /* ← TAMBAH INI */
    margin-bottom: 2px;
                    ">
                        ${logoPerusahaan ?
`
<div style="
    width:200px;
    height:100px;
    margin:0 auto -35px auto;
    overflow:hidden;
    line-height:0;
">
    <img src="${logoPerusahaan}"
        style="
            width:100%;
            height:100%;
            object-fit:cover;
            object-position:center;
            display:block;
        ">
</div>
`
:
`<h2 id="displayStrukCompanyName" style="
    margin:0;
    font-size:16px;
    font-weight:bold;
    text-transform:uppercase;
    color:#000;
">${namaPerusahaan}</h2>`
}

                        <p style="margin: 0; font-size: 10px; color: #666;">Billing Management System</p>
                        <p style="margin: 0; font-size: 12px; color: #666;">${alamatPerusahaan}</p>
                        </div>

                    <!-- INFO TRANSAKSI -->
                    <div style="margin-bottom: 10px;">
                        <table style="width: 100%; font-size: 11px; border-collapse: collapse;">
                            <tr>
                                <td style="padding: 2px 0; width: 30%; color: #666;">TGL</td>
                                <td style="padding: 2px 0; font-weight: bold; text-align: right;">${tanggalInvoice}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0; color: #666;">NO</td>
                                <td style="padding: 2px 0; font-weight: bold; text-align: right;">${noInvoice}</td>
                            </tr>
                            <tr>
                                <td style="padding: 2px 0; color: #666;">PETUGAS</td>
                                <td style="padding: 2px 0; font-weight: bold; text-align: right;">${namaPetugas.toUpperCase()}</td>
                            </tr>
                        </table>
                    </div>

                    <!-- PEMBELI -->
                    <div style="
                        border-top: 1px dashed #ccc;
                        border-bottom: 1px dashed #ccc;
                        padding: 8px 0;
                        margin-bottom: 10px;
                    ">
                        <div style="font-size: 11px; color: #666; margin-bottom: 2px;">PELANGGAN</div>
                        <div style="font-weight: bold; font-size: 12px; margin-bottom: 2px;">${globalDataPelanggan.nama}</div>
                    </div>

                    <!-- ITEM TAGIHAN -->
                    <div style="margin-bottom: 10px;">
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            font-size: 11px;
                            border-bottom: 1px dotted #eee;
                            padding-bottom: 5px;
                        ">
                            <span>PAKET INTERNET</span>
                            <span>${formatRupiah(nominal)}</span>
                        </div>
                        <div style="
                            font-size: 10px;
                            color: #666;
                            margin-top: 2px;
                            padding-left: 5px;
                        ">
                            ${globalDataPelanggan.paket} (${bulan})
                        </div>
                    </div>

                    <!-- TOTAL -->
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        margin-top: 10px;
                        padding-top: 5px;
                        border-top: 2px solid #000;
                        font-weight: bold;
                        font-size: 14px;
                    ">
                        <span>TOTAL</span>
                        <span>${formatRupiah(nominal)}</span>
                    </div>

                    <!-- STATUS -->
                    <div style="text-align: center; margin-top: 5px; font-size: 11px;">
                        <div id="notaStatusText" style="font-weight: bold; color: #e74c3c;">BELUM LUNAS</div>
                    </div>

                    <!-- FOOTER (ALAMAT PERUSAHAAN) -->
                    <div style="
                        margin-top: 20px;
                        text-align: center;
                        border-top: 1px dashed #ccc;
                        padding-top: 10px;
                        font-size: 10px;
                        color: #666;
                    ">
                        <p style="margin: 0 0 5px 0;">Terima Kasih atas kepercayaan Anda</p>
                        <p style="margin: 0;">Simpan struk ini sebagai bukti pembayaran yang sah.</p>

                    </div>

                </div>

                <!-- TOMBOL AKSI -->
                <div id="notaFooterContainer" style="
                    width: 320px;
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                ">
                    <button id="btnBayarStruk" class="btn btn-success" style="
                        width: 100%;
                        padding: 12px;
                        border-radius: 5px;
                        font-weight: bold;
                        font-size: 14px;
                        cursor: pointer;
                        border: none;
                        background-color: #27ae60;
                    ">
                        <i class="fas fa-money-bill-wave"></i> BAYAR
                    </button>

                    <button id="btnKirimWA" class="btn" style="
                        width: 100%;
                        background: #bdc3c7;
                        color: #7f8c8d;
                        padding: 12px;
                        border-radius: 5px;
                        font-weight: bold;
                        font-size: 14px;
                        cursor: not-allowed;
                        border: none;
                        opacity: 0.6;
                    " disabled>
                        <i class="fab fa-whatsapp"></i> KIRIM NOTA
                    </button>

                    <button id="btnBatalStruk" class="btn" style="
                        width: 100%;
                        background: #fff;
                        color: #e74c3c;
                        border: 1px solid #e74c3c;
                        padding: 10px;
                        border-radius: 5px;
                        font-weight: bold;
                        font-size: 13px;
                        cursor: pointer;
                    ">
                        BATAL
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(strukOverlay);

        // Event Tombol Batal
        const btnBatal = document.getElementById('btnBatalStruk');
        if(btnBatal) {
            btnBatal.onclick = function() {
                document.getElementById('strukOverlay').remove();
            };
        }



        // Event Tombol Bayar
const btnBayar = document.getElementById('btnBayarStruk');
if (btnBayar) {
    btnBayar.onclick = async function() {
        // Panggil fungsi lama (JANGAN DIHAPUS)
        tampilkanPopUpKonfirmasi(tagihanId, pelangganId, namaPelanggan, nominal, bulan);


    };
}



    } catch (error) {
        console.error("Error buka nota:", error);
        showToast('error', 'Error', 'Gagal membuka nota');
    }
}



// ============================================
// FUNGSI CEK ID PERUSAHAAN
// ============================================

function cekIDPerusahaan() {
    console.log("🔍 Mencari ID Dokumen Perusahaan di folder 'settings'...");

    db.collection('settings').get().then((snapshot) => {
        if (snapshot.empty) {
            console.log("❌ KOSONG: Folder 'settings' tidak ada datanya sama sekali.");
        } else {
            console.log(`✅ DITEMUKAN: Ada ${snapshot.size} dokumen di folder 'settings'.`);
            console.log("📋 DAFTAR ID DOKUMEN:");

            let index = 1;
            snapshot.forEach((doc) => {
                const data = doc.data();
                const idDoc = doc.id;

                console.log(`${index}. ID: [ ${idDoc} ]`);
                console.log(`   Isi Data:`, data);
                console.log(`   ---------------------------------`);

                index++;
            });

            console.log("👆 LIHAT DAFTAR DI ATAS.");
            console.log("👆 CARA DOKUMEN YANG ISINYA ADA 'NAMA' / 'ALAMAT', AMBIL ID-NYA.");
        }
    }).catch((error) => {
        console.error("❌ Error:", error);
    });
}

// ============================================
// FUNGSI KIRIM ULANG STRUK (JIKA SUDAH LUNAS)
// ============================================

async function kirimUlangStruk(tagihanId, namaPelanggan, nominal, bulan) {
    console.log("📤 Kirim Ulang Struk...");

    // Ambil data tanggal bayar terbaru untuk ditampilkan di struk
    let tglBayarStr = moment().format('DD-MM-YYYY');

    try {
        showLoading();

        // GENERATE GAMBAR STRUK (Sama logic dengan bayar, tapi tidak update DB)
        const strukContainer = document.createElement('div');
        strukContainer.style.width = '300px';
        strukContainer.style.padding = '15px';
        strukContainer.style.background = '#ffffff';
        strukContainer.style.fontFamily = 'monospace';
        strukContainer.style.fontSize = '14px';
        strukContainer.style.color = '#000000';
        strukContainer.style.border = '1px solid #000';
        strukContainer.style.position = 'absolute';
        strukContainer.style.left = '-9999px';

        strukContainer.innerHTML = `
            <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 10px;">
                <h2 style="margin: 0; font-size: 18px; font-weight: bold;">X-BILL</h2>
                <p style="margin: 0; font-size: 10px;">Jl. Internet Cepat No. 1</p>
            </div>

            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Pelanggan:</span>
                    <strong>${namaPelanggan}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Tanggal:</span>
                    <span>${tglBayarStr}</span>
                </div>
            </div>

            <div style="border-top: 1px solid #000; border-bottom: 1px solid #000; padding: 10px 0; margin: 10px 0; text-align: center;">
                <strong>BUKTI PEMBAYARAN</strong>
            </div>

            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Periode:</span>
                    <span>${bulan}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 16px; font-weight: bold;">
                    <span>Total:</span>
                    <span>${formatRupiah(nominal)}</span>
                </div>
            </div>

            <div style="text-align: center; margin-top: 15px; font-weight: bold;">
                STATUS: LUNAS
            </div>

            <div style="text-align: center; margin-top: 15px; border-top: 1px solid #000; padding-top: 10px; font-size: 11px;">
                Terima Kasih<br>
                Simpan struk ini sebagai bukti pembayaran yang sah.
            </div>
        `;

        document.body.appendChild(strukContainer);
        await new Promise(r => setTimeout(r, 300));

        // NOTE: Untuk sharing gambar ke WA via browser, biasanya butuh API backend tambahan
        // Di sini kita simulasi dengan membuka WA text biasa saja karena keterbatasan client-side only
        // 🔥 KIRIM GAMBAR VIA ANDROID BRIDGE
const canvas = await html2canvas(strukContainer, {
    scale: 2,
    useCORS: true,
    backgroundColor: "#ffffff"
});

document.body.removeChild(strukContainer);

// Ambil nomor telepon SEBELUM masuk ke reader.onloadend
const noTujuan = (await getNomorTeleponPelanggan(tagihanId)).replace(/\D/g, "");
if (noTujuan.startsWith("0")) {
    noTujuan = "62" + noTujuan.substring(1);
}

canvas.toBlob((blob) => {
    const reader = new FileReader();
    reader.onloadend = () => {
        if (window.Android && Android.sendImageToWhatsApp) {
            Android.sendImageToWhatsApp(noTujuan, reader.result);
            showToast('success', 'Berhasil', 'Struk dikirim ke WA');
        } else {
            showToast('error', 'Gagal', 'Android bridge tidak tersedia');
        }
    };
    reader.readAsDataURL(blob);
}, 'image/png');





        hideLoading();

    } catch (error) {
        hideLoading();
        console.error("Error:", error);
        showToast('error', 'Gagal', error.message);
    }
}

// Helper untuk ambil nomor telepon jika perlu
async function getNomorTeleponPelanggan(tagihanId) {
    try {
        const doc = await db.collection('tagihan').doc(tagihanId).get();
        if(doc.exists && doc.data().pelanggan_telepon) {
            return doc.data().pelanggan_telepon;
        }
        return "-";
    } catch(e) {
        return "-";
    }
}



// FUNGSI BARU: Apply filter di client side
function applyTagihanFilters() {
    const bulanFilter = document.getElementById('filterBulan')?.value || '';
    const statusFilter = document.getElementById('filterStatusTagihan')?.value || '';
    const searchFilter = document.getElementById('searchTagihan')?.value || '';

    console.log("Filter:", { bulanFilter, statusFilter, searchFilter });

    // Clone data asli
    let filteredData = [...tagihanData];

    // Filter bulan
    if (bulanFilter) {
        filteredData = filteredData.filter(t => t.bulan === bulanFilter);
    }

    // Filter status
    if (statusFilter) {
        filteredData = filteredData.filter(t => t.status === statusFilter);
    }

    // Filter search
    if (searchFilter) {
        const searchLower = searchFilter.toLowerCase();
        filteredData = filteredData.filter(t =>
            (t.pelanggan_nama && t.pelanggan_nama.toLowerCase().includes(searchLower)) ||
            (t.id && t.id.toLowerCase().includes(searchLower)) ||
            (t.bulan && t.bulan.includes(searchFilter))
        );
    }

    // Update global variable
    tagihanData = filteredData;

    // Render tabel
    renderTagihanTable();
}

        function renderTagihanTable() {
    const table = document.getElementById('tagihanTable');
    if (!table) return;

    if (tagihanData.length === 0) {
        table.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tidak ada data tagihan</td></tr>`;
        return;
    }

    table.innerHTML = tagihanData.map((tagihan, index) => {
        // Format Data Aman
        const id = tagihan.id || `TAGIHAN_${index}`;
        const nama = (tagihan.pelanggan_nama || 'Pelanggan').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const nominal = tagihan.jumlah || 0;
        const bulan = tagihan.bulan || '-';

        // Logic Status
        const isLunas = tagihan.status === 'lunas';
        let tombolBayar = '';

        // --- PERBAIKAN DISINI ---
        // Kita simpan SEMUA data yang dibutuhkan di dalam atribut 'data-' pada tombol
        // Kemudian kita gunakan fungsi pembantu 'handleBayarClick' yang lebih aman
        if (!isLunas) {
            tombolBayar = `
                <button class="btn btn-sm btn-success"
                    data-id="${id}"
                    data-pid="${tagihan.pelanggan_id || ''}"
                    data-nama="${nama}"
                    data-nominal="${nominal}"
                    data-bulan="${bulan}"
                    onclick="handleBayarClick(this)"
                    title="Bayar Sekarang">
                    <i class="fas fa-money-bill-wave"></i> Bayar
                </button>
            `;
        }

        return `
            <tr>
                <td>${id.substring(0, 10)}...</td>
                <td><strong>${nama}</strong></td>
                <td>${bulan}</td>
                <td>${formatRupiah(nominal)}</td>
                <td>
                    <span class="badge ${isLunas ? 'badge-success' : 'badge-warning'}">
                        ${isLunas ? 'Lunas' : 'Belum'}
                    </span>
                </td>
                <td>
                    <div class="btn-group">
                        ${tombolBayar}
                        <button class="btn btn-sm btn-info" onclick="viewInvoice('${id}')"><i class="fas fa-eye"></i></button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}


// ============================================
// FUNGSI SHOW PAYMENT CONFIRMATION (POP UP)
// ============================================

function showPaymentConfirmation(tagihanId, pelangganId, namaPelanggan, nominal, bulan) {
    console.log("⚠️ MENAMPILKAN POP UP KONFIRMASI...");

    // MODAL KONFIRMASI
    const modalConfirm = document.createElement('div');
    modalConfirm.style.position = 'fixed';
    modalConfirm.style.top = '0';
    modalConfirm.style.left = '0';
    modalConfirm.style.width = '100%';
    modalConfirm.style.height = '100%';
    modalConfirm.style.background = 'rgba(0, 0, 0, 0.7)';
    modalConfirm.style.zIndex = '1000000';
    modalConfirm.style.display = 'flex';
    modalConfirm.style.alignItems = 'center';
    modalConfirm.style.justifyContent = 'center';

    modalConfirm.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.4); animation: modalPop 0.3s ease;">
            <div style="width: 70px; height: 70px; background: #e74c3c; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 30px;">
                <i class="fas fa-question"></i>
            </div>
            <h3 style="color: #2c3e50; margin: 0 0 10px 0;">Konfirmasi Pembayaran</h3>
            <p style="color: #7f8c8d; margin: 0 0 20px 0;">Anda akan memproses pembayaran untuk:</p>

            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <small>Pelanggan:</small> <strong>${namaPelanggan}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <small>Periode:</small> <strong>${bulan}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; border-top: 1px solid #ddd; padding-top: 10px;">
                    <small style="font-weight: bold;">Total:</small> <strong style="color: #e74c3c; font-size: 18px;">${formatRupiah(nominal)}</strong>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button id="btnConfirmCancel" style="flex: 1; padding: 12px; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; color: #555;">Batal</button>
                <button id="btnConfirmOK" style="flex: 1; padding: 12px; border: none; background: #27ae60; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">Lanjut Bayar</button>
            </div>
        </div>
    `;

    document.body.appendChild(modalConfirm);

    // HANDLE BUTTONS DI MODAL KONFIRMASI
    document.getElementById('btnConfirmCancel').onclick = () => modalConfirm.remove();

    document.getElementById('btnConfirmOK').onclick = () => {
        modalConfirm.remove();
        // JIKA OK -> BARU MUNCULKAN NOTA (PREVIEW)
        bayarTagihanDenganStruk(tagihanId, pelangganId, namaPelanggan, nominal, bulan);
    };
}



// ============================================
// FUNGSI PEMBANTU CLICK TOMBOL BAYAR
// ============================================

function handleBayarClick(btnElement) {


    const id = btnElement.getAttribute('data-id');
    const pid = btnElement.getAttribute('data-pid');
    const nama = btnElement.getAttribute('data-nama');
    const nominal = parseInt(btnElement.getAttribute('data-nominal')) || 0;
    const bulan = btnElement.getAttribute('data-bulan');

    if (!id || !pid || !nominal) return showToast('error', 'Error', 'Data tidak lengkap');

    bukaNotaDanKonfirmasi(id, pid, nama, nominal, bulan);


}

// ================== GLOBAL CACHE ==================
window.__CACHE = {
    pelanggan: null,
    tagihan: null
};


async function loadTagihanData() {
    logRead('tagihan');
     await loadServerOptionsForTagihan();

    const table = document.getElementById('tagihanTable');
    if (!table) return;

    table.innerHTML = `<tr><td colspan="6" class="text-center"><div class="spinner" style="width:30px;height:30px;margin:0 auto;"></div></td></tr>`;

    try {

          // ⭐⭐ AMBIL NILAI FILTER SERVER ⭐⭐
        const serverFilter = document.getElementById('filterServerTagihan')?.value || "";
        // ⭐⭐ PERBAIKAN 1: FILTER PELANGGAN BERDASARKAN COMPANY_ID ⭐⭐
        let pelangganSnapshot;

            if (window.__CACHE.pelanggan) {
                console.log("⚡ Pelanggan dari CACHE");
                pelangganSnapshot = window.__CACHE.pelanggan;
            } else {
                pelangganSnapshot = await db.collection('pelanggan')
                    .where('company_id', '==', globalCompanyId)
                    .get();

                window.__CACHE.pelanggan = pelangganSnapshot;
            }

        const pelangganIds = [];
        const pelangganMap = {};

        pelangganSnapshot.forEach(doc => {
            // ⭐⭐ PERBAIKAN 2: VALIDASI DATA PELANGGAN MILIK COMPANY INI ⭐⭐
            const p = doc.data();
            if (p.company_id !== globalCompanyId) {
                console.warn(`⚠️ Pelanggan ${doc.id} bukan milik company ini:`, p.company_id);
                return; // Skip jika bukan milik company ini
            }

            pelangganIds.push(doc.id);
            pelangganMap[doc.id] = {
            alamat: p.alamat || '-',
            nama: p.nama || '-',
            telepon: p.telepon || '-',
            server: p.server || 'Tidak Diketahui',  // ⭐ INI
            koordinat: p.koordinat || null,         // ⭐ INI
            company_id: p.company_id || globalCompanyId
        };
    });

                // ⭐⭐ DEKLARASI QUERY ⭐⭐
        let tagihanSnapshot;
let tagihanData = [];
// ✅ TAMBAH INI:

const cachedTagihan = CACHE.get('tagihanData', TAGIHAN_CACHE_TTL);
if (cachedTagihan) {
    console.log("✅ PAKAI CACHE TAGIHAN - 0 READ");
    tagihanData = cachedTagihan;
} else {
    console.log("📥 AMBIL TAGIHAN DARI FIREBASE");
    const tagihanSnapshot = await db.collection('tagihan')
        .where('company_id', '==', globalCompanyId)
        .get();

    tagihanSnapshot.forEach(doc => {
        tagihanData.push({ id: doc.id, data: doc.data() });
    });

    CACHE.set('tagihanData', tagihanData);
}


        if (pelangganIds.length === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center" style="padding: 40px;">
                        <i class="fas fa-inbox" style="font-size: 48px; color: #e9ecef;"></i>
                        <h4 style="margin-top:15px; color: var(--gray);">Tidak Ada Pelanggan</h4>
                        <p>Belum ada data pelanggan untuk perusahaan Anda.</p>
                        <button class="btn btn-primary mt-2" onclick="showAddPelangganModal()">
                            <i class="fas fa-plus"></i> Tambah Pelanggan Pertama
                        </button>
                    </td>
                </tr>`;
            return;
        }

        console.log(`👥 ${pelangganIds.length} pelanggan valid untuk company: ${globalCompanyId}`);

        

        if (pelangganIds.length <= 10) {
            // JIKA PELANGGAN <= 10, AMBIL SEKALIGUS DENGAN FILTER COMPANY
            const tagihanSnapshot = await db.collection('tagihan')
                .where('pelanggan_id', 'in', pelangganIds)
                .where('company_id', '==', globalCompanyId)  // ⭐ TAMBAH FILTER INI
                .get();

            tagihanSnapshot.forEach(doc => {
                const data = doc.data();
                // ⭐⭐ VALIDASI TAMBAHAN: PASTIKAN TAGIHAN MILIK COMPANY INI ⭐⭐
                if (data.company_id === globalCompanyId) {
                    tagihanData.push({ id: doc.id, data: data });
                } else {
                    console.warn(`⚠️ Tagihan ${doc.id} bukan milik company ini:`, data.company_id);
                }
            });
        } else {
            // JIKA PELANGGAN > 10, AMBIL PER BATCH (FIREBASE LIMIT 10)
            for (let i = 0; i < pelangganIds.length; i += 10) {
                const batchIds = pelangganIds.slice(i, i + 10);
                const batchSnapshot = await db.collection('tagihan')
                    .where('pelanggan_id', 'in', batchIds)
                    .where('company_id', '==', globalCompanyId)  // ⭐ TAMBAH FILTER INI
                    .get();

                batchSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.company_id === globalCompanyId) {
                        tagihanData.push({ id: doc.id, data: data });
                    }
                });
            }
        }

        if (tagihanData.length === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center" style="padding: 40px;">
                        <i class="fas fa-receipt" style="font-size: 48px; color: #e9ecef;"></i>
                        <h4 style="margin-top:15px; color: var(--gray);">Belum Ada Tagihan</h4>
                        <p>Belum ada data tagihan untuk pelanggan Anda.</p>
                        <button class="btn btn-primary mt-2" onclick="openGenerateModal()">
                            <i class="fas fa-bolt"></i> Generate Tagihan Pertama
                        </button>
                    </td>
                </tr>`;
            return;
        }

        console.log(`💰 ${tagihanData.length} tagihan valid untuk company: ${globalCompanyId}`);

        // 3. GROUP BY PELANGGAN (DENGAN VALIDASI EKSTRA)
        const groupedMap = {};

        tagihanData.forEach(item => {
            const t = item.data;
            const pid = t.pelanggan_id;

            // ⭐⭐ VALIDASI: PASTIKAN PELANGGAN ADA DI MAP KITA ⭐⭐
            if (!pelangganMap[pid]) {
                console.warn(`⚠️ Tagihan ${item.id} milik pelanggan ${pid} yang tidak ada di pelangganMap`);
                return; // Skip jika pelanggan tidak valid
            }

            if (!groupedMap[pid]) {
    groupedMap[pid] = {
        pelanggan_id: pid,
        pelanggan_nama: pelangganMap[pid].nama,
        pelanggan_telepon: pelangganMap[pid].telepon,
        pelanggan_alamat: pelangganMap[pid].alamat,
        pelanggan_server: pelangganMap[pid].server || 'Tidak Diketahui',  // ⭐ INI
        pelanggan_koordinat: pelangganMap[pid].koordinat || null,         // ⭐ INI
        list_tagihan: [],
        total_nominal: 0,
        company_id: pelangganMap[pid].company_id
    };
}

            // ⭐⭐ VALIDASI: PASTIKAN TAGIHAN MILIK COMPANY YANG SAMA ⭐⭐
            if (t.company_id !== globalCompanyId) {
                console.warn(`⚠️ Tagihan ${item.id} company_id tidak match:`, t.company_id);
                return;
            }

            groupedMap[pid].list_tagihan.push(t);
            if (t.status !== 'lunas') {
                groupedMap[pid].total_nominal += Number(t.jumlah) || 0;
            }
        });

                const groupedData = Object.values(groupedMap);

// ⭐⭐ FILTER BERDASARKAN SERVER ⭐⭐
let filteredData = [...groupedData];
if (serverFilter) {
    filteredData = filteredData.filter(item => {
        // Cari pelanggan di snapshot
        const pelangganDoc = pelangganSnapshot.docs.find(doc => doc.id === item.pelanggan_id);
        if (!pelangganDoc) return false;

        const pelangganData = pelangganDoc.data();
        return pelangganData.server === serverFilter;
    });
}

// SORTING: BELUM LUNAS DI ATAS, LUNAS DI BAWAH
filteredData.sort((a, b) => {
    const aBelumLunas = a.list_tagihan.filter(t => t.status !== 'lunas').length;
    const bBelumLunas = b.list_tagihan.filter(t => t.status !== 'lunas').length;

    if (bBelumLunas !== aBelumLunas) {
        return bBelumLunas - aBelumLunas;
    }

    return a.pelanggan_nama.localeCompare(b.pelanggan_nama);
});

// 4. PAGINATION (PAKAI filteredData BUKAN groupedData)
const itemsPerPage = 10;
const totalData = filteredData.length; // ⭐ PAKAI DATA YANG SUDAH FILTER
const totalPages = Math.ceil(totalData / itemsPerPage);

if (currentPageTagihan > totalPages) currentPageTagihan = 1;
const startIndex = (currentPageTagihan - 1) * itemsPerPage;
const endIndex = startIndex + itemsPerPage;
const pageData = filteredData.slice(startIndex, endIndex); // ⭐ PAKAI filteredData

// ⭐⭐ DEBUG PAGINATION ⭐⭐
console.log('=== DEBUG PAGINATION ===');
console.log('Server Filter:', serverFilter);
console.log('Filtered Data Length:', filteredData.length);
console.log('Items Per Page:', itemsPerPage);
console.log('Current Page:', currentPagePelanggan);
console.log('Start Index:', startIndex);
console.log('End Index:', endIndex);
console.log('Page Data Length:', pageData.length);
console.log('Page Data Names:', pageData.map(p => p.nama));
console.log('=======================');


        // 5. RENDER TABEL
table.innerHTML = pageData.map((item) => {
    const listBelumLunas = item.list_tagihan.filter(t => t.status !== 'lunas');
    const jumlahBulanBelumLunas = listBelumLunas.length;

    const isAllLunas = jumlahBulanBelumLunas === 0;

    let displayBulan = `<strong>${jumlahBulanBelumLunas} Bulan</strong>`;
    let displayNominal = `<strong>${formatRupiah(item.total_nominal)}</strong>`;

    if (isAllLunas) {
        displayBulan = `<span style="color: var(--gray);">-</span>`;
        displayNominal = `<div style="color: var(--success); font-weight: bold;"><i class="fas fa-check-circle"></i> LUNAS</div>`;
    }

    let tombolBayar = '';
    if (!isAllLunas) {
        const tagihanPertama = listBelumLunas[0];
        const idTagihan = tagihanPertama.id;

        tombolBayar = `
            <button class="btn btn-sm btn-success"
                data-id="${idTagihan}"
                data-pid="${item.pelanggan_id}"
                data-nama="${item.pelanggan_nama}"
                data-nominal="${tagihanPertama.jumlah}"
                data-bulan="${tagihanPertama.bulan}"
                onclick="handleBayarClick(this)"
                title="Bayar Tagihan">
                <i class="fas fa-money-bill-wave"></i> Bayar
            </button>
        `;
    }

    return `
        <tr>
            <td>
    <strong>${item.pelanggan_server}</strong><br>
</td>
            <td>
                <strong>${item.pelanggan_nama}</strong><br>
                <small class="text-muted">${item.pelanggan_telepon}</small>
                ${item.company_id !== globalCompanyId ? '<br><small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Data tidak valid</small>' : ''}
            </td>
            <td>
               <small class="text-muted">-6.2088, 106.8456</small><br>
    <button class="btn btn-sm btn-outline btn-sm" onclick="openGoogleMaps('-6.2088, 106.8456')" title="Buka di Google Maps">
        <i class="fas fa-external-link-alt"></i> Maps
    </button>

            </td>
            <td>
                <strong>${item.pelanggan_alamat}</strong>
            </td>
            <td>
                <span class="badge badge-primary" style="font-size:14px; padding:8px 12px;">
                    ${displayBulan}
                </span>
            </td>
            <td>${displayNominal}</td>
            <td>
                ${isAllLunas
                    ? '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Lunas</span>'
                    : '<span class="badge badge-warning"><i class="fas fa-clock"></i> Belum Lunas</span>'}
            </td>
            <td>
                <div class="btn-group">
                    ${tombolBayar}
                    <button class="btn btn-sm btn-info" onclick="viewTagihanDetails('${item.pelanggan_id}')" title="Detail">
                        <i class="fas fa-list"></i> Detail
                    </button>
                </div>
            </td>
        </tr>
    `;
}).join('');
        // 6. RENDER PAGINATION
        // 6. RENDER PAGINATION (SAMA KAYAK PELANGGAN)
const paginationContainer = document.getElementById('tagihanPagination');
if (paginationContainer) {
    paginationContainer.innerHTML = '';

    if (totalData > 0) {
        const totalPages = Math.ceil(totalData / itemsPerPage);

        if (totalPages > 1) {
            let paginationHTML = '<div class="pagination">';

            // TOMBOL KIRI (<)
            if (currentPageTagihan > 1) {
                paginationHTML += `<a class="page-link" onclick="changePage('tagihan', ${currentPageTagihan - 1})">&laquo;</a>`;
            }

            // ANGKA HALAMAN
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPageTagihan) {
                    paginationHTML += `<span class="page-link active">${i}</span>`;
                } else {
                    paginationHTML += `<a class="page-link" onclick="changePage('tagihan', ${i})">${i}</a>`;
                }
            }

            // TOMBOL KANAN (>)
            if (currentPageTagihan < totalPages) {
                paginationHTML += `<a class="page-link" onclick="changePage('tagihan', ${currentPageTagihan + 1})">&raquo;</a>`;
            }

            paginationHTML += '</div>';
            paginationContainer.innerHTML = paginationHTML;
        }
    }
}

if (window.__fromMapOpenDetail) {
    bukaRiwayatTagihan(window.__fromMapOpenDetail);
    window.__fromMapOpenDetail = null;
}


    } catch (error) {
        console.error("❌ Error load tagihan:", error);
        table.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${error.message}</td></tr>`;
    }
}




// Fungsi untuk membuka Google Maps
function openGoogleMaps(coordinates) {
    if (!coordinates || coordinates.trim() === '') {
        showToast('warning', 'Peta', 'Koordinat tidak tersedia');
        return;
    }

    try {
        // Bersihkan koordinat
        const cleanCoords = coordinates.trim().replace(/\s+/g, '');

        // Validasi format koordinat
        if (!cleanCoords.match(/^-?\d+\.?\d*,\s*-?\d+\.?\d*$/)) {
            showToast('error', 'Error', 'Format koordinat tidak valid');
            return;
        }

        // Buka Google Maps
        const url = `https://www.google.com/maps?q=${cleanCoords}`;
        window.open(url, '_blank');

        showToast('info', 'Peta', 'Membuka Google Maps...');

    } catch (error) {
        console.error("Error open Google Maps:", error);
        showToast('error', 'Error', 'Gagal membuka peta');
    }
}

// Fungsi untuk view di map internal (jika ada)
function viewOnMap(coordinates) {
    // Jika ada peta internal, bisa digunakan
    // Untuk sekarang buka Google Maps
    openGoogleMaps(coordinates);
}


// FUNGSI applyTagihanFilters YANG HARUS ADA
function applyTagihanFilters(data) {
    if (!data || !Array.isArray(data)) {
        console.error("❌ applyTagihanFilters: data bukan array");
        return [];
    }

    const bulanFilter = document.getElementById('filterBulan')?.value || '';
    const statusFilter = document.getElementById('filterStatusTagihan')?.value || '';
    const searchFilter = document.getElementById('searchTagihan')?.value || '';

    return data.filter(tagihan => {
        // Filter bulan
        if (bulanFilter && tagihan.bulan !== bulanFilter) return false;

        // Filter status
        if (statusFilter && tagihan.status !== statusFilter) return false;

        // Filter search
        if (searchFilter) {
            const searchLower = searchFilter.toLowerCase();
            return (
                (tagihan.pelanggan_nama && tagihan.pelanggan_nama.toLowerCase().includes(searchLower)) ||
                (tagihan.id && tagihan.id.toLowerCase().includes(searchLower)) ||
                (tagihan.bulan && tagihan.bulan.includes(searchFilter))
            );
        }

        return true;
    });
}


// ============================================
// FUNGSI PENCARIAN TAGIHAN (SEARCH)
// ============================================

function filterTagihanSearch(keyword) {
    const table = document.getElementById('tagihanTable');
    const rows = table.getElementsByTagName('tr');

    const filterLower = keyword.toLowerCase();

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');

        // Cari di Nama (td 0) atau Alamat (td 1)
        const textNama = cells[0].textContent || "";
        const textAlamat = cells[1].textContent || "";

        if (textNama.toLowerCase().indexOf(filterLower) > -1 ||
            textAlamat.toLowerCase().indexOf(filterLower) > -1) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    }
}


async function executePayAllAndPrint(pelangganId, idsString, totalNominal, bulanString) {
    console.log("💳 PROSES BAYAR & GENERATE GAMBAR STRUK...");

    if (!confirm(`Konfirmasi pembayaran lunas sebesar ${formatRupiah(totalNominal)}?\n\nStruk Gambar akan dibuat & dikirim ke WhatsApp.`)) {
        return;
    }

    try {
        showLoading();

        // 1. UPDATE DATABASE
        const tagihanIds = String(idsString).split(',');
        const batch = db.batch();
        const now = new Date().toISOString();
        const tglHariIni = moment().format('DD-MM-YYYY HH:mm');

        let namaPelanggan = "Pelanggan";
        let teleponPelanggan = "";
        const docRef = await db.collection('pelanggan').doc(pelangganId).get();
        if (docRef.exists) {
            const data = docRef.data();
            namaPelanggan = data.nama;
            teleponPelanggan = data.telepon;
        }

        tagihanIds.forEach(id => {
            const ref = db.collection('tagihan').doc(id);
            batch.update(ref, {
                status: 'lunas',
                tanggal_bayar: tglHariIni,
                metode_bayar: 'Tunai (Bulk)',
                updated_at: now
            });
        });

        await batch.commit();

        // ⭐⭐ AMBIL DATA PERUSAHAAN ⭐⭐
        let namaPerusahaan = 'X-BILL';
        let alamatPerusahaan = 'Jl. Internet Cepat No. 1';

        try {
            if (globalCompanyId) {
                // Cek localStorage
                const savedProfile = localStorage.getItem(`companyProfile_${globalCompanyId}`);
                if (savedProfile) {
                    const profile = JSON.parse(savedProfile);
                    if (profile.companyName) {
                        namaPerusahaan = profile.companyName;
                    }
                    if (profile.companyAddress) {
                        alamatPerusahaan = profile.companyAddress;
                    }
                }

                // Jika tidak ada di localStorage, cek database
                if (namaPerusahaan === 'X-BILL') {
                    const companyDoc = await db.collection('company_settings').doc(globalCompanyId).get();

                    if (companyDoc.exists) {
                        const data = companyDoc.data();
                        if (data.companyName) {
                            namaPerusahaan = data.companyName;
                        }
                        if (data.companyAddress) {
                            alamatPerusahaan = data.companyAddress;
                        }
                    }
                }
            }
        } catch (companyError) {
            console.log('Gagal ambil data perusahaan:', companyError);
        }

        // 2. GENERATE HTML STRUK (HIDDEN)
        const strukContainer = document.createElement('div');
        strukContainer.style.position = 'absolute';
        strukContainer.style.left = '-9999px';
        strukContainer.style.top = '0';
        strukContainer.style.width = '300px';
        strukContainer.style.background = 'white';
        strukContainer.style.padding = '10px';
        strukContainer.style.fontFamily = 'monospace';
        strukContainer.style.fontSize = '12px';



        // Isi HTML Struk - ⭐⭐ PAKAI NAMA PERUSAHAAN YANG SUDAH DIAMBIL ⭐⭐
        strukContainer.innerHTML = `
            <div style="text-align: center; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px;">
                <h3 style="margin: 0; font-size: 16px;">${namaPerusahaan}</h3>
                <p style="margin: 0; font-size: 10px;">${alamatPerusahaan}</p>
            </div>

            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Pelanggan:</span>
                    <strong>${namaPelanggan}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Tanggal:</span>
                    <span>${tglHariIni}</span>
                </div>
            </div>

            <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 10px 0; margin: 10px 0; text-align: center;">
                <strong>BUKTI PEMBAYARAN</strong>
            </div>

            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between;">
                    <span>Item:</span>
                    <span>Pelunasan Tagihan</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>Bulan:</span>
                    <span>${bulanString}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <span>Total:</span>
                    <strong>${formatRupiah(totalNominal)}</strong>
                </div>
            </div>

            <div style="text-align: center; margin-top: 15px; font-weight: bold;">
                STATUS: LUNAS
            </div>

            <div style="text-align: center; margin-top: 20px; border-top: 1px solid #000; padding-top: 10px; font-size: 10px;">
                Terima Kasih<br>
                Simpan struk ini sebagai bukti pembayaran yang sah.
            </div>
        `;

        document.body.appendChild(strukContainer);

        // 3. CONVERT HTML JADI GAMBAR
        await new Promise(r => setTimeout(r, 500));

        const canvas = await html2canvas(strukContainer, {
            scale: 2,
            useCORS: true,
            backgroundColor: "#ffffff"
        });

        // Convert Canvas ke BLOB
       canvas.toBlob(function(blob) {

    document.body.removeChild(strukContainer);
    if (!blob) return;

    const reader = new FileReader();
    reader.onloadend = function () {

        let noTujuan = (teleponPelanggan || "").replace(/\D/g, "");

        if (window.Android && Android.sendImageToWhatsApp) {
            Android.sendImageToWhatsApp(
                noTujuan,
                reader.result
            );
        }
    };

    reader.readAsDataURL(blob);

}, 'image/png');



            hideLoading();
            forceCloseModal('modalDetailTagihan');
            showToast('info', 'Gambar Siap', 'Struk Gambar dibuat. Silakan Share gambar tersebut ke WA.');

            if (currentPage === 'tagihan') await loadTagihanData();
            if (currentPage === 'dashboard') await renderDashboard();



    } catch (error) {
        hideLoading();
        console.error("Error Generate Gambar:", error);
        showToast('error', 'Gagal', 'Gagal membuat gambar struk: ' + error.message);
    }
}


// FUNGSI INJECT NAMA PERUSAHAAN KE STRUK
function syncCompanyNameToStruk() {
    const nameInput = document.getElementById('companyName');
    const displayTarget = document.getElementById('displayStrukCompanyName');

    if (nameInput && displayTarget) {
        // Cek apakah ada isinya
        if (nameInput.value && nameInput.value.trim() !== "") {
            displayTarget.textContent = nameInput.value;
            console.log("✅ Nama Perusahaan Struk diupdate: " + nameInput.value);
        } else {
            // Kalau kosong, balikin ke default
            displayTarget.textContent = "X-BILL";
        }
    }
}



// ============================================
// FUNGSI INISIALISASI DATABASE OTOMATIS
// ============================================

async function initializeDatabase() {
    console.log("🚀 Memulai inisialisasi database...");

    try {
        // 1. CEK APAKAH DATABASE SUDAH ADA
        console.log("📊 Mengecek struktur database...");

        // Cek apakah ada data di collections
        const [pelangganSnapshot, paketSnapshot, tagihanSnapshot] = await Promise.all([
            db.collection('pelanggan').limit(1).get(),
            db.collection('paket').limit(1).get(),
            db.collection('tagihan').limit(1).get()
        ]);

        const hasData = !pelangganSnapshot.empty || !paketSnapshot.empty || !tagihanSnapshot.empty;

        if (hasData) {
            console.log("✅ Database sudah ada, tidak perlu inisialisasi");
            return;
        }

        console.log("📝 Database kosong, membuat data awal...");

        // 2. BUAT COLLECTION PAKET TERLEBIH DAHULU
        console.log("📦 Membuat data paket internet...");
        await createInitialPackages();

        // 3. BUAT COLLECTION PELANGGAN
        console.log("👥 Membuat data pelanggan contoh...");
        await createInitialCustomers();

        // 4. BUAT COLLECTION TAGIHAN
        console.log("💰 Membuat data tagihan contoh...");
        await createInitialInvoices();

        // 5. BUAT COLLECTION AKTIVITAS
        console.log("📋 Membuat log aktivitas...");
        await createInitialActivities();

        // 6. BUAT INDEX OTOMATIS (jika perlu)
        console.log("🔧 Mengecek index...");
        await checkAndCreateIndexes();


    } catch (error) {
        console.error("❌ Error inisialisasi database:", error);
        showToast('error', 'Error', 'Gagal menginisialisasi database: ' + error.message);
    }
}

// FUNGSI UNTUK MEMBUAT PAKET INTERNET AWAL
async function createInitialPackages() {
    const packages = [];

    const batch = db.batch();

    packages.forEach(pkg => {
        const paketRef = db.collection('paket').doc(pkg.id);
        batch.set(paketRef, pkg);
    });

     if (packages.length > 0) {
        await batch.commit();
        console.log(`✅ ${packages.length} paket berhasil dibuat`);
    } else {
        console.log("⚠️ Tidak ada data paket dummy untuk dibuat.");
    }

    await batch.commit();
    console.log(`✅ ${packages.length} paket berhasil dibuat`);
}

// FUNGSI UNTUK MEMBUAT PELANGGAN AWAL
async function createInitialCustomers() {
    const customers = [];

    const batch = db.batch();

    customers.forEach(customer => {
        const custRef = db.collection('pelanggan').doc(customer.id);
        batch.set(custRef, customer);
    });

    if (customers.length > 0) {
        await batch.commit();
        console.log(`✅ ${customers.length} pelanggan berhasil dibuat`);
    } else {
        console.log("⚠️ Tidak ada data pelanggan dummy untuk dibuat.");
    }

    await batch.commit();
    console.log(`✅ ${customers.length} pelanggan berhasil dibuat`);
}

// FUNGSI UNTUK MEMBUAT TAGIHAN AWAL
async function createInitialInvoices() {
    const invoices = [];

    const batch = db.batch();

    invoices.forEach(invoice => {
        const invoiceRef = db.collection('tagihan').doc(invoice.id);
        batch.set(invoiceRef, invoice);
    });

     if (invoices.length > 0) {
        await batch.commit();
        console.log(`✅ ${invoices.length} tagihan berhasil dibuat`);
    } else {
        console.log("⚠️ Tidak ada data tagihan dummy untuk dibuat.");
    }

    await batch.commit();
    console.log(`✅ ${invoices.length} tagihan berhasil dibuat`);
}

// FUNGSI UNTUK MEMBUAT AKTIVITAS AWAL
async function createInitialActivities() {
    const activities = [];

    const batch = db.batch();

    activities.forEach((activity, index) => {
        const activityRef = db.collection('aktivitas').doc(`ACT_${Date.now()}_${index}`);
        batch.set(activityRef, activity);
    });

    if (activities.length > 0) {
        await batch.commit();
        console.log(`✅ ${activities.length} aktivitas berhasil dibuat`);
    } else {
        console.log("⚠️ Tidak ada data aktivitas dummy untuk dibuat.");
    }

    await batch.commit();
    console.log(`✅ ${activities.length} aktivitas berhasil dibuat`);
}

// FUNGSI UNTUK CEK DAN BUAT INDEX
async function checkAndCreateIndexes() {
    try {
        console.log("🔍 Mengecek index Firestore...");

        // Tidak ada fungsi langsung untuk buat index via JavaScript
        // User harus buat manual di Firebase Console
        console.log("ℹ️ Untuk performa optimal, buat index di Firebase Console:");
        console.log("1. Buka https://console.firebase.google.com/");
        console.log("2. Pilih project Anda");
        console.log("3. Pilih Firestore Database > Indexes");
        console.log("4. Buat index untuk query yang sering digunakan");

    } catch (error) {
        console.error("❌ Error cek index:", error);
    }
}


// ==========================================
// PERBAIKAN DARURAT: SIMPAN COMPANY ID SAAT LOGIN
// ==========================================

// Fungsi ini akan dipanggil otomatis setelah login berhasil
async function saveUserSessionAndInit() {
    if (!currentUser) {
        console.warn("Tidak ada user untuk disimpan.");
        return;
    }

    // 1. Siapkan data lengkap user
    let finalCompanyId = globalCompanyId; // Cek apakah sudah ada global

    // 2. Jika global kosong, coba ambil dari localStorage
    if (!finalCompanyId) {
        const storedUser = localStorage.getItem('xbill_user');
        if (storedUser) {
            try {
                const parsedUser = JSON.parse(storedUser);
                if (parsedUser.company_id) {
                    finalCompanyId = parsedUser.company_id;
                }
            } catch (e) {}
        }
    }

    // 3. Jika masih kosong, beri ID Default (COMP_DEFAULT)
    if (!finalCompanyId) {
        finalCompanyId = "COMP_DEFAULT";
        console.warn("⚠️ Company ID masih kosong, pakai Default.");
    }

    // 4. Simpan ke GLOBAL & LOCALSTORAGE (Agar sinkron)
    globalCompanyId = finalCompanyId;

    // Update user object di memori
    currentUser.company_id = finalCompanyId;

    // Update localStorage user object
    const userStorageData = JSON.parse(localStorage.getItem('xbill_user') || '{}');
    userStorageData.company_id = finalCompanyId;
    localStorage.setItem('xbill_user', JSON.stringify(userStorageData));

    console.log("💾 Company ID FINAL:", globalCompanyId);
}

// ==========================================
// PANGGIL FUNGSI INI DI AKHIR SCRIPT LOGIN
// ==========================================
// Cari bagian login berhasil, dan tambahkan baris ini:
// saveUserSessionAndInit();

// ============================================
// ROUTING & PAGE MANAGEMENT
// ============================================

async function loadPage(page) {
    console.trace("🔥 loadPage TRACE:", page);

    console.log("🔥 loadPage DIPANGGIL:", page);

     // ⭐⭐ TAMBAH INI: ⭐⭐
    // Tutup semua modal saat ganti halaman
    document.querySelectorAll('.modal-overlay.show').forEach(modal => {
        modal.classList.remove('show');
        modal.classList.add('hidden');
    });
    document.body.style.overflow = 'auto';
    // ⭐⭐ SAMPAI SINI ⭐⭐

    console.log("🔄 Loading Page:", page);

    // 1. AMBIL ROLE USER SAAT INI
    const currentRole = currentUser ? currentUser.role : 'admin';
    console.log("🔑 Current Role:", currentRole);

    // 2. CEK AKSES BERDASARKAN ROLE
    if (currentRole === 'staff_billing') {
        const allowedPages = ['dashboard', 'tagihan', 'tunggakan', 'setting'];

        if (!allowedPages.includes(page)) {
            console.warn("⛔ Akses Ditolak untuk Role:", currentRole, "Halaman:", page);
            showToast('error', 'Akses Ditolak', 'Anda tidak memiliki izin mengakses menu ini.');

            // Redirect otomatis ke halaman Tagihan
            page = 'tagihan';
        }
    }

    // 3. ATUR TAMPILAN MENU NAVIGASI (VISIBILITAS)
    if (currentRole === 'staff_billing') {
        document.querySelectorAll('.nav-item').forEach(nav => {
            const navPage = nav.getAttribute('data-page');

            // HANYA TAMPILKAN MENU YANG DIIJINKAN
            // Dashboard, Tagihan, Tunggakan, Setting
            if (['dashboard', 'tagihan', 'tunggakan', 'setting'].includes(navPage)) {
                nav.style.display = 'flex';

                // KHUSUS MENU SETTING: Kita ubah teks/icon sedikit biar beda atau biarkan default
                if (navPage === 'setting') {
                    // Opsional: Ubah icon setting jadi icon gembok (keamanan)
                    // const icon = nav.querySelector('i');
                    // if(icon) icon.className = 'fas fa-shield-alt';
                }
            } else {
                // SEMBUNYIKAN MENU LAINNYA (Pelanggan, Paket, Laporan, dll)
                nav.style.display = 'none';
            }
        });
    } else {
        // Jika Admin, pastikan semua menu tampil normal
        document.querySelectorAll('.nav-item').forEach(nav => {
            nav.style.display = 'flex';
        });
    }

    // Update active nav
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-page') === page) {
            item.classList.add('active');
        }
    });



    const mainContent = document.getElementById('mainContent');
    if (!mainContent) {
        console.error("❌ Error: #mainContent tidak ditemukan");
        return;
    }

    let pageHTML = '';


let cachedDashboardHTML = '';


    try {
        switch(page) {
           case 'dashboard':

                // 1. SELALU render HTML dashboard
                pageHTML = await getDashboardHTML();
                mainContent.innerHTML = pageHTML;

                // 🔥 TUNGGU DOM SELESAI DIBUAT
                await renderDashboard();


                // 2. Setup container map
                const mapContainer = document.getElementById('mapContainer');
                if (mapContainer) {
                    mapContainer.style.display = 'block';
                    mapContainer.style.visibility = 'visible';
                    mapContainer.style.height = '400px';
                    mapContainer.style.width = '100%';
                }



                console.log('🔄 Dashboard render logic berat');

                // reset state
                window._dashboardLoaded = true;
                window._dashboardDirty = false;




                // 4. INIT MAP (PASTI NEMPEL KE DOM BARU)
// 4. MAP FIX: REBIND KE DOM BARU (JANGAN REMOVE)
// 4. INIT MAP (FIX LOGIN + NAV)
const waitForMapDOM = () => {
    const el = document.getElementById('pelangganMap');
    if (!el || !el.isConnected) {
        requestAnimationFrame(waitForMapDOM);
        return;
    }

    // 🔥 HANCURKAN TOTAL MAP LAMA
    if (window.pelangganMap) {
        window.pelangganMap.off();
        window.pelangganMap.remove();
        window.pelangganMap = null;
    }

    window.mapMarkers = [];

    // 🔥 FORCE DOM STABIL
    el.style.display = 'block';
    el.offsetHeight; // ⬅️ WAJIB

    // 🔥 INIT SETELAH DOM BENAR-BENAR ADA
    initPelangganMap();

    requestAnimationFrame(() => {
        if (!window.pelangganMap) return;

        // 🔥 RESET INTERNAL LEAFLET
        window.pelangganMap.setView(
            [-6.2088, 106.8456],
            13,
            { animate: false }
        );

        loadPelangganMap();
        window.pelangganMap.invalidateSize();
    });
};

// waitForMapDOM();



break;



            case 'pelanggan':
     pageHTML = await getPelangganHTML();
                mainContent.innerHTML = pageHTML;

                // TAMBAH INI ↓↓↓
                setTimeout(async () => {
                    await loadPaketData();
                    await loadPelangganData();
                    await loadServerOptions(); // ⭐ TAMBAHKAN INI

                    // ⭐⭐ TAMBAHKAN INI SETELAH loadServerOptions: ⭐⭐
                    const dropdown = document.getElementById('filterServer');
                    if (dropdown) {
                        // Biarkan onchange natural ke handleServerChange()
                    }

                }, 0);

                break;

            case 'paket':
                if (currentRole === 'staff_billing') {
                    showToast('error', 'Akses Ditolak', 'Menu ini hanya untuk Admin.');
                    loadPage('tagihan');
                    return;
                }
                pageHTML = await getPaketHTML();
                mainContent.innerHTML = pageHTML;
                await loadPaketData();
                break;

            case 'tagihan':
    pageHTML = await getTagihanHTML();
    mainContent.innerHTML = pageHTML;
    await loadTagihanData();
    await loadServerOptions();

    // ⭐⭐ CEK URL HASH UNTUK AUTO-OPEN MODAL ⭐⭐
    setTimeout(() => {
        // Parse URL hash: #tagihan&open=TAGIHAN_ID
        const hash = window.location.hash;
        console.log("🔍 Checking hash for auto-open:", hash);

        if (hash.includes('&open=')) {
            const tagihanId = hash.split('&open=')[1];
            if (tagihanId && tagihanId.length > 5) {
                console.log("🚀 Auto-opening tagihan modal for:", tagihanId);

                // AMBIL DATA DAN BUKA MODAL
                db.collection('tagihan').doc(tagihanId).get().then(doc => {
                    if (doc.exists) {
                        // PANGGIL FUNGSI editTagihan YANG SUDAH ADA
                        if (typeof editTagihan === 'function') {
                            console.log("📋 Opening modal for tagihan:", tagihanId);
                            editTagihan(tagihanId, doc.data());

                            // CLEAR HASH SETELAH BUKA
                            window.location.hash = 'tagihan';
                        }
                    }
                });
            }
        }
    }, 1500); // Delay 1.5 detik biar halaman selesai load

    break;

            case 'tunggakan':
                pageHTML = await getTunggakanHTML();
                mainContent.innerHTML = pageHTML;
                setTimeout(async () => {
                    await loadTunggakanData();
                }, 50);
                break;

            case 'laporan':
    pageHTML = await getLaporanHTML();
    mainContent.innerHTML = pageHTML;

    // Inisialisasi peta setelah dashboard dimuat
        setTimeout(() => {
            initPelangganMap();
            loadPelangganMap();
        }, 300);

    // --- KODE RAHASIA: AUTO KLIK GENERATE LAPORAN ---
    setTimeout(() => {
        console.log("⚡ Auto-generate Laporan...");
        generateLaporan();
    }, 500); // Delay setengah detik biar loading UI selesai dulu
    break;

                        case 'setting':
                console.log("⚙️ Load Page: Setting");
                pageHTML = await getSettingHTML();
                mainContent.innerHTML = pageHTML;

                // ⭐⭐ FIX: PANGGIL FUNGSI ISI DATA ⭐⭐
                setTimeout(async () => {
                    await loadCompanyProfile(); // PANGGIL YANG BENAR
                    await loadBrandingSettings();
                }, 100);
                break;

            default:
                pageHTML = `<div class="page"><h3>Halaman tidak ditemukan</h3></div>`;
                mainContent.innerHTML = pageHTML;
        }

               // ⭐⭐ PERBAIKAN KHUSUS UNTUK MAP: Reset peta setiap kali kembali ke dashboard ⭐⭐
        // ⭐⭐ PERBAIKAN KHUSUS UNTUK MAP: Reset ukuran map saat kembali ke dashboard ⭐⭐
if (page === 'dashboard') {
    setTimeout(() => {
        const mapContainer = document.getElementById('pelangganMap');
        if (mapContainer && mapContainer.offsetParent !== null) {
            if (window.pelangganMap) {
                window.pelangganMap.invalidateSize(true);
                console.log("✅ Map resize ulang");
            }
        }
    }, 200);
}

        console.log("✅ Page Render Selesai:", page);

    } catch (error) {
        console.error("❌ Error Fatal di loadPage:", error);
        const mainContent = document.getElementById('mainContent');
        if (mainContent) {
            mainContent.innerHTML = `
                <div class="page" style="padding: 50px; text-align: center;">
                    <h3 style="color:red">Terjadi Kesalahan</h3>
                    <p>${error.message}</p>
                    <button class="btn btn-primary" onclick="location.reload()">Refresh Halaman</button>
                </div>
            `;
        }
    }
}

// TAMBAHKAN TOMBOL RESET DATABASE DI HALAMAN IMPORT/EXPORT
// Modifikasi getImportExportHTML():
async function getImportExportHTML() {
    return `
        <div class="page import-export-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-file-import"></i> Import & Export Data</h2>
                <button class="btn btn-danger" onclick="resetDatabase()" title="Reset semua data ke kondisi awal">
                    <i class="fas fa-database"></i> Reset Database
                </button>
            </div>

            <!-- ... sisa kode tetap ... -->

            <div class="card mt-4">
                <div class="card-header">
                    <h3><i class="fas fa-database"></i> Tools Database</h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Perhatian!</strong> Tindakan ini akan menghapus semua data dan membuat ulang data contoh.
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-warning" onclick="initializeDatabase()">
                            <i class="fas fa-play"></i> Inisialisasi Database
                        </button>
                        <button class="btn btn-danger" onclick="resetDatabase()">
                            <i class="fas fa-trash"></i> Reset & Buat Ulang
                        </button>
                        <button class="btn btn-info" onclick="checkDatabaseStatus()">
                            <i class="fas fa-chart-bar"></i> Status Database
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// FUNGSI RESET DATABASE
async function resetDatabase() {
    if (!confirm('⚠️ PERINGATAN!\n\nAnda akan menghapus SEMUA data dan membuat ulang data contoh.\n\nLanjutkan?')) {
        return;
    }

    try {
        showLoading();
        console.log("🔄 Memulai reset database...");

        // Hapus semua collections
        const collections = ['pelanggan', 'paket', 'tagihan', 'aktivitas'];

        for (const collectionName of collections) {
            console.log(`🗑️ Menghapus collection: ${collectionName}`);

            const snapshot = await db.collection(collectionName).get();
            const batch = db.batch();

            snapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });

            await batch.commit();
            console.log(`✅ ${snapshot.size} dokumen dihapus dari ${collectionName}`);
        }

        // Reset flag
        window.databaseInitialized = false;

        // Buat ulang data
        await initializeDatabase();

        hideLoading();
        showToast('success', 'Reset Berhasil', 'Database berhasil direset dan data contoh dibuat ulang');

        // Redirect ke dashboard
        loadPage('dashboard');

    } catch (error) {
        console.error("❌ Error reset database:", error);
        hideLoading();
        showToast('error', 'Error', 'Gagal reset database: ' + error.message);
    }
}

// FUNGSI CEK STATUS DATABASE
async function checkDatabaseStatus() {
    try {
        showLoading();

        const collections = ['pelanggan', 'paket', 'tagihan', 'aktivitas'];
        let result = '<h4>Status Database:</h4><ul>';

        for (const collectionName of collections) {
            const snapshot = await db.collection(collectionName).get();
            result += `<li><strong>${collectionName}:</strong> ${snapshot.size} dokumen</li>`;
        }

        result += '</ul>';

        hideLoading();

        // Tampilkan modal dengan status
        const modal = document.createElement('div');
        modal.className = 'modal-overlay show';
        modal.innerHTML = `
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-database"></i> Status Database</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    ${result}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="initializeDatabase()">
                        <i class="fas fa-play"></i> Inisialisasi
                    </button>
                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                        Tutup
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

    } catch (error) {
        console.error("Error cek status database:", error);
        hideLoading();
        showToast('error', 'Error', 'Gagal cek status database');
    }
}


// DI showApp() ATAU loadPage():
function updateUIBasedOnRole() {
  const role = localStorage.getItem('userRole');

  // Sembunyikan menu untuk karyawan
  if (role === 'karyawan') {
    document.querySelector('[data-page="paket"]').style.display = 'none';
    document.querySelector('[data-page="import-export"]').style.display = 'none';
    document.querySelector('[data-page="laporan"]').style.display = 'none';
  }



  // Update nama user di navbar
  document.getElementById('userRole').textContent =
    role === 'admin' ? 'Administrator' : 'Karyawan';
}

        // ============================================
        // CRUD FUNCTIONS - PELANGGAN
        // ============================================

        // PERBAIKAN: GANTI FUNGSI showAddPelangganModal
function showAddPelangganModal() {
    // Reset form
    document.getElementById('formPelanggan').reset();
    document.getElementById('pelangganId').value = '';

    // Set tanggal default
    document.getElementById('pelangganTanggalPasang').value = new Date().toISOString().split('T')[0];

    // ⭐⭐ TAMBAHKAN INI: ⭐⭐
    loadPaketSelectOptions();

    // Tampilkan modal
    showModal('modalPelanggan');

    setTimeout(loadServerDropdownToModal, 0);

}

console.log("✅ Function updated");

function setupAutoProrata() {
    const tglInput = document.getElementById('pelangganTanggalPasang');
    const hargaInput = document.getElementById('pelangganHarga');

    if (!tglInput || !hargaInput) return;

    tglInput.addEventListener('change', function() {
        const tglPasang = new Date(this.value);
        const sekarang = new Date();
        const harga = parseInt(hargaInput.value) || 0;

        if (harga > 0 &&
            tglPasang.getMonth() === sekarang.getMonth() &&
            tglPasang.getFullYear() === sekarang.getFullYear()) {

            const hariDalamBulan = 30;
            const sisaHari = hariDalamBulan - tglPasang.getDate() + 1;
            const prorata = Math.round((harga / hariDalamBulan) * sisaHari);

            // TAMPILKAN INFO PRORATA
            showToast('info', 'Prorata',
                `Bulan pertama: ${sisaHari} hari = ${formatRupiah(prorata)}`);

            // OPSIONAL: Auto-update harga field
            // hargaInput.value = prorata;
        }
    });
}

// PANGGIL DI showAddPelangganModal():
// setupAutoProrata();
async function generateTagihanArrears(pelangganId, pelangganData, tglPasang) {
    const tglPasangObj = new Date(tglPasang);

    // 1. TAGIHAN UNTUK BULAN PERTAMA (PRORATA)
    // Tagihan bulan berikutnya untuk penggunaan bulan pertama
    const bulanTagihan1 = moment(tglPasang).add(1, 'month').format('MM-YYYY');

    // Hitung prorata bulan pertama
    const prorata = hitungProrataBulanPertama(pelangganData.harga, tglPasang);

    // Buat tagihan prorata (jatuh tempo: 10 bulan berikutnya)
    await buatTagihanArrears(pelangganId, pelangganData, {
        bulan: bulanTagihan1,
        jumlah: prorata,
        keterangan: `Prorata ${moment(tglPasang).format('MMM YYYY')}`,
        jatuh_tempo: moment(bulanTagihan1).date(10).format('DD-MM-YYYY')
    });

    // 2. TAGIHAN BULAN-BULAN BERIKUTNYA (FULL)
    // Mulai dari bulan setelah bulan pertama
    const mulaiBulanFull = moment(tglPasang).add(2, 'months');

    for (let i = 0; i < 12; i++) { // 12 bulan ke depan
        const bulanTagihan = mulaiBulanFull.clone().add(i, 'months').format('MM-YYYY');
        const jatuhTempo = mulaiBulanFull.clone().add(i, 'months').date(10).format('DD-MM-YYYY');

        await buatTagihanArrears(pelangganId, pelangganData, {
            bulan: bulanTagihan,
            jumlah: pelangganData.harga,
            keterangan: `Tagihan reguler`,
            jatuh_tempo: jatuhTempo
        });
    }
}

function hitungProrataBulanPertama(hargaBulanan, tglPasang) {
    const tgl = new Date(tglPasang);
    const tahun = tgl.getFullYear();
    const bulan = tgl.getMonth();
    const hariDalamBulan = new Date(tahun, bulan + 1, 0).getDate();
    const sisaHari = hariDalamBulan - tgl.getDate() + 1;

    return Math.round((hargaBulanan / hariDalamBulan) * sisaHari);
}


// Helper terpisah untuk isi dropdown agar rapi
function populatePaketOptions() {
    const paketSelect = document.getElementById('pelangganPaket');
if (paketSelect && paketData) {
    paketSelect.innerHTML = '<option value="">-- Pilih Paket --</option>';

    paketData.forEach(p => {
        const option = document.createElement('option');
        option.value = p.nama;
        option.textContent = p.nama; // ← HANYA NAMA
        option.dataset.harga = p.harga;
        paketSelect.appendChild(option);
    });

    paketSelect.onchange = function() {
        const harga = this.options[this.selectedIndex].dataset.harga;
        document.getElementById('pelangganHarga').value = harga || '';
    };
}
}



// 2. FUNGSI LOAD TEMPLATE PESAN
async function loadMessageTemplates() {
    try {
        console.log("📋 Memuat template pesan...");

        showLoading();

        // AMBIL DARI COLLECTION message_templates
        const templateRef = db.collection('message_templates').doc(globalCompanyId);
        const templateDoc = await templateRef.get();

        if (templateDoc.exists) {
            const templateData = templateDoc.data();

            // ISI FORM DENGAN DATA DARI DATABASE
            document.getElementById('templateReminder3Days').value =
                templateData.reminder_3hari || '';

            document.getElementById('templateReminder1Day').value =
                templateData.reminder_1hari || '';

            document.getElementById('templateOverdue').value =
                templateData.reminder_overdue || '';

            document.getElementById('templatePaymentConfirmed').value =
                templateData.payment_confirmed || '';

            document.getElementById('templateNewInvoice').value =
                templateData.new_invoice || '';

            console.log("✅ Template dimuat dari database");

        } else {
            // JIKA BELUM ADA, ISI DENGAN DEFAULT
            console.log("ℹ️ Template belum ada, menggunakan default");

            document.getElementById('templateReminder3Days').value =
                `Yth. [nama_pelanggan],\nTagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan] akan jatuh tempo pada [jatuh_tempo].\nSilakan lakukan pembayaran sebelum jatuh tempo.\nTerima kasih.\n[nama_perusahaan]`;

            document.getElementById('templateNewInvoice').value =
                `Yth. [nama_pelanggan],\nTagihan bulan [bulan_tagihan] sebesar [jumlah_tagihan] telah tersedia.\nJatuh tempo: [jatuh_tempo]\nLink pembayaran: [link_pembayaran]\nTerima kasih.\n[nama_perusahaan]`;
        }

        hideLoading();

    } catch (error) {
        hideLoading();
        console.error("❌ Error load templates:", error);
        showToast('error', 'Gagal', 'Gagal memuat template: ' + error.message);
    }
}

// 3. FUNGSI SHOW MODAL DENGAN LOAD DATA
function showMessageTemplates() {
    console.log("🔘 Membuka modal template pesan");

    // Tampilkan modal
    showModal('modalMessageTemplates');

    // Load data setelah modal terbuka
    setTimeout(() => {
        loadMessageTemplates();
    }, 200);
}

        // ============================================
// FUNGSI SIMPAN PELANGGAN (FIX EDIT)
// ============================================

async function savePelanggan() {
    try {
        // Ambil nilai dari form

        const pelangganId = document.getElementById('pelangganId').value;
        const server= document.getElementById('pelangganServer').value.trim();
        const nama = document.getElementById('pelangganNama').value.trim();
        const telepon = document.getElementById('pelangganTelepon').value.trim();
        const alamat = document.getElementById('pelangganAlamat').value.trim();
        const paket = document.getElementById('pelangganPaket').value;
        const harga = document.getElementById('pelangganHarga').value;
        const tanggalPasang = document.getElementById('pelangganTanggalPasang').value;
        const status = document.getElementById('pelangganStatus').value;
        const koordinat = document.getElementById('pelangganKoordinat').value.trim();
        const catatan = document.getElementById('pelangganCatatan').value;

        // Validasi
        if (!nama || !telepon || !alamat || !paket || !harga || !tanggalPasang) {
            showToast('error', 'Validasi Gagal', 'Harap isi semua field yang wajib');
            return;
        }

        // Validasi nomor telepon (harus angka)
        const teleponAngka = telepon.replace(/\D/g, '');
        if (teleponAngka !== telepon) {
            showToast('error', 'Validasi Gagal', 'Nomor telepon hanya boleh mengandung angka');
            return;
        }

        // Validasi minimal panjang telepon
        if (telepon.length < 10) {
            showToast('error', 'Validasi Gagal', 'Nomor telepon minimal 10 digit');
            return;
        }

        // Validasi harga harus angka
        if (isNaN(parseFloat(harga)) || parseFloat(harga) <= 0) {
            showToast('error', 'Validasi Gagal', 'Harga harus angka dan lebih dari 0');
            return;
        }

        showLoading();

        // Pastikan company_id ada
        if (!globalCompanyId) {
            await ensureCompanyId();
        }

        // Data untuk disimpan
        const pelangganData = {
            server: document.getElementById('pelangganServer').value,
            nama: nama.toUpperCase(),
            telepon: telepon,
            alamat: alamat.toUpperCase(),
            paket: paket,
            harga: parseFloat(harga),
            tanggal_pasang: tanggalPasang,
            status: status,
            koordinat: koordinat,
            catatan: catatan,
            company_id: globalCompanyId,
            updated_at: new Date().toISOString()
        };

        let message = '';
        let isNew = !pelangganId;

        // ⭐⭐ AMBIL DATA LAMA JIKA UPDATE ⭐⭐
        let oldData = null;
        if (pelangganId) {
            const oldDoc = await db.collection('pelanggan').doc(pelangganId).get();
            if (oldDoc.exists) oldData = oldDoc.data();
        }

                if (pelangganId) {
            // Update existing
            await db.collection('pelanggan').doc(pelangganId).update(pelangganData);
            message = 'Data pelanggan berhasil diperbarui';

            // ===== TAMBAHKAN INI: UPDATE DATA TAGIHAN =====
            try {
                // Cari semua tagihan milik pelanggan ini
                const tagihanSnapshot = await db.collection('tagihan')
                    .where('pelanggan_id', '==', pelangganId)
                    .where('company_id', '==', globalCompanyId)
                    .get();

                if (!tagihanSnapshot.empty) {
                    console.log(`📝 Update ${tagihanSnapshot.size} tagihan untuk ${nama}`);

                    const batch = db.batch();
                    tagihanSnapshot.forEach(doc => {
                        // Update field pelanggan_nama di setiap tagihan
                        batch.update(doc.ref, {
                            pelanggan_nama: nama.toUpperCase() // pakai nama baru
                        });
                    });

                    await batch.commit();
                    console.log('✅ Tagihan berhasil diupdate');
                }
            } catch (tagihanError) {
                console.error('Gagal update tagihan:', tagihanError);
                // Tetap lanjut, jangan sampai error di sini mengganggu proses utama
            }
            // ===== SELESAI TAMBAHAN =====

        } else {
            // Add new
            pelangganData.created_at = new Date().toISOString();
            const newDocRef = await db.collection('pelanggan').add(pelangganData);
            message = 'Pelanggan baru berhasil ditambahkan';
        }



        // ===============================
        // 🔥 RESET CACHE PELANGGAN (WAJIB)
        // ===============================
        window._pelangganCache = null;
        window._pelangganCacheTime = 0;


        // ⭐⭐ LOG AKTIVITAS DETAIL ⭐⭐
        try {
            let detailPerubahan = "";

            if (!isNew && oldData) {
                // CEK PERUBAHAN
                if (oldData.nama !== pelangganData.nama) {
                    detailPerubahan += `Nama: "${oldData.nama}" → "${pelangganData.nama}". `;
                }
                if (oldData.paket !== pelangganData.paket) {
                    detailPerubahan += `Paket: "${oldData.paket}" → "${pelangganData.paket}". `;
                }
                if (oldData.harga !== pelangganData.harga) {
                    detailPerubahan += `Harga: ${formatRupiah(oldData.harga)} → ${formatRupiah(pelangganData.harga)}. `;
                }
                if (oldData.status !== pelangganData.status) {
                    detailPerubahan += `Status: "${oldData.status}" → "${pelangganData.status}". `;
                }
            }

            const aktivitasText = isNew
                ? `TAMBAH PELANGGAN - ${nama} | Paket: ${paket} | Harga: ${formatRupiah(pelangganData.harga)}`
                : `UPDATE PELANGGAN - ${nama} | ${detailPerubahan || "Data diperbarui"}`;

            await db.collection('aktivitas').add({
                aktivitas: aktivitasText,
                user: currentUser?.email || "Admin",
                timestamp: new Date().toISOString(),
                company_id: globalCompanyId
            });

        } catch (logError) {
            console.log("Log gagal:", logError);
        }

        // Tutup modal
        hideModal('modalPelanggan');

        currentPagePelanggan = 1;

        // 🔥 Reset cache biar ambil data terbaru
        window._pelangganCache = null;
        window._pelangganCacheTime = 0;

        // Refresh data
        await loadPelangganData();

                // Refresh data tagihan juga (kalau sedang di halaman tagihan)
        if (currentPage === 'tagihan') {
            await loadTagihanData();
        }

        // Tampilkan pesan sukses
        hideLoading();
        showToast('success', 'Berhasil', message);

    } catch (error) {
        console.error("Error saving pelanggan:", error);
        hideLoading();
        showToast('error', 'Error', 'Gagal menyimpan data pelanggan');
    }
}

async function generateTagihanPertama(pelangganId, pelangganData, tglPasang) {
    try {
        // === PERBAIKAN: Timeline arrears untuk pelanggan baru ===
        const tglPasangObj = new Date(tglPasang);

        // 1. Tentukan bulan pemakaian (bulan saat pasang)
        const bulanPemakaian = moment(tglPasangObj).format('MM-YYYY'); // Contoh: "2024-12"

        // 2. Jatuh tempo = bulan berikutnya, tanggal 10
        const bulanJatuhTempo = moment(tglPasangObj).add(1, 'month').format('MM-YYYY'); // "2025-01"
        const tanggalJatuhTempo = `${bulanJatuhTempo}-10`;

        // 3. Hitung prorata untuk sisa hari di bulan pemakaian
        const hariDalamBulan = moment(bulanPemakaian).daysInMonth();
        const sisaHari = hariDalamBulan - tglPasangObj.getDate() + 1;
        const jumlah = Math.round((pelangganData.harga / hariDalamBulan) * sisaHari);

        console.log("🆕 Tagihan pertama:");
        console.log(`- Pelanggan: ${pelangganData.nama}`);
        console.log(`- Pasang: ${tglPasang} (${sisaHari} hari sisa di ${bulanPemakaian})`);
        console.log(`- Tagihan: ${bulanPemakaian} = ${formatRupiah(jumlah)}`);
        console.log(`- Jatuh tempo: ${tanggalJatuhTempo}`);

        const tagihanId = 'INV_' + pelangganId + '_' + bulanPemakaian.replace('-', '');

        const tagihanData = {
            id: tagihanId,
            pelanggan_id: pelangganId,
            pelanggan_nama: pelangganData.nama,
            pelanggan_telepon: pelangganData.telepon,
            pelanggan_email: pelangganData.email ,
            bulan: bulanPemakaian, // Bulan pemakaian (saat pasang)
            jumlah: jumlah,
            status: 'belum',
            tanggal_jatuh_tempo: tanggalJatuhTempo, // Jatuh tempo bulan berikutnya
            tanggal_dibuat: new Date().toISOString(),
            prorata: true,
            prorata_hari: sisaHari,
            denda: 0,
            company_id: globalCompanyId,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        await db.collection('tagihan').doc(tagihanId).set(tagihanData);

        console.log("✅ Tagihan pertama digenerate:", tagihanId);

        // Tampilkan timeline yang jelas ke user
        const timelineMessage = `
            📅 Timeline ARREARS untuk ${pelangganData.nama}:
            1. Pasang: ${moment(tglPasang).format('DD MMM YYYY')}
            2. Pemakaian: ${bulanPemakaian} (${sisaHari} hari)
            3. Tagihan: ${formatRupiah(jumlah)} (prorata)
            4. Jatuh tempo: ${moment(tanggalJatuhTempo).format('DD MMM YYYY')}
        `;

        showToast('info', 'Tagihan Dibuat', timelineMessage);

        // LOG AKTIVITAS dengan detail arrears
        await db.collection('aktivitas').add({
            aktivitas: `Auto-generate tagihan pertama untuk ${pelangganData.nama}: ${bulanPemakaian} (prorata ${sisaHari} hari) → jatuh tempo ${tanggalJatuhTempo}`,
            user: getUserLogName(),
            timestamp: new Date().toISOString()
        });

    } catch (error) {
        console.error("❌ Gagal generate tagihan pertama :", error);
        showToast('error', 'Error', 'Gagal buat tagihan pertama: ' + error.message);
    }
}

        async function editPelanggan(id) {
    console.log("🔥 EDIT PELANGGAN FORCE METHOD");

    // 1. FORCE CLOSE ALL MODALS
    document.querySelectorAll('.modal-overlay').forEach(m => {
        m.style.display = 'none';
        m.classList.remove('show');
        m.classList.add('hidden');
    });

    // 2. FORCE OPEN PELANGGAN MODAL
    const modal = document.getElementById('modalPelanggan');
    modal.style.display = 'flex';
    modal.style.visibility = 'visible';
    modal.style.opacity = '1';
    modal.classList.remove('hidden');
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';

    try {
        // 3. GET DATA
        const doc = await db.collection('pelanggan').doc(id).get();
        if (!doc.exists) return;

        const data = doc.data();

        // 4. FILL FORM (SIMPLE VERSION)
        document.getElementById('pelangganId').value = id;
        document.getElementById('pelangganServer').value = data.server || '';
        document.getElementById('pelangganNama').value = data.nama || '';
        document.getElementById('pelangganTelepon').value = data.telepon || '';
        document.getElementById('pelangganAlamat').value = data.alamat || '';
        document.getElementById('pelangganHarga').value = data.harga || '';
        document.getElementById('pelangganStatus').value = data.status || 'aktif';
        document.getElementById('pelangganTanggalPasang').value = data.tanggal_pasang || '';
        document.getElementById('pelangganKoordinat').value = data.koordinat || '';

        // 5. LOAD & SET PAKET
        setTimeout(async () => {
            await loadPaketSelectOptions();

            const select = document.getElementById('pelangganPaket');
            if (select && data.paket) {
                select.value = data.paket;
                console.log("✅ Paket set:", data.paket);
            }
        }, 300);




    } catch (error) {
        console.error("Error:", error);
    }
    setTimeout(loadServerDropdownToModal, 0);
}

// ============================================
// FUNGSI KHUSUS UNTUK MENGISI DROPDOWN PAKET
// ============================================

async function populateDropdownPaket() {
    console.log("📦 Mengisi Dropdown Paket...");

    const paketSelect = document.getElementById('pelangganPaket');
    if (!paketSelect) {
        console.error("❌ Elemen #pelangganPaket tidak ditemukan!");
        return;
    }

    try {
        // Ambil data paket (gunakan window.paketData jika ada preload, atau ambil baru)
        let snapshot;
        if (window.paketData && window.paketData.length > 0) {
            console.log("Menggunakan data preload paket");
            // Tidak perlu await get lagi
        } else {
            console.log("Mengambil data paket baru...");
            snapshot = await db.collection('paket').get();
            window.paketData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        // Kosongkan dulu
        paketSelect.innerHTML = '<option value="">-- Pilih Paket --</option>';

        // Isi Option
        if (window.paketData && window.paketData.length > 0) {
            window.paketData.forEach(p => {
                const option = document.createElement('option');
                option.value = p.nama; // Gunakan NAMA Paket sebagai Value
                option.textContent = `${p.nama} (${formatRupiah(p.harga)})`;
                paketSelect.appendChild(option);
            });

            console.log(`✅ ${window.paketData.length} paket berhasil diisi ke dropdown.`);
        } else {
            console.warn("⚠️ Data paket kosong");
        }

        // Setup Event Listener (Hanya sekali)
        if (!paketSelect.hasListener) {
            paketSelect.addEventListener('change', function() {
                const harga = this.options[this.selectedIndex].getAttribute('data-harga');
                document.getElementById('pelangganHarga').value = harga || '';
            });
            paketSelect.hasListener = true;
        }

    } catch (error) {
        console.error("❌ Error populate dropdown:", error);
    }
}


// ============================================
// FUNGSI EDIT DI HALAMAN TUNGGAKAN (PAKSA MODAL)
// ============================================

async function editPelangganDetail(pelangganId) {
    try {
        console.log("✏️ Edit pelanggan (Mode Tumpuk Tindih):", pelangganId);

        showLoading();

        // 1. AMBIL DATA
        const doc = await db.collection('pelanggan').doc(pelangganId).get();
        if (!doc.exists) throw new Error('Data tidak ditemukan');

        const data = doc.data();

        // 2. ISI FORM MODAL PELANGGAN
        document.getElementById('pelangganId').value = pelangganId;
        document.getElementById('pelangganNama').value = data.nama || '';
        document.getElementById('pelangganTelepon').value = data.telepon || '';
        document.getElementById('pelangganAlamat').value = data.alamat || '';
        document.getElementById('pelangganPaket').value = data.paket || '';
        document.getElementById('pelangganHarga').value = data.harga || '';
        document.getElementById('pelangganTanggalPasang').value = data.tanggal_pasang || '';
        document.getElementById('pelangganStatus').value = data.status || 'aktif';
        document.getElementById('pelangganCatatan').value = data.catatan || '';
        document.getElementById('pelangganServer').value = pelangganData.server || '';
        document.getElementById('pelangganKoordinat').value = pelangganData.koordinat || '';

        // 3. TUTUP MODAL TUNGGAKAN (Detail/Pay) KALAU ADA
        const modalDetail = document.getElementById('modalDetailTagihan');
        if (modalDetail) modalDetail.remove();

        const modalPay = document.getElementById('modalPayAll');
        if (modalPay) modalPay.remove();

        // 4. BUKA MODAL EDIT (PAKSA MUNCUL DI HALAMAN INI)
        const modalEdit = document.getElementById('modalPelanggan');
        modalEdit.classList.remove('hidden');
        modalEdit.classList.add('show');
        modalEdit.style.display = 'flex';
        modalEdit.style.zIndex = '99999'; // Z-INDEX TERTINGGI
        document.body.style.overflow = 'hidden';

        // Ubah judul jadi "Edit Pelanggan"
        const judul = modalEdit.querySelector('.modal-title');
        if (judul) judul.innerText = 'Edit Pelanggan';

        hideLoading();
        showToast('info', 'Mode Edit', 'Form Edit Pelanggan aktif.');

    } catch (error) {
        console.error("Error:", error);
        hideLoading();
        showToast('error', 'Gagal', error.message);
    }
}



// TAMBAHKAN INI DI renderPelangganTable()
function attachDeleteEvents() {
    // HAPUS SEMUA EVENT LAMA
    document.querySelectorAll('.btn-danger').forEach(btn => {
        btn.replaceWith(btn.cloneNode(true));
    });

    // PASANG EVENT BARU
    document.querySelectorAll('.btn-danger').forEach(btn => {
        btn.onclick = function(e) {
            e.stopPropagation();
            e.stopImmediatePropagation();
            const id = this.getAttribute('data-id');
            if (id) deletePelanggan(id);
        };
    });
}


// FUNGSI UNTUK UPDATE TIMELINE PREVIEW DI MODAL
function updateArrearsTimeline() {
    try {
        // Ambil input bulan generate
        const bulanGenerateInput = document.getElementById('generateBulan').value;
        const tanggalJatuhTempo = parseInt(document.getElementById('generateJatuhTempo').value) || 10;

        if (!bulanGenerateInput) return;

        // Parse input
        const bulanGenerate = moment(bulanGenerateInput, 'YYYY-MM'); // Titik Akhir Loop
        const bulanSebelumnya = bulanGenerate.clone().subtract(1, 'month'); // Bulan sebelum input

        // Update UI Preview
        // Sesuai perintah: Yang muncul "Tagihan Bulan Januari"
        document.getElementById('previewBulanPemakaian').textContent = bulanSebelumnya.format('MMM YYYY'); // Des 2024 (Pemakaian)
        document.getElementById('previewBulanGenerate').textContent = bulanGenerate.format('MMM YYYY'); // Jan 2025 (Generate)

        // Jatuh tempo: 10 bulan berikutnya (Feb 2025) -> ATAU SESUAI LOGIKA BARU (10 Jan 2025)
        // Karena perintah: "Generate bulan januari, yang muncul tagihan bulan januari"
        // Maka jatuh tempo idealnya adalah di bulan berikutnya (Februari) atau akhir bulan Januari.
        // Namun agar konsisten dengan bulan muncul:
        const jatuhTempoDate = bulanGenerate.clone().date(tanggalJatuhTempo); // 10 Januari 2025
        document.getElementById('previewJatuhTempo').textContent = jatuhTempoDate.format('DD MMM YYYY');

        // Update Summary
        document.getElementById('summaryBulanPemakaian').textContent = bulanSebelumnya.format('MMMM YYYY'); // Menunjukkan pemakaian bulan lalu
        document.getElementById('summaryBulanJatuhTempo').textContent = bulanGenerate.format('MMMM YYYY'); // Menunjukkan jatuh tempo di bulan ini

    } catch (error) {
        console.error("Error update timeline:", error);
    }
}

// FUNGSI UNTUK LOAD DATA DAN UPDATE PREVIEW
async function loadTunggakanDataForModal() {
    console.log("📊 Loading data untuk modal ...");

    try {
        // 1. AMBIL DATA PELANGGAN AKTIF
        const snapshot = await db.collection('pelanggan').where('status', '==', 'aktif').get();
        const totalAktif = snapshot.size;

        // 2. HITUNG RATA-RATA HARGA
        let totalHarga = 0;
        snapshot.forEach(doc => {
            totalHarga += Number(doc.data().harga) || 150000;
        });
        const rataHarga = Math.round(totalHarga / totalAktif);

        // 3. UPDATE UI
        document.getElementById('summaryTotalAktif').textContent = totalAktif;
        document.getElementById('previewPelangganCount').textContent = totalAktif;
        document.getElementById('previewHargaRata').textContent = formatRupiah(rataHarga);

        const estimasiTotal = totalAktif * rataHarga;
        document.getElementById('previewTotalEstimasi').textContent = formatRupiah(estimasiTotal);
        document.getElementById('summaryEstimasiTotal').textContent = formatRupiah(estimasiTotal);
        document.getElementById('summaryJumlahTagihan').textContent = totalAktif;

        // 4. UPDATE TIMELINE
        updateArrearsTimeline();



    } catch (error) {
        console.error("❌ Error load data for modal:", error);
        showToast('error', 'Error', 'Gagal memuat data');
    }
}

// INIT MODAL SAAT DIBUKA
document.addEventListener('DOMContentLoaded', function() {
    // Event listener untuk input bulan generate
    const bulanGenerateInput = document.getElementById('generateBulan');
    if (bulanGenerateInput) {
        // Set default ke bulan sekarang
        const now = moment();
        bulanGenerateInput.value = now.format('YYYY-MM');

        bulanGenerateInput.addEventListener('change', function() {
            updateArrearsTimeline();
        });
    }
 // Event listener untuk input tanggal jatuh tempo
    const jatuhTempoInput = document.getElementById('generateJatuhTempo');
    if (jatuhTempoInput) {
        jatuhTempoInput.addEventListener('change', updateArrearsTimeline);
    }

    // Event listener untuk filter tunggakan
    const filterTunggakan = document.getElementById('filterTunggakan');
    if (filterTunggakan) {
        filterTunggakan.addEventListener('change', function() {
            toggleTunggakanFilter();
            updateArrearsTimeline();
        });
    }

    // Inisialisasi timeline saat pertama kali
    setTimeout(updateArrearsTimeline, 500);
});

// ============================================
// FUNGSI HELPER: FORMAT BULAN UNTUK DISPLAY
// ============================================

function formatBulanForDisplay(bulanString) {
    try {
        // Coba berbagai format
        let m = moment(bulanString, 'MM-YYYY');
        if (!m.isValid()) {
            m = moment(bulanString, 'YYYY-MM');
        }
        if (!m.isValid()) {
            m = moment(bulanString);
        }

        if (m.isValid()) {
            return m.format('MMMM YYYY');
        }

        return bulanString; // Fallback ke string asli

    } catch (error) {
        return bulanString;
    }
}

// ============================================
// FUNGSI BARU: VALIDASI DAN KONVERSI TANGGAL
// ============================================

function parseAndValidateDate(dateString, format = null) {
    try {
        let m;

        if (format) {
            m = moment(dateString, format);
        } else {
            // Coba berbagai format umum
            const formats = [
                'YYYY-MM-DD',
                'DD-MM-YYYY',
                'MM-DD-YYYY',
                'YYYY/MM/DD',
                'DD/MM/YYYY'
            ];

            for (const fmt of formats) {
                m = moment(dateString, fmt, true); // strict mode
                if (m.isValid()) break;
            }
        }

        if (!m || !m.isValid()) {
            throw new Error(`Format tanggal tidak valid: ${dateString}`);
        }

        // Validasi: tanggal tidak boleh di masa depan jauh atau masa lalu jauh
        const now = moment();
        const diffYears = Math.abs(m.diff(now, 'years'));

        if (diffYears > 10) {
            throw new Error(`Tanggal tidak realistis: ${m.format('DD/MM/YYYY')}`);
        }

        return {
            moment: m,
            iso: m.format('YYYY-MM-DD'),
            display: m.format('DD/MM/YYYY'),
            database: m.format('YYYY-MM-DD')
        };

    } catch (error) {
        console.error("Error parse date:", error);
        return null;
    }
}


// FUNGSI UNTUK EKSEKUSI DELETE (DIPANGGIL DARI MODAL)
async function executeDelete(id) {
    console.log("🔥 EKSEKUSI DELETE UNTUK:", id);

    try {
        // TAMPILKAN LOADING
        const deleteBtn = document.querySelector('button[onclick*="executeDelete"]');
        if (deleteBtn) {
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menghapus...';
            deleteBtn.disabled = true;
        }

        // HAPUS DARI FIREBASE
        await db.collection('pelanggan').doc(id).delete();
        console.log("✅ BERHASIL DIHAPUS");

        // HAPUS MODAL
        const modal = document.getElementById('deleteConfirmModal');
        if (modal) modal.remove();

        // TAMPILKAN NOTIFIKASI
        showToast('success', 'Berhasil', 'Data pelanggan telah dihapus');

        // REFRESH DATA
        if (currentPage === 'pelanggan') {
            loadPelangganData();
        }

        // LOG AKTIVITAS
        await db.collection('aktivitas').add({
            aktivitas: `Menghapus pelanggan ${id.substring(0, 8)}...`,
            user: getUserLogName(),
            timestamp: new Date().toISOString()
        });

    } catch (error) {
        console.error("❌ ERROR DELETE:", error);
        showToast('error', 'Gagal', 'Gagal menghapus: ' + error.message);

        // HAPUS MODAL
        const modal = document.getElementById('deleteConfirmModal');
        if (modal) modal.remove();
    }
}

// GANTI TOMBOL DI TABLE MENJADI:
// <button class="btn btn-sm btn-danger" onclick="deletePelanggan('${pelanggan.id}'); return false;" title="Hapus">

        // ============================================
        // CRUD FUNCTIONS - PAKET
        // ============================================

        function showAddPaketModal() {
    if (localStorage.getItem('userRole') !== 'admin') {
        alert('HANYA ADMIN!');
        return;
    }

    // Reset form
    document.getElementById('formPaket').reset();

    // PERBAIKAN: Wajib mengosongkan ID Paket agar mode kembali ke "TAMBAH"
    document.getElementById('paketId').value = '';

    const modal = document.getElementById('modalPaket');
    modal.classList.remove('hidden');
    modal.classList.add('show');
}

       async function savePaket() {
    // Ambil semua nilai form
    const nama = document.getElementById('paketNama').value.trim();
    const kecepatan = document.getElementById('paketKecepatan').value.trim();
    const harga = parseInt(document.getElementById('paketHarga').value) || 0;
    const kuota = document.getElementById('paketKuota').value.trim();
    const deskripsi = document.getElementById('paketDeskripsi').value.trim();
    const fitur = document.getElementById('paketFitur').value.trim();
    const warna = document.getElementById('paketWarna').value;
    const status = document.getElementById('paketStatus').value;
    const paketId = document.getElementById('paketId').value; // ⭐⭐ INI YANG DICEK ⭐⭐

    // Validasi
    if (!nama || !kecepatan || harga <= 0) {
        showToast('error', 'Error', 'Isi nama, kecepatan, dan harga dengan benar!');
        return;
    }

    try {
        const dataPaket = {
            nama,
            kecepatan,
            harga,
            kuota: kuota || 'Unlimited',
            deskripsi,
            fitur,
            warna,
            status: status || 'aktif',
            company_id: globalCompanyId, // ⭐ Pastikan ada company_id
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        // ⭐⭐⭐ LOGIKA YANG BENAR: ⭐⭐⭐
        if (paketId) {
            // MODE EDIT - Update data yang ada
            await db.collection('paket').doc(paketId).update({
                ...dataPaket,
                updated_at: new Date().toISOString()
            });
            showToast('success', 'Berhasil', 'Paket berhasil diperbarui');
        } else {
            // MODE TAMBAH - Buat data baru dengan ID unik
            const newId = `PAKET_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            await db.collection('paket').doc(newId).set(dataPaket);
            showToast('success', 'Berhasil', 'Paket baru berhasil ditambahkan');
        }

        // Tutup modal
        hideModal('modalPaket');

        // Refresh data paket
        await loadPaketData();

    } catch (error) {
        console.error('Error save paket:', error);
        showToast('error', 'Error', 'Gagal menyimpan paket');
    }
}


        async function editPaket(id) {
    console.log("🎯 EDIT PAKET:", id);

    if (localStorage.getItem('userRole') !== 'admin') {
        alert('❌ HANYA ADMIN!');
        return;
    }

    try {
        // 1. FORCE TUTUP SEMUA MODAL LAIN
        document.querySelectorAll('.modal-overlay').forEach(m => {
            m.style.display = 'none';
            m.classList.remove('show');
            m.classList.add('hidden');
        });

        // 2. AMBIL DATA
        const doc = await db.collection('paket').doc(id).get();
        if (!doc.exists) {
            showToast('error', 'Error', 'Data tidak ditemukan');
            return;
        }

        const data = doc.data();
        console.log("📊 Data paket:", data);

        // 3. ISI FORM
        document.getElementById('paketId').value = id;
        document.getElementById('paketNama').value = data.nama || '';
        document.getElementById('paketKecepatan').value = data.kecepatan || '';
        document.getElementById('paketHarga').value = data.harga || 150000;
        document.getElementById('paketKuota').value = data.kuota || '';
        document.getElementById('paketDeskripsi').value = data.deskripsi || '';
        document.getElementById('paketFitur').value = data.fitur || '';
        document.getElementById('paketWarna').value = data.warna || '#4361ee';
        document.getElementById('paketStatus').value = data.status || 'aktif';

        // 4. FORCE BUKA MODAL
        const modal = document.getElementById('modalPaket');
        modal.style.display = 'flex';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        modal.classList.remove('hidden');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';

        // 5. UPDATE JUDUL
        modal.querySelector('.modal-title').textContent = 'Edit Paket';

        console.log("✅ Modal paket terbuka");

    } catch (error) {
        console.error("❌ Error edit paket:", error);
        showToast('error', 'Error', 'Gagal memuat data paket');
    }
}

        async function deletePaket(id) {
    // ⭐⭐ GANTI confirm(...) JADI confirmDialog(...) ⭐⭐
    confirmDialog('Hapus paket ini? Pelanggan yang menggunakan paket ini akan terpengaruh.', async () => {
        try {
            showLoading();
            await db.collection('paket').doc(id).delete();

            await db.collection('aktivitas').add({
                aktivitas: 'Menghapus paket',
                user: getUserLogName(),
                timestamp: new Date().toISOString()
            });

            hideLoading();
            showToast('success', 'Berhasil', 'Paket berhasil dihapus');
            await loadPaketData();

        } catch (error) {
            console.error("Error deleting paket:", error);
            hideLoading();
            showToast('error', 'Error', 'Gagal menghapus paket');
        }
    });
}




async function generateTagihanBulk() {

    logRead('generate');
    console.log("🚀 GENERATE TAGIHAN (FIX TANGGAL)...");

    try {
        const bulanGenerateInput = document.getElementById('generateBulan').value;
        // Kita pakai fixed tanggal 10 sesuai contoh user
        const tglJatuhTempoFix = 10;

        if (!bulanGenerateInput) {
            showToast('error', 'Error', 'Pilih bulan generate');
            return;
        }

        // 1. LOADING UI
        const generateBtn = document.querySelector('#modalGenerateTagihan .btn-primary');
        const originalText = generateBtn.innerHTML;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        generateBtn.disabled = true;

        const bulanGenerate = moment(bulanGenerateInput, 'YYYY-MM');


        // PAKAI DATA DARI GLOBAL ATAU AMBIL BARU
        let paketMap = {};
        if (!window.paketData) window.paketData = [];
        if (window.paketData && window.paketData.length > 0) {
            // PAKAI DATA YANG SUDAH ADA
            window.paketData.forEach(p => {
                paketMap[p.nama] = p.harga;
            });
            console.log('⚡ Pakai paketData global');
        } else {
            // AMBIL DARI DATABASE KALAU KOSONG
            const snapshot = await db.collection('paket')
                .where('company_id', '==', globalCompanyId)
                .get();
            snapshot.forEach(doc => {
                const p = doc.data();
                paketMap[p.nama] = p.harga;
                window.paketData.push(p); // SIMPAN KE GLOBAL
            });
            console.log('📦 Ambil paket dari database');
        }

        // 2. AMBIL SEMUA PELANGGAN AKTIF
        const pelangganSnapshot = await db.collection('pelanggan')
            .where('company_id', '==', globalCompanyId)
            .where('status', '==', 'aktif')
            .get();

        if (pelangganSnapshot.empty) {
            showToast('warning', 'Data Kosong', 'Tidak ada pelanggan aktif');
            generateBtn.disabled = false;
            generateBtn.innerHTML = originalText;
            return;
        }

        // 3. AMBIL SEMUA TAGIHAN YANG SUDAH ADA
        const allExistingTags = await db.collection('tagihan')
            .where('company_id', '==', globalCompanyId)
            .get();

        const existingTagMap = new Map();
        allExistingTags.forEach(doc => {
            const data = doc.data();
            const key = `${data.pelanggan_id}_${data.bulan}`;
            existingTagMap.set(key, true);
        });

        let totalTagihanDibuat = 0;
        const batch = db.batch();
        const now = new Date().toISOString();

        // 4. PROSES PER PELANGGAN
        for (const doc of pelangganSnapshot.docs) {
            const pelanggan = doc.data();
            const pelangganId = doc.id;

            let tanggalPasang = moment(pelanggan.tanggal_pasang, ['YYYY-MM-DD', 'DD-MM-YYYY']);
            if (!tanggalPasang.isValid()) tanggalPasang = moment('2020-01-01');

            // ⭐ LOGIKA: START LOOP = BULAN PASANG + 1
            let bulanSaatIni = tanggalPasang.clone().add(1, 'month').startOf('month');

            const maxLoop = 24;
            let loopCount = 0;

            // Loop sampai bulan input
            while (bulanSaatIni.isSameOrBefore(bulanGenerate, 'month') && loopCount < maxLoop) {

                // Format Key: MM-YYYY
                const bulanKey = bulanSaatIni.format('MM-YYYY');

                const existingKey = `${pelangganId}_${bulanKey}`;

                if (!existingTagMap.has(existingKey)) {
                    let jumlahTagihan = paketMap[pelanggan.paket] || 0;
                    let isProrata = false;
                    let catatan = 'Tagihan normal';

                    // Cek Prorata
                    const bulanPertama = tanggalPasang.clone().add(1, 'month').startOf('month');
                    if (bulanSaatIni.isSame(bulanPertama, 'month')) {
                        isProrata = true;
                        const daysInMonth = bulanSaatIni.daysInMonth();
                        const sisaHari = daysInMonth - tanggalPasang.date() + 1;
                        jumlahTagihan = Math.round((jumlahTagihan / daysInMonth) * sisaHari);
                        catatan = `Prorata ${sisaHari} hari`;
                    }

                    // ⭐ FIX KRUSIAL: BANGUN TANGGAL DARI YEAR, MONTH, DATE (AGAR TIDAK SALAH)
                    // Kita clone bulanSaatIni, lalu set tanggalnya ke 10.
                    const jatuhTempoDate = bulanSaatIni.clone().date(tglJatuhTempoFix);

                    // Format ke string DD-MM-YYYY
                    const jatuhTempoString = jatuhTempoDate.format('DD-MM-YYYY');

                    const tagihanId = `INV_${bulanKey.replace('-', '')}_${pelangganId}_${Date.now()}`;
                    const tagihanRef = db.collection('tagihan').doc(tagihanId);

                    batch.set(tagihanRef, {
                        id: tagihanId,
                        pelanggan_id: pelangganId,
                        pelanggan_nama: pelanggan.nama || '',
                        pelanggan_telepon: pelanggan.telepon || '',
                        bulan: bulanKey, // 02-2026
                        jumlah: jumlahTagihan,
                        tanggal_jatuh_tempo: jatuhTempoString, // Hasil: 10 Feb 2026
                        status: 'belum',
                        company_id: globalCompanyId,
                        created_at: now,
                        updated_at: now,
                        metadata: {
                            is_prorata: isProrata,
                            catatan: catatan,
                            bulan_generate: bulanGenerateInput
                        }
                    });

                    totalTagihanDibuat++;
                    console.log(`   ✅ ${pelanggan.nama} - ${bulanKey} (JT: ${jatuhTempoString})`);
                }

                bulanSaatIni.add(1, 'month');
                loopCount++;
            }
        }

        // 5. SIMPAN
        if (totalTagihanDibuat > 0) {
            await batch.commit();

                 // ===== UPDATE CACHE =====
            // Ambil cache lama (data Feb–Juli)
            const cachedTagihan = CACHE.get('tagihanData', 3600000) || [];

            // Ambil data baru yang BARU DIGENERATE (misal Agustus)
            const snapshotBaru = await db.collection('tagihan')
                .where('company_id', '==', globalCompanyId)
                .where('bulan', '==', bulanGenerateInput)
                .get();

            const dataBaru = [];
            snapshotBaru.forEach(doc => {
                dataBaru.push({ id: doc.id, data: doc.data() });
            });

            // Gabungin cache lama + data baru
            const cacheBaru = [...cachedTagihan, ...dataBaru];

            // Hapus duplikat berdasarkan ID (jaga-jaga)
            const uniqueCache = [];
            const seen = new Set();
            cacheBaru.forEach(item => {
                if (!seen.has(item.id)) {
                    seen.add(item.id);
                    uniqueCache.push(item);
                }
            });

            // Simpan cache baru
            CACHE.set('tagihanData', uniqueCache);
            console.log(`💾 CACHE UPDATE: ${cachedTagihan.length} lama + ${dataBaru.length} baru = ${uniqueCache.length} total (${bulanGenerateInput})`);
            // ===== END UPDATE CACHE =====

            console.log(`💾 BERHASIL: ${totalTagihanDibuat} tagihan disimpan.`);
            showToast('success', 'Berhasil', `${totalTagihanDibuat} tagihan baru dibuat.`);

            await db.collection('aktivitas').add({
                aktivitas: `Generate: ${totalTagihanDibuat} tagihan (${bulanGenerate.format('MMMM YYYY')})`,
                user: currentUser?.email || "Admin",
                timestamp: now,
                company_id: globalCompanyId


            });

        } else {
            showToast('info', 'Info', 'Semua tagihan sudah ada.');
        }

        forceCloseModal('modalGenerateTagihan');
        await loadTagihanData();

    } catch (error) {
        console.error("❌ Error generate:", error);
        showToast('error', 'Gagal', error.message);
    } finally {
        const generateBtn = document.querySelector('#modalGenerateTagihan .btn-primary');
        if (generateBtn) {
            generateBtn.innerHTML = '<i class="fas fa-bolt"></i> Generate Tagihan';
            generateBtn.disabled = false;
        }
    }
}

// Helper untuk reset tombol (biar rapi)
function resetGenerateButton() {
    const generateBtn = document.querySelector('#modalGenerateTagihan .btn-primary') ||
                       document.getElementById('btnGenerateTagihan');
    if (generateBtn) {
        generateBtn.innerHTML = '<i class="fas fa-bolt"></i> Generate Tagihan';
        generateBtn.disabled = false;
    }
}

// Helper untuk reset tombol (biar rapi)
function resetGenerateButton() {
    const generateBtn = document.querySelector('#modalGenerateTagihan .btn-primary') ||
                       document.getElementById('btnGenerateTagihan');
    if (generateBtn) {
        generateBtn.innerHTML = '<i class="fas fa-bolt"></i> Generate Tagihan';
        generateBtn.disabled = false;
    }
}

function resetGenerateButton() {
    const generateBtn = document.getElementById('btnGenerateTagihan');
    if (generateBtn) {
        generateBtn.innerHTML = '<i class="fas fa-bolt"></i> Generate Tagihan';
        generateBtn.disabled = false;
    }
}




// ============================================
// FUNGSI CEK TAGIHAN SUDAH ADA
// ============================================

async function cekTagihanSudahAda(pelangganId, bulanKey) {
    try {
        const snapshot = await db.collection('tagihan')
            .where('pelanggan_id', '==', pelangganId)
            .where('bulan', '==', bulanKey)
            .limit(1)
            .get();
        return !snapshot.empty;
    } catch (error) {
        console.error(`Error cek tagihan:`, error);
        return true; // Jika error, anggap sudah ada
    }
}

        async function getCompanyProfile() {
    try {
        // CEK CACHE DULU
        const cacheKey = `company_profile_${globalCompanyId}`;
        const cached = localStorage.getItem(cacheKey);

        if (cached) {
            return JSON.parse(cached);
        }

        // AMBIL DARI DATABASE
        const companyRef = db.collection('company_settings').doc(globalCompanyId);
        const companyDoc = await companyRef.get();

        let companyData = {
            nama_perusahaan: 'X-BILL',
            telepon: '081234567890',
            alamat: 'Jl. Internet Cepat No. 1',
            website: 'https://xbill.com'
        };

        if (companyDoc.exists) {
            const data = companyDoc.data();
            companyData = {
                ...companyData,
                ...data
            };
        }

        // SIMPAN KE CACHE (1 JAM)
        localStorage.setItem(cacheKey, JSON.stringify(companyData));
        setTimeout(() => {
            localStorage.removeItem(cacheKey);
        }, 60 * 60 * 1000);

        return companyData;

    } catch (error) {
        console.error("Error get company profile:", error);
        return {
            nama_perusahaan: 'X-BILL',
            telepon: '081234567890',
            alamat: 'Jl. Internet Cepat No. 1',
            website: 'https://xbill.com'
        };
    }
}

// FUNGSI UNTUK AMBIL DATA TUNGGAKAN
async function getTunggakanData() {
    try {
        const snapshot = await db.collection('tagihan')
            .where('status', '==', 'telat')
            .get();

        if (snapshot.empty) {
            return [];
        }

        const tunggakanByPelanggan = {};

        snapshot.docs.forEach(doc => {
            const tagihan = doc.data();
            const pelangganId = tagihan.pelanggan_id;

            if (!tunggakanByPelanggan[pelangganId]) {
                tunggakanByPelanggan[pelangganId] = {
                    pelanggan_id: pelangganId,
                    pelanggan_nama: tagihan.pelanggan_nama,
                    total: 0,
                    jumlah_tunggakan: 0,
                    hari_terlambat: 0
                };
            }

            // Hitung hari terlambat
            const jatuhTempo = moment(tagihan.tanggal_jatuh_tempo);
            const hariTerlambat = moment().diff(jatuhTempo, 'days');

            // Update data tunggakan
            tunggakanByPelanggan[pelangganId].total += Number(tagihan.jumlah) || 0;
            tunggakanByPelanggan[pelangganId].jumlah_tunggakan += 1;
            tunggakanByPelanggan[pelangganId].hari_terlambat = Math.max(
                tunggakanByPelanggan[pelangganId].hari_terlambat,
                hariTerlambat
            );
        });

        return Object.values(tunggakanByPelanggan);

    } catch (error) {
        console.error("❌ Error get tunggakan data:", error);
        return [];
    }
}

// FUNGSI PREVIEW GENERATE TAGIHAN
async function previewGenerateTagihan() {
    try {
        console.log("👁️‍🗨️ Preview generate tagihan...");

        // Update summary
        await updateGenerateSummary();

        showToast('info', 'Preview', 'Menghitung summary generate...');

    } catch (error) {
        console.error("Error preview:", error);
    }
}

// FUNGSI UPDATE SUMMARY
async function updateGenerateSummary() {
    try {
        const bulan = document.getElementById('generateBulan').value;
        if (!bulan) return;

        // Ambil data pelanggan aktif
        const snapshot = await db.collection('pelanggan')
            .where('status', '==', 'aktif')
            .get();

        const totalAktif = snapshot.size;

        // Ambil data tunggakan
        const tunggakanData = await getTunggakanData();
        const jumlahTunggakan = tunggakanData.length;

        // Hitung total tunggakan
        const totalTunggakan = tunggakanData.reduce((sum, t) => sum + t.total, 0);

        // Estimasi tagihan (rata-rata 150rb per pelanggan)
        const estimasiTagihan = totalAktif * 150000;

        // Update UI
        document.getElementById('summaryTotalAktif').textContent = totalAktif;
        document.getElementById('summaryTunggakan').textContent = jumlahTunggakan;
        document.getElementById('summaryTotalTunggakan').textContent = formatRupiah(totalTunggakan);
        document.getElementById('summaryTagihan').textContent = formatRupiah(estimasiTagihan);

        // Estimasi waktu
        const estimasiWaktu = Math.ceil(totalAktif / 10); // 10 pelanggan per detik
        document.getElementById('summaryWaktu').textContent = `~${estimasiWaktu} detik`;

    } catch (error) {
        console.error("Error update summary:", error);
    }
}

// Di fungsi initializeQuickActions() atau saat buka modal:
// FUNGSI UNTUK BUKA MODAL DENGAN DATA TUNGGAKAN
function showGenerateTagihanModal() {
    const role = localStorage.getItem('userRole');
    if (role !== 'admin' && role !== 'karyawan') {
        alert('HANYA ADMIN/KARYAWAN!'); return;
    }
    const modal = document.getElementById('modalGenerateTagihan');
    modal.classList.remove('hidden');
    modal.classList.add('show');
}

        // FUNGSI UNTUK TOMBOL "BAYAR"
async function bayarTagihan(tagihanId) {
    try {
        console.log("Membuka form bayar untuk tagihan:", tagihanId);

        // Ambil data tagihan
                // Ambil data tagihan
        const doc = await db.collection('tagihan').doc(tagihanId).get();
        if (!doc.exists) {
            showToast('error', 'Error', 'Data tidak ditemukan');
            return;
        }

        const tagihan = doc.data();

        // Ambil data pelanggan (UNTUK NAMA & STATUS)
        let namaPelanggan = tagihan.pelanggan_nama || 'Pelanggan';
        let statusPelanggan = 'Nonaktif'; // Default
        let tglPasang = '-';
        let namaPetugas = 'Admin'; // ⭐ DEFAULT PETUGAS

        try {
            const pelDoc = await db.collection('pelanggan').doc(tagihan.pelanggan_id).get();
            if (petugasDoc.exists) {
                const pData = petugasDoc.data();
                namaPelanggan = pData.nama || namaPelanggan; // Update nama dari DB jika ada
                statusPelanggan = pData.status || 'Nonaktif';
                tglPasang = pData.tanggal_pasang || '-';

                // ⭐ AMBIL NAMA PETUGAS DARI USER LOGIN ⭐
                namaPetugas = getNamaKaryawan(); // Fungsi helper (akan kita buat di bawah)
            }
        } catch (err) {
            console.warn("Gagal ambil data pelanggan:", err);
            // Pakai default Admin
        }

        // Isi Form Modal
        document.getElementById('bayarInvoice').value = tagihan.id || tagihanId.substring(0, 10) + '...';
        document.getElementById('bayarPelanggan').value = namaPelanggan;
        document.getElementById('bayarStatusPelanggan').value = statusPelanggan;
        document.getElementById('bayarTanggalPasang').value = tglPasang;
        document.getElementById('bayarJumlah').value = formatRupiah(tagihan.jumlah || 0);

        // Hitung denda jika telat
        let denda = 0;
        if (tagihan.status === 'telat' && tagihan.tanggal_jatuh_tempo) {
            const hariTerlambat = moment().diff(moment(tagihan.tanggal_jatuh_tempo), 'days');
            denda = Math.round((tagihan.jumlah || 0) * Math.min(0.1, 0.02 * hariTerlambat));
        }

        document.getElementById('bayarDenda').value = formatRupiah(denda);
        document.getElementById('totalBayar').value = (tagihan.jumlah || 0) + denda;
        document.getElementById('tagihanId').value = tagihanId;

        // Set tanggal hari ini
        document.getElementById('tanggalBayar').value = moment().format('DD-MM-YYYY');

        // Buka modal
        const modal = document.getElementById('modalBayarTagihan');
        modal.classList.remove('hidden');
        modal.classList.add('show');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';

        showToast('info', 'Pembayaran', 'Isi form pembayaran');

    } catch (error) {
        console.error("Error membuka form bayar:", error);
        showToast('error', 'Error', 'Gagal membuka form pembayaran');
    }
}

// FUNGSI HELPER: AMBIL NAMA PETUGAS
function getNamaKaryawan() {
    // Coba ambil dari localStorage/Variable Global
    if (currentUser && currentUser.name) {
        return currentUser.name;
    }

    // Fallback jika user object belum siap
    const savedName = localStorage.getItem('userName');
    if (savedName) return savedName;

    return 'Admin'; // Default
}

// FUNGSI UNTUK TOMBOL "LIHAT DETAIL"
async function viewInvoice(tagihanId) {
    try {
        console.log("Melihat detail tagihan:", tagihanId);

        // Ambil data tagihan
        const doc = await db.collection('tagihan').doc(tagihanId).get();
        if (!doc.exists) {
            showToast('error', 'Error', 'Tagihan tidak ditemukan');
            return;
        }

        const tagihan = doc.data();

        // Ambil data pelanggan
        let pelanggan = {};
        if (tagihan.pelanggan_id) {
            const pelangganDoc = await db.collection('pelanggan').doc(tagihan.pelanggan_id).get();
            if (pelangganDoc.exists) {
                pelanggan = pelangganDoc.data();
            }
        }

        // Buat HTML untuk detail
        const detailHTML = `
            <div style="padding: 20px;">
                <div style="background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h3 style="color: var(--primary);">INVOICE</h3>
                        <h1 style="color: var(--dark);">${tagihan.id || tagihanId}</h1>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                        <div>
                            <h4>Informasi Pelanggan</h4>
                            <table class="table" style="background: #f8f9fa; border-radius: 8px;">
                                <tr><td><strong>Nama</strong></td><td>${pelanggan.nama || tagihan.pelanggan_nama || '-'}</td></tr>
                                <tr><td><strong>Telepon</strong></td><td>${pelanggan.telepon || tagihan.pelanggan_telepon || '-'}</td></tr>
                                <tr><td><strong>Email</strong></td><td>${pelanggan.email || tagihan.pelanggan_email || '-'}</td></tr>
                                <tr><td><strong>Alamat</strong></td><td>${pelanggan.alamat || '-'}</td></tr>
                            </table>
                        </div>

                        <div>
                            <h4>Detail Tagihan</h4>
                            <table class="table" style="background: #f8f9fa; border-radius: 8px;">
                                <tr><td><strong>Bulan</strong></td><td>${tagihan.bulan || '-'}</td></tr>
                                <tr><td><strong>Jatuh Tempo</strong></td><td>${moment(tagihan.tanggal_jatuh_tempo).format('DD/MM/YYYY') || '-'}</td></tr>
                                <tr><td><strong>Status</strong></td><td>
                                    <span class="badge ${tagihan.status === 'lunas' ? 'badge-success' :
                                                       tagihan.status === 'telat' ? 'badge-danger' : 'badge-warning'}">
                                        ${tagihan.status === 'lunas' ? 'LUNAS' :
                                         tagihan.status === 'telat' ? 'TELAT' : 'BELUM BAYAR'}
                                    </span>
                                </td></tr>
                                <tr><td><strong>Tipe</strong></td><td>${tagihan.prorata ? 'PRORATA' : 'NORMAL'}</td></tr>
                            </table>
                        </div>
                    </div>

                    <div style="background: var(--primary); color: white; padding: 20px; border-radius: 8px; text-align: center;">
                        <h2 style="margin: 0;">TOTAL: ${formatRupiah(tagihan.jumlah || 0)}</h2>
                    </div>

                    ${tagihan.status === 'lunas' ? `
                        <div style="margin-top: 30px; padding: 20px; background: #e8f5e9; border-radius: 8px;">
                            <h4 style="color: #00b894;"><i class="fas fa-check-circle"></i> SUDAH DIBAYAR</h4>
                            <p><strong>Tanggal Bayar:</strong> ${tagihan.tanggal_bayar || '-'}</p>
                            <p><strong>Metode:</strong> ${tagihan.metode_bayar || '-'}</p>
                            <p><strong>Referensi:</strong> ${tagihan.referensi_bayar || '-'}</p>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;

        // Buat modal
        const modal = document.createElement('div');
        modal.className = 'modal-overlay show';
        modal.innerHTML = `
            <div class="modal modal-lg">
                <div class="modal-header">
                    <h3 class="modal-title"><i class="fas fa-file-invoice"></i> Detail Tagihan</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    ${detailHTML}
                </div>
                <div class="modal-footer">
                    ${tagihan.status !== 'lunas' ? `
                        <button class="btn btn-success" onclick="bayarTagihan('${tagihanId}')">
                            <i class="fas fa-money-bill-wave"></i> Bayar Sekarang
                        </button>
                    ` : ''}
                    <button class="btn btn-primary" onclick="printInvoiceDetail('${tagihanId}')">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button class="btn btn-outline" onclick="this.closest('.modal-overlay').remove()">
                        Tutup
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

    } catch (error) {
        console.error("Error melihat detail:", error);
        showToast('error', 'Error', 'Gagal memuat detail tagihan');
    }
}

// FUNGSI UNTUK TOMBOL "KIRIM REMINDER"
async function sendReminderSingle(pelangganId) {
    try {
        console.log("Kirim reminder untuk pelanggan:", pelangganId);

        if (!pelangganId) {
            showToast('error', 'Error', 'ID pelanggan tidak valid');
            return;
        }

        // Ambil data pelanggan
        const pelangganDoc = await db.collection('pelanggan').doc(pelangganId).get();
        if (!pelangganDoc.exists) {
            showToast('error', 'Error', 'Pelanggan tidak ditemukan');
            return;
        }

        const pelanggan = pelangganDoc.data();

        // Tampilkan konfirmasi
        if (confirm(`Kirim reminder tagihan ke ${pelanggan.nama} (${pelanggan.telepon})?`)) {
            showLoading();

            // Simulasi kirim reminder
            setTimeout(() => {
                hideLoading();
                showToast('success', 'Berhasil', `Reminder telah dikirim ke ${pelanggan.nama}`);

                // Log aktivitas
                db.collection('aktivitas').add({
                    aktivitas: `Kirim reminder ke ${pelanggan.nama}`,
                    user: currentUser?.name || 'Administrator',
                    timestamp: new Date().toISOString()
                });
            }, 1500);
        }

    } catch (error) {
        console.error("Error kirim reminder:", error);
        showToast('error', 'Error', 'Gagal mengirim reminder');
    }
}




// FUNGSI UNTUK TOMBOL "PRINT"
function printInvoice(tagihanId) {
    console.log("Print invoice:", tagihanId);

    // Buka window print
    window.open(`?print=${tagihanId}`, '_blank');

    // Atau show toast info
    showToast('info', 'Print Invoice', 'Membuka printer dialog...');
}

// Fungsi sederhana untuk print detail
function printInvoiceDetail(tagihanId) {
    const printContent = document.querySelector('.modal-overlay.show .modal-body').innerHTML;
    const originalContent = document.body.innerHTML;

    document.body.innerHTML = printContent;
    window.print();
    document.body.innerHTML = originalContent;
    location.reload();
}

        async function konfirmasiPembayaran() {
            try {
                const form = document.getElementById('formBayarTagihan');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                showLoading();

                const tagihanId = document.getElementById('tagihanId').value;
                const totalBayar = parseInt(document.getElementById('totalBayar').value);
                const metodeBayar = document.getElementById('metodeBayar').value;
                const tanggalBayar = document.getElementById('tanggalBayar').value;
                const referensiBayar = document.getElementById('referensiBayar').value;
                const catatanBayar = document.getElementById('catatanBayar').value;

                await db.collection('tagihan').doc(tagihanId).update({
                    status: 'lunas',
                    total_bayar: totalBayar,
                    metode_bayar: metodeBayar,
                    tanggal_bayar: tanggalBayar,
                    referensi_bayar: referensiBayar,
                    catatan_bayar: catatanBayar,
                    updated_at: new Date().toISOString()
                });




                // Log activity
                await db.collection('aktivitas').add({
            aktivitas: `Bayar tagihan: ${dataTagihan.bulan} - ${formatRupiah(totalBayar)}`,
            user: currentUser?.email || "Admin",
            timestamp: new Date().toISOString(),
            company_id: globalCompanyId
                });

                hideModal('modalBayarTagihan');
                hideLoading();

                showToast('success', 'Berhasil', 'Pembayaran berhasil dikonfirmasi');

                if (currentPage === 'tagihan') {
                    await loadTagihanData();
                }
                if (currentPage === 'tunggakan') {
                    await loadTunggakanData();
                }
                if (currentPage === 'dashboard') {
                    await renderDashboard();
                }
                    if (currentPage === 'dashboard') {
                      loadPelangganMap();
                 }

                // 🔥 TAMBAH 2 BARIS INI DI SINI
                    window._dashboardCache = null;
                    window._dashboardCacheTime = 0;



            } catch (error) {
                console.error("Error confirming payment:", error);
                hideLoading();
                showToast('error', 'Error', 'Gagal konfirmasi pembayaran');
            }
        }

        // ============================================
        // PRORATA CALCULATOR
        // ============================================

        function hitungProrata() {
    try {
        const biayaBulanan = parseFloat(document.getElementById('prorataBiaya').value) || 0;
        const mulaiStr = document.getElementById('prorataMulai').value;
        const akhirStr = document.getElementById('prorataAkhir').value;

        if (!mulaiStr || !akhirStr) {
            showToast('error', 'Error', 'Isi tanggal mulai dan akhir');
            return;
        }

        const tanggalMulai = moment(mulaiStr);
        const tanggalAkhir = moment(akhirStr);

        if (!tanggalMulai.isValid() || !tanggalAkhir.isValid()) {
            showToast('error', 'Error', 'Format tanggal tidak valid');
            return;
        }

        if (tanggalAkhir.isBefore(tanggalMulai)) {
            showToast('error', 'Error', 'Tanggal akhir harus setelah tanggal mulai');
            return;
        }

        // Hitung jumlah hari
        const jumlahHari = tanggalAkhir.diff(tanggalMulai, 'days') + 1;
        document.getElementById('prorataHari').value = jumlahHari;

        // Hitung prorata: (biaya bulanan / 30) × jumlah hari
        const hargaPerHari = biayaBulanan / 30;
        const totalProrata = Math.round(hargaPerHari * jumlahHari);

        document.getElementById('prorataHasil').textContent = formatRupiah(totalProrata);

        // Tampilkan detail perhitungan
        const detail = `
            Perhitungan:
            - Biaya bulanan: ${formatRupiah(biayaBulanan)}
            - Per hari: ${formatRupiah(Math.round(hargaPerHari))}
            - Jumlah hari: ${jumlahHari} hari
            - Total prorata: ${formatRupiah(totalProrata)}
        `;

        console.log(detail);

    } catch (error) {
        console.error("Error hitung prorata:", error);
        showToast('error', 'Error', 'Gagal menghitung prorata');
    }
}

        // ============================================
        // FUNGSI: KIRIM REMINDER
        // ============================================

        async function kirimReminder() {
    // GANTI INI:
    // const select = document.getElementById('reminderPelanggan');
    // if (!select.value) { ... }

    // MENJADI INI:
    const jenis = document.getElementById('reminderType')?.value || 'whatsapp';
    const pesan = document.getElementById('previewPesan')?.value || '';
    const jadwal = document.getElementById('reminderSchedule')?.value || 'now';

    if (!pesan.trim()) {
        showToast('error', 'Error', 'Pesan tidak boleh kosong!');
        return;
    }

    try {
        showLoading();

        // Update tombol
        const btn = document.querySelector('#modalReminder .btn-primary');
        if (btn) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> MENGIRIM...';
            btn.disabled = true;
        }

        // 1. Ambil semua pelanggan dengan tunggakan
        const tunggakanSnapshot = await db.collection('tagihan')
            .where('company_id', '==', globalCompanyId)
            .where('status', 'in', ['belum', 'telat'])
            .get();

        if (tunggakanSnapshot.empty) {
            hideLoading();
            showToast('warning', 'Tidak Ada Data', 'Tidak ada pelanggan dengan tunggakan');
            return;
        }

        const pelangganIds = [];
        tunggakanSnapshot.forEach(doc => {
            const pelId = doc.data().pelanggan_id;
            if (pelId && !pelangganIds.includes(pelId)) {
                pelangganIds.push(pelId);
            }
        });

        // 2. Kirim ke setiap pelanggan
        let berhasil = 0;
        const totalPelanggan = pelangganIds.length;

        for (const id of pelangganIds) {
            try {
                const doc = await db.collection('pelanggan').doc(id).get();
                if (doc.exists) {
                    const p = doc.data();

                    // Log pengiriman
                    await db.collection('reminder_log').add({
                        pelanggan_id: id,
                        pelanggan_nama: p.nama || '',
                        pelanggan_telepon: p.telepon || '',
                        jenis: jenis,
                        pesan: pesan.trim(),
                        status: 'terkirim',
                        tanggal: new Date().toISOString(),
                        jadwal_kirim: jadwal,
                        company_id: globalCompanyId,
                        user: getUserLogName()
                    });

                    berhasil++;
                }
            } catch (err) {
                console.error(`Gagal log untuk ${id}:`, err);
            }
        }

        // 3. Tampilkan hasil
        hideLoading();

        if (btn) {
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Kirim ke Semua Pelanggan';
            btn.disabled = false;
        }

        showToast('success', 'Berhasil',
            `${berhasil} dari ${totalPelanggan} reminder berhasil dikirim`);

        // 4. Update summary status
        const summaryStatus = document.getElementById('summaryStatus');
        if (summaryStatus) {
            summaryStatus.innerHTML =
                `<span class="badge badge-success">TERKIRIM ${berhasil}/${totalPelanggan}</span>`;
        }

        // 5. Auto close modal setelah 2 detik
        setTimeout(() => {
            hideModal('modalReminder');
        }, 2000);

    } catch (error) {
        hideLoading();
        console.error("Error kirim reminder:", error);
        showToast('error', 'Gagal', error.message);

        // Reset tombol
        const btn = document.querySelector('#modalReminder .btn-primary');
        if (btn) {
            btn.innerHTML = '<i class="fas fa-paper-plane"></i> Kirim ke Semua Pelanggan';
            btn.disabled = false;
        }
    }

}

// 1. FUNGSI loadPelangganForReminder() - YANG SUDAH ADA
// 2. FUNGSI kirimReminder() - YANG SUDAH ADA
// 3. FUNGSI BARU: updateSummaryReminder()

function updateSummaryReminder() {
    const media = document.getElementById('reminderType').value;
    const jadwal = document.getElementById('reminderSchedule').value;

    let waktuText = "Sekarang";
    if (jadwal === "tomorrow") waktuText = "Besok Pagi (08:00)";
    if (jadwal === "afternoon") waktuText = "Sore Ini (16:00)";

    document.getElementById('summaryMedia').textContent = media;
    document.getElementById('summaryWaktuReminder').textContent = waktuText;
}

// ============================================
// INITIALIZE
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    // Event saat modal dibuka
    const modal = document.getElementById('modalReminder');
    if (modal) {
        modal.addEventListener('click', function() {
            if (this.classList.contains('show')) {
                loadPelangganForReminder();
            }
        });
    }

    // Tombol kirim
    const btnKirim = document.getElementById('btnKirimReminder');
    if (btnKirim) {
        btnKirim.onclick = kirimReminder;
    }
});

        // ============================================
        // EXPORT FUNCTIONS
        // ============================================

        async function exportData() {
    if (localStorage.getItem('userRole') !== 'admin') {
        alert('❌ HANYA ADMIN YANG BOLEH EXPORT DATA!');
        return;
    }

    try {
        showLoading();
        const type = document.getElementById('exportType').value;
        const format = document.querySelector('input[name="exportFormat"]:checked')?.value || 'excel';

        let data = [];
        let filename = '';

        if (type === 'pelanggan') {
            const snapshot = await db.collection('pelanggan')
    .where('company_id', '==', globalCompanyId)  // ⭐ FILTER COMPANY
    .get();
            data = snapshot.docs.map(doc => {
                const p = doc.data();
                return {
                    ID: doc.id,
                    Nama: p.nama,
                    Telepon: p.telepon,
                    Email: p.email,
                    Alamat: p.alamat,
                    Paket: p.paket,
                    Harga: p.harga,
                    Status: p.status,
                    'Tanggal Pasang': p.tanggal_pasang,
                    'Tanggal Update': p.updated_at
                };
            });
            filename = `pelanggan_${moment().format('YYYYMMDD_HHmmss')}`;
        } else if (type === 'paket') {
            const snapshot = await db.collection('paket')
    .where('company_id', '==', globalCompanyId)  // ⭐ FILTER COMPANY
    .get();
            data = snapshot.docs.map(doc => {
                const p = doc.data();
                return {
                    ID: doc.id,
                    'Nama Paket': p.nama,
                    Kecepatan: p.kecepatan,
                    Harga: p.harga,
                    Kuota: p.kuota,
                    Deskripsi: p.deskripsi,
                    Fitur: p.fitur,
                    Status: p.status,
                    'Tanggal Buat': p.created_at
                };
            });
            filename = `paket_${moment().format('YYYYMMDD_HHmmss')}`;
        } else if (type === 'tagihan') {
            const snapshot = await db.collection('tagihan').limit(100).get();
            data = snapshot.docs.map(doc => {
                const t = doc.data();
                return {
                    Invoice: t.id,
                    Pelanggan: t.pelanggan_nama,
                    Bulan: t.bulan,
                    Jumlah: t.jumlah,
                    Status: t.status,
                    'Jatuh Tempo': t.tanggal_jatuh_tempo,
                    'Tanggal Bayar': t.tanggal_bayar || '-',
                    'Metode Bayar': t.metode_bayar || '-',
                    Denda: t.denda || 0
                };
            });
            filename = `tagihan_${moment().format('YYYYMMDD_HHmmss')}`;
        }

        if (format === 'excel') {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, `${filename}.xlsx`);
        } else if (format === 'csv') {
            const csv = XLSX.utils.sheet_to_csv(XLSX.utils.json_to_sheet(data));
            downloadCSV(csv, `${filename}.csv`);
        }

        hideLoading();
        showToast('success', 'Berhasil', 'Data berhasil diexport');

    } catch (error) {
        console.error("Error exporting:", error);
        hideLoading();
        showToast('error', 'Error', 'Gagal export data');
    }
}

        // ============================================
        // OTHER BUTTON FUNCTIONS
        // ============================================

        function refreshDashboard() {
            renderDashboard();

        }

        function exportPelanggan() {
            // For now, just export data
            document.getElementById('exportType').value = 'pelanggan';
            exportData();
        }

        function generateSingleTagihan(pelangganId) {

            // Implementation would be similar to bulk generate but for single customer
        }

        function sendReminderSingle(pelangganId) {
        }

        function printPelanggan() {
            window.print();
        }

        function exportPelangganPDF() {
            showToast('info', 'Coming Soon', 'Export PDF akan segera tersedia');
        }

        function exportPaket() {
            document.getElementById('exportType').value = 'paket';
            exportData();
        }

        function printTagihan() {
            window.print();
        }

        function exportTagihanPDF() {
            showToast('info', 'Coming Soon', 'Export PDF akan segera tersedia');
        }

        // FUNGSI EXPORT TUNGGAKAN - PERBAIKAN
async function exportTunggakan() {
    try {
        showLoading();

        // Ambil data tunggakan langsung dari database
        const snapshot = await db.collection('tagihan')
            .where('company_id', '==', globalCompanyId)
            .where('status', 'in', ['belum', 'telat'])
            .get();

        if (snapshot.empty) {
            hideLoading();
            showToast('warning', 'Data Kosong', 'Tidak ada data tunggakan untuk diexport');
            return;
        }

        // Ambil data pelanggan untuk mapping
        const pelangganSnapshot = await db.collection('pelanggan')
            .where('company_id', '==', globalCompanyId)
            .get();

        const pelangganMap = {};
        pelangganSnapshot.forEach(doc => {
            pelangganMap[doc.id] = doc.data();
        });

        // Format data untuk Excel
        const data = [
            ['No', 'Nama Pelanggan', 'Telepon', 'Bulan Tagihan', 'Nominal', 'Jatuh Tempo', 'Hari Telat', 'Status']
        ];

        let index = 1;
        snapshot.forEach(doc => {
            const t = doc.data();
            const pelanggan = pelangganMap[t.pelanggan_id] || {};
            const hariTelat = t.tanggal_jatuh_tempo ?
                Math.max(0, moment().diff(moment(t.tanggal_jatuh_tempo, 'DD-MM-YYYY'), 'days')) : 0;

            data.push([
                index++,
                pelanggan.nama || '-',
                pelanggan.telepon || '-',
                t.bulan || '-',
                t.jumlah || 0,
                t.tanggal_jatuh_tempo || '-',
                hariTelat,
                t.status === 'telat' ? 'Telat' : 'Belum Bayar'
            ]);
        });

        // Buat Excel
        const now = moment().format('YYYYMMDD_HHmmss');
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, 'Tunggakan');
        XLSX.writeFile(wb, `Data_Tunggakan_${now}.xlsx`);

        hideLoading();
        showToast('success', 'Export Berhasil', `${snapshot.size} data berhasil diexport`);

    } catch (error) {
        hideLoading();
        console.error("❌ Error export tunggakan:", error);
        showToast('error', 'Error', 'Gagal export data: ' + error.message);
    }
}

// FUNGSI PERBAIKAN: SETUP MODAL REMINDER
function setupReminderModal() {
    console.log("⚙️ Setup modal reminder...");

    const modal = document.getElementById('modalReminder');
    if (!modal) {
        console.warn("⚠️ Modal reminder tidak ditemukan");
        return;
    }

    // 1. Setup tombol close
    const closeBtn = modal.querySelector('.modal-close');
    if (closeBtn) {
        closeBtn.onclick = function() {
            modal.classList.remove('show');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        };
    }

    // 2. Setup form submit
    const form = document.getElementById('reminderForm');
    if (form) {
        form.onsubmit = async function(e) {
            e.preventDefault();

            const pelangganSelect = document.getElementById('reminderPelanggan');
            const jenisSelect = document.getElementById('reminderJenis');
            const pesanInput = document.getElementById('reminderPesan');

            if (!pelangganSelect || !jenisSelect || !pesanInput) {
                showToast('error', 'Error', 'Form tidak lengkap');
                return;
            }

            const selectedPelanggan = pelangganSelect.value;
            const jenisReminder = jenisSelect.value;
            const pesan = pesanInput.value.trim();

            if (!selectedPelanggan) {
                showToast('warning', 'Peringatan', 'Pilih pelanggan terlebih dahulu');
                return;
            }

            if (!pesan) {
                showToast('warning', 'Peringatan', 'Masukkan pesan reminder');
                return;
            }

            // Proses kirim reminder...
            console.log("Kirim reminder:", { selectedPelanggan, jenisReminder, pesan });
            showToast('success', 'Berhasil', 'Reminder berhasil dikirim');

            // Tutup modal
            modal.classList.remove('show');
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        };
    }

    // 3. Load pelanggan saat modal dibuka
    modal.addEventListener('click', function(e) {
        if (e.target === modal || modal.classList.contains('show')) {
            // Tunggu sebentar untuk memastikan modal benar-benar terbuka
            setTimeout(() => {
                loadPelangganForReminder();
            }, 200);
        }
    });
}

// FUNGSI LOAD PELANGGAN UNTUK REMINDER (FIXED)
async function loadPelangganForReminder() {
    const container = document.getElementById('reminderPelangganList');
    if (!container) {
        console.error("❌ Element #reminderPelangganList tidak ditemukan!");
        return;
    }

    try {
        container.innerHTML = '<div class="text-center"><div class="spinner"></div> Memuat pelanggan...</div>';

        // Ambil pelanggan dengan tunggakan
        const tunggakanSnapshot = await db.collection('tagihan')
            .where('company_id', '==', globalCompanyId)
            .where('status', 'in', ['belum', 'telat'])
            .get();

        if (tunggakanSnapshot.empty) {
            container.innerHTML = '<div class="text-center text-muted">Tidak ada pelanggan dengan tunggakan</div>';

            // Update summary
            document.getElementById('summaryJumlahPelanggan').textContent = '0';
            document.getElementById('summaryStatus').innerHTML =
                '<span class="badge badge-secondary">TIDAK ADA DATA</span>';

            return;
        }

        // Kumpulkan ID pelanggan unik
        const pelangganIds = [];
        tunggakanSnapshot.forEach(doc => {
            const pelId = doc.data().pelanggan_id;
            if (pelId && !pelangganIds.includes(pelId)) {
                pelangganIds.push(pelId);
            }
        });

        // Ambil detail pelanggan
        let html = '';
        let count = 0;

        for (const id of pelangganIds) {
            const doc = await db.collection('pelanggan').doc(id).get();
            if (doc.exists) {
                const p = doc.data();
                count++;

                html += `
    <div style="
        display: grid;
        grid-template-columns: 2fr 1.5fr 1.5fr auto;
        gap: 15px;
        padding: 12px;
        margin-bottom: 8px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        background: white;
        align-items: center;
    ">
        <div>
            <strong>${p.nama || 'Tanpa Nama'}</strong>
        </div>
        <div>
            <i class="fas fa-phone" style="color: #3498db;"></i>
            ${p.telepon || '-'}
        </div>
        <div>
            <i class="fas fa-envelope" style="color: #e74c3c;"></i>
            ${p.email || '-'}
        </div>
        <div style="color: #e74c3c; font-weight: bold; font-size: 12px;">
            ⚠️ TUNGGAKAN
        </div>
    </div>
`;
            }
        }

        container.innerHTML = html;

        // Update summary
        document.getElementById('summaryJumlahPelanggan').textContent = count;
        updateSummaryReminder(); // Panggil update summary

        console.log(`✅ ${count} pelanggan dengan tunggakan dimuat`);

    } catch (error) {
        console.error("❌ Error load pelanggan:", error);
        container.innerHTML = '<div class="text-center text-danger">Error memuat data</div>';
    }
}


// Panggil setup saat halaman load
document.addEventListener('DOMContentLoaded', function() {
    setupReminderModal();
});

// ============================================
// FUNGSI TAMBAHAN: BUKA MODAL REMINDER
// ============================================

function openReminderModal() {
    console.log("📩 Membuka modal kirim reminder...");

    const modal = document.getElementById('modalReminder');
    if (!modal) {
        showToast('error', 'Error', 'Modal reminder tidak ditemukan');
        return;
    }

    // Tampilkan modal
    modal.classList.remove('hidden');
    modal.classList.add('show');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // Reset form
    const form = document.getElementById('reminderForm');
    if (form) form.reset();

    // Load pelanggan ke dropdown
    setTimeout(() => {
        loadPelangganForReminder();
    }, 300);

    showToast('info', 'Kirim Reminder', 'Pilih pelanggan yang akan dikirimi reminder');
}

// ============================================
// EVENT LISTENER UNTUK MODAL REMINDER
// ============================================

// Pasang event listener saat halaman load
document.addEventListener('DOMContentLoaded', function() {
    // Tombol "Kirim Reminder" di halaman Tunggakan
    const btnReminder = document.querySelector('[onclick*="modalReminder"]');
    if (btnReminder) {
        btnReminder.onclick = openReminderModal;
    }

    // Tombol close modal
    const modalClose = document.querySelector('#modalReminder .modal-close');
    if (modalClose) {
        modalClose.onclick = function() {
            document.getElementById('modalReminder').classList.remove('show');
            document.getElementById('modalReminder').classList.add('hidden');
            document.body.style.overflow = 'auto';
        };
    }

    // Tombol di quick actions (jika ada)
    const quickActionBtn = document.getElementById('btnKirimReminder');
    if (quickActionBtn) {
        quickActionBtn.onclick = openReminderModal;
    }
});

// FUNGSI REFRESH TUNGGAKAN SAJA
// FUNGSI REFRESH TUNGGAKAN SAJA (TIDAK RELOAD HALAMAN)
function refreshTunggakan() {
    console.log("🔄 Refresh data tunggakan...");

    try {
        // 1. Tampilkan loading indicator di tabel
        const table = document.getElementById('tunggakanTable');
        if (table) {
            const originalContent = table.innerHTML;
            table.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center" style="padding: 30px;">
                        <div class="spinner" style="width: 30px; height: 30px; margin: 0 auto;"></div>
                        <p style="margin-top: 10px; color: #666;">Memperbarui data tunggakan...</p>
                    </td>
                </tr>
            `;

            // 2. Reset input pencarian (opsional, bisa dihapus jika tidak mau reset)
            const searchInput = document.getElementById('searchTunggakan');
            if (searchInput) {
                searchInput.value = '';
            }

            // 3. Reset ke halaman 1
            halamanTunggakanSaatIni = 1;

            // 4. Load ulang data setelah delay kecil untuk efek visual
            setTimeout(async () => {
                try {
                    await loadTunggakanData('semua');
                } catch (error) {
                    // Kembalikan konten asli jika error
                    table.innerHTML = originalContent;
                    console.error("Error refresh:", error);
                    showToast('error', 'Gagal', 'Gagal memuat data ulang');
                }
            }, 500);
        } else {
            // Jika tabel tidak ditemukan, cukup panggil loadTunggakanData
            loadTunggakanData('semua');
            showToast('info', 'Refresh', 'Memuat ulang data tunggakan');
        }

    } catch (error) {
        console.error("Error refreshTunggakan:", error);
        showToast('error', 'Error', 'Gagal refresh data');
    }
}

// UPDATE TOMBOL REFRESH DI HTML (ganti onclick yang ada):
// Dari: onclick="location.reload()"
// Menjadi: onclick="refreshTunggakan()"



        function generateTunggakanReport() {
            showToast('info', 'Coming Soon', 'Laporan tunggakan akan segera tersedia');
        }

        function sendWhatsAppReminder() {
            showToast('info', 'Coming Soon', 'WhatsApp reminder akan segera tersedia');
        }

        function suspendingPelanggan(pelangganId) {
            confirmDialog('Suspend pelanggan ini?', async () => {
                try {
                    showLoading();
                    await db.collection('pelanggan').doc(pelangganId).update({
                        status: 'nonaktif'
                    });

                    hideLoading();
                    showToast('success', 'Berhasil', 'Pelanggan berhasil disuspend');

                    if (currentPage === 'tunggakan') {
                        await loadTunggakanData();
                    }

                } catch (error) {
                    console.error("Error suspending pelanggan:", error);
                    hideLoading();
                    showToast('error', 'Error', 'Gagal suspend pelanggan');
                }
            });
        }

        function viewInvoice(tagihanId) {
            showToast('info', 'Coming Soon', 'View invoice akan segera tersedia');
        }

        function printInvoice(tagihanId) {
            showToast('info', 'Coming Soon', 'Print invoice akan segera tersedia');
        }

        function downloadTemplate() {
            showToast('info', 'Coming Soon', 'Download template akan segera tersedia');
        }

        async function importExcel() {
            try {
                const fileInput = document.getElementById('fileImport');
                const file = fileInput.files[0];

                if (!file) {
                    showToast('error', 'Error', 'Pilih file terlebih dahulu');
                    return;
                }

                showLoading();

                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        // Process data based on import type
                        const importType = document.getElementById('importType').value;

                        showToast('success', 'Berhasil', `${jsonData.length} data berhasil diimport`);

                        hideLoading();

                    } catch (error) {
                        console.error("Error importing data:", error);
                        hideLoading();
                        showToast('error', 'Error', 'Gagal import data');
                    }
                };

                reader.readAsArrayBuffer(file);

            } catch (error) {
                console.error("Error importing:", error);
                hideLoading();
                showToast('error', 'Error', 'Gagal import data');
            }
        }

        function backupManual() {
            showModal('modalBackup');
        }

        function startBackup() {
            showToast('info', 'Coming Soon', 'Backup otomatis akan segera tersedia');
        }

        function restoreBackup() {
            showToast('info', 'Coming Soon', 'Restore backup akan segera tersedia');
        }

        function generateLaporan() {
            showToast('info', 'Coming Soon', 'Generate laporan akan segera tersedia');
        }

        function printLaporan() {
            window.print();
        }

        function exportLaporan() {
            showModal('modalExportLaporan');
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================

        // Login Handler
        // Event Listener Login
document.getElementById('loginForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();

    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;

    // Validasi input kosong
    if (!username || !password) {
        showToast('error', 'Login Gagal', 'Email dan Password wajib diisi');
        return;
    }

    // ⭐⭐ CEK LOCKOUT STATUS ⭐⭐
    const lockoutCheck = checkLoginLockout();
    if (lockoutCheck.locked) {
        showToast('error', 'Akun Terkunci',
            `Terlalu banyak percobaan gagal. Coba lagi dalam ${lockoutCheck.remainingMinutes} menit.`);
        return;
    }

    // Ambil elemen tombol submit untuk efek loading
    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;

    try {
        // Ubah tombol jadi loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Login...';
        showLoading();

        let loginSuccess = false;
        let userData = null;

        // 1. COBA LOGIN SEBAGAI ADMIN HARDCODED
        if (username === 'admin' && password === 'admin123') {
            console.log("🔐 Login sebagai Admin Hardcoded");

            userData = {
                uid: 'admin_hardcoded',
                name: 'Administrator',
                email: 'admin@xbill.com',
                role: 'admin'
            };

            loginSuccess = true;
        }
        // 2. COBA LOGIN SEBAGAI KARYAWAN (EMAIL)
        else if (username.includes('@')) {
            console.log("🔐 Login dengan email:", username);

            // ⭐⭐ PERBAIKAN: CEK DI KARYAWAN DULU ⭐⭐
            const karyawanSnapshot = await db.collection('karyawan')
                .where('email', '==', username.toLowerCase())
                .limit(1)
                .get();

            if (!karyawanSnapshot.empty) {
                const karyawanDoc = karyawanSnapshot.docs[0];
                const karyawan = karyawanDoc.data();

                // ⭐⭐ CEK STATUS AKTIF ⭐⭐
                if (karyawan.status !== 'aktif') {
                    throw new Error("Akun karyawan tidak aktif");
                }

                // Verifikasi password (base64 hash sederhana)
                if (karyawan.password === btoa(password)) {
                    userData = {
                        uid: karyawanDoc.id,
                        name: karyawan.nama,
                        email: karyawan.email,
                        role: karyawan.role,
                        telepon: karyawan.telepon || '',
                        karyawan_id: karyawanDoc.id
                    };
                    loginSuccess = true;

                    // Update last login
                    await db.collection('karyawan').doc(karyawanDoc.id).update({
                        last_login: new Date().toISOString()
                    });

                    console.log("✅ Login karyawan berhasil:", karyawan.nama);
                } else {
                    throw new Error("Password salah");
                }
            }
            // ⭐⭐ PERBAIKAN: JIKA TIDAK ADA DI KARYAWAN, CEK DI FIREBASE AUTH ⭐⭐
            else {
                console.log("⚠️ Email tidak ada di karyawan, coba login sebagai user...");

                try {
                    const authResult = await firebase.auth().signInWithEmailAndPassword(username, password);
                    const user = authResult.user;

                    // Ambil data user dari collection users
                    const userDoc = await db.collection('users').doc(user.uid).get();

                    if (userDoc.exists) {
                        const userDataDB = userDoc.data();
                        userData = {
                            uid: user.uid,
                            name: userDataDB.name || user.email.split('@')[0],
                            email: user.email,
                            role: userDataDB.role || 'user'
                        };
                        loginSuccess = true;

                    } else {
                        throw new Error("Akun tidak terdaftar di sistem");
                    }

                } catch (error) {

                }
            }
        }
        // 3. COBA LOGIN DENGAN USERNAME (BUKAN EMAIL)
        else {
            console.log("🔐 Login dengan username:", username);

            const email = `${username}@xbill.com`;
            try {
                const authResult = await firebase.auth().signInWithEmailAndPassword(email, password);
                const user = authResult.user;

                // Ambil data user dari collection users
                const userDoc = await db.collection('users').doc(user.uid).get();

                if (userDoc.exists) {
                    const userDataDB = userDoc.data();
                    userData = {
                        uid: user.uid,
                        name: userDataDB.name || user.email.split('@')[0],
                        email: user.email,
                        role: userDataDB.role || 'admin'
                    };
                    loginSuccess = true;
                    console.log("✅ Login user berhasil:", user.email);
                } else {
                    throw new Error("Akun tidak terdaftar di sistem");
                }

            } catch (error) {

            }
        }

        // ⭐⭐ JIKA LOGIN SUKSES ⭐⭐
        if (loginSuccess && userData) {
    // Set current user
    currentUser = userData;

    // ⭐⭐ VALIDASI: JIKA NAME ADALAH EMAIL, UBAH ⭐⭐
    if (currentUser.name && currentUser.name.includes('@')) {
        // Name adalah email, ambil bagian sebelum @
        const nameFromEmail = currentUser.name.split('@')[0];
        currentUser.name = nameFromEmail.charAt(0).toUpperCase() + nameFromEmail.slice(1);
        console.log("⚠️ Name diubah dari email:", currentUser.name);
    }

    // ⭐⭐ JIKA NAME KOSONG, BUAT DARI EMAIL ⭐⭐
    if (!currentUser.name || currentUser.name.trim() === '') {
        if (currentUser.email) {
            const nameFromEmail = currentUser.email.split('@')[0];
            currentUser.name = nameFromEmail.charAt(0).toUpperCase() + nameFromEmail.slice(1);
        } else {
            currentUser.name = 'User';
        }
    }

    console.log("✅ Nama user yang akan ditampilkan:", currentUser.name);

    // Simpan ke localStorage
    localStorage.setItem('xbill_user', JSON.stringify(currentUser));
    localStorage.setItem('userName', currentUser.name); // ⭐ INI YANG DITAMPILKAN
    localStorage.setItem('userEmail', currentUser.email);
    localStorage.setItem('userRole', currentUser.role);

    if (currentUser.karyawan_id) {
        localStorage.setItem('karyawanId', currentUser.karyawan_id);
    }
            // ⭐⭐ INISIALISASI COMPANY ID ⭐⭐
            console.log("🏢 Menginisialisasi Company ID...");

            // Cek apakah sudah punya company_id di database
            const userDocRef = db.collection('users').doc(currentUser.uid);
            const userDoc = await userDocRef.get();

            if (userDoc.exists) {
                const existingData = userDoc.data();
                globalCompanyId = existingData.company_id || null;

                if (globalCompanyId) {
                    console.log("✅ Company ID ditemukan:", globalCompanyId);
                } else {
                    console.warn("⚠️ Data user ada tapi company_id kosong. Membuat baru...");
                    const newCompanyId = `COMP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

                    await userDocRef.update({
                        company_id: newCompanyId,
                        updated_at: new Date().toISOString()
                    });

                    await db.collection('company_settings').doc(newCompanyId).set({
                        id: newCompanyId,
                        admin_email: currentUser.email,
                        admin_name: currentUser.name,
                        created_at: new Date().toISOString()
                    });

                    globalCompanyId = newCompanyId;
                    console.log("✅ Company ID baru dibuat:", globalCompanyId);
                }
            } else {
                console.log("📝 Data user belum ada. Membuat dokumen user baru...");
                const newCompanyId = `COMP_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

                await userDocRef.set({
                    uid: currentUser.uid,
                    email: currentUser.email,
                    name: currentUser.name,
                    role: currentUser.role,
                    company_id: newCompanyId,
                    created_at: new Date().toISOString()
                });

                await db.collection('company_settings').doc(newCompanyId).set({
                    id: newCompanyId,
                    admin_email: currentUser.email,
                    admin_name: currentUser.name,
                    created_at: new Date().toISOString()
                });

                globalCompanyId = newCompanyId;
                console.log("✅ User & Company ID baru dibuat:", globalCompanyId);
            }

            // ⭐⭐ RESET LOGIN ATTEMPTS JIKA BERHASIL ⭐⭐
            resetLoginAttempts();

            // ⭐⭐ LOG AKTIVITAS LOGIN ⭐⭐
            await db.collection('aktivitas').add({
                aktivitas: `Login: ${currentUser.name} (${currentUser.role})`,
                user: currentUser.name,
                user_id: currentUser.uid,
                role: currentUser.role,
                company_id: globalCompanyId,
                timestamp: new Date().toISOString()
            });

            // ⭐⭐ UPDATE UI DAN LOAD APLIKASI ⭐⭐

            // Update UI User Info
            const userNameEl = document.getElementById('userName');
            const userAvatarEl = document.getElementById('userAvatar');
            const userRoleEl = document.getElementById('userRole');

            if (userNameEl) userNameEl.textContent = currentUser.name;
            if (userAvatarEl) userAvatarEl.textContent = currentUser.name.charAt(0).toUpperCase();
            if (userRoleEl) {
                // Tampilkan role yang user-friendly
                const roleDisplay = {
                    'admin': 'Admin',
                    'staff_billing': 'Staff Billing',
                    'staff_teknis': 'Staff Teknis',
                    'supervisor': 'Supervisor'
                };
                userRoleEl.textContent = roleDisplay[currentUser.role] || currentUser.role;
            }

            // Switch View: Sembunyikan Login, Tampilkan App
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');

            // Load Dashboard
            // await handleLoginSuccess();

            // Reset tombol
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            hideLoading();


        }

    } catch (error) {
        console.error("❌ Error Login:", error);

        // ⭐⭐ RECORD FAILED ATTEMPT UNTUK LOGIN GAGAL ⭐⭐
        recordFailedLogin();

        // Cek apakah sekarang terkunci
        const newLockoutCheck = checkLoginLockout();
        if (newLockoutCheck.locked) {
            error.message = `Terlalu banyak percobaan gagal. Akun terkunci selama ${newLockoutCheck.remainingMinutes} menit.`;
        } else {
            const remainingAttempts = MAX_LOGIN_ATTEMPTS - loginAttempts;
            error.message = `${error.message} (Sisa percobaan: ${remainingAttempts})`;
        }

        // Reset tombol
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        hideLoading();

        showToast('error', 'Login Gagal', error.message);
    }
});

        // Navigation Handler
        document.addEventListener('click', function(e) {
            const navItem = e.target.closest('.nav-item');
            if (navItem) {
                e.preventDefault();
                const page = navItem.getAttribute('data-page');
                loadPage(page);
            }
        });





        // Di login form, setelah verifikasi:
async function loginKaryawan(email, password) {
    try {
        console.log("🔐 Login karyawan dengan email:", email);

        // 1. CEK DI COLLECTION KARYAWAN
        const snapshot = await db.collection('karyawan')
            .where('email', '==', email.toLowerCase())
            .where('company_id', '==', globalCompanyId)
            .limit(1)
            .get();

        if (snapshot.empty) {
            throw new Error("Email tidak terdaftar");
        }

        const karyawanDoc = snapshot.docs[0];
        const karyawanData = karyawanDoc.data();

        // 2. CEK STATUS AKTIF
        if (karyawanData.status !== 'aktif') {
            throw new Error("Akun karyawan tidak aktif");
        }

        // 3. VERIFIKASI PASSWORD (BASE64)
        const hashedInput = btoa(password);
        if (karyawanData.password !== hashedInput) {
            throw new Error("Password salah");
        }

        // 4. SET CURRENT USER
        currentUser = {
            uid: karyawanDoc.id,
            karyawan_id: karyawanDoc.id,
            name: karyawanData.nama,
            email: karyawanData.email,
            role: karyawanData.role,
            telepon: karyawanData.telepon
        };

        // 5. SIMPAN KE LOCALSTORAGE
        localStorage.setItem('userName', karyawanData.nama);
        localStorage.setItem('userEmail', karyawanData.email);
        localStorage.setItem('userRole', karyawanData.role);
        localStorage.setItem('karyawanId', karyawanDoc.id);
        localStorage.setItem('xbill_user', JSON.stringify(currentUser));

        // 6. UPDATE LAST LOGIN
        await db.collection('karyawan').doc(karyawanDoc.id).update({
            last_login: new Date().toISOString()
        });

        // 7. LOG AKTIVITAS LOGIN
        await db.collection('aktivitas').add({
            aktivitas: `Login karyawan: ${karyawanData.nama}`,
            user: karyawanData.nama,
            user_id: karyawanDoc.id,
            company_id: globalCompanyId,
            timestamp: new Date().toISOString()
        });

        console.log("✅ Login berhasil sebagai karyawan:", karyawanData.nama);
        return true;

    } catch (error) {
        console.error("❌ Login karyawan error:", error);
        throw error;
    }
}

// Fungsi hash password sederhana
function hashPassword(password) {
    // Gunakan library bcrypt di production
    return btoa(password); // Sementara pakai base64
}


function getNamaKaryawan() {
    // Priority 1: Current user session
    if (currentUser && currentUser.name) {
        return currentUser.name;
    }

    // Priority 2: LocalStorage
    const savedName = localStorage.getItem('userName');
    if (savedName) {
        return savedName;
    }

    // Priority 3: Ambil dari Firebase berdasarkan email
    return 'Staff';
}

// ⭐⭐ PAKAI DI SEMUA LOG AKTIVITAS: ⭐⭐
async function logActivity(aktivitas, details = {}) {
    try {
        await db.collection('aktivitas').add({
            aktivitas: aktivitas,
            user: getNamaKaryawan(), // ← NAMA KARYAWAN YANG LOGIN
            user_id: localStorage.getItem('karyawanId') || currentUser?.uid,
            role: localStorage.getItem('userRole') || 'staff',
            company_id: globalCompanyId,
            details: details,
            timestamp: new Date().toISOString()
        });
    } catch (error) {
        console.error("❌ Gagal log aktivitas:", error);
    }
}


async function logActivity(aktivitas, details = {}) {
    try {
        const namaKaryawan = getNamaKaryawan();
        const karyawanId = localStorage.getItem('karyawanId') || currentUser?.uid;

        await db.collection('aktivitas').add({
            aktivitas: aktivitas,
            user: namaKaryawan,
            user_id: karyawanId,
            role: localStorage.getItem('userRole') || 'staff',
            company_id: globalCompanyId,
            details: details,
            timestamp: new Date().toISOString()
        });

        console.log(`📝 Activity by ${namaKaryawan}: ${aktivitas}`);
    } catch (error) {
        console.error("❌ Gagal log aktivitas:", error);
    }
}


async function simpanKaryawan() {
    try {
        const nama = document.getElementById('karyawanNama').value.trim();
        const email = document.getElementById('karyawanEmail').value.trim().toLowerCase();
        const password = document.getElementById('karyawanPassword').value;
        const role = document.getElementById('karyawanRole').value;
        const telepon = document.getElementById('karyawanTelepon').value.trim();
        const catatan = document.getElementById('karyawanCatatan').value.trim();

        // ⭐⭐ VALIDASI EMAIL FORMAT ⭐⭐
        if (!validateEmail(email)) {
            showToast('error', 'Error', 'Format email tidak valid');
            return;
        }

        // Validasi wajib
        if (!nama || !email || !password) {
            showToast('error', 'Error', 'Nama, email dan password wajib diisi');
            return;
        }

        if (password.length < 6) {
            showToast('error', 'Error', 'Password minimal 6 karakter');
            return;
        }

        // ⭐⭐ CEK EMAIL SUDAH TERDAFTAR DI COMPANY INI ⭐⭐
        const checkSnapshot = await db.collection('karyawan')
            .where('email', '==', email)
            .where('company_id', '==', globalCompanyId)
            .get();

        if (!checkSnapshot.empty) {
            showToast('error', 'Error', 'Email sudah terdaftar');
            return;
        }

        // ⭐⭐ SIMPAN KE FIREBASE ⭐⭐
        const karyawanId = `K_${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;

        await db.collection('karyawan').doc(karyawanId).set({
            id: karyawanId,
            nama: nama,
            email: email, // Email sebagai username
            password: btoa(password), // Hash sederhana (base64)
            role: role,
            telepon: telepon,
            catatan: catatan,
            company_id: globalCompanyId,
            status: 'aktif',
            created_at: new Date().toISOString(),
            created_by: currentUser?.uid || 'system',
            last_login: null
        });

        // ⭐⭐ LOG AKTIVITAS ⭐⭐
        await db.collection('aktivitas').add({
            aktivitas: `Tambah karyawan: ${nama} (${email})`,
            user: getNamaKaryawan(),
            user_id: currentUser?.uid,
            company_id: globalCompanyId,
            details: {
                karyawan_id: karyawanId,
                role: role,
                email: email
            },
            timestamp: new Date().toISOString()
        });

        showToast('success', 'Berhasil', `Karyawan ${nama} berhasil ditambahkan`);
        hideModal('modalTambahKaryawan');

        // Reset form
        document.getElementById('formTambahKaryawan').reset();

    } catch (error) {
        console.error("❌ Error simpan karyawan:", error);
        showToast('error', 'Error', 'Gagal menyimpan karyawan');
    }
}

// ⭐⭐ FUNGSI VALIDASI EMAIL ⭐⭐
function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email);
}


// Fungsi untuk menampilkan modal import paket
function showImportPaketModal() {
    const modal = document.getElementById('modalImportPaket');
    if (modal) {
        // Reset file input
        document.getElementById('fileImportPaket').value = '';

        modal.classList.remove('hidden');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        showToast('info', 'Import Paket', 'Membuka form import data paket');
    }
}

// FUNGSI IMPORT DATA PAKET (DENGAN LOGIKA SAMA DENGAN IMPORT PELANGGAN)
async function importDataPaket() {
    const fileInput = document.getElementById('fileImportPaket');

    if (!fileInput || !fileInput.files.length) {
        showToast('error', 'Error', 'Pilih file terlebih dahulu');
        return;
    }

    try {
        showLoading();
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = async function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (jsonData.length === 0) throw new Error('File kosong');

                // AMBIL DATA PAKET YANG SUDAH ADA DI DATABASE
                const snapshot = await db.collection('paket')
                    .where('company_id', '==', globalCompanyId)
                    .get();

                // Buat map untuk cek duplikat (sama seperti di savePaket)
                const existingPackages = {};
                snapshot.forEach(doc => {
                    const p = doc.data();
                    // Key unik: nama + kecepatan + harga
                    const key = `${p.nama}_${p.kecepatan}_${p.harga}`.toLowerCase();
                    existingPackages[key] = true;
                });

                let insertCount = 0;
                let skipCount = 0;
                const batch = db.batch();
                const now = new Date().toISOString();

                for (let i = 0; i < jsonData.length; i++) {
                    try {
                        const row = jsonData[i];

                        // Cari kolom (smart mapping)
                        const keys = Object.keys(row);
                        const findKey = (search) => {
                            return keys.find(k => k.toLowerCase().includes(search.toLowerCase()));
                        };

                        // MAPPING KOLOM (sama seperti di form tambah paket)
                        const namaRaw = row[findKey('nama')] || row[findKey('paket')] || row[findKey('nama_paket')];
                        const kecepatanRaw = row[findKey('kecepatan')] || row[findKey('speed')];
                        const hargaRaw = row[findKey('harga')] || row[findKey('price')];

                        if (!namaRaw || !kecepatanRaw || !hargaRaw) {
                            skipCount++;
                            continue;
                        }

                        const nama = namaRaw.toString().trim().toUpperCase();
                        const kecepatan = kecepatanRaw.toString().trim();
                        const harga = parseInt(hargaRaw.toString().replace(/[^\d]/g, '')) || 0;

                        if (!nama || !kecepatan || harga === 0) {
                            skipCount++;
                            continue;
                        }

                        // CEK DUPLIKAT (sama seperti validasi di savePaket)
                        const uniqueKey = `${nama}_${kecepatan}_${harga}`.toLowerCase();
                        if (existingPackages[uniqueKey]) {
                            skipCount++;
                            continue;
                        }

                        // DATA OPSIONAL (sama field dengan form tambah paket)
                        const kuota = row[findKey('kuota')] ?
                            row[findKey('kuota')].toString().trim() : 'Unlimited';
                        const deskripsi = row[findKey('deskripsi')] ?
                            row[findKey('deskripsi')].toString().trim() : '';

                        // PROSES FITUR (jika ada)
                        let fitur = [];
                        const fiturRaw = row[findKey('fitur')];
                        if (fiturRaw) {
                            fitur = fiturRaw.toString().split(/[,;]/)
                                .map(f => f.trim())
                                .filter(f => f.length > 0);
                        }

                        // STATUS
                        const statusRaw = row[findKey('status')];
                        const status = statusRaw ?
                            statusRaw.toString().trim().toLowerCase() : 'aktif';

                        // Warna default (sama seperti di form)
                        const warna = '#4361ee';

                        // BUAT DATA PAKET (FORMAT SAMA DENGAN savePaket())
                        const paketData = {
                            nama: nama,
                            kecepatan: kecepatan,
                            harga: harga,
                            kuota: kuota,
                            deskripsi: deskripsi,
                            fitur: fitur,
                            status: status,
                            warna: warna,
                            company_id: globalCompanyId, // SAMA
                            created_at: now,             // SAMA
                            updated_at: now              // SAMA
                        };

                        // GENERATE ID (sama pattern dengan savePaket)
                        const paketId = `PAKET_${Date.now()}_${i}_${Math.random().toString(36).substr(2, 9)}`;

                        batch.set(db.collection('paket').doc(paketId), paketData);
                        insertCount++;

                        // TANDAI SUDAH ADA
                        existingPackages[uniqueKey] = true;

                    } catch (err) {
                        console.error(`Error baris ${i+1}:`, err);
                        skipCount++;
                    }
                }

                // SIMPAN KE DATABASE
                if (insertCount > 0) {
                    await batch.commit();

                    // LOG AKTIVITAS (sama seperti di savePaket)
                    await db.collection('aktivitas').add({
                        aktivitas: `Import ${insertCount} paket baru`,
                        user: getUserLogName(),
                        timestamp: now,
                        company_id: globalCompanyId
                    });

                    showToast('success', 'Berhasil',
                        `${insertCount} paket baru ditambahkan<br>` +
                        `${skipCount} data dilewati (sudah ada)`);
                } else {
                    showToast('info', 'Tidak Ada Data Baru',
                        'Semua data sudah ada di sistem');
                }

                hideModal('modalImportPaket');
                await loadPaketData(); // Refresh tabel paket

            } catch (error) {
                hideLoading();
                showToast('error', 'Format Salah', 'File tidak sesuai format');
            }
        };

        reader.onerror = () => {
            hideLoading();
            showToast('error', 'Error', 'Gagal membaca file');
        };

        reader.readAsArrayBuffer(file);

    } catch (error) {
        hideLoading();
        console.error("Error import:", error);
        showToast('error', 'Gagal', 'Gagal import data');
    }
}

function downloadTemplatePaket() {
    const templateData = [
        // HEADER (kolom bisa fleksibel, akan dicari secara smart)
        ['nama_paket', 'kecepatan', 'harga', 'kuota', 'deskripsi', 'fitur', 'status'],
        // CONTOH DATA (format sama dengan form tambah paket)
        ['PAKET 10 MBPS', '10 Mbps', '150000', 'Unlimited', 'Paket hemat untuk browsing', 'Unlimited Bandwidth,24/7 Support', 'aktif'],
        ['PAKET 20 MBPS', '20 Mbps', '250000', 'Unlimited', 'Untuk streaming & gaming', 'Unlimited Bandwidth,Gaming,Streaming HD', 'aktif'],
        ['PAKET 50 MBPS', '50 Mbps', '500000', 'Unlimited', 'Paket bisnis & keluarga', 'Unlimited Bandwidth,Priority Support,4K Streaming', 'aktif']
    ];

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(templateData);
    XLSX.utils.book_append_sheet(wb, ws, 'Template Paket');
    XLSX.writeFile(wb, 'Template_Paket_XBILL.xlsx');

    showToast('success', 'Template', 'Template berhasil didownload');
}


        async function exportPaket() {
    try {
        showLoading();

        // ⭐⭐ HAPUS/COMMENT BARIS INI KARENA ELEMEN TIDAK ADA: ⭐⭐
        // document.getElementById('paketStatusFilter').value = ''; // ← INI YANG ERROR

        // ⭐⭐ AMBIL DATA PAKET DENGAN FILTER COMPANY ⭐⭐
        const snapshot = await db.collection('paket')
            .where('company_id', '==', globalCompanyId)
            .get();

        if (snapshot.empty) {
            hideLoading();
            showToast('warning', 'Data Kosong', 'Tidak ada data paket');
            return;
        }

        // Format data untuk export
        const data = [
            ['No', 'Nama Paket', 'Kecepatan', 'Harga', 'Kuota', 'Status', 'Deskripsi', 'Fitur', 'Created At']
        ];

        let index = 1;
        snapshot.forEach(doc => {
            const paket = doc.data();
            data.push([
                index++,
                paket.nama || '',
                paket.kecepatan || '',
                paket.harga || 0,
                paket.kuota || '',
                paket.status || '',
                paket.deskripsi || '',
                paket.fitur || '',
                paket.created_at ? moment(paket.created_at).format('DD/MM/YYYY HH:mm') : ''
            ]);
        });

        // Export ke Excel
        const now = moment().format('YYYYMMDD_HHmmss');
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        XLSX.utils.book_append_sheet(wb, ws, 'Paket');
        XLSX.writeFile(wb, `Paket_${globalCompanyId}_${now}.xlsx`);

        hideLoading();
        showToast('success', 'Export Berhasil', `${snapshot.size} paket diexport`);

    } catch (error) {
        hideLoading();
        console.error("Error export paket:", error);
        showToast('error', 'Error', 'Gagal export paket: ' + error.message);
    }
}

        // ============================================
// LOGOUT HANDLER (FIXED & CENTRALIZED)
// ============================================

// Fungsi Logout Utama (Global - bisa dipanggil dari tombol mana saja)
// ============================================
// FUNGSI LOGOUT DENGAN POPUP KUSTOM MINIMALIS
// ============================================

async function handleLogout() {
// Tutup semua modal yang masih terbuka
document.querySelectorAll('.modal-overlay.show').forEach(modal => {
    modal.classList.remove('show');
    modal.classList.add('hidden');
});
    console.log("🚪 Proses Logout dimulai...");

    // Buat overlay gelap
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 999999;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
    `;

    // Buat modal sederhana
    const modal = document.createElement('div');
    modal.style.cssText = `
        background: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        width: 90%;
        max-width: 300px;
        animation: slideUp 0.3s ease;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    `;

    modal.innerHTML = `
        <div style="color: #4361ee; font-size: 42px; margin-bottom: 15px;">
            <i class="fas fa-sign-out-alt"></i>
        </div>
        <h3 style="margin: 0 0 10px 0; color: #2d3436;">Logout?</h3>
        <p style="color: #636e72; margin-bottom: 25px; font-size: 14px;">Anda akan keluar dari sistem</p>
        <div style="display: flex; gap: 10px;">
            <button id="btnLogoutCancel" style="
                flex: 1;
                padding: 12px;
                border: 1px solid #ddd;
                background: white;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                color: #636e72;
                transition: all 0.2s;
            " onmouseover="this.style.borderColor='#4361ee'" onmouseout="this.style.borderColor='#ddd'">
                Batal
            </button>
            <button id="btnLogoutConfirm" style="
                flex: 1;
                padding: 12px;
                border: none;
                background: #4361ee;
                color: white;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.2s;
            " onmouseover="this.style.background='#3a56d4'" onmouseout="this.style.background='#4361ee'">
                Logout
            </button>
        </div>
        <style>
            @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
            @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        </style>
    `;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    document.body.style.overflow = 'hidden';

    // Fungsi untuk menutup modal
    const closeModal = () => {
        overlay.remove();
        document.body.style.overflow = 'auto';
    };

    // Event listeners
    document.getElementById('btnLogoutCancel').onclick = closeModal;

    document.getElementById('btnLogoutConfirm').onclick = async function() {
        const btn = this;
        const originalText = btn.textContent;
        btn.textContent = 'Loading...';
        btn.disabled = true;

        try {
            // Log aktivitas
            await db.collection('aktivitas').add({
                aktivitas: `User logout`,
                user: getUserLogName(),
                timestamp: new Date().toISOString(),
                company_id: globalCompanyId
            });

            // Reset login attempts
            resetLoginAttempts();

            // Firebase logout
            if (firebase.auth()) {
                await firebase.auth().signOut();
            }

            // Reset variabel
            currentUser = null;
            globalCompanyId = null;

            // Clear localStorage
            localStorage.removeItem('userName');
            localStorage.removeItem('userRole');
            localStorage.removeItem('xbill_user');
            localStorage.removeItem('xbill_company_id');

            // Close modal
            closeModal();

            // Show login page
            document.getElementById('appContainer').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');

            // Reset login form
            const loginForm = document.getElementById('loginForm');
            if (loginForm) loginForm.reset();

            // Toast notification
            showToast('success', 'Logout Berhasil', 'Sampai jumpa kembali!');

        } catch (error) {
            console.error("Logout error:", error);
            closeModal();
            showToast('error', 'Error', 'Gagal logout');
        }
    };

    // Close on overlay click
    overlay.onclick = (e) => {
        if (e.target === overlay) {
            closeModal();
        }
    };
}

// Event Listener untuk tombol logout di Navbar (ID: logoutBtn)
const logoutBtnMain = document.getElementById('logoutBtn');
if (logoutBtnMain) {
    logoutBtnMain.addEventListener('click', handleLogout);
}

// Event Listener untuk tombol logout kecil di User Menu (ID: logoutBtnSmall)
const logoutBtnSmall = document.getElementById('logoutBtnSmall');
if (logoutBtnSmall) {
    logoutBtnSmall.addEventListener('click', handleLogout);
}


function showComingSoon() {
    showToast('info', 'Coming Soon', 'Fitur sedang dikembangkan');
}


        // ==========================================
// FUNGSI PLACEHOLDER SETTING (MENGATASI ERROR)
// ==========================================

// ============================================
// 1. PROFIL PERUSAHAAN
// ============================================
function showCompanyProfile() {
    // ⭐⭐ RESET FORM - KOSONGKAN SEMUA ⭐⭐
    const form = document.getElementById('formCompanyProfile');
    if (form) form.reset();

    // ⭐⭐ KOSONGKAN MANUAL SEMUA FIELD ⭐⭐
    document.getElementById('companyName').value = '';
    document.getElementById('companyTagline').value = '';
    document.getElementById('companyAddress').value = '';
    document.getElementById('companyPhone').value = '';
    document.getElementById('companyEmail').value = '';
    document.getElementById('companyWebsite').value = '';
    document.getElementById('companyNPWP').value = '';
    document.getElementById('companyDirector').value = '';
    document.getElementById('companyType').value = 'isp';
    document.getElementById('invoicePrefix').value = 'INV';
    document.getElementById('invoiceFooter').value = '';
    document.getElementById('invoiceTerms').value = '';

    // ⭐⭐ AMBIL DATA HANYA UNTUK COMPANY INI ⭐⭐
    db.collection('company_settings').doc(globalCompanyId).get()
        .then(doc => {
            if (doc.exists) {
                const data = doc.data();

                // ⭐⭐ PASTIKAN INI DATA COMPANY YANG SEDANG LOGIN ⭐⭐
                if (data.company_id !== globalCompanyId) {
                    console.error("❌ DATA BUKAN UNTUK COMPANY INI!");
                    return; // JANGAN ISI FORM DENGAN DATA COMPANY LAIN
                }

                // ISI FORM DENGAN DATA COMPANY INI
                if (data.companyName) document.getElementById('companyName').value = data.companyName;
                if (data.companyTagline) document.getElementById('companyTagline').value = data.companyTagline;
                if (data.companyAddress) document.getElementById('companyAddress').value = data.companyAddress;
                if (data.companyPhone) document.getElementById('companyPhone').value = data.companyPhone;
                if (data.companyEmail) document.getElementById('companyEmail').value = data.companyEmail;
                if (data.companyWebsite) document.getElementById('companyWebsite').value = data.companyWebsite;
                if (data.companyNPWP) document.getElementById('companyNPWP').value = data.companyNPWP;
                if (data.companyDirector) document.getElementById('companyDirector').value = data.companyDirector;
                if (data.companyType) document.getElementById('companyType').value = data.companyType;
                if (data.invoicePrefix) document.getElementById('invoicePrefix').value = data.invoicePrefix;
                if (data.invoiceFooter) document.getElementById('invoiceFooter').value = data.invoiceFooter;
                if (data.invoiceTerms) document.getElementById('invoiceTerms').value = data.invoiceTerms;
            }
            // JIKA TIDAK ADA DATA: FORM TETAP KOSONG (CORRECT)
        })
        .catch(error => {
            console.error("Error load company data:", error);
        });

    // TAMPILKAN MODAL
    document.getElementById('modalCompanyProfile').classList.remove('hidden');
    document.getElementById('modalCompanyProfile').classList.add('show');
    document.body.style.overflow = 'hidden';
}

// ============================================
// 2. BRANDING
// ============================================
function showBrandingSettings() {
    // Fungsi sederhana, cuma buka modal
    showModal('modalBranding');
}

// ============================================
// 3. KONTAK & NOTIFIKASI
// ============================================
async function showContactSettings() {
    try {
        const docRef = db.collection('settings').doc('contacts');
        const doc = await docRef.get();

        if (doc.exists) {
            const data = doc.data();
            if (document.getElementById('whatsappNumber')) document.getElementById('whatsappNumber').value = data.whatsapp_number || '';
            if (document.getElementById('whatsappApiKey')) document.getElementById('whatsappApiKey').value = data.whatsapp_api_key || '';
            if (document.getElementById('enableWhatsApp')) document.getElementById('enableWhatsApp').checked = data.enable_whatsapp || false;
            if (document.getElementById('smtpHost')) document.getElementById('smtpHost').value = data.smtp_host || '';
            if (document.getElementById('smtpPort')) document.getElementById('smtpPort').value = data.smtp_port || '';
            if (document.getElementById('smtpEmail')) document.getElementById('smtpEmail').value = data.smtp_email || '';
            if (document.getElementById('smtpPassword')) document.getElementById('smtpPassword').value = data.smtp_password || '';
            if (document.getElementById('enableSSL')) document.getElementById('enableSSL').checked = data.enable_ssl || false;
            if (document.getElementById('smsProvider')) document.getElementById('smsProvider').value = data.sms_provider || '';
            if (document.getElementById('smsApiKey')) document.getElementById('smsApiKey').value = data.sms_api_key || '';
            if (document.getElementById('smsSecret')) document.getElementById('smsSecret').value = data.sms_secret || '';
            if (document.getElementById('enableSMS')) document.getElementById('enableSMS').checked = data.enable_sms || false;

            // Checkboxes Notifikasi
            if (document.getElementById('notifNewCustomer')) document.getElementById('notifNewCustomer').checked = data.notif_new_customer || false;
            if (document.getElementById('notifPayment')) document.getElementById('notifPayment').checked = data.notif_payment || false;
            if (document.getElementById('notifOverdue')) document.getElementById('notifOverdue').checked = data.notif_overdue || false;
            if (document.getElementById('reminder3Days')) document.getElementById('reminder3Days').checked = data.reminder_3days || false;
            if (document.getElementById('reminder1Day')) document.getElementById('reminder1Day').checked = data.reminder_1day || false;
            if (document.getElementById('reminderOverdue')) document.getElementById('reminderOverdue').checked = data.reminder_overdue || false;
        }
        showModal('modalContactSettings');
    } catch (error) {
        console.error("Error show contact settings:", error);
    }
}

// ============================================
// 4. TEMPLATE PESAN
// ============================================
async function showMessageTemplates() {
    try {
        const docRef = db.collection('settings').doc('message_templates');
        const doc = await docRef.get();

        if (doc.exists) {
            const data = doc.data();
            if (document.getElementById('templateReminder3Days')) document.getElementById('templateReminder3Days').value = data.reminder_3days || '';
            if (document.getElementById('templateReminder1Day')) document.getElementById('templateReminder1Day').value = data.reminder_1day || '';
            if (document.getElementById('templateOverdue')) document.getElementById('templateOverdue').value = data.overdue || '';
            if (document.getElementById('templatePaymentConfirmed')) document.getElementById('templatePaymentConfirmed').value = data.payment_confirmed || '';
            if (document.getElementById('templateNewInvoice')) document.getElementById('templateNewInvoice').value = data.new_invoice || '';
        }
        showModal('modalMessageTemplates');
    } catch (error) {
        console.error("Error show templates:", error);
    }
}

// ============================================
// 5. KEUANGAN & PAJAK
// ============================================
async function showFinancialSettings() {
    // Simulasi: Ambil data pajak dari localStorage
    const currentTax = localStorage.getItem('xbill_tax_rate') || '11';

    // Karena modal bawaan mungkin tidak ada input pajak, kita pakai prompt sederhana untuk demo
    const newTax = prompt(`Masukkan Pajak PPN Saat Ini (%):`, currentTax);

    if (newTax !== null) {
        localStorage.setItem('xbill_tax_rate', newTax);
        showToast('success', 'Berhasil', `Pajak diatur ke ${newTax}%`);
    }
}

// ============================================
// 6. KEAMANAN & AKSES (GANTI PASSWORD)
// ============================================
async function showSecuritySettings() {
    showModal('modalChangePassword');
}

// ============================================
// 7. BACKUP & RESTORE
// ============================================
async function showBackupSettings() {
    showModal('modalBackup');
}

// ============================================
// 8. SYSTEM SETTINGS
// ============================================
async function showSystemSettings() {
    // Simulasi: Ambil nama app dari localStorage
    const currentName = localStorage.getItem('xbill_app_name') || document.getElementById('companyNameNav')?.textContent || "X-BILL";

    const newName = prompt("Masukkan Nama Aplikasi:", currentName);

    if (newName) {
        localStorage.setItem('xbill_app_name', newName);
        if (document.getElementById('companyNameNav')) {
            document.getElementById('companyNameNav').textContent = newName;
        }
        showToast('success', 'Berhasil', `Nama aplikasi diubah menjadi ${newName}`);
    }
}

// ============================================
// 9. USER MANAGEMENT (PROFIL SAYA)
// ============================================
// ============================================
// FUNGSI USER MANAGEMENT - GUNAKAN NAMA YANG SUDAH ADA
// ============================================

// FUNGSI 1: showUserManagement() - JIKA BELUM ADA
function showUserManagement() {
    console.log("🚀 MEMBUKA USER MANAGEMENT");

    // CEK EMAIL ADMIN
    const userEmail = firebase.auth().currentUser?.email || currentUser?.email;
    console.log("User email:", userEmail);

    // LIST EMAIL ADMIN YANG DIIZINKAN
    const adminEmails = [
        'admin@xbill.com',
        'administrator@',
        'superadmin@',
        'dovand@gmail.com',  // ⭐ EMAIL LU ⭐
        'dovand.akses@gmail.com',
        'admin'  // untuk user 'admin'
    ];

    // CEK APAKAH EMAIL TERMASUK ADMIN
    let isAdmin = false;
    if (userEmail) {
        const emailLower = userEmail.toLowerCase();
        for (const adminEmail of adminEmails) {
            if (emailLower.includes(adminEmail.toLowerCase())) {
                isAdmin = true;
                break;
            }
        }
    }

    console.log("Is admin?", isAdmin);

    // JIKA BUKAN ADMIN, TETAPI IZINKAN UNTUK TESTING
    if (!isAdmin) {
        // UNTUK TESTING, IZINKAN SEMUA USER
        console.log("⚠️ Bukan admin, tapi diizinkan untuk testing");
        // showToast('warning', 'Testing Mode', 'Akses User Management diizinkan untuk testing');
    }



    // BUKA MODAL
    const modal = document.getElementById('modalUserManagement');
    if (modal) {
        showModal('modalUserManagement');
        // LANGSUNG PANGGIL loadDataKaryawan() DI SINI
        loadDataKaryawan(); // <=== INI YANG BIKIN NOMER URUT
    } else {
        buatModalUserManagement();
    }
}

// FUNGSI 2: loadDataKaryawan() - Load data dari Firebase
async function loadDataKaryawan() {
    try {
        console.log("Memuat data karyawan...");

        const table = document.getElementById('tabelKaryawan');
        if (!table) return;

        table.innerHTML = `<tr><td colspan="7" class="text-center"><div class="spinner"></div> Memuat data...</td></tr>`;

        if (!globalCompanyId) {
            table.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Company ID tidak ditemukan</td></tr>`;
            return;
        }

        const snapshot = await db.collection('users')
            .where('company_id', '==', globalCompanyId)
            .get();

        console.log("Jumlah data:", snapshot.size);

        if (snapshot.empty) {
            table.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Belum ada data karyawan</td></tr>`;
            return;
        }

        let html = '';
        let counter = 1;

        snapshot.forEach((doc) => {
            const user = doc.data();

            // DATA
            const nama = user.nama || '-';
            const email = user.email || '-';
            const role = user.role || '-';
            const status = user.status || 'nonaktif';

            // ROLE BADGE
            let roleBadge = '';
            if (role === 'admin') {
                roleBadge = '<span class="badge badge-primary">Admin</span>';
            } else if (role === 'staff_billing') {
                roleBadge = '<span class="badge badge-success">Staff Billing</span>';
            } else if (role === 'staff_collection') {
                roleBadge = '<span class="badge badge-warning">Staff Collection</span>';
            } else if (role === 'karyawan') {
                roleBadge = '<span class="badge badge-info">Karyawan</span>';
            } else {
                roleBadge = `<span class="badge badge-secondary">${role}</span>`;
            }

            // STATUS BADGE
            const statusBadge = status === 'aktif'
                ? '<span class="badge badge-success">Aktif</span>'
                : '<span class="badge badge-danger">Nonaktif</span>';

            // HAK AKSES
            let hakAksesText = '-';
            if (user.hak_akses) {
                const hak = user.hak_akses;
                const akses = [];
                if (hak.tagihan) akses.push('Tagihan');
                if (hak.tunggakan) akses.push('Tunggakan');
                if (hak.pelanggan) akses.push('Pelanggan');
                if (hak.paket) akses.push('Paket');
                if (hak.laporan) akses.push('Laporan');
                hakAksesText = akses.join(', ') || '-';
            }

            // HTML ROW
            html += `
                <tr>
                    <td style="font-weight: bold;">${counter}</td>
                    <td><strong>${nama}</strong></td>
                    <td>${email}</td>
                    <td>${roleBadge}</td>
                    <td>${statusBadge}</td>
                    <td><small>${hakAksesText}</small></td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline" onclick="editKaryawan('${doc.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="resetPassword('${doc.id}')" title="Reset Password">
                                <i class="fas fa-key"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="hapusKaryawan('${doc.id}', '${nama}')" title="Hapus">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;

            counter++;
        });

        table.innerHTML = html;

    } catch (error) {
        console.error("Error loadDataKaryawan:", error);
        showToast('error', 'Gagal', 'Gagal memuat data karyawan');

        const table = document.getElementById('tabelKaryawan');
        if (table) {
            table.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error: ${error.message}</td></tr>`;
        }
    }
}

// ============================================
// FUNGSI HAPUS KARYAWAN
// ============================================
async function hapusKaryawan(userId, namaKaryawan) {
    // Konfirmasi dengan modal custom
    const modalId = 'confirmHapusKaryawan';

    // Hapus modal lama jika ada
    const oldModal = document.getElementById(modalId);
    if (oldModal) oldModal.remove();

    // Buat modal konfirmasi
    const modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'modal-overlay show';
    modal.style.zIndex = '999999';

    modal.innerHTML = `
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header" style="background: #dc3545; color: white;">
                <h3 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Hapus Karyawan
                </h3>
                <button class="modal-close" onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto'">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 48px; color: #dc3545; margin-bottom: 15px;">
                        <i class="fas fa-user-minus"></i>
                    </div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">Yakin ingin menghapus?</h4>
                    <p style="color: #7f8c8d; line-height: 1.5;">
                        Karyawan: <strong>${namaKaryawan}</strong><br>
                        ID: <small>${userId}</small>
                    </p>
                    <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin: 15px 0; text-align: left;">
                        <i class="fas fa-info-circle" style="color: #856404;"></i>
                        <small style="color: #856404;">Data karyawan akan dihapus permanen dari database.</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 10px;">
                <button class="btn btn-outline" onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto'" style="padding: 10px 20px;">
                    <i class="fas fa-times"></i> Batal
                </button>
                <button id="btnConfirmHapus" class="btn btn-danger" style="padding: 10px 20px;">
                    <i class="fas fa-trash"></i> Ya, Hapus
                </button>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';

    // Event listener untuk tombol konfirmasi
    document.getElementById('btnConfirmHapus').onclick = async function() {
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menghapus...';
        btn.disabled = true;

        try {
            showLoading();

            // Hapus dari Firestore
            await db.collection('users').doc(userId).delete();

            // Hapus dari Firebase Auth (jika ada)
            try {
                // Opsional: Hapus juga dari Firebase Auth
                // Perlu Firebase Admin SDK atau Cloud Function untuk ini
                console.log("User dihapus dari Firestore, auth perlu dihapus manual");
            } catch (authError) {
                console.warn("Tidak bisa hapus dari Auth:", authError);
            }

            // Log aktivitas
            await db.collection('aktivitas').add({
                aktivitas: `Menghapus karyawan: ${namaKaryawan}`,
                user: currentUser?.email || 'Admin',
                timestamp: new Date().toISOString(),
                company_id: globalCompanyId
            });

            hideLoading();

            // Tutup modal konfirmasi
            document.getElementById(modalId).remove();
            document.body.style.overflow = 'auto';

            showToast('success', 'Berhasil', `Karyawan ${namaKaryawan} berhasil dihapus`);

            // Refresh tabel
            if (typeof loadDataKaryawan === 'function') {
                loadDataKaryawan();
            }

        } catch (error) {
            hideLoading();
            console.error("Error hapus karyawan:", error);
            showToast('error', 'Gagal', 'Gagal menghapus karyawan: ' + error.message);

            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    };
}

// ============================================
// FUNGSI EDIT KARYAWAN (AKTIFKAN)
// ============================================
async function editKaryawan(userId) {
    console.log("✏️ Edit karyawan:", userId);

    try {
        showLoading();

        // Ambil data karyawan dari Firestore
        const doc = await db.collection('users').doc(userId).get();

        if (!doc.exists) {
            hideLoading();
            showToast('error', 'Error', 'Data karyawan tidak ditemukan');
            return;
        }

        const data = doc.data();

        // Buat modal edit (sederhana dulu)
        const modalId = 'modalEditKaryawan';

        // Hapus modal lama jika ada
        const oldModal = document.getElementById(modalId);
        if (oldModal) oldModal.remove();

        // Buat modal edit
        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal-overlay show';
        modal.style.zIndex = '999999';

        modal.innerHTML = `
            <div class="modal">
                <div class="modal-header" style="background: #4361ee; color: white;">
                    <h3 class="modal-title">
                        <i class="fas fa-user-edit"></i> Edit Karyawan
                    </h3>
                    <button class="modal-close" onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto'">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="formEditKaryawan">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nama Lengkap *</label>
                                <input type="text" class="form-control" id="editNamaKaryawan" value="${data.nama || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Email *</label>
                                <input type="email" class="form-control" id="editEmailKaryawan" value="${data.email || ''}" required readonly style="background: #f8f9fa;">
                                <small class="text-muted">Email tidak dapat diubah</small>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Telepon *</label>
                                <input type="text" class="form-control" id="editTeleponKaryawan" value="${data.telepon || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Role *</label>
                                <select class="form-control" id="editRoleKaryawan" required>
                                    <option value="staff_billing" ${data.role === 'staff_billing' ? 'selected' : ''}>Staff Billing</option>
                                    <option value="admin" ${data.role === 'admin' ? 'selected' : ''}>Admin</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-control" id="editStatusKaryawan">
                                <option value="aktif" ${data.status === 'aktif' ? 'selected' : ''}>Aktif</option>
                                <option value="nonaktif" ${data.status === 'nonaktif' ? 'selected' : ''}>Nonaktif</option>
                            </select>
                        </div>

                        <input type="hidden" id="editUserId" value="${userId}">
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="document.getElementById('${modalId}').remove(); document.body.style.overflow='auto'">Batal</button>
                    <button class="btn btn-primary" onclick="simpanEditKaryawan()">
                        <i class="fas fa-save"></i> Simpan Perubahan
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';

        hideLoading();

    } catch (error) {
        hideLoading();
        console.error("Error edit karyawan:", error);
        showToast('error', 'Gagal', 'Gagal memuat data karyawan');
    }
}

// ============================================
// FUNGSI SIMPAN EDIT KARYAWAN
// ============================================
async function simpanEditKaryawan() {
    try {
        const userId = document.getElementById('editUserId').value;
        const nama = document.getElementById('editNamaKaryawan').value.trim();
        const telepon = document.getElementById('editTeleponKaryawan').value.trim();
        const role = document.getElementById('editRoleKaryawan').value;
        const status = document.getElementById('editStatusKaryawan').value;

        if (!nama || !telepon) {
            showToast('error', 'Error', 'Nama dan telepon wajib diisi');
            return;
        }

        showLoading();

        // Update di Firestore
        await db.collection('users').doc(userId).update({
            nama: nama,
            telepon: telepon,
            role: role,
            status: status,
            updated_at: new Date().toISOString(),
            updated_by: currentUser?.email || 'Admin'
        });

        // Log aktivitas
        await db.collection('aktivitas').add({
            aktivitas: `Update karyawan: ${nama}`,
            user: currentUser?.email || 'Admin',
            timestamp: new Date().toISOString(),
            company_id: globalCompanyId
        });

        hideLoading();

        // Tutup modal
        const modal = document.getElementById('modalEditKaryawan');
        if (modal) {
            modal.remove();
            document.body.style.overflow = 'auto';
        }

        showToast('success', 'Berhasil', 'Data karyawan berhasil diperbarui');

        // Refresh tabel
        if (typeof loadDataKaryawan === 'function') {
            loadDataKaryawan();
        }

    } catch (error) {
        hideLoading();
        console.error("Error simpan edit:", error);
        showToast('error', 'Gagal', 'Gagal menyimpan perubahan: ' + error.message);
    }
}

// FUNGSI 3: updateStatsKaryawan() - Update statistik
async function updateStatsKaryawan() {
    try {
        const snapshot = await db.collection('users')
            .where('company_id', '==', globalCompanyId)
            .get();

        const total = snapshot.size;
        const adminCount = snapshot.docs.filter(doc => doc.data().role === 'admin').length;
        const staffCount = snapshot.docs.filter(doc => doc.data().role.includes('staff')).length;
        const aktifCount = snapshot.docs.filter(doc => doc.data().status === 'aktif').length;

        // Update elemen jika ada
        const totalEl = document.getElementById('totalKaryawan');
        const adminEl = document.getElementById('adminKaryawan');
        const staffEl = document.getElementById('staffKaryawan');
        const aktifEl = document.getElementById('aktifKaryawan');

        if (totalEl) totalEl.textContent = total;
        if (adminEl) adminEl.textContent = adminCount;
        if (staffEl) staffEl.textContent = staffCount;
        if (aktifEl) aktifEl.textContent = aktifCount;

        // Update badge di card
        const badge = document.querySelector('.setting-card [onclick="showUserManagement()"] .setting-badge');
        if (badge) {
            badge.textContent = total + ' user';
        }

    } catch (error) {
        console.error("Error updateStatsKaryawan:", error);
    }
}

// FUNGSI 4: buatModalUserManagement() - Buat modal jika belum ada
function buatModalUserManagement() {
    console.log("Membuat modal User Management...");

    const modalHTML = `
    <div class="modal-overlay hidden" id="modalUserManagement">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-user-shield"></i> User Management</h3>
                <button class="modal-close" onclick="hideModal('modalUserManagement')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <button class="btn btn-primary" onclick="tambahKaryawan()">
                        <i class="fas fa-user-plus"></i> Tambah Karyawan Baru
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Nama</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Hak Akses</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="tabelKaryawan">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="spinner"></div> Memuat data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="hideModal('modalUserManagement')">Tutup</button>
            </div>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // TUNGGU MODAL RENDER, BARU LOAD DATA
    setTimeout(() => {
        showModal('modalUserManagement');
        // PANGGIL loadDataKaryawan() UNTUK ISI NOMER URUT
        if (typeof loadDataKaryawan === 'function') {
            loadDataKaryawan();
        } else {
            console.error("loadDataKaryawan() tidak ditemukan!");
        }
    }, 100);
}

// FUNGSI 5: tambahKaryawan() - Untuk tombol tambah karyawan
function tambahKaryawan() {
    console.log("tambahKaryawan() dipanggil");

    // 1. TUTUP MODAL USER MANAGEMENT DULU
    hideModal('modalUserManagement');

    // 2. BARU BUKA MODAL TAMBAH KARYAWAN
    setTimeout(() => {
        const modal = document.getElementById('modalTambahKaryawan');
        if (!modal) {
            buatModalTambahKaryawan();
        } else {
            showModal('modalTambahKaryawan');
        }
    }, 300);
}

// FUNGSI 6: buatModalTambahKaryawan() - Modal form
function buatModalTambahKaryawan() {
    const modalHTML = `
    <div class="modal-overlay hidden" id="modalTambahKaryawan">
    <div class="modal">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Tambah Karyawan</h3>
            <button class="modal-close" onclick="hideModal('modalTambahKaryawan')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formTambahKaryawan">
                <!-- NAMA & EMAIL (USERNAME) -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Nama Lengkap *</label>
                        <input type="text" class="form-control" id="karyawanNama" required>
                    </div>
                    <div class="form-group">
                        <label>Email (Username Login) *</label>
                        <input type="email" class="form-control" id="karyawanEmail" required>
                    </div>
                </div>

                <!-- PASSWORD -->
                <div class="form-group">
                    <label>Password *</label>
                    <input type="password" class="form-control" id="karyawanPassword" required>
                    <small class="text-muted">Minimal 6 karakter</small>
                </div>

                <!-- ROLE & TELEPON -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Role *</label>
                        <select class="form-control" id="karyawanRole" required>
                            <option value="staff_billing">Staff_Billing</option>
                            <option value="admin">Admin</option>

                        </select>
                    </div>
                    <div class="form-group">
                        <label>Telepon</label>
                        <input type="tel" class="form-control" id="karyawanTelepon">
                    </div>
                </div>


            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="hideModal('modalTambahKaryawan')">Batal</button>
            <button class="btn btn-primary" onclick="simpanKaryawan()">
                <i class="fas fa-save"></i> Simpan Karyawan
            </button>
        </div>
    </div>
</div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
    showModal('modalTambahKaryawan');
}

// FUNGSI 7: simpanKaryawanBaru() - Save ke Firebase
// ============================================
// FUNGSI SIMPAN KARYAWAN BARU - LENGKAP & FIX
// ============================================

async function simpanKaryawanBaru() {
    console.log("🔄 FUNGSI simpanKaryawanBaru DIPANGGIL");

    try {
        // 1. CEK SEMUA VARIABLE PENTING
        console.log("=== DEBUG INFO ===");
        console.log("1. currentUser:", currentUser);
        console.log("2. currentUser.email:", currentUser?.email);
        console.log("3. currentUser.uid:", currentUser?.uid);
        console.log("4. globalCompanyId:", globalCompanyId);
        console.log("5. Firestore db:", db ? "TERHUBUNG" : "ERROR");

        // 2. JIKA globalCompanyId NULL, BUAT DARI EMAIL ADMIN
        let companyId = globalCompanyId;
        if (!companyId && currentUser && currentUser.email) {
            companyId = currentUser.email.replace(/[@.]/g, '_').toUpperCase() + "_COMPANY";
            console.log("⚠️ Buat companyId dari email:", companyId);
        }

        if (!companyId) {
            showToast('error', 'System Error',
                `Tidak bisa mendapatkan Company ID.
                Admin: ${currentUser?.email || 'Tidak diketahui'}
                Silakan refresh halaman atau logout/login kembali.`);
            return;
        }

        // 3. AMBIL DATA DARI FORM (DENGAN ID YANG BENAR)
        console.log("=== AMBIL DATA DARI FORM ===");

        const nama = document.getElementById('namaKaryawan').value;
        const email = document.getElementById('emailKaryawan').value;
        const telepon = document.getElementById('teleponKaryawan').value;
        const role = document.getElementById('roleKaryawan').value;
        const password = document.getElementById('passwordKaryawan').value;

        console.log("Data form:", {nama, email, telepon, role, password});

        // 4. VALIDASI DATA
        if (!nama || !email || !telepon || !role || !password) {
            showToast('error', 'Form Kosong', 'Harap isi semua field yang wajib');
            return;
        }

        if (password.length < 6) {
            showToast('error', 'Password Lemah', 'Password minimal 6 karakter');
            return;
        }

        // 5. BUAT OBJECT DATA KARYAWAN
        const karyawanData = {
            nama: nama.trim(),
            email: email.trim().toLowerCase(),
            password: btoa("12345678"), // Password default
            telepon: telepon.trim(),
            role: role,
            status: 'aktif',
            company_id: companyId, // INI YANG PASTI ADA
            created_at: new Date().toISOString(),
            created_by: currentUser.email,
            hak_akses: {
                dashboard: true,
                pelanggan: false,
                paket: false,
                tagihan: true,
                tunggakan: true,
                laporan: false,
                setting: false
            }
        };

        console.log("✅ Data siap disimpan:", karyawanData);

        // 6. TAMPILKAN LOADING
        showLoading();

        // 7. SIMPAN DATA KE FIRESTORE SAJA (TANPA MEMBUAT USER DI AUTH)
        console.log("Menyimpan data karyawan ke Firestore...");
        const karyawanId = `K_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        console.log("✅ ID Karyawan dibuat:", karyawanId);


        // 8. SIMPAN DATA KE FIRESTORE
        karyawanData.uid = userId;

        console.log("Menyimpan ke Firestore collection 'users'...");
        await db.collection('users').doc(userId).set(karyawanData);
        console.log("✅ Data tersimpan di Firestore");

                 // Kirim email ke karyawan baru
if (typeof kirimEmailKaryawan === 'function') {
    console.log("📧 Mencoba kirim email ke:", karyawanData.email);

    // GENERATE PASSWORD RANDOM
    const randomPassword = generateRandomPassword(8);

    // UPDATE karyawanData dengan password random (hash)
    karyawanData.password = btoa(randomPassword);
    await db.collection('users').doc(userId).update({
        password: btoa(randomPassword)
    });

    // KIRIM EMAIL DENGAN PASSWORD RANDOM
    kirimEmailKaryawan(karyawanData.email, karyawanData.nama, randomPassword);
} else {
    console.warn("⚠️ Fungsi kirimEmailKaryawan tidak ditemukan");
}

        // 9. UPDATE PROFILE DISPLAY NAME
        await userCredential.user.updateProfile({
            displayName: karyawanData.nama
        });

        // 10. KIRIM EMAIL VERIFIKASI (OPSIONAL)
        try {
            await userCredential.user.sendEmailVerification();
            console.log("✅ Email verifikasi dikirim");
        } catch (emailError) {
            console.log("ℹ️ Email verifikasi gagal, tapi user tetap dibuat");
        }

        // 11. SEMBUNYIKAN LOADING
        hideLoading();

        // 12. TUTUP MODAL
        hideModal('modalTambahKaryawan');

        // 13. TAMPILKAN SUKSES
        showToast('success', 'BERHASIL!',
            `Karyawan "${karyawanData.nama}" berhasil ditambahkan.
            `);



        // 14. RESET FORM
        document.getElementById('namaKaryawan').value = '';
        document.getElementById('emailKaryawan').value = '';
        document.getElementById('teleponKaryawan').value = '';
        document.getElementById('passwordKaryawan').value = '';

        // 15. REFRESH DATA JIKA MODAL USER MANAGEMENT MASIH TERBUKA
        setTimeout(() => {
            if (typeof loadDataKaryawan === 'function') {
                loadDataKaryawan();
            }
        }, 1000);

    } catch (error) {
        // ERROR HANDLING
        console.error("❌ ERROR DETAIL:", error);
        hideLoading();

        // ERROR MESSAGE YANG SPESIFIK
        let errorMessage = 'Gagal menambah karyawan: ';

        if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'Email ini sudah terdaftar di sistem';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'Format email tidak valid';
        } else if (error.code === 'auth/weak-password') {
            errorMessage = 'Password terlalu lemah, minimal 6 karakter';
        } else if (error.code === 'auth/network-request-failed') {
            errorMessage = 'Koneksi internet bermasalah';
        } else if (error.code === 'permission-denied') {
            errorMessage = 'Anda tidak punya izin untuk menambah user';
        } else {
            errorMessage += error.message;
        }

        showToast('error', 'GAGAL', errorMessage);
    }
}

// ============================================
// FUNGSI UNTUK MEMASTIKAN company_id SELALU ADA
// ============================================

async function initCompanyId() {
    console.log("🔄 initCompanyId() dipanggil");

    // 1. CEK DI LOCALSTORAGE
    const savedCompanyId = localStorage.getItem('xbill_company_id');
    if (savedCompanyId) {
        console.log("✅ Company ID dari localStorage:", savedCompanyId);
        globalCompanyId = savedCompanyId;
        return savedCompanyId;
    }

    // 2. JIKA ADA USER LOGIN
    if (currentUser && currentUser.uid) {
        try {
            // CEK DI FIRESTORE
            const userDoc = await db.collection('users').doc(currentUser.uid).get();

            if (userDoc.exists) {
                const userData = userDoc.data();
                if (userData.company_id) {
                    console.log("✅ Company ID dari Firestore:", userData.company_id);
                    globalCompanyId = userData.company_id;
                    localStorage.setItem('xbill_company_id', userData.company_id);
                    return userData.company_id;
                }
            }

            // BUAT BARU JIKA TIDAK ADA
            const newCompanyId = `COMP_${Date.now()}_${Math.random().toString(36).substr(2, 6).toUpperCase()}`;
            console.log("🆕 Buat Company ID baru:", newCompanyId);

            // SIMPAN KE FIRESTORE
            await db.collection('users').doc(currentUser.uid).set({
                uid: currentUser.uid,
                email: currentUser.email,
                nama: currentUser.displayName || currentUser.email.split('@')[0],
                company_id: newCompanyId,
                role: 'admin',
                created_at: new Date().toISOString(),
                status: 'aktif'
            }, { merge: true });

            // SIMPAN KE VARIABLE & LOCALSTORAGE
            globalCompanyId = newCompanyId;
            localStorage.setItem('xbill_company_id', newCompanyId);

            return newCompanyId;

        } catch (error) {
            console.error("❌ Error initCompanyId:", error);

            // FALLBACK: BUAT DARI EMAIL
            const fallbackCompanyId = currentUser.email.replace(/[@.]/g, '_').toUpperCase() + "_COMPANY";
            globalCompanyId = fallbackCompanyId;
            localStorage.setItem('xbill_company_id', fallbackCompanyId);

            return fallbackCompanyId;
        }
    }

    console.error("❌ Tidak ada user login");
    return null;
}

// ============================================
// FIREBASE AUTH LISTENER - YANG RENDER UI
// ============================================
firebase.auth().onAuthStateChanged(async function(user) {
    console.log("🔥 onAuthStateChanged triggered, user:", user ? user.email : "null");

    if (user) {
        currentUser = user;
        console.log("✅ User authenticated, starting UI render...");

        // ⭐⭐ PANGGIL handleLoginSuccess() HANYA DI SINI ⭐⭐
        await handleLoginSuccess();

    } else {
        console.log("❌ No user, show login page");
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('appContainer').classList.add('hidden');
    }
});


// FUNGSI 8: editKaryawan() - Edit data karyawan
function editKaryawan(userId) {
    console.log("Edit karyawan:", userId);
    showToast('info', 'Edit', 'Fitur edit dalam pengembangan');
}

// FUNGSI 9: resetPassword() - Reset password
async function resetPassword(userId) {
    if (!confirm('Reset password karyawan ini?')) return;
    
    try {
        showLoading();
        
        // Generate password baru
        const newPassword = Math.random().toString(36).slice(-8);
        
        // TODO: Implement reset password via Cloud Functions
        
        hideLoading();
        showToast('success', 'Berhasil', 'Password telah direset: ' + newPassword);
        
    } catch (error) {
        hideLoading();
        console.error("Error resetPassword:", error);
        showToast('error', 'Gagal', 'Gagal reset password');
    }
}

// ============================================
// 10. API & INTEGRATION
// ============================================
async function showAPISettings() {
    // Simulasi: Ambil API Key dari localStorage
    const currentKey = localStorage.getItem('xbill_api_key') || "";
    
    const newKey = prompt("Masukkan API Key Integrasi:", currentKey);
    
    if (newKey !== null) {
        localStorage.setItem('xbill_api_key', newKey);
        showToast('success', 'Berhasil', 'API Key berhasil disimpan.');
    }
}

// ============================================
// 11. LOGS & AUDIT
// ============================================
async function showLogsAudit() {
    try {
        showToast('info', 'Memuat Logs...', 'Mengambil riwayat aktivitas.');
        
        const snapshot = await db.collection('aktivitas').orderBy('timestamp', 'desc').limit(50).get();
        
        let logHtml = '<h4 style="margin-bottom:15px;">Riwayat Aktivitas (50 Terakhir)</h4>';
        logHtml += '<div style="max-height: 400px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px;">';
        
        if (snapshot.empty) {
            logHtml += '<p class="text-muted">Belum ada aktivitas.</p>';
        } else {
            logHtml += '<table class="table" style="font-size:12px; margin-bottom:0;">';
            logHtml += '<thead><tr><th>Waktu</th><th>Aktivitas</th><th>User</th></tr></thead><tbody>';
            
            snapshot.forEach(doc => {
                const data = doc.data();
                const time = moment(data.timestamp).format('DD/MM HH:mm');
                logHtml += `<tr><td>${time}</td><td>${data.aktivitas}</td><td>${data.user}</td></tr>`;
            });
            
            logHtml += '</tbody></table>';
        }
        
        logHtml += '</div>';

        // Tampilkan di Modal (Buat modal dinamis jika belum ada)
        let modal = document.getElementById('modalLogsAudit');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'modalLogsAudit';
            modal.className = 'modal-overlay show';
            modal.style.zIndex = '10000';
            modal.innerHTML = `
                <div class="modal modal-lg">
                    <div class="modal-header">
                        <h3 class="modal-title">Logs & Audit Trail</h3>
                        <button class="modal-close" onclick="document.getElementById('modalLogsAudit').remove()">&times;</button>
                    </div>
                    <div class="modal-body" id="logsContent">${logHtml}</div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="document.getElementById('modalLogsAudit').remove()">Tutup</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        } else {
            const content = document.getElementById('logsContent');
            if(content) content.innerHTML = logHtml;
            modal.classList.remove('hidden');
            modal.classList.add('show');
        }
        
    } catch (error) {
        console.error("Error load logs:", error);
        showToast('error', 'Gagal', 'Gagal memuat logs.');
    }
}

// ============================================
// 12. TENTANG APLIKASI
// ============================================
async function showAboutInfo() {
    let modal = document.getElementById('modalAboutInfo');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modalAboutInfo';
        modal.className = 'modal-overlay show';
        modal.innerHTML = `
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Tentang Aplikasi</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                </div>
                <div class="modal-body" style="text-align: center;">
                    <h2 style="color: var(--primary);">X-BILL v2.1.0</h2>
                    <p>Billing Management System untuk ISP</p>
                    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                    <p>Developed by <strong>X-Software</strong></p>
                    <p>&copy; 2024 X-BILL Systems.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Tutup</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    } else {
        modal.classList.remove('hidden');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
}


// ==========================================
// FUNGSI TUTUP MODAL (ANTI-LOOP & ANTI-ERROR)
// ==========================================

function forceCloseModal(modalIdOrElement) {
    // 1. Normalisasi Input: Bisa berupa String ID atau Element HTML
    let modalEl = modalIdOrElement;

    // Jika input string (ID), cari elemennya
    if (typeof modalEl === 'string') {
        modalEl = document.getElementById(modalIdOrElement);
    }

    // 2. Validasi: Jika elemen tidak ditemukan
    if (!modalEl) {
        console.warn(`⚠️ Modal tidak ditemukan: ${modalIdOrElement}`);
        return; // Stop, jangan lanjut agar tidak error
    }

    // 3. Lakukan Penutupan
    try {
        // Hapus class show
        modalEl.classList.remove('show');
        // Tambah class hidden (sesuai CSS Anda)
        modalEl.classList.add('hidden');
        // Reset display style ke none (agar benar-benar hilang)
        modalEl.style.display = 'none';
        
        // Opsional: Jika modal dinamis buatan JS (bukan static di HTML), hapus dari DOM
        // Tapi karena ID Anda statis ('modalCompanyProfile'), kita cukup hide saja.
        
        console.log(`🔒 Modal ditutup: ${modalEl.id || 'Unknown ID'}`);
        
    } catch (error) {
        console.error("❌ Error saat menutup modal:", error);
    } finally {
        // 4. Selalu pastikan body scroll kembali aktif (terlepas dari error di atas)
        document.body.style.overflow = 'auto';
    }
}


// ============================================
// SISTEM KARYAWAN - FIX
// ============================================

// A. MODAL HTML UNTUK KARYAWAN (Tambahkan sebelum )
const karyawanModalHTML = `
<!-- MODAL: TAMBAH KARYAWAN -->
<div class="modal-overlay hidden" id="modalTambahKaryawan">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-user-plus"></i> Tambah Karyawan Baru</h3>
            <button class="modal-close" onclick="hideModal('modalTambahKaryawan')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="formTambahKaryawan">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nama Lengkap *</label>
                        <input type="text" class="form-control" id="namaKaryawan" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" class="form-control" id="emailKaryawan" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Telepon *</label>
                        <input type="text" class="form-control" id="teleponKaryawan" required>
                    </div>
                    <div class="form-group">
                        <label>Role *</label>
                        <select class="form-control" id="roleKaryawan" required>
                            <option value="staff_billing">Staff Billing</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                
               
                
                <div class="form-group">
                    <label>Hak Akses</label>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="aksesTagihan" checked disabled>
                        <label class="form-check-label">Tagihan (Wajib)</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="aksesTunggakan" checked>
                        <label class="form-check-label">Tunggakan</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="aksesPelanggan">
                        <label class="form-check-label">Data Pelanggan (View Only)</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="aksesDashboard">
                        <label class="form-check-label">Dashboard (View Only)</label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
           <div class="modal-footer">
    <button class="btn btn-outline" onclick="kembaliKeUserManagement()">Batal</button>
    <button class="btn btn-primary" onclick="simpanKaryawanBaru()">Simpan</button>
</div>
        </div>
    </div>
</div>
`;

// B. TAMBAHKAN MODAL KE DOM
document.addEventListener('DOMContentLoaded', function() {
    document.body.insertAdjacentHTML('beforeend', karyawanModalHTML);
});



// D. FUNGSI UNTUK MEMBUKA MODAL TAMBAH KARYAWAN
function bukaModalTambahKaryawan() {
    // Reset form
    document.getElementById('formTambahKaryawan').reset();
    
    // Set nilai default
    document.getElementById('aksesTagihan').checked = true;
    document.getElementById('aksesTunggakan').checked = true;
    document.getElementById('aksesPelanggan').checked = false;
    document.getElementById('aksesDashboard').checked = false;
    
    showModal('modalTambahKaryawan');
}


// ============================================
// INISIALISASI EVENT LISTENER - TAMBAHKAN INI
// ============================================

// Tunggu DOM siap



async function getSettingHTML() {
    let currentRole = 'karyawan';
    
    try {
        if (currentUser && currentUser.uid) {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if (userDoc.exists) {
                currentRole = userDoc.data().role || 'karyawan';
            }
        }
    } catch (error) {
        console.error("Error ambil role:", error);
    }
    
    console.log("⚙️ Load Page: Setting. Role:", currentRole);
    // Template HTML Setting
    let settingsHTML = `
        <div class="page setting-page">
            <div class="page-header">
                <h2 class="page-title"><i class="fas fa-cog"></i> System Settings</h2>
            </div>
            
            <!-- SETTING MENU GRID -->
            <div class="settings-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px,1fr)); gap: 20px;">
                
                <!-- CARD 1: PROFIL PERUSAHAAN (HANYA UNTUK ADMIN) -->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showCompanyProfile()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="fas fa-building"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Profil Perusahaan</h3>
                        <p>Kelola data perusahaan, alamat, kontak, dan informasi bisnis</p>
                        <div class="setting-badge">Pengaturan Dasar</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 2: LOGO & BRANDING (HANYA UNTUK ADMIN) -->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showBrandingSettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <i class="fas fa-palette"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Logo & Branding</h3>
                        <p>Custom logo, warna tema, font, dan tampilan aplikasi</p>
                        <div class="setting-badge">UI/UX</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 3: KONTAK & NOTIFIKASI (HANYA UNTUK ADMIN <--showContactSettings--> 
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showComingSoon()"> 
                    <div class="setting-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <i class="fas fa-phone-alt"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Kontak & Notifikasi</h3>
                        <p>WhatsApp, Email, SMS, dan pengaturan notifikasi</p>
                        <div class="setting-badge">Komunikasi</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 4: TEMPLATE PESAN (HANYA UNTUK ADMIN) -->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showMessageTemplates()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <i class="fas fa-comment-alt"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Template Pesan</h3>
                        <p>Custom template untuk reminder, invoice, dan notifikasi</p>
                        <div class="setting-badge">Marketing</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 5: KEUANGAN & PAJAK (HANYA UNTUK ADMIN <--showFinancialSettings-->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showComingSoon()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Keuangan & Pajak</h3>
                        <p>PPN, denda, metode pembayaran, dan laporan keuangan</p>
                        <div class="setting-badge">Financial</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 6: KEAMANAN & AKSES (UNTUK ADMIN & STAFF) -->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showUserManagement()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);">
                        <i class="fas fa-users-cog"></i>
                    </div>
                    <div class="setting-content">
                        <h3>User Management</h3>
                        <p>Kelola pengguna dan hak akses ke sistem</p>
                        <span class="setting-badge">Admin Only</span>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 7: KEAMANAN (GANTI PASSWORD) - UNTUK SEMUA ROLE -->
                <div class="setting-card" onclick="showSecuritySettings()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Keamanan & Akses</h3>
                        <p>Ganti password dan pengaturan keamanan akun Anda</p>
                        <div class="setting-badge">Security</div>
                    </div>
                </div>
                
                <!-- CARD 8: BACKUP & RESTORE (HANYA UNTUK ADMIN <--showBackupSettings-->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showComingSoon()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #5ee7df 0%, #b490ca 100%);">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Backup & Restore</h3>
                        <p>Auto-backup, restore data, dan management database</p>
                        <div class="setting-badge">Data</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 9: SYSTEM SETTINGS (HANYA UNTUK ADMIN <--showSystemSettings-->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showComingSoon()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);">
                        <i class="fas fa-sliders-h"></i>
                    </div>
                    <div class="setting-content">
                        <h3>System Settings</h3>
                        <p>Timezone, bahasa, format tanggal, dan pengaturan sistem</p>
                        <div class="setting-badge">System</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 10: API & INTEGRATION (HANYA UNTUK ADMIN <--showAPISettings-->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showComingSoon()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);">
                        <i class="fas fa-code"></i>
                    </div>
                    <div class="setting-content">
                        <h3>API & Integration</h3>
                        <p>API keys, webhooks, dan integrasi dengan sistem lain</p>
                        <div class="setting-badge">Developer</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 11: LOGS & AUDIT (HANYA UNTUK ADMIN <--showLogsAudit-->
                ${currentRole === 'admin' ? `
                <div class="setting-card" onclick="showComingSoon()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Logs & Audit</h3>
                        <p>Activity logs, audit trail, dan monitoring sistem</p>
                        <div class="setting-badge">Monitoring</div>
                    </div>
                </div>
                ` : ''}
                
                <!-- CARD 12: TENTANG APLIKASI -->
                <div class="setting-card" onclick="showAboutInfo()">
                    <div class="setting-icon" style="background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%);">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="setting-content">
                        <h3>Tentang Aplikasi</h3>
                        <p>Versi, update, credits, dan informasi sistem</p>
                        <div class="setting-badge">Info</div>
                    </div>
                </div>
                
            </div>
            
            
            
        </div>
    `;

    return settingsHTML;
}





// ============================================
// FUNGSI SAVE UNTUK MODAL SETTING
// ============================================

// 1. SIMPAN PROFIL PERUSAHAAN
// ============================================
// FUNGSI SAVE PROFIL PERUSAHAAN (PERBAIKAN)
// ============================================
async function saveCompanyProfile() {
    try {
        showLoading();
        
        // 1. VALIDASI INPUT
        const companyName = document.getElementById('companyName').value.trim();
        const companyAddress = document.getElementById('companyAddress').value.trim();
        const companyPhone = document.getElementById('companyPhone').value.trim();
        
        if (!companyName || !companyAddress || !companyPhone) {
            hideLoading();
            showToast('error', 'Error', 'Nama, alamat, dan telepon wajib diisi');
            return;
        }
        
        // 2. AMBIL COMPANY ID
        const companyId = firebase.auth().currentUser.uid;

        
        // 3. DATA UNTUK DISIMPAN
        const companyData = {
            // DATA UTAMA
            companyName: document.getElementById('companyName').value,
            companyTagline: document.getElementById('companyTagline').value.trim(),
            companyAddress: document.getElementById('companyAddress').value,
            companyPhone: companyPhone,
            companyEmail: document.getElementById('companyEmail').value.trim(),
            companyWebsite: document.getElementById('companyWebsite').value.trim(),
            companyNPWP: document.getElementById('companyNPWP').value.trim(),
            companyDirector: document.getElementById('companyDirector').value.trim(),
            companyType: document.getElementById('companyType').value,
            
            // INVOICE SETTINGS
            invoicePrefix: document.getElementById('invoicePrefix').value.trim(),
            invoiceFooter: document.getElementById('invoiceFooter').value.trim(),
            invoiceTerms: document.getElementById('invoiceTerms').value.trim(),
            
            // METADATA
            company_id: companyId,
            updated_at: new Date().toISOString(),
            updated_by: getUserLogName()
        };
        
        // 4. SIMPAN KE LOCALSTORAGE (UNTUK CEPAT LOAD)
            localStorage.setItem(`companyProfile_${companyId}`, JSON.stringify(companyData));

            // 2. HAPUS key terpisah yang lama (jika ada)
            localStorage.removeItem('companyName');
            localStorage.removeItem('companyAddress');
            localStorage.removeItem(`company_profile_${companyId}`);


        
        // 5. SIMPAN KE DATABASE (Firestore) DENGAN COMPANY_ID FILTER
        await db.collection('company_settings').doc(companyId).set(companyData, { merge: true });
        
        // 6. UPDATE UI NAVBAR
        const navbarBrand = document.querySelector('.navbar-brand');
        if (navbarBrand) {
            navbarBrand.innerHTML = '';
            
            // Cek logo di settings
            const savedSettings = localStorage.getItem(`companySettings_${companyId}`);
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    if (settings.companyLogo && settings.companyLogo.startsWith('data:image')) {
                        const img = document.createElement('img');
                        img.src = settings.companyLogo;
                        img.style.height = '40px';
                        img.style.maxHeight = '40px';
                        img.style.objectFit = 'contain';
                        navbarBrand.appendChild(img);
                    }
                } catch(e) {}
            }
            
            // Tambah nama perusahaan
            const span = document.createElement('span');
            span.id = 'companyNameNav';
            span.textContent = companyName;
            span.style.marginLeft = navbarBrand.children.length > 0 ? '10px' : '0';
            span.style.color = 'var(--primary)';
            span.style.fontSize = '20px';
            span.style.fontWeight = '700';
            navbarBrand.appendChild(span);
        }
        
        // 7. UPDATE DROPDOWN COMPANY NAME
        const dropdownCompanyName = document.getElementById('dropdownCompanyName');
        if (dropdownCompanyName) dropdownCompanyName.textContent = companyName;
        
        const dropdownCompanyTagline = document.getElementById('dropdownCompanyTagline');
        if (dropdownCompanyTagline) dropdownCompanyTagline.textContent = companyData.companyTagline || 'Billing Management System';
        
        // 8. LOG AKTIVITAS DENGAN COMPANY_ID FILTER
        await db.collection('aktivitas').add({
            aktivitas: 'Update profil perusahaan',
            user: getUserLogName(),
            timestamp: new Date().toISOString(),
            company_id: companyId
        });
        
        hideLoading();
        hideModal('modalCompanyProfile');
        showToast('success', 'Berhasil', 'Profil perusahaan berhasil disimpan');
        
    } catch (error) {
        hideLoading();
        console.error('Error saveCompanyProfile:', error);
        showToast('error', 'Gagal', 'Gagal menyimpan profil: ' + error.message);
    }
}

// ============================================
// FUNGSI SAVE BRANDING (FIX FINAL - VALIDASI BENAR)
// ============================================
async function saveBranding() {
    try {
        showLoading();
        
        // 1. AMBIL COMPANY ID
        const companyId = await ensureCompanyId();
        if (!companyId) {
            hideLoading();
            showToast('error', 'Error', 'Company ID tidak valid');
            return;
        }
        
        // 2. AMBIL LOGO DENGAN VALIDASI PROMISE YANG BENAR
        const logoPreview = document.getElementById('logoPreview');
        let companyLogo = '';
        
        if (logoPreview) {
            const img = logoPreview.querySelector('img');
            if (img && img.src) {
                // ⭐⭐ VALIDASI DENGAN PROMISE YANG BENAR ⭐⭐
                const isValid = await new Promise((resolve) => {
                    const testImg = new Image();
                    testImg.onload = () => {
                        console.log('Logo valid:', testImg.width, 'x', testImg.height);
                        resolve(true);
                    };
                    testImg.onerror = () => {
                        console.log('Logo invalid');
                        resolve(false);
                    };
                    testImg.src = img.src;
                    // ⭐⭐ TIDAK ADA TIMEOUT - TUNGGU SAMPAI onload/onerror ⭐⭐
                });
                
                if (!isValid) {
                    hideLoading();
                    showToast('error', 'Logo Invalid', 'File corrupt/format salah. Upload PNG/JPG.');
                    return; // ⭐⭐ STOP JIKA INVALID ⭐⭐
                }
                
                companyLogo = img.src;
            }
        }

        if (
    !document.getElementById('primaryColor') ||
    !document.getElementById('secondaryColor')
) {
    hideLoading();
    showToast('error', 'Gagal Simpan', 'Form branding belum siap');
    return;
}


        const mainFontEl = document.getElementById('mainFont');
        const fontSizeEl = document.getElementById('fontSize');

        const brandingData = {
            companyLogo: companyLogo,
            primaryColor: document.getElementById('primaryColor').value,
            secondaryColor: document.getElementById('secondaryColor').value,
            dashboardTheme: (document.querySelector('input[name="dashboardTheme"]:checked') || { value: 'default' }).value,
            mainFont: mainFontEl ? mainFontEl.value : null,
            fontSize: fontSizeEl ? fontSizeEl.value : null,
            company_id: companyId,
            updated_at: new Date().toISOString()
        };

        
        await db.collection('company_settings').doc(companyId).set(brandingData, { merge: true });
        localStorage.setItem(`companySettings_${companyId}`, JSON.stringify(brandingData));
        
        // 4. UPDATE UI (kode sisanya sama)
        if (companyLogo) {
            const navbarBrand = document.querySelector('.navbar-brand');
            if (navbarBrand) {
                const oldImg = navbarBrand.querySelector('img');
                if (oldImg) oldImg.remove();
                const defaultIcon = navbarBrand.querySelector('i.fa-file-invoice-dollar');
                if (defaultIcon) defaultIcon.remove();
                
                const newImg = document.createElement('img');
                newImg.src = companyLogo;
                newImg.style.height = '40px';
                newImg.style.width = 'auto';
                newImg.style.maxWidth = '200px';
                newImg.style.objectFit = 'contain';
                navbarBrand.prepend(newImg);
            }
        }
        
        hideLoading();
        hideModal('modalBranding');
        showToast('success', 'Berhasil', 'Branding disimpan');
        
    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        showToast('error', 'Gagal', error.message);
    }
}

// Fungsi Helper untuk simpan ke Firebase (Dipisah agar rapi)
async function simpanKeFirebase(data) {
    try {
        // Simpan ke Firestore
        await db.collection('company_settings').doc('branding').set(data, { merge: true });

        // Terapkan perubahan ke UI
        applyBrandingStyles(data);

        hideLoading();
        hideModal('modalBranding');
        showToast('success', 'Berhasil', 'Branding & Logo berhasil disimpan!');
        
        // Refresh tampilan logo di modal agar langsung muncul
        setTimeout(() => {
            showBrandingSettings();
        }, 500);

    } catch (error) {
        hideLoading();
        console.error("Error simpan ke firebase:", error);
        showToast('error', 'Gagal', 'Gagal menyimpan ke database: ' + error.message);
    }
}

// Fungsi untuk menerapkan styling branding
function applyBrandingStyles(settings) {
    const root = document.documentElement;
    
    if (settings.primaryColor) {
        root.style.setProperty('--primary', settings.primaryColor);
    }
    if (settings.secondaryColor) {
        root.style.setProperty('--secondary', settings.secondaryColor);
    }
    if (settings.mainFont) {
        document.body.style.fontFamily = settings.mainFont;
    }
    if (settings.fontSize) {
        document.body.style.fontSize = settings.fontSize;
    }
    
    // Terapkan tema
    if (settings.dashboardTheme === 'dark') {
        document.body.classList.add('dark-mode');
    } else if (settings.dashboardTheme === 'light') {
        document.body.classList.remove('dark-mode');
    } else {
        // Auto mode - ikuti sistem
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark-mode');
        } else {
            document.body.classList.remove('dark-mode');
        }
    }
}

// PERBAIKI FUNGSI previewLogo()
function previewLogo(input) {

console.log('🔥 previewLogo DIPANGGIL');


    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            console.log('✅ FileReader onload success');
            console.log('Data URL length:', e.target.result.length);
            console.log('Data URL starts with:', e.target.result.substring(0, 50));
            
            const preview = document.getElementById('logoPreview');
            console.log('Logo preview element:', preview);

            // ⬇️ INI YANG KURANG DI SCRIPT ASLI
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '10px';
            
            preview.innerHTML = '';   // bersihkan icon lama
            preview.appendChild(img);

            preview.style.display = 'none';
            preview.offsetHeight;
            preview.style.display = 'flex';

            input.style.pointerEvents = 'none';

                      
            console.log('✅ Preview updated');
        };
        
        reader.onerror = function(e) {
            console.error('❌ FileReader error:', e);
            console.error('Error code:', reader.error.code);
        };
        
        reader.onprogress = function(e) {
            if (e.lengthComputable) {
                const percentLoaded = Math.round((e.loaded / e.total) * 100);
                console.log(`📥 Loading: ${percentLoaded}%`);
            }
        };
        
        console.log('📁 Reading file:', input.files[0].name, input.files[0].size, 'bytes');
        reader.readAsDataURL(input.files[0]);
    } else {
        console.log('⚠️ No file selected');
    }
}




// 4. SIMPAN KONTAK & NOTIFIKASI
async function saveContactSettings() {
    try {
        const formData = {
            // WhatsApp
            whatsappNumber: document.getElementById('whatsappNumber').value,
            whatsappApiKey: document.getElementById('whatsappApiKey').value,
            enableWhatsApp: document.getElementById('enableWhatsApp').checked,
            
            // Email
            smtpHost: document.getElementById('smtpHost').value,
            smtpPort: document.getElementById('smtpPort').value,
            smtpEmail: document.getElementById('smtpEmail').value,
            smtpPassword: document.getElementById('smtpPassword').value,
            enableSSL: document.getElementById('enableSSL').checked,
            
            // SMS Gateway
            smsProvider: document.getElementById('smsProvider').value,
            smsApiKey: document.getElementById('smsApiKey').value,
            smsSecret: document.getElementById('smsSecret').value,
            enableSMS: document.getElementById('enableSMS').checked,
            
            // Notifikasi
            notifNewCustomer: document.getElementById('notifNewCustomer').checked,
            notifPayment: document.getElementById('notifPayment').checked,
            notifOverdue: document.getElementById('notifOverdue').checked,
            reminder3Days: document.getElementById('reminder3Days').checked,
            reminder1Day: document.getElementById('reminder1Day').checked,
            reminderOverdue: document.getElementById('reminderOverdue').checked,
            
            updated_at: new Date().toISOString()
        };

        // Validasi WhatsApp jika diaktifkan
        if (formData.enableWhatsApp && !formData.whatsappNumber) {
            showToast('error', 'Validasi Gagal', 'Nomor WhatsApp wajib diisi jika WhatsApp diaktifkan');
            return;
        }

        showLoading();

        // Simpan ke Firebase
        await db.collection('company_settings').doc('contact').set(formData, { merge: true });

        hideLoading();
        hideModal('modalContactSettings');
        showToast('success', 'Berhasil', 'Pengaturan kontak berhasil disimpan');

    } catch (error) {
        hideLoading();
        console.error("Error save contact settings:", error);
        showToast('error', 'Gagal', 'Gagal menyimpan pengaturan: ' + error.message);
    }
}

// 5. TEST NOTIFIKASI
async function testNotification() {
    try {
        showLoading();
        
        // Ambil pengaturan kontak
        const contactDoc = await db.collection('company_settings').doc('contact').get();
        const contactData = contactDoc.exists ? contactDoc.data() : {};
        
        // Simulasikan pengiriman notifikasi
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        hideLoading();
        
        if (contactData.enableWhatsApp && contactData.whatsappNumber) {
            showToast('success', 'Test Berhasil', `Notifikasi test terkirim ke ${contactData.whatsappNumber}`);
        } else {
            showToast('info', 'Test Simulasi', 'Notifikasi test berhasil disimulasikan (mode offline)');
        }

    } catch (error) {
        hideLoading();
        console.error("Error test notification:", error);
        showToast('error', 'Gagal', 'Gagal mengirim test: ' + error.message);
    }
}

// 6. GANTI PASSWORD
async function changePassword() {
    try {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // Validasi
        if (!currentPassword || !newPassword || !confirmPassword) {
            showToast('error', 'Validasi Gagal', 'Harap isi semua field password');
            return;
        }

        if (newPassword !== confirmPassword) {
            showToast('error', 'Validasi Gagal', 'Password baru tidak cocok');
            return;
        }

        if (newPassword.length < 8) {
            showToast('error', 'Validasi Gagal', 'Password minimal 8 karakter');
            return;
        }

        showLoading();

        // Re-authenticate user
        const user = firebase.auth().currentUser;
        const credential = firebase.auth.EmailAuthProvider.credential(
            user.email,
            currentPassword
        );

        await user.reauthenticateWithCredential(credential);
        
        // Update password
        await user.updatePassword(newPassword);
        
        // Log aktivitas
        await db.collection('aktivitas').add({
            aktivitas: 'User mengganti password',
            user: getUserLogName(),
            timestamp: new Date().toISOString()
        });

        hideLoading();
        hideModal('modalChangePassword');
        showToast('success', 'Berhasil', 'Password berhasil diubah');

        // Clear form
        document.getElementById('formChangePassword').reset();

    } catch (error) {
        hideLoading();
        console.error("Error change password:", error);
        
        if (error.code === 'auth/wrong-password') {
            showToast('error', 'Gagal', 'Password saat ini salah');
        } else if (error.code === 'auth/weak-password') {
            showToast('error', 'Gagal', 'Password terlalu lemah');
        } else {
            showToast('error', 'Gagal', 'Gagal mengubah password: ' + error.message);
        }
    }
}

// 7. VALIDASI PASSWORD (real-time)
function validatePasswordStrength() {
    const password = document.getElementById('newPassword').value;
    const strengthBar = document.getElementById('passwordStrength');
    const tipsElement = document.getElementById('passwordTips');
    
    if (!password) {
        strengthBar.style.width = '0%';
        strengthBar.style.background = '#ddd';
        tipsElement.textContent = '';
        return;
    }

    let strength = 0;
    let tips = [];

    // Kriteria password
    if (password.length >= 8) strength += 25;
    if (/[a-z]/.test(password)) strength += 25;
    if (/[A-Z]/.test(password)) strength += 25;
    if (/[0-9]/.test(password)) strength += 15;
    if (/[^A-Za-z0-9]/.test(password)) strength += 10;

    // Warna berdasarkan strength
    let color = '#ff6b6b'; // merah
    if (strength >= 50) color = '#fdcb6e'; // kuning
    if (strength >= 75) color = '#00b894'; // hijau

    strengthBar.style.width = strength + '%';
    strengthBar.style.background = color;

    // Tips
    if (password.length < 8) tips.push('Minimal 8 karakter');
    if (!/[a-z]/.test(password)) tips.push('Tambahkan huruf kecil');
    if (!/[A-Z]/.test(password)) tips.push('Tambahkan huruf besar');
    if (!/[0-9]/.test(password)) tips.push('Tambahkan angka');
    if (!/[^A-Za-z0-9]/.test(password)) tips.push('Tambahkan simbol');

    tipsElement.textContent = tips.length > 0 ? tips.join(', ') : 'Password kuat!';
}

// 8. CHECK PASSWORD MATCH
function checkPasswordMatch() {
    const password = document.getElementById('newPassword').value;
    const confirm = document.getElementById('confirmPassword').value;
    const matchDiv = document.getElementById('passwordMatch');
    const mismatchDiv = document.getElementById('passwordMismatch');

    if (!confirm) {
        matchDiv.style.display = 'none';
        mismatchDiv.style.display = 'none';
        return;
    }

    if (password === confirm) {
        matchDiv.style.display = 'block';
        mismatchDiv.style.display = 'none';
    } else {
        matchDiv.style.display = 'none';
        mismatchDiv.style.display = 'block';
    }
}

// 9. SIMPAN PROFIL USER
async function saveUserProfile() {
    try {
        const formData = {
            fullName: document.getElementById('userFullName').value,
            username: document.getElementById('userUsername').value,
            email: document.getElementById('userEmail').value,
            phone: document.getElementById('userPhone').value,
            address: document.getElementById('userAddress').value,
            bio: document.getElementById('userBio').value,
            updated_at: new Date().toISOString()
        };

        // Validasi
        if (!formData.fullName || !formData.username) {
            showToast('error', 'Validasi Gagal', 'Nama lengkap dan username wajib diisi');
            return;
        }

        showLoading();

        // Update di Firebase Auth
        const user = firebase.auth().currentUser;
        await user.updateProfile({
            displayName: formData.fullName
        });

        // Update di Firestore
        await db.collection('users').doc(user.uid).set(formData, { merge: true });

        // Update UI
        if (document.getElementById('userName')) {
            document.getElementById('userName').textContent = formData.fullName;
        }
        
        if (document.getElementById('userAvatar')) {
            const initials = formData.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('userAvatar').textContent = initials;
        }

        hideLoading();
        hideModal('modalUserProfile');
        showToast('success', 'Berhasil', 'Profil berhasil disimpan');

    } catch (error) {
        hideLoading();
        console.error("Error save user profile:", error);
        showToast('error', 'Gagal', 'Gagal menyimpan profil: ' + error.message);
    }
}

// 10. UPLOAD FOTO PROFIL
function uploadUserPhoto(input) {
    if (input.files && input.files[0]) {
        const file = input.files[0];
        
        // Validasi ukuran file (max 2MB)
        if (file.size > 2 * 1024 * 1024) {
            showToast('error', 'File Terlalu Besar', 'Maksimal ukuran file 2MB');
            return;
        }

        // Validasi tipe file
        if (!file.type.match('image.*')) {
            showToast('error', 'Format Tidak Valid', 'Hanya file gambar yang diperbolehkan');
            return;
        }

        const reader = new FileReader();
        
        reader.onload = function(e) {
            const preview = document.getElementById('userPhotoPreview');
            const img = document.getElementById('userPhotoImg');
            const initials = document.getElementById('userInitials');
            
            img.src = e.target.result;
            img.style.display = 'block';
            initials.style.display = 'none';
            
            showToast('success', 'Berhasil', 'Foto profil berhasil diupload');
        };
        
        reader.readAsDataURL(file);
    }
}


// ============================================
// FUNGSI BARU: updateNavbarTime() - BUAT DARI NOL
// ============================================

function updateNavbarTime() {
    // 1. Cari elemen waktu di navbar
    const timeElement = document.getElementById('currentTime');
    
    // 2. Jika tidak ada dengan ID, cari dengan class atau buat baru
    if (!timeElement) {
        // Coba cari elemen lain yang mungkin untuk waktu
        const possibleElements = [
            document.querySelector('.navbar-time'),
            document.querySelector('.current-time'),
            document.querySelector('.time-display')
        ];
        
        const foundElement = possibleElements.find(el => el !== null);
        if (foundElement) {
            const now = moment();
            foundElement.textContent = now.format('DD/MM/YYYY HH:mm');
            return;
        }
        
        // Jika tidak ada, coba tambahkan ke navbar
        const navbar = document.querySelector('.navbar, .app-header');
        if (navbar) {
            const timeDiv = document.createElement('div');
            timeDiv.id = 'currentTime';
            timeDiv.className = 'navbar-time';
            timeDiv.style.marginLeft = 'auto';
            timeDiv.style.padding = '0 15px';
            timeDiv.style.fontSize = '14px';
            
            const now = moment();
            timeDiv.textContent = now.format('DD/MM/YYYY HH:mm');
            
            navbar.appendChild(timeDiv);
            return;
        }
        
        return;
    }
    
    // 3. Update waktu
    const now = moment();
    timeElement.textContent = now.format('DD/MM/YYYY HH:mm');
}



// ============================================
// FUNGSI TEMPLATE PESAN - FIX
// ============================================

// 11. FUNGSI SAVE TEMPLATE PESAN
async function saveMessageTemplates() {
    console.log("🔄 Menyimpan template pesan...");
    
    try {
        // Ambil data dari form
        const templateData = {
            // Reminder templates
            reminder_3hari: document.getElementById('templateReminder3Days').value,
            reminder_1hari: document.getElementById('templateReminder1Day').value,
            reminder_overdue: document.getElementById('templateOverdue').value,
            
            // Konfirmasi templates
            payment_confirmed: document.getElementById('templatePaymentConfirmed').value,
            new_invoice: document.getElementById('templateNewInvoice').value,
            
            // Metadata
            updated_at: new Date().toISOString(),
            updated_by: currentUser.email,
            company_id: globalCompanyId
        };

        // Validasi - template utama harus diisi
        if (!templateData.reminder_3hari || !templateData.new_invoice) {
            showToast('error', 'Validasi Gagal', 'Template Reminder 3 Hari dan Template Tagihan Baru harus diisi');
            return;
        }

        showLoading();

        // Simpan ke Firestore
        await db.collection('message_templates').doc(globalCompanyId).set(templateData, { merge: true });

        // Log aktivitas
        await db.collection('aktivitas').add({
            aktivitas: 'Menyimpan template pesan otomatis',
            user: getUserLogName(),
            timestamp: new Date().toISOString(),
            company_id: globalCompanyId
        });

        hideLoading();
        hideModal('modalMessageTemplates');
        showToast('success', 'Berhasil', 'Template pesan berhasil disimpan!');

    } catch (error) {
        hideLoading();
        console.error("❌ Error saveMessageTemplates:", error);
        showToast('error', 'Gagal', 'Gagal menyimpan template: ' + error.message);
    }
}

// 12. LOAD DATA SETTING SAAT MODAL DIBUKA
function saveCompanyProfile() {
    try {
        const companyName = document.getElementById('companyName').value;
        const companyAddress = document.getElementById('companyAddress').value;
        
        if (!companyName || !companyAddress) {
            showToast('error', 'Error', 'Nama dan alamat wajib diisi');
            return;
        }

        // ⭐⭐ GUNAKAN DATA YANG DIAMBIL DARI FORM ⭐⭐
        const profileData = {
            companyName: companyName,
            companyTagline: document.getElementById('companyTagline').value || '',
            companyAddress: companyAddress,
            companyPhone: document.getElementById('companyPhone').value || '',
            companyEmail: document.getElementById('companyEmail').value || '',
            companyWebsite: document.getElementById('companyWebsite').value || '',
            companyNPWP: document.getElementById('companyNPWP').value || '',
            companyDirector: document.getElementById('companyDirector').value || '',
            companyType: document.getElementById('companyType').value || 'isp',
            invoicePrefix: document.getElementById('invoicePrefix').value || 'INV',
            invoiceFooter: document.getElementById('invoiceFooter').value || '',
            invoiceTerms: document.getElementById('invoiceTerms').value || '',
            company_id: globalCompanyId, // ⭐⭐ TANDAI MILIK COMPANY INI ⭐⭐
            updated_at: new Date().toISOString()
        };

        // Simpan ke Firebase
        db.collection('company_settings').doc(globalCompanyId).set(profileData)
            .then(() => {
                showToast('success', 'Berhasil', 'Profil perusahaan disimpan');
                hideModal('modalCompanyProfile');
                
                // Update UI langsung
                const navElement = document.getElementById('companyNameNav');
                if (navElement) navElement.textContent = companyName;
                
                const dropdownElement = document.getElementById('dropdownCompanyName');
                if (dropdownElement) dropdownElement.textContent = companyName;
                
                // Simpan ke localStorage dengan key spesifik
                localStorage.setItem(`companyProfile_${globalCompanyId}`, JSON.stringify(profileData));
                
                // Load ulang profil
                loadCompanyProfile();
            })
            .catch(error => {
                console.error("Error save company profile:", error);
                showToast('error', 'Gagal', 'Gagal menyimpan profil: ' + error.message);
            });

    } catch (error) {
        console.error("Error save company profile:", error);
        showToast('error', 'Error', 'Terjadi kesalahan: ' + error.message);
    }
}

async function saveBrandingSettings() {
    const companyName = document.getElementById('brandingCompanyName').value;
    const companyAddress = document.getElementById('brandingCompanyAddress').value;
    const companyPhone = document.getElementById('brandingCompanyPhone').value;
    const companyEmail = document.getElementById('brandingCompanyEmail').value;
    const companyWebsite = document.getElementById('brandingCompanyWebsite').value;
    const primaryColor = document.getElementById('brandingPrimaryColor').value;
    const logoFile = document.getElementById('brandingLogoUpload').files[0];
    
    if (!companyName.trim()) {
        showToast('error', 'Error', 'Nama perusahaan wajib diisi');
        return;
    }
    
    try {
        showLoading();
        
        let logoUrl = '';
        
        // UPLOAD LOGO JIKA ADA
        if (logoFile) {
            const storageRef = firebase.storage().ref();
            const logoRef = storageRef.child(`companies/${globalCompanyId}/logo_${Date.now()}.png`);
            
            await logoRef.put(logoFile);
            logoUrl = await logoRef.getDownloadURL();
        }
        
        const brandingData = {
            companyName: companyName,
            companyAddress: companyAddress,
            companyPhone: companyPhone,
            companyEmail: companyEmail,
            companyWebsite: companyWebsite,
            updated_at: new Date().toISOString()
        };
        
        // SIMPAN LOGO KE COLLECTION companies
        if (logoUrl) {
            await db.collection('company_settings').doc(globalCompanyId).set({
            logo_url: logoUrl,
            updated_at: new Date().toISOString()
            }, { merge: true });
            
            // UPDATE LOGO INSTANT DI UI
            localStorage.setItem('companyLogo', logoUrl);
            
            // CARI DAN UPDATE ELEMEN LOGO DI POJOK KIRI ATAS
            const logoElements = [
                document.querySelector('.sidebar-logo'),
                document.querySelector('.navbar-brand'),
                document.querySelector('.app-logo'),
                document.querySelector('.logo-container'),
                document.querySelector('.company-logo')
            ];
            
            logoElements.forEach(element => {
                if (element) {
                    element.innerHTML = `<img src="${logoUrl}" alt="${companyName}" style="max-height: 40px; max-width: 150px;">`;
                }
            });
            
            // JIKA TIDAK ADA ELEMEN LOGO, BUAT MANUAL DI SIDEBAR
            const hasLogoElement = logoElements.some(el => el !== null);
            if (!hasLogoElement) {
                const sidebarHeader = document.querySelector('.sidebar-header');
                if (sidebarHeader) {
                    const logoDiv = document.createElement('div');
                    logoDiv.className = 'company-logo';
                    logoDiv.style.padding = '15px';
                    logoDiv.style.textAlign = 'center';
                    logoDiv.innerHTML = `<img src="${logoUrl}" alt="${companyName}" style="max-height: 40px;">`;
                    sidebarHeader.prepend(logoDiv);
                }
            }
        }
        
        await db.collection('company_settings').doc('profile').set(brandingData, { merge: true });
        
        hideLoading();
        showToast('success', 'Berhasil', 'Branding berhasil diterapkan');
        
        // REFRESH PROFIL SETELAH SIMPAN
        setTimeout(() => {
            loadCompanyProfile();
        }, 500);
        
        // TUTUP MODAL
        setTimeout(() => {
            const modal = document.getElementById('modalBrandingSettings');
            if (modal) {
                modal.classList.remove('show');
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
        }, 1000);
        
    } catch (error) {
        hideLoading();
        console.error("Error:", error);
        showToast('error', 'Gagal', error.message);
    }
}


// ============================================
// FUNGSI BARU: updateLogoInUI() - TAMBAHKAN DI BAWAH loadCompanyProfile()
// ============================================

function updateLogoInUI(logoUrl, companyName) {
    console.log("🖼️ Update logo di UI:", logoUrl);
    
    // 1. CEK ELEMEN LOGO DI POJOK KIRI ATAS
    const logoElements = [
        document.querySelector('.sidebar-logo'),
        document.querySelector('.navbar-brand'),
        document.querySelector('.app-logo'),
        document.querySelector('.logo-container')
    ];
    
    // 2. CEK JIKA ADA LOGO (DARI MANA SAJA)
    let logoContainer = null;
    for (let el of logoElements) {
        if (el) {
            logoContainer = el;
            break;
        }
    }
    
    // 3. JIKA TIDAK ADA CONTAINER, BUAT DI NAVBAR
    if (!logoContainer) {
        const navbar = document.querySelector('.navbar, .app-header');
        if (navbar) {
            logoContainer = document.createElement('div');
            logoContainer.className = 'navbar-brand';
            navbar.prepend(logoContainer);
        } else {
            console.warn("⚠️ Tidak ditemukan container untuk logo");
            return;
        }
    }
    
    // 4. HAPUS LOGO LAMA & TEKS LAMA
    const oldElements = logoContainer.querySelectorAll('i, img, span, .company-name');
    oldElements.forEach(el => el.remove());
    
    // 5. JIKA ADA LOGO URL, BUAT ELEMENT IMG
    if (logoUrl && logoUrl.startsWith('data:image')) {
        const logoImg = document.createElement('img');
        logoImg.src = logoUrl;
        logoImg.alt = companyName || 'Company Logo';
        logoImg.style.maxHeight = '40px';
        logoImg.style.width = 'auto';
        logoImg.style.objectFit = 'contain';
        
        // ⭐⭐ PERBAIKAN: TAMBAH CACHE BUSTING ⭐⭐
        logoImg.src = logoUrl + "?t=" + Date.now();
        
        logoContainer.appendChild(logoImg);
        console.log("✅ Logo image ditambahkan");
    } else if (logoUrl) {
        // Jika URL external
        const logoImg = document.createElement('img');
        logoImg.src = logoUrl;
        logoImg.alt = companyName || 'Company Logo';
        logoImg.style.maxHeight = '40px';
        logoImg.style.width = 'auto';
        logoImg.style.objectFit = 'contain';
        logoContainer.appendChild(logoImg);
        console.log("✅ Logo external ditambahkan");
    }
    
    // ⭐⭐ PERBAIKAN PENTING: TAMBAH NAMA PERUSAHAAN ⭐⭐
    if (companyName && companyName !== 'X-BILL') {
        const nameSpan = document.createElement('span');
        nameSpan.className = 'company-name';
        nameSpan.textContent = companyName;
        nameSpan.style.color = 'var(--primary)';
        nameSpan.style.fontSize = '20px';
        nameSpan.style.fontWeight = '700';
        nameSpan.style.marginLeft = '10px';
        nameSpan.style.whiteSpace = 'nowrap';
        nameSpan.style.overflow = 'hidden';
        nameSpan.style.textOverflow = 'ellipsis';
        nameSpan.style.maxWidth = '200px';
        
        logoContainer.appendChild(nameSpan);
        console.log("✅ Nama perusahaan ditambahkan:", companyName);
    }
    
    // 6. UPDATE JUGA DI DROPDOWN SETTING
    const dropdownCompanyName = document.getElementById('dropdownCompanyName');
    const dropdownCompanyTagline = document.getElementById('dropdownCompanyTagline');
    const companyNameNav = document.getElementById('companyNameNav');
    
    if (dropdownCompanyName && companyName) {
        dropdownCompanyName.textContent = companyName;
    }
    
    if (dropdownCompanyTagline) {
        // Ambil tagline dari localStorage jika ada
        const savedProfile = localStorage.getItem(`companyProfile_${globalCompanyId}`);
        if (savedProfile) {
            try {
                const profile = JSON.parse(savedProfile);
                dropdownCompanyTagline.textContent = profile.companyTagline || 'Billing Management System';
            } catch(e) {
                dropdownCompanyTagline.textContent = 'Billing Management System';
            }
        }
    }
    
    if (companyNameNav && companyName) {
        companyNameNav.textContent = companyName;
    }
    
    console.log("✅ Logo diupdate di navbar-brand");
}
// UPDATE SETIAP MENIT (60.000 ms)
setInterval(updateNavbarTime, 60000);

// PANGGIL PERTAMA KALI
updateNavbarTime();


async function loadBrandingSettings() {
    try {
       const companyId = currentUser.uid;

const doc = await db.collection('company_settings').doc(companyId).get();

        
        if (doc.exists) {
            const data = doc.data();
            
            const primaryColorEl = document.getElementById('primaryColor');
            if (primaryColorEl) primaryColorEl.value = data.primaryColor || '#4361ee';

            const secondaryColorEl = document.getElementById('secondaryColor');
            if (secondaryColorEl) secondaryColorEl.value = data.secondaryColor || '#7209b7';
            
            // Set radio button
            const theme = data.dashboardTheme || 'light';
            const themeRadio = document.getElementById(
                `theme${theme.charAt(0).toUpperCase() + theme.slice(1)}`
            );
            if (themeRadio) {
                themeRadio.checked = true;
            }
                        
           const mainFontEl = document.getElementById('mainFont');
            if (mainFontEl) mainFontEl.value = data.mainFont || "'Segoe UI', system-ui";

            const fontSizeEl = document.getElementById('fontSize');
            if (fontSizeEl) fontSizeEl.value = data.fontSize || '16px';
            
            // Terapkan langsung
            applyBrandingStyles(data);
        }
    } catch (error) {
        console.error("Error load branding:", error);
    }
}

async function loadCompanyProfile() {
    try {
        // AMBIL DATA DARI company_settings
        const uid = firebase.auth().currentUser.uid;

        const doc = await db
            .collection('company_settings')
            .doc(uid)
            .get();

        
        if (!doc.exists) return;
        
        const data = doc.data();
        
        // ⭐⭐ VALIDASI: Pastikan data untuk company ini ⭐⭐
        if (data.company_id && data.company_id !== globalCompanyId) {
            console.error("🚫 Data perusahaan bukan milik company ini!");
            return;
        }
        
        // Update nama perusahaan
        if (data.companyName) {
            const navElement = document.getElementById('companyNameNav');
            if (navElement) navElement.textContent = data.companyName;
        }
        
        // ⭐⭐ UPDATE LOGO DI NAVBAR ⭐⭐
        if (data.companyLogo) {
            const navbarBrand = document.querySelector('.navbar-brand');
            if (navbarBrand) {
                // HAPUS SEMUA LOGO/ICON LAMA
                const oldElements = navbarBrand.querySelectorAll('i, img');
                oldElements.forEach(el => el.remove());
                
                // TAMBAH LOGO BARU
                const logoImg = document.createElement('img');
                logoImg.src = data.companyLogo;
                logoImg.alt = 'Logo';
                logoImg.style.width = '24px';
                logoImg.style.height = '24px';
                logoImg.style.marginRight = '10px';
                logoImg.style.borderRadius = '4px';
                
                navbarBrand.prepend(logoImg);
            }
        }
        
       
        
    } catch (error) {
        console.error("Error load company profile:", error);
    }
}



// ============================================
// EVENT LISTENER UNTUK MODAL SETTING
// ============================================

// Tambahkan event listener untuk modal setting saat dibuka
document.addEventListener('DOMContentLoaded', function() {
    // Event untuk modal profil perusahaan
    document.addEventListener('click', function(e) {
        if (e.target.closest && e.target.closest('[onclick*="showCompanyProfile"]')) {
            setTimeout(loadCompanyProfile, 100);
        }
        
        if (e.target.closest && e.target.closest('[onclick*="showBrandingModal"]')) {
            setTimeout(loadBrandingSettings, 100);
        }
        
        if (e.target.closest && e.target.closest('[onclick*="showUserProfile"]')) {
            setTimeout(loadUserProfile, 100);
        }
    });
    
    // Event untuk validasi password real-time
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    
    if (newPasswordInput) {
        newPasswordInput.addEventListener('input', function() {
            validatePasswordStrength();
            checkPasswordMatch();
        });
    }
    
    if (confirmPasswordInput) {
        confirmPasswordInput.addEventListener('input', checkPasswordMatch);
    }
});


function kembaliKeUserManagement() {
    hideModal('modalTambahKaryawan');
    setTimeout(() => {
        showModal('modalUserManagement');
    }, 300);
}

// ============================================
// FUNGSI TAMBAHAN UNTUK LOAD DATA USER
// ============================================

async function loadUserProfile() {
    try {
        const user = firebase.auth().currentUser;
        if (!user) return;

        const doc = await db.collection('users').doc(user.uid).get();
        
        if (doc.exists) {
            const data = doc.data();
            
            // Isi form
            document.getElementById('userFullName').value = data.fullName || user.displayName || '';
            document.getElementById('userUsername').value = data.username || user.email?.split('@')[0] || '';
            document.getElementById('userEmail').value = data.email || user.email || '';
            document.getElementById('userPhone').value = data.phone || '';
            document.getElementById('userAddress').value = data.address || '';
            document.getElementById('userBio').value = data.bio || '';
            
            // Data readonly
            document.getElementById('userRoleInput').value = data.role || 'Admin';
            document.getElementById('userJoinDate').value = user.metadata.creationTime 
                ? moment(user.metadata.creationTime).format('DD MMMM YYYY')
                : moment().format('DD MMMM YYYY');
            
            // Set avatar
            const avatar = document.getElementById('userAvatar');
            const initials = document.getElementById('userInitials');
            if (data.fullName) {
                const avatarInitials = data.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
                if (avatar) avatar.textContent = avatarInitials;
                if (initials) initials.textContent = avatarInitials;
            }
        } else {
            // Data default jika belum ada
            document.getElementById('userFullName').value = user.displayName || '';
            document.getElementById('userUsername').value = user.email?.split('@')[0] || '';
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userRoleInput').value = 'Admin';
            document.getElementById('userJoinDate').value = user.metadata.creationTime 
                ? moment(user.metadata.creationTime).format('DD MMMM YYYY')
                : moment().format('DD MMMM YYYY');
            
            // Set avatar default
            const avatar = document.getElementById('userAvatar');
            const initials = document.getElementById('userInitials');
            if (user.displayName) {
                const avatarInitials = user.displayName.split(' ').map(n => n[0]).join('').toUpperCase();
                if (avatar) avatar.textContent = avatarInitials;
                if (initials) initials.textContent = avatarInitials;
            }
        }
    } catch (error) {
        console.error("Error load user profile:", error);
    }
}




// FUNGSI CEK PERMISSION
function cekAkses(requiredRole, actionType) {
  const userRole = localStorage.getItem('userRole');
  
  // Admin bisa semua
  if (userRole === 'admin') return true;
  
  // Karyawan hanya bisa:
  if (userRole === 'karyawan') {
    // Baca semua data
    if (actionType === 'read') return true;
    
    // Hanya tagihan yang boleh create/update
    if (actionType === 'write_tagihan') return true;
    
    // Tidak boleh hapus apapun
    if (actionType === 'delete') return false;
    
    // Tidak boleh CRUD pelanggan & paket
    if (actionType === 'write_pelanggan') return false;
    if (actionType === 'write_paket') return false;
  }
  
  return false;
}

// ALIAS FUNGSI UNTUK MUDAH
function hanyaAdmin() {
  return localStorage.getItem('userRole') === 'admin';
}

function adminAtauKaryawan() {
  const role = localStorage.getItem('userRole');
  return role === 'admin' || role === 'karyawan';
}


// ============================================
// FUNGSI KLIK CARD LUNAS - DETAIL BULAN INI
// ============================================

function showLunasBulanIni() {
    console.log("🟢 Membuka detail lunas bulan ini...");
    
    // --- TAMBAHKAN INI: PAKSA Z-INDEX TINGGI ---
    // Kita cari semua modal lain yang mungkin ada dan turunkan z-index-nya
    window.document.querySelectorAll('.modal-overlay.show').forEach(modal => {
    modal.style.zIndex = "1000"; 
});

    showModal('modalLunasBulanIni');
    
    // --- TAMBAHKAN INI: SET Z-INDEX MODAL INI TINGGI ---
    // Pastikan modal lunas menang di paling atas
    const modal = document.getElementById('modalLunasBulanIni');
    if (modal) {
        modal.style.zIndex = "99999"; 
        console.log("✅ Modal Lunas Z-Index set to 99999");
    }
    
    loadLunasBulanIniData();
}

// ============================================
// FUNGSI LOAD DATA LUNAS BULAN INI (FIXED: HANYA PELANGGAN LUNAS)
// ============================================

async function loadLunasBulanIniData(page = 1) {
    const table = document.getElementById('lunasBulanIniTable');
    if (!table) return;
    
    try {
        table.innerHTML = `<tr><td colspan="8" class="text-center"><div class="spinner" style="margin:0 auto;"></div> Memuat Data...</td></tr>`;
        
        // Tentukan Bulan Ini
        const currentMonthText = moment().format('MM-YYYY');
        
        // 1. Ambil SEMUA tagihan bulan ini (tanpa filter status dulu)
        const snapshot = await db.collection('tagihan')
            .where('company_id', '==', globalCompanyId)
            .where('bulan', '==', currentMonthText)
            .get();
        
        // 2. Kita Filter secara Manual di JavaScript agar TIDAK ERROR INDEKS
        // Hanya ambil data pelanggan yang statusnya 'lunas'
        let filteredDocs = [];
        
        if (!snapshot.empty) {
            // Loop semua data
            snapshot.forEach(doc => {
                const data = doc.data();
                
                // Filter Status: HANYA JIKA STATUS = 'lunas'
                if (data.status === 'lunas') {
                    filteredDocs.push({ id: doc.id, ...data });
                }
            });
        }
        
        console.log(`📊 Ditemukan ${filteredDocs.length} data lunas bulan ini.`);
        
        if (filteredDocs.length === 0) {
            table.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center" style="padding: 30px;">
                        <i class="fas fa-inbox" style="font-size: 40px; color: #e9ecef;"></i>
                        <h4 style="margin-top:10px; color: var(--gray);">Belum Ada Pelunasan</h4>
                        <p>Belum ada pelanggan yang membayar lunas bulan ini.</p>
                    </td>
                </tr>`;
            document.getElementById('lunasPagination').innerHTML = '';
            return;
        }
        
        // 3. Pagination Logic (Sama seperti sebelumnya)
        const totalData = filteredDocs.length;
        const itemsPerPage = 10;
        const totalPages = Math.ceil(totalData / itemsPerPage);
        
        if (page > totalPages) page = totalPages;
        
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageDocs = filteredDocs.slice(startIndex, endIndex);
        
        // 4. Render Table
        let html = '';
        
        // Cache map pelanggan
        if (!window.pelangganCacheMap) window.pelangganCacheMap = {};
        
        for (let i = 0; i < pageDocs.length; i++) {
            const t = pageDocs[i];
            
            // Ambil Nama Pelanggan
            let namaPelanggan = t.pelanggan_nama || 'Unknown';
            if (t.pelanggan_id && !window.pelangganCacheMap[t.pelanggan_id]) {
                try {
                    const pelDoc = await db.collection('pelanggan').doc(t.pelanggan_id).get();
                    if (pelDoc.exists) {
                        const pData = pelDoc.data();
                        window.pelangganCacheMap[t.pelanggan_id] = pData.nama || t.pelanggan_nama;
                    }
                } catch (e) { /* ignore */ }
            }
            
            if (window.pelangganCacheMap[t.pelanggan_id]) {
                namaPelanggan = window.pelangganCacheMap[t.pelanggan_id];
            }
            
            // Format Tanggal Bayar
            let tglBayarDisplay = '-';
            if (t.tanggal_bayar) {
                let m = moment(t.tanggal_bayar, 'DD MMMM YYYY, HH:mm');
                if (!m.isValid()) m = moment(t.tanggal_bayar);
                if (!m.isValid()) m = moment(t.tanggal_bayar, 'YYYY-MM-DD');
                if (m.isValid()) tglBayarDisplay = m.format('DD/MM/YYYY');
            }

            const no = startIndex + i + 1;

            html += `
                <tr>
                    <td style="font-weight: bold;">${no}</td>
                    <td><strong>${namaPelanggan}</strong></td>
                    <td>${formatRupiah(t.jumlah || 0)}</td>
                    <td><span class="badge badge-info">${t.bulan || '-'}</span></td>
                    <td><span class="badge badge-success"><i class="fas fa-check-circle"></i> LUNAS</span></td>
                    <td>${tglBayarDisplay}</td>
                    <td><small>${t.nama_petugas || t.updated_by || 'System'}</small></td>
                </tr>
            `;
        }
        
        table.innerHTML = html;
        
        // Render Pagination
        renderPagination(totalData, page, 'lunasBulanIni', 'lunasPagination');
        
    } catch (error) {
        console.error("Error load data lunas:", error);
        const table = document.getElementById('lunasBulanIniTable');
        if(table) {
            table.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Error: ${error.message}</td></tr>`;
        }
    }
}


// ============================================
// FUNGSI DETAIL TUNGGAKAN (REAL-TIME CALCULATION)
// ============================================

// ⭐⭐ PERBAIKI FUNGSI showDetailTunggakan() ⭐⭐
async function showDetailTunggakan() {
    console.log("📋 Membuka modal detail tunggakan dari dashboard...");
    
    const modal = document.getElementById('modalDetailTunggakan');
    if (!modal) {
        showToast('error', 'Error', 'Modal tidak ditemukan');
        return;
    }
    
    // ⭐⭐ RESET KE HALAMAN 1 SETIAP KALI MODAL DIBUKA ⭐⭐
    window.currentTunggakanModalPage = 1;
    
    // Tampilkan modal
    modal.classList.remove('hidden');
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Load data dengan halaman 1
    await loadTunggakanDataForModal('semua', 1);
}

async function loadTunggakanDataForModal(filterKategori = 'semua', page = 1) {
    console.log(`📊 Loading data tunggakan untuk modal, halaman ${page}...`);
    
    const table = document.getElementById('tunggakanTable');
    const pagination = document.getElementById('tunggakanPagination');
    
    if (!table) {
        console.error("❌ Tabel tidak ditemukan di modal");
        return;
    }
    
    try {
        table.innerHTML = `<tr><td colspan="9" class="text-center">Memuat data...</td></tr>`;
        
        // Ambil data pelanggan untuk mendapatkan SERVER dan KOORDINAT
        const pelangganSnapshot = await db.collection('pelanggan')
            .where('company_id', '==', globalCompanyId)
            .get();
        
        // Buat mapping pelanggan yang lengkap
        const pelangganMap = {};
        pelangganSnapshot.forEach(doc => {
            const p = doc.data();
            pelangganMap[doc.id] = {
                nama: p.nama || 'Tanpa Nama',
                telepon: p.telepon || '-',
                alamat: p.alamat || '-',
                server: p.server || '-',
                koordinat: p.koordinat || '-',
                lokasi: p.lokasi || '-'
            };
        });
        
        // Ambil data tagihan tunggakan
        const snapshot = await db.collection('tagihan')
            .where('company_id', '==', globalCompanyId)
            .where('status', 'in', ['belum', 'telat'])
            .get();
        
        if (snapshot.empty) {
            table.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-muted" style="padding: 40px;">
                        <i class="fas fa-check-circle" style="font-size: 48px; color: #e9ecef;"></i>
                        <h4 style="margin-top:15px; color: var(--gray);">Tidak Ada Tunggakan</h4>
                        <p>Semua tagihan sudah lunas.</p>
                    </td>
                </tr>`;
            pagination.innerHTML = '';
            return;
        }
        
        // Group data berdasarkan Pelanggan
        const groupedMap = {};
        
        snapshot.forEach(doc => {
            const t = doc.data();
            const pid = t.pelanggan_id;
            
            if (!pelangganMap[pid]) return;
            
            const pelangganInfo = pelangganMap[pid];
            
            if (!groupedMap[pid]) {
                groupedMap[pid] = {
                    pelanggan_id: pid,
                    pelanggan_nama: pelangganInfo.nama,
                    pelanggan_telepon: pelangganInfo.telepon,
                    pelanggan_alamat: pelangganInfo.alamat,
                    pelanggan_server: pelangganInfo.server,
                    pelanggan_koordinat: pelangganInfo.koordinat,
                    pelanggan_lokasi: pelangganInfo.lokasi,
                    list_tagihan: [],
                    total_nominal: 0
                };
            }
            
            groupedMap[pid].list_tagihan.push({
                ...t,
                tagihan_id: doc.id
            });
            groupedMap[pid].total_nominal += Number(t.jumlah) || 0;
        });
        
        // Proses data
        let processedData = Object.values(groupedMap).map(item => {
            let maxHariTerlambat = 0;
            let statusTerparah = 'belum';
            
            item.list_tagihan.forEach(t => {
                if (t.status === 'telat' && t.tanggal_jatuh_tempo) {
                    statusTerparah = 'telat';
                    let mJatuhTempo = moment(t.tanggal_jatuh_tempo, 'DD-MM-YYYY');
                    if (!mJatuhTempo.isValid()) mJatuhTempo = moment(t.tanggal_jatuh_tempo);
                    if (mJatuhTempo.isValid()) {
                        const hariTelat = moment().diff(mJatuhTempo, 'days');
                        if (hariTelat > maxHariTerlambat) maxHariTerlambat = hariTelat;
                    }
                }
            });
            
            let kategori = 'ringan';
            if (statusTerparah === 'telat') {
                if (maxHariTerlambat > 60) kategori = 'berat';
                else if (maxHariTerlambat > 30) kategori = 'sedang';
            }
            
            let listBulan = item.list_tagihan.map(t => {
                const rawBulan = t.bulan || '';
                let dateObj = null;
                
                if (rawBulan.includes('-')) {
                    const parts = rawBulan.split('-');
                    if (parts.length === 2 && parts[0].length === 4) dateObj = moment(rawBulan); 
                    else if (parts.length === 2 && parts[0].length <= 2) dateObj = moment(rawBulan, 'MM-YYYY');
                    else if (parts.length === 3) {
                        const fixedString = `${parts[1]}-${parts[2]}-${parts[0]}`;
                        dateObj = moment(fixedString, 'YYYY-MM-DD');
                    }
                } else {
                    dateObj = moment(rawBulan);
                }
                if (dateObj && dateObj.isValid()) return dateObj.format('MMM YY');
                return rawBulan;
            }).join(', ');
            
            let jatuhTempoText = '-';
            let jatuhTempoDate = null;
            
            if (item.list_tagihan.length > 0) {
                let latestMonth = null;
                let latestTimestamp = 0;
                
                item.list_tagihan.forEach(tagihan => {
                    if (tagihan.bulan) {
                        let monthMoment = null;
                        
                        if (tagihan.bulan.includes('-')) {
                            const parts = tagihan.bulan.split('-');
                            if (parts.length === 2) {
                                if (parts[0].length === 2) {
                                    monthMoment = moment(`${parts[1]}-${parts[0]}-01`);
                                } else if (parts[0].length === 4) {
                                    monthMoment = moment(`${parts[0]}-${parts[1]}-01`);
                                }
                            }
                        }
                        
                        if (monthMoment && monthMoment.isValid()) {
                            const timestamp = monthMoment.valueOf();
                            if (timestamp > latestTimestamp) {
                                latestTimestamp = timestamp;
                                latestMonth = monthMoment;
                            }
                        }
                    }
                });
                
                if (latestMonth) {
                    jatuhTempoDate = latestMonth.date(10);
                    jatuhTempoText = jatuhTempoDate.format('DD MMM YYYY');
                } else {
                    if (item.list_tagihan[0].tanggal_jatuh_tempo) {
                        jatuhTempoDate = moment(item.list_tagihan[0].tanggal_jatuh_tempo, 'DD-MM-YYYY');
                        if (jatuhTempoDate.isValid()) {
                            jatuhTempoText = jatuhTempoDate.format('DD MMM YYYY');
                        }
                    }
                }
            }
            
            return { 
                ...item, 
                kategori: kategori, 
                hari_terlambat: maxHariTerlambat,
                string_bulan: listBulan,
                string_jatuh_tempo: jatuhTempoText,
                jatuh_tempo_date: jatuhTempoDate,
                jumlah_tagihan: item.list_tagihan.length
            };
        });
        
        // Filter data berdasarkan kategori
        let allData = [...processedData];
        if (filterKategori !== 'semua') {
            allData = allData.filter(item => item.kategori === filterKategori);
        }
        
        // ⭐⭐ PAGINATION LOGIC ⭐⭐
        const itemsPerPage = 10;
        const totalPages = Math.ceil(allData.length / itemsPerPage);
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const tableData = allData.slice(startIndex, endIndex);
        
        // ⭐⭐ RENDER TABEL DENGAN PAGINATION ⭐⭐
        table.innerHTML = tableData.map((item, index) => {
            let badgeColor = '#fdcb6e';
            let badgeText = 'Ringan';
            if (item.kategori === 'sedang') {
                badgeColor = '#e17055';
                badgeText = 'Sedang';
            } else if (item.kategori === 'berat') {
                badgeColor = '#d63031';
                badgeText = 'Berat';
            }
            
            // ⭐⭐ TAMPILKAN KOORDINAT/LOKASI - TOMBOL MAP KECIL ⭐⭐
            let lokasiDisplay = '-';
            if (item.pelanggan_koordinat && item.pelanggan_koordinat !== '-') {
                lokasiDisplay = `
                    <div style="display: flex; align-items: center; gap: 3px; font-size: 11px;">
                        <i class="fas fa-map-marker-alt" style="color: #4361ee; font-size: 10px;"></i>
                        <span>${item.pelanggan_koordinat}</span>
                    </div>
                `;
            } else if (item.pelanggan_lokasi && item.pelanggan_lokasi !== '-') {
                lokasiDisplay = `<small style="font-size: 11px;">${item.pelanggan_lokasi}</small>`;
            }
            
            // ⭐⭐ TAMPILKAN SERVER ⭐⭐
            let serverBadge = '';
            if (item.pelanggan_server && item.pelanggan_server !== '-') {
                const serverColors = {
                    'Server Utama': '#4361ee',
                    'Server Timur': '#00b894',
                    'Server Barat': '#fd79a8',
                    'Server Selatan': '#fdcb6e',
                    'Server Pusat': '#6c5ce7'
                };
                
                const color = serverColors[item.pelanggan_server] || '#6c757d';
                serverBadge = `
                    <span style="background: ${color}; color: white; padding: 1px 6px; border-radius: 10px; font-size: 10px; font-weight: bold;">
                        ${item.pelanggan_server}
                    </span>
                `;
            }
            
            // ⭐⭐ TOMBOL MAP KECIL ⭐⭐
            let tombolMap = '';
            if (item.pelanggan_koordinat && item.pelanggan_koordinat !== '-') {
                tombolMap = `
                    <button class="btn btn-xs btn-outline" 
                            onclick="showOnMap('${item.pelanggan_koordinat}', '${item.pelanggan_nama}')" 
                            title="Lihat di Peta"
                            style="padding: 1px 4px; font-size: 10px; margin-top: 2px;">
                        <i class="fas fa-map" style="font-size: 9px;"></i>
                    </button>
                `;
            }
            
            return `
                <tr>
                    <!-- SERVER -->
                    <td style="text-align: center; font-size: 11px;">
                        ${serverBadge || '<span class="text-muted">-</span>'}
                    </td>
                    
                    <!-- PELANGGAN -->
                    <td style="font-size: 12px;">
                        <strong>${item.pelanggan_nama}</strong>
                        <br>
                        <small class="text-muted" style="font-size: 10px;">${item.pelanggan_telepon}</small>
                        <br>
                        <small style="color: #666; font-size: 10px;">${item.pelanggan_alamat}</small>
                    </td>
                    
                    <!-- LOKASI/KOORDINAT -->
                    <td style="font-size: 11px;">
                        ${lokasiDisplay}
                        ${tombolMap}
                    </td>
                    
                    <!-- BULAN TAGIHAN -->
                    <td style="font-size: 11px;">
                        <small style="color: var(--gray);">${item.string_bulan}</small>
                        <br>
                        <small class="text-muted" style="font-size: 10px;">${item.jumlah_tagihan} tagihan</small>
                    </td>
                    
                    <!-- NOMINAL -->
                    <td style="font-size: 12px;">
                        <strong>${formatRupiah(item.total_nominal)}</strong>
                        <br>
                        <small class="text-muted" style="font-size: 10px;">${item.hari_terlambat > 0 ? `${item.hari_terlambat} hari telat` : 'Belum telat'}</small>
                    </td>
                    
                    <!-- JATUH TEMPO -->
                    <td style="font-size: 11px;">
                        <small>${item.string_jatuh_tempo}</small>
                        ${item.jatuh_tempo_date ? `<br><small class="text-muted" style="font-size: 9px;">${moment(item.jatuh_tempo_date).fromNow()}</small>` : ''}
                    </td>
                    
                    <!-- KATEGORI -->
                    <td>
                        <span style="background: ${badgeColor}; color: white; padding: 1px 6px; border-radius: 8px; font-size: 10px; font-weight: bold;">
                            ${badgeText}
                        </span>
                    </td>
                    
                    <!-- STATUS -->
                    <td>
                        <span class="badge badge-warning" style="font-size: 10px; padding: 2px 6px;">
                            <i class="fas fa-clock" style="font-size: 9px;"></i> Belum
                        </span>
                    </td>
                    
                    <!-- AKSI -->
                    <td>
                        <div class="btn-group" style="gap: 2px;">
                            <button class="btn btn-sm btn-success" 
                                    onclick="showPayAllModal('${item.pelanggan_id}')" 
                                    title="Bayar Semua Tunggakan"
                                    style="padding: 2px 6px; font-size: 11px;">
                                <i class="fas fa-money-bill-wave"></i>
                            </button>
                            <button class="btn btn-sm btn-info" 
                                    onclick="viewTagihanDetails('${item.pelanggan_id}')" 
                                    title="Rincian Tagihan"
                                    style="padding: 2px 6px; font-size: 11px;">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        // ⭐⭐ RENDER PAGINATION DENGAN TOMBOL KIRI & KANAN ⭐⭐
        let paginationHTML = '<div class="pagination" style="display: flex; justify-content: center; align-items: center; gap: 5px; margin-top: 15px;">';
        
        // TOMBOL PREVIOUS (KIRI)
        if (page > 1) {
            paginationHTML += `
                <a class="page-link" 
                   onclick="loadTunggakanDataForModal('${filterKategori}', ${page - 1})"
                   style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-decoration: none;">
                    &laquo; Prev
                </a>
            `;
        }
        
        // ANGKA HALAMAN
        const maxVisiblePages = 5;
        let startPage = Math.max(1, page - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            if (i === page) {
                paginationHTML += `
                    <span class="page-link active" 
                          style="padding: 6px 10px; background: #4361ee; color: white; border-radius: 4px;">
                        ${i}
                    </span>
                `;
            } else {
                paginationHTML += `
                    <a class="page-link" 
                       onclick="loadTunggakanDataForModal('${filterKategori}', ${i})"
                       style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-decoration: none;">
                        ${i}
                    </a>
                `;
            }
        }
        
        // TOMBOL NEXT (KANAN)
        if (page < totalPages) {
            paginationHTML += `
                <a class="page-link" 
                   onclick="loadTunggakanDataForModal('${filterKategori}', ${page + 1})"
                   style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-decoration: none;">
                    Next &raquo;
                </a>
            `;
        }
        
        paginationHTML += '</div>';
        
        // INFO SUMMARY
        paginationHTML += `
            <div style="text-align: center; margin-top: 10px; color: var(--gray); font-size: 12px;">
                <i class="fas fa-info-circle"></i> 
                Halaman ${page} dari ${totalPages} | 
                Menampilkan ${startIndex + 1}-${Math.min(endIndex, allData.length)} dari ${allData.length} data
            </div>
        `;
        
        pagination.innerHTML = paginationHTML;
        
    } catch (error) {
        console.error("❌ Error load tunggakan modal:", error);
        table.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-danger" style="padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px;"></i>
                    <h4 style="margin-top:15px;">Error Memuat Data</h4>
                    <p>${error.message}</p>
                </td>
            </tr>`;
    }
}

// ⭐⭐ FUNGSI UNTUK TAMPILKAN DI PETA ⭐⭐
// ⭐⭐ FUNGSI UNTUK TAMPILKAN DI PETA (TOMBOL KECIL) ⭐⭐
function showOnMap(koordinat, nama) {
    console.log("🗺️ Menampilkan di peta:", koordinat, nama);
    
    // Parsing koordinat
    const parts = koordinat.split(',');
    if (parts.length !== 2) {
        showToast('error', 'Format Error', 'Format koordinat tidak valid');
        return;
    }
    
    const lat = parseFloat(parts[0].trim());
    const lng = parseFloat(parts[1].trim());
    
    if (isNaN(lat) || isNaN(lng)) {
        showToast('error', 'Format Error', 'Koordinat harus angka');
        return;
    }
    
    // Buka Google Maps di tab baru
    const url = `https://www.google.com/maps?q=${lat},${lng}`;
    window.open(url, '_blank');
    
    // Notifikasi kecil
    showToast('info', 'Peta', `Membuka lokasi ${nama}`, 2000);
}


// ============================================
// LOAD DATA TUNGGAKAN DENGAN PERHITUNGAN DINAMIS
// ============================================

async function loadTunggakanDynamicData(page = currentPageTunggakan) {

    currentPageTunggakan = page;

    const table = document.getElementById('tunggakanTable');
    if (!table) return;
    
    try {
        // 1. Ambil SEMUA Tagihan BELUM LUNAS
        const snapshot = await db.collection('tagihan')
            .where('company_id', '==', globalCompanyId)
            .where('status', '==', 'belum') // Status belum (termasuk telat)
            .get();
        
        if (snapshot.empty) {
            table.innerHTML = `<tr><td colspan="4" class="text-center" style="padding: 40px;">Tidak ada tunggakan saat ini. Semua tagihan sudah LUNAS.</td></tr>`;
            document.getElementById('tunggakanPagination').innerHTML = '';
            return;
        }
        
        // 2. Group Data per Pelanggan & Hitung Total
        const groupedMap = {};
        
        snapshot.forEach(doc => {
            const t = doc.data();
            const pid = t.pelanggan_id;
            const bulanRaw = t.bulan || "";
            
            // Konversi "01-2025" jadi Angka 1 (Januari)
            const parts = bulanRaw.split('-');
            const angkaBulan = parts[0] ? parseInt(parts[0], 10) : 0; // Ambil bagian bulan (01 jadi 1)
            
            if (!groupedMap[pid]) {
                // Init pelanggan baru
                groupedMap[pid] = {
                    pelanggan_id: pid,
                    pelanggan_nama: t.pelanggan_nama || 'Unknown',
                    pelanggan_telepon: t.pelanggan_telepon || '-',
                    total_uang: 0,
                    list_angka_bulan: [] // Simpan angka bulan: [1, 2, 3]
                };
            }
            
            // Tambah nominal
            groupedMap[pid].total_uang += Number(t.jumlah) || 0;
            
            // Simpan angka bulan (Hanya simpan angka unik agar tidak doang 1, 1, 1)
            if (!groupedMap[pid].list_angka_bulan.includes(angkaBulan)) {
                groupedMap[pid].list_angka_bulan.push(angkaBulan);
            }
        });
        
        // 3. Siapkan Array untuk Pagination
        let dataArray = Object.values(groupedMap);
        
        // 4. Pagination
        const itemsPerPage = 10;
        const totalPages = Math.ceil(dataArray.length / itemsPerPage);
        
        if (page > totalPages) page = totalPages;
        const startIndex = (page - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = dataArray.slice(startIndex, endIndex);
        
        // 5. Render Table
        let html = '';
        
        pageData.forEach((item, index) => {
            const nomor = startIndex + index + 1;
            
            // Ubah array angka [1, 2] jadi string "1, 2"
            const periodeString = item.list_angka_bulan.join(', ');
            
            html += `
                <tr>
                    <td>${nomor}</td>
                    <td><strong>${item.pelanggan_nama}</strong></td>
                    <td style="color: var(--danger); font-weight: bold;">${formatRupiah(item.total_uang)}</td>
                    <td><span style="background: #ffebeb; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 12px;">${periodeString}</span></td>
                </tr>
            `;
        });
        
        table.innerHTML = html;
        
        // Render Pagination
        renderPagination(dataArray.length, page, 'tunggakan', 'tunggakanPagination');
        
    } catch (error) {
        console.error("Error load tunggakan:", error);
        const table = document.getElementById('tunggakanTable');
        if(table) table.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Error: ${error.message}</td></tr>`;
    }
}


async function renderDistribusiPelangganChart() {
    try {
        const ctx = document.getElementById('laporanChart2');
        if (!ctx) return;
        
        // Hapus chart lama
        if (window.distribusiChart) {
            window.distribusiChart.destroy();
        }
        
        // AMBIL DATA REAL DARI DATABASE
        const snapshot = await db.collection('pelanggan')
            .where('company_id', '==', globalCompanyId)
            .get();
        
        if (snapshot.empty) {
            // Tampilkan chart kosong
            window.distribusiChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Tidak Ada Data'],
                    datasets: [{
                        data: [100],
                        backgroundColor: ['#e9ecef']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
            return;
        }
        
        // HITUNG DISTRIBUSI
        let aktif = 0, tunggak = 0, nonaktif = 0;
        
        snapshot.forEach(doc => {
            const status = doc.data().status || 'nonaktif';
            if (status === 'aktif') aktif++;
            else if (status === 'tunggak') tunggak++;
            else nonaktif++;
        });
        
        // BUAT CHART REAL
        window.distribusiChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Aktif', 'Tunggak', 'Nonaktif'],
                datasets: [{
                    data: [aktif, tunggak, nonaktif],
                    backgroundColor: ['#00b894', '#ff6b6b', '#fdcb6e'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = aktif + tunggak + nonaktif;
                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
        
        console.log(`✅ Chart distribusi: ${aktif} aktif, ${tunggak} tunggak, ${nonaktif} nonaktif`);
        
    } catch (error) {
        console.error("❌ Error render distribusi chart:", error);
    }
}

// -------------------------------------------------------
// 1. FUNGSI GENERATE LAPORAN (AMAN & LENGKAP)
// -------------------------------------------------------
async function generateLaporan() {
    console.log("📊 Generate Laporan: 6 BULAN TERAKHIR");

    const table = document.getElementById('laporanTable');
    if (!table) return;

    table.innerHTML = `<tr><td colspan="6" class="text-center"><div class="spinner" style="width:30px;height:30px;margin:0 auto;"></div> Memuat Data 6 Bulan...</td></tr>`;

    try {
        // 1. TENTUKAN 6 BULAN TERAKHIR
        const listBulan = [];
        
        for (let i = 5; i >= 0; i--) {
            const m = moment().subtract(i, 'months');
            const bulanKey = m.format('MM-YYYY');
            const labelDisplay = m.format('MMM YY');
            
            listBulan.push({ key: bulanKey, display: labelDisplay });
        }
        
        // 2. AMBIL DATA BATCH
        const promises = listBulan.map(item => {
            return db.collection('tagihan')
                .where('company_id', '==', globalCompanyId)
                .where('bulan', '==', item.key)
                .get();
        });

        const snapshots = await Promise.all(promises);

        // 3. GABUNGKAN SEMUA DATA
        let laporanData = [];
        let totalPendapatan = 0;

        snapshots.forEach((snap) => {
            snap.forEach(doc => {
                const t = doc.data();
                const nominal = Number(t.jumlah) || 0;
                
                // Hitung total (Semua status, atau bisa difilter cuma Lunas)
                totalPendapatan += nominal;

                let tglDisplay = '-';
                if (t.created_at) {
                    let m = moment(t.created_at);
                    if (m.isValid()) tglDisplay = m.format('DD/MM/YYYY');
                }

                // Cari label bulan yang sesuai dari listBulan
                const bulanInfo = listBulan.find(b => b.key === t.bulan);

                laporanData.push({
                    tanggal: tglDisplay,
                    bulanKey: t.bulan,          // Kunci untuk sorting
                    bulanDisplay: bulanInfo ? bulanInfo.display : t.bulan,
                    pelanggan: t.pelanggan_nama || 'Unknown',
                    nominal: nominal,
                    status: t.status || 'belum',
                    metode: t.metode_bayar || '-'
                });
            });
        });

        // 4. URUTKAN DATA: LAMA -> BARU (ASCENDING CHRONOLOGIS)
        laporanData.sort((a, b) => {
            const dateA = moment(a.bulanKey, 'MM-YYYY');
            const dateB = moment(b.bulanKey, 'MM-YYYY');
            
            if (dateA.isValid() && dateB.isValid()) {
                return dateA.valueOf() - dateB.valueOf();
            }
            return 0;
        });

        console.log(`💰 Total Pendapatan 6 Bulan: ${formatRupiah(totalPendapatan)}`);

        // 5. RENDER TABEL
        let tableHTML = `
            <thead>
                <tr>
                    <th>Periode</th>
                    <th>Pelanggan</th>
                    <th>Nominal</th>
                    <th>Status</th>
                    <th>Metode</th>
                </tr>
            </thead>
            <tbody>
        `;

        // Tampilkan 50 data terakhir
        laporanData.slice(-50).reverse().forEach(item => {
            let badgeClass = 'badge-warning'; 
            if (item.status === 'lunas') badgeClass = 'badge-success';

            tableHTML += `
                <tr>
                    <td><span class="badge badge-info">${item.bulanDisplay}</span></td>
                    <td><strong>${item.pelanggan}</strong></td>
                    <td>${formatRupiah(item.nominal)}</td>
                    <td><span class="badge ${badgeClass}">${item.status.toUpperCase()}</span></td>
                    <td>${item.metode}</td>
                </tr>
            `;
        });

        tableHTML += `</tbody>`;
        table.innerHTML = tableHTML;

        // 6. UPDATE GRAFIK
        updateLaporanCharts(laporanData);

        
        console.log("✅ Laporan berhasil digenerate dengan chart distribusi real");

    } catch (error) {
        console.error("❌ Error generate laporan:", error);
        table.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${error.message}</td></tr>`;
    }
}



// -------------------------------------------------------
// 2. FUNGSI UPDATE GRAFIK (MANDIRI & AMAN)
// -------------------------------------------------------
function updateLaporanCharts(data) {
    // CEGAH ERROR JIKA DATA KOSONG ATAU UNDEFINED
    if (!data || data.length === 0) {
    console.log("📊 Data kosong, tampilkan chart dengan data 0");
    
    // Hapus chart lama kalau ada
    if (window.laporanChartInstance) window.laporanChartInstance.destroy();
    
    // Chart 1 dengan data 0
    const ctx = document.getElementById('laporanChart1');
    if (ctx) {
        window.laporanChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun'],
                datasets: [{
                    label: 'Pendapatan (Rp)',
                    data: [0, 0, 0, 0, 0, 0],
                    backgroundColor: 'rgba(67, 97, 238, 0.6)'
                }]
            }
        });
    }
    
    // Chart 2 dengan data kosong
    const ctx2 = document.getElementById('laporanChart2');
    if (ctx2) {
        window.laporanChart2Instance = new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Belum Ada Data'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#e9ecef']
                }]
            }
        });
    }
    return;
}

    // 1. GRAFIK PENDAPATAN
    if (window.laporanChartInstance) {
        window.laporanChartInstance.destroy();
    }

    // Grouping data berdasarkan bulanKey
    const monthlyData = {};
    // Ambil semua key bulan yang unik dari data untuk label sumbu X
    const uniqueBulanKeys = [...new Set(data.map(item => item.bulanKey))];

    // Inisialisasi 0
    uniqueBulanKeys.forEach(key => {
        monthlyData[key] = 0;
    });

    // Hitung total per bulan
    data.forEach(item => {
        if (monthlyData[item.bulanKey] !== undefined) {
            monthlyData[item.bulanKey] += item.nominal;
        }
    });

    // Urutkan Label Bulan (Ascending: Jan, Feb, Mar...)
    uniqueBulanKeys.sort((a, b) => {
        const dateA = moment(a, 'MM-YYYY');
        const dateB = moment(b, 'MM-YYYY');
        return dateA.valueOf() - dateB.valueOf();
    });

    // Ambil total pendapatan berdasarkan urutan key
    const monthlyTotals = uniqueBulanKeys.map(key => monthlyData[key]);

    // Format Labels agar cantik
    const formattedLabels = uniqueBulanKeys.map(bulan => {
        const parts = bulan.split('-');
        if (parts.length === 2) {
            const dateObj = moment(`${parts[1]}-${parts[0]}-01`);
            return dateObj.isValid() ? dateObj.format('MMM YY') : bulan;
        }
        return bulan;
    });

    const ctx = document.getElementById('laporanChart1');
    if (ctx) {
        window.laporanChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: formattedLabels,
                datasets: [{
                    label: 'Pendapatan (Rp)',
                    data: monthlyTotals,
                    backgroundColor: 'rgba(67, 97, 238, 0.6)',
                    borderColor: '#4361ee',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return formatRupiah(value);
                            }
                        }
                    }
                }
            }
        });
    }

    // 2. GRAFIK DISTRIBUSI (PIE CHART - METODE PEMBAYARAN)
    // 2. GRAFIK DISTRIBUSI (PIE CHART - METODE PEMBAYARAN)
const ctx2 = document.getElementById('laporanChart2');
if (ctx2) {
    const metodeCounts = {};
    data.forEach(item => {
        const metode = item.metode || 'Lainnya'; // "Tunai", "Transfer", dll
        metodeCounts[metode] = (metodeCounts[metode] || 0) + 1;
    });

    window.laporanChart2Instance = new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: Object.keys(metodeCounts), // Contoh: ["Tunai", "Transfer"]
            datasets: [{
                data: Object.values(metodeCounts), // Contoh: [45, 55]
                backgroundColor: ['#00b894', '#0984e3', '#6c5ce7', '#fdcb6e', '#ff7675']
            }]
        }
    });
}};
        


// ============================================
// INITIALIZATION & EVENT HANDLERS (FIXED VERSION)
// ============================================



document.addEventListener('DOMContentLoaded', function() {
    console.log("🚀 X-BILL System Initializing...");

    (async function initGlobalData() {
        console.log("🚀 Inisialisasi Data Global Aplikasi...");
        
        try {
            // Kita coba ambil data Company Profile terlebih dahulu
            const doc = await db.collection('company_settings').doc('profile').get();
            
            if (doc.exists) {
                const data = doc.data();
                const companyName = data.companyName || 'X-BILL';
                const companyAddress = data.companyAddress || 'Jl. Internet Cepat No. 1';
                
                // Simpan ke Variable Global agar tidak hilang saat ganti menu
                window.globalCompanyName = companyName;
                window.globalCompanyAddress = companyAddress;
                
                // Update UI Navbar secara langsung (jika elemennya ada)
                const navElement = document.getElementById('companyNameNav');
                if (navElement) navElement.textContent = companyName;
                
                console.log("✅ Data Perusahaan dimuat dari Database:", companyName);
            } else {
                console.log("ℹ️ Belum ada profil perusahaan di database, gunakan default.");
                window.globalCompanyName = 'X-BILL';
                window.globalCompanyAddress = 'Jl. Internet Cepat No. 1';
            }
            
        } catch (error) {
            console.warn("⚠️ Gagal inisialisasi data global (mungkin belum login/offline):", error);
            // Set default jika error
            window.globalCompanyName = 'X-BILL';
            window.globalCompanyAddress = 'Jl. Internet Cepat No. 1';
        }
    })();
    
    // 1. SETUP DEFAULT DATES
    const today = moment().format('DD-MM-YYYY');
    const nextMonth = moment().add(1, 'month').format('MM-YYYY');
    
    const dateFields = ['prorataMulai', 'prorataAkhir', 'tanggalBayar'];
    dateFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = today;
    });
    
    const monthFields = ['generateBulan'];
    monthFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = nextMonth;
    });
    
    // 2. CEK STATUS LOGIN
    const savedUser = localStorage.getItem('xbill_user');
    const loginPageEl = document.getElementById('loginPage');
    const appContainerEl = document.getElementById('appContainer');
    
    if (savedUser && loginPageEl && appContainerEl) {
        try {
            currentUser = JSON.parse(savedUser);
            
            // Update UI User Info
            const userNameEl = document.getElementById('userName');
            const userAvatarEl = document.getElementById('userAvatar');
            const avatarTextEl = document.getElementById('avatarText');
            
            if (userNameEl) userNameEl.textContent = currentUser.name;
            if (userAvatarEl) userAvatarEl.textContent = currentUser.name.charAt(0);
            if (avatarTextEl) avatarTextEl.textContent = currentUser.name.charAt(0);
            
            // Switch View
            loginPageEl.classList.add('hidden');
            appContainerEl.classList.remove('hidden');
            
            // Load Dashboard
            // loadPage('dashboard');
            
        } catch (e) {
            console.error("Error parsing user:", e);
        }
    } else if (!savedUser && loginPageEl) {
        // Pastikan Login Page Tampil
        loginPageEl.classList.remove('hidden');
        if (appContainerEl) appContainerEl.classList.add('hidden');
    }
    
    // 3. ATTACH EVENT LISTENER UNTUK FORM LOGIN
    const loginForm = document.getElementById('loginForm');
if (loginForm) {
    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        
        if (!username || !password) {
            showToast('error', 'Login Gagal', 'Username dan Password wajib diisi');
            return;
        }

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Login...';
            showLoading();

            let userCredential = null;
            let userUid = null; // Variabel untuk menyimpan UID Firebase

            // 1. COBA LOGIN MENGGUNAKAN HARDCODE ADMIN
            if (username === 'admin' && password === 'admin123') {
                userCredential = {
                    uid: 'admin_hardcoded',
                    name: 'Administrator',
                    email: 'admin@xbill.com',
                    role: 'admin' // Default hardcoded
                };
                userUid = 'admin_hardcoded';
            } else {
                // 2. COBA LOGIN MENGGUNAKAN FIREBASE AUTH
                const email = username.includes('@') ? username : `${username}@xbill.com`;
                const authResult = await firebase.auth().signInWithEmailAndPassword(email, password);
                
                userCredential = {
                    uid: authResult.user.uid,
                    name: authResult.user.displayName || authResult.user.email.split('@')[0],
                    email: authResult.user.email,
                    role: null // Akan diisi dari database nanti
                };
                userUid = authResult.user.uid;
            }

            // 3. AMBIL DATA USER LENGKAP DARI FIRESTORE (AMBIL ROLE YANG ASLI)
            console.log("Mengambil data user dari Firestore untuk UID:", userUid);
            const userDocRef = db.collection('users').doc(userUid);
            const userDoc = await userDocRef.get();

            if (userDoc.exists) {
                const userData = userDoc.data();
                // Update role dengan yang ada di database
                userCredential.role = userData.role || 'admin'; 
                console.log("Role ditemukan di database:", userCredential.role);
            } else {
                console.warn("Data user tidak ditemukan di Firestore, menggunakan role default:", userCredential.role);
            }

            // 4. SIMPAN SESSION
            currentUser = userCredential;
            localStorage.setItem('xbill_user', JSON.stringify(currentUser));
            localStorage.setItem('userRole', currentUser.role);
            localStorage.setItem('userName', currentUser.name);

            // 5. SWITCH VIEW
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            
            // Update UI User Info
            if (document.getElementById('userName')) document.getElementById('userName').textContent = currentUser.name;
            if (document.getElementById('userAvatar')) document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
            
            // Update Role Text di Navbar
            if (document.getElementById('userRole')) {
                document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'Administrator' : currentUser.role.toUpperCase();
            }

            // 6. LOAD PAGE DASHBOARD
            await loadPage('dashboard');
            
            hideLoading();
          

        } catch (error) {
            // ⭐⭐ PERBAIKAN: Jangan tampilkan Toast Error jika sudah masuk Dashboard ⭐⭐
            console.error("❌ Error Login:", error);
            
            // Cek apakah user sudah masuk dashboard sebelum menampilkan error
            const appContainer = document.getElementById('appContainer');
            if (!appContainer.classList.contains('hidden')) {
                console.log("⚠️ User sudah di dashboard, abaikan error login toast ini.");
                return; // Stop jangan tampilkan error toast
            }

            hideLoading();
            
            // Kembalikan tombol
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
            
            // Opsional: Tampilkan pesan error hanya jika benar-benar gagal total
            // showToast('error', 'Login Gagal', error.message);
        } finally {
            // Pastikan tombol kembali normal
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
    });
}
    
    
    
    // 5. ATTACH LOGOUT
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                localStorage.removeItem('xbill_user');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userName');
                currentUser = null;
                firebase.auth().signOut().catch(() => {});
                window.location.reload();
            }
        });
    }

    // 6. ATTACH OTHER EVENTS
    const encryptEl = document.getElementById('encryptData');
    if (encryptEl) {
        encryptEl.addEventListener('change', function() {
            const el = document.getElementById('passwordSection');
            if (el) el.style.display = this.checked ? 'block' : 'none';
        });
    }
    
    const reminderEl = document.getElementById('reminderSchedule');
    if (reminderEl) {
        reminderEl.addEventListener('change', function() {
            const el = document.getElementById('customSchedule');
            if (el) el.style.display = (this.value === 'custom') ? 'block' : 'none';
        });
    }
    
    console.log("✅ Initialization Complete.");
});


// Dalam fungsi loadPage('setting') atau fungsi yang merender halaman setting
document.querySelectorAll('.setting-card').forEach(card => {
    card.addEventListener('click', function() {
        const targetModal = this.getAttribute('data-modal');
        if (targetModal) {
            showModal(targetModal);
            
            // Load data sesuai modal
            switch(targetModal) {
                case 'modalCompanyProfile':
                    setTimeout(loadCompanyProfile, 100);
                    break;
                case 'modalBranding':
                    setTimeout(loadBrandingSettings, 100);
                    break;
                case 'modalUserProfile':
                    setTimeout(loadUserProfile, 100);
                    break;
            }
        }
    });
});

// ============================================
// 2. TOMBOL GENERATE TAGIHAN (FIXING)
// ============================================

// ⭐⭐ TAMBAHKAN VALIDASI ELEMENT DULU ⭐⭐
const btnGenerate = document.getElementById('btnGenerateTagihan');

if (!btnGenerate) {
    console.log("⚠️ Tombol btnGenerateTagihan tidak ditemukan, skip event listener");
} else {
    btnGenerate.addEventListener('click', function(e) {
        e.preventDefault();
        
        const modal = document.getElementById('modalGenerateTagihan');
        if (!modal) {
            console.error("❌ Modal generate tagihan tidak ditemukan");
            return;
        }
        
        // Set nilai default bulan ke bulan INI
        const todayMoment = moment();
        const bulanKini = todayMoment.format('MM-YYYY');
        
        // Reset checkbox
        document.getElementById('generateProrata').checked = true; 
        
        // Isi form
        const bulanInput = document.getElementById('generateBulan');
        if(bulanInput) {
            bulanInput.value = bulanKini;
        }
        
        // Show modal
        modal.classList.remove('hidden');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';

        // Panggil fungsi generate
        setTimeout(() => {
            console.log("Tombol Generate diklik...");
            // generateTagihanBulk(); // ⭐⭐ COMMENT DULU JIKA MAU TEST MODAL
        }, 300);
    });
}



// ============================================
// FIX TOMBOL BAYAR DI HALAMAN DAFTAR TAGIHAN
// ============================================

document.body.addEventListener('click', function(e) {
    // Cari elemen <button> atau <i> di dalam tombol yang diklik
    const target = e.target;
    const btn = target.closest('button');

    // Cek apakah yang diklik adalah tombol Bayar (Warna Hijau, Ikon Uang/Dollar)
    // atau tombol yang memiliki onclick mengandung kata "executePayAllDirect" (Untuk tombol Bayar di grup)
    
    if (btn) {
        const onclickAttr = btn.getAttribute('onclick') || '';
        
        // LOGIKA 1: Jika tombol BAYAR SEMUA (Grup Pelanggan)
        if (onclickAttr.includes('executePayAllDirect')) {
            e.preventDefault(); // Mencegah aksi default/error
            
            // Ambil data dari tombol
            const pelangganId = btn.getAttribute('data-pid') || btn.getAttribute('onclick').match(/'([^']+)'/)[1]; // Ambil ID string
            // Perlu mengambil ID dan Total dari context tabel
            // Cara paling aman adalah mencari baris tabel (tr) terdekat
            const row = btn.closest('tr');
            if (row) {
                // Disini kita perlu menarik data 'belumUrut' yang tersimpan secara global di window atau ambil manual dari array
                // Karena tombol di tabel utama biasanya membuka modal 'viewTagihanDetails' dulu
                // JADI untuk tabel DAFTAR TAGIHAN, tombol 'Bayar' biasanya memanggil 'showPayAllModal'
                if (onclickAttr.includes('showPayAllModal')) {
                    showPayAllModal(pelangganId);
                }
            }
        }

        // LOGIKA 2: Jika tombol BAYAR LANGSUNG (Tombol tunggal per tagihan - JIKA ADA)
        // Biasanya di tabel utama tombolnya 'showPayAllModal', tapi kalau tombol bayar langsung:
        if (onclickAttr.includes('bayarTagihanDenganStruk')) {
            e.preventDefault();
            e.stopPropagation();
            
            // Ekstrak parameter dari string onclick jika perlu, atau panggil fungsi langsung
            // Karena tombol di tabel utama sering pakai showPayAllModal, kita fokus ke situ dulu:
            // showPayAllModal(pid);
        }
    }
});


// ⭐⭐⭐ GLOBAL CLICK HANDLER UNTUK LOG ⭐⭐⭐
document.addEventListener('click', async function(e) {
    const target = e.target;
    
    // Tangkap semua tombol simpan/hapus
    if (target.matches('[onclick*="save"], [onclick*="delete"], [onclick*="generate"]')) {
        const onclickText = target.getAttribute('onclick') || '';
        
        // Auto-log setelah 2 detik (biar proses utama selesai dulu)
        setTimeout(async () => {
            try {
                await db.collection('aktivitas').add({
                    aktivitas: `KLIK: ${onclickText.substring(0, 50)}...`,
                    user: currentUser?.email || "User",
                    timestamp: new Date().toISOString(),
                    company_id: globalCompanyId
                });
            } catch (e) {
                // Ignore
            }
        }, 2000);
    }
});
        
        // Encrypt data checkbox handler
        document.getElementById('encryptData')?.addEventListener('change', function() {
            const passwordSection = document.getElementById('passwordSection');
            if (this.checked) {
                passwordSection.style.display = 'block';
            } else {
                passwordSection.style.display = 'none';
            }
        });
        
        // Reminder schedule handler
        document.getElementById('reminderSchedule')?.addEventListener('change', function() {
            const customSchedule = document.getElementById('customSchedule');
            if (this.value === 'custom') {
                customSchedule.style.display = 'block';
            } else {
                customSchedule.style.display = 'none';
            }
        });
        
        console.log("X-BILL System Loaded Successfully!");

        // Blokir form submit default
document.addEventListener('DOMContentLoaded', function() {
    const allForms = document.querySelectorAll('form');
    allForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        });
    });
    
    // Blokir click pada semua tombol di modal
    const allButtons = document.querySelectorAll('.modal button');
    allButtons.forEach(button => {
        if (!button.onclick) {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
        }
    });
});

// ============================================
// TOMBOL BACK HP: KLIK 2X MUNCUL KONFIRMASI KELUAR
// ============================================

let backButtonPressed = 0;
let backButtonTimer = null;

// Fungsi utama handle tombol back
function handleBackButton() {

 // CEK APAKAH SEDANG DI HALAMAN LOGIN
    if (!document.getElementById('appContainer').classList.contains('hidden')) {
        console.log("Di halaman login, back diabaikan");
        return;
    }
    backButtonPressed++;
    
    if (backButtonPressed === 1) {
        
        // Reset setelah 2 detik
        backButtonTimer = setTimeout(() => {
            backButtonPressed = 0;
        }, 2000);
    } else if (backButtonPressed === 2) {
        // Reset counter
        backButtonPressed = 0;
        if (backButtonTimer) {
            clearTimeout(backButtonTimer);
            backButtonTimer = null;
        }
        
        // Tampilkan popup konfirmasi keluar
        showExitConfirmation();
    }
}

// Popup konfirmasi keluar kustom
function showExitConfirmation() {
    const modalId = 'exitConfirmationModal';
    
    // Hapus modal lama jika ada
    const oldModal = document.getElementById(modalId);
    if (oldModal) oldModal.remove();
    
    // Buat modal kustom
    const modal = document.createElement('div');
    modal.id = modalId;
    modal.className = 'modal-overlay show';
    modal.style.zIndex = '999999';
    modal.innerHTML = `
        <div class="modal" style="max-width: 400px; animation: modalSlide 0.3s ease;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%); color: white;">
                <h3 class="modal-title">
                    <i class="fas fa-door-open"></i> Keluar Aplikasi
                </h3>
                <button class="modal-close" style="color: white;" onclick="closeExitModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 60px; color: #ff6b6b; margin-bottom: 15px;">
                        <i class="fas fa-question-circle"></i>
                    </div>
                    <h4 style="color: #2c3e50; margin-bottom: 10px;">Yakin Mau Keluar?</h4>
                    <p style="color: #7f8c8d; line-height: 1.5;">
                        Anda akan keluar dari aplikasi X-BILL.<br>
                        Pastikan semua data sudah tersimpan.
                    </p>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 15px;">
                <button onclick="closeExitModal()" class="btn btn-outline" style="padding: 12px 25px; min-width: 120px;">
                    <i class="fas fa-times"></i> Batal
                </button>
                <button onclick="confirmExitApp()" class="btn btn-danger" style="padding: 12px 25px; min-width: 120px; background: linear-gradient(135deg, #ff6b6b 0%, #ff4757 100%);">
                    <i class="fas fa-sign-out-alt"></i> Keluar
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
}

// Fungsi tutup modal
function closeExitModal() {
    const modal = document.getElementById('exitConfirmationModal');
    if (modal) modal.remove();
    document.body.style.overflow = 'auto';
}

// Fungsi konfirmasi keluar
function confirmExitApp() {
    // Log aktivitas keluar
    db.collection('aktivitas').add({
        aktivitas: 'User keluar dari aplikasi via back button',
        user: getUserLogName(),
        timestamp: new Date().toISOString(),
        company_id: globalCompanyId
    });
    
    // Logout dari Firebase
    firebase.auth().signOut().then(() => {
        closeExitModal();
        
        // Redirect ke halaman login
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('appContainer').classList.add('hidden');
        
        showToast('success', 'Sampai Jumpa', 'Anda berhasil keluar dari aplikasi');
    }).catch(error => {
        console.error("Error logout:", error);
        showToast('error', 'Gagal', 'Gagal logout: ' + error.message);
    });
}

// Ganti fungsi tambahServerLangsung() dengan ini:
function tambahServerLangsung() {
    console.log("🎯 tambahServerLangsung() dipanggil");
    
    // Panggil fungsi tampilkanModalServer (yang sudah ada di STEP 2)
    if (typeof tampilkanModalServer === 'function') {
        tampilkanModalServer();
    } else {
        console.error("❌ Fungsi tampilkanModalServer tidak ditemukan!");
        // Fallback: tampilkan modal manual
        const modal = document.getElementById('modalTambahServerKecil');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('show');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
    }
}


// Fungsi tampilkan modal server (jika belum ada)
function tampilkanModalServer() {
    console.log("🚀 Menampilkan modal server...");
    
    const modal = document.getElementById('modalTambahServerKecil');
    if (!modal) {
        console.error("❌ Modal tidak ditemukan");
        return;
    }
    
    // Tampilkan modal
    modal.classList.remove('hidden');
    modal.classList.add('show');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // Focus ke input
    setTimeout(() => {
        const input = document.getElementById('inputServerBaru');
        if (input) {
            input.value = '';
            input.focus();
        }
    }, 100);
}


// Fungsi simpan dari modal
async function simpanServerModal() {
    const input = document.getElementById('inputServerBaru');
    const namaServer = input.value.trim();
    
    if (!namaServer) {
        showToast('error', 'Error', 'Nama server wajib diisi');
        input.focus();
        return;
    }
    
    try {
        showLoading();
        
        // ⭐⭐ VALIDASI DUPLIKAT DI DATABASE ⭐⭐
        const checkSnapshot = await db.collection('servers')
            .where('company_id', '==', globalCompanyId)
            .where('nama', '==', namaServer)
            .get();
            
        if (!checkSnapshot.empty) {
            showToast('warning', 'Server sudah ada', 
                `Server "${namaServer}" sudah terdaftar di database.`);
            input.focus();
            hideLoading();
            return;
        }
        
        // ⭐⭐ SIMPAN KE DATABASE ⭐⭐
        const serverData = {
            nama: namaServer,
            company_id: globalCompanyId,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            status: 'aktif'
        };
        
        await db.collection('servers').add(serverData);
        
        hideLoading();
        hideModal('modalTambahServerKecil');
        
        // ⭐⭐ REFRESH DROPDOWN (DENGAN FILTER UNIQUE) ⭐⭐
        await loadServerOptions();
        
        showToast('success', 'Berhasil', `Server "${namaServer}" ditambahkan`);
        
        // Auto-select server baru
        setTimeout(() => {
            const select = document.getElementById('filterServer');
            if (select) {
                select.value = namaServer;
                if (typeof loadPelangganData === 'function') loadPelangganData();
            }
        }, 500);
        
    } catch (error) {
        hideLoading();
        console.error("Error save server:", error);
        showToast('error', 'Gagal', 'Tidak bisa menyimpan server');
    }
        // Reset cache server
    window._serverOptionsCache = null;
    window._pelangganCache = null;
    window._pelangganCacheTime = 0;
}
async function loadServerOptions() {

    if (window._serverOptionsCache) {
        console.log("⚡ Pakai cache server options (NO READ)");
        return window._serverOptionsCache;
    }

    try {
        console.log("🔄 Memuat opsi server dari database...");

        const servers = new Set();

        // 🔥 CEK CACHE PELANGGAN DENGAN TIMESTAMP
        const now = Date.now();
        if (window._pelangganCache && window._pelangganCache.length &&
            window._pelangganCacheTime && (now - window._pelangganCacheTime) < 300000) {

            console.log("⚡ Pakai cache pelanggan untuk server options");
            window._pelangganCache.forEach(p => {
                if (p.server && p.server.trim() !== '') {
                    servers.add(p.server.trim());
                }
            });
        } else {
            // fallback kalau cache expired
            const pelangganSnapshot = await db.collection('pelanggan')
                .where('company_id', '==', globalCompanyId)
                .get();

            pelangganSnapshot.forEach(doc => {
                const p = doc.data();
                if (p.server && p.server.trim() !== '') {
                    servers.add(p.server.trim());
                }
            });

            // Update cache pelanggan
            window._pelangganCache = pelangganSnapshot.docs.map(doc => doc.data());
            window._pelangganCacheTime = now;
        }

        // 🔥 2. Ambil dari collection servers (sekali saja)
        const snapshot = await db.collection('servers')
            .where('company_id', '==', globalCompanyId)
            .where('status', '==', 'aktif')
            .get();

        snapshot.forEach(doc => {
            const s = doc.data();
            if (s.nama && s.nama.trim() !== '') {
                servers.add(s.nama.trim());
            }
        });

        const sortedServers = Array.from(servers).sort();

        window._serverOptionsCache = sortedServers;

        console.log("📋 Servers:", sortedServers);
        return sortedServers;

    } catch (error) {
        console.error("❌ Error load server options:", error);
        return [];
    }
}

function updateDropdownServer(selectId, servers) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    const selectedValue = select.value;
    
    // Clear
    select.innerHTML = '<option value="">Semua Server</option>';
    
    // Filter UNIQUE
    const uniqueNames = new Set();
    
    servers.forEach(server => {
        if (server.nama && !uniqueNames.has(server.nama)) {
            uniqueNames.add(server.nama);
            
            const option = document.createElement('option');
            option.value = server.nama;
            option.textContent = server.nama;
            select.appendChild(option);
        }
    });
    
    // Tambah opsi tambah server
    const addOption = document.createElement('option');
    addOption.value = "+tambah";
    addOption.textContent = "+ Tambah Server Baru";
    addOption.style.cssText = "color: #4361ee; font-weight: bold; background: #f0f9ff;";
    select.appendChild(addOption);
    
    // Kembalikan nilai selected
    if (selectedValue && selectedValue !== "+tambah") {
        select.value = selectedValue;
    }
}


// Fungsi handle perubahan dropdown server
function handleServerFilterChange(selectElement) {
    console.log("🔘 Dropdown server dipilih:", selectElement.value);
    
    if (selectElement.value === "+tambah") {
        // Panggil fungsi yang sudah ada
        tambahServerLangsung();
        
        // Reset dropdown ke default
        setTimeout(() => {
            selectElement.value = "";
        }, 100);
    } else {
        // Filter normal
        if (typeof saveFilterState === 'function') saveFilterState();
        if (typeof loadPelangganData === 'function') loadPelangganData(selectElement.value);
    }
}



function filterByServerTagihan(serverName) {
    console.log("📡 Filter tagihan by server:", serverName);
    
    // Simpan filter ke localStorage/state
    if (typeof saveFilterState === 'function') {
        saveFilterState();
    }
    
    // Load data tagihan dengan filter
    if (typeof loadTagihanData === 'function') {
        loadTagihanData();
    }
}

// Juga buat fungsi untuk reset filter
function resetFilterTagihan() {
    const select = document.getElementById('filterServerTagihan');
    if (select) select.value = "";
    
    if (typeof loadTagihanData === 'function') {
        loadTagihanData();
    }
}


// Panggil saat halaman pelanggan dimuat
if (document.querySelector('.pelanggan-page')) {
    setTimeout(initServerDropdown, 500);
}

// Tambah event Enter key di input
document.getElementById('inputServerBaru')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        simpanServerModal();
    }
});

// ============================================
// SETUP EVENT LISTENER UNTUK TOMBOL BACK
// ============================================

// Event listener untuk Cordova/PhoneGap (jika build jadi app)
if (window.cordova || window.PhoneGap) {
    document.addEventListener('deviceready', function() {
        document.addEventListener('backbutton', function(e) {
            e.preventDefault();
            handleBackButton();
        }, false);
    }, false);
} 
// Fallback untuk browser (PC/mobile)
else {
    // Deteksi jika di mobile browser
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
        // Untuk mobile browser, intercept popstate
        window.addEventListener('popstate', function(e) {
            e.preventDefault();
            handleBackButton();
        });
    } else {
        // Untuk PC: tambah tombol debug (opsional)
        document.addEventListener('keydown', function(e) {
            // Backspace key untuk simulasi back button
            if (e.key === 'Backspace' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                handleBackButton();
            }
        });
    }
}


async function loadServerOptionsForTagihan() {
    try {
        const snapshot = await db.collection('servers')
            .where('company_id', '==', globalCompanyId)
            .get();
        
        const servers = [];
        snapshot.forEach(doc => {
            servers.push(doc.data());
        });
        
        // Sort manual
        servers.sort((a, b) => (a.nama || '').localeCompare(b.nama || ''));
        
        // Update dropdown tagihan (TANPA opsi tambah)
        updateDropdownServerTagihan('filterServerTagihan', servers);
        
    } catch (error) {
        console.error("Error load servers for tagihan:", error);
    }
}

// Fungsi update dropdown khusus tagihan
function updateDropdownServerTagihan(selectId, servers) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    const selectedValue = select.value;
    
    // Clear
    select.innerHTML = '<option value="">Semua Server</option>';
    
    // Filter UNIQUE (sama seperti pelanggan)
    const uniqueNames = new Set();
    
    servers.forEach(server => {
        if (server.nama && !uniqueNames.has(server.nama)) {
            uniqueNames.add(server.nama);
            
            const option = document.createElement('option');
            option.value = server.nama;
            option.textContent = server.nama;
            select.appendChild(option);
        }
    });
    
    // ⭐⭐ TIDAK ADA OPSI "+ Tambah Server Baru" ⭐⭐
    
    // Kembalikan nilai selected
    if (selectedValue) {
        select.value = selectedValue;
    }
}

// ⭐ EVENT DRAG HANYA UNTUK ADMIN:
if (isAdmin) {
    marker.on('dragend', function(e) {
        const newPos = e.target.getLatLng();
        const newKoordinat = `${newPos.lat},${newPos.lng}`;
        
        // ⭐ CUSTOM CONFIRM DIALOG
        const modalId = 'confirmDragModal';
        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal-overlay show';
        modal.style.zIndex = '999999';
        modal.innerHTML = `
            <div class="modal" style="max-width: 400px; animation: modalSlide 0.3s ease;">
                <div class="modal-header">
                    <h3 class="modal-title" style="color: #4361ee;">
                        <i class="fas fa-map-marker-alt"></i> Update Lokasi
                    </h3>
                    <button class="modal-close" onclick="document.getElementById('${modalId}').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="text-align: center; padding: 15px 0;">
                        <div style="font-size: 48px; color: #4361ee; margin-bottom: 15px;">
                            <i class="fas fa-map-pin"></i>
                        </div>
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">Pindah Lokasi Pelanggan</h4>
                        <p style="color: #7f8c8d; line-height: 1.5; margin-bottom: 20px;">
                            <strong>${pelanggan.nama || 'Pelanggan'}</strong><br>
                            Koordinat baru: <strong>${newKoordinat}</strong>
                        </p>
                        <div style="background: #f0f9ff; border-radius: 8px; padding: 10px; margin: 10px 0; text-align: left;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <i class="fas fa-info-circle" style="color: #3498db;"></i>
                                <small><strong>Koordinat lama:</strong></small>
                            </div>
                            <div style="padding-left: 25px; font-size: 12px; color: #666;">
                                ${pelanggan.koordinat || 'Belum ada koordinat'}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="justify-content: center; gap: 10px;">
                    <button class="btn btn-outline" onclick="document.getElementById('${modalId}').remove()" style="padding: 10px 20px;">
                        <i class="fas fa-times"></i> Batal
                    </button>
                    <button id="btnConfirmDrag" class="btn btn-primary" style="padding: 10px 20px;">
                        <i class="fas fa-check"></i> Simpan Lokasi Baru
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
        
        // Event listener untuk tombol konfirmasi
        document.getElementById('btnConfirmDrag').onclick = async function() {
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
            btn.disabled = true;
            
            try {
                // Update koordinat di database
                await db.collection('pelanggan').doc(doc.id).update({
                    koordinat: newKoordinat,
                    updated_at: new Date().toISOString()
                });
                
                // Tutup modal
                document.getElementById(modalId).remove();
                document.body.style.overflow = 'auto';
                
                // Tampilkan notifikasi sukses
                showToast('success', 'Berhasil', `Lokasi ${pelanggan.nama} berhasil diperbarui`);
                
                // Log aktivitas
                await db.collection('aktivitas').add({
                    aktivitas: `Update lokasi pelanggan: ${pelanggan.nama} → ${newKoordinat}`,
                    user: getUserLogName(),
                    timestamp: new Date().toISOString(),
                    company_id: globalCompanyId
                });
                
            } catch (error) {
                // Kembalikan marker ke posisi semula jika gagal
                marker.setLatLng([coords[0], coords[1]]);
                
                // Tutup modal dan tampilkan error
                document.getElementById(modalId).remove();
                document.body.style.overflow = 'auto';
                
                console.error("Error update koordinat:", error);
                showToast('error', 'Gagal', 'Tidak bisa menyimpan lokasi baru: ' + error.message);
                
                // Reset tombol
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
    });
}

// ============================================
// HANDLE PERUBAHAN SERVER DI DROPDOWN
// ============================================

function handleServerChange(serverValue) {
    if (serverValue === "+tambah") {
        showModal('modalTambahServerKecil');
        return;
    }
    
    // SIMPAN FILTER YANG DIPILIH
    window.activeServerFilter = serverValue;
    
    // RESET KE HALAMAN 1
    currentPagePelanggan = 1;
    
    // LOAD DATA DENGAN FILTER
    loadPelangganData(serverValue);
}

// Fungsi untuk baca state filter saat halaman dimuat
function loadFilterState() {
    const savedFilter = localStorage.getItem('filterServerState');
    if (savedFilter) {
        const filterDropdown = document.getElementById('filterServer');
        if (filterDropdown) {
            filterDropdown.value = savedFilter;
            handleServerChange(savedFilter);
        }
    }
}

// Auto refresh saat app aktif kembali
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        console.log("🔄 App aktif kembali");
        // Refresh data
        if (window.currentPage === 'dashboard' && typeof renderDashboard === 'function') {
            setTimeout(renderDashboard, 500);
        }
    }
});



// ============================================
// ⭐⭐ HANDLE TOMBOL BACK HP - VERSI IMPROVED ⭐⭐
// ============================================

// ⭐⭐ DEKLARASI VARIABLE ⭐⭐


// FUNGSI UNTUK TAMBAH HISTORY
function addToPageHistory(page) {
    if (pageHistory[pageHistory.length - 1] !== page) {
        pageHistory.push(page);
        console.log("📝 History:", pageHistory);
        
        // Max 10 history
        if (pageHistory.length > 10) {
            pageHistory.shift();
        }
    }
}

// FUNGSI NAVIGASI BACK DENGAN TOAST CUSTOM
function navigateBack() {
    // Cari halaman sebelumnya dalam riwayat
    const historyIndex = pageHistory.indexOf(currentPage);
    
    if (historyIndex > 0) {
        const prevPage = pageHistory[historyIndex - 1];
        
        // Hapus halaman saat ini dari history
        pageHistory.splice(historyIndex, 1);
        
        // Navigasi ke halaman sebelumnya
        loadPage(prevPage);
        
        // Tampilkan toast custom
        showToast('info', 'Navigasi', `Kembali ke ${getPageTitle(prevPage)}`, 1500);
    } else {
        // Sudah di halaman pertama, tetap di dashboard
        showToast('info', 'Anda sudah di halaman awal', 'Tidak ada halaman sebelumnya', 1500);
    }
}

// FUNGSI KONFIRMASI KELUAR DENGAN MODAL CUSTOM
function showExitConfirmModal() {
    // Hapus modal lama jika ada
    const oldModal = document.getElementById('exitConfirmModal');
    if (oldModal) oldModal.remove();
    
    // Buat modal custom
    const modal = document.createElement('div');
    modal.id = 'exitConfirmModal';
    modal.className = 'modal-overlay show';
    modal.style.zIndex = '999999';
    
    modal.innerHTML = `
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header" style="background: var(--danger); color: white;">
                <h3 class="modal-title">
                    <i class="fas fa-sign-out-alt"></i> Keluar Aplikasi?
                </h3>
                <button class="modal-close" onclick="document.getElementById('exitConfirmModal').remove(); document.body.style.overflow='auto'" style="color: white;">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 48px; color: var(--danger); margin-bottom: 15px;">
                        <i class="fas fa-door-open"></i>
                    </div>
                    <h4 style="color: var(--dark); margin-bottom: 10px;">Yakin ingin keluar?</h4>
                    <p style="color: var(--gray); line-height: 1.5;">
                        Anda akan keluar dari aplikasi X-BILL.<br>
                        <strong style="color: var(--danger);">Data login tetap tersimpan.</strong>
                    </p>
                    <div style="background: rgba(255, 107, 107, 0.1); border-left: 4px solid var(--danger); padding: 10px; margin: 15px 0; text-align: left; border-radius: 4px;">
                        <i class="fas fa-info-circle" style="color: var(--danger);"></i>
                        <small style="color: var(--gray);">Untuk logout lengkap, gunakan menu Logout di profil.</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center; gap: 10px;">
                <button class="btn btn-outline" onclick="document.getElementById('exitConfirmModal').remove(); document.body.style.overflow='auto'" style="padding: 10px 20px;">
                    <i class="fas fa-times"></i> Batal
                </button>
                <button id="btnConfirmExitApp" class="btn btn-danger" style="padding: 10px 20px;">
                    <i class="fas fa-check"></i> Keluar
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
    
    // Event listener untuk tombol konfirmasi
    document.getElementById('btnConfirmExitApp').onclick = function() {
        // Tutup modal
        document.getElementById('exitConfirmModal').remove();
        document.body.style.overflow = 'auto';
        
        // Tampilkan toast custom
        showToast('info', 'Aplikasi Ditutup', 'Anda telah keluar dari aplikasi X-BILL', 2000);
        
        // Sembunyikan app container, tampilkan login page
        document.getElementById('appContainer').classList.add('hidden');
        document.getElementById('loginPage').classList.remove('hidden');
        
        // Reset history
        pageHistory = ['dashboard'];
        currentPage = 'dashboard';
        
        // Reset last back press
        lastBackPress = 0;
    };
}

function handleLogoUpload(input) {
    console.log("🎯 Fungsi dipanggil");
    console.log("📂 File:", input.files);
    
    if (!input.files || input.files.length === 0) {
        console.error("❌ Tidak ada file");
        return;
    }
    
    const file = input.files[0];
    console.log("📄 File details:", file.name, file.size, file.type);
    
    // Validasi
    if (file.size > 2 * 1024 * 1024) {
        alert("Maksimal 2MB");
        return;
    }
    
    if (!file.type.startsWith('image/')) {
        alert("Hanya file gambar (JPG, PNG, GIF)");
        return;
    }
    
    // Preview
    const reader = new FileReader();
    
    reader.onload = function(e) {
        const logoPreview = document.getElementById('logoPreview');

        // KOSONGKAN DULU
        logoPreview.innerHTML = '';

        // BUAT GAMBAR BARU
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'contain';
        img.style.borderRadius = '10px';

        // TAMBAHIN KE PREVIEW
        logoPreview.appendChild(img);

        // BARU PANGGIL MAKE DRAGGABLE
        makeDraggable(img);

        console.log("🎨 Preview berhasil ditambahkan");
    };

    reader.onerror = function(e) {
        console.error("❌ FileReader error:", e);
        alert("Gagal membaca file");
    };

    reader.readAsDataURL(file);
    console.log("📖 Membaca file sebagai DataURL...");
}


let isDragging = false;
let startX, startY, startLeft, startTop;
let currentImage = null;

function makeDraggable(imgElement) {
    currentImage = imgElement;

    // Style dasar
    imgElement.style.position = 'absolute';
    imgElement.style.cursor = 'move';
    imgElement.style.width = 'auto';
    imgElement.style.height = 'auto';
    imgElement.style.maxWidth = 'none';
    imgElement.style.maxHeight = 'none';
    imgElement.style.userSelect = 'none';
    imgElement.style.webkitUserSelect = 'none';
    imgElement.style.touchAction = 'none';
    imgElement.style.transition = 'width 0.2s ease, height 0.2s ease';

    const parent = imgElement.parentElement;
    parent.style.position = 'relative';
    parent.style.overflow = 'hidden';

    // Ambil ukuran asli
    if (!imgElement.dataset.naturalWidth) {
        const tempImg = new Image();
        tempImg.src = imgElement.src;
        tempImg.onload = function() {
            imgElement.dataset.naturalWidth = tempImg.width;
            imgElement.dataset.naturalHeight = tempImg.height;
            imgElement.dataset.scale = 1;
            imgElement.style.width = tempImg.width + 'px';
            imgElement.style.height = tempImg.height + 'px';
        };
    }

    // ========== DRAG (1 JARI) ==========
    let isDragging = false;
    let startX, startY, startLeft, startTop;

    const startDrag = (e) => {
        if (e.touches && e.touches.length > 1) return;

        e.preventDefault();
        isDragging = true;

        const clientX = e.clientX ?? e.touches[0].clientX;
        const clientY = e.clientY ?? e.touches[0].clientY;

        startX = clientX;
        startY = clientY;
        startLeft = imgElement.offsetLeft;
        startTop = imgElement.offsetTop;
    };

    imgElement.addEventListener('mousedown', startDrag);
    imgElement.addEventListener('touchstart', startDrag);

    const onDrag = (e) => {
        if (!isDragging) return;
        if (e.touches && e.touches.length > 1) {
            isDragging = false;
            return;
        }

        e.preventDefault();

        const clientX = e.clientX ?? e.touches[0].clientX;
        const clientY = e.clientY ?? e.touches[0].clientY;

        imgElement.style.left = (startLeft + clientX - startX) + 'px';
        imgElement.style.top = (startTop + clientY - startY) + 'px';
    };

    document.addEventListener('mousemove', onDrag);
    document.addEventListener('touchmove', onDrag, { passive: false });

    const stopDrag = () => {
        isDragging = false;
    };

    document.addEventListener('mouseup', stopDrag);
    document.addEventListener('touchend', stopDrag);
    document.addEventListener('touchcancel', stopDrag);

    // ========== ZOOM UNTUK PC (WHEEL) ==========
    imgElement.addEventListener('wheel', (e) => {
        e.preventDefault();

        let currentWidth = parseFloat(imgElement.style.width) || imgElement.dataset.naturalWidth;
        let step = 50; // 50 pixel tiap scroll

        if (e.deltaY > 0) {
            currentWidth -= step;
        } else {
            currentWidth += step;
        }

        // Batasi ukuran (min 50px, max 1000px)
        currentWidth = Math.min(1000, Math.max(50, currentWidth));

        // Hitung scale berdasarkan ukuran baru
        let scale = currentWidth / imgElement.dataset.naturalWidth;

        // Simpan scale dan terapkan ukuran
        imgElement.dataset.scale = scale;
        imgElement.style.width = currentWidth + 'px';
        imgElement.style.height = (imgElement.dataset.naturalHeight * scale) + 'px';

        console.log('Ukuran baru:', currentWidth, 'Scale:', scale);
    }, { passive: false });

    // ========== PINCH ZOOM UNTUK ANDROID ==========
    let initialDistance = 0;
    let initialScale = 1;

    imgElement.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            initialDistance = Math.sqrt(dx * dx + dy * dy);
            initialScale = parseFloat(imgElement.dataset.scale || '1');
        }
    });

    imgElement.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
            e.preventDefault();

            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            const currentDistance = Math.sqrt(dx * dx + dy * dy);

            if (initialDistance > 0) {
                let scale = initialScale * (currentDistance / initialDistance);
                scale = Math.min(3, Math.max(0.02, scale));

                imgElement.dataset.scale = scale;
                imgElement.style.width = (imgElement.dataset.naturalWidth * scale) + 'px';
                imgElement.style.height = (imgElement.dataset.naturalHeight * scale) + 'px';
            }
        }
    }, { passive: false });
}

function startDrag(e) {
    e.preventDefault();
    isDragging = true;

    const img = currentImage;
    if (!img) return;

    // Posisi awal mouse
    if (e.type === 'mousedown') {
        startX = e.clientX;
        startY = e.clientY;
    } else {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
    }

    // Posisi awal gambar
    const rect = img.getBoundingClientRect();
    const parentRect = img.parentElement.getBoundingClientRect();

    startLeft = rect.left - parentRect.left;
    startTop = rect.top - parentRect.top;

    img.style.transition = 'none';
}

function stopDrag() {
    isDragging = false;
    if (currentImage) {
        currentImage.style.transition = 'all 0.2s';
    }
}

function drag(e) {
    if (!isDragging || !currentImage) return;
    e.preventDefault();

    let currentX, currentY;
    if (e.type === 'mousemove') {
        currentX = e.clientX;
        currentY = e.clientY;
    } else {
        currentX = e.touches[0].clientX;
        currentY = e.touches[0].clientY;
    }

    // Hitung pergerakan
    const deltaX = currentX - startX;
    const deltaY = currentY - startY;

    // Posisi baru
    let newLeft = startLeft + deltaX;
    let newTop = startTop + deltaY;

    // Batasi biar ga keluar parent
    const parent = currentImage.parentElement;
    const parentWidth = parent.clientWidth;
    const parentHeight = parent.clientHeight;
    const imgWidth = currentImage.width;
    const imgHeight = currentImage.height;

    newLeft = Math.max(Math.min(newLeft, parentWidth - imgWidth), 0);
    newTop = Math.max(Math.min(newTop, parentHeight - imgHeight), 0);

    // Terapkan posisi
    currentImage.style.left = newLeft + 'px';
    currentImage.style.top = newTop + 'px';
}


// FUNGSI HANDLE TOMBOL BACK UTAMA (DENGAN TOAST CUSTOM)
function handleBackButton() {

 if (document.getElementById('appContainer').classList.contains('hidden')) {
        console.log("Di halaman login, back diabaikan");
        return;
    }
    const now = Date.now();
    
    // Jika bukan di dashboard, navigasi back
    if (currentPage !== 'dashboard') {
        navigateBack();
        return;
    }
    
    // Jika di dashboard, cek double tap
    if (now - lastBackPress < 2000) {
        // Double tap - Tampilkan konfirmasi keluar (MODAL CUSTOM)
        showExitConfirmModal();
        lastBackPress = 0;
    } else {
        // Single tap - Tampilkan toast custom X-BILL
        showToast('info', 'Tips', 'Tekan back sekali lagi dalam 2 detik untuk keluar aplikasi', 2000);
        lastBackPress = now;
        
        // Reset setelah 2 detik
        setTimeout(() => {
            lastBackPress = 0;
        }, 2000);
    }
}

// ============================================
// SETUP EVENT LISTENERS
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log("🔧 Setup tombol back handler dengan navigasi");
    
    // ⭐⭐ UPDATE HISTORY SETIAP KALI GANTI HALAMAN ⭐⭐
    const originalLoadPage = window.loadPage;
    window.loadPage = function(page) {
        addToPageHistory(page);
        return originalLoadPage.apply(this, arguments);
    };
    
    // 1. BROWSER BACK BUTTON
    window.addEventListener('popstate', function(event) {
        console.log("🔙 Tombol back browser ditekan");
        handleBackButton();
        
        // Cegah navigasi default browser
        history.pushState(null, null, '#' + currentPage);
    });
    
    // 2. HARDWARE BACK BUTTON (HP)
    if (typeof navigator !== 'undefined' && navigator.app) {
        document.addEventListener('backbutton', function(e) {
            e.preventDefault();
            console.log("📱 Tombol back hardware HP ditekan");
            handleBackButton();
        }, false);
    }
    

    
    // 4. INISIALISASI HISTORY
    history.pushState(null, null, '#dashboard');
});



function pickImage(){
    if (window.AppInventor) {
        AppInventor.setWebViewString("PICK_IMAGE");
    }
}


// ============================================
// FUNGSI BERPINDAH HALAMAN (ADMIN <-> CUSTOMER)
// ============================================

// Fungsi untuk menampilkan halaman login pelanggan
function showCustomerLoginPage() {
    console.log("🟢 Beralih ke halaman login pelanggan");


      // 🔥 TAMBAH 3 BARIS INI
    backButtonPressed = 0;
    if (backButtonTimer) {
        clearTimeout(backButtonTimer);
        backButtonTimer = null;
    }

    // Sembunyikan halaman login admin
    document.getElementById('loginPage').classList.add('hidden');

    // Tampilkan halaman login pelanggan
    document.getElementById('customerLoginPage').classList.remove('hidden');

}

// Fungsi untuk menampilkan halaman login admin
function showAdminLoginPage() {
    console.log("🔵 Beralih ke halaman login admin");
    
    // Sembunyikan halaman login pelanggan
    document.getElementById('customerLoginPage').classList.add('hidden');
    
    // Tampilkan halaman login admin
    document.getElementById('loginPage').classList.remove('hidden');
}

// Fungsi logout untuk pelanggan
function handleCustomerLogout() {
    console.log("🚪 Customer logout");
    
    // Sembunyikan dashboard pelanggan
    document.getElementById('customerAppContainer').classList.add('hidden');
    
    // Tampilkan halaman login pelanggan
    document.getElementById('customerLoginPage').classList.remove('hidden');
    
    // Reset form login
    document.getElementById('customerLoginForm').reset();
    
    showToast('success', 'Berhasil Logout', 'Sampai jumpa kembali!');
}

// ============================================
// TAMBAHKAN TOMBOL "LOGIN SEBAGAI PELANGGAN" DI HALAMAN LOGIN ADMIN
// ============================================

// Jalankan setelah halaman selesai dimuat
document.addEventListener('DOMContentLoaded', function() {
    // Cari footer di halaman login admin
    const loginFooter = document.querySelector('#loginPage .login-footer');
    
    if (loginFooter) {
        // Buat elemen tombol/tautan
        const linkCustomer = document.createElement('p');
        linkCustomer.style.marginTop = '10px';
        linkCustomer.style.marginBottom = '0';

        // showCustomerLoginPage()
linkCustomer.innerHTML = '<a href="#" onclick="showComingSoon()" style="color: var(--primary); text-decoration: none;"><i class="fas fa-user"></i> Login Pelanggan </a>';
        // Tambahkan ke footer
        loginFooter.appendChild(linkCustomer);
    }
});


// ============================================
// EMAILJS NOTIFICATION SYSTEM
// ============================================

// INISIALISASI EMAILJS - PAKAI AKUN DEMO DULU
(function() {
    // 🔥 AKUN DEMO - GANTI NANTI KALAU SUDAH PUNYA AKUN SENDIRI
    emailjs.init("vbjhrBXWJrdgku8--"); // <--- NANTI DIGANTI
})();

// KONFIGURASI EMAILJS
const EMAILJS_CONFIG = {
    SERVICE_ID: "service_ssyukb4",     // <--- NANTI DIGANTI
    TEMPLATE_KARYAWAN: "template_n9mmj46" // <--- NANTI DIGANTI
};

/**
 * GENERATE PASSWORD RANDOM (8 KARAKTER)
 */
function generateRandomPassword(length = 8) {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789';
    let password = '';
    for (let i = 0; i < length; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
}

/**
 * KIRIM EMAIL PASSWORD KE KARYAWAN BARU (VERSI ASLI)
 */
async function kirimEmailKaryawan(email, nama, password) {
    console.log(`📧 Mengirim email ke: ${email}`);
    
    // VALIDASI EMAIL
    if (!email || !email.includes('@')) {
        console.warn("⚠️ Email tidak valid");
        showToast('warning', 'Email Tidak Valid', `Email ${email} tidak valid`, 5000);
        return false;
    }
    
    try {
        // AMBIL NAMA PERUSAHAAN DARI NAVBAR
        const companyName = document.getElementById('companyNameNav')?.textContent || 'X-BILL';
        const loginUrl = window.location.href;
        
        // SIAPKAN PARAMETER UNTUK TEMPLATE EMAIL
        const templateParams = {
            to_email: email,
            to_name: nama,
            password: password,
            company_name: companyName,
            login_url: loginUrl,
            from_name: `${companyName} - Sistem Billing`
        };
        
        console.log("📤 Mengirim dengan parameter:", templateParams);
        
        // KIRIM VIA EMAILJS
        const response = await emailjs.send(
            "service_ssyukb4",                    // SERVICE_ID
            "template_n9mmj46",                 // 🔥 GANTI DENGAN TEMPLATE_ID ANDA
            templateParams
        );
        
        console.log("✅ Email berhasil dikirim:", response);
        showToast('success', 'Email Terkirim', `Password telah dikirim ke ${email}`);
        return true;
        
    } catch (error) {
        console.error("❌ Gagal kirim email:", error);
        
        // TAMPILKAN PASSWORD DI ALERT SEBAGAI FALLBACK
        alert(`
❌ EMAIL GAGAL DIKIRIM!
        
👤 Nama: ${nama}
📧 Email: ${email}
🔑 Password: ${password}

📝 CATATAN:
Email tidak terkirim. Harap beri tahu password ini ke karyawan secara manual.
        `);
        
        return false;
    }
}

        function shareWA(phone, base64Image) {
    if (typeof Android !== "undefined") {
        Android.sendImageToWhatsApp(phone, base64Image);
    } else {
        alert("Android bridge tidak tersedia");
    }
}


       // FUNGSI KIRIM PASSWORD VIA WA
async function kirimPasswordViaWA(phone, password, nama, pesanKustom = null) {
    try {
        const pesan = pesanKustom || `Halo *${nama}*,\n\nPassword baru Anda: *${password}*\n\nGunakan untuk login.\n\n- X-BILL`;

        let noTujuan = phone.replace(/\D/g, '');
        if (noTujuan.startsWith('0')) {
            noTujuan = '62' + noTujuan.substring(1);
        }

        console.log('Mengirim ke:', noTujuan);

        const response = await fetch('https://jkt.wablas.com/api/send-message', {
            method: 'POST',
            headers: {
                'Authorization': 'sbALSJkESIqahdXY5yuHu0l0108HG2SFmxA5ThhzuD5jaie7HkwFGvN',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                phone: noTujuan,
                message: pesan,
                secret: 'CneMTQtr'  // ← SECRET KEY
            })
        });

        const result = await response.json();
        console.log('Response lengkap:', JSON.stringify(result, null, 2));
        return result.status === true;

    } catch (error) {
        console.error('Error WA:', error);
        return false;
    }
}

// ============================================
// FUNGSI LOGIN PELANGGAN (FIX - HANYA 1 LISTENER)
// ============================================

(function() {
    const oldForm = document.getElementById('customerLoginForm');
    if (!oldForm) return;

    const newForm = oldForm.cloneNode(true);
    oldForm.parentNode.replaceChild(newForm, oldForm);

    newForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const phone = document.getElementById('customerPhone').value.trim();
        const password = document.getElementById('costumerPassword').value.trim();

        if (!phone || !password) {
            showToast('error', 'Error', 'Nomor dan password wajib diisi');
            return;
        }

        showLoading();

        try {
            const snapshot = await db.collection('pelanggan')
                .where('telepon', '==', phone)
                .where('company_id', '==', globalCompanyId)
                .get();

            if (snapshot.empty) {
                hideLoading();
                showToast('error', 'Gagal', 'Nomor tidak terdaftar');
                return;
            }

            const pelangganDoc = snapshot.docs[0];
            const pelangganData = pelangganDoc.data();

            if (pelangganData.password !== btoa(password)) {
                hideLoading();
                showToast('error', 'Gagal', 'Password salah');
                return;
            }

            const newPassword = Math.floor(100000 + Math.random() * 900000).toString();

            await db.collection('pelanggan').doc(pelangganDoc.id).update({
                password: btoa(newPassword),
                updated_at: new Date().toISOString()
            });

            await kirimPasswordViaWA(phone, newPassword, pelangganData.nama);

            showToast('success', 'Berhasil', 'Password baru telah dikirim ke WA');

            hideLoading();
            showCustomerDashboard(pelangganData);

        } catch (error) {
            hideLoading();
            console.error('Error:', error);
            showToast('error', 'Gagal', error.message);
        }
    });
})();

        // Buka modal saat tombol Kirim Password diklik
document.getElementById('requestPasswordBtn').addEventListener('click', function() {
    document.getElementById('requestPhoneModal').value = '';
    showModal('modalRequestPassword');
});

// Proses kirim password
async function processPasswordRequest() {
    const phone = document.getElementById('requestPhoneModal').value.trim();

    if (!phone) {
        showToast('error', 'Error', 'Nomor HP wajib diisi');
        return;
    }

    showLoading();

    try {
        // Cari semua perusahaan tempat nomor ini terdaftar
        const snapshot = await db.collection('pelanggan')
            .where('telepon', '==', phone)
            .get();

        if (snapshot.empty) {
            hideLoading();
            showToast('error', 'Gagal', 'NOMOR HP TIDAK TERDAFTAR');
            return;
        }

        // Kumpulkan company_id unik
        const companies = [];
        const seen = new Set();

        for (const doc of snapshot.docs) {
            const data = doc.data();
            const companyId = data.company_id;

            if (!seen.has(companyId)) {
                seen.add(companyId);

                // Ambil nama perusahaan
                const companyDoc = await db.collection('company_settings').doc(companyId).get();
                const companyName = companyDoc.exists ? companyDoc.data().companyName : 'Perusahaan';

                companies.push({
                    id: companyId,
                    name: companyName,
                    pelangganId: doc.id,
                    pelangganData: data
                });
            }
        }

        hideLoading();

        if (companies.length === 1) {
            // Langsung kirim password
            pilihPerusahaan(companies[0].id, phone, companies[0].pelangganId, companies[0].pelangganData.nama);
        } else {
            // Tampilkan pilihan perusahaan
            tampilkanPilihanPerusahaan(companies, phone);
        }

    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        showToast('error', 'Gagal', error.message);
    }
}

        function tampilkanPilihanPerusahaan(companies, phone) {
    const listDiv = document.getElementById('companyList');
    const displayPhone = document.getElementById('displayPhone');

    displayPhone.textContent = phone;

    let html = '';
    companies.forEach((company, index) => {
        html += `
            <div style="padding: 12px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; background: white;"
                 onclick="pilihPerusahaan('${company.id}', '${phone}', '${company.pelangganId}', '${company.pelangganData.nama}')">
                <strong>${index + 1}. ${company.name}</strong>
            </div>
        `;
    });

    listDiv.innerHTML = html;
    showModal('modalPilihPerusahaan');
}

        async function pilihPerusahaan(companyId, phone, pelangganId, nama) {
    hideModal('modalPilihPerusahaan');
    showLoading();

    try {
        // Generate password baru
        const newPassword = Math.floor(100000 + Math.random() * 900000).toString();

        // Update password di database
        await db.collection('pelanggan').doc(pelangganId).update({
            password: btoa(newPassword),
            updated_at: new Date().toISOString()
        });

        // Ambil nama perusahaan
        const companyDoc = await db.collection('company_settings').doc(companyId).get();
        const companyName = companyDoc.exists ? companyDoc.data().companyName : 'Perusahaan';

        hideLoading();

        // 🔥 BUAT MODAL CUSTOM DENGAN TOMBOL COPY
        const modalId = 'modalPasswordPopup';

        // Hapus modal lama jika ada
        const oldModal = document.getElementById(modalId);
        if (oldModal) oldModal.remove();

        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'modal-overlay show';
        modal.style.zIndex = '999999';

        modal.innerHTML = `
            <div class="modal" style="max-width: 400px;">
                <div class="modal-header" style="background: #4361ee; color: white;">
                    <h3 class="modal-title"><i class="fas fa-key"></i> Password Baru</h3>
                    <button class="modal-close" onclick="document.getElementById('${modalId}').remove()" style="color: white;">&times;</button>
                </div>
                <div class="modal-body" style="text-align: center; padding: 30px;">
                    <p style="margin-bottom: 10px;">Halo <strong>${nama}</strong>,</p>
                    <p style="margin-bottom: 5px;">Password untuk login ke <strong>${companyName}</strong>:</p>
                    <div style="font-size: 32px; font-weight: bold; color: #4361ee; margin: 20px; padding: 10px; background: #f0f9ff; border-radius: 8px; letter-spacing: 2px;" id="passwordDisplay">${newPassword}</div>
                </div>
                <div class="modal-footer" style="justify-content: center; gap: 10px;">
                    <button class="btn btn-primary" onclick="copyPasswordToClipboard('${newPassword}', '${modalId}')">
                        <i class="fas fa-copy"></i> Copy Password
                    </button>
                    <button class="btn btn-outline" onclick="document.getElementById('${modalId}').remove()">
                        Tutup
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Reset form
        document.getElementById('requestPhoneModal').value = '';

    } catch (error) {
        hideLoading();
        console.error('Error:', error);
        showToast('error', 'Gagal', error.message);
    }
}

// Fungsi copy password ke clipboard
function copyPasswordToClipboard(password, modalId) {
    navigator.clipboard.writeText(password).then(() => {
        showToast('success', 'Berhasil', 'Password berhasil dicopy');
        document.getElementById(modalId).remove();
    }).catch(() => {
        showToast('error', 'Gagal', 'Gagal copy password');
    });
}



    </script>
</body>
</html>
